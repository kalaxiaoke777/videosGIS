// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.21/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../Graphic ../../../request ../../Attachment ../support/FeatureSet ../support/IdSet ../support/shared ../support/sqlUtils ../support/stats ../../../core/MD5 ../../../kernel ../../../core/promiseUtils ../../../geometry/support/jsonUtils ../../../layers/FeatureLayer ../../../layers/graphics/featureConversionUtils ../../../rest/query/operations/pbfOptimizedFeatureSet ../../../rest/support/FeatureSet ../../../rest/support/Query ../../../rest/support/StatisticDefinition ../../../tasks/QueryTask ../../../rest/query/operations/query ../../Dictionary".split(" "),
function(C,D,E,K,L,A,y,w,M,F,G,r,N,O,P,Q,R,x,H,I,S,T){return function(J){function z(a){var b=J.call(this,a)||this;b.declaredClass="esri.arcade.featureset.sources.FeatureLayerDynamic";b._removeGeometry=!1;b._overrideFields=null;b.formulaCredential=null;b._pageJustIds=!1;b._requestStandardised=!1;b._useDefinitionExpression=!0;a.spatialReference&&(b.spatialReference=a.spatialReference);b._transparent=!0;b._maxProcessing=1E3;b._layer=a.layer;b._wset=null;void 0!==a.outFields&&(b._overrideFields=a.outFields);
void 0!==a.includeGeometry&&(b._removeGeometry=!1===a.includeGeometry);return b}C._inheritsLoose(z,J);var l=z.prototype;l._maxQueryRate=function(){return y.defaultMaxRecords};l.end=function(){return this._layer};l.optimisePagingFeatureQueries=function(a){this._pageJustIds=a};l.convertQueryToLruCacheKey=function(a){a=y.stableStringify(a.toJSON());return F.createMD5Hash(a,F.outputTypes.String)};l.load=function(){null===this._loadPromise&&(this._loadPromise=r.create((a,b)=>{try{!0===this._layer.loaded?
(this._initialiseFeatureSet(),a(this)):(this._layer.when().then(()=>{try{this._initialiseFeatureSet(),a(this)}catch(c){b(c)}},b),this._layer.load())}catch(c){b(c)}}));return this._loadPromise};l._initialiseFeatureSet=function(){null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference);this.geometryType=this._layer.geometryType;this.fields=this._layer.fields.slice(0);if(this._layer.outFields&&(1!==this._layer.outFields.length||"*"!==this._layer.outFields[0])){var a=[];for(var b of this.fields)if("oid"===
b.type)a.push(b);else for(const d of this._layer.outFields)if(d.toLowerCase()===b.name.toLowerCase()){a.push(b);break}this.fields=a}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{a=[];b=[];for(var c of this.fields)if("oid"===c.type)a.push(c),b.push(c.name);else for(const d of this._overrideFields)if(d.toLowerCase()===c.name.toLowerCase()){a.push(c);b.push(c.name);break}this.fields=a;this._overrideFields=b}this._layer.source&&
this._layer.source.sourceJSON&&(c=this._layer.source.sourceJSON.currentVersion,!0===this._layer.source.sourceJSON.useStandardizedQueries?(this._databaseType=y.FeatureServiceDatabaseType.StandardisedNoInterval,void 0!==c&&null!==c&&10.61<=c&&(this._databaseType=y.FeatureServiceDatabaseType.Standardised)):void 0!==c&&null!==c&&(10.5<=c&&(this._databaseType=y.FeatureServiceDatabaseType.StandardisedNoInterval,this._requestStandardised=!0),10.61<=c&&(this._databaseType=y.FeatureServiceDatabaseType.Standardised)));
this.objectIdField=this._layer.objectIdField;for(const d of this.fields)"global-id"===d.type&&(this.globalIdField=d.name);this.hasM=this._layer.supportsM;this.hasZ=this._layer.supportsZ;this.typeIdField=this._layer.typeIdField;this.types=this._layer.types};l._isInFeatureSet=function(){return y.IdState.InFeatureSet};l._refineSetBlock=function(a){return r.resolve(a)};l._candidateIdTransform=function(a){return a};l._getSet=function(a){return null===this._wset?this._ensureLoaded().then(()=>this._getFilteredSet("",
null,null,null,a)).then(b=>this._wset=b):r.resolve(this._wset)};l._runDatabaseProbe=function(a){return r.create((b,c)=>{try{this._ensureLoaded().then(()=>{try{const d=new x;d.where=a.replace("OBJECTID",this._layer.objectIdField);this._layer.queryObjectIds(d).then(()=>{b(!0)},()=>{try{b(!1)}catch(f){c(f)}})}catch(d){c(d)}})}catch(d){c(d)}})};l._canUsePagination=function(){return this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsPagination?!0:!1};
l._cacheableFeatureSetSourceKey=function(){return this._layer.url};l.pbfSupportedForQuery=function(a){return!a.outStatistics&&this._layer&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsFormatPBF&&!0===this._layer.capabilities.query.supportsQuantizationEditMode};l.queryPBF=function(a){a.quantizationParameters={mode:"edit"};return S.executeQueryPBF(this._layer.parsedUrl,a,new Q.OptimizedFeatureSetParserContext({})).then(b=>R.fromJSON(P.convertToFeatureSet(b.data)).unquantize())};
l.nativeCapabilities=function(){return{title:this._layer.title,source:this,canQueryRelated:!0,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:this._requestStandardised}};l.executeQuery=function(a,b){const c=new I({url:this._layer.parsedUrl.path}),d="execute"===b&&this.pbfSupportedForQuery(a);let f=null;if(this.recentlyUsedQueries){const h=this.convertQueryToLruCacheKey(a);f=this.recentlyUsedQueries.getFromCache(h);null===f&&(f=!0!==d?c[b](a):this.queryPBF(a),
this.recentlyUsedQueries.addToCache(h,f),f=f.catch(e=>{this.recentlyUsedQueries.removeFromCache(h);throw e;}))}this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:a,method:b});null===f&&(f=!0!==d?c[b](a):this.queryPBF(a));return f};l._getFilteredSet=function(a,b,c,d,f){return this.databaseType().then(h=>{if(this.isTable()&&b&&null!==a&&""!==a)return new A([],[],!0,null);if(this._canUsePagination())return this._getFilteredSetUsingPaging(a,
b,c,d,f);let e="",g=!1;null!==d&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(e=d.constructClause(),g=!0);const k=new x;k.where=null===c?null===b?"1\x3d1":"":w.toWhereClause(c,h);this._requestStandardised&&(k.sqlFormat="standard");k.spatialRelationship=this._makeRelationshipEnum(a);k.outSpatialReference=this.spatialReference;k.orderByFields=""!==e?e.split(","):null;k.geometry=null===b?null:b;k.relationParameter=this._makeRelationshipParam(a);
return this.executeQuery(k,"executeForIds").then(m=>{null===m&&(m=[]);this._checkCancelled(f);return new A([],m,g,null)})})};l._expandPagedSet=function(a,b,c,d,f){return this._expandPagedSetFeatureSet(a,b,c,d,f)};l._getFilteredSetUsingPaging=function(a,b,c,d,f){try{let h="",e=!1;null!==d&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(h=d.constructClause(),e=!0);return this.databaseType().then(g=>{g=null===c?null===b?"1\x3d1":"":w.toWhereClause(c,
g);this._layer.definitionExpression&&this._useDefinitionExpression&&(g=""!==g?"(("+this._layer.definitionExpression+") AND ("+g+"))":this._layer.definitionExpression);let k=this._maxQueryRate();var m=this._layer.capabilities.query.maxRecordCount;void 0!==m&&m<k&&(k=m);let q=null;if(!0===this._pageJustIds)q=new A([],["GETPAGES"],e,{spatialRel:this._makeRelationshipEnum(a),relationParam:this._makeRelationshipParam(a),outFields:this._layer.objectIdField,resultRecordCount:k,resultOffset:0,geometry:null===
b?null:b,where:g,orderByFields:h,returnGeometry:!1,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}});else{m=!0;!0===this._removeGeometry&&(m=!1);const n=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._layer.outFields?this._layer.outFields:["*"]);q=new A([],["GETPAGES"],e,{spatialRel:this._makeRelationshipEnum(a),relationParam:this._makeRelationshipParam(a),outFields:n.join(","),resultRecordCount:k,resultOffset:0,geometry:null===
b?null:b,where:g,orderByFields:h,returnGeometry:m,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}return this._expandPagedSet(q,k,0,1,f).then(()=>q)})}catch(h){return r.reject(h)}};l._clonePageDefinition=function(a){return null===a?null:!0!==a.groupbypage?{groupbypage:!1,spatialRel:a.spatialRel,relationParam:a.relationParam,outFields:a.outFields,resultRecordCount:a.resultRecordCount,resultOffset:a.resultOffset,geometry:a.geometry,where:a.where,orderByFields:a.orderByFields,
returnGeometry:a.returnGeometry,returnIdsOnly:a.returnIdsOnly,internal:a.internal}:{groupbypage:!0,spatialRel:a.spatialRel,relationParam:a.relationParam,outFields:a.outFields,resultRecordCount:a.resultRecordCount,useOIDpagination:a.useOIDpagination,generatedOid:a.generatedOid,groupByFieldsForStatistics:a.groupByFieldsForStatistics,resultOffset:a.resultOffset,outStatistics:a.outStatistics,geometry:a.geometry,where:a.where,orderByFields:a.orderByFields,returnGeometry:a.returnGeometry,returnIdsOnly:a.returnIdsOnly,
internal:a.internal}};l._getPhysicalPage=function(a,b,c){try{const d=a.pagesDefinition.internal.lastRetrieved,f=a.pagesDefinition.internal.lastPage,h=new x;this._requestStandardised&&(h.sqlFormat="standard");h.spatialRelationship=a.pagesDefinition.spatialRel;h.relationParameter=a.pagesDefinition.relationParam;h.outFields=a.pagesDefinition.outFields.split(",");h.num=a.pagesDefinition.resultRecordCount;h.start=a.pagesDefinition.internal.lastPage;h.geometry=a.pagesDefinition.geometry;h.where=a.pagesDefinition.where;
h.orderByFields=""!==a.pagesDefinition.orderByFields?a.pagesDefinition.orderByFields.split(","):null;h.returnGeometry=a.pagesDefinition.returnGeometry;h.outSpatialReference=this.spatialReference;return this.executeQuery(h,"execute").then(e=>{this._checkCancelled(c);if(a.pagesDefinition.internal.lastPage!==f)return"done";for(var g=0;g<e.features.length;g++)a.pagesDefinition.internal.set[d+g]=e.features[g].attributes[this._layer.objectIdField];if(!1===this._pageJustIds)for(g=0;g<e.features.length;g++)this._featureCache[e.features[g].attributes[this._layer.objectIdField]]=
e.features[g];if(void 0===e.exceededTransferLimit&&e.features.length!==a.pagesDefinition.resultRecordCount||!1===e.exceededTransferLimit)a.pagesDefinition.internal.fullyResolved=!0;a.pagesDefinition.internal.lastRetrieved=d+e.features.length;a.pagesDefinition.internal.lastPage+=a.pagesDefinition.resultRecordCount;return"done"})}catch(d){return r.reject(d)}};l._fieldsIncludingObjectId=function(a){if(null===a)return[this.objectIdField];a=a.slice(0);if(-1<a.indexOf("*"))return a;let b=!1;for(const c of a)if(c.toUpperCase()===
this.objectIdField.toUpperCase()){b=!0;break}!1===b&&a.push(this.objectIdField);return a};l._getFeatures=function(a,b,c,d){const f=[];try{-1!==b&&void 0===this._featureCache[b]&&f.push(b);if(!0===this._checkIfNeedToExpandKnownPage(a,this._maxProcessingRate()))return this._expandPagedSet(a,this._maxProcessingRate(),0,0,d).then(()=>this._getFeatures(a,b,c,d));let h=0;for(let e=a._lastFetchedIndex;e<a._known.length;e++){a._lastFetchedIndex+=1;h++;if(void 0===this._featureCache[a._known[e]]){let g=!1;
if(null!==this._layer._mode&&void 0!==this._layer._mode){const k=this._layer._mode;if(void 0!==k._featureMap[a._known[e]]){const m=k._featureMap[a._known[e]];null!==m&&(g=!0,this._featureCache[a._known[e]]=m)}}if(!1===g&&(a._known[e]!==b&&f.push(a._known[e]),f.length>=this._maxProcessingRate()-1))break}if(h>=c&&0===f.length)break}if(0===f.length)return r.resolve("success");try{const e=new x;this._requestStandardised&&(e.sqlFormat="standard");e.objectIds=f;e.outFields=null!==this._overrideFields?this._overrideFields:
this._fieldsIncludingObjectId(this._layer.outFields?this._layer.outFields:["*"]);e.returnGeometry=!0;!0===this._removeGeometry&&(e.returnGeometry=!1);e.outSpatialReference=this.spatialReference;return this.executeQuery(e,"execute").then(g=>{this._checkCancelled(d);if(void 0!==g.error)return r.reject(Error(g.error));for(let k=0;k<g.features.length;k++)this._featureCache[g.features[k].attributes[this._layer.objectIdField]]=g.features[k];return"success"})}catch(e){return r.reject(e)}}catch(h){return r.reject(h)}};
l._getDistinctPages=function(a,b,c,d,f,h,e,g,k){return this._ensureLoaded().then(()=>this.databaseType()).then(m=>{let q=c.parseTree.column;for(var n=0;n<this._layer.fields.length;n++)if(this._layer.fields[n].name.toLowerCase()===q.toLowerCase()){q=this._layer.fields[n].name;break}n=new x;this._requestStandardised&&(n.sqlFormat="standard");m=null===h?null===f?"1\x3d1":"":w.toWhereClause(h,m);this._layer.definitionExpression&&this._useDefinitionExpression&&(m=""!==m?"(("+this._layer.definitionExpression+
") AND ("+m+"))":this._layer.definitionExpression);n.where=m;n.spatialRelationship=this._makeRelationshipEnum(d);n.relationParameter=this._makeRelationshipParam(d);n.geometry=null===f?null:f;n.returnDistinctValues=!0;n.returnGeometry=!1;n.outFields=[q];return this.executeQuery(n,"execute").then(p=>{this._checkCancelled(k);if(!p.hasOwnProperty("features"))return r.reject(Error("Unnexected Result querying statistics from layer"));let u=!1;for(var t=0;t<this._layer.fields.length;t++)if(this._layer.fields[t].name===
q){"date"===this._layer.fields[t].type&&(u=!0);break}for(t=0;t<p.features.length;t++){if(u){const v=p.features[t].attributes[q];null!==v?g.push(new Date(v)):g.push(v)}else g.push(p.features[t].attributes[q]);if(g.length>=e)break}return 0===p.features.length?g:p.features.length===this._layer.capabilities.query.maxRecordCount&&g.length<e?this._getDistinctPages(a+p.features.length,b,c,d,f,h,e,g,k).then(v=>({calculated:!0,result:v})):g})})};l._distinctStat=function(a,b,c,d,f,h,e){return this._getDistinctPages(0,
a,b,c,d,f,h,[],e).then(g=>({calculated:!0,result:g}))};l.isTable=function(){return this._layer.isTable||null===this._layer.geometryType||"table"===this._layer.type||""===this._layer.geometryType};l._countstat=function(a,b,c,d){return this.databaseType().then(f=>{const h=new x;this._requestStandardised&&(h.sqlFormat="standard");if(this.isTable()&&c&&null!==b&&""!==b)return{calculated:!0,result:0};f=null===d?null===c?"1\x3d1":"":w.toWhereClause(d,f);this._layer.definitionExpression&&this._useDefinitionExpression&&
(f=""!==f?"(("+this._layer.definitionExpression+") AND ("+f+"))":this._layer.definitionExpression);h.where=f;h.where=f;h.spatialRelationship=this._makeRelationshipEnum(b);h.relationParameter=this._makeRelationshipParam(b);h.geometry=null===c?null:c;h.returnGeometry=!1;return this.executeQuery(h,"executeForCount").then(e=>({calculated:!0,result:e}))})};l._stats=function(a,b,c,d,f,h,e){return this._ensureLoaded().then(()=>{const g=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsSqlExpression,
k=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsStatistics,m=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsDistinct;return"count"===a?m?this._countstat(a,c,d,f):{calculated:!1}:!1===k||!1===w.isSingleField(b)&&!1===g||!1===b.isStandardized?""!==c||null!==f?{calculated:!1}:this._manualStat(a,b,h,e):"distinct"===a?!1===m?""!==c||null!==f?{calculated:!1}:this._manualStat(a,b,h,e):this._distinctStat(a,
b,c,d,f,h,e):this.databaseType().then(q=>{if(this.isTable()&&d&&null!==c&&""!==c)return{calculated:!0,result:null};const n=new x;this._requestStandardised&&(n.sqlFormat="standard");var p=null===f?null===d?"1\x3d1":"":w.toWhereClause(f,q);this._layer.definitionExpression&&this._useDefinitionExpression&&(p=""!==p?"(("+this._layer.definitionExpression+") AND ("+p+"))":this._layer.definitionExpression);n.where=p;n.spatialRelationship=this._makeRelationshipEnum(c);n.relationParameter=this._makeRelationshipParam(c);
n.geometry=null===d?null:d;p=new H;p.statisticType=M.decodeStatType(a);p.onStatisticField=w.toWhereClause(b,q);p.outStatisticFieldName="ARCADE_STAT_RESULT";n.returnGeometry=!1;let u="ARCADE_STAT_RESULT";n.outStatistics=[p];return this.executeQuery(n,"execute").then(t=>{if(!t.hasOwnProperty("features")||0===t.features.length)return r.reject(Error("Unnexected Result querying statistics from layer"));var v=!1;for(let B=0;B<t.fields.length;B++)if("ARCADE_STAT_RESULT"===t.fields[B].name.toUpperCase()){u=
t.fields[B].name;"date"===t.fields[B].type&&(v=!0);break}return v?(v=t.features[0].attributes[u],null!==v&&(v=new Date(t.features[0].attributes[u])),{calculated:!0,result:v}):{calculated:!0,result:t.features[0].attributes[u]}})})})};l._stat=function(a,b,c,d,f,h,e){return this._stats(a,b,c,d,f,h,e)};l._canDoAggregates=function(a,b){return this._ensureLoaded().then(()=>{let c=!1;const d=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsSqlExpression;
void 0!==this._layer.capabilities&&null!==this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsStatistics&&!0===this._layer.capabilities.query.supportsOrderBy&&(c=!0);if(c)for(let f=0;f<b.length-1;f++)null!==b[f].workingexpr&&(!1===b[f].workingexpr.isStandardized?c=!1:!1===w.isSingleField(b[f].workingexpr)&&!1===d&&(c=!1));return!1===c?!1:!0})};l._makeRelationshipEnum=function(a){if(0<=a.indexOf("esriSpatialRelRelation"))return"relation";switch(a){case "esriSpatialRelRelation":return"relation";
case "esriSpatialRelIntersects":return"intersects";case "esriSpatialRelContains":return"contains";case "esriSpatialRelOverlaps":return"overlaps";case "esriSpatialRelWithin":return"within";case "esriSpatialRelTouches":return"touches";case "esriSpatialRelCrosses":return"crosses";case "esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return a};l._makeRelationshipParam=function(a){return 0<=a.indexOf("esriSpatialRelRelation")?a.split(":")[1]:""};l._getAggregatePagesDataSourceDefinition=function(a,
b,c,d,f,h,e){return this._ensureLoaded().then(()=>this.databaseType()).then(g=>{let k="",m=!1,q=!1;null!==h&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(k=h.constructClause(),q=!0);this._layer.capabilities&&this._layer.capabilities.query&&!1===this._layer.capabilities.query.supportsPagination&&(q=!1,m=!0,k=this._layer.objectIdField);const n=[];for(var p=0;p<b.length;p++){var u=new H;u.onStatisticField=null!==b[p].workingexpr?w.toWhereClause(b[p].workingexpr,
g):"";u.outStatisticFieldName=b[p].field;u.statisticType=b[p].toStatisticsName();n.push(u)}""===k&&(k=a.join(","));p=this._maxQueryRate();u=this._layer.capabilities.query.maxRecordCount;void 0!==u&&u<p&&(p=u);g=null===f?null===d?"1\x3d1":"":w.toWhereClause(f,g);this._layer.definitionExpression&&this._useDefinitionExpression&&(g=""!==g?"(("+this._layer.definitionExpression+") AND ("+g+"))":this._layer.definitionExpression);return new A([],["GETPAGES"],q,{groupbypage:!0,spatialRel:this._makeRelationshipEnum(c),
relationParam:this._makeRelationshipParam(c),outFields:["*"],useOIDpagination:m,generatedOid:e,resultRecordCount:p,resultOffset:0,groupByFieldsForStatistics:a,outStatistics:n,geometry:null===d?null:d,where:g,orderByFields:k,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})})};l._getAgregagtePhysicalPage=function(a,b,c){try{let d=a.pagesDefinition.where;!0===a.pagesDefinition.useOIDpagination&&(d=""!==d?"("+d+") AND ("+a.pagesDefinition.generatedOid+
"\x3e"+a.pagesDefinition.internal.lastMaxId.toString()+")":a.pagesDefinition.generatedOid+"\x3e"+a.pagesDefinition.internal.lastMaxId.toString());const f=a.pagesDefinition.internal.lastRetrieved,h=a.pagesDefinition.internal.lastPage,e=new x;this._requestStandardised&&(e.sqlFormat="standard");e.where=d;e.spatialRelationship=a.pagesDefinition.spatialRel;e.relationParameter=a.pagesDefinition.relationParam;e.outFields=a.pagesDefinition.outFields;e.outStatistics=a.pagesDefinition.outStatistics;e.geometry=
a.pagesDefinition.geometry;e.groupByFieldsForStatistics=a.pagesDefinition.groupByFieldsForStatistics;e.num=a.pagesDefinition.resultRecordCount;e.start=a.pagesDefinition.internal.lastPage;e.returnGeometry=a.pagesDefinition.returnGeometry;e.orderByFields=""!==a.pagesDefinition.orderByFields?a.pagesDefinition.orderByFields.split(","):null;return this.isTable()&&e.geometry&&e.spatialRelationship?r.resolve([]):this.executeQuery(e,"execute").then(g=>{this._checkCancelled(c);if(!g.hasOwnProperty("features"))return r.reject(Error("Unnexected Result querying aggregates from layer"));
const k=[];if(a.pagesDefinition.internal.lastPage!==h)return[];for(var m=0;m<g.features.length;m++)a.pagesDefinition.internal.set[f+m]=g.features[m].attributes[a.pagesDefinition.generatedOid];for(m=0;m<g.features.length;m++)k.push(new D({attributes:g.features[m].attributes,geometry:null}));if(!0===a.pagesDefinition.useOIDpagination)0===g.features.length?a.pagesDefinition.internal.fullyResolved=!0:a.pagesDefinition.internal.lastMaxId=g.features[g.features.length-1].attributes[a.pagesDefinition.generatedOid];
else if(void 0===g.exceededTransferLimit&&g.features.length!==a.pagesDefinition.resultRecordCount||!1===g.exceededTransferLimit)a.pagesDefinition.internal.fullyResolved=!0;a.pagesDefinition.internal.lastRetrieved=f+g.features.length;a.pagesDefinition.internal.lastPage+=a.pagesDefinition.resultRecordCount;return k})}catch(d){return r.reject(d)}};z.create=function(a,b,c,d,f){a=new O({url:a,outFields:null===b?["*"]:b});return new z({layer:a,spatialReference:c,lrucache:d,interceptor:f})};l.relationshipMetaData=
function(){return this._layer&&this._layer.source&&this._layer.source.sourceJSON&&this._layer.source.sourceJSON.relationships?this._layer.source.sourceJSON.relationships:[]};l.serviceUrl=function(){return y.extractServiceUrl(this._layer.parsedUrl.path)};l.queryAttachments=function(a,b,c,d,f){if(this._layer.capabilities.data.supportsAttachment&&this._layer.capabilities.operations.supportsQueryAttachments){const h={objectIds:[a],returnMetadata:f};if(b&&0<b||c&&0<c)h.size=[b&&0<b?b:0,c&&0<c?c:b+1];d&&
0<d.length&&(h.attachmentTypes=d);this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:h,method:"attachments"});return this._layer.queryAttachments(h).then(e=>{const g=[];e&&e[a]&&e[a].forEach(k=>{const m=this._layer.parsedUrl.path+"/"+a.toString()+"/attachments/"+k.id.toString();let q=null;f&&k.exifInfo&&(q=T.convertJsonToArcade(k.exifInfo,!0));g.push(new K(k.id,k.name,k.contentType,k.size,m,q))});return g})}return r.resolve([])};l.queryRelatedFeatures=
function(a){const b={f:"json",relationshipId:a.relationshipId.toString(),definitionExpression:a.where,outFields:a.outFields.join(","),returnGeometry:a.returnGeometry.toString()};void 0!==a.resultOffset&&null!==a.resultOffset&&(b.resultOffset=a.resultOffset.toString());void 0!==a.resultRecordCount&&null!==a.resultRecordCount&&(b.resultRecordCount=a.resultRecordCount.toString());a.orderByFields&&(b.orderByFields=a.orderByFields.join(","));0<a.objectIds.length&&(b.objectIds=a.objectIds.join(","));a.outSpatialReference&&
(b.outSR=JSON.stringify(a.outSpatialReference.toJSON()));this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preRequestCallback({layer:this._layer,queryPayload:b,method:"relatedrecords",url:this._layer.parsedUrl.path+"/queryRelatedRecords"});return E(this._layer.parsedUrl.path+"/queryRelatedRecords",{responseType:"json",query:b}).then(c=>{if(c.data){const d={};if((c=c.data)&&c.relatedRecordGroups){const f=c.spatialReference;for(const h of c.relatedRecordGroups){const e=h.objectId,g=[];
for(const k of h.relatedRecords){k.geometry&&(k.geometry.spatialReference=f);const m=new D({geometry:k.geometry?N.fromJSON(k.geometry):null,attributes:k.attributes});g.push(m)}d[e]={features:g,exceededTransferLimit:!0===c.exceededTransferLimit}}}return d}return r.reject("Invalid Request")})};l.getFeatureByObjectId=function(a,b){const c=new I({url:this._layer.parsedUrl.path}),d=new x;d.outFields=b;d.returnGeometry=!1;d.outSpatialReference=this.spatialReference;d.where=this.objectIdField+"\x3d"+a.toString();
this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:d,method:"execute"});return c.execute(d).then(f=>1===f.features.length?f.features[0]:null)};l.getIdentityUser=function(){return this.load().then(()=>{var a;const b=null==(a=G.id)?void 0:a.findCredential(this._layer.url);return b?b.userId:null})};l.getOwningSystemUrl=function(){return this.load().then(()=>{var a;const b=null==(a=G.id)?void 0:a.findServerInfo(this._layer.url);if(b)return r.resolve(b.owningSystemUrl);
let c=this._layer.url;a=c.toLowerCase().indexOf("/rest/services");return(c=-1<a?c.substring(0,a):c)?(c+="/rest/info",r.create((d,f)=>{E(c,{query:{f:"json"}}).then(h=>{let e="";h.data&&h.data.owningSystemUrl&&(e=h.data.owningSystemUrl);d(e)},h=>{d("")})})):r.resolve("")})};l.getDataSourceFeatureSet=function(){const a=new z({layer:this._layer,spatialReference:this.spatialReference,outFields:this._overrideFields,includeGeometry:!this._removeGeometry,lrucache:this.recentlyUsedQueries,interceptor:this.featureSetQueryInterceptor});
a._useDefinitionExpression=!1;return a};C._createClass(z,[{key:"gdbVersion",get:function(){return this._layer&&this._layer.capabilities&&this._layer.capabilities.data&&this._layer.capabilities.data.isVersioned?this._layer.gdbVersion?this._layer.gdbVersion:"SDE.DEFAULT":""}}]);return z}(L)});