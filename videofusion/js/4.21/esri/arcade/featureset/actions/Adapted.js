// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.21/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../Graphic ../../kernel ../support/FeatureSet ../support/IdSet ../support/shared ../support/sqlUtils ../../../core/promiseUtils ../../../core/sql/WhereClause ../../../geometry/SpatialReference".split(" "),function(u,v,E,F,z,y,w,p,r,A,G){let x=function(){function n(f){this.field=f;this.sqlRewritable=!1}n.prototype.postInitialization=function(f,m){};return n}(),B=function(n){function f(a){a=n.call(this,a)||this;a.sqlRewritable=!0;return a}
v._inheritsLoose(f,n);var m=f.prototype;m.extractValue=function(a){return a.attributes[this.field.name]};m.rewriteSql=function(a){return{rewritten:this.sqlRewritable,where:a}};return f}(x),C=function(n){function f(a,b,d){var e=n.call(this,w.cloneField(a))||this;e.originalField=a;e.sqlRewritable=!0;e.field.name=b;e.field.alias=d;return e}v._inheritsLoose(f,n);var m=f.prototype;m.rewriteSql=function(a,b){return{rewritten:this.sqlRewritable,where:p.reformulateWithoutField(a,this.field.name,this.originalField.name,
b.getFieldsIndex())}};m.extractValue=function(a){return a.attributes[this.originalField.name]};return f}(x),D=function(n){function f(a,b,d){a=n.call(this,a)||this;a.codefield=b;a.lkp=d;a.reverseLkp={};for(const e in d)a.reverseLkp[d[e]]=e;a.sqlRewritable=!0;return a}v._inheritsLoose(f,n);var m=f.prototype;m.rewriteSql=function(a,b){const d=this.evaluateNodeToWhereClause(a.parseTree,w.FeatureServiceDatabaseType.Standardised,this.field.name,this.codefield instanceof A.WhereClause?p.toWhereClause(this.codefield,
w.FeatureServiceDatabaseType.Standardised):this.codefield,a.parameters);return 0<=d.indexOf(f.BADNESS)?{rewritten:!1,where:a}:{rewritten:this.sqlRewritable,where:A.WhereClause.create(d,b._parent.getFieldsIndex())}};m.evaluateNodeToWhereClause=function(a,b,d=null,e=null,c){var g;switch(a.type){case "interval":return p.convertIntervalToSql(this.evaluateNodeToWhereClause(a.value,b,d,e,c),a.qualifier,a.op);case "case_expression":e=" CASE ";"simple"===a.format&&(e+=this.evaluateNodeToWhereClause(a.operand,
b,d,f.BADNESS,c));for(g=0;g<a.clauses.length;g++)e+=" WHEN "+this.evaluateNodeToWhereClause(a.clauses[g].operand,b,d,f.BADNESS,c)+" THEN "+this.evaluateNodeToWhereClause(a.clauses[g].value,b,d,f.BADNESS,c);null!==a.else&&(e+=" ELSE "+this.evaluateNodeToWhereClause(a.else,b,d,f.BADNESS,c));return e+=" END ";case "param":d=c[a.value.toLowerCase()];if("string"===typeof d)return"'"+c[a.value.toLowerCase()].toString().replace(/'/g,"''")+"'";if(d instanceof Date)return p.makeDateString(d,b);if(d instanceof
Array){a=[];for(c=0;c<d.length;c++)"string"===typeof d[c]?a.push("'"+d[c].toString().replace(/'/g,"''")+"'"):d[c]instanceof Date?a.push(p.makeDateString(d[c],b)):a.push(d[c].toString());return a}return d.toString();case "expr_list":g=[];for(k of a.value)g.push(this.evaluateNodeToWhereClause(k,b,d,e,c));return g;case "unary_expr":return" ( NOT "+this.evaluateNodeToWhereClause(a.expr,b,d,f.BADNESS,c)+" ) ";case "binary_expr":switch(a.operator){case "AND":return" ("+this.evaluateNodeToWhereClause(a.left,
b,d,e,c)+" AND "+this.evaluateNodeToWhereClause(a.right,b,d,e,c)+") ";case "OR":return" ("+this.evaluateNodeToWhereClause(a.left,b,d,e,c)+" OR "+this.evaluateNodeToWhereClause(a.right,b,d,e,c)+") ";case "IS":if("null"!==a.right.type)throw Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(a.left,b,d,e,c)+" IS NULL )";case "ISNOT":if("null"!==a.right.type)throw Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(a.left,b,d,e,c)+" IS NOT NULL )";case "IN":var k=
[];if("expr_list"===a.right.type){if("column_ref"===a.left.type&&a.left.column.toUpperCase()===this.field.name.toUpperCase()){var l=[];k=!0;for(g of a.right.value)if("string"===g.type)if(void 0!==this.lkp[g.value])l.push(this.lkp[g.value].toString());else{k=!1;break}else{k=!1;break}if(k)return" ("+this.evaluateNodeToWhereClause(a.left,b,d,e,c)+" IN ("+l.join(",")+")) "}k=this.evaluateNodeToWhereClause(a.right,b,d,e,c);return" ("+this.evaluateNodeToWhereClause(a.left,b,d,e,c)+" IN ("+k.join(",")+")) "}g=
this.evaluateNodeToWhereClause(a.right,b,d,e,c);return g instanceof Array?" ("+this.evaluateNodeToWhereClause(a.left,b,d,e,c)+" IN ("+g.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(a.left,b,d,e,c)+" IN ("+g+")) ";case "NOT IN":k=[];if("expr_list"===a.right.type){if("column_ref"===a.left.type&&a.left.column.toUpperCase()===this.field.name.toUpperCase()){g=[];k=!0;for(l of a.right.value)if("string"===l.type)if(void 0!==this.lkp[l.value])g.push(this.lkp[l.value].toString());else{k=!1;break}else{k=
!1;break}if(k)return" ("+this.evaluateNodeToWhereClause(a.left,b,d,e,c)+" NOT IN ("+g.join(",")+")) "}k=this.evaluateNodeToWhereClause(a.right,b,d,e,c);return" ("+this.evaluateNodeToWhereClause(a.left,b,d,e,c)+" NOT IN ("+k.join(",")+")) "}g=this.evaluateNodeToWhereClause(a.right,b,d,e,c);return g instanceof Array?" ("+this.evaluateNodeToWhereClause(a.left,b,d,e,c)+" NOT IN ("+g.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(a.left,b,d,e,c)+" NOT IN ("+g+")) ";case "BETWEEN":return e=this.evaluateNodeToWhereClause(a.right,
b,d,f.BADNESS,c)," ("+this.evaluateNodeToWhereClause(a.left,b,d,f.BADNESS,c)+" BETWEEN "+e[0]+" AND "+e[1]+" ) ";case "NOTBETWEEN":return e=this.evaluateNodeToWhereClause(a.right,b,d,f.BADNESS,c)," ("+this.evaluateNodeToWhereClause(a.left,b,d,f.BADNESS,c)+" NOT BETWEEN "+e[0]+" AND "+e[1]+" ) ";case "LIKE":return""!==a.escape?" ("+this.evaluateNodeToWhereClause(a.left,b,d,f.BADNESS,c)+" LIKE "+this.evaluateNodeToWhereClause(a.right,b,d,f.BADNESS,c)+" ESCAPE '"+a.escape+"') ":" ("+this.evaluateNodeToWhereClause(a.left,
b,d,f.BADNESS,c)+" LIKE "+this.evaluateNodeToWhereClause(a.right,b,d,f.BADNESS,c)+") ";case "NOT LIKE":return""!==a.escape?" ("+this.evaluateNodeToWhereClause(a.left,b,d,f.BADNESS,c)+" NOT LIKE "+this.evaluateNodeToWhereClause(a.right,b,d,f.BADNESS,c)+" ESCAPE '"+a.escape+"') ":" ("+this.evaluateNodeToWhereClause(a.left,b,d,f.BADNESS,c)+" NOT LIKE "+this.evaluateNodeToWhereClause(a.right,b,d,f.BADNESS,c)+") ";case "\x3c\x3e":case "\x3d":if("column_ref"===a.left.type&&"string"===a.right.type){if(a.left.column.toUpperCase()===
this.field.name.toUpperCase()&&void 0!==this.lkp[a.right.value.toString()])return" ("+e+" "+a.operator+" "+this.lkp[a.right.value.toString()].toString()+") "}else if("column_ref"===a.right.type&&"string"===a.left.type&&a.right.column.toUpperCase()===this.field.name.toUpperCase())return" ("+this.lkp[a.right.value.toString()].toString()+" "+a.operator+" "+e+") ";return" ("+this.evaluateNodeToWhereClause(a.left,b,d,f.BADNESS,c)+" "+a.operator+" "+this.evaluateNodeToWhereClause(a.right,b,d,f.BADNESS,
c)+") ";case "\x3c":case "\x3e":case "\x3e\x3d":case "\x3c\x3d":case "*":case "-":case "+":case "/":return" ("+this.evaluateNodeToWhereClause(a.left,b,d,f.BADNESS,c)+" "+a.operator+" "+this.evaluateNodeToWhereClause(a.right,b,d,f.BADNESS,c)+") "}throw Error("Not Supported Operator "+a.operator);case "null":return"null";case "bool":return!0===a.value?"1":"0";case "string":return"'"+a.value.toString().replace(/'/g,"''")+"'";case "timestamp":return p.makeDateString(a.value,b);case "date":return p.makeDateString(a.value,
b);case "number":return a.value.toString();case "current_time":return p.makeToday("date"===a.mode,b);case "column_ref":return d&&d.toLowerCase()===a.column.toLowerCase()?"("+e+")":a.column;case "function":return c=this.evaluateNodeToWhereClause(a.args,b,d,f.BADNESS,c),p.translateFunctionToDatabaseSpecific(a.name,c,b)}throw Error("Unsupported sql syntax "+a.type);};m.extractValue=function(a){return this.codefield instanceof A.WhereClause?this.reverseLkp[this.codefield.calculateValueCompiled(a)]:this.reverseLkp[a.attributes[this.codefield]]};
return f}(x);D.BADNESS="_!!!_BAD_LKP_!!!!";let H=function(n){function f(a,b){a=n.call(this,a)||this;a.sql=b;return a}v._inheritsLoose(f,n);var m=f.prototype;m.rewriteSql=function(a,b){return{rewritten:!0,where:p.reformulateWithoutField(a,this.field.name,p.toWhereClause(this.sql,w.FeatureServiceDatabaseType.Standardised),b.getFieldsIndex())}};m.extractValue=function(a){return this.sql.calculateValueCompiled(a)};return f}(x);z=function(n){function f(a){var b=n.call(this,a)||this;b._calcFunc=null;b.declaredClass=
"esri.arcade.featureset.actions.Adapted";b.adaptedFields=null;b._extraFilter=null;b._extraFilter=a.extraFilter;b._parent=a.parentfeatureset;b._maxProcessing=30;b.adaptedFields=a.adaptedFields;return b}v._inheritsLoose(f,n);f.findField=function(a,b){for(const d of a)if(d.name.toLowerCase()===b.toString().toLowerCase())return d;return null};var m=f.prototype;m._initialiseFeatureSet=function(){null!==this._parent?(this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,
this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.spatialReference=new G({wkid:4326}),this.globalIdField=this.objectIdField="",this.geometryType=w.layerGeometryEsriConstants.point,this.typeIdField="",this.types=null);this.fields=[];for(const a of this.adaptedFields)a.postInitialization(this,this._parent),this.fields.push(a.field)};
m._getSet=function(a){return null===this._wset?this._ensureLoaded().then(()=>this._extraFilter?this._getFilteredSet("",null,null,null,a):this._parent._getSet(a)).then(b=>{this._checkCancelled(a);return this._wset=new y(b._candidates.slice(0),b._known.slice(0),b._ordered,this._clonePageDefinition(b.pagesDefinition))}):r.resolve(this._wset)};m._isInFeatureSet=function(a){return this._parent._isInFeatureSet(a)};m._getFeatures=function(a,b,d,e){const c=[];-1!==b&&void 0===this._featureCache[b]&&c.push(b);
const g=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(a,g))return this._expandPagedSet(a,g,0,0,e).then(()=>this._getFeatures(a,b,d,e));let k=0;for(let h=a._lastFetchedIndex;h<a._known.length&&!(k++,k<=d&&(a._lastFetchedIndex+=1),void 0===this._featureCache[a._known[h]]&&(a._known[h]!==b&&c.push(a._known[h]),c.length>=g));h++);if(0===c.length)return r.resolve("success");a=new y([],c,a._ordered,null);const l=Math.min(c.length,d);return this._parent._getFeatures(a,-1,l,e).then(()=>
{this._checkCancelled(e);var h=[];for(let q=0;q<l;q++){const t=this._parent._featureFromCache(c[q]);void 0!==t&&h.push({geometry:t.geometry,attributes:t.attributes,id:c[q]})}for(const q of h){h=[];for(const t of this.adaptedFields)h[t.field.name]=t.extractValue(q);this._featureCache[q.id]=new E({attributes:h,geometry:F.cloneGeometry(q.geometry)})}return"success"})};m._fetchAndRefineFeatures=function(){return r.reject(Error("Fetch and Refine should not be called in this featureset"))};m._getFilteredSet=
function(a,b,d,e,c){let g=!1;var k=this.reformulateWithoutAdaptions(d);g=k.cannot;d=k.where;let l=!1;if(null!==e){l=!0;k=[];for(const h of this.adaptedFields)if(!(h instanceof B)&&!0===e.scanForField(h.field.name))if(h instanceof C)k.push({field:h.field.name,newfield:h.originalField.name});else{e=null;l=!1;break}e&&0<k.length&&(e=e.replaceFields(k))}null!==d?null!==this._extraFilter&&(d=p.combine(this._extraFilter,d)):d=this._extraFilter;return this._ensureLoaded().then(()=>this._parent._getFilteredSet(a,
b,d,e,c)).then(h=>{this._checkCancelled(c);return!0===g?new y(h._candidates.slice(0).concat(h._known.slice(0)),[],!0===l?h._ordered:!1,this._clonePageDefinition(h.pagesDefinition)):new y(h._candidates.slice(0),h._known.slice(0),!0===l?h._ordered:!1,this._clonePageDefinition(h.pagesDefinition))})};m.reformulateWithoutAdaptions=function(a){const b={cannot:!1,where:a};if(null!==a)for(const d of this.adaptedFields)if(!0===p.scanForField(a,d.field.name)){const e=d.rewriteSql(a,this);if(!0===e.rewritten)b.where=
e.where;else{b.cannot=!0;b.where=null;break}}return b};m._stat=function(a,b,d,e,c,g,k){let l=!1,h=this.reformulateWithoutAdaptions(b);l=h.cannot;b=h.where;h=this.reformulateWithoutAdaptions(c);l=l||h.cannot;c=h.where;null!==c?null!==this._extraFilter&&(c=p.combine(this._extraFilter,c)):c=this._extraFilter;return!0===l?null===c&&""===d&&null===e?this._manualStat(a,b,g,k):r.resolve({calculated:!1}):this._parent._stat(a,b,d,e,c,g,k).then(q=>!1===q.calculated?null===c&&""===d&&null===e?this._manualStat(a,
b,g,k):{calculated:!1}:q)};m._canDoAggregates=function(a,b,d,e,c){if(null===this._parent)return r.resolve(!1);for(var g=0;g<a.length;g++)for(var k of this.adaptedFields)if(a[g].toLowerCase()===k.field.name.toLowerCase()&&!(k instanceof B))return r.resolve(!1);g=[];for(k=0;k<b.length;k++){var l=b[k];if(null!==l.workingexpr){const h=this.reformulateWithoutAdaptions(l.workingexpr);if(h.cannot)return r.resolve(!1);l=l.clone();l.workingexpr=h.where;g.push(l)}else g.push(l)}b=this.reformulateWithoutAdaptions(c);
if(b.cannot)return r.resolve(!1);c=b.where;null!==c?null!==this._extraFilter&&(c=p.combine(this._extraFilter,c)):c=this._extraFilter;return this._parent._canDoAggregates(a,g,d,e,c)};m._getAggregatePagesDataSourceDefinition=function(a,b,d,e,c,g,k){if(null===this._parent)return r.reject(Error("Should never be called"));const l=[];for(let q=0;q<b.length;q++){var h=b[q];if(null!==h.workingexpr){const t=this.reformulateWithoutAdaptions(h.workingexpr);if(t.cannot)return r.reject(Error("Should never be called"));
h=h.clone();h.workingexpr=t.where;l.push(h)}else l.push(h)}b=this.reformulateWithoutAdaptions(c);if(b.cannot)return r.reject(Error("Should never be called"));c=b.where;null!==c?null!==this._extraFilter&&(c=p.combine(this._extraFilter,c)):c=this._extraFilter;return this._parent._getAggregatePagesDataSourceDefinition(a,l,d,e,c,g,k)};return f}(z);u.AdaptedFeatureSet=z;u.AdaptedField=x;u.FieldRename=C;u.OriginalField=B;u.SqlExpressionAdapted=H;u.StringToCodeAdapted=D;Object.defineProperty(u,"__esModule",
{value:!0})});