// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.21/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/Error ../../core/Logger ../../core/maybe ../../core/promiseUtils ../../core/watchUtils ../../core/accessorSupport/decorators/property ../../core/has ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/subclass ../../layers/support/commonProperties ../../layers/support/fieldUtils ../../rest/support/Query ../../support/arcadeOnDemand ./support/FeatureEffect ./support/FeatureFilter ./support/popupUtils ../support/floorFilterUtils".split(" "),
function(y,t,n,B,v,p,C,z,r,M,N,G,H,e,I,J,K,L,w,D){const E=v.getLogger("esri.views.layers.FeatureLayerView");v=h=>{h=function(A){function x(...b){b=A.call(this,...b)||this;b._updatingRequiredFieldsPromise=null;b.effect=null;b.filter=null;b.timeExtent=null;b.layer=null;b.requiredFields=[];b.view=null;return b}t._inheritsLoose(x,A);var l=x.prototype;l.initialize=function(){z.init(this,"layer.renderer layer.labelingInfo layer.elevationInfo.featureExpressionInfo layer.displayField filter effect layer.timeInfo layer.floorInfo timeExtent".split(" "),
()=>this._handleRequiredFieldsChange(),!0);z.on(this,"view.floors","change",()=>this._handleRequiredFieldsChange());z.on(this,"layer.sublayer","change",()=>this._handleRequiredFieldsChange())};l.highlight=function(b){throw Error("missing implementation");};l.createQuery=function(){var b={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};b=p.isSome(this.filter)?this.filter.createQuery(b):new I(b);if("feature"===this.layer.type){const c=D.getFloorFilterClause(this);p.isSome(c)&&
(b.where=b.where?`(${b.where}) AND (${c})`:c)}p.isSome(this.timeExtent)&&(b.timeExtent=p.isSome(b.timeExtent)?b.timeExtent.intersection(this.timeExtent):this.timeExtent.clone());return b};l.queryFeatures=function(b,c){throw Error("missing implementation");};l.queryObjectIds=function(b,c){throw Error("missing implementation");};l.queryFeatureCount=function(b,c){throw Error("missing implementation");};l.queryExtent=function(b,c){throw Error("missing implementation");};l._loadArcadeModules=function(b){if(b.get("expressionInfos.length"))return J.loadArcade()};
l._handleRequiredFieldsChange=function(){const b=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",b);b.then(()=>{this._updatingRequiredFieldsPromise===b&&this._set("_updatingRequiredFieldsPromise",null)})};l._updateRequiredFields=function(){var b=t._asyncToGenerator(function*(){if(this.layer&&this.view){var c="3d"===this.view.type,{layer:a,layer:{fieldsIndex:q,objectIdField:k}}=this,f="renderer"in a&&a.renderer,g="orderBy"in a&&a.orderBy,m=a.featureReduction,d=new Set;f=yield C.eachAlways([f?
f.collectRequiredFields(d,q):null,e.collectLabelingFields(d,a),c?e.collectElevationFields(d,a):null,p.isSome(this.filter)?e.collectFilterFields(d,a,this.filter):null,this.effect?e.collectFilterFields(d,a,this.effect.filter):null,m?e.collectFeatureReductionFields(d,a,m):null,g?e.collectOrderByInfos(d,a,g):null]);a.timeInfo&&this.timeExtent&&e.collectFields(d,a.fieldsIndex,[a.timeInfo.startField,a.timeInfo.endField]);"feature"===a.type&&a.floorInfo&&e.collectFields(d,a.fieldsIndex,[a.floorInfo.floorField]);
"subtype-group"===a.type&&(e.collectField(d,q,a.subtypeField),g=a.sublayers.map(u=>{var F;return Promise.all([null==(F=u.renderer)?void 0:F.collectRequiredFields(d,q),e.collectLabelingFields(d,u)])}),yield C.eachAlways(g));for(const u of f)u.error&&E.error(u.error);e.collectField(d,q,k);c&&"displayField"in a&&a.displayField&&e.collectField(d,q,a.displayField);c=Array.from(d).sort();this._set("requiredFields",c)}});return function(){return b.apply(this,arguments)}}();l.validateFetchPopupFeatures=function(b){if(p.isNone(b))return null;
for(const c of b.clientGraphics){const a=c.layer;if("popupEnabled"in a&&!a.popupEnabled)return new B("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:a});if("popupTemplate"in a&&!w.getFetchPopupTemplate(a,b))return new B("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:a})}};l.fetchClientPopupFeatures=function(){var b=t._asyncToGenerator(function*(c){var a=p.isSome(c)?c.clientGraphics:null;if(!a||0===a.length)return Promise.resolve([]);const q=
[],k=[],f=yield this.createPopupQuery(c);for(const m of a){var {layer:g}=m;if(!("popupEnabled"in g))continue;a=e.unpackFieldNames(this.layer.fieldsIndex,f.outFields);g=w.getFetchPopupTemplate(g,c);if(!p.isSome(g))continue;const d=yield this._loadArcadeModules(g);d&&d.arcadeUtils.hasGeometryOperations(g)||!e.featureHasFields(a,m)?k.push(m):q.push(m)}if("stream"===this.layer.type||0===k.length)return Promise.resolve(q);f.objectIds=k.map(m=>m.attributes[this.layer.objectIdField]);return this.layer.queryFeatures(f).then(m=>
q.concat(m.features)).catch(()=>k)});return function(c){return b.apply(this,arguments)}}();l.createPopupQuery=function(){var b=t._asyncToGenerator(function*(c){const a=this.layer.createQuery(),q=new Set;var k=!1,f=p.isSome(c)&&c.clientGraphics?c.clientGraphics.map(g=>g.layer):[this.layer];for(const g of f)if("popupEnabled"in g&&(f=w.getFetchPopupTemplate(g,c),p.isSome(f))){k=(k=yield this._loadArcadeModules(f))&&k.arcadeUtils.hasGeometryOperations(f);k=!("point"!==this.layer.geometryType&&!k);f=yield w.getRequiredFields(this.layer,
f);for(const m of f)q.add(m)}a.returnGeometry=k;a.returnZ=k;a.returnM=k;a.outFields=Array.from(q);a.outSpatialReference=this.view.spatialReference;"feature"===this.layer.type&&(c=D.getFloorFilterClause(this),p.isSome(c)&&(a.where=a.where?`(${a.where}) AND (${c})`:c));return a});return function(c){return b.apply(this,arguments)}}();l.canResume=function(){return!A.prototype.canResume.call(this)||p.isSome(this.timeExtent)&&this.timeExtent.isEmpty?!1:!0};t._createClass(x,[{key:"availableFields",get:function(){const {layer:b,
layer:{fieldsIndex:c},requiredFields:a}=this;return"outFields"in b&&b.outFields?e.fixFields(c,[...e.unpackFieldNames(c,b.outFields),...a]):e.fixFields(c,a)}},{key:"maximumNumberOfFeatures",get:function(){return 0},set:function(b){E.error("#maximumNumberOfFeatures\x3d","Setting maximum number of features is not supported")}},{key:"maximumNumberOfFeaturesExceeded",get:function(){return!1}}]);return x}(h);n.__decorate([r.property()],h.prototype,"_updatingRequiredFieldsPromise",void 0);n.__decorate([r.property({readOnly:!0})],
h.prototype,"availableFields",null);n.__decorate([r.property({type:K})],h.prototype,"effect",void 0);n.__decorate([r.property({type:L})],h.prototype,"filter",void 0);n.__decorate([r.property(H.combinedViewLayerTimeExtentProperty)],h.prototype,"timeExtent",void 0);n.__decorate([r.property()],h.prototype,"layer",void 0);n.__decorate([r.property({type:Number})],h.prototype,"maximumNumberOfFeatures",null);n.__decorate([r.property({readOnly:!0,type:Boolean})],h.prototype,"maximumNumberOfFeaturesExceeded",
null);n.__decorate([r.property({readOnly:!0})],h.prototype,"requiredFields",void 0);n.__decorate([r.property()],h.prototype,"suspended",void 0);n.__decorate([r.property()],h.prototype,"view",void 0);return h=n.__decorate([G.subclass("esri.views.layers.FeatureLayerView")],h)};y.FeatureLayerView=v;y["default"]=v;Object.defineProperty(y,"__esModule",{value:!0})});