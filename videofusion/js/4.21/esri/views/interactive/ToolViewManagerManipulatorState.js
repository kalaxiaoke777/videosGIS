// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.21/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../core/MapUtils ../../core/mathUtils ../../core/maybe ../../core/screenUtils ./interactiveToolUtils ../support/screenUtils".split(" "),function(y,z,u,g,A,v,m){const q={manipulator:null,tool:null};return function(){function r(){this._pointerLocations=new Map;this._hoveredManipulators=new Map;this._grabbedManipulators=new Map;this._draggedManipulators=new Map;this._stopDrag=!1;this._currentlyActiveTool=null;this._revertToActiveTool=!1;this._cursor=
null}var k=r.prototype;k.handleInputEvent=function(a,e){var d=()=>a.stopPropagation();switch(a.type){case "pointer-move":"mouse"===a.pointerType&&this._pointerLocations.set(a.pointerId,{x:a.x,y:a.y,pointerType:a.pointerType});break;case "drag":0<this._grabbedManipulators.size&&(this._stopDrag=!0);this._stopDrag&&(a.stopPropagation(),"end"===a.action&&(this._stopDrag=!1));break;case "pointer-down":if("mouse"===a.pointerType&&0!==a.button)break;d=m.createScreenPointFromEvent(a);var c=this._intersect(d,
a.pointerType,e.forEachTool);if(g.isNone(c))break;var f=this._findToolAndManipulatorByKey(c,e.forEachTool,q),b=g.applySome(f,l=>l.manipulator);f=g.applySome(f,l=>l.tool);!(g.isSome(b)&&g.isSome(f)&&b.interactive)||b.grabbable&&b.grabbableForEvent(a)||!b.grabbing||b.dragging||this._ungrabManipulatorBeforeDragging(b,f,a);g.isSome(b)&&b.interactive&&b.grabbable&&b.grabbableForEvent(a)&&!b.grabbing&&(this._grabbedManipulators.set(a.pointerId,{key:c,start:d,pointerType:a.pointerType}),1===this._grabbedManipulators.size&&
e.activeTool!==c.tool&&(this._currentlyActiveTool=e.activeTool,this._revertToActiveTool=!0,e.setActiveTool(c.tool)),b.grabbing=!0,b.events.emit("grab-changed",{action:"start",pointerType:a.pointerType,screenPoint:d}),a.stopPropagation());break;case "pointer-up":this._handlePointerEnd(a,e);break;case "pointer-drag":if("mouse"===a.pointerType&&0!==a.button)break;var h=this._grabbedManipulators.get(a.pointerId);d=this._draggedManipulators.get(a.pointerId);c=g.applySome(h||d,({key:l})=>l);b=this._findManipulatorByKey(c,
e.forEachTool);if(g.isNone(b))break;f=m.createScreenPointFromEvent(a);f.x=u.clamp(f.x,0,e.view.width);f.y=u.clamp(f.y,0,e.view.height);h=g.unwrap(h||d).start;switch(a.action){case "start":case "update":if("update"===a.action||1===this._grabbedManipulators.size)b.dragging=!0,d?b.events.emit("drag",{action:"update",start:h,screenPoint:f}):b.events.emit("drag",{action:"start",start:h,screenPoint:f,pointerType:a.pointerType}),this._draggedManipulators.set(a.pointerId,{key:g.unwrap(c),start:h});break;
case "end":b.dragging=!1,d&&b.events.emit("drag",{action:"end",start:h,screenPoint:f}),this._draggedManipulators.delete(a.pointerId),this._handlePointerEnd(a,e)}a.stopPropagation();break;case "immediate-click":{c=m.createScreenPointFromEvent(a);b=this._intersect(c,a.pointerType,e.forEachTool);const l=this._findToolAndManipulatorByKey(b,e.forEachTool,q);a.native.shiftKey||e.forEachTool(n=>{if((!g.isSome(l)||l.tool!==n||n.automaticManipulatorSelection)&&n.manipulators){let w=!1;n.manipulators.forEach(({manipulator:x})=>
{x.selected&&(x.selected=!1,w=!0)});w&&n.manipulatorSelectionChanged&&n.manipulatorSelectionChanged()}});if(g.isNone(l))break;const {manipulator:p,tool:t}=l;if(!p.interactive)break;p.selectable&&t.automaticManipulatorSelection&&(p.selected=!p.selected,t.manipulatorSelectionChanged&&t.manipulatorSelectionChanged());p.events.emit("immediate-click",{screenPoint:c,button:a.button,pointerType:a.pointerType,shiftKey:a.native.shiftKey,stopPropagation:d});break}case "click":d=m.createScreenPointFromEvent(a);
c=this._intersect(d,a.pointerType,e.forEachTool);c=this._findManipulatorByKey(c,e.forEachTool);if(g.isNone(c)||!c.interactive)break;c.events.emit(a.type,{screenPoint:d,button:a.button,pointerType:a.pointerType,shiftKey:a.native.shiftKey});a.stopPropagation();break;case "double-click":c=m.createScreenPointFromEvent(a);b=this._intersect(c,a.pointerType,e.forEachTool);b=this._findManipulatorByKey(b,e.forEachTool);if(g.isNone(b)||!b.interactive)break;b.events.emit("double-click",{screenPoint:c,button:a.button,
pointerType:a.pointerType,shiftKey:a.native.shiftKey,stopPropagation:d});break;case "immediate-double-click":c=m.createScreenPointFromEvent(a),b=this._intersect(c,a.pointerType,e.forEachTool),b=this._findManipulatorByKey(b,e.forEachTool),!g.isNone(b)&&b.interactive&&b.events.emit("immediate-double-click",{screenPoint:c,button:a.button,pointerType:a.pointerType,shiftKey:a.native.shiftKey,stopPropagation:d})}this._updateCursor(e.forEachTool)};k._ungrabManipulatorBeforeDragging=function(a,e,d){a.grabbing=
!1;a.events.emit("grab-changed",{action:"end",pointerType:d.pointerType,screenPoint:m.createScreenPointFromEvent(d)});this._grabbedManipulators.forEach(({key:c},f)=>{c.tool===e&&e.manipulators.findById(c.manipulatorId)===a&&this._grabbedManipulators.delete(f)})};k._handlePointerEnd=function(a,e){var d=g.applySome(this._grabbedManipulators.get(a.pointerId),({key:c})=>c);d=this._findManipulatorByKey(d,e.forEachTool);g.isSome(d)&&!d.dragging&&(1===this._grabbedManipulators.size&&0===this._draggedManipulators.size&&
this._revertToActiveTool&&(e.setActiveTool(this._currentlyActiveTool),this._revertToActiveTool=!1,this._currentlyActiveTool=null),d.grabbing&&(d.grabbing=!1,d.events.emit("grab-changed",{action:"end",pointerType:a.pointerType,screenPoint:m.createScreenPointFromEvent(a)})),this._grabbedManipulators.delete(a.pointerId))};k._cursorFromMap=function(a,e){let d=null;z.someMap(a,({key:c})=>{c=this._findManipulatorByKey(c,e);return g.isSome(c)&&c.interactive&&"cursor"in c&&c.cursor?(d=c.cursor,!0):!1});return d};
k._updateCursor=function(a){this._cursor=0<this._grabbedManipulators.size?this._cursorFromMap(this._grabbedManipulators,a)||"grabbing":0<this._hoveredManipulators.size?this._cursorFromMap(this._hoveredManipulators,a)||"pointer":null};k.clearPointers=function(a,e,d=!0,c){const f=b=>b.tool===a&&(g.isNone(c)||b.manipulatorId===c);this._grabbedManipulators.forEach(({key:b,pointerType:h},l)=>{f(b)&&(this._grabbedManipulators.delete(l),b=this._findManipulatorByKey(b,e),g.isSome(b)&&(b.grabbing=!1,b.events.emit("grab-changed",
{action:"end",screenPoint:null,pointerType:h})))});this._draggedManipulators.forEach(({key:b},h)=>{f(b)&&(this._draggedManipulators.delete(h),b=this._findManipulatorByKey(b,e),g.isSome(b)&&(b.dragging=!1,b.events.emit("drag",{action:"cancel"})))});d&&this._hoveredManipulators.forEach(({key:b},h)=>{f(b)&&(this._hoveredManipulators.delete(h),b=this._findManipulatorByKey(b,e),g.isSome(b)&&(b.hovering=!1))});this._updateCursor(e)};k._intersect=function(a,e,d){let c=null;d(f=>{if(null==f.manipulators||
!v.areToolManipulatorsEditable(f))return!1;const b=f.manipulators.intersect(a,e);if(g.isNone(b))return!1;c={manipulatorId:b.id,tool:f};return!0});return c};k.updateHoveredStateFromKnownPointers=function(a){this._pointerLocations.forEach((e,d)=>{this._updateHoveredStateForPointerAtScreenPosition(A.createScreenPoint(e.x,e.y),d,e.pointerType,a)})};k.handleHoverEvent=function(a,e){"pointer-up"!==a.type&&"immediate-click"!==a.type&&"pointer-move"!==a.type||"mouse"!==a.pointerType||this._updateHoveredStateForPointerAtScreenPosition(m.createScreenPointFromEvent(a),
a.pointerId,a.pointerType,e)};k._updateHoveredStateForPointerAtScreenPosition=function(a,e,d,c){a=this._intersect(a,d,c);d=this._findManipulatorByKey(a,c);var f=g.applySome(this._hoveredManipulators.get(e),({key:b})=>b);f=this._findManipulatorByKey(f,c);g.isSome(d)&&!d.interactive&&(d=null);f!==d&&(g.isSome(f)&&(f.hovering=!1),g.isSome(d)?(d.hovering=!0,this._hoveredManipulators.set(e,{key:g.unwrap(a)})):this._hoveredManipulators.delete(e),this._updateCursor(c))};k._findManipulatorByKey=function(a,
e){return this._findToolAndManipulatorByKey(a,e,q)?q.manipulator:null};k._findToolAndManipulatorByKey=function(a,e,d){if(g.isNone(a))return null;d.tool=null;d.manipulator=null;e(c=>{if(c!==a.tool||null==c.manipulators||!v.areToolManipulatorsEditable(c))return!1;const f=c.manipulators.findById(a.manipulatorId);return g.isSome(f)?(d.manipulator=f,d.tool=c,!0):!1});return d.manipulator?d:null};y._createClass(r,[{key:"cursor",get:function(){return this._cursor}}]);return r}()});