// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.21/esri/copyright.txt for details.
//>>built
define("exports ../../../../../core/maybe ../../../../../core/screenUtils ../definitions ./CollisionGrid ./visualVariableSimpleUtils".split(" "),function(A,y,D,B,x,E){function v(k,h){const d=[];k.forEachTile(c=>d.push(c));d.sort((c,e)=>c.instanceId-e.instanceId);d.forEach(c=>{y.isSome(c.labelMetrics)&&c.isReady&&h(c,c.labelMetrics.getCursor())})}function F(k){return h=>D.pt2px(E.getSizeForValueSimple(h,k))}function G(k){for(const d of k){var h;k=("featureReduction"in d&&"cluster"===(null==(h=d.featureReduction)?
void 0:h.type)&&d.featureReduction).labelingInfo||[];k=[...d.labelingInfo||[],...k];if(d.labelsVisible&&k.length&&k.some(c=>"none"===c.deconflictionStrategy))return!0}return!1}let I=function(){function k(){}var h=k.prototype;h.run=function(d,c,e){const g=[];for(let t=d.length-1;0<=t;t--)a:{var f=g,a=d[t];if("feature"!==a.layer.type&&"csv"!==a.layer.type&&"geojson"!==a.layer.type&&"ogc-feature"!==a.layer.type&&"stream"!==a.layer.type&&"subtype-group"!==a.layer.type&&"wfs"!==a.layer.type)break a;const u=
a.layer.geometryType,w=!G("subtype-group"===a.layer.type?a.layer.sublayers.items:[a.layer]),p={};if("subtype-group"!==a.layer.type){if("heatmap"===a.layer.renderer.type)break a;b:{var b=a.layer.renderer;if(b="visualVariables"in b&&b.visualVariables)for(const q of b)if("size"===q.type){b=F(q);break b}b=null}p[0]=b}b=a.tileRenderer;y.isNone(b)||f.push({tileRenderer:b,vvEvaluators:p,deconflictionEnabled:w,geometryType:u,visible:a.layer.visible})}this._transformMetrics(g,c);this._runCollision(g,c,e)};
h._runCollision=function(d,c,e){const [g,f]=c.state.size;c=new x.CollisionBitsetGrid(g*c.pixelRatio,f*c.pixelRatio);for(const {tileRenderer:a,deconflictionEnabled:b,visible:t}of d){const u=a.featuresView.attributeView;b?t?(this._prepare(a),this._collideVisible(c,a,e),this._collideInvisible(c,a)):v(a,(w,p)=>{for(;p.nextId();)u.setLabelMinZoom(p.id,255)}):v(a,(w,p)=>{for(;p.nextId();)u.setLabelMinZoom(p.id,0)})}};h._isFiltered=function(d,c,e){d=c.getFilterFlags(d);c=!e.effect||e.effect.excludedLabelsVisible||
!!(d&B.EFFECT_FLAG_0);return!((!e.hasFilter||d&B.FILTER_FLAG_0)&&c)};h._prepare=function(d){const c=d.featuresView.attributeView,e=new Set;v(d,(g,f)=>{for(;f.nextId();)e.has(f.id)||(e.add(f.id),this._isFiltered(f.id,c,d.layerView)?c.setLabelMinZoom(f.id,254):0!==c.getLabelMinZoom(f.id)?c.setLabelMinZoom(f.id,255):c.setLabelMinZoom(f.id,0))})};h._collideVisible=function(d,c,e){const g=c.featuresView.attributeView,f=new Set;v(c,(a,b)=>{for(;b.nextId();)if(!f.has(b.id))if(a.key.level!==e)g.setLabelMinZoom(b.id,
254);else if(0===g.getLabelMinZoom(b.id))switch(d.insertMetrics(b)){case x.HAS_COLLISION:g.setLabelMinZoom(b.id,254);f.add(b.id);break;case x.NONE:g.setLabelMinZoom(b.id,0),f.add(b.id)}})};h._collideInvisible=function(d,c){const e=c.featuresView.attributeView,g=new Set;v(c,(f,a)=>{for(;a.nextId();)if(!g.has(a.id)&&255===e.getLabelMinZoom(a.id))switch(d.insertMetrics(a)){case x.HAS_COLLISION:e.setLabelMinZoom(a.id,255);g.add(a.id);break;case x.NONE:e.setLabelMinZoom(a.id,0),g.add(a.id)}})};h._transformMetrics=
function(d,c){for(const {tileRenderer:e,geometryType:g,vvEvaluators:f}of d)v(e,(a,b)=>{const t=e.featuresView.attributeView;a=a.transforms.labelMat2d;a[4]=Math.round(a[4]);a[5]=Math.round(a[5]);const u=a[4],w=a[5],p="polyline"===g;for(;b.next();){const H=b.boundsCount,z=b.anchorX,C=b.anchorY;var q=b.size,r=f[0];if(y.isSome(r)){var l=t.getVVSize(b.id);r=r(l);q=isNaN(r)||null==r||Infinity===r?q:r}r=q/2*b.directionX;q=q/2*b.directionY;for(l=0;l<H;l++){var m=z,n=b.anchorY;p?(m=m+b.boundsX(l)+r,n=n+b.boundsY(l)+
q,c.state.rotation?(m=a[0]*m+a[2]*n+a[4],n=a[1]*m+a[3]*n+a[5]):(m+=u,n+=w),b.setBoundsComputedAnchorX(l,Math.floor(m)),b.setBoundsComputedAnchorY(l,Math.floor(n))):(c.state.rotation?(m=a[0]*z+a[2]*C+a[4],n=a[1]*z+a[3]*C+a[5]):(m+=u,n+=w),m=m+b.boundsX(l)+r,n=n+b.boundsY(l)+q,b.setBoundsComputedAnchorX(l,m),b.setBoundsComputedAnchorY(l,n))}}})};return k}();A.CollisionEngine=I;Object.defineProperty(A,"__esModule",{value:!0})});