// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.21/esri/copyright.txt for details.
//>>built
define("exports ../../../../../../chunks/_rollupPluginBabelHelpers ../../../../../../core/has ../../../../../../core/maybe ../../../../../../core/promiseUtils ../../../../../../geometry/libtess ../templates/WGLLabelTemplate ../templates/WGLMarkerTemplate ../templates/WGLTemplateStore ../../../../layers/features/support/AttributeStore".split(" "),function(v,r,w,p,x,z,y,A,q,B){w=function(){function t(b,a,c){this._loadPromise=z.loadLibtess();this._geometryType=b;this._idField=a;this._templateStore=c}
var n=t.prototype;n.update=function(b,a){p.isSome(b.mesh.labels)&&(this._labelTemplates=this._createLabelTemplates(b.mesh.labels,a));this._schema=b};n._createLabelTemplates=function(b,a){const c=new Map;if("simple"===b.type){for(var e of b.classes)b=y.fromLabelClass(e,a),c.set(e.index,b);return c}for(const g in b.classes){e=b.classes[g];for(const d of e)e=y.fromLabelClass(d,a),c.set(d.index,e)}return c};n.analyze=function(){var b=r._asyncToGenerator(function*(a,c,e,g,d,f){if(!x.isAborted(f)){var l;
"dictionary"===c.type&&(l=yield c.analyze(this._idField,a.copy(),g,d,f));for(var k=0;a.next();){var h=void 0;h=l?l[k++]:p.isSome(e)&&B.isAggregateId(a.getDisplayId())&&1!==a.readAttribute("cluster_count")?e.match(this._idField,a,this._geometryType,g,d):c.match(this._idField,a,this._geometryType,g,d);a.setGroupId(h);if(q.isDynamicId(h)){h=this._templateStore.getDynamicTemplateGroup(h);for(const m of h)m&&m.analyze&&m.analyze(this._templateStore,a,g,d)}}yield this._loadPromise;return this._templateStore.finalize(f)}});
return function(a,c,e,g,d,f){return b.apply(this,arguments)}}();n.analyzeGraphics=function(){var b=r._asyncToGenerator(function*(a,c,e,g,d){if(!x.isAborted(d)){a=a.getCursor();for(c&&(yield c.analyze(this._idField,a.copy(),e,g,d));a.next();){let f=a.getGroupId();if(null==f||-1===f)f=c.match(this._idField,a,a.geometryType,e,g),a.setGroupId(f);if(q.isDynamicId(f)){const l=this._templateStore.getDynamicTemplateGroup(f);for(const k of l)k&&k.analyze&&k.analyze(this._templateStore,a,e,g)}a.setGroupId(f)}yield this._loadPromise;
return this._templateStore.finalize(d)}});return function(a,c,e,g,d){return b.apply(this,arguments)}}();n.writeGraphic=function(b,a,c){const e=a.getGroupId(),g=a.getDisplayId(),d=this._templateStore.getTemplateGroup(e);b.featureStart(a.insertAfter,0);if(null!=g){if(q.isDynamicId(e))for(const f of d)f.bindFeature(a,null,null);if(d){for(const f of d)f&&f.write(b,a,c);b.featureEnd()}}};n.writeCursor=function(b,a,c,e,g,d){const f=a.getGroupId(),l=a.getDisplayId(),k=this._templateStore.getTemplateGroup(f),
h=this._schema.mesh.sortKey;let m=0;p.isSome(h)&&(m=null!=h.fieldIndex?a.getComputedNumericAtIndex(h.fieldIndex):null!=h.field?a.readAttribute(h.field):a.readAttribute(this._idField),m*="asc"===h.order?1:-1);b.featureStart(0,null==m||isNaN(m)?0:m);if(null!=l&&k){if(q.isDynamicId(f))for(const u of k)u.bindFeature(a,c,e);for(const u of k)u.write(b,a,g);p.isSome(d)&&b.hasRecords&&(c=d&&this._findLabelRef(k),this._writeLabels(b,a,d,c,g));b.featureEnd()}};n._findLabelRef=function(b){for(const a of b)if(a instanceof
A)return a;return null};n._writeLabels=function(b,a,c,e,g){for(const d of c)if(p.isSome(d)&&d){const {glyphs:f,rtl:l,index:k}=d;c=this._labelTemplates.get(k);c.setZoomLevel(g);c.bindReferenceTemplate(e);c.bindTextInfo(f,l);c.write(b,a,null)}};r._createClass(t,[{key:"templates",get:function(){return this._templateStore}}]);return t}();v.WGLMeshFactory=w;Object.defineProperty(v,"__esModule",{value:!0})});