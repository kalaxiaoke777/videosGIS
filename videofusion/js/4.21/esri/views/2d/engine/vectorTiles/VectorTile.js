// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.21/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/maybe ../../../../chunks/mat3 ../../../../chunks/mat3f32 ./RenderBucket ./decluttering/config ../webgl/TiledDisplayObject".split(" "),function(m,q,r,k,n,l,t,p){p=function(h){function g(b,a,c,e,f,v,w=null){a=h.call(this,b,a,c,e,f,4096,4096)||this;a._memCache=w;a.type="vector-tile";a._referenced=0;a._hasSymbolBuckets=!1;a._memoryUsedByLayerData=0;a.layerData=new Map;a.layerCount=0;a.status="loading";a.allSymbolsFadingOut=
!1;a.lastOpacityUpdate=0;a.symbols=new Map;a.isCoverage=!1;a.neededForCoverage=!1;a.decluttered=!1;a.invalidating=!1;a.parentTile=null;a.childrenTiles=new Set;a._processed=!1;a._referenced=1;a.styleRepository=v;a.id=b.id;return a}q._inheritsLoose(g,h);var d=g.prototype;d.setData=function(b){this.changeDataImpl(b);this.requestRender();this.ready();this.invalidating=!1;this._processed=!0};d.deleteLayerData=function(b){let a=!1;for(const c of b)this.layerData.has(c)&&(b=this.layerData.get(c),this._memoryUsedByLayerData-=
b.memoryUsed,3===b.type&&this.symbols.has(c)&&(this.symbols.delete(c),a=!0),b.destroy(),this.layerData.delete(c),this.layerCount--);r.isSome(this._memCache)&&this._memCache.updateSize(this.key.id,this,this._memoryUsedByLayerData);a&&this.emit("symbols-changed");this.requestRender()};d.processed=function(){return this._processed};d.hasData=function(){return 0<this.layerCount};d.dispose=function(){"unloaded"!==this.status&&(u.delete(this),g._destroyRenderBuckets(this.layerData),this.layerData=null,
this._memoryUsedByLayerData=this.layerCount=0,this.destroy(),this.status="unloaded")};d.release=function(){return 0===--this._referenced?(this.dispose(),this.stage=null,!0):!1};d.retain=function(){++this._referenced};d.changeDataImpl=function(b){let a=!1;if(b){b=this._createRenderBuckets(b);for(const [c,e]of b)this.layerData.has(c)&&(b=this.layerData.get(c),this._memoryUsedByLayerData-=e.memoryUsed,b.destroy(),this.layerData.delete(c),this.layerCount--),3===e.type&&(this.symbols.set(c,e.symbols),
a=!0),this._memoryUsedByLayerData+=e.memoryUsed,this.layerData.set(c,e),this.layerCount++;r.isSome(this._memCache)&&this._memCache.updateSize(this.key.id,this,this._memoryUsedByLayerData)}this._hasSymbolBuckets=!1;for(const [,c]of this.layerData)3===c.type&&(this._hasSymbolBuckets=!0);a&&this.emit("symbols-changed")};d.attachWithContext=function(b){this.stage={context:b,trashDisplayObject(a){a.processDetach()},untrashDisplayObject(){return!1}}};d.setTransform=function(b,a){h.prototype.setTransform.call(this,
b,a);var c=a/(b.resolution*b.pixelRatio);a=this.width/this.rangeX*c;c*=this.height/this.rangeY;const e=[0,0];b.toScreen(e,[this.x,this.y]);const f=this.transforms.tileUnitsToPixels;k.identity(f);k.translate(f,f,e);k.rotate(f,f,Math.PI*b.rotation/180);k.scale(f,f,[a,c,1])};d._createTransforms=function(){return{dvs:n.create(),tileMat3:n.create(),tileUnitsToPixels:n.create()}};g._destroyRenderBuckets=function(b){if(b){var a=new Set;b.forEach(c=>{a.has(c)||(c.destroy(),a.add(c))});b.clear()}};d._createRenderBuckets=
function(b){const a=new Map,c=new Map;for(const e of b){b=this._deserializeBucket(e,c);for(const f of b.layerUIDs)a.set(f,b)}return a};d._deserializeBucket=function(b,a){let c=a.get(b);if(c)return c;switch((new Uint32Array(b))[0]){case 1:c=new l.FillRenderBucket(b,this.styleRepository);break;case 2:c=new l.LineRenderBucket(b,this.styleRepository);break;case 3:c=new l.SymbolRenderBucket(b,this.styleRepository,this);break;case 4:c=new l.CircleRenderBucket(b,this.styleRepository)}a.set(b,c);return c};
q._createClass(g,[{key:"hasSymbolBuckets",get:function(){return this._hasSymbolBuckets}},{key:"isFading",get:function(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<t.FADE_DURATION}},{key:"isHoldingForFade",get:function(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<t.FADE_DURATION)}},{key:"wasRequested",get:function(){return"errored"===this.status||"loaded"===this.status||"reloading"===this.status}},{key:"referenced",
get:function(){return this._referenced}},{key:"memoryUsage",get:function(){return(this._memoryUsedByLayerData+256)/(this._referenced||1)}}]);return g}(p.TiledDisplayObject);const u=new Map;m.VectorTile=p;m.printAllocations=function(){u.forEach((h,g)=>{console.log(`\n${g.key}:`);h[0].forEach(d=>console.log(d));console.log("\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d");h[1].forEach(d=>console.log(d))})};Object.defineProperty(m,"__esModule",{value:!0})});