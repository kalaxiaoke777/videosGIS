// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.21/esri/copyright.txt for details.
//>>built
define("../../../../core/screenUtils ../../../../core/unitUtils ../../../../chunks/rbush ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/contains ../../../../geometry/support/extentUtils ../../../../geometry/support/jsonUtils ../../../../geometry/support/normalizeUtils ../../../../geometry/support/normalizeUtilsCommon ../../../../geometry/support/spatialReferenceUtils ../../../../symbols/cim/utils ./GraphicStoreItem ./graphicsUtils".split(" "),function(A,B,C,t,y,D,E,F,G,H,
I,z,q){function w(r,n,a,d,c){v.minX=n;v.minY=a;v.maxX=d;v.maxY=c;return r.search(v)}function J(r){return{minX:r.bounds[0],minY:r.bounds[1],maxX:r.bounds[2],maxY:r.bounds[3]}}const v={minX:0,minY:0,maxX:0,maxY:0},u=t.create();return function(){function r(a,d,c,e,h,k){this._graphics=e;this._onAdd=h;this._onRemove=k;this._index=C.rbush(9,J);this._itemByGraphic=new Map;this._currentLevel=-Infinity;this._tileInfoView=a;this._uidFieldName=c;if(d=a.getClosestInfoForScale(d))this._currentLevel=d.level,this._resolution=
this._tileInfoView.getTileResolution(d.level);this._metersPerUnit=H.isValid(a.spatialReference)?B.getMetersPerUnit(a.spatialReference):1}var n=r.prototype;n.hitTest=function(a,d,c,e,h){a=F.normalizeMapX(a,this._tileInfoView.spatialReference);var k=.5*e*c;u[0]=a-k;u[1]=d-k;u[2]=a+k;u[3]=d+k;c=.5*e*(c+q.PIXEL_BUFFER);var b=w(this._index,a-c,d-c,a+c,d+c);if(!b||0===b.length)return[];c={x:a,y:d};k=[];for(const g of b)if(g.graphic.visible)switch(E.getJsonType(g.geometry)){case "esriGeometryPoint":{b=g.symbol;
if(!b)continue;const {x:f,y:l}=g.geometry;var m=e*this._metersPerUnit;let p;switch(b.type){case "esriTS":p=q.getTextSymbolBounds(f,l,b,g.size,e,h);break;case "expanded-cim":p=q.getCIMMarkerBounds(f,l,b,e,m,h);break;case "esriSMS":case "esriPMS":p=q.getMarkerSymbolBounds(f,l,b,e,m,h)}y.polygonContainsPoint(p,c)&&k.push(g)}break;case "esriGeometryPolyline":b=g.symbol;m=0;if("expanded-cim"===b.type){b=b.layers;if(!b||0===b.length)continue;m=b.findIndex(f=>"line"===f.type);if(-1===m)continue;m=I.evaluateValueOrFunction(b[m].width,
null,null)}else{b=b.layers;if(!b||0===b.length)continue;m=b[0].width}b=1.5*e*window.devicePixelRatio*A.pt2px(m);q.isPointOnPolyline(g.geometry,a,d,b)&&k.push(g);break;case "esriGeometryEnvelope":b=g.geometry;b=t.fromValues(b.xmin,b.ymin,b.xmax,b.ymax);t.intersects(b,u)&&k.push(g);break;case "esriGeometryPolygon":if(y.polygonContainsPoint(g.geometry,c)){k.push(g);break}b=D.getPolygonExtent(g.geometry);if(Math.abs(b.ymax-b.ymin)<5*e||Math.abs(b.xmax-b.xmin)<5*e)b=t.fromValues(b.xmin,b.ymin,b.xmax,b.ymax),
t.intersects(b,u)&&k.push(g);break;case "esriGeometryMultipoint":{b=g.symbol;if(!b)continue;m=g.geometry.points;let f;for(let l=0;l<m.length;l++)if(f="esriTS"===b.type?q.getTextSymbolBounds(m[l][0],m[l][1],b,g.size,e,h):q.getMarkerSymbolBounds(m[l][0],m[l][1],b,e,e*this._metersPerUnit,h),y.polygonContainsPoint(f,c)){k.push(g);break}}}k.sort((g,f)=>{const l=q.graphicGeometryToNumber(g.graphic),p=q.graphicGeometryToNumber(f.graphic);return l===p?f.zorder-g.zorder:l-p});return k.map(g=>g.graphic)};n.getGraphicsData=
function(a,d,c){const e=this._searchForItems(d);if(0===e.length||0===c.length)return[];e.sort((f,l)=>f.zorder-l.zorder);e[0].insertAfter=-1;for(var h=1;h<e.length;h++)e[h].insertAfter=e[h-1].graphic.uid;e.sort((f,l)=>f.graphic.uid-l.graphic.uid);c.sort((f,l)=>f.uid-l.uid);let k=h=0,b;const m=[],g={originPosition:"upperLeft",scale:[d.resolution,d.resolution],translate:[d.bounds[0],d.bounds[3]]};for(const f of c){for(k=-2;h<e.length;)if(b=e[h],h++,f.uid===b.graphic.uid){k=b.insertAfter;break}if(!b.geometry||
-2===k)continue;c=b.getGeometryQuantized(g,d.bounds,this._tileInfoView.spatialReference);const l={...b.graphic.attributes};l[this._uidFieldName]=f.uid;null==b.groupId&&(b.groupId=a.createTemplateGroup(b.symbol,null));m.push({centroid:z.getCentroidQuantized(b,g),geometry:c,attributes:l,symbol:b.symbol,groupId:b.groupId,insertAfter:k,zorder:b.zorder})}m.sort((f,l)=>f.zorder-l.zorder);return m};n.queryTileData=function(a,d){if(0===this._graphics.length)return[];const {bounds:c,resolution:e}=d,h=this._searchForItems(d),
k=[];if(0===h.length)return k;this._createTileGraphics(k,a,h,{originPosition:"upperLeft",scale:[e,e],translate:[c[0],c[3]]},d);return k};n.has=function(a){return this._itemByGraphic.has(a)};n.getBounds=function(a){return this._itemByGraphic.has(a)?this._itemByGraphic.get(a).bounds:null};n.addOrModify=function(a,d,c){if(a)return this.has(a)&&this.remove(a),this._onAdd(a),d=z.acquire(a,d,c,this._resolution,this._resolution*this._metersPerUnit,this._tileInfoView.spatialReference),this._itemByGraphic.set(a,
d),c&&this._index.insert(d),d.bounds};n.remove=function(a){if(this._itemByGraphic.has(a)){this._onRemove(a);var d=this._itemByGraphic.get(a);this._index.remove(d);this._itemByGraphic.delete(a)}};n.updateZ=function(){const a=this._graphics.items;for(let c=0;c<a.length;c++){var d=a[c];if(d=this._itemByGraphic.get(d))d.zorder=c}};n.update=function(a,d,c){const e=this._itemByGraphic.get(a);e.groupId=null;const h=t.clone(e.bounds);e.size[0]=e.size[1]=0;this._index.remove(e);e.set(a,d,c,this._resolution,
this._resolution*this._metersPerUnit,this._tileInfoView.spatialReference);c&&this._index.insert(e);return{oldBounds:h,newBounds:e.bounds}};n.updateLevel=function(a){if(this._currentLevel!==a){this._currentLevel=a;var d=this._tileInfoView;this._resolution=d.getTileResolution(a);this._index.clear();a=this._itemByGraphic;var c=[];for(const [,e]of a)e.updateBounds(this._resolution,this._resolution*this._metersPerUnit,d.spatialReference),e.geometry&&c.push(e);this._index.load(c)}};n.clear=function(){this._itemByGraphic.clear();
this._index.clear()};n._createTileGraphics=function(a,d,c,e,h){const k=this._uidFieldName,b=this._tileInfoView.spatialReference;({bounds:h}=h);c.sort((p,x)=>p.zorder-x.zorder);let m,g,f,l;for(let p=0;p<c.length;p++){f=c[p];m=f.graphic;g=f.getGeometryQuantized(e,h,b);l=0===p?-1:c[p-1].graphic.uid;const x={...f.graphic.attributes};x[k]=m.uid;null==f.groupId&&(f.groupId=d.createTemplateGroup(f.symbol,null));a.push({centroid:z.getCentroidQuantized(f,e),geometry:g,attributes:x,symbol:f.symbol,groupId:f.groupId,
insertAfter:l,zorder:f.zorder})}};n._searchForItems=function(a){var d=this._tileInfoView.spatialReference,c=a.bounds;if(d.isWrappable){const [e,h]=G.getSpatialReferenceMinMaxX(d);d=1E-5>Math.abs(c[2]-h);const k=1E-5>Math.abs(c[0]-e);if(!(d&&k||!d&&!k))return a=a.resolution,a=d?t.create([e,c[1],e+a*q.PIXEL_BUFFER,c[3]]):t.create([h-a*q.PIXEL_BUFFER,c[1],h,c[3]]),c=w(this._index,c[0],c[1],c[2],c[3]),a=w(this._index,a[0],a[1],a[2],a[3]),[...new Set([...c,...a])]}return w(this._index,c[0],c[1],c[2],c[3])};
return r}()});