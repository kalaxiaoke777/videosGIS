// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.21/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/HandleOwner ../../../../core/has ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/screenUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/Logger ../../../../core/accessorSupport/decorators/subclass ../../../../geometry/Polygon ../../../../geometry/SpatialReference ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/coordsUtils ../../../../geometry/support/jsonUtils ../../../../geometry/support/normalizeUtilsSync ../../../../geometry/support/spatialReferenceUtils ../../../../layers/graphics/data/projectionSupport ../../../../symbols/cim/cimSymbolUtils ../../../../symbols/support/defaults ../../engine/webgl/definitions ../../engine/webgl/GraphicTile ../../engine/webgl/TileData ../../engine/webgl/WGLDisplayObject ../../engine/webgl/mesh/MeshData ../../engine/webgl/mesh/factories/WGLMeshFactory ../../engine/webgl/mesh/templates/WGLTemplateStore ../../engine/webgl/util/BidiText ../../engine/webgl/util/Matcher ../features/schemaUtils ../features/support/AttributeStore ../features/support/ComputedAttributeStorage ../features/support/GraphicsReader ./GraphicStore ./graphicsUtils ../../../layers/GraphicsView ../../../webgl/capabilities".split(" "),
function(n,w,r,K,ha,A,k,L,x,ia,ja,M,N,O,D,P,p,Q,G,H,R,E,S,T,I,U,V,W,X,Y,Z,J,aa,ba,ca,da,m,ea,fa){function F(y,t,e){if(e.has(y))return e.get(y);t={tile:t,addedOrModified:[],removed:[]};e.set(y,t);return t}r=function(y){function t(a){a=y.call(this,a)||this;a._storage=new ba.ComputedAttributeStorage;a._displayIds=new Map;a._controller=new AbortController;a._tiles=new Map;a._graphicStoreUpdate=!1;a._graphicsSet=new Set;a._matcher=Promise.resolve(null);a._tileUpdateSet=new Set;a._tilesToUpdate=new Map;
a._graphicIdToAbortController=new Map;a._attached=!1;a._highlightIds=new Map;a._updatingGraphicsTimer=null;a._hashToExpandedSymbol=new Map;a._hashTpExpandedSymbolPromise=new Map;a._processing=!1;a._needsProcessing=!1;a._pendingUpdate={added:new Set,updated:new Set,removed:new Set};a.lastUpdateId=-1;a.updateRequested=!1;a.graphicUpdateHandler=a.graphicUpdateHandler.bind(n._assertThisInitialized(a));return a}n._inheritsLoose(t,y);var e=t.prototype;e._createMatcher=function(a,b){a&&(a=J.createMatcherSchema({indexCount:0,
fields:{}},"feature",a),this._matcher=Z.createMatcher(a,b,null))};e._createDisplayId=function(a){this._displayIds.has(a)||this._displayIds.set(a,this._storage.createDisplayId());return this._displayIds.get(a)};e.initialize=function(){this._attributeStore=new aa["default"]({type:"local",initialize:b=>Promise.resolve(this.container.attributeView.initialize(b)),update:b=>this.container.attributeView.requestUpdate(b),render:()=>this.container.requestRender()},fa());this.container.hasHighlight=()=>!!this._highlightIds.size;
this._graphicStore=new da(this.view.featuresTilingScheme,this.view.state.scale,this.uid,this.graphics,b=>{this._createDisplayId(b.uid);this._setFilterState(b.uid,b.visible)},b=>{const c=this._displayIds.get(b.uid);this._displayIds.delete(b.uid);this._storage.releaseDisplayId(c)});const a=new X.WGLTemplateStore(this.container.getMaterialItems.bind(this.container),this.view.featuresTilingScheme.tileInfo);this._createMatcher(this.renderer,a);this._meshFactory=new W.WGLMeshFactory(null,this.uid,a);this._templateStore=
a;this.handles.add([this.watch("renderer",b=>{this._createMatcher(b,a);for(const c of this.graphics)this._pendingUpdate.updated.add(c);this.requestUpdate()}),this.view.graphicsTileStore.on("update",this._onTileUpdate.bind(this)),this.container.on("attach",()=>{0<this.graphics.items.length&&this._graphicsChangeHandler({target:this.graphics,added:this.graphics.items,removed:[],moved:[]});this.handles.add(this.graphics.on("change",b=>this._graphicsChangeHandler(b)),"graphics");this._attached=!0;this.notifyChange("updating")})]);
this._onTileUpdate({added:this.view.graphicsTileStore.tiles,removed:[]})};e.destroy=function(){this._updatingGraphicsTimer&&(clearTimeout(this._updatingGraphicsTimer),this._updatingGraphicsTimer=null,this.notifyChange("updating"));this._controller.abort();this.container.destroy();this._set("graphics",null);this._graphicStore.clear();this._attributeStore=null;this._hashToExpandedSymbol.clear();this.renderer=this.view=null};e.hitTest=function(a,b){if(!this.view||!this.view.position)return Promise.resolve(null);
a=this.view.toMap(L.createScreenPoint(a,b));return this.searchFeatures(a).then(c=>c&&c.length?c[0]:null)};e.searchFeatures=function(){var a=n._asyncToGenerator(function*(b,c=2){return this._graphicStore.hitTest(b.x,b.y,c,this.view.state.resolution,this.view.state.rotation)});return function(b){return a.apply(this,arguments)}}();e.update=function(a){k.throwIfAborted(this._controller.signal);a=this.view.featuresTilingScheme.getClosestInfoForScale(a.state.scale).level;this._graphicStore.updateLevel(a);
this._graphicStoreUpdate=!0;this.updateRequested=!1;0<this._pendingUpdate.updated.size&&(this._processing?this._needsProcessing=!0:this._updateGraphics())};e.viewChange=function(){this.requestUpdate()};e.requestUpdate=function(){this.updateRequested||(this.updateRequested=!0,this.requestUpdateCallback())};e.processUpdate=function(a){this.updateRequested&&(this.updateRequested=!1,this.update(a))};e.graphicUpdateHandler=function(a){const {graphic:b,property:c,newValue:d}=a;switch(c){case "geometry":case "symbol":this._pendingUpdate.updated.add(b);
this.requestUpdate();break;case "visible":this._setFilterState(b.uid,d),this._attributeStore.sendUpdates()}};e.addHighlight=function(a){for(const b of a)this._highlightIds.has(b)?(a=this._highlightIds.get(b),this._highlightIds.set(b,a+1)):this._highlightIds.set(b,1);this._updateHighlight()};e.removeHighlight=function(a){for(const b of a)this._highlightIds.has(b)&&(a=this._highlightIds.get(b)-1,0===a?this._highlightIds.delete(b):this._highlightIds.set(b,a));this._updateHighlight()};e._updateHighlight=
function(){const a=Array.from(this._highlightIds.keys()),b=a.map(c=>this._displayIds.get(c));this._attributeStore.setHighlight(a,b)};e._getIntersectingTiles=function(a){a=this._graphicStore.getBounds(a);if(!a||0===D.width(a)||0===D.height(a))return[];const b=m.intersectingInternationalDateline(a,this.view.spatialReference);return A.isSome(b)?[...new Set([...this.view.graphicsTileStore.boundsIntersections(b[0]),...this.view.graphicsTileStore.boundsIntersections(b[1])])]:this.view.graphicsTileStore.boundsIntersections(a)};
e._updateTile=function(){var a=n._asyncToGenerator(function*(b){k.throwIfAborted(this._controller.signal);const c=b.tile;var d=this._getGraphicsData(this._templateStore,c,b.addedOrModified);d=yield this._processGraphics(c,d);k.throwIfAborted(this._controller.signal);this._patchTile(c.key,{type:"update",addOrUpdate:d,remove:b.removed,end:!0,clear:!1,sort:!1});return d});return function(b){return a.apply(this,arguments)}}();e._patchTile=function(a,b){this._tiles.has(a)&&(a=this._tiles.get(a),this.container.onTileData(a,
b),this.container.requestRender())};e._graphicsChangeHandler=function(a){const b=this._pendingUpdate;for(const c of a.added)b.added.add(c);for(const c of a.moved)b.updated.add(c);for(const c of a.removed)this._pendingUpdate.added.has(c)?b.added.delete(c):b.removed.add(c);this._processing?this._needsProcessing=!0:this._updateGraphics()};e._getGraphicsToUpdate=function(){const a={added:[],removed:[],updated:[]};if(!this.graphics)return a;const b=this._pendingUpdate;for(const c of this.graphics.items)b.added.has(c)?
a.added.push(c):b.updated.has(c)&&a.updated.push(c);for(const c of b.removed)this._graphicStore.has(c)&&a.removed.push(c);b.added.clear();b.removed.clear();b.updated.clear();return a};e._updateGraphics=function(){var a=n._asyncToGenerator(function*(){this._processing=!0;const {added:b,removed:c,updated:d}=this._getGraphicsToUpdate(),f=this._tilesToUpdate;try{if(!this._graphicStoreUpdate){var g=this.view.featuresTilingScheme.getClosestInfoForScale(this.view.state.scale).level;this._graphicStore.updateLevel(g)}g=
[];const u=Array(b.length+c.length);for(let l=0;l<d.length;l++){var h=d[l];const z=this._getIntersectingTiles(h);for(const B of z){var q=B.id;F(q,B,f).removed.push(this._displayIds.get(h.uid))}g.push(this._updateGraphic(h,null));u[l]=h}var C=d.length;for(h=0;h<b.length;h++){const l=b[h];u[C+h]=l;this._graphicsSet.add(l);g.push(this._addGraphic(l))}for(const l of c){this._abortProcessingGraphic(l.uid);const z=this._getIntersectingTiles(l);for(const B of z)q=B.id,F(q,B,f).removed.push(this._displayIds.get(l.uid));
this._graphicsSet.delete(l);this._graphicStore.remove(l)}this._flipUpdatingGraphics();yield Promise.all(g);let v;for(C=0;C<u.length;C++){v=u[C];const l=this._getIntersectingTiles(v);for(const z of l)q=z.id,F(q,z,f).addedOrModified.push(v)}this._graphicStore.updateZ();q=[];for(const [,l]of f)q.push(this._updateTile(l));yield Promise.all(q)}catch(u){k.isAbortError(u)}for(const u of c)try{const v=yield this._getSymbolForGraphic(u,{});v&&this._hashToExpandedSymbol.delete(v.hash())}catch(v){k.isAbortError(v)}f.clear();
this.notifyChange("updating");this._processing=!1;this._needsProcessing&&(this._needsProcessing=!1,this._updateGraphics())});return function(){return a.apply(this,arguments)}}();e._getArcadeInfo=function(a){const b=(a.attributes?Object.keys(a.attributes):[]).map(c=>({name:c,alias:c,type:"string"===typeof a.attributes[c]?"esriFieldTypeString":"esriFieldTypeDouble"}));return A.isNone(a.geometry)?null:{geometryType:p.getJsonType(a.geometry),spatialReference:O.fromJSON(a.geometry.spatialReference),fields:b}};
e._getSymbolForGraphic=function(){var a=n._asyncToGenerator(function*(b,c){k.throwIfAborted(this._controller.signal);return A.isSome(b.symbol)?b.symbol:A.isSome(this.renderer)?this.renderer.getSymbolAsync(b,{scale:this.view.scale,abortOptions:c}):this._getNullSymbol(b)});return function(b,c){return a.apply(this,arguments)}}();e._getSymbolResources=function(){var a=n._asyncToGenerator(function*(b,c){k.throwIfAborted(this._controller.signal);if(!this.container.stage)return null;var d=yield this._getSymbolForGraphic(b,
c),f=d.hash();let g=this._hashToExpandedSymbol.get(f);if(!g){let h=this._hashTpExpandedSymbolPromise.get(f);if(h)g=yield h,k.throwIfAborted(this._controller.signal);else{b=this._getArcadeInfo(b);d=J.createSymbolSchema(d);h=R.expandSymbol(d,b,c);this._hashTpExpandedSymbolPromise.set(f,h);try{g=yield h,this._hashTpExpandedSymbolPromise.delete(f),this._hashToExpandedSymbol.set(f,g)}catch(q){this._hashTpExpandedSymbolPromise.delete(f),k.throwIfAborted(q)}}}if("esriTS"===g.type){c=[];[f]=Y.bidiText(g.text);
for(d=0;d<f.length;d++)c.push(f.charCodeAt(d));[{mosaicItem:c}]=yield this.container.getMaterialItems([{symbol:g,id:0,glyphIds:c}]);return{symbol:g,mosaicItem:c}}return{symbol:g,mosaicItem:null}});return function(b,c){return a.apply(this,arguments)}}();e._projectAndNormalizeGeometry=function(){var a=n._asyncToGenerator(function*(b,c){k.throwIfAborted(this._controller.signal);if(A.isNone(b.geometry)||"mesh"===b.geometry.type)return null;var d=b.geometry;p.isPolygon(d)?d.rings=d.rings:p.isPolyline(d)?
d.paths=d.paths:p.isExtent(d)&&(b=yield this._getSymbolForGraphic(b,c),k.throwIfAborted(this._controller.signal),d=m.isMarkerSymbol(b.type)||m.isTextSymbol(b.type)?d.center:N.fromExtent(d));yield H.checkProjectionSupport(d.spatialReference,this.view.spatialReference);b=Q.normalizeCentralMeridianSync(d);d=H.project(b,d.spatialReference,this.view.spatialReference);P.closeRingsAndFixWinding(d);return d});return function(b,c){return a.apply(this,arguments)}}();e._onTileUpdate=function(a){const b=G.getInfo(this.view.spatialReference);
if(a.added&&0<a.added.length)for(const c of a.added)this._addNewTile(c,b);if(a.removed&&0<a.removed.length)for(const c of a.removed)this._removeTile(c.key)};e._addGraphic=function(){var a=n._asyncToGenerator(function*(b){this._abortProcessingGraphic(b.uid);k.throwIfAborted(this._controller.signal);var c=k.createAbortController();this._graphicIdToAbortController.set(b.uid,c);c={signal:c.signal};try{yield this._addOrUpdateGraphic(b,c),k.throwIfAborted(this._controller.signal),this._graphicIdToAbortController.delete(b.uid)}catch(d){if(this._graphicIdToAbortController.delete(b.uid),
!k.isAbortError(d))throw d;}});return function(b){return a.apply(this,arguments)}}();e._updateGraphic=function(){var a=n._asyncToGenerator(function*(b,c){k.throwIfAborted(this._controller.signal);const d=this._projectAndNormalizeGeometry(b,c);c=this._getSymbolResources(b,c);const [f,g]=yield Promise.all([d,c]);k.throwIfAborted(this._controller.signal);this._graphicStore.addOrModify(b,g,f)});return function(b,c){return a.apply(this,arguments)}}();e._addOrUpdateGraphic=function(){var a=n._asyncToGenerator(function*(b,
c){k.throwIfAborted(this._controller.signal);const d=this._projectAndNormalizeGeometry(b,c);c=this._getSymbolResources(b,c);try{const [f,g]=yield Promise.all([d,c]);k.throwIfAborted(this._controller.signal);this._addProjectedGraphic(b,g,f)}catch(f){if(!k.isAbortError(f))throw f;}});return function(b,c){return a.apply(this,arguments)}}();e._addProjectedGraphic=function(a,b,c){this._graphicsSet.has(a)&&this._graphicStore.addOrModify(a,b,c)};e._addTile=function(a){var b=this.view.featuresTilingScheme.getTileBounds(D.create(),
a);b=new T.GraphicTile(a,b[0],b[3]);this._tiles.set(a,b);this.container.addChild(b);return b};e._addNewTile=function(){var a=n._asyncToGenerator(function*(b,c){const d=this._addTile(b.key),f=this._graphicStore.queryTileData(this._templateStore,b);if(0!==f.length){if(c){c=Math.round((c.valid[1]-c.valid[0])/b.resolution);for(var g of f)g.geometry&&(p.isPoint(g.geometry)||p.isMultipoint(g.geometry))&&this._wrapPoints(g,c)}g=b.key;this._tileUpdateSet.add(b.key);this.notifyChange("updating");try{const h=
{type:"update",clear:!1,addOrUpdate:yield this._processGraphics(b,f),remove:[],end:!0,sort:!1};d.patch(h);this._tileUpdateSet.delete(g);this.notifyChange("updating")}catch(h){if(this._tileUpdateSet.delete(g),this.notifyChange("updating"),!k.isAbortError(h))throw h;}}});return function(b,c){return a.apply(this,arguments)}}();e._removeTile=function(a){if(this._tiles.has(a)){var b=this._tiles.get(a);this.container.removeChild(b);b.destroy();this._tiles.delete(a)}};e._setFilterState=function(a,b){const c=
this._displayIds.get(a);a=this._attributeStore.getHighlightFlag(a);this._attributeStore.setData(c,0,0,a|(b?S.FILTER_FLAG_0:0))};e._getGraphicsData=function(a,b,c){const d=G.getInfo(this.view.spatialReference);a=this._graphicStore.getGraphicsData(a,b,c);if(d){b=Math.round((d.valid[1]-d.valid[0])/b.resolution);for(const f of a)f.geometry&&(p.isPoint(f.geometry)||p.isMultipoint(f.geometry))&&this._wrapPoints(f,b)}return a};e._wrapPoints=function(a,b){const c=a.geometry;p.isMultipoint(c)?this._wrapMultipoint(c,
b):this._wrapPoint(a,b)};e._wrapMultipoint=function(a,b){var c=a.points;const d=[];let f=0,g=0;for(const [h,q]of c)d.push([h+f,q]),f=0,b===m.TILE_SIZE?(c=5*m.PIXEL_BUFFER,h+g<c?(d.push([b,0]),f=-b):h+g>m.TILE_SIZE-c&&(d.push([-b,0]),f=b)):h+g<-m.PIXEL_BUFFER?(d.push([b,0]),f=-b):h+g>m.TILE_SIZE+m.PIXEL_BUFFER&&(d.push([-b,0]),f=b),g+=h;a.points=d};e._wrapPoint=function(a,b){const c=a.geometry;if(b===m.TILE_SIZE){const d=5*m.PIXEL_BUFFER;c.x<d?a.geometry={points:[[c.x,c.y],[b,0]]}:c.x>m.TILE_SIZE-
d&&(a.geometry={points:[[c.x,c.y],[-b,0]]})}else c.x<-m.PIXEL_BUFFER?a.geometry={points:[[c.x,c.y],[b,0]]}:c.x>m.TILE_SIZE+m.PIXEL_BUFFER&&(a.geometry={points:[[c.x,c.y],[-b,0]]})};e._processGraphics=function(){var a=n._asyncToGenerator(function*(b,c,d){if(!c||!c.length||!this._meshFactory)return null;c=ca.GraphicsReader.from(c);const f=this._meshFactory,g=yield this._matcher;yield f.analyzeGraphics(c,g,null,null,d);this._attributeStore.sendUpdates();return this._processAnalyzedGraphics(b,c)});return function(b,
c,d){return a.apply(this,arguments)}}();e._processAnalyzedGraphics=function(a,b){const c=this._meshFactory;var d=b.getSize();b=b.getCursor();const f=new V.MeshData(a.key.id,{features:d,records:d,metrics:0},!1,!1,!1);for(d=[];b.next();){const g=b.readGraphic();g.insertAfter=-1===g.insertAfter?-1:this._displayIds.get(g.insertAfter);g.displayId=this._displayIds.get(g.attributes[this.uid]);const h=new U(g.displayId);h.insertAfter=g.insertAfter;d.push(h);c.writeGraphic(f,b,a.level)}a=f.serialize(a.tileInfoView.tileInfo.isWrappable);
return 1!==a.length?new I.TileData:I.TileData.fromVertexData(a[0].message,d)};e._abortProcessingGraphic=function(a){this._graphicIdToAbortController.has(a)&&this._graphicIdToAbortController.get(a).abort()};e._getNullSymbol=function(a){a=a.geometry;return p.isPolyline(a)?E.errorPolylineSymbol2D:p.isPolygon(a)||p.isExtent(a)?E.errorPolygonSymbol2D:E.errorPointSymbol2D};e._flipUpdatingGraphics=function(){this._updatingGraphicsTimer&&clearTimeout(this._updatingGraphicsTimer);this._updatingGraphicsTimer=
setTimeout(()=>{this._updatingGraphicsTimer=null;this.notifyChange("updating")},160);this.notifyChange("updating")};n._createClass(t,[{key:"updating",get:function(){return!this._attached||null!==this._updatingGraphicsTimer||0<this._tileUpdateSet.size||0<this._tilesToUpdate.size}}]);return t}(ea.GraphicsView(K.HandleOwnerMixin(r)));w.__decorate([x.property({constructOnly:!0})],r.prototype,"requestUpdateCallback",void 0);w.__decorate([x.property()],r.prototype,"container",void 0);w.__decorate([x.property({constructOnly:!0})],
r.prototype,"graphics",void 0);w.__decorate([x.property()],r.prototype,"updating",null);w.__decorate([x.property()],r.prototype,"view",void 0);w.__decorate([x.property()],r.prototype,"updateRequested",void 0);return r=w.__decorate([M.subclass("esri.views.2d.layers.support.GraphicsView2D")],r)});