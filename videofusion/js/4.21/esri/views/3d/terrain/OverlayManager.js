// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.21/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/Handles ../../../core/has ../../../core/mathUtils ../../../core/maybe ../../../core/scheduling ../../../core/time ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/Logger ../../../core/accessorSupport/decorators/subclass ../../../chunks/vec2 ../../../chunks/vec3 ../../../chunks/vec3f64 ../../../chunks/vec4 ../../../chunks/vec4f64 ../../../geometry/projection ../../../geometry/projectionEllipsoid ../../../geometry/support/aaBoundingRect ../../../geometry/support/ray ../../../chunks/sphere ../../../geometry/support/vector ../../../geometry/support/webMercatorUtils ../state/utils/viewUtils ../support/animationUtils ../support/debugFlags ../support/debugUtils ../support/mathUtils ./Overlay ./OverlayRenderer ../webgl-engine/lib/Intersector ../webgl-engine/lib/localOrigin ../webgl-engine/parts/requireUtils ../../support/Scheduler".split(" "),
function(k,B,n,O,P,Q,C,l,R,S,p,ka,la,T,U,w,G,D,H,I,y,h,J,K,V,W,X,Y,E,Z,F,aa,ba,ca,da,ea,fa){const ha=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]];let t;k.OverlayManager=function(L){function z(a){a=L.call(this,a)||this;a._handles=new P;a._spatialReference=null;a._renderSR=null;a._overlaySREqualsRenderSR=!0;a._drapeSources=new Map;a._drapeTargets=new Set;a._placementDirty=!1;a._drawTexturesDirty=!1;a._drawTexturesAnimateDirty=
!1;a._layerViewsDirty=!0;a._hasUnusedRenderTargets=!1;a._longitudeCyclical=null;a._latestOriginId=0;a._maxResolution=Q("esri-mobile")?2048:4096;a._animationTimeLast=0;return a}B._inheritsLoose(z,L);var e=z.prototype;e.initialize=function(){const a=this.view;this.renderer=new ba.OverlayRenderer({view:a,worldToPCSRatio:this._worldToPCSRatio,spatialReference:this._spatialReference});this._groundIntersector=new ca.Intersector(this.view.state.viewingMode);this._groundIntersector.options.backfacesTerrain=
!0;this._groundIntersector.options.invisibleTerrain=!0;this._groundIntersector.options.hud=!1;this._handles.add([this.renderer.events.on("has-highlights",()=>{this._setDrawTexturesDirty();this.notifyChange("hasHighlights")}),this.renderer.events.on("has-water",b=>{var c;return null==(c=a._stage)?void 0:c.renderView.setRenderParameters({hasOverlayWater:b})}),this.renderer.events.on("renders-occluded",()=>{this._setDrawTexturesDirty();this.notifyChange("rendersOccluded")}),this.renderer.events.on("content-changed",
()=>this._setDrawTexturesDirty()),this.renderer.events.on("textures-disposed",()=>this.updateDrapeTargets()),a.watch(["pointsOfInterest.renderPointOfView","pointsOfInterest.centerOnSurfaceFrequent.location","pixelRatio"],()=>this.setPlacementDirty()),this.surface.on("elevation-change",()=>this.setPlacementDirty()),a.allLayerViews.on("after-changes",()=>this._layerViewsDirty=!0),a.on("resize",()=>this.setPlacementDirty()),R.addFrameTask({preRender:b=>{this.renderer.processSyncLayers();this._updateLayerViews();
this.renderer.hasOverlays&&(this._dispatchRendererUpdate(b),this._drawOverlayTextures(this.renderer.overlays));this._hasUnusedRenderTargets&&this._collectUnusedRenderTargetMemory()}}),a.resourceController.scheduler.registerTask(fa.TaskPriority.OVERLAY,this),a._stage.renderView.events.on("force-camera-for-screenshot",b=>{this._updateOverlays(b);this.renderer.hasOverlays&&this._drawOverlayTextures(this.renderer.overlays)})]);this._updateLayerViews()};e.destroy=function(){this._drapeSources.forEach((a,
b)=>this.unregisterDrapeSource(b));this._drapeTargets.forEach(a=>this._unregisterDrapeTarget(a));this.renderer.dispose();this._handles&&(this._handles.destroy(),this._handles=null);l.isSome(t)&&(t.hide(),t=null)};e.setSpatialReference=function(a){this._spatialReference=a;this.renderer.spatialReference=a;this._longitudeCyclical=null;const b=this.view.renderSpatialReference;l.isSome(a)&&l.isSome(b)?(this._renderSR=b,this._overlaySREqualsRenderSR=a.equals(this._renderSR),this._isSpherical&&(this._longitudeCyclical=
a.isWebMercator?new F.Cyclical(-2.0037508342787E7,2.0037508342787E7):new F.Cyclical(-180,180),this.renderer.longitudeCyclical=this._longitudeCyclical),this.renderer&&(this.renderer.worldToPCSRatio=this._worldToPCSRatio)):this.renderer.disposeOverlays()};e.getGpuMemoryUsage=function(){return this.renderer.gpuMemoryUsage};e._updateLayerViews=function(){if(this._layerViewsDirty){var a=new Set;for(const b of this.view.allLayerViews.items)a.add(b.uid),"drapeSourceType"in b&&!this._drapeSources.has(b)&&
this._registerDrapeSource(b,0),"drapeTargetType"in b&&!this._drapeTargets.has(b)&&this._registerDrapeTarget(b);this._drapeSources.forEach((b,c)=>{0!==b||a.has(c.uid)||this.unregisterDrapeSource(c)});this._drapeTargets.forEach(b=>{a.has(b.uid)||this._unregisterDrapeTarget(b)});this.renderer.updateLayerOrder();this._setDrawTexturesDirty();this._layerViewsDirty=!1}};e.registerDrapeSource=function(a){this._registerDrapeSource(a,1)};e._registerDrapeSource=function(a,b){this._drapeSources.set(a,b);this.renderer.ensureOverlays(this._drapeTargets,
this._drapeSources);this._updateDrapeSource(a);this._setContentDirty();this.notifyChange("running")};e._updateDrapeSource=function(a){2===this.renderer.overlays.length&&l.isSome(a.setDrapingExtent)&&l.isSome(this._spatialReference)&&a.setDrapingExtent(this.renderer.overlays,this._spatialReference)};e.unregisterDrapeSource=function(a){this._drapeSources.has(a)&&(this._drapeSources.delete(a),this.renderer.ensureDrapeSources(this._drapeSources),this._setContentDirty(),this.notifyChange("running"))};
e._registerDrapeTarget=function(a){this._drapeTargets.add(a);this._updateDrapeTarget(a);this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources)};e.updateDrapeTargets=function(){this._drapeTargets.forEach(a=>this._updateDrapeTarget(a))};e._updateDrapeTarget=function(a){a.setDrapingTextures(this.renderer.overlays)};e._unregisterDrapeTarget=function(a){this._drapeTargets.delete(a);this.renderer.ensureDrapeTargets(this._drapeTargets)};e._setContentDirty=function(){this.setPlacementDirty();
this._setDrawTexturesDirty()};e.setPlacementDirty=function(){this._placementDirty=!0};e.runTask=function(){this._updateOverlays(this.view.state.camera)};e._updateOverlays=function(a){if(this._spatialReference){this._updateLayerViews();var b=aa.computeOverlayResolution(a.fullWidth,a.fullHeight,this._maxResolution);this._computeOverlayExtents(a,b,x);var c=h.width(x.inner)/h.width(x.outer);this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);a=this._updateOverlay(0,x.inner,b,1);b=this._updateOverlay(1,
x.outer,b,c);if(a||b)this._drapeSources.forEach((f,d)=>this._updateDrapeSource(d)),this.surface.updateTileOverlayParams(),this._setDrawTexturesDirty();this._placementDirty=!1}};e._updateOverlay=function(a,b,c,f){if(0===this.renderer.overlays.length)return!1;a=this.renderer.overlays[a];a:{var d=a.extent;const g=E.TESTS_DISABLE_UPDATE_THRESHOLDS?0:1E-5*Math.max(b[2]-b[0],b[3]-b[1],d[2]-d[0],d[3]-d[1]);for(let q=0;4>q;q++)if(Math.abs(d[q]-b[q])>g){d=!0;break a}d=!1}if(!d&&c===a.resolution&&a.pixelRatio===
f)return!1;h.copy(a.extent,b);a.resolution=c;a.pixelRatio=f;b=h.center(a.extent);a.renderLocalOrigin=da.fromValues(b[0],b[1],0,`OV_${this._latestOriginId++}`);return!0};e.setTileParameters=function(a){const b=a.renderData.overlay;if(0<this.renderer.overlays.length){const c=this.renderer.overlays[0],f=this.renderer.overlays[1];a=h.intersection(a.extent,this.surface.extent,M);this._rectInsideRect(c.extent,a)||this._rectanglesOverlap(a,c.extent)||this._rectanglesOverlap(a,f.extent)?(this._setTileOverlayData(a,
0,b),this._setTileOverlayData(a,1,b)):(this._clearTileOverlayData(0,b),this._clearTileOverlayData(1,b))}else this._clearTileOverlayData(0,b),this._clearTileOverlayData(1,b)};e.overlayPixelSizeInMapUnits=function(a){if(0===this.renderer.overlays.length)return 0;const b=this.renderer.overlays[0],c=this.renderer.overlays[1];a=this._pointIsInExtent(a,b.extent)?b:c;return(a.extent[2]-a.extent[0])/a.resolution};e._setTileOverlayData=function(a,b,c){if(0!==this.renderer.overlays.length){var f=this.renderer.overlays[b].extent,
d=h.width(f),g=h.height(f),q=a[0];if(this._longitudeCyclical){q=this._longitudeCyclical.minimalMonotonic(f[0],q);const m=this._longitudeCyclical.minimalMonotonic(f[0],a[2]);q>m&&(q=m-(a[2]-a[0]))}c.setScale(b,h.width(a)/d,h.height(a)/g);c.setOffset(b,(q-f[0])/d,(a[1]-f[1])/g)}};e._clearTileOverlayData=function(a,b){b.setScale(a,-1,-1);b.setOffset(a,-1,-1)};e.reloadShaders=function(){var a=B._asyncToGenerator(function*(){ea.removeLoadedShaderModules();yield this.renderer.reloadShaders();this.runTask()});
return function(){return a.apply(this,arguments)}}();e._dispatchRendererUpdate=function(a){const b=S.Milliseconds(a.time-this._animationTimeLast);b<Y.DESIRED_DRAPED_ANIMATION_MS&&l.isNone(this.forcedAnimationTime)||(this._animationTimeLast=a.time,this.renderer.updateLogic({dt:b,forcedTime:this.forcedAnimationTime,camera:this.view.state.camera})&&(this._drawTexturesAnimateDirty=!0))};e._setDrawTexturesDirty=function(){this.renderer.hasOverlays?this._drawTexturesDirty=!0:this.setPlacementDirty()};e._intersectGroundFromView=
function(a,b,c,f){c=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(a,ia,b,c);if(l.isNone(c))return!1;b=c.origin;c=w.add(A,c.origin,c.direction);this._groundIntersector.reset(b,c);this._groundIntersector.intersect([],null,a);this.view.basemapTerrain.intersect(this._groundIntersector,null,b,c);return this._groundIntersector.results.min.getIntersectionPoint(f)};e._findHorizonBasedPointOfInterest=function(a,b){var c=.5;c=this.view.renderCoordsHelper.getAltitude(a.eye);const f=this.view.pointsOfInterest.centerOnSurfaceFrequent;
var d=C.clamp(f.estimatedSurfaceAltitude,a.aboveGround?-Infinity:c+1E-5,a.aboveGround?c-1E-5:Infinity);c=a.aboveGround;if("global"===this.view.viewingMode){var g=A;K.closestPointOnSilhouette(K.fromRadius(y.getReferenceEllipsoid(this.view.spatialReference).radius+d),J.wrap(a.eye,a.viewForward),g);w.subtract(g,g,a.eye);d=F.cyclicalPI.normalize(V.angleAroundAxis(a.viewForward,g,a.viewRight))/a.fovY+.5;g=0>=d||1<=d?.5:.55;c=c?g*d:d+g*(1-d)}else d=H.fromValues(0,Math.tan(.5*Math.PI-Math.acos(-a.viewForward[2])),
1,0),d=D.transformMat4(d,d,a.projectionMatrix)[1],d=C.clamp(.5+.5*d,0,1),c=1===d||0===d?.5:c?.55*d:1-.55*(1-d);return this._intersectGroundFromView(a,.5,c,b)?w.sqrDist(b,a.eye)<f.distance*f.distance:!1};e._computeOverlayExtents=function(a,b,c){var f=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,d=G.create();this._findHorizonBasedPointOfInterest(a,d)||w.copy(d,f);var g=w.distance(a.eye,d);f=X.viewAngle(this.view.renderCoordsHelper,f,a.eye);const q=Math.PI/2-Math.abs(f-Math.PI/2);
E.OVERLAY_SHOW_CENTER?(l.isNone(t)&&(t=new Z.PointGraphics(this.view.graphics,"red")),t.show(d,this._renderSR)):l.isSome(t)&&t.hide();this._overlaySREqualsRenderSR||I.projectVectorToVector(d,this._renderSR,d,this._spatialReference);f=this.surface.extent;g=b*a.perRenderPixelRatio*g/2;var m=!1;let u=Infinity;this._isSpherical&&l.isSome(f)&&l.isSome(this._spatialReference)&&(this._spatialReference.isWebMercator?(g/=Math.cos(W.y2lat(d[1])),u=f[3]):(m=!0,g/=y.getReferenceEllipsoid(this._spatialReference).metersPerDegree,
u=90),g>=u&&(g=u,d[1]=0,this._spatialReference.isWebMercator&&(d[0]=0)));!this._isSpherical&&l.isSome(this._spatialReference)&&this._spatialReference.isGeographic&&(g/=y.getReferenceEllipsoid(this._spatialReference).metersPerDegree,u=90);let v=1;m&&(v=1/Math.max(.2,Math.cos(Math.abs(C.deg2rad(d[1])))),180<g*v&&(v=180/g));m=Math.log(2)/12;g=Math.exp(Math.round(Math.log(g)/m)*m);m=g*v;const N=.5*b/(32*m);b=.5*b/(32*g);d[0]=Math.round(d[0]*N)/N;d[1]=Math.round(d[1]*b)/b;b=c.inner;b[0]=d[0]-m;b[1]=d[1]-
g;b[2]=d[0]+m;b[3]=d[1]+g;this._isSpherical&&this._shiftExtentToFitBounds(b,Infinity,u);c=c.outer;6*m>h.width(f)?h.copy(c,l.unwrap(f)):q<=.25*Math.PI?(c[0]=b[0]-m,c[1]=b[1]-g,c[2]=b[2]+m,c[3]=b[3]+g):(I.projectVectorToVector(a.eye,this._renderSR,A,this._spatialReference),U.subtract(r,d,A),a=-Math.atan2(r[1],r[0])+.125*Math.PI,0>a&&(a+=2*Math.PI),D.scale(r,ha[Math.floor(a/(.25*Math.PI))],2*g),r[0]*=v,r[2]*=v,D.add(c,b,r));this._isSpherical?(c[0]=this._longitudeCyclical.clamp(c[0]),c[2]=this._longitudeCyclical.clamp(c[2]),
c[1]=Math.max(c[1],-u),c[3]=Math.min(c[3],u)):(a=h.intersection(b,f,M),d=h.intersection(c,f,ja),h.contains(a,d)&&(c[2]=c[0],c[3]=c[1]))};e._drawOverlayTextures=function(a){if(0!==a.length&&(this._drawTexturesDirty||this._drawTexturesAnimateDirty)){var b=this._drawOverlay(a[0]);a=this._drawOverlay(a[1]);0!==b&&0!==a||this.surface.updateTileOverlayParams();this._collectUnusedRenderTargetMemory();this.updateDrapeTargets();this._drawTexturesAnimateDirty=!1;this._drawTexturesDirty?(this._drawTexturesDirty=
!1,this.surface.requestRender(),this.surface.requestUpdate()):this.surface.requestRender(0)}};e._drawOverlay=function(a){this._longitudeCyclical?a.setupGeometryViewsCyclical(this._longitudeCyclical):a.setupGeometryViewsDirect();return a.draw(this.renderer,this.view.state.camera.pixelRatio)};e._collectUnusedRenderTargetMemory=function(){this._hasUnusedRenderTargets=!1;if(this.renderer.hasOverlays){const a=performance.now();this._hasUnusedRenderTargets=this.renderer.collectUnusedRenderTargetMemory(a)}};
e._rectanglesOverlap=function(a,b){return l.isNone(a)?!1:this._longitudeCyclical?(this._longitudeCyclical.contains(b[0],b[2],a[0])||this._longitudeCyclical.contains(b[0],b[2],a[2])||this._longitudeCyclical.contains(a[0],a[2],b[0]))&&!(a[1]>b[3]||a[3]<b[1]):h.intersects(a,b)};e._rectInsideRect=function(a,b){return l.isNone(b)?!1:this._longitudeCyclical?this._longitudeCyclical.contains(a[0],a[2],b[0])&&this._longitudeCyclical.contains(a[0],a[2],b[2])&&b[1]>a[1]&&b[3]<a[3]:h.contains(a,b)};e._pointIsInExtent=
function(a,b){if(this._longitudeCyclical)return this._longitudeCyclical.contains(b[0],b[2],a.x)&&a.y>=b[1]&&a.y<=b[3];const c=a.x;a=a.y;return c>b[0]&&c<b[2]&&a>b[1]&&a<b[3]};e._shiftExtentToFitBounds=function(a,b,c){let f=0,d=0;a[0]<-b?f=a[0]+b:a[2]>b&&(f=b-a[2]);a[1]<-c?d=a[1]+c:a[3]>c&&(d=c-a[3]);h.offset(a,f,d)};B._createClass(z,[{key:"running",get:function(){return(this._placementDirty||this._layerViewsDirty)&&(0<this._drapeSources.size||0<this.view.graphics.length||E.OVERLAY_DRAW_DEBUG_TEXTURE)&&
!!this._spatialReference&&!this.suspended&&this.surface.ready}},{key:"_isSpherical",get:function(){return this.view.state.isGlobal}},{key:"_worldToPCSRatio",get:function(){return l.isSome(this._spatialReference)&&this._spatialReference.isGeographic?y.getReferenceEllipsoid(this._spatialReference).metersPerDegree:1}},{key:"view",get:function(){return this.surface.view}},{key:"updating",get:function(){return this.running||this.renderer.updating}},{key:"hasHighlights",get:function(){return this.renderer.hasHighlights}},
{key:"rendersOccluded",get:function(){return this.renderer.rendersOccluded}},{key:"hasOverlays",get:function(){return this.renderer.hasOverlays}},{key:"test",get:function(){return{renderer:this.renderer,update:()=>this.runTask()}}}]);return z}(O);n.__decorate([p.property()],k.OverlayManager.prototype,"_spatialReference",void 0);n.__decorate([p.property({readOnly:!0})],k.OverlayManager.prototype,"running",null);n.__decorate([p.property()],k.OverlayManager.prototype,"_placementDirty",void 0);n.__decorate([p.property()],
k.OverlayManager.prototype,"_layerViewsDirty",void 0);n.__decorate([p.property()],k.OverlayManager.prototype,"_isSpherical",null);n.__decorate([p.property()],k.OverlayManager.prototype,"_worldToPCSRatio",null);n.__decorate([p.property()],k.OverlayManager.prototype,"renderer",void 0);n.__decorate([p.property({constructOnly:!0})],k.OverlayManager.prototype,"surface",void 0);n.__decorate([p.property({readOnly:!0,aliasOf:"surface.suspended"})],k.OverlayManager.prototype,"suspended",void 0);n.__decorate([p.property({readOnly:!0})],
k.OverlayManager.prototype,"updating",null);n.__decorate([p.property({type:Boolean})],k.OverlayManager.prototype,"hasHighlights",null);n.__decorate([p.property({type:Boolean})],k.OverlayManager.prototype,"rendersOccluded",null);k.OverlayManager=n.__decorate([T.subclass("esri.views.3d.terrain.OverlayManager")],k.OverlayManager);const r=H.create(),A=G.create(),x={inner:h.create(),outer:h.create()},M=h.create(),ja=h.create(),ia=J.create();Object.defineProperty(k,"__esModule",{value:!0})});