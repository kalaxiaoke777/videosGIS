// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.21/esri/copyright.txt for details.
//>>built
define("exports ../../../core/mathUtils ../../../core/maybe ../../../chunks/vec3f64 ../../../chunks/vec4 ../../../chunks/vec4f64 ../../../geometry/support/aaBoundingBox ../../../geometry/support/buffer/BufferPool ../support/buffer/InterleavedLayout ./ElevationData ./TerrainConst ../webgl-engine/materials/internal/MaterialUtil".split(" "),function(L,fa,M,ha,V,ia,R,ja,ka,W,N,X){function Y(c,e,l,m){const B=0<(l&2),D=e+(m?1024:0)+(B?2048:0);var u=S.get(D);if(!u){{u=e-1;const w=e-1,I=e*e;var b=2*u+2*w;
let E=u*w*6,F=6*b,C=6*(2*u+w-1);m&&(E*=2,F*=2,C*=2);b=65536<I+b?new Uint32Array(E+F):new Uint16Array(E+F);let h=0,a=0,d=E,f,g;let t=0;for(let n=0;n<=w;n++){B&&(t=0===n?C:n===w?-C:0);d+=t;for(let p=0;p<=u;p++){var v=T(p,n,u,w);if(-1<v){var k=0===n&&p!==u?1:p===u&&n!==w?u+1:n===w&&0!==p?-1:0===p&&0!==n?-(u+1):0;0!==k&&(f=h,g=I+v,v=I+(0===p&&1===n?0:v+1),k=h+k,m?(b[d+0]=f,b[d+1]=g,b[d+2]=g,b[d+3]=v,b[d+4]=v,b[d+5]=f,b[d+6]=v,b[d+7]=k,b[d+8]=k,b[d+9]=f,b[d+10]=f,b[d+11]=v,d+=12):(b[d+0]=f,b[d+1]=g,b[d+
2]=v,b[d+3]=v,b[d+4]=k,b[d+5]=f,d+=6))}++h;p<u&&n<w&&(f=n*(u+1)+p,g=f+1,v=g+(u+1),k=v-1,m?(b[a+0]=f,b[a+1]=g,b[a+2]=g,b[a+3]=v,b[a+4]=v,b[a+5]=f,b[a+6]=v,b[a+7]=k,b[a+8]=k,b[a+9]=f,b[a+10]=f,b[a+11]=v,a+=12):(b[a+0]=f,b[a+1]=g,b[a+2]=v,b[a+3]=v,b[a+4]=k,b[a+5]=f,a+=6))}d-=t}u=new la(b,E,F)}S.set(D,u)}c.indices=u.values;c.numSurfaceIndices=u.numSurfaceIndices;c.numSkirtIndices=u.numSkirtIndices;c.numWithoutSkirtIndices=c.numSurfaceIndices+(l?6*(e-1)*(m?2:1):0)}function U(c,e,l,m){c<m[0]&&(m[0]=c);
c>m[3]&&(m[3]=c);e<m[1]&&(m[1]=e);e>m[4]&&(m[4]=e);l<m[2]&&(m[2]=l);l>m[5]&&(m[5]=l)}function Z(c,e){const l=e>c?1:0;return 2+4*l+(1-2*l)*(c+e)}function T(c,e,l,m){return 0===e?c:c===l?l+e:e===m?l+m+(l-c):0===c&&0<e?2*l+m+(m-e):-1}const ma=ka.newLayout().vec3f("position").vec2f("uv0"),Q=new ja.BufferPool(c=>ma.createBuffer(c),c=>c.count);let la=function(c,e,l){this.values=c;this.numSurfaceIndices=e;this.numSkirtIndices=l};const S=new Map,aa=Array(N.MAX_PATCH_TESSELATION+1),ba=Array(N.MAX_PATCH_TESSELATION+
1),ca=Array(N.MAX_PATCH_TESSELATION+1),da=Array(N.MAX_PATCH_TESSELATION+1),ea=ha.create();L.PatchGeometry=function(){this.vertexAttributes=this.indices=null;this.boundingBox=R.empty();this.skirtLength=this.numVertsPerRow=this.numWithoutSkirtIndices=this.numSkirtIndices=this.numSurfaceIndices=0;this.uvOffsetAndScale=ia.create()};L.clearCaches=function(){Q.clear();S.clear()};L.createPlanarGlobePatch=function(c,e,l,m,B){const D=e[0],u=e[1],b=e[2]-D,v=e[3]-u,k=c.clippingArea,w=M.isSome(k)?Math.max(0,
(k[0]-e[0])/b):0,I=M.isSome(k)?Math.max(0,(k[1]-e[1])/v):0,E=M.isSome(k)?Math.min(1,(k[2]-e[0])/b):1;e=M.isSome(k)?Math.min(1,(k[3]-e[1])/v):1;const F=E>w?1/(E-w):1,C=e>I?1/(e-I):1,h=-w*F,a=-I*C,d=.1*b,f=c.numVertsPerRow-1,g=c.numVertsPerRow-1,t=c.numVertsPerRow*c.numVertsPerRow,n=Q.acquire(t+(2*f+2*g)),p=n.position.typedBuffer,q=n.uv0.typedBuffer,x=B.geometryInfo.boundingBox;R.empty(x);let A=0;for(let H=0;H<=g;H++){var y=H/g;let O=a+y*C;y=u+y*v;M.isSome(k)&&(y<k[1]?(y=k[1],O=0):y>k[3]&&(y=k[3],O=
1));for(let J=0;J<=f;J++){var r=J/f;let P=h+r*F;r=D+r*b;M.isSome(k)&&(r<k[0]?(r=k[0],P=0):r>k[2]&&(r=k[2],P=1));var G=c.samplerData?W.ElevationData.sample(r,y,c.samplerData)||0:0;r=r*m-l[0];const K=y*m-l[1];G-=l[2];U(r,K,G,x);var z=N.GEOMETRY_VERTEX_STRIDE*A;p[z+0]=r;p[z+1]=K;p[z+2]=G;q[z+0]=P;q[z+1]=O;z=T(J,H,f,f);-1<z&&(z=N.GEOMETRY_VERTEX_STRIDE*(t+z),p[z+0]=r,p[z+1]=K,p[z+2]=G,q[z+0]=Z(P,O),q[z+1]=d);++A}}B.geometryInfo.numVertsPerRow=c.numVertsPerRow;B.geometryInfo.vertexAttributes=n;B.geometryInfo.skirtLength=
d;V.set(B.geometryInfo.uvOffsetAndScale,w,I,E-w,e-I);Y(B.geometryInfo,c.numVertsPerRow,0,c.wireframe)};L.createSphericalGlobePatch=function(c,e,l,m,B,D,u,b){var v=B[0];const k=B[1];var w=B[2];B=B[3];const I=.1*u.radius*(B-k),E=c.numVertsPerRow-1,F=c.numVertsPerRow-1,C=c.numVertsPerRow*c.numVertsPerRow,h=Q.acquire(C+(2*E+2*F)),a=h.position.typedBuffer,d=h.uv0.typedBuffer,f=m.geometryInfo.boundingBox;R.empty(f);var g=e[2]-e[0];const t=e[3]-e[1];var n=w-v;w=l[0];const p=l[1];l=l[2];for(var q=0;q<=E;q++){var x=
q/E,A=v+x*n;aa[q]=Math.sin(A);ba[q]=Math.cos(A);ca[q]=x;da[q]=e[0]+x*g}v=D&&!!(b&1);g=D&&!!(b&2);n=0;for(q=0;q<=F;q++){x=q/F;var y=fa.lerp(k,B,x);A=Math.cos(y);const O=Math.sin(y);D?(y=u.halfSemiMajorAxis*Math.log((1+O)/(1-O)),x=(y-e[1])/t):y=180*y/Math.PI;for(let J=0;J<=E;J++){const P=ca[J];var r=aa[J],G=ba[J],z=u.radius;c.samplerData&&(z+=W.ElevationData.sample(da[J],y,c.samplerData)||0);G=G*A*z-w;r=r*A*z-p;z=O*z-l;U(G,r,z,f);var H=N.GEOMETRY_VERTEX_STRIDE*n;a[H+0]=G;a[H+1]=r;a[H+2]=z;d[H+0]=P;
d[H+1]=x;H=T(J,q,E,F);if(-1<H){H=N.GEOMETRY_VERTEX_STRIDE*(C+H);const K=v&&0===q?-1:g&&q===F?1:0;G=0===K?G:-w;r=0===K?r:-p;z=0===K?z:u.radius*K-l;a[H+0]=G;a[H+1]=r;a[H+2]=z;d[H+0]=0===K?Z(P,x):P;d[H+1]=0===K?I:x;0!==K&&U(G,r,z,f)}++n}}m.geometryInfo.numVertsPerRow=c.numVertsPerRow;m.geometryInfo.vertexAttributes=h;m.geometryInfo.skirtLength=I;V.set(m.geometryInfo.uvOffsetAndScale,0,0,1,1);Y(m.geometryInfo,c.numVertsPerRow,D?b:0,c.wireframe);m.intersectionData=null};L.intersectSkirtsGlobal=function(c,
e,l,m,B,D,u,b,v,k){const w=D.position;D=D.uv0;const I=c[0],E=c[1];c=c[2];const F=e[0]-I,C=e[1]-E;e=e[2]-c;l*=3;for(m*=3;l<m;l+=3){var h=B[l],a=B[l+1],d=B[l+2],f=w.get(h,0),g=w.get(h,1),t=w.get(h,2),n=w.get(a,0),p=w.get(a,1),q=w.get(a,2),x=w.get(d,0),A=w.get(d,1),y=w.get(d,2);if(2<=D.get(h,0)){h=f+b[0];var r=g+b[1],G=t+b[2];const z=u/Math.sqrt(h*h+r*r+G*G);f+=h*z;g+=r*z;t+=G*z}2<=D.get(a,0)&&(a=n+b[0],h=p+b[1],r=q+b[2],G=u/Math.sqrt(a*a+h*h+r*r),n+=a*G,p+=h*G,q+=r*G);2<=D.get(d,0)&&(d=x+b[0],a=A+b[1],
h=y+b[2],r=u/Math.sqrt(d*d+a*a+h*h),x+=d*r,A+=a*r,y+=h*r);M.isSome(v)&&([f,g,t]=v.applyToVertex(f,g,t),[n,p,q]=v.applyToVertex(n,p,q),[x,A,y]=v.applyToVertex(x,A,y));n-=f;p-=g;q-=t;x-=f;A-=g;y-=t;a=C*y-A*e;h=e*x-y*F;r=F*A-x*C;d=n*a+p*h+q*r;if(!(Math.abs(d)<=Number.EPSILON)){f=I-f;g=E-g;t=c-t;a=f*a+g*h+t*r;if(0<d){if(0>a||a>d)continue}else if(0<a||a<d)continue;h=g*q-p*t;t=t*n-q*f;g=f*p-n*g;f=F*h+C*t+e*g;if(0<d){if(0>f||a+f>d)continue}else if(0<f||a+f<d)continue;t=(x*h+A*t+y*g)/d;0<=t&&(g=X.computeNormal(n,
p,q,x,A,y,ea),k(t,g))}}};L.intersectSkirtsLocal=function(c,e,l,m,B,D,u,b,v){const k=D.position;D=D.uv0;const w=c[0],I=c[1];c=c[2];const E=e[0]-w,F=e[1]-I;e=e[2]-c;l*=3;for(m*=3;l<m;l+=3){var C=B[l],h=B[l+1],a=B[l+2],d=k.get(C,0),f=k.get(C,1),g=k.get(C,2),t=k.get(h,0),n=k.get(h,1),p=k.get(h,2),q=k.get(a,0),x=k.get(a,1),A=k.get(a,2);2<=D.get(C,0)&&(g+=u);2<=D.get(h,0)&&(p+=u);2<=D.get(a,0)&&(A+=u);M.isSome(b)&&([d,f,g]=b.applyToVertex(d,f,g),[t,n,p]=b.applyToVertex(t,n,p),[q,x,A]=b.applyToVertex(q,
x,A));C=t-d;n-=f;p-=g;q-=d;x-=f;A-=g;a=F*A-x*e;t=e*q-A*E;const y=E*x-q*F;h=C*a+n*t+p*y;if(!(Math.abs(h)<=Number.EPSILON)){d=w-d;f=I-f;g=c-g;a=d*a+f*t+g*y;if(0<h){if(0>a||a>h)continue}else if(0<a||a<h)continue;t=f*p-n*g;g=g*C-p*d;f=d*n-C*f;d=E*t+F*g+e*f;if(0<h){if(0>d||a+d>h)continue}else if(0<d||a+d<h)continue;g=(q*t+x*g+A*f)/h;0<=g&&(C=X.computeNormal(C,n,p,q,x,A,ea),v(g,C))}}};L.releaseGeometry=function(c){Q.release(c.vertexAttributes);c.vertexAttributes=null;c.indices=null};Object.defineProperty(L,
"__esModule",{value:!0})});