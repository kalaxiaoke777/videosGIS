// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.21/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/has ../../../core/Handles ../../../core/maybe ../../../core/watchUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/Logger ../../../core/accessorSupport/decorators/subclass ../../../core/accessorSupport/trackingUtils ../../../geometry/projectionEllipsoid ../../../geometry/support/spatialReferenceUtils ../../../support/featureFlags ./ChapmanAtmosphere ./CloudsComposition ./CloudsGenerator ./PanoramicAtmosphere ./RealisticAtmosphere ./SimpleAtmosphere ./Stars".split(" "),
function(g,p,h,w,q,x,b,r,k,H,I,y,t,z,l,A,n,B,C,D,u,E,F){const G=[14,15,16];g.EnvironmentRenderer=function(v){function m(){var a=v.apply(this,arguments)||this;a._handles=new x;a._context=null;a._chapmanQuality="high";a._enableNewAtmosphere=A.enableNewAtmosphere();a._pendingAtmosphere=null;a._atmosphere=null;a._stars=null;a._clouds=null;a._cloudComposition=null;a._cloudsEnabled=!!q("enable-feature:enable-clouds");return a}p._inheritsLoose(m,v);var e=m.prototype;e.renderCubeMap=function(){b.isSome(this._clouds)&&
(this._clouds.resetRenderFlags(),this._context.requestRender())};e.initialize=function(){this.view._stage.addRenderPlugin(G,this)};e.destroy=function(){this._pendingAtmosphere=b.destroyMaybe(this._pendingAtmosphere);this._atmosphere=b.destroyMaybe(this._atmosphere);this._stars=b.destroyMaybe(this._stars);this._handles=b.destroyMaybe(this._handles);this._clouds=b.destroyMaybe(this._clouds);this._cloudComposition=b.destroyMaybe(this._cloudComposition);this.view&&null!=this.view._stage&&(this.view._stage.removeRenderPlugin(this),
this._set("view",null))};e.initializeRenderContext=function(a){this._context=a;this.setup()};e.setup=function(){this._handles.add(r.when(this.view,"basemapTerrain",()=>this._updateBasemapTerrain(),!0));this._handles.add([r.init(this.view,["viewingMode","environment.atmosphereEnabled","environment.atmosphere.quality"],()=>this._updateAtmosphere(),!0),t.autorun(()=>this._updateStars()),t.autorun(()=>{this.evaluateCloudsEnabled();this.ensureClouds(this._context.renderContext.rctx);if(b.isSome(this._clouds)){var a,
c;const d=null==(a=this.view)?void 0:null==(c=a.environment)?void 0:c.clouds;this._clouds.coverage=null==d?void 0:d.coverage;this._clouds.absorption=null==d?void 0:d.absorption;this._clouds.cloudHeight=null==d?void 0:d.cloudHeight;this._clouds.cloudSize=null==d?void 0:d.cloudSize;this._clouds.density=null==d?void 0:d.density;this._clouds.detailSize=null==d?void 0:d.detailSize;this._clouds.smoothness=null==d?void 0:d.smoothness}})])};e.evaluateCloudsEnabled=function(){var a,c,d,f;this.cloudsEnabled=
(null!=(a=null!==(null==(c=this.view)?void 0:null==(d=c.environment)?void 0:d.clouds))?a:!!q("enable-feature:enable-clouds"))&&l.isEarth(null==(f=this.view)?void 0:f.spatialReference)};e.uninitializeRenderContext=function(){b.isSome(this._stars)&&(this._stars.destroy(),this._stars=null);b.isSome(this._atmosphere)&&(this._atmosphere.uninitializeRenderContext(),this._atmosphere.destroy(),this._atmosphere=null);this._clouds=b.destroyMaybe(this._clouds);this._cloudComposition=b.destroyMaybe(this._cloudComposition)};
e.render=function(a){let c=!0;const d=this._context.renderContext.rctx;b.isSome(this._stars)&&this._stars.canRender&&15===a.slot&&0===a.pass&&(c=this._stars.render(a.rctx,a.camera)&&c);if(this._cloudsEnabled&&14===a.slot&&0===a.pass&&(this.ensureClouds(d),b.isSome(this._clouds))){const f=a.rctx.getViewport();c=this._clouds.render(d)&&c;a.rctx.setViewport(f.x,f.y,f.width,f.height)}b.isSome(this._atmosphere)&&this._atmosphere.canRender&&(c=this._atmosphere.render(a)&&c);this._cloudsEnabled&&b.isSome(this._clouds)&&
b.isSome(this._cloudComposition)&&15===a.slot&&0===a.pass&&(c=this._cloudComposition.render(a,this._clouds._frameBufferCube)&&c,this._cloudComposition.isFading()&&this._setNeedsRender());return c};e.ensureClouds=function(a){this._cloudsEnabled&&b.isSome(this._clouds)&&b.isSome(this._cloudComposition)||(this._cloudsEnabled&&b.isNone(this._clouds)&&b.isNone(this._cloudComposition)&&(this._clouds=new C.CloudsGenerator(a,this.view),a=z.getReferenceEllipsoid(this.view.spatialReference).radius,this._cloudComposition=
new B.CloudsComposition(this._context.renderContext.rctx,this.view.state.viewingMode,a)),this._cloudsEnabled||!b.isSome(this._clouds)&&!b.isSome(this._cloudComposition)||(this._clouds=b.destroyMaybe(this._clouds),this._cloudComposition=b.destroyMaybe(this._cloudComposition)))};e._setNeedsRender=function(){this._context&&this._context.requestRender()};e._updateStars=function(){var a,c,d;const f=null!=(a=null==(c=this.view)?void 0:null==(d=c.environment)?void 0:d.starsEnabled)?a:!1;f&&b.isNone(this._stars)?
(this._stars=new F.Stars({view:this.view,requestRender:()=>this._context.requestRender}),this._setNeedsRender()):!f&&b.isSome(this._stars)&&(this._stars.destroy(),this._stars=null,this._setNeedsRender())};e._updateAtmosphere=function(){var a=this._getAtmosphereType();if(this.atmosphereType!==a)if(this.atmosphereType=a,b.isSome(this._pendingAtmosphere)&&(this._pendingAtmosphere!==this._atmosphere&&this._pendingAtmosphere.destroy(),this._pendingAtmosphere=null),a=this._getAtmosphereClass()){var c=new a(this.view);
c instanceof n.ChapmanAtmosphere&&c.setSimplified("medium"===this._getAtmosphereType());c.initializeRenderContext(this._context);b.isNone(this._atmosphere)&&(this._atmosphere=c,this._setNeedsRender());this._pendingAtmosphere=c;c.when().then(()=>{b.isSome(this._atmosphere)&&this._pendingAtmosphere!==this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=this._pendingAtmosphere);this._pendingAtmosphere=null;this._setNeedsRender();this._updateBasemapTerrain()}).catch(()=>{this._pendingAtmosphere===
c&&(this._pendingAtmosphere=null)})}else b.isSome(this._atmosphere)&&(this._atmosphere.destroy(),this._atmosphere=null,this._setNeedsRender()),this._updateBasemapTerrain()};e._getAtmosphereClass=function(){const a=this._getAtmosphereType();if(this.atmosphereClassFromType)return this.atmosphereClassFromType(a);switch(a){case "none":return null;case "chapman":case "medium":return n.ChapmanAtmosphere;case "realistic":return u.RealisticAtmosphere;case "panoramic":return D;case "simple":return E}};e._getAtmosphereType=
function(){const a=this.view.get("environment.atmosphereEnabled"),c=this.view.get("environment.atmosphere.quality"),d=this.view.viewingMode;return!a||null==c||l.isMoon(this.view.spatialReference)?"none":"local"===d?"panoramic":this._enableNewAtmosphere&&n.ChapmanAtmosphere.isSupported(this._context)&&!l.isMars(this.view.spatialReference)?"medium"===this._chapmanQuality?"medium":"chapman":"high"===c&&u.RealisticAtmosphere.isSupported(this._context)&&!l.isMars(this.view.spatialReference)?"realistic":
"simple"};e._updateBasemapTerrain=function(){const a=this.view.basemapTerrain;a&&(a.velvetOverground=null!=this._atmosphere&&"simple"===this.atmosphereType)};p._createClass(m,[{key:"canRender",get:function(){return!(!this.view.basemapTerrain||!this.view.basemapTerrain.renderer.canRender)||"global"!==this.view.viewingMode}},{key:"updating",get:function(){return b.isSome(this._pendingAtmosphere)||b.isSome(this._stars)&&this._stars.updating}},{key:"cloudsEnabled",set:function(a){this._cloudsEnabled=
a;this._setNeedsRender()}},{key:"test",get:function(){return{atmosphere:this._atmosphere,clouds:this._clouds,enableNewAtmosphere:a=>{this._enableNewAtmosphere=a},setNewAtmosphereQuality:a=>{this._chapmanQuality=a},updateAtmosphere:()=>{this._updateAtmosphere()}}}}]);return m}(w);h.__decorate([k.property({constructOnly:!0})],g.EnvironmentRenderer.prototype,"view",void 0);h.__decorate([k.property({constructOnly:!0})],g.EnvironmentRenderer.prototype,"atmosphereClassFromType",void 0);h.__decorate([k.property({type:Boolean,
readOnly:!0})],g.EnvironmentRenderer.prototype,"updating",null);h.__decorate([k.property()],g.EnvironmentRenderer.prototype,"_pendingAtmosphere",void 0);h.__decorate([k.property()],g.EnvironmentRenderer.prototype,"_stars",void 0);g.EnvironmentRenderer=h.__decorate([y.subclass("esri.views.3d.environment.EnvironmentRenderer")],g.EnvironmentRenderer);Object.defineProperty(g,"__esModule",{value:!0})});