// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.21/esri/copyright.txt for details.
//>>built
define("exports ../../../core/Handles ../../../core/maybe ../../../core/watchUtils ../../../chunks/mat4 ../../../chunks/mat4f64 ../../../chunks/vec2 ../../../chunks/vec2f64 ../../../chunks/vec3 ../../../chunks/vec3f64 ../../../chunks/vec4f64 ../../../geometry/support/Ellipsoid ./atmosphereUtils ./ChapmanAtmosphereTechnique ../webgl-engine/lib/DefaultVertexBufferLayouts ../webgl-engine/lib/glUtil3D".split(" "),function(p,x,e,q,r,t,u,v,h,l,w,k,b,m,y,z){let B=function(){function n(a){this._view=a;this.canRender=
!0;this._skyslot=15;this._hazeSlot=16;this._cameraPosition=l.create();this._projectionInverse=t.create();this._viewInverse=t.create();this._heightParameters=w.create();this._betasRayleigh=l.create();this._betasCombined=l.create();this._scaleHeight=0;this._radii=v.create();this._nearFar=v.create();this._lowerElevationBoundRadius=this._altitudeFade=this._innerFadeDistance=this._cAtmosphere=this._cameraHeightSq=this._cameraHeight=0;this._lowerBoundEarthRadius=k.earth.radius;this._simplified=!1;this._skyStrength=
1;this._hazeStrength=3;this._skyHazeMultiplier=this._mieStrength=1;this._skyHazePow=0;this._sunSpread=this._sunSize=1;this._updateRadius(k.earth.radius)}var c=n.prototype;c.destroy=function(){this._atmosphereTechnique=e.releaseMaybe(this._atmosphereTechnique);this._atmosphereHazeTechnique=e.releaseMaybe(this._atmosphereHazeTechnique);this._vao=e.disposeMaybe(this._vao);this._handles=e.destroyMaybe(this._handles)};c.when=function(){return Promise.resolve()};c.setSimplified=function(a){this._simplified=
a};c.initializeRenderContext=function(a){const f=a.renderContext.rctx;this._handles=new x;e.isSome(this._view.basemapTerrain.rootTiles)&&this._updateElevation({spatialReference:this._view.basemapTerrain.spatialReference,tile:this._view.basemapTerrain.rootTiles[0],extent:this._view.basemapTerrain.rootTiles[0].extent,context:"ground"});this._handles.add(q.on(this._view,"basemapTerrain","elevation-change",g=>this._updateElevation(g),()=>this._updateElevation()));this._handles.add(q.on(this._view,"basemapTerrain",
"elevation-bounds-change",()=>this._updateVisibleElevationBounds()));const d=new m.ChapmanAtmosphereTechniqueConfiguration;d.haze=!1;d.simplified=this._simplified;this._atmosphereTechnique=a.shaderTechniqueRep.acquire(m.ChapmanAtmosphereTechnique,d);d.haze=!0;this._atmosphereHazeTechnique=a.shaderTechniqueRep.acquire(m.ChapmanAtmosphereTechnique,d);this._vao=z.createQuadVAO(f,y.Pos2Tex);this._scaleHeight=b.rayLeighScaleHeight*b.atmosphereHeight;h.set(this._betasRayleigh,b.betaRayleigh[0],b.betaRayleigh[1],
b.betaRayleigh[2]);h.set(this._betasCombined,b.betaRayleigh[0]+b.betaOzone[0],b.betaRayleigh[1]+b.betaOzone[1],b.betaRayleigh[2]+b.betaOzone[2])};c.uninitializeRenderContext=function(){this.destroy()};c.render=function(a){if(a.slot!==this._hazeSlot&&a.slot!==this._skyslot||0!==a.pass)return!1;this._update(a.camera);const f=a.rctx,d=a.offscreenRenderingHelper,g=a.slot===this._skyslot?this._atmosphereTechnique:this._atmosphereHazeTechnique,A=a.slot===this._skyslot?d.depthTexture:d.linearDepthTexture;
f.useProgram(g.program);g.bindPipelineState(f);d.renderDepthDetached(()=>{g.program.bindTexture(A,"depthTex");this._renderCommon(g.program,a)});return!0};c._renderCommon=function(a,f){if(e.isNone(this._vao))return!1;const d=f.rctx;f.scenelightingData.setLightDirectionUniform(a);a.setUniform4fv("heightParameters",this._heightParameters);a.setUniform3fv("cameraPosition",this._cameraPosition);a.setUniformMatrix4fv("projectionInverse",this._projectionInverse);a.setUniformMatrix4fv("viewInverse",this._viewInverse);
a.setUniform2fv("nearFar",this._nearFar);a.setUniform2fv("radii",this._radii);a.setUniform1f("scaleHeight",this._scaleHeight);this._simplified||a.setUniform1f("betaMie",b.betaMie);a.setUniform3fv("betaRayleigh",this._betasRayleigh);a.setUniform3fv("betaCombined",this._betasCombined);a.setUniform1f("innerFadeDistance",this._innerFadeDistance);a.setUniform1f("altitudeFade",this._altitudeFade);a.setUniform1f("skyStrength",this._skyStrength);a.setUniform1f("hazeStrength",this._hazeStrength);a.setUniform1f("mieStrength",
this._mieStrength);a.setUniform1f("skyHazeMultiplier",this._skyHazeMultiplier);a.setUniform1f("skyHazePow",this._skyHazePow);a.setUniform1f("sunSize",this._sunSize);a.setUniform1f("sunSpread",this._sunSpread);d.bindVAO(this._vao);a.assertCompatibleVertexAttributeLocations(this._vao);d.drawArrays(5,0,4);return!0};c._adjustRadiusForTesselation=function(a){return a*Math.cos(Math.PI/16/16)};c._updateElevation=function(a){a=a?a.tile:e.unwrapOr(this._view.basemapTerrain.rootTiles,[null])[0];e.isNone(a)||
0!==a.lij[0]||(a=this._adjustRadiusForTesselation(k.earth.radius+a.elevationBounds[0]),a!==this._lowerElevationBoundRadius&&(this._lowerElevationBoundRadius=a,this._lowerBoundEarthRadius=-1,this._updateVisibleElevationBounds()))};c._updateVisibleElevationBounds=function(){const a=this._adjustRadiusForTesselation(k.earth.radius+this._view.basemapTerrain.elevationBounds.min);(0>this._lowerBoundEarthRadius||a<this._lowerBoundEarthRadius)&&this._updateRadius(a)};c._updateRadius=function(a){this._lowerBoundEarthRadius=
a;u.set(this._radii,a,a+b.atmosphereHeight);this._innerFadeDistance=2*Math.sqrt((2*a-b.innerAtmosphereDepth)*b.innerAtmosphereDepth)};c._update=function(a){e.isNone(a)||(this._cameraHeight=h.length(a.eye),this._cameraHeightSq=this._cameraHeight*this._cameraHeight,this._cAtmosphere=this._cameraHeightSq-this._radii[1]*this._radii[1],this._heightParameters=w.fromValues(this._cameraHeight,this._cameraHeightSq,this._cAtmosphere,Math.min(1,Math.max(0,(this._cameraHeight-this._radii[0])/b.atmosphereHeight))),
h.copy(this._cameraPosition,a.eye),r.invert(this._projectionInverse,a.projectionMatrix),r.invert(this._viewInverse,a.viewMatrix),u.set(this._nearFar,a.near,a.far),this._altitudeFade=b.computeInnerAltitudeFade(this._cameraHeight-this._lowerBoundEarthRadius))};n.isSupported=function(a){return a.renderContext.rctx.capabilities.depthTexture};return n}();p.ChapmanAtmosphere=B;Object.defineProperty(p,"__esModule",{value:!0})});