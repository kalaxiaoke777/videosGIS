// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.21/esri/copyright.txt for details.
//>>built
define("exports ../../../core/mathUtils ../../../core/maybe ../../../chunks/mat4 ../../../chunks/mat4f64 ../../../chunks/vec3 ../../../chunks/vec3f64 ../../../geometry/support/axisAngle ./CloudsCompositionTechnique ../webgl-engine/lib/glUtil3D".split(" "),function(x,u,v,w,p,e,q,t,z,A){var f;(function(b){b[b.FINISHED=0]="FINISHED";b[b.CHANGE_ANCHOR=1]="CHANGE_ANCHOR";b[b.FADE_IN=2]="FADE_IN"})(f||(f={}));var c;(function(b){b[b.FINISHED=0]="FINISHED";b[b.FADE_OUT=1]="FADE_OUT";b[b.FADE_IN=2]="FADE_IN"})(c||
(c={}));var g;(function(b){b[b.FINISHED=0]="FINISHED";b[b.CROSS_FADE=1]="CROSS_FADE"})(g||(g={}));let C=function(){function b(a,d,l){this._viewingMode=d;this._inverseProjectionMatrix=p.create();this._inverseViewMatrix=p.create();this._cameraPositionLastFrame=q.create();this._cloudCompositionTechnique=new z.CloudsCompositionTechnique({rctx:a,viewingMode:this._viewingMode},null);this._vao=A.createQuadVAO(a);this._setDefaultParallax(l)}var k=b.prototype;k.destroy=function(){this._cloudCompositionTechnique=
v.releaseMaybe(this._cloudCompositionTechnique);this._vao=v.disposeMaybe(this._vao)};k.render=function(a,d){const l=a.camera;if(v.isNone(this._vao)||v.isNone(l))return!1;const n=a.rctx,h=this._cloudCompositionTechnique.program;n.useProgram(h);this._cloudCompositionTechnique.bindPipelineState(n);a.scenelightingData.setLightDirectionUniform(h);a.scenelightingData.setUniforms(h);w.invert(this._inverseProjectionMatrix,l.projectionMatrix);w.invert(this._inverseViewMatrix,l.viewMatrix);h.setUniformMatrix4fv("inverseProjectionMatrix",
this._inverseProjectionMatrix);h.setUniformMatrix4fv("inverseViewMatrix",this._inverseViewMatrix);h.bindTexture(d.colorTexture,"cubeMap");this._setParallaxParams(l.eye);this._bindParallaxParams(h,a.camera);n.bindVAO(this._vao);h.assertCompatibleVertexAttributeLocations(this._vao);n.drawArrays(5,0,4);return!0};k.isFading=function(){return this._crossFadeParams.crossFadeStage!==g.FINISHED||this._fadeInOutParams.fadeInOutStage!==c.FINISHED||this._fadeInParams.fadeInStage!==f.FINISHED};k._setDefaultParallax=
function(a){this._parallaxParams={anchorPointClouds:q.create(),radius:a,cloudsFadeOutHeightFactor:0,cloudsHeight:1E5,radiusCurvatureCorrectionFactor:0,transform:p.create()};this._parallaxParamsNew={anchorPointClouds:q.create(),radius:a,cloudsFadeOutHeightFactor:0,cloudsHeight:1E5,radiusCurvatureCorrectionFactor:0,transform:p.create()};this._crossFadeParams={crossFadeStage:g.FINISHED,crossFadeFactor:0,distanceThresholdFactor:.3};this._fadeInOutParams={fadeInOutStage:c.FINISHED,fadeInOutFactor:0,distanceThresholdFactor:.6};
this._fadeInParams={fadeInStage:f.FINISHED,fadeInFactor:0,distanceThresholdFactor:2}};k._isCameraPossitionFinal=function(a){return e.equals(this._cameraPositionLastFrame,a)};k._setFadeInStage=function(a){a=this._isCameraPossitionFinal(a);this._fadeInParams.fadeInStage===f.FINISHED&&(this._fadeInParams.fadeInFactor=1,e.copy(this._parallaxParams.anchorPointClouds,m),this._fadeInParams.fadeInStage=f.CHANGE_ANCHOR,this._crossFadeParams.crossFadeStage=g.FINISHED,this._fadeInOutParams.fadeInOutStage=c.FINISHED);
this._fadeInParams.fadeInStage===f.CHANGE_ANCHOR&&a&&(e.copy(this._parallaxParams.anchorPointClouds,m),this._fadeInParams.fadeInStage=f.FADE_IN,this._startTime=performance.now());0<this._fadeInParams.fadeInFactor&&this._fadeInParams.fadeInStage===f.FADE_IN&&(this._fadeInParams.fadeInFactor=1-(performance.now()-this._startTime)/500);0>=this._fadeInParams.fadeInFactor&&this._fadeInParams.fadeInStage===f.FADE_IN&&(this._fadeInParams.fadeInStage=f.FINISHED,this._fadeInParams.fadeInFactor=0)};k._setCrossFadingStage=
function(){this._crossFadeParams.crossFadeStage===g.FINISHED&&(e.copy(this._parallaxParamsNew.anchorPointClouds,m),this._startTime=performance.now(),this._crossFadeParams.crossFadeFactor=0,this._crossFadeParams.crossFadeStage=g.CROSS_FADE);1>this._crossFadeParams.crossFadeFactor&&this._crossFadeParams.crossFadeStage===g.CROSS_FADE&&(this._crossFadeParams.crossFadeFactor=(performance.now()-this._startTime)/500);1<=this._crossFadeParams.crossFadeFactor&&this._crossFadeParams.crossFadeStage===g.CROSS_FADE&&
(this._crossFadeParams.crossFadeStage=g.FINISHED,this._crossFadeParams.crossFadeFactor=1,e.copy(this._parallaxParams.anchorPointClouds,this._parallaxParamsNew.anchorPointClouds))};k._setFadeInOutStage=function(a){a=this._isCameraPossitionFinal(a);this._fadeInOutParams.fadeInOutStage===c.FINISHED&&(this._startTime=performance.now(),this._fadeInOutParams.fadeInOutFactor=0,this._fadeInOutParams.fadeInOutStage=c.FADE_OUT);1>this._fadeInOutParams.fadeInOutFactor&&this._fadeInOutParams.fadeInOutStage===
c.FADE_OUT&&(this._fadeInOutParams.fadeInOutFactor=(performance.now()-this._startTime)/250);1<=this._fadeInOutParams.fadeInOutFactor&&this._fadeInOutParams.fadeInOutStage===c.FADE_OUT&&(this._fadeInOutParams.fadeInOutFactor=1,e.copy(this._parallaxParams.anchorPointClouds,m));1<=this._fadeInOutParams.fadeInOutFactor&&this._fadeInOutParams.fadeInOutStage===c.FADE_OUT&&a&&(this._startTime=performance.now(),this._fadeInOutParams.fadeInOutFactor=1,this._fadeInOutParams.fadeInOutStage=c.FADE_IN,this._crossFadeParams.crossFadeStage=
g.FINISHED,this._crossFadeParams.crossFadeFactor=0);0<this._fadeInOutParams.fadeInOutFactor&&this._fadeInOutParams.fadeInOutStage===c.FADE_IN&&(this._fadeInOutParams.fadeInOutFactor=1-(performance.now()-this._startTime)/500);0>=this._fadeInOutParams.fadeInOutFactor&&this._fadeInOutParams.fadeInOutStage===c.FADE_IN&&(this._fadeInOutParams.fadeInOutStage=c.FINISHED,this._fadeInOutParams.fadeInOutFactor=0)};k._setParallaxParams=function(a){e.normalize(m,a);e.scale(m,m,this._parallaxParams.radius);0===
this._parallaxParams.anchorPointClouds[0]&&0===this._parallaxParams.anchorPointClouds[1]&&0===this._parallaxParams.anchorPointClouds[2]&&e.copy(this._parallaxParams.anchorPointClouds,m);var d=e.length(e.subtract(B,this._parallaxParams.anchorPointClouds,m));let l=!0;d>this._fadeInParams.distanceThresholdFactor*this._parallaxParams.cloudsHeight||this._fadeInParams.fadeInStage!==f.FINISHED?this._setFadeInStage(a):d>this._fadeInOutParams.distanceThresholdFactor*this._parallaxParams.cloudsHeight||this._fadeInOutParams.fadeInOutStage!==
c.FINISHED?this._setFadeInOutStage(a):d>this._crossFadeParams.distanceThresholdFactor*this._parallaxParams.cloudsHeight||this._crossFadeParams.crossFadeStage!==g.FINISHED?this._setCrossFadingStage():l=!1;d=e.length(a);const n=.05*this._parallaxParams.cloudsHeight,h=.1*this._parallaxParams.cloudsHeight;this._parallaxParams.cloudsFadeOutHeightFactor=1-u.clamp(1/(n-h)*(d-this._parallaxParams.radius)+-h/(n-h),0,1);this._parallaxParams.radiusCurvatureCorrectionFactor=.84*Math.sqrt(Math.max(d*d-this._parallaxParams.radius*
this._parallaxParams.radius,0))/d;t.fromPoints(y,this._parallaxParams.anchorPointClouds,r);this._parallaxParams.transform=p.create();w.rotate(this._parallaxParams.transform,this._parallaxParams.transform,r[3],t.axis(r));l&&(t.fromPoints(y,this._parallaxParamsNew.anchorPointClouds,r),this._parallaxParamsNew.transform=p.create(),w.rotate(this._parallaxParamsNew.transform,this._parallaxParamsNew.transform,r[3],t.axis(r)));e.copy(this._cameraPositionLastFrame,a)};k._bindParallaxParams=function(a,d){a.setUniform1f("cloudsHeight",
this._parallaxParams.cloudsHeight);a.setUniformMatrix4fv("rotationMatrixClouds",this._parallaxParams.transform);a.setUniformMatrix4fv("rotationMatrixCloudsCrossFade",this._parallaxParamsNew.transform);a.setUniform3fv("anchorPosition",this._parallaxParams.anchorPointClouds);a.setUniform3fv("anchorPositionCrossFade",this._parallaxParamsNew.anchorPointClouds);this._fadeInOutParams.fadeInOutStage!==c.FINISHED?a.setUniform1f("totalFadeInOut",this._parallaxParams.cloudsFadeOutHeightFactor+Math.max(u.clamp(this._fadeInOutParams.fadeInOutFactor,
0,1))):a.setUniform1f("totalFadeInOut",this._parallaxParams.cloudsFadeOutHeightFactor+Math.max(u.clamp(this._fadeInParams.fadeInFactor,0,1)));a.setUniform1f("radiusCurvatureCorrectionFactor",this._parallaxParams.radiusCurvatureCorrectionFactor);a.setUniform1i("crossFade",this._crossFadeParams.crossFadeStage);a.setUniform1f("crossFadeAnchorFactor",u.clamp(this._crossFadeParams.crossFadeFactor,0,1));a.setUniform1f("radius",this._parallaxParams.radius);a.setUniform3fv("cameraPosition",d.eye)};return b}();
const y=q.fromValues(0,0,1),r=t.create(),m=q.create(),B=q.create();x.CloudsComposition=C;Object.defineProperty(x,"__esModule",{value:!0})});