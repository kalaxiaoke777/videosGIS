// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.21/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/devEnvironmentUtils ../../../../core/maybe ../../../../chunks/mat3 ../../../../chunks/mat3f64 ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/buffer/BufferView ../../../../chunks/vec32 ../../../../chunks/vec42 ../../../../geometry/support/buffer/utils ../../glTF/DefaultLoadingContext ../../glTF/loader ../../glTF/internal/indexUtils ./wosrLoader ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/Texture ../../webgl-engine/materials/DefaultMaterial ../../webgl-engine/materials/DefaultMaterial_COLOR_GAMMA ../../../../chunks/vec22 ../../../../chunks/vec43 ../../../../chunks/vec33".split(" "),
function(G,T,U,d,P,V,W,X,w,K,L,q,H,M,B,Y,Z,N,Q,aa,D,ba,C,ca,R,da){function O(){O=T._asyncToGenerator(function*(c,e){var m=S(U.adjustStaticAGOUrl(c));if("wosr"===m.fileType)return c=yield e.cache?e.cache.loadWOSR(m.url,e):Q.load(m.url,e),m=Q.processLoadResult(c,e),{lods:[m],referenceBoundingBox:m.boundingBox,isEsriSymbolResource:!1,isWosr:!0,remove:c.remove};c=yield e.cache?e.cache.loadGLTF(m.url,e,e.usePBR):Z.load(new Y.DefaultLoadingContext(e.streamDataRequester),m.url,e,e.usePBR);var u=d.get(c.model.meta,
"ESRI_proxyEllipsoid");if(c.meta.isEsriSymbolResource&&d.isSome(u)&&-1!==c.meta.uri.indexOf("/RealisticTrees/"))a:for(var n=0;n<c.model.lods.length;++n){var x=c.model.lods[n];c.customMeta.esriTreeRendering=!0;for(var r of x.parts){x=r.attributes.normal;if(d.isNone(x))break a;const h=r.attributes.position,z=h.count,E=K.create(),l=K.create(),a=K.create(),t=B.createBuffer(q.BufferViewVec4u8,z),b=B.createBuffer(q.BufferViewVec3f,z),y=W.invert(X.create(),r.transform);for(let f=0;f<z;f++){h.getVec(f,l);
x.getVec(f,E);w.transformMat4(l,l,r.transform);w.subtract(a,l,u.center);w.divide(a,a,u.radius);const p=a[2];var v=w.length(a);v=Math.min(.45+.55*v*v,1);w.divide(a,a,u.radius);w.transformMat4(a,a,y);w.normalize(a,a);n+1!==c.model.lods.length&&1<c.model.lods.length&&(-1<p?w.lerp(a,a,E,.2):w.lerp(a,a,E,Math.min(-4*p-3.8,1)));b.setVec(f,a);t.set(f,0,255*v);t.set(f,1,255*v);t.set(f,2,255*v);t.set(f,3,255)}r.attributes.normal=b;r.attributes.color=t}}r=c.meta.isEsriSymbolResource?{usePBR:e.usePBR,isSchematic:!1,
treeRendering:c.customMeta.esriTreeRendering,mrrFactors:[0,1,.2]}:{usePBR:e.usePBR,isSchematic:!1,mrrFactors:[0,1,.5]};e={...e.materialParamsMixin,treeRendering:c.customMeta.esriTreeRendering};if(null!=m.specifiedLodIndex)return u=I(c,r,e,m.specifiedLodIndex),n=u[0].boundingBox,0!==m.specifiedLodIndex&&(n=I(c,r,e,0)[0].boundingBox),{lods:u,referenceBoundingBox:n,isEsriSymbolResource:c.meta.isEsriSymbolResource,isWosr:!1,remove:c.remove};m=I(c,r,e);return{lods:m,referenceBoundingBox:m[0].boundingBox,
isEsriSymbolResource:c.meta.isEsriSymbolResource,isWosr:!1,remove:c.remove}});return O.apply(this,arguments)}function S(c){const e=c.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return e?{fileType:"gltf",url:e[1],specifiedLodIndex:null!=e[4]?Number(e[4]):null}:c.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:c,specifiedLodIndex:null}:{fileType:"unknown",url:c,specifiedLodIndex:null}}function I(c,e,m,u){const n=c.model,x=V.create(),r=[],v=new Map,h=new Map;n.lods.forEach((z,E)=>{if(void 0===u||
E===u){var l={name:z.name,stageResources:{textures:[],materials:[],geometries:[]},lodThreshold:d.isSome(z.lodThreshold)?z.lodThreshold:null,pivotOffset:[0,0,0],numberOfVertices:0,boundingBox:L.empty()};r.push(l);z.parts.forEach(a=>{var t=a.material+(a.attributes.normal?"_normal":"")+(a.attributes.color?"_color":"")+(a.attributes.texCoord0?"_texCoord0":"")+(a.attributes.tangent?"_tangent":"");const b=n.materials.get(a.material),y=d.isSome(a.attributes.texCoord0);var f=d.isSome(a.attributes.normal);
a:{switch(b.alphaMode){case "BLEND":var p=0;break a;case "MASK":p=2;break a;case "OPAQUE":case null:case void 0:p=1;break a}p=void 0}if(!v.has(t)){if(y){if(d.isSome(b.textureColor)&&!h.has(b.textureColor)){var g=n.textures.get(b.textureColor);h.set(b.textureColor,new D.Texture(g.data,{...g.parameters,preMultiplyAlpha:1!==p}))}d.isSome(b.textureNormal)&&!h.has(b.textureNormal)&&(g=n.textures.get(b.textureNormal),h.set(b.textureNormal,new D.Texture(g.data,g.parameters)));d.isSome(b.textureOcclusion)&&
!h.has(b.textureOcclusion)&&(g=n.textures.get(b.textureOcclusion),h.set(b.textureOcclusion,new D.Texture(g.data,g.parameters)));d.isSome(b.textureEmissive)&&!h.has(b.textureEmissive)&&(g=n.textures.get(b.textureEmissive),h.set(b.textureEmissive,new D.Texture(g.data,g.parameters)));d.isSome(b.textureMetallicRoughness)&&!h.has(b.textureMetallicRoughness)&&(g=n.textures.get(b.textureMetallicRoughness),h.set(b.textureMetallicRoughness,new D.Texture(g.data,g.parameters)))}g=b.color[0]**(1/C.COLOR_GAMMA);
var A=b.color[1]**(1/C.COLOR_GAMMA),k=b.color[2]**(1/C.COLOR_GAMMA),F=b.emissiveFactor[0]**(1/C.COLOR_GAMMA);const ea=b.emissiveFactor[1]**(1/C.COLOR_GAMMA),fa=b.emissiveFactor[2]**(1/C.COLOR_GAMMA),J=d.isSome(b.textureColor)&&y?h.get(b.textureColor):null;v.set(t,new ba.DefaultMaterial({...e,transparent:0===p,textureAlphaMode:p,textureAlphaCutoff:b.alphaCutoff,diffuse:[g,A,k],ambient:[g,A,k],opacity:b.opacity,doubleSided:b.doubleSided,doubleSidedType:"winding-order",cullFace:b.doubleSided?0:2,vertexColors:!!a.attributes.color,
vertexTangents:!!a.attributes.tangent,normals:f?"default":"screenDerivative",castShadows:!0,receiveSSAO:!0,textureId:d.isSome(J)?J.id:void 0,colorMixMode:b.colorMixMode,normalTextureId:d.isSome(b.textureNormal)&&y?h.get(b.textureNormal).id:void 0,textureAlphaPremultiplied:d.isSome(J)&&!!J.params.preMultiplyAlpha,occlusionTextureId:d.isSome(b.textureOcclusion)&&y?h.get(b.textureOcclusion).id:void 0,emissiveTextureId:d.isSome(b.textureEmissive)&&y?h.get(b.textureEmissive).id:void 0,metallicRoughnessTextureId:d.isSome(b.textureMetallicRoughness)&&
y?h.get(b.textureMetallicRoughness).id:void 0,emissiveFactor:[F,ea,fa],mrrFactors:[b.metallicFactor,b.roughnessFactor,e.mrrFactors[2]],isSchematic:!1,...m}))}a:{f=a.indices||a.attributes.position.count;switch(a.primitiveType){case 4:f=N.trianglesToTriangles(f);break a;case 5:f=N.triangleStripToTriangles(f);break a;case 6:f=N.triangleFanToTriangles(f);break a}f=void 0}p=f;f=a.attributes.position.count;g=B.createBuffer(q.BufferViewVec3f,f);H.transformMat4(g,a.attributes.position,a.transform);g=[["position",
{data:g.typedBuffer,size:g.elementCount,exclusive:!0}]];A=[["position",p]];d.isSome(a.attributes.normal)&&(k=B.createBuffer(q.BufferViewVec3f,f),P.normalFromMat4(x,a.transform),H.transformMat3(k,a.attributes.normal,x),g.push(["normal",{data:k.typedBuffer,size:k.elementCount,exclusive:!0}]),A.push(["normal",p]));d.isSome(a.attributes.tangent)&&(k=B.createBuffer(q.BufferViewVec4f,f),P.normalFromMat4(x,a.transform),M.transformMat3(k,a.attributes.tangent,x),g.push(["tangent",{data:k.typedBuffer,size:k.elementCount,
exclusive:!0}]),A.push(["tangent",p]));d.isSome(a.attributes.texCoord0)&&(k=B.createBuffer(q.BufferViewVec2f,f),ca.normalizeIntegerBuffer(k,a.attributes.texCoord0),g.push(["uv0",{data:k.typedBuffer,size:k.elementCount,exclusive:!0}]),A.push(["uv0",p]));d.isSome(a.attributes.color)&&(k=B.createBuffer(q.BufferViewVec4u8,f),4===a.attributes.color.elementCount?a.attributes.color instanceof q.BufferViewVec4f?M.scale(k,a.attributes.color,255):a.attributes.color instanceof q.BufferViewVec4u8?R.copy(k,a.attributes.color):
a.attributes.color instanceof q.BufferViewVec4u16&&M.scale(k,a.attributes.color,1/256):(R.fill(k,255,255,255,255),F=new q.BufferViewVec3u8(k.buffer,0,4),a.attributes.color instanceof q.BufferViewVec3f?H.scale(F,a.attributes.color,255):a.attributes.color instanceof q.BufferViewVec3u8?da.copy(F,a.attributes.color):a.attributes.color instanceof q.BufferViewVec3u16&&H.scale(F,a.attributes.color,1/256)),g.push(["color",{data:k.typedBuffer,size:k.elementCount,exclusive:!0}]),A.push(["color",p]));a=new aa.Geometry(g,
A);l.stageResources.geometries.push(a);l.stageResources.materials.push(v.get(t));y&&(d.isSome(b.textureColor)&&l.stageResources.textures.push(h.get(b.textureColor)),d.isSome(b.textureNormal)&&l.stageResources.textures.push(h.get(b.textureNormal)),d.isSome(b.textureOcclusion)&&l.stageResources.textures.push(h.get(b.textureOcclusion)),d.isSome(b.textureEmissive)&&l.stageResources.textures.push(h.get(b.textureEmissive)),d.isSome(b.textureMetallicRoughness)&&l.stageResources.textures.push(h.get(b.textureMetallicRoughness)));
l.numberOfVertices+=f;t=a.boundingInfo;d.isSome(t)&&(L.expandWithVec3(l.boundingBox,t.getBBMin()),L.expandWithVec3(l.boundingBox,t.getBBMax()))})}});return r}G.fetch=function(c,e){return O.apply(this,arguments)};G.gltfToEngineResources=I;G.parseUrl=S;Object.defineProperty(G,"__esModule",{value:!0})});