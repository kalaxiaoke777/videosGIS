// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.21/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../intl ../../../../../core/Accessor ../../../../../core/Handles ../../../../../core/mathUtils ../../../../../core/maybe ../../../../../core/quantityFormatUtils ../../../../../core/screenUtils ../../../../../core/unitUtils ../../../../../core/watchUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/has ../../../../../core/accessorSupport/ensureType ../../../../../core/Logger ../../../../../core/accessorSupport/decorators/subclass ../../../../../core/accessorSupport/trackingUtils ../../../../../chunks/vec2 ../../../../../chunks/vec3 ../../../../../chunks/vec3f64 ../../../../../chunks/vec4f32 ../../../../../chunks/vec4f64 ../../../../../geometry/projectionEllipsoid ../../../interactive/visualElements/LabelVisualElement ../../../interactive/visualElements/LineVisualElement ../../../interactive/visualElements/MeasurementArrowVisualElement ../../../interactive/visualElements/RightAngleQuadVisualElement ../../../interactive/visualElements/support/Segment ../support/viewUtils ../../../webgl-engine/materials/lineStippleUtils ../../../../../intl/locale ../../../../../intl/messages".split(" "),
function(f,C,h,ea,O,P,t,g,p,y,I,J,k,fa,ha,ia,Q,w,K,L,z,R,S,T,A,D,U,V,v,F,G,W,X){f.DirectLineMeasurementView=function(M){function E(a){a=M.call(this,a)||this;a._params={...Y};a._handles=new P;a._segmentVisualElement=null;a._triangleVisualElement=null;a._rightAngleQuad=null;a._projectedGeodesicLine=null;a._geodesicStartHint=null;a._geodesicEndHint=null;a._segmentLabel=null;a._verticalLabel=null;a._horizontalLabel=null;a._startPosition=z.create();a._endPosition=z.create();a._cornerPosition=z.create();
a._startPositionAtSeaLevel=z.create();a._endPositionAtSeaLevel=z.create();a._state=0;a._segmentLabelDisplayedMeasurement=1;a._triangleOrientationOverride=null;a.messages=null;a.loadingMessages=!0;a.viewMode=0;a.visualizedMeasurement=0;a.actualVisualizedMeasurement=1;a.visualElementOrientation=0;a.triangleCollapseRatioThreshold=.03;return a}C._inheritsLoose(E,M);var m=E.prototype;m.initialize=function(){this._handles.add(J.whenOnce(this.view,"ready",()=>this._initialize(),!0))};m._initialize=function(){var a=
this;switch(this._state){case 1:throw Error("invalid state");case 2:return}const b=this._params,d={attached:!0,view:this.view};this._segmentVisualElement=new U.MeasurementArrowVisualElement({...d,geometry:null,renderOccluded:4});this._triangleVisualElement=new D.LineVisualElement({...d,width:b.triangleLineWidth,color:b.triangleColor,renderOccluded:4});this._rightAngleQuad=new V.RightAngleQuadVisualElement({...d,color:B,renderOccluded:4});const c={...d,polygonOffset:!0,stippleIntegerRepeats:!1,renderOccluded:4};
this._projectedGeodesicLine=new D.LineVisualElement({...c,width:b.geodesicProjectionLineWidth,color:b.geodesicProjectionLineColor,stipplePattern:G.createStipplePatternSimple(b.guideStippleLengthPixels)});this._geodesicStartHint=new D.LineVisualElement({...c,width:b.guideLineWidth,color:b.geodesicProjectionLineColor,stipplePattern:G.createStipplePatternSimple(b.guideStippleLengthPixels)});this._geodesicEndHint=new D.LineVisualElement({...c,width:b.guideLineWidth,color:b.geodesicProjectionLineColor,
stipplePattern:G.createStipplePatternSimple(b.guideStippleLengthPixels)});this._segmentLabel=new A.LabelVisualElement({...d,fontSize:b.direcLabelFontSize});this._verticalLabel=new A.LabelVisualElement({...d,fontSize:b.verticalLabelFontSize});this._horizontalLabel=new A.LabelVisualElement({...d,fontSize:b.horizontalLabelFontSize});this._handles.add([w.autorun(()=>this._updateGeometryAndViewMode()),w.autorun(()=>this._updateVisualElementVisibility()),w.reactionInit(()=>this.layerView.fullOpacity,()=>
this._updateVisualElementsOpacity()),w.autorun(()=>this._updateLabelText()),w.autorun(()=>this._updateLabelVisibility()),w.autorun(()=>this._updateSegmentStripeLength()),W.onLocaleChange(C._asyncToGenerator(function*(){return a._updateMessageBundle()}))]);this._state=1;this._updateMessageBundle()};m.destroy=function(){2!==this._state&&(this._handles=g.destroyMaybe(this._handles),this._segmentVisualElement=g.destroyMaybe(this._segmentVisualElement),this._triangleVisualElement=g.destroyMaybe(this._triangleVisualElement),
this._rightAngleQuad=g.destroyMaybe(this._rightAngleQuad),this._projectedGeodesicLine=g.destroyMaybe(this._projectedGeodesicLine),this._geodesicStartHint=g.destroyMaybe(this._geodesicStartHint),this._geodesicEndHint=g.destroyMaybe(this._geodesicEndHint),this._segmentLabel=g.destroyMaybe(this._segmentLabel),this._verticalLabel=g.destroyMaybe(this._verticalLabel),this._horizontalLabel=g.destroyMaybe(this._horizontalLabel),this.set("view",null),this._state=2)};m.whenReady=function(){var a=C._asyncToGenerator(function*(){yield J.whenOnce(this,
"ready")});return function(){return a.apply(this,arguments)}}();m._updateVisualElementVisibility=function(){this._segmentVisualElement.visible=!1;this._triangleVisualElement.visible=!1;this._rightAngleQuad.visible=!1;this._projectedGeodesicLine.visible=!1;this._geodesicStartHint.visible=!1;this._geodesicEndHint.visible=!1;if(this.visible)switch(this.viewMode){case 1:this._segmentVisualElement.visible=!0;break;case 2:this._segmentVisualElement.visible=!0;this._triangleVisualElement.visible=!0;this._rightAngleQuad.visible=
!0;break;case 3:this._segmentVisualElement.visible=!0,this._projectedGeodesicLine.visible=!0,this._geodesicStartHint.visible=!0,this._geodesicEndHint.visible=!0}};m._updateGeometryAndViewMode=function(){var a=this.view.renderCoordsHelper;const {elevationAlignedStartPoint:b,elevationAlignedEndPoint:d}=this.layerView;if(g.isNone(b)||g.isNone(d)||b.equals(d)){this.viewMode=0;var c=this.visualizedMeasurement;this.actualVisualizedMeasurement=0===c?1:c}else{a.toRenderCoords(b,this._startPosition);a.toRenderCoords(d,
this._endPosition);c=this._getActualVisualElementsOrientation();var l=this._updateActualVisualizedMeasurement();this.viewMode=this._computeViewMode(l);var r=this._startPosition,e=this._endPosition,q=1===c?1:-1,n=q*(a.getAltitude(e)-a.getAltitude(r));0>n&&(r=this._endPosition,e=this._startPosition);a=2===l?new v.GeodesicSegment(this._startPosition,this._endPosition,a.spatialReference):new v.EuclideanSegment(this._startPosition,this._endPosition);this._segmentVisualElement.geometry=a;this._updateSegmentStripeLength();
this._segmentLabelDisplayedMeasurement=l;switch(this.viewMode){case 1:this._updateSegment(a,c);break;case 2:this._updateSegmentAndTriangle(a,c,r,e,q,n);break;case 3:this._updateSegmentAndProjection(c)}}};m._updateSegment=function(a,b){this._segmentLabel.anchor=1===b?"top":"bottom";this._segmentLabel.geometry={type:"segment",segment:a,sampleLocation:"center"}};m._updateSegmentAndTriangle=function(a,b,d,c,l,r){var e=this.view;const q=e.state.camera,n=this._cornerPosition;e.renderCoordsHelper.worldUpAtPosition(d,
n);L.scale(n,n,l*Math.abs(r));L.add(n,n,d);this._triangleVisualElement.geometry=[[[d[0],d[1],d[2]],[n[0],n[1],n[2]],[c[0],c[1],c[2]]]];this._rightAngleQuad.geometry={previous:d,center:n,next:c};l=new v.EuclideanSegment(d,n);r=new v.EuclideanSegment(n,c);e=Z;var u=aa;q.projectToRenderScreen(n,e);q.projectToRenderScreen(c,u);e={segment:"bottom",horizontal:"top",vertical:e[0]<u[0]?"left":"right"};{const H=ba;u=ca;F.screenSpaceTangent(d,n,H,q);F.screenSpaceTangent(d,c,u,q);K.dot(H,u)>=N?(c=t.sign(H[1])===
t.sign(u[1]),e.segment=c?A.mirrorPosition(e.vertical):e.vertical):(d=da,F.screenSpaceTangent(n,c,d,q),K.dot(d,u)>=N&&(e.segment=t.sign(d[0])===t.sign(u[0])?A.mirrorPosition(e.horizontal):e.horizontal))}2===b&&(e.segment="top"===e.segment?"bottom":"top",e.horizontal="top"===e.horizontal?"bottom":"top",e.vertical="top"===e.vertical?"bottom":"top");b=e;this._segmentLabel.anchor=b.segment;this._segmentLabel.geometry={type:"segment",segment:a,sampleLocation:"center"};this._verticalLabel.geometry={type:"segment",
segment:l,sampleLocation:"center"};this._verticalLabel.anchor=b.vertical;this._horizontalLabel.geometry={type:"segment",segment:r,sampleLocation:"center"};this._horizontalLabel.anchor=b.horizontal};m._updateSegmentAndProjection=function(a){var b=this.view.renderCoordsHelper;b.setAltitude(this._startPositionAtSeaLevel,0,this._startPosition);b.setAltitude(this._endPositionAtSeaLevel,0,this._endPosition);b=new v.GeodesicSegment(this._startPositionAtSeaLevel,this._endPositionAtSeaLevel,b.spatialReference);
this._projectedGeodesicLine.setGeometryFromSegment(b);this._geodesicStartHint.setGeometryFromSegment(new v.EuclideanSegment(this._startPositionAtSeaLevel,this._startPosition));this._geodesicEndHint.setGeometryFromSegment(new v.EuclideanSegment(this._endPositionAtSeaLevel,this._endPosition));this._segmentLabel.geometry={type:"segment",segment:b,sampleLocation:"center"};this._segmentLabel.anchor=1===a?"top":"bottom"};m._updateLabelText=function(){if(1===this._state){var a=this._segmentLabel,b=this._horizontalLabel,
d=this._verticalLabel,c=this.messages,l=this.layerView.result;g.isNone(l)||g.isNone(c)?(a.text=null,b.text=null,d.text=null):(c=this._getLabelsText(c,l),a.text=1===this._segmentLabelDisplayedMeasurement?c.euclideanDistance:c.geodesicDistance,b.text=c.horizontalDistance,d.text=c.verticalDistance,this.notifyChange("labels"))}};m._updateLabelVisibility=function(){if(1===this._state){var a=this._segmentLabel,b=this._horizontalLabel,d=this._verticalLabel;a.visible=!1;b.visible=!1;d.visible=!1;if(this.visible)switch(this.viewMode){case 1:a.visible=
!0;break;case 2:a.visible=!0;b.visible=!0;d.visible=!0;break;case 3:a.visible=!0}}};m._getLabelsText=function(a,{directDistance:b,horizontalDistance:d,verticalDistance:c,geodesicDistance:l,geodesicAngle:r}){const e=this.layerView.unit,q=n=>({euclideanDistance:"",geodesicDistance:"",horizontalDistance:"",verticalDistance:"",...n});switch(e){case "metric":return q({euclideanDistance:b&&p.formatMetricLength(a,b),geodesicDistance:l&&p.formatMetricLength(a,l),horizontalDistance:d&&p.formatMetricLength(a,
d),verticalDistance:c&&p.formatMetricVerticalLength(a,c)});case "imperial":return q({euclideanDistance:b&&p.formatImperialLength(a,b),geodesicDistance:l&&p.formatImperialLength(a,l),horizontalDistance:d&&p.formatImperialLength(a,d),verticalDistance:c&&p.formatImperialVerticalLength(a,c)});case "degrees":return a=r&&p.formatDecimal(a,r,"degrees"),q({euclideanDistance:a,geodesicDistance:a,horizontalDistance:a});case "degrees-minutes-seconds":return q({horizontalDistance:r&&p.formatDMS(r)});default:return q({euclideanDistance:b&&
p.formatDecimal(a,b,e),geodesicDistance:l&&p.formatDecimal(a,l,e),horizontalDistance:d&&p.formatDecimal(a,d,e),verticalDistance:c&&p.formatDecimal(a,c,e)})}};m._updateSegmentStripeLength=function(){const a=this._measurementArrowStripeLength,b=this._segmentVisualElement;g.isSome(a)?(b.stripeLength=a,b.stripesEnabled=!0):b.stripesEnabled=!1};m._computeViewMode=function(a){if(2===a){if(!this._geodesicDistanceExceeded)return 1;if(this._requiresGeodesicGuideAt(this._startPosition)||this._requiresGeodesicGuideAt(this._endPosition))return 3}a=
this.layerView.result;if(g.isNone(a))return 1;const {verticalDistance:b,horizontalDistance:d}=a;a=b.value;const c=d.value;return Math.min(a/c,c/a)<this.triangleCollapseRatioThreshold?1:2};m._getActualVisualElementsOrientation=function(){if(g.isSome(this._triangleOrientationOverride))return this._triangleOrientationOverride;const a=this.visualElementOrientation;return 0===a?this.view.state.camera.aboveGround?1:2:a};m._updateActualVisualizedMeasurement=function(){if(0===this.visualizedMeasurement){this.actualVisualizedMeasurement=
1;const a=this.layerView.unit;if("degrees"===a||"degrees-minutes-seconds"===a)this.actualVisualizedMeasurement=2;this._geodesicDistanceExceeded&&(this.actualVisualizedMeasurement=2)}else this.actualVisualizedMeasurement=this.visualizedMeasurement;return this.actualVisualizedMeasurement};m._requiresGeodesicGuideAt=function(a){var b=this.view;if(!b.state)return!1;const d=b.renderCoordsHelper;b=b.state.camera.computeScreenPixelSizeAt(a);return 10<=d.getAltitude(a)/b};m._updateMessageBundle=function(){this.loadingMessages=
!0;X.fetchMessageBundle("esri/core/t9n/Units").then(a=>{this.messages=a;this.view&&this._updateLabelText()}).finally(()=>{this.loadingMessages=!1})};m._updateVisualElementsOpacity=function(){const a=this.layerView.fullOpacity,{triangleColor:b,geodesicProjectionLineColor:d}=this._params;this._triangleVisualElement.color=t.applyOpacity(x,b,a);this._rightAngleQuad.color=t.applyOpacity(x,B,a);t.applyOpacity(x,d,a);this._projectedGeodesicLine.color=x;this._geodesicStartHint.color=x;this._geodesicEndHint.color=
x;this._segmentVisualElement.opacity=a};C._createClass(E,[{key:"_geodesicDistanceExceeded",get:function(){var a;const b=this.layerView.result;return g.isSome(b)&&(null==(a=b.horizontalDistance)?void 0:a.value)>this.layer.geodesicDistanceThreshold}},{key:"ready",get:function(){return 1===this._state}},{key:"visible",get:function(){return this.layerView.visible&&!this.layerView.suspended}},{key:"allowVisualElementsOrientationChange",get:function(){return g.isNone(this._triangleOrientationOverride)},
set:function(a){g.isNone(this._triangleOrientationOverride)!==a&&(g.isNone(this._triangleOrientationOverride)?this._triangleOrientationOverride=this._getActualVisualElementsOrientation():this._triangleOrientationOverride=null)}},{key:"labels",get:function(){return{direct:this._segmentLabel,horizontal:2===this.actualVisualizedMeasurement?this._segmentLabel:this._horizontalLabel,vertical:this._verticalLabel}}},{key:"testData",get:function(){var a;return{labels:this.labels,stripeLength:null==(a=this._segmentVisualElement)?
void 0:a.stripeLength}}},{key:"_measurementArrowStripeLength",get:function(){const a=this.view,{result:b,unit:d}=this.layerView;var c=null;if(g.isSome(b))switch(c=b.directDistance,d){case "metric":c=c&&c.toUnit("meters");break;case "imperial":c=c&&c.toUnit(I.preferredImperialLengthUnit(c.value,c.unit));break;case "degrees":case "degrees-minutes-seconds":c=(c=b.geodesicAngle)&&c.toUnit("degrees");break;default:c=c&&c.toUnit(d)}if(c){let l=1;l=t.nextHighestPowerOfTen(c.value/30);return l*="degrees"===
c.unit?T.getReferenceEllipsoid(a.spatialReference).metersPerDegree:I.convertUnit(1,c.unit,"meters")}return null}}]);return E}(O);h.__decorate([k.property()],f.DirectLineMeasurementView.prototype,"_state",void 0);h.__decorate([k.property()],f.DirectLineMeasurementView.prototype,"_segmentLabelDisplayedMeasurement",void 0);h.__decorate([k.property()],f.DirectLineMeasurementView.prototype,"_triangleOrientationOverride",void 0);h.__decorate([k.property()],f.DirectLineMeasurementView.prototype,"_geodesicDistanceExceeded",
null);h.__decorate([k.property()],f.DirectLineMeasurementView.prototype,"messages",void 0);h.__decorate([k.property()],f.DirectLineMeasurementView.prototype,"view",void 0);h.__decorate([k.property()],f.DirectLineMeasurementView.prototype,"layer",void 0);h.__decorate([k.property()],f.DirectLineMeasurementView.prototype,"layerView",void 0);h.__decorate([k.property({readOnly:!0})],f.DirectLineMeasurementView.prototype,"ready",null);h.__decorate([k.property()],f.DirectLineMeasurementView.prototype,"loadingMessages",
void 0);h.__decorate([k.property({readOnly:!0})],f.DirectLineMeasurementView.prototype,"visible",null);h.__decorate([k.property()],f.DirectLineMeasurementView.prototype,"viewMode",void 0);h.__decorate([k.property()],f.DirectLineMeasurementView.prototype,"visualizedMeasurement",void 0);h.__decorate([k.property()],f.DirectLineMeasurementView.prototype,"actualVisualizedMeasurement",void 0);h.__decorate([k.property()],f.DirectLineMeasurementView.prototype,"visualElementOrientation",void 0);h.__decorate([k.property()],
f.DirectLineMeasurementView.prototype,"triangleCollapseRatioThreshold",void 0);h.__decorate([k.property()],f.DirectLineMeasurementView.prototype,"allowVisualElementsOrientationChange",null);h.__decorate([k.property()],f.DirectLineMeasurementView.prototype,"labels",null);h.__decorate([k.property()],f.DirectLineMeasurementView.prototype,"testData",null);h.__decorate([k.property()],f.DirectLineMeasurementView.prototype,"_measurementArrowStripeLength",null);f.DirectLineMeasurementView=h.__decorate([Q.subclass("esri.views.3d.layers.DirectLineMeasurement.DirectLineMeasurementView")],
f.DirectLineMeasurementView);const B=R.fromValues(1,.5,0,.75),Y={laserLineGlowColor:[1,.5,0],laserLineGlowWidth:8,laserLineGlowFalloff:8,laserLineInnerColor:[1,1,1],laserLineInnerWidth:.75,laserLineGlobalAlpha:.75,laserLineEnabled:!0,handleColor:[1,.5,0],handleOpacity:.5,handleRadius:5,triangleColor:B,triangleLineWidth:3,triangleCornerSize:32,triangleSubdivisions:128,arrowWidth:16,arrowOutlineColor:[1,.5,0,1],arrowOutlineWidth:.2,arrowStripeEvenColor:[1,1,1,1],arrowStripeOddColor:[1,.5,0,1],arrowStripeLength:16,
arrowSubdivisions:128,geodesicProjectionLineWidth:2,geodesicProjectionLineColor:B,guideLineWidth:2,guideLineColor:B,guideStippleLengthPixels:6,labelDistance:25,direcLabelFontSize:16,horizontalLabelFontSize:12,verticalLabelFontSize:12},N=Math.cos(t.deg2rad(12)),x=S.create(),Z=y.createRenderScreenPointArray3(),aa=y.createRenderScreenPointArray3(),ba=y.createRenderScreenPointArray(),ca=y.createRenderScreenPointArray(),da=y.createRenderScreenPointArray();Object.defineProperty(f,"__esModule",{value:!0})});