// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.21/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../geometry ../../../../../core/Accessor ../../../../../core/Evented ../../../../../core/Handles ../../../../../core/handleUtils ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/has ../../../../../core/accessorSupport/ensureType ../../../../../core/Logger ../../../../../core/accessorSupport/decorators/subclass ../../../../../core/accessorSupport/trackingUtils ../../../../../chunks/vec3 ../../../../../chunks/vec3f64 ../../../../../geometry/projection ../../../../../geometry/support/aaBoundingRect ../../../../../geometry/support/ray ./LineOfSightAnalysis ./LineOfSightRayIntersector ./LineOfSightResult ../../../support/ElevationProvider ../../../webgl-engine/lib/intersectorUtilsConversions ../../../../support/Scheduler ../../../../../geometry/Point".split(" "),
function(l,F,m,ba,S,T,I,v,f,J,n,ca,da,ea,U,q,g,w,V,K,L,W,X,M,Y,N,z,Z){function O(C,x,d){if(f.isNone(d))return!1;V.projectBoundingRect(C,x,P,d.spatialReference);return K.containsPointObject(P,d)}l.LineOfSightController=function(C){function x(a){a=C.call(this,a)||this;a._tasks=z.ImmediateTask;a._handles=new I;a._analysisHandles=new I;return a}F._inheritsLoose(x,C);var d=x.prototype;d.initialize=function(){var a;const b=null==(a=this.view.resourceController)?void 0:a.scheduler;b&&(this._tasks=b.registerTask(z.TaskPriority.LINE_OF_SIGHT_TOOL));
this._handles.add([this._connectObserver(),this._connectAnalyses(),this._connectTargets()]);this._intersector=new X.LineOfSightRayIntersector({view:this.view})};d.destroy=function(){this._handles.destroy();this._analysisHandles.destroy();this._analyses.removeAll()};d.getLineOfSightComputationDependencies=function(a){({inputPoints:a}=a);return{inputPoints:a}};d.computeAnalysis=function(a){const {analysis:b}=a,{inputPoints:c,computationResult:e}=b,{observerAdjusted:p,targetAdjusted:h}=c,{start:k,end:r}=
e;g.copy(k,p);g.copy(r,h);this._canComputeAnalysis(b)?this._computeAnalysisIntersection(a):this._interpolateAnalysisIntersection(a);b.updateComputationResults();this.emit("result-changed",{target:a.analysis.target,result:b.result})};d._adjustStartEndPositions=function(a){var b=this._screenPixelSize;const c=this.view;({inputPoints:a}=a);const {observer:e,observerSurfaceNormal:p,target:h,targetSurfaceNormal:k,observerAdjusted:r,targetAdjusted:t}=a;a=D;f.isSome(p)?g.copy(a,p):g.subtract(a,h,e);g.normalize(a,
a);g.scale(a,a,Math.min(b,1));g.add(r,e,a);f.isSome(k)?g.copy(a,k):g.subtract(a,e,h);b=c.state.camera.computeScreenPixelSizeAt(h);g.normalize(a,a);g.scale(a,a,Math.min(b,1));g.add(t,h,a)};d._computeAnalysisIntersection=function({analysis:a,interpolationInfo:b}){const {view:c}=this,{sceneIntersectionHelper:e,renderCoordsHelper:p}=c;if(!f.isNone(e)){var h=this._intersector.intersector,{computationResult:k,inputPoints:r}=a,{observer:t,target:y}=r,{start:G,end:H}=k,A=L.fromPoints(G,H,aa);e.intersectToolIntersectorRay(A,
h);var E=k.intersection,Q=D;A=h.results.min?h.results.min.getIntersectionPoint(E):!1;var u=!0;A&&(g.copy(b.originalIntersection,E),g.copy(b.originalObserver,G),g.copy(b.originalTarget,H),p.fromRenderCoords(E,Q,c.spatialReference),b=1-g.dist(H,y)/g.dist(G,y),u=g.dist(t,E)>=b*g.dist(t,y));b=new Z(Q,c.spatialReference);{const {result:B,target:R}=a;f.isSome(B)?(B.target=R,B.intersectedGraphic=u?null:N.toGraphic(h.results.min,c),B.intersectedLocation=u?null:b,B.visible=A?u:!1):a.result=new M.LineOfSightResult({target:R,
elevationAlignedTargetLocation:a.elevationAlignedTargetLocation,intersectedGraphic:u?null:N.toGraphic(h.results.min,c),intersectedLocation:u?null:b,visible:A?u:!1})}k.isValid=r.isValid=!0;k.isTargetVisible=u}};d._interpolateAnalysisIntersection=function({analysis:a,interpolationInfo:b}){const {computationResult:c,inputPoints:e}=a,{start:p,end:h,intersection:k}=c,{originalIntersection:r,originalObserver:t,originalTarget:y}=b;g.copy(k,r);e.isValid?(a=D,b=g.dist(t,r)/g.dist(t,y),g.sub(a,p,t),g.scale(a,
a,1-b),g.add(k,k,a),g.sub(a,h,y),g.scale(a,a,b),g.add(k,k,a),c.isValid=!0):(a.result=new M.LineOfSightResult,c.isValid=!1,c.isTargetVisible=!1)};d._canComputeAnalysis=function(a){var b=this.view.frustum;if(f.isNone(this.layerViewData.elevationAlignedObserver)||f.isNone(a.target)||f.isNone(b))return!1;const {observerAdjusted:c,targetAdjusted:e}=a.inputPoints;a=b.intersectsPoint(c);b=b.intersectsPoint(e);return a&&b};d._onObserverChange=function(a){f.isNone(a)?(this.layer.targets.removeAll(),this.layerViewData.elevationAlignedObserver=
null):(this.layerViewData.elevationAlignedObserver=this._applyElevationAlignment(a,this.layer.intersection),a=w.create(),this.view.renderCoordsHelper.toRenderCoords(this.layerViewData.elevationAlignedObserver,a),this._observerEngineLocation=a,this.priority=z.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE)};d._applyElevationAlignment=function(a,b){if(a.hasZ&&(f.isNone(b)||"Graphic"===b.type))return a;a=a.clone();a.z=f.unwrapOr(Y.getElevationAtPoint(this.view.elevationProvider,a),0);return a};d._onObserverChangeForAnalysis=
function(a){a.inputPoints.isValid=!1};d._onObserverEngineForAnalysis=function(a,b,c){const {inputPoints:e}=a;g.copy(e.observer,b);f.isSome(c)?(b=this._intersector.updateFromIntersectionResult(c),f.isSome(b)&&this.view.renderCoordsHelper.toRenderCoords(b,e.observer),e.observerSurfaceNormal=w.clone(c.normal)):e.observerSurfaceNormal=null;this._adjustStartEndPositions(a);a.updateInputPoints();this.priority=z.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE};d._onTargetLocationChange=function(a,b,c){const {inputPoints:e}=
a;e.isValid=!1;f.isSome(b)&&(a.elevationAlignedTargetLocation=this._applyElevationAlignment(b,c),this.view.renderCoordsHelper.toRenderCoords(a.elevationAlignedTargetLocation,e.target),f.isSome(c)?(b=this._intersector.updateFromIntersectionResult(c),f.isSome(b)&&this.view.renderCoordsHelper.toRenderCoords(b,e.target),e.targetSurfaceNormal=w.clone(c.normal)):e.targetSurfaceNormal=null,this._adjustStartEndPositions(a),a.updateInputPoints());this.priority=z.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE};
d._connectAnalysisToTarget=function(a){return q.reactionInit(()=>({analysis:a,targetLocation:a.target.location,targetIntersection:a.target.intersection}),({analysis:b,targetLocation:c,targetIntersection:e})=>{f.isSome(c)&&this._onTargetLocationChange(b,c,e)})};d._connectAnalysisToObserver=function(a){return q.reactionInit(()=>({analysis:a,observer:this.layerViewData.elevationAlignedObserver}),({analysis:b})=>{this._onObserverChangeForAnalysis(b)})};d._connectAnalysisToObserverEngine=function(a){return q.reactionInit(()=>
({analysis:a,observer:this._observerEngineLocation,observerIntersection:this.layer.intersection}),({analysis:b,observer:c,observerIntersection:e})=>{this._onObserverEngineForAnalysis(b,c,e)})};d._connectAnalysisToCamera=function(a){return q.reaction(()=>({camera:this.view.state.camera,isDirty:this._isCameraDirty}),({isDirty:b})=>{a.inputPoints.isValid&&!b||a.updateInputPoints()})};d._connectAnalysisToElevation=function(a){return this.view.elevationProvider.on("elevation-change",b=>{if(this._canComputeAnalysis(a)){var c=
this.layer.observer;O(b.extent,b.spatialReference,c)&&this._onObserverChange(c);c=a.target;if(f.isSome(c)&&O(b.extent,b.spatialReference,c.location))a.onElevationChange()}})};d._connectAnalysisForCompute=function(a){var b=this;let c=f.none;const e={analysis:a,interpolationInfo:{originalIntersection:w.create(),originalObserver:w.create(),originalTarget:w.create()}};return v.handlesGroup([q.reactionInit(()=>this.getLineOfSightComputationDependencies(a),()=>{c=f.abortMaybe(c);c=J.createTask(function(){var p=
F._asyncToGenerator(function*(h){yield J.ignoreAbortErrors(b._tasks.schedule(()=>b.computeAnalysis(e),h))});return function(h){return p.apply(this,arguments)}}())}),v.makeHandle(()=>c=f.abortMaybe(c))])};d._connectAnalysis=function(a){const b=this._analysisHandles;b.has(a)||b.add([this._connectAnalysisToTarget(a),this._connectAnalysisToObserver(a),this._connectAnalysisToObserverEngine(a),this._connectAnalysisToCamera(a),this._connectAnalysisToElevation(a),this._connectAnalysisForCompute(a)])};d._disconnectAnalysis=
function(a){this._analysisHandles.remove(a)};d._onAnalysesCollectionChange=function(a){a.added.forEach(b=>this._connectAnalysis(b));a.removed.forEach(b=>this._disconnectAnalysis(b))};d._onTargetsChange=function(a){this._analyses.removeAll();0<a.items.length&&a.forEach(b=>this._addTarget(b));return a.on("change",b=>this._onTargetCollectionChange(b))};d._onTargetCollectionChange=function(a){a.added.forEach(b=>this._addTarget(b));a.removed.forEach(b=>this._removeTarget(b))};d._onCursorTargetChange=function(a,
b){f.isSome(b)&&this._removeTarget(b);f.isSome(a)&&this._addTarget(a)};d._addTarget=function(a){const b=this._analyses;b.some(c=>c.target===a)||b.add(new W.LineOfSightAnalysis({target:a}))};d._removeTarget=function(a){const b=this._analyses,c=b.find(e=>e.target===a);b.remove(c)};d._connectObserver=function(){return v.handlesGroup([q.reactionInit(()=>this.layer.observer,a=>this._onObserverChange(a))])};d._connectAnalyses=function(){let a=null;return v.handlesGroup([q.reactionInit(()=>this._analyses,
b=>{a=f.removeMaybe(a);a=b.on("change",c=>this._onAnalysesCollectionChange(c));b.forEach(c=>this._connectAnalysis(c))}),v.makeHandle(()=>a=f.removeMaybe(a))])};d._connectTargets=function(){let a=null;return v.handlesGroup([q.reactionInit(()=>this.layer.targets,b=>{a=f.removeMaybe(a);a=this._onTargetsChange(b)}),q.reactionInit(()=>this.layerViewData.cursorTarget,(b,c)=>{this._onCursorTargetChange(b,c)}),v.makeHandle(()=>{a=f.removeMaybe(a)})])};F._createClass(x,[{key:"updating",get:function(){return this._tasks.updating}},
{key:"priority",get:function(){return this._tasks.priority},set:function(a){this._tasks.priority=a}},{key:"_analyses",get:function(){return this.layerViewData.analyses}},{key:"_observerEngineLocation",get:function(){return this.layerViewData.observerEngineLocation},set:function(a){this.layerViewData.observerEngineLocation=a}},{key:"_screenPixelSize",get:function(){return this.view.state.camera.computeScreenPixelSizeAt(this._observerEngineLocation)}},{key:"_isCameraDirty",get:function(){var a=this.layerViewData.elevationAlignedObserver;
const {view:b}=this,{renderCoordsHelper:c}=b;if(f.isNone(a)||f.isNone(c))return!1;const e=D;c.toRenderCoords(a,e);a=b.state.camera.computeScreenPixelSizeAt(e);return.1<Math.abs((a-this._screenPixelSize)/this._screenPixelSize)}}]);return x}(T.EventedMixin(S));m.__decorate([n.property({constructOnly:!0})],l.LineOfSightController.prototype,"layer",void 0);m.__decorate([n.property({constructOnly:!0})],l.LineOfSightController.prototype,"layerViewData",void 0);m.__decorate([n.property({constructOnly:!0})],
l.LineOfSightController.prototype,"view",void 0);m.__decorate([n.property()],l.LineOfSightController.prototype,"updating",null);m.__decorate([n.property()],l.LineOfSightController.prototype,"priority",null);m.__decorate([n.property()],l.LineOfSightController.prototype,"_analyses",null);m.__decorate([n.property()],l.LineOfSightController.prototype,"_observerEngineLocation",null);m.__decorate([n.property()],l.LineOfSightController.prototype,"_screenPixelSize",null);m.__decorate([n.property()],l.LineOfSightController.prototype,
"_tasks",void 0);m.__decorate([n.property()],l.LineOfSightController.prototype,"_isCameraDirty",null);l.LineOfSightController=m.__decorate([U.subclass("esri.views.3d.layers.analysis.LineOfSight.LineOfSightController")],l.LineOfSightController);const D=w.create(),aa=L.create(),P=K.empty();Object.defineProperty(l,"__esModule",{value:!0})});