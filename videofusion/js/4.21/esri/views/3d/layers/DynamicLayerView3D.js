// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.21/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/asyncUtils ../../../core/Logger ../../../core/maybe ../../../core/promiseUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../../../geometry/Extent ../../../geometry/support/aaBoundingRect ./LayerView3D ./support/overlayImageUtils ./support/projectExtentUtils ../support/debugFlags ../webgl-engine/lib/RenderGeometry ../webgl-engine/lib/Texture ../webgl-engine/materials/ImageMaterial ../../layers/LayerView ../../layers/RefreshableLayerView".split(" "),
function(l,r,C,D,t,k,F,u,p,S,G,E,m,H,w,I,J,K,L,M,N,O){const x=D.getLogger("esri.views.3d.layers.DynamicLayerView3D");p=function(y){function z(){var a=y.apply(this,arguments)||this;a.drapeSourceType=0;a.updatePolicy=1;a.fullExtentInLocalViewSpatialReference=null;a.maximumDataResolution=null;a._images=[];a._extents=[];a._overlays=[];a.updateWhenStationary=!0;a.refreshDebounced=k.debounce(function(){var c=l._asyncToGenerator(function*(b){yield a.doRefresh(b).catch(e=>{k.isAbortError(e)||D.getLogger(a.declaredClass).error(e)})});
return function(b){return c.apply(this,arguments)}}(),2E3);return a}l._inheritsLoose(z,y);var h=z.prototype;h.initialize=function(){this.addResolvingPromise(I.toViewIfLocal(this).then(a=>this._set("fullExtentInLocalViewSpatialReference",a)));this.updatingHandles.add(this,"suspended",()=>this._suspendedChangeHandler());this.handles.add(this.view.resourceController.scheduler.registerIdleStateCallbacks(()=>{this._isScaleRangeActive()&&this.notifyChange("suspended")},()=>{}));this._isScaleRangeLayer()&&
this.updatingHandles.add(this.layer,"scaleRangeId",()=>this.notifyChange("suspended"))};h.destroy=function(){this.clear()};h.setDrapingExtent=function(a,c){this._spatialReference=c;a.forEach(b=>{this._overlays[b.index]=b;this._updateImageExtent(b)})};h._updateImageExtent=function(a){const c=this._clippedExtent(a.extent,P);if(!t.isNone(c)){var b=w.computeImageExportSize(a.extent,c,a.resolution),e=a.pixelRatio*this.view.pixelRatio;if("imageMaxWidth"in this.layer||"imageMaxHeight"in this.layer){var d=
this.layer.imageMaxWidth,g=this.layer.imageMaxHeight;if(b.width>d){const f=d/b.width;b.height=Math.floor(b.height*f);b.width=d;e*=f}b.height>g&&(d=g/b.height,b.width=Math.floor(b.width*d),b.height=g,e*=d)}g=this._extents[a.index];g&&m.equals(g.extent,c)&&this._imageSizeEquals(c,g.imageSize,b)||(this._extents[a.index]={extent:m.create(c),imageSize:b,pixelRatio:e},this.suspended||this._fetch(a.index).catch(f=>{k.isAbortError(f)||x.error(f)}))}};h.clear=function(){for(let a=0;a<this._images.length;a++)this._clearImage(a)};
h.doRefresh=function(){var a=l._asyncToGenerator(function*(c){if(!this.suspended){var b=[];for(let e=0;e<this._extents.length;e++)this._extents[e]&&b.push(this._fetch(e,c));yield k.eachAlways(b)}});return function(c){return a.apply(this,arguments)}}();h.canResume=function(){if(!y.prototype.canResume.call(this))return!1;if(this._isScaleRangeLayer()){const {minScale:a,maxScale:c}=this.layer;if(0<a||0<c){const b=this.view.scale;if(b<c||0<a&&b>a)return!1}}return!0};h.isUpdating=function(){return this._images.some(a=>
!!a.loadingPromise)};h.processResult=function(){var a=l._asyncToGenerator(function*(c,b,e){if(b instanceof HTMLImageElement||b instanceof HTMLCanvasElement)c.image=b});return function(c,b,e){return a.apply(this,arguments)}}();h.findExtentInfoAt=function(a){for(const c of this._extents){const b=c.extent;if((new E(b[0],b[1],b[2],b[3],this._spatialReference)).contains(a))return c}return null};h.getFetchOptions=function(){};h.redraw=function(){var a=l._asyncToGenerator(function*(c,b){var e=this;yield C.forEach(this._images,
function(){var d=l._asyncToGenerator(function*(g,f){g&&(yield c(g,b),yield e._createStageObjects(f,g.image))});return function(g,f){return d.apply(this,arguments)}}())});return function(c,b){return a.apply(this,arguments)}}();h._imageSizeEquals=function(a,c,b){if(!this.maximumDataResolution||J.TESTS_DISABLE_UPDATE_THRESHOLDS)return!1;const e=m.width(a)/this.maximumDataResolution.x;a=m.height(a)/this.maximumDataResolution.y;a=Math.abs(a/c.height-a/b.height);return 1.5>=Math.abs(e/c.width-e/b.width)&&
1.5>=a};h._fetch=function(){var a=l._asyncToGenerator(function*(c,b){var e=this;if(!this.suspended){var d=this._extents[c],g=d.extent;this._images[c]||(this._images[c]={texture:null,material:null,renderGeometry:null,loadingPromise:null,loadingAbortController:null,image:null,pixelData:null,renderExtent:m.create(g)});var f=this._images[c];f.loadingAbortController&&(f.loadingAbortController.abort(),f.loadingAbortController=null);var n=new E(g[0],g[1],g[2],g[3],this._spatialReference);if(0===n.width||
0===n.height)this._clearImage(c);else{var A=k.createAbortController();f.loadingAbortController=A;k.onAbort(b,()=>A.abort());var B=A.signal,v=this._waitFetchReady(B).then(()=>{const q={requestAsImageElement:!0,pixelRatio:this._overlays[c].pixelRatio,...this.getFetchOptions(),signal:B},{height:Q,width:R}=d.imageSize;return this.layer.fetchImage(n,R,Q,q)}).then(q=>{if(k.isAborted(B))throw x.warnOnce("A call to fetchImage resolved even though the request was aborted. fetchImage should not resolve if options.signal.aborted is true."),
k.createAbortError();return this.processResult(f,q)}).then(()=>m.copy(f.renderExtent,g));f.loadingPromise=v;k.always(v,()=>{v===f.loadingPromise&&(f.loadingPromise=null,f.loadingAbortController=null)});this.notifyChange("updating");yield v.then(l._asyncToGenerator(function*(){yield e._createStageObjects(c,f.image);e.notifyChange("updating")})).catch(q=>{q&&!k.isAbortError(q)&&x.error(q);this.notifyChange("updating");throw q;})}}});return function(c,b){return a.apply(this,arguments)}}();h._clearImage=
function(a){if(a=this._images[a]){t.isSome(a.renderGeometry)&&(this.view.basemapTerrain.overlayManager.renderer.removeGeometries([a.renderGeometry],this,2),a.renderGeometry=null);const c=this.view._stage;c.remove(a.texture);a.texture=null;c.remove(a.material);a.material=null;a.loadingAbortController&&(a.loadingAbortController.abort(),a.loadingAbortController=null);a.loadingPromise=null;a.image=null;a.pixelData=null}};h._createStageObjects=function(){var a=l._asyncToGenerator(function*(c,b){const e=
this.view._stage,d=this._images[c],g=this.view.basemapTerrain.overlayManager.renderer,f=()=>{e.remove(d.texture);d.texture=null;t.isSome(d.renderGeometry)&&(g.removeGeometries([d.renderGeometry],this,2),d.renderGeometry=null)};if(b){b=new L.Texture(b,{width:b.width,height:b.height,preMultiplyAlpha:!0,wrap:{s:33071,t:33071}});yield C.result(this._images[0===c?1:0].loadingPromise);if(0===c)var n=w.createGeometryForExtent(d.renderExtent);else{n=this._images[0].renderExtent;if(!n){f();return}n=w.createOuterImageGeometry(n,
d.renderExtent)}f();e.add(b);d.texture=b;t.isNone(d.material)?(d.material=new M.ImageMaterial({transparent:!0,textureId:b.id}),e.add(d.material)):d.material.setParameterValues({textureId:b.id});d.renderGeometry=new K.RenderGeometry(n,d.material);d.renderGeometry.origin=this._overlays[c].renderLocalOrigin;g.addGeometries([d.renderGeometry],this,2)}else f(),e.remove(d.material),d.material=null});return function(c,b){return a.apply(this,arguments)}}();h._isScaleRangeLayer=function(){return"minScale"in
this.layer&&"maxScale"in this.layer};h._isScaleRangeActive=function(){return this._isScaleRangeLayer()?0<this.layer.minScale||0<this.layer.maxScale:!1};h._clippedExtent=function(a,c){if("local"!==this.view.viewingMode)return m.copy(c,a);const b=this.view.basemapTerrain;return b.ready?m.intersection(a,b.extent,c):m.copy(c,a)};h._suspendedChangeHandler=function(){this.suspended?this.clear():this.refreshDebounced()};h._waitFetchReady=function(){var a=l._asyncToGenerator(function*(c){yield F.whenOnce(this.view,
"stationary",c);k.throwIfAborted(c)});return function(c){return a.apply(this,arguments)}}();return z}(O.RefreshableLayerView(H.LayerView3D(N)));r.__decorate([u.property()],p.prototype,"layer",void 0);r.__decorate([u.property()],p.prototype,"suspended",void 0);r.__decorate([u.property({readOnly:!0})],p.prototype,"fullExtentInLocalViewSpatialReference",void 0);r.__decorate([u.property()],p.prototype,"updating",void 0);p=r.__decorate([G.subclass("esri.views.3d.layers.DynamicLayerView3D")],p);const P=
m.create();return p});