// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.21/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../Camera ../../../core/Logger ../../../core/mathUtils ../../../core/maybe ../../../core/promiseUtils ../../../chunks/vec3 ../../../chunks/vec3f64 ../../../geometry/Point ../../../geometry/projection ../../../geometry/projectionEllipsoid ../../../geometry/SpatialReference ../../../geometry/support/scaleUtils ../camera/intersectionUtils ../../../chunks/cameraUtilsPlanar ../../../chunks/cameraUtilsSpherical ./earthUtils ./ElevationProvider ./mathUtils ../../support/spatialReferenceSupport".split(" "),
function(m,N,H,Y,D,n,Z,z,r,w,p,aa,A,ba,ca,O,P,da,Q,R,ea){function x(a){return"global"===a.viewingMode?P.cameraUtilsSpherical:O.cameraUtilsPlanar}function S(a,b,c){const d=a.state.camera,e=d.width/2/d.pixelRatio;1===a.renderCoordsHelper.viewingMode&&null!=c&&(b*=Math.cos(D.deg2rad(c)));b/=a.renderCoordsHelper.unitInMeters;return e/(96*39.37/b)/Math.tan(d.fovX/2)}function T(a,b,c){const d=a.state.camera;b=96*39.37/(d.width/2/d.pixelRatio/(b*Math.tan(d.fovX/2)));1===a.renderCoordsHelper.viewingMode&&
(b/=Math.cos(D.deg2rad(c)));return b*=a.renderCoordsHelper.unitInMeters}function U(a,b,c,d,e,f){if(B(f)){const h=new I(f.signal);E(a,d.heading,d.tilt,b,c,e,h);h.resolver.promise.then(g=>{g=F(a,g,d.fov);if(n.isNone(g))f.resolver.reject();else return f.resolver.resolve(g)},g=>f.resolver.reject(g))}else return b=E(a,d.heading,d.tilt,b,c,e),F(a,b,d.fov,f)}function V(a,b,c,d,e){return x(a).directionToHeadingTilt(b,c,d,e)}function fa(a,b){return!!(a.basemapTerrain&&a.renderCoordsHelper.fromRenderCoords(b,
y,a.spatialReference)&&n.unwrapOr(Q.getElevationAtPoint(a.elevationProvider,y),0)>y.z-1)}function ha(a,b,c){return J.apply(this,arguments)}function J(){J=N._asyncToGenerator(function*(a,b,c){if(!a.renderCoordsHelper.fromRenderCoords(b,y,a.spatialReference))return!1;a=yield a.elevationProvider.queryElevation(y.x,y.y,y.z,y.spatialReference,"ground",c);return n.unwrapOr(a,0)>y.z-1});return J.apply(this,arguments)}function ia(a,b,c){return K.apply(this,arguments)}function K(){K=N._asyncToGenerator(function*(a,
b,c){const d=r.create();b?b instanceof w?(p.projectPointToVector(b,d,a.renderSpatialReference),null==b.z&&null!=a.basemapTerrain&&(b=yield a.elevationProvider.queryElevation(b.x,b.y,b.z,b.spatialReference,"ground",c),n.isSome(b)&&a.renderCoordsHelper.setAltitude(d,b))):z.copy(d,b):z.copy(d,a.state.camera.center);return d});return K.apply(this,arguments)}function ja(a,b){const c=r.create();b&&b instanceof w?(p.projectPointToVector(b,c,a.renderSpatialReference),null==b.z&&null!=a.basemapTerrain&&(b=
Q.getElevationAtPoint(a.elevationProvider,b),n.isSome(b)&&a.renderCoordsHelper.setAltitude(c,b))):b?z.copy(c,b):z.copy(c,a.state.camera.center);return c}function E(a,b,c,d,e,f,h){const g=d&&d instanceof w?d:null;if(B(h))return ia(a,d,h.signal).then(k=>{L(a,b,c,g,k,e,f,h)},k=>h.resolver.reject(k)),null;d=ja(a,d);return L(a,b,c,g,d,e,f,h)}function L(a,b,c,d,e,f,h,g){if(n.isNone(d)&&(d=p.projectVectorToPoint(e,a.renderSpatialReference,a.spatialReference||A.WGS84),n.isNone(d)))return null;f=Math.max(f,
a.state.constraints.minimumPoiDistance);var k=ka(a,b,c,e,f,h);const t=x(a).eyeForCenterWithHeadingTilt,l=t(e,f,k.heading,k.tilt);if(1===h&&"global"===a.viewingMode&&0<c){const q=()=>{var u=f,v=f;var M=a.state.constraints.tilt(v);v=x(a).eyeTiltToLookAtTilt(c,e,v);v=Math.min(v,.5*Math.PI);M=M.min*(1-.7)+.7*v;u=x(a).lookAtTiltToEyeTilt(M,e,u);h=1>c-u?0:1;return L(a,b,u,d,e,f,h,g)};k=a.map.ground.navigationConstraint;if(!k||"stay-above"===k.type){if(fa(a,l.eye))return q();if(B(g))return ha(a,l.eye,g.signal).then(u=>
{if(u)return q();g.resolver.resolve({eye:l.eye,up:l.up,center:r.clone(e),heading:l.heading,tilt:l.tilt});return null}),null}}k=!g||B(g)?{center:r.create(),eye:r.create(),up:r.create(),tilt:0,heading:0}:g;k.eye=l.eye;k.up=l.up;k.center=r.clone(e);k.heading=l.heading;k.tilt=l.tilt;B(g)&&g.resolver.resolve(k);return k}function ka(a,b,c,d,e,f){var h=0;if(f=1===f)if(h=a.pointsOfInterest.centerOnSurfaceFrequent.distance,8<Math.log(e/h)/Math.LN2)f=!0;else{var g=a.renderSpatialReference,k=a.spatialReference||
A.WGS84;f=p.projectVectorToPoint(d,g,k);g=p.projectVectorToPoint(a.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,g,k);n.isNone(f)||n.isNone(g)?f=!1:(h*=Math.tan(.5*a.state.camera.fov),f=5<g.distance(f)/h)}f?(b=0,f=a.state.constraints.tilt(e),f.max=Math.min(f.max,.5*Math.PI),f=f.min*(1-.7)+.7*f.max,c=x(a).eyeTiltToLookAtTilt(c,d,e),h=Math.min(c,f)):h=x(a).eyeTiltToLookAtTilt(c,d,e);c=h=a.state.constraints.clampTilt(e,h);c=x(a).lookAtTiltToEyeTilt(c,d,e);return{heading:b,tilt:c}}function F(a,
b,c,d){if(n.isNone(b))return null;a=p.projectVectorToPoint(b.eye,a.renderSpatialReference,a.spatialReference||A.WGS84);return n.isNone(a)?null:n.isSome(d)?(d.position=a,d.heading=b.heading,d.tilt=b.tilt,d.fov=c,d):new H(a,b.heading,b.tilt,c)}function B(a){return a&&"resolver"in a}const W=Y.getLogger("esri.views.3d.support.cameraUtils"),X=r.create(),G=r.create(),la={heading:0,tilt:0},y=new w,ma=new R.Cyclical(-2.0037508342788905E7,2.0037508342788905E7),na=new R.Cyclical(-180,180),C=r.create();let I=
function(a){this.signal=a;this.resolver=Z.createResolver()};m.AsyncContext=I;m.computeScale=function(a,b,c){const d=a.renderSpatialReference;b||(b=a.state.camera);var e=A.WGS84;b instanceof H?(e=b.position.latitude,p.projectPointToVector(b.position,X,d),p.projectPointToVector(c,G,d),b=z.distance(X,G)):(p.projectVectorToVector(b.center,d,G,e),e=G[1],b=b.distance);return T(a,b,e)};m.directionToHeadingTilt=V;m.distanceToScale=T;m.externalToInternal=function(a,b){if(n.isNone(b))return null;var c=a.renderSpatialReference;
const d=x(a).headingTiltToDirectionUp,e=r.create();if(!p.projectPointToVector(b.position,e,c))return null;c=d(e,b.heading,b.tilt);z.scale(c.direction,c.direction,a.state.camera.distance);z.add(c.direction,c.direction,e);a=ca.cameraOnContentAlongViewDirection(a,e,c.direction,c.up);a.fov=D.deg2rad(b.fov);return a};m.fromCenterDistance=U;m.fromCenterScale=function(a,b,c,d,e,f){c=S(a,c,b.latitude);return U(a,b,c,d,e,f)};m.fromExtent=function(a,b,c,d,e,f=null){var h=null!=b.zmax&&null!=b.zmin;let g;if("global"===
a.viewingMode){if(!ea.isSpatialReferenceSupported(b.spatialReference,"global"))return B(f)&&f.resolver.reject(),null;var k=new w(b.xmin,b.ymin,b.spatialReference);const q=new w(b.xmax,b.ymax,b.spatialReference),u=b.spatialReference.isGeographic?na:ma;var t=new w({x:u.center(k.x,q.x),y:(q.y+k.y)/2,z:h?(b.zmax+b.zmin)/2:null,spatialReference:b.spatialReference});const v=aa.getReferenceEllipsoid(b.spatialReference);var l=da.getGreatCircleSpanAt(t,k,q);g=l.lon;l=l.lat;u.diff(k.x,q.x)>u.range/2&&(g+=v.halfCircumference);
g=Math.min(g,v.halfCircumference);l=Math.min(l,v.halfCircumference)}else t=n.unwrapOr(a.renderSpatialReference,b.spatialReference),t.equals(b.spatialReference)||(b=p.project(b,t)),g=b.xmax-b.xmin,l=b.ymax-b.ymin,t=new w({x:b.xmin+.5*g,y:b.ymin+.5*l,z:h?(b.zmax+b.zmin)/2:null,spatialReference:t});k=a.state.camera;b=Math.max(1/Math.tan(k.fovX/2)*g*.5,1/Math.tan(k.fovY/2)*l*.5,1/Math.tan(k.fov/2)*(h?b.zmax-b.zmin:0)*.5)/1;if(B(f))h=new I(f.signal),E(a,c,d,t,b,e,h),h.resolver.promise.then(q=>{q=F(a,q,
a.camera.fov);if(n.isNone(q))f.resolver.reject();else return f.resolver.resolve(q)},q=>f.resolver.reject(q));else return c=E(a,c,d,t,b,e),F(a,c,a.camera.fov,f)};m.getObserverForPointAtDistance=E;m.headingTiltToDirectionUp=function(a,b,c,d,e){return x(a).headingTiltToDirectionUp(b,c,d,e)};m.internalToExternal=function(a,b,c){const d=a.renderSpatialReference,e=V(a,b.eye,b.viewForward,b.up,la);a=a.spatialReference||A.WGS84;p.projectVectorToVector(b.eye,d,C,a)||(a=A.WGS84,p.projectVectorToVector(b.eye,
d,C,a));if(n.isNone(c))return new H(new w(C,a),e.heading,e.tilt,D.rad2deg(b.fov));c.position.x=C[0];c.position.y=C[1];c.position.z=C[2];c.position.spatialReference=a;c.heading=e.heading;c.tilt=e.tilt;c.fov=D.rad2deg(b.fov);return c};m.observerToCamera=F;m.scaleToDistance=S;m.scaleToResolution=function(a,b){return a.spatialReference?ba.getResolutionForScale(b,a.spatialReference):void 0};m.scaleToZoom=function(a,b){var c;if(a=null==(c=a.basemapTerrain)?void 0:c.tilingScheme)return a.levelAtScale(b);
W.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")};m.toExtent=function(a,b,c){const d=p.projectVectorToPoint(c,a.renderSpatialReference,a.spatialReference||A.WGS84);if(n.isNone(d))return null;var e=Math.tan(b.fovX/2),f=Math.tan(b.fovY/2);b=z.dist(b.eye,c);e*=2*b;f*=2*b;return"global"===a.viewingMode?P.toExtent(a,d,e,f):O.toExtent(a,d,e,f)};m.zoomToScale=function(a,b){var c;if(a=null==(c=a.basemapTerrain)?void 0:c.tilingScheme)return a.scaleAtLevel(b);W.error("#zoomToScale()",
"Cannot compute scale from zoom without a tiling scheme")};Object.defineProperty(m,"__esModule",{value:!0})});