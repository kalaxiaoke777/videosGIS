// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.21/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/Logger ../../../../../core/maybe ../../../../../core/PooledArray ../../../../../chunks/mat3 ../../../../../chunks/mat3f32 ../../../../../chunks/vec3 ../../../../../chunks/vec3f64 ../../../../../chunks/vec4 ../../../../../chunks/vec4f32 ../../../layers/support/symbolColorUtils ../../../support/orientedBoundingBox ../../../support/buffer/glUtil ../../../support/buffer/InterleavedLayout ./ComponentData ./ComponentObject ./interface ./IntersectionGeometry ./Renderable ./RenderGeometry ./RenderSubmitSystem ./SourceGeometry ./Material/ComponentMaterial ./Material/ComponentTechnique ../../core/util/TwoVectorPosition ../../lib/ComponentUtils ../../lib/Util ../../lib/TextureBackedBuffer/BufferManager ../../../../webgl/BufferObject ../../../../webgl/VertexArrayObject".split(" "),
function(C,L,z,n,D,t,E,q,F,M,N,O,G,H,P,Q,R,S,T,U,V,W,X,w,Y,Z,I,aa,ba,A,ca){const J=z.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");z=function(){function B(a){this._renderManager=a;this._objects=[new D,new D];this._renderSubmit=new W.RenderSubmitSystem(this);this._renderManager.register(this._renderSubmit);this._componentBufferManager=new ba.BufferManager(a.rctx)}var e=B.prototype;e.dispose=function(){aa.assert(0===this._objects[0].length&&0===this._objects[1].length,
"ObjectCollection should be empty upon disposal");this._componentBufferManager.destroy()};e.createObject=function(a){const b=new R.ComponentObject;b.toMapSpace=a.toMapSpace.slice();b.transform=a.transform;b.obb=G.clone(a.obb);b.components=new Q(this._componentBufferManager,a.geometry.componentOffsets);b.renderable=this._createRenderable(a,b.components);b.intersectionGeometry=new T(a.geometry.positionData,b.components);this._objects[b.visible].push(b);return b};e.destroyObject=function(a){this._objects[a.visible].removeUnordered(a);
a.dispose();this._notifyDirty()};e.setObjectVisibility=function(a,b){b!==a.visible&&(this._objects[a.visible].removeUnordered(a),this._objects[b].push(a),a.visible=b,this._notifyDirty())};e.preSubmit=function(a){const b=a.camera.eye;this.visibleObjects.forAll(c=>{const d=q.squaredDistance(b,c.obb.center);c.renderable.meta.cameraDepthSquared=d})};e.getMaterial=function(a){return a.renderable.material};e.updateMaterial=function(a,b){a=a.renderable.material;b(a);a.dirty&&this._notifyDirty()};e.setAllComponentVisibilities=
function(a,b){a.components.visibility.reset(b);a.components.visibilityDirty();this._notifyDirty()};e.forEachVisibleComponent=function(a,b){return a.components.visibility.forEachComponent(b)};e.getComponentCount=function(a){const b=a.components.visibility.componentCount();return{visible:b,invisible:a.components.count-b}};e.setComponentData=function(a,b){const c=a.renderable.material;if(S.isVaryingComponentParameters(b)){a=a.components;var d=a.materialDataBuffer;const k=a.materialDataIndices,f={castShadows:!0,
pickable:!0,externalColor:N.create(),externalColorMixMode:1};d=d.textureBuffer;const g=new Uint8Array(4),u=new Uint32Array(g.buffer);let l=0,h=0,m=0,p=!1,v=0;for(let r=0;r<a.count;r++)b(r,f),l+=+(1>f.externalColor[3]),h+=+(3===f.externalColorMixMode&&1===f.externalColor[3]),m+=+f.castShadows,O.encodeSymbolColor(f.externalColor,f.externalColorMixMode,g),g[2]=g[2]&254|+f.castShadows,d.setData(k[r],0,g[0],g[1],g[2],g[3]),p=p||0<r&&v!==u[0],v=u[0],f.pickable!==I.getVisibility(a.pickability,r)&&(a.pickability=
I.updateVisibilityWithCount(a.pickability,a.count,r,f.pickable));p?(c.componentParameters=new w.ComponentParametersVarying,c.componentParameters.castShadows=m===a.count?0:0===m?2:1,c.componentParameters.transparent=l===a.count?0:0===l?2:1,c.componentParameters.opaqueOverride=h===a.count?0:0===h?2:1,c.componentParameters.texture=d,d.updateTexture()):(c.componentParameters=new w.ComponentParametersUniform,c.componentParameters.castShadows=f.castShadows?0:2,c.componentParameters.externalColor=f.externalColor,
c.componentParameters.externalColorMixMode=f.externalColorMixMode)}else c.componentParameters=new w.ComponentParametersUniform,c.componentParameters.castShadows=b.castShadows?0:2,c.componentParameters.externalColor=b.externalColor,c.componentParameters.externalColorMixMode=b.externalColorMixMode;this._notifyDirty()};e.getComponentAabb=function(a,b,c){return a.intersectionGeometry.getComponentAabb(b,c)};e.getComponentObb=function(a){return a.obb};e.getObjectTransform=function(a){return a.transform};
e.getComponentPositions=function(a,b,c){return a.intersectionGeometry.getComponentPositions(b,c)};e.intersect=function(a,b,c,d,k,f){n.isSome(k)&&(k.localOrigin=a.transform.position);const g=t.invert(K,a.transform.rotationScale);q.sub(x,b,a.transform.position);q.sub(y,c,a.transform.position);q.transformMat3(x,x,g);q.transformMat3(y,y,g);b=t.transpose(K,g);return a.intersectionGeometry.intersect(x,y,d,b,k,f)};e.addEdges=function(a,b,c,d){const {indices:k,positions:f}=a.intersectionGeometry,g=a.components.offsets;
return b.addComponentObject(a,a.transform,{center:a.obb.center,radius:G.radius(a.obb)},f,k,g,c,d)};e.addComponentHighlight=function(a,b){a=a.components;n.isNone(a.highlightCounts)&&(a.highlightCounts=new Uint32Array(a.count+1));0===a.highlightCounts[b]++&&(a.highlightsDirty(),this._notifyDirty());a.highlightCounts[a.count]++};e.removeComponentHighlight=function(a,b){a=a.components;if(n.isNone(a.highlightCounts))J.warn("Removing non-existing highlight.");else{var c=a.highlightCounts[b],d=a.highlightCounts[a.count];
0===c?J.warn("Removing non-existing highlight."):1<c?(a.highlightCounts[b]=c-1,a.highlightCounts[a.count]=d-1):(a.highlightCounts[b]=0,a.highlightsDirty(),this._notifyDirty(),1===d?a.highlightCounts=null:a.highlightCounts[a.count]=d-1)}};e.clearHighlights=function(a){a=a.components;n.isSome(a.highlightCounts)&&(a.highlightCounts=null,a.highlightsDirty(),this._notifyDirty())};e.getObjectGPUMemoryUsage=function(a){return a.renderable.meta.gpuMemoryEstimate};e._createRenderable=function(a,b){const c=
this._renderManager.rctx;var d=a.geometry,k=d.vertices.layoutParameters,f=A.createVertex(c,35044,d.vertices.data);const g=n.applySome(d.indices,p=>A.createIndex(c,35044,p));var u=H.glLayout(X.createVertexBufferLayout(k)),l=new Uint16Array(d.vertices.count);for(var h=0;h<b.count;h++){var m=b.offsets[h];const p=b.offsets[h+1],v=b.materialDataIndices[h];if(n.isSome(d.indices))for(;m<p;m++)l[d.indices[m]]=v;else for(;m<p;m++)l[m]=v}d=A.createVertex(c,35044,l.buffer);l=new Z.TwoVectorPosition(a.transform.position);
h=E.clone(a.transform.rotationScale);t.invert(h,h);t.transpose(h,h);b=new Y.ComponentDrawParameters;q.copy(b.worldFromModel_TL,l.low);q.copy(b.worldFromModel_TH,l.high);t.copy(b.worldFromModel_RS,a.transform.rotationScale);t.copy(b.transformNormal_GlobalFromModel,h);M.copy(b.toMapSpace,a.toMapSpace);a=new w.ComponentMaterial;u=new ca(c,a.attributeLocations,{data:u,componentIndices:da},{data:f,componentIndices:d},n.unwrap(g));k=new V.RenderGeometry(u,4,k,n.isSome(g));f={cameraDepthSquared:.5,gpuMemoryEstimate:f.byteSize+
d.byteSize+(n.isSome(g)?g.byteSize:0)};return new U.Renderable(a,b,k,f)};e._notifyDirty=function(){this._renderManager.notifyDirty()};L._createClass(B,[{key:"visibleObjects",get:function(){return this._objects[1]}}]);return B}();const da=H.glLayout(P.newLayout().u16("componentIndex")),K=E.create(),x=F.create(),y=F.create();C.ComponentObjectCollection=z;Object.defineProperty(C,"__esModule",{value:!0})});