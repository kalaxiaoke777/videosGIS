// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.21/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/Evented ../../../../core/has ../../../../core/Logger ../../../../core/maybe ../../../../core/scheduling ../../../../core/time ../../../../core/watchUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../support/animationUtils ../collections/Component/ComponentObjectCollection ../core/shaderTechnique/ShaderTechniqueRepository ../lib/AutoDisposable ../lib/CompositingHelper ../lib/depthRangeUtils ../lib/GLMaterialRep ../lib/MagnifierHelper ../lib/Renderer ../lib/TextureRepository ../lib/WebGLDriverTest ../materials/StippleTextureRepository ../materials/internal/WaterTextureRepository ./requireUtils ./ScreenshotManager ../../../webgl/context-util ../../../webgl/RenderingContext".split(" "),
function(e,q,g,x,y,u,z,m,A,B,C,n,S,D,E,F,G,h,H,I,J,K,L,M,v,N,O,P,Q,r,R){const w=z.getLogger("esri.views.3d.webgl-engine.parts.View");e.RenderView=function(t){function p(b){var a=t.call(this,{})||this;a.events=new y;a.waterTextureRepository=new O.WaterTextureRepository;a._magnifierHelper=new K.MagnifierHelper;a._componentObjectCollection=null;a._needsUpdate=!0;a._needsRender=!0;a._idleSuspend=!0;a._needsWaterReflectionUpdate=!1;a._logicUpdateLast=0;a._container=b.container;a._initializeContext(b.options);
C.init(a.waterTextureRepository,"loadingState",()=>a.setNeedsRender());a._magnifierHelper.events.on("request-render",()=>a.setNeedsRender());a._stippleTextureRepository=new N.StippleTextureRepository(a._rctx);a._shaderTechniqueRepository=new G.ShaderTechniqueRepository({rctx:a._rctx,viewingMode:b.viewingMode,stippleTextureRepository:a._stippleTextureRepository,waterTextureRepository:a.waterTextureRepository});a._textureRepository=new M.TextureRepository(b,a._shaderTechniqueRepository,a._rctx);a._textureRepository.events.on("changed",
c=>a.setNeedsRender(c));a._materialRepository=new J(a._textureRepository,a._shaderTechniqueRepository,()=>a.setNeedsRender());a._compositingHelper=new H(a._rctx,a._shaderTechniqueRepository);a._renderer=new L(a._materialRepository,a._textureRepository,a._shaderTechniqueRepository,a._rctx,a._compositingHelper,a._magnifierHelper,(c=1)=>a.setNeedsRender(c),(c,d)=>b.schedule(c,d),b);a._screenshotManager=new Q.ScreenshotManager(a._rctx,(c,d,k)=>a._renderer.render(c,d,d,k),()=>a.setNeedsRender(),b.options.screenshot.renderOverlay,
c=>a.events.emit("force-camera-for-screenshot",c));a._registerFrameTask(b);return a}q._inheritsLoose(p,t);var f=p.prototype;f.normalizeCtorArgs=function(){return{}};f.dispose=function(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas);this._frameTask&&(this._frameTask.remove(),this._frameTask=null);this._shaderTechniqueRepository.dispose();this._shaderTechniqueRepository=null;v.clearTestWebGLDriver(this._rctx);t.prototype.dispose.call(this);this._rctx=this._tmpDepthBuffer=
null};f.setNeedsRender=function(b=1){1===b?this._needsUpdate||(this._needsUpdate=!0,this.notifyChange("updating")):this._needsRender=!0};f.evaluateUpdating=function(){return this.needsUpdate||this._needsWaterReflectionUpdate||this._renderer.updating||this._textureRepository.updating||this.waterTextureRepository.updating||this._magnifierHelper.updating};f.ensureEdgeView=function(){return this._renderer.ensureEdgeView()};f.updateLightSources=function(b,a,c){this._renderer.updateLightSources(b,a,c);
this.setNeedsRender()};f.setRenderParameters=function(b){void 0!==b.idleSuspend&&this._idleSuspend!==!!b.idleSuspend&&(this._idleSuspend=!!b.idleSuspend,this.setNeedsRender());this._renderer.setRenderParameters(b)};f.modify=function(b){this._renderer.modify(b);b.clear()};f.takeScreenshot=function(b){return this._screenshotManager.takeScreenshot(b)};f.readAccumulatedShadow=function(b){return this._renderer.readAccumulatedShadow(b[0],b[1])};f.getMinimalDepthForArea=function(b,a,c,d,k=d){b=c.constrainWindowSize(b,
a,d*c.pixelRatio,k*c.pixelRatio);a=this._ensureDepthBuffer(b);this._renderer.readDepthPixels(c,b[0],b[1],b[2],b[3],a);d=Number.MAX_VALUE;for(k=0;k<b[2]*b[3];k++){const l=I.textureToDepth(4*k,a,c.nearFar);d>l&&l!==c.nearFar[0]&&l!==c.nearFar[1]&&(d=l)}return d===Number.MAX_VALUE?void 0:d};f._ensureDepthBuffer=function(b){b=4*b[2]*b[3];if(m.isNone(this._tmpDepthBuffer)||this._tmpDepthBuffer.byteLength<b)this._tmpDepthBuffer=new Uint8Array(b);return this._tmpDepthBuffer};f.getGpuMemoryUsage=function(){return this._renderer.getGpuMemoryUsage()};
f.hotReloadShaders=function(){var b=q._asyncToGenerator(function*(){P.removeLoadedShaderModules();yield this._shaderTechniqueRepository.hotReload();this.setNeedsRender()});return function(){return b.apply(this,arguments)}}();f._registerFrameTask=function(b){const a=b.state,c={viewCamera:a.camera,frameHasDecorations:!1};let d=!1;this._frameTask=A.addFrameTask({preRender:k=>{d=this.evaluateUpdating();b.processSyncLayers();var l=B.Milliseconds(k.time-this._logicUpdateLast);if(l>E.DESIRED_ANIMATION_MS||
m.isSome(this.forcedAnimationTime))l={camera:a.camera,dt:l,forcedTime:this.forcedAnimationTime},this._logicUpdateLast=k.time,this._renderer.updateLogic(l)&&this.setNeedsRender(0)},render:()=>{if((this.needsUpdate||this._needsRender||!this._idleSuspend||!this._renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&0<a.camera.fullWidth&&0<a.camera.fullHeight){const k=this._needsUpdate&&this._idleSuspend&&this._renderer.isCameraFinal;this._needsWaterReflectionUpdate=this._needsUpdate=this._needsRender=
!1;this._renderer.render(null,a.camera,a.contentCamera,!1);k&&this._renderer.hasWaterReflection&&(this.setNeedsRender(0),this._needsWaterReflectionUpdate=!0)}},postRender:()=>{d===this.updating&&d===this.evaluateUpdating()||this.notifyChange("updating")},update:()=>{c.viewCamera=a.camera;c.frameHasDecorations=this._renderer.hasSlicePlane||this._magnifierHelper.enabled;this._textureRepository.update();this._screenshotManager.update(c)}})};f._initializeContext=function(b){this._canvas=b.canvas;this._canvas||
(this._canvas=document.createElement("canvas"));this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");const a={alpha:b.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:null==b.stencil?!0:b.stencil,powerPreference:"high-performance"};let c;const d=u("esri-force-webgl");d?c=r.createContextOrErrorHTML(this._canvas,d,a):(c=r.createContext(this._canvas,2,a),m.isNone(c)&&(c=r.createContextOrErrorHTML(this._canvas,1,a)));m.isNone(c)?w.error("A WebGL context with the requested version ("+
d?d:"automatic) could not be created."):(this._rctx=new R(c,{disabledExtensions:b.deactivatedWebGLExtensions||{},debugWebGLExtensions:b.debugWebGLExtensions||{},maxAnisotropy:8}),v.testWebGLDriver(this._rctx),this._loadShaderOnlyExtensions(),!b.alpha&&this._rctx.contextAttributes.alpha&&w.error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&11<=u("safari")&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas))};
f._loadShaderOnlyExtensions=function(){this._rctx.capabilities.enable("standardDerivatives");this._rctx.capabilities.enable("shaderTextureLOD");this._rctx.capabilities.enable("textureFloat")};q._createClass(p,[{key:"performanceInfo",get:function(){const b=this._rctx.gl;return{renderer:this._renderer.performanceInfo,textureMemory:void 0!==b.getUsedTextureMemory?b.getUsedTextureMemory():void 0,renderbufferMemory:void 0!==b.getUsedRenderbufferMemory?b.getUsedRenderbufferMemory():void 0,VBOMemory:void 0!==
b.getUsedVBOMemory?b.getUsedVBOMemory():void 0}}},{key:"needsUpdate",get:function(){return this._needsUpdate}},{key:"updating",get:function(){return this.evaluateUpdating()}},{key:"edgeView",get:function(){return this._renderer.edgeView}},{key:"textureRepository",get:function(){return this._textureRepository}},{key:"compositingHelper",get:function(){return this._compositingHelper}},{key:"magnifier",set:function(b){this._magnifierHelper.magnifier=b}},{key:"renderingContext",get:function(){return this._rctx}},
{key:"capabilities",get:function(){return this._rctx.capabilities}},{key:"canvas",get:function(){return this._canvas}},{key:"hasShadowsEnabled",get:function(){return this._renderer.hasShadowsEnabled}},{key:"renderPlugins",get:function(){return this._renderer.renderPlugins}},{key:"test",get:function(){return{renderer:this._renderer}}},{key:"componentObjectCollection",get:function(){m.isNone(this._componentObjectCollection)&&(this._componentObjectCollection=new F.ComponentObjectCollection(this._renderer.renderPassManager));
return this._componentObjectCollection},set:function(b){this._componentObjectCollection=b}}]);return p}(h.AutoDisposableMixin(x));g.__decorate([n.property({type:Boolean,readOnly:!0})],e.RenderView.prototype,"updating",null);g.__decorate([h.autoDispose()],e.RenderView.prototype,"_rctx",void 0);g.__decorate([h.autoDispose()],e.RenderView.prototype,"_container",void 0);g.__decorate([h.autoDispose()],e.RenderView.prototype,"_canvas",void 0);g.__decorate([h.autoDispose()],e.RenderView.prototype,"_stippleTextureRepository",
void 0);g.__decorate([h.autoDispose(),n.property()],e.RenderView.prototype,"waterTextureRepository",void 0);g.__decorate([h.autoDispose(),n.property()],e.RenderView.prototype,"_magnifierHelper",void 0);g.__decorate([h.autoDispose(),n.property()],e.RenderView.prototype,"_textureRepository",void 0);g.__decorate([h.autoDispose()],e.RenderView.prototype,"_compositingHelper",void 0);g.__decorate([h.autoDispose()],e.RenderView.prototype,"_renderer",void 0);g.__decorate([h.autoDispose()],e.RenderView.prototype,
"_screenshotManager",void 0);g.__decorate([h.autoDispose()],e.RenderView.prototype,"componentObjectCollection",null);g.__decorate([h.autoDispose()],e.RenderView.prototype,"_componentObjectCollection",void 0);e.RenderView=g.__decorate([D.subclass("esri.views.3d.webgl-engine.parts.RenderView")],e.RenderView);Object.defineProperty(e,"__esModule",{value:!0})});