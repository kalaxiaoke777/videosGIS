// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.21/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/MapUtils ../../../../core/PooledArray ../../../../core/accessorSupport/decorators/property ../../../../core/has ../../../../core/accessorSupport/ensureType ../../../../core/Logger ../../../../core/accessorSupport/decorators/subclass ./ChangeSet ./Material ./rendererUtils ../materials/renderers/MergedRenderer".split(" "),function(g,n,l,r,p,t,q,C,D,E,u,v,w,x,y){g.SortedRenderGeometryRenderer=
function(k){function h(){var a=k.apply(this,arguments)||this;a._pending=new z;a._changes=new v.ChangeSet;a._materialRenderers=new Map;a._sortedMaterialRenderers=new t;a._hasHighlights=!1;a._hasWater=!1;return a}n._inheritsLoose(h,k);var e=h.prototype;e.dispose=function(){this._changes.prune();this._materialRenderers.forEach(a=>a.dispose());this._materialRenderers.clear();this._sortedMaterialRenderers.clear()};e.commitChanges=function(){if(!this.updating)return!1;this._processAddsRemoves();let a=!1,
c=!1,b=!1;x.splitRenderGeometryChangeSetByMaterial(this._changes).forEach((d,m)=>{let f=this._materialRenderers.get(m);!f&&0<d.adds.length&&(f=new y(this.rctx,this.materialRepository,m),this._materialRenderers.set(m,f),b=c=a=!0);if(f){var A=c||f.hasHighlights,B=b||f.hasWater;f.modify(d);c=c||A!==f.hasHighlights;b=b||B!==f.hasWater;f.isEmpty&&(this._materialRenderers.delete(m),f.dispose(),a=!0)}});this._changes.clear();a&&this.updateSortedMaterialRenderers();c&&(this._hasHighlights=p.someMap(this._materialRenderers,
d=>d.hasHighlights));b&&(this._hasWater=p.someMap(this._materialRenderers,d=>d.hasWater));this.notifyChange("updating");return!0};e.add=function(a){if(0!==a.length){var c=this._pending.empty;for(const b of a)this._pending.adds.add(b);c&&this.notifyChange("updating")}};e.remove=function(a){const c=this._pending.empty;for(const b of a)this._pending.adds.has(b)?(this._pending.removed.add(b),this._pending.adds.delete(b)):this._pending.removed.has(b)||this._pending.removes.add(b);c&&!this._pending.empty&&
this.notifyChange("updating")};e.modify=function(a,c){const b=0===this._changes.updates.length;for(const d of a)a=this._changes.updates.pushNew(),a.renderGeometry=d,a.updateType=c;b&&0<this._changes.updates.length&&this.notifyChange("updating")};e.updateLogic=function(a){let c=!1;this._sortedMaterialRenderers.forAll(({materialRenderer:b})=>c=b.updateLogic(a)||c);return c};e.render=function(a,c){for(let b=0;b<this._sortedMaterialRenderers.length;b++){const d=this._sortedMaterialRenderers.data[b];w.materialPredicate(d.material,
a)&&d.materialRenderer.render(c.slot,a.pass,c,null)}};e.updateSortedMaterialRenderers=function(){this._sortedMaterialRenderers.clear();let a=0;this._materialRenderers.forEach((c,b)=>{b.insertOrder=a++;this._sortedMaterialRenderers.push({material:b,materialRenderer:c})});this._sortedMaterialRenderers.sort((c,b)=>{const d=b.material.renderPriority-c.material.renderPriority;return 0!==d?d:c.material.insertOrder-b.material.insertOrder})};e._processAddsRemoves=function(){this._changes.adds.clear();this._changes.removes.clear();
this._changes.adds.pushArray(Array.from(this._pending.adds));this._changes.removes.pushArray(Array.from(this._pending.removes));for(let a=0;a<this._changes.updates.length;)this._pending.has(this._changes.updates.data[a].renderGeometry)?this._changes.updates.removeUnorderedIndex(a):a++;this._pending.clear()};n._createClass(h,[{key:"updating",get:function(){return!this._pending.empty||0<this._changes.updates.length}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasWater",get:function(){return this._hasWater}},
{key:"rendersOccluded",get:function(){return p.someMap(this._materialRenderers,a=>a.rendersOccluded)}},{key:"isEmpty",get:function(){return!this.updating&&0===this._materialRenderers.size}},{key:"test",get:function(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}}]);return h}(r);l.__decorate([q.property()],g.SortedRenderGeometryRenderer.prototype,"rctx",void 0);l.__decorate([q.property()],g.SortedRenderGeometryRenderer.prototype,"materialRepository",void 0);l.__decorate([q.property()],
g.SortedRenderGeometryRenderer.prototype,"updating",null);g.SortedRenderGeometryRenderer=l.__decorate([u.subclass("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],g.SortedRenderGeometryRenderer);let z=function(){function k(){this.adds=new Set;this.removes=new Set;this.removed=new Set}var h=k.prototype;h.has=function(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)};h.clear=function(){this.adds.clear();this.removes.clear();this.removed.clear()};n._createClass(k,[{key:"empty",
get:function(){return 0===this.adds.size&&0===this.removes.size&&0===this.removed.size}}]);return k}();Object.defineProperty(g,"__esModule",{value:!0})});