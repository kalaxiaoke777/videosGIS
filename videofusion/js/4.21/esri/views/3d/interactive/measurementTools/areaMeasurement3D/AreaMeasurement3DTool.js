// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.21/esri/copyright.txt for details.
//>>built
define("../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../core/Handles ../../../../../core/Logger ../../../../../core/maybe ../../../../../core/accessorSupport/decorators/property ../../../../../core/has ../../../../../core/accessorSupport/ensureType ../../../../../core/accessorSupport/decorators/subclass ../../../../../core/accessorSupport/trackingUtils ../../../../../layers/graphics/hydratedFeatures ../../editingTools/dragEventPipeline3D ./AreaMeasurement3DModel ./AreaMeasurement3DView ../support/measurementUtils ../../../../interactive/dragEventPipeline ../../../../interactive/InteractiveToolBase ../../../../support/screenUtils".split(" "),
function(q,g,C,e,k,h,M,N,D,E,r,F,G,t,u,H,I,v){const w=e.getLogger("esri.views.3d.interactive.measurementTools.areaMeasurement3D.AreaMeasurement3DTool");e=function(x){function m(a){var b=x.call(this,a)||this;b._handles=new C;b._tempPickRequest=new t.PickRequest;b.model=new G.AreaMeasurement3DModel({sceneView:a.view});b.measurementView=new t({model:b.model,unit:a.unit,manipulators:b.manipulators});return b}q._inheritsLoose(m,x);var c=m.prototype;c.initialize=function(){this.measurementView.when().then(()=>
this._initialize())};c._initialize=function(){this.destroyed?w.error("Calling _initialized() on destroyed AreaMeasurement3DTool."):(this._setupManipulators(),this.visible&&this.measurementView.show(),this._handles.add(E.reaction(()=>this.state,a=>{"measured"===a?this.complete():this.finishToolCreation()})),"measured"===this.state?this.complete():this.startToolCreation())};c.destroy=function(){this.attached&&this.detach();this.measurementView.destroy();this._set("measurementView",null);this.model.destroy();
this._set("model",null);this._handles=k.destroyMaybe(this._handles)};c.onActivate=function(){this.model.active=!0};c.onDeactivate=function(){this.model.active=!1};c.onShow=function(){this.created&&this.measurementView.show()};c.onHide=function(){this.created&&this.measurementView.hide()};c.onDetach=function(){switch(this.toolState){case "created":case "creating":this.measurementView.path&&this.measurementView.path.clear(),this.measurementView.cursorPoint=null,this.model.state="initial"}};c.onInputEvent=
function(a){switch(a.type){case "immediate-double-click":this._handleImmediateDoubleClick(a);break;case "immediate-click":this._handleImmediateClick(a);break;case "pointer-move":this._handlePointerMove(a);break;case "drag":this._handleDrag(a);break;case "key-down":this._handleKeyDown(a)}};c._setupManipulators=function(){let a=0;const b=d=>f=>{"start"===f.action&&(a++,this.measurementView.lastDraggedVertex=k.unwrap(this.measurementView.manipulatorToVertex(d)),"measured"===this.model.state&&(this.model.state=
"editing"));return f},n=()=>d=>"end"===d.action?(a--,0===a&&"editing"===this.model.state&&(this.model.state="measured"),null):d,B=(d,f)=>{this._handles.add([H.createManipulatorDragEventPipeline(f,(l,J,K)=>{const y=F.hideManipulatorWhileDragging(l),p=k.unwrap(this.measurementView.manipulatorToVertex(l));J.next(b(l)).next(y).next(n()).next(this.measurementView.screenToMap3D()).next(z=>{l.location=z.mapEnd;this.measurementView.path.setVertexPosition(p,r.clonePoint(z.mapEnd))});const A=r.clonePoint(this.measurementView.path.getVertexPositionAsPoint(p));
K.next(y).next(()=>{this.measurementView.path.setVertexPosition(p,A);l.location=A})})],`manipulator-${d}`)},L=d=>{this._handles.remove(`manipulator-${d}`)};this.manipulators.forEach(({id:d,manipulator:f})=>{B(d,f)});this._handles.add([this.manipulators.on("after-add",({item:{id:d,manipulator:f}})=>{B(d,f)}),this.manipulators.on("after-remove",({item:{id:d}})=>{L(d)})])};c._handleImmediateDoubleClick=function(a){u.isPrimaryPointerAction(a)&&("drawing"===this.model.state&&this.measurementView.finishMeasurement(),
a.stopPropagation())};c._handleDrag=function(a){"editing"===this.model.state&&a.stopPropagation()};c._handleImmediateClick=function(a){if(u.isPrimaryPointerAction(a)){var b=v.createScreenPointFromEvent(a);if(this.model.active)switch(this.model.state){case "initial":if(this._addVertexAt(b)){this.measurementView.cursorPoint=null;this.model.state="drawing";a.stopPropagation();return}break;case "drawing":{const n=this.measurementView.vertexHandleAt(b,a.pointerType);if(k.isNone(n)){if(this._addVertexAt(b)){this.measurementView.cursorPoint=
null;a.stopPropagation();return}}else 0===n.index&&(this.measurementView.finishMeasurement(),a.stopPropagation())}}"mouse"===a.pointerType&&this._hoverAt(b)}};c._handlePointerMove=function(a){"mouse"===a.pointerType&&(a=v.createScreenPointFromEvent(a),this._hoverAt(a))};c._handleKeyDown=function(a){"Enter"===a.key&&"drawing"===this.model.state&&(this.measurementView.finishMeasurement(),a.stopPropagation())};c._hoverAt=function(a){this.measurementView.requiresCursorPoint?(a=this._pick(a),a.mapPoint&&
(this.measurementView.cursorPoint=a.mapPoint)):this.measurementView.cursorPoint=null};c._addVertexAt=function(a){a=this._pick(a);return a.mapPoint?(this.measurementView.path.add(a.mapPoint),!0):!1};c._pick=function(a){const b=this._tempPickRequest;b.screenPoint=a;return this.measurementView.pick(b)};q._createClass(m,[{key:"state",get:function(){var a,b;if(k.isNone(this.model))return"ready";switch(this.model.state){case "initial":return 1<=(null==(a=this.measurementView)?void 0:null==(b=a.path)?void 0:
b.numVertices)?"measuring":"ready";case "drawing":case "editing":return"measuring";case "measured":return"measured"}}},{key:"cursor",get:function(){return this.destroyed?(w.error("Can't query the cursor of a destroyed tool."),null):!this.model.active||"initial"!==this.model.state&&"drawing"!==this.model.state?null:"crosshair"}},{key:"unit",set:function(a){this._set("unit",a);"ready"===this.measurementView.state&&(this.measurementView.layerView.unit=a)}}]);return m}(I.InteractiveToolBase);g.__decorate([h.property({readOnly:!0})],
e.prototype,"state",null);g.__decorate([h.property({readOnly:!0})],e.prototype,"cursor",null);g.__decorate([h.property()],e.prototype,"unit",null);g.__decorate([h.property({constructOnly:!0})],e.prototype,"model",void 0);g.__decorate([h.property({constructOnly:!0})],e.prototype,"measurementView",void 0);g.__decorate([h.property({constructOnly:!0})],e.prototype,"view",void 0);return e=g.__decorate([D.subclass("esri.views.3d.interactive.measurementTools.areaMeasurement3D.AreaMeasurement3DTool")],e)});