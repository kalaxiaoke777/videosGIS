// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.21/esri/copyright.txt for details.
//>>built
define("require ../../kernel ../Error ../events ../maybe ../promiseUtils ./utils ../../support/revision".split(" "),function(g,D,x,E,F,u,l,y){function n(c){return Object.freeze({__proto__:null,default:c})}const G={statsWorker:()=>new Promise(function(c,b){g(["../../smartMapping/statistics/support/statsWorker"],c,b)}),geometryEngineWorker:()=>new Promise(function(c,b){g(["../../geometry/geometryEngineWorker"],c,b)}),CSVSourceWorker:()=>new Promise(function(c,b){g(["../../layers/graphics/sources/support/CSVSourceWorker"],
c,b)}),EdgeProcessingWorker:()=>new Promise(function(c,b){g(["../../views/3d/webgl-engine/lib/edgeRendering/EdgeProcessingWorker"],c,b)}),ElevationSamplerWorker:()=>new Promise(function(c,b){g(["../../geometry/support/meshUtils/ElevationSamplerWorker"],c,b)}),FeatureServiceSnappingSourceWorker:()=>new Promise(function(c,b){g(["../../views/interactive/snapping/featureSources/featureServiceSource/FeatureServiceSnappingSourceWorker"],c,b)}),GeoJSONSourceWorker:()=>new Promise(function(c,b){g(["../../layers/graphics/sources/geojson/GeoJSONSourceWorker"],
function(a){c(n(a))},b)}),LercWorker:()=>new Promise(function(c,b){g(["../../layers/support/LercWorker"],function(a){c(n(a))},b)}),MemorySourceWorker:()=>new Promise(function(c,b){g(["../../layers/graphics/sources/support/MemorySourceWorker"],function(a){c(n(a))},b)}),PBFDecoderWorker:()=>new Promise(function(c,b){g(["../../views/3d/support/PBFDecoderWorker"],function(a){c(n(a))},b)}),Pipeline:()=>new Promise(function(c,b){g(["../../views/2d/layers/features/Pipeline"],c,b)}),PointCloudWorker:()=>
new Promise(function(c,b){g(["../../views/3d/layers/PointCloudWorker"],function(a){c(n(a))},b)}),RasterWorker:()=>new Promise(function(c,b){g(["../../layers/support/RasterWorker"],function(a){c(n(a))},b)}),SceneLayerWorker:()=>new Promise(function(c,b){g(["../../views/3d/layers/SceneLayerWorker"],c,b)}),WFSSourceWorker:()=>new Promise(function(c,b){g(["../../layers/graphics/sources/WFSSourceWorker"],function(a){c(n(a))},b)}),WorkerTileHandler:()=>new Promise(function(c,b){g(["../../views/2d/engine/vectorTiles/WorkerTileHandler"],
function(a){c(n(a))},b)})},{CLOSE:z,ABORT:A,INVOKE:B,RESPONSE:v,OPEN_PORT:C,ON:H}=l.MessageType;let I=function(){function c(a){this._timer=null;this._cancelledJobIds=new Set;this._invokeMessages=[];this._invoke=a;this._timer=null;this._process=this._process.bind(this)}var b=c.prototype;b.push=function(a){a.type===l.MessageType.ABORT?this._cancelledJobIds.add(a.jobId):(this._invokeMessages.push(a),null===this._timer&&(this._timer=setTimeout(this._process,0)))};b.clear=function(){this._invokeMessages.length=
0;this._cancelledJobIds.clear();this._timer=null};b._process=function(){this._timer=null;for(const a of this._invokeMessages)this._cancelledJobIds.has(a.jobId)||this._invoke(a);this._cancelledJobIds.clear();this._invokeMessages.length=0};return c}(),w=function(){function c(a,d){this._port=a;this._outJobs=new Map;this._inJobs=new Map;this._invokeQueue=new I(e=>this._onInvokeMessage(e));this._client=d.client;this._onMessage=this._onMessage.bind(this);this._channel=d.channel;this._schedule=d.schedule;
this._port.addEventListener("message",this._onMessage);this._port.start()}c.connect=function(a){const d=new MessageChannel;a="function"===typeof a?new a:"default"in a&&"function"===typeof a.default?new a.default:a;const e=new c(d.port1,{channel:d,client:a});"object"===typeof a&&"remoteClient"in a&&(a.remoteClient=e);c.clients.set(e,a);return d.port2};c.loadWorker=function(a){return(a=G[a])?a():Promise.resolve(null)};var b=c.prototype;b.close=function(){this._post({type:z});this._close()};b.isBusy=
function(){return 0<this._outJobs.size};b.invoke=function(a,d,e){const f=e&&e.signal,m=e&&e.transferList;if(!this._port)return Promise.reject(new x("worker:port-closed",`Cannot call invoke('${a}'), port is closed`,{methodName:a,data:d}));const h=l.newJobId();return new Promise((p,q)=>{const t=u.onAbortOrThrow(f,()=>{var k;const r=this._outJobs.get(h);r&&(this._outJobs.delete(h),null==(k=r.abortHandle)?void 0:k.remove(),this._post({type:A,jobId:h}),q(u.createAbortError()))});this._outJobs.set(h,{resolve:p,
reject:q,abortHandle:t,debugInfo:a});this._post({type:B,jobId:h,methodName:a,abortable:null!=f},d,m)})};b.on=function(a,d){function e(m){d(m.data)}const f=new MessageChannel;this._port.postMessage({type:l.MessageType.ON,eventType:a,port:f.port2},[f.port2]);f.port1.addEventListener("message",e);f.port1.start();return{remove(){f.port1.postMessage({type:l.MessageType.CLOSE});f.port1.close();f.port1.removeEventListener("message",e)}}};b.openPort=function(){const a=new MessageChannel;this._post({type:C,
port:a.port2});return a.port1};b._close=function(){this._channel&&(this._channel=null);this._port.removeEventListener("message",this._onMessage);this._port.close();this._outJobs.forEach(a=>{var d;null==(d=a.abortHandle)?void 0:d.remove();a.reject(u.createAbortError(`Worker closing, aborting job calling '${a.debugInfo}'`))});this._inJobs.clear();this._outJobs.clear();this._invokeQueue.clear();this._port=this._client=this._schedule=null};b._onMessage=function(a){F.isSome(this._schedule)?this._schedule(()=>
this._processMessage(a)):this._processMessage(a)};b._processMessage=function(a){if(a=l.receiveMessage(a))switch(a.type){case v:this._onResponseMessage(a);break;case B:this._invokeQueue.push(a);break;case A:this._onAbortMessage(a);break;case z:this._onCloseMessage();break;case C:this._onOpenPortMessage(a);break;case H:this._onOnMessage(a)}};b._onAbortMessage=function(a){const d=this._inJobs,e=a.jobId,f=d.get(e);this._invokeQueue.push(a);f&&(f.controller&&f.controller.abort(),d.delete(e))};b._onCloseMessage=
function(){const a=this._client;this._close();a&&"destroy"in a&&c.clients.get(this)===a&&a.destroy();c.clients.delete(this);a&&a.remoteClient&&(a.remoteClient=null)};b._onInvokeMessage=function(a){const {methodName:d,jobId:e,data:f,abortable:m}=a;a=m?u.createAbortController():null;const h=this._inJobs;let p=this._client,q=p[d],t;try{if(!q&&d&&-1!==d.indexOf(".")){const k=d.split(".");for(let r=0;r<k.length-1;r++)p=p[k[r]],q=p[k[r+1]]}if("function"!==typeof q)throw new TypeError(`${d} is not a function`);
t=q.call(p,f,{client:this,signal:a?a.signal:null})}catch(k){this._post({type:v,jobId:e,error:l.toInvokeError(k)});return}u.isPromiseLike(t)?(h.set(e,{controller:a,promise:t}),t.then(k=>{h.has(e)&&(h.delete(e),this._post({type:v,jobId:e},k))},k=>{h.has(e)&&(h.delete(e),u.isAbortError(k)||this._post({type:v,jobId:e,error:l.toInvokeError(k||{message:`Error encountered at method ${d}`})}))})):this._post({type:v,jobId:e},t)};b._onOpenPortMessage=function(a){new c(a.port,{client:this._client})};b._onOnMessage=
function(a){const {port:d}=a,e=this._client.on(a.eventType,m=>{d.postMessage(m)}),f=E.on(a.port,"message",m=>{l.receiveMessage(m).type===l.MessageType.CLOSE&&(f.remove(),e.remove(),d.close())})};b._onResponseMessage=function(a){var d;const {jobId:e,error:f,data:m}=a;a=this._outJobs;if(a.has(e)){var h=a.get(e);a.delete(e);null==(d=h.abortHandle)?void 0:d.remove();f?h.reject(x.fromJSON(JSON.parse(f))):h.resolve(m)}};b._post=function(a,d,e){return l.postMessage(this._port,a,d,e)};return c}();w.kernelInfo=
{revision:y.commitHash,version:D.version,buildDate:y.buildDate};w.clients=new Map;return w});