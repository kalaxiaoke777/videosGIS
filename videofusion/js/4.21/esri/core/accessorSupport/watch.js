// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.21/esri/copyright.txt for details.
//>>built
define("exports ../ArrayPool ../lang ../ReentrantObjectPool ../scheduling ../SetUtils ../uid ./get ./trackingUtils ./utils".split(" "),function(k,D,y,E,F,G,w,z,q,r){function t(b){g.delete(b);g.add(b);u||(u=F.schedule(A))}function B(b){if(!b.removed){var d=b.oldValue,a=b.getValue();y.equals(d,a)||(b.oldValue=a,b.notify(a,d))}}function A(){let b=10;for(;u&&b--;){u=null;const d=H(),a=v.acquire();for(const c of d){const e=c.uid;B(c);e===c.uid&&c.removed&&a.push(c)}for(const c of g)c.removed&&(a.push(c),
g.delete(c));for(const c of a)n.pool.release(c);v.release(a);v.release(d);x.forEach(c=>c())}}function H(){const b=v.acquire();b.length=g.size;let d=0;for(const a of g)b[d]=a,++d;g.clear();return b}function I(b,d,a){let c=r.parse(b,d,a,(e,h,l)=>{let f,m,p=q.reactionDeferred(()=>z.valueOf(e,h),(J,K)=>{e.__accessor__.destroyed||f&&f.uid!==m?c.remove():(f||(f=n.acquireUntracked(J,l,K,e,h),m=f.uid),t(f))});return{remove:r.once(()=>{p.remove();f&&(f.uid!==m||f.removed||(f.removed=!0,t(f)),f=null);c=p=null})}});
return c}function L(b,d,a){const c=r.parse(b,d,a,(e,h,l)=>{let f=!1;return q.reaction(()=>z.valueOf(e,h),(m,p)=>{e.__accessor__.destroyed?c.remove():f||(f=!0,y.equals(p,m)||l.call(e,m,p,h,e),f=!1)})});return c}function C(b,d,a,c=!1){return!b.__accessor__||b.__accessor__.destroyed?{remove(){}}:c?L(b,d,a):I(b,d,a)}function M(b,d){let a,c,e=q.reactionDeferred(b,(h,l)=>{a&&a.uid!==c?e.remove():(a||(a=n.acquireTracked(h,d,l),c=a.uid),t(a))});return{remove:r.once(()=>{e.remove();a&&(a.uid!==c||a.removed||
(a.removed=!0,t(a)),a=null);e=null})}}let n=function(){function b(){this.uid=w.generateUID();this.removed=!1;this.path=this.target=this.getValue=this.callback=this.oldValue=this.type=null}b.acquireUntracked=function(a,c,e,h,l){return this.pool.acquire(0,a,c,e,h,l)};b.acquireTracked=function(a,c,e){return this.pool.acquire(1,a,c,e,null,null)};var d=b.prototype;d.notify=function(a,c){0===this.type?this.callback.call(this.target,a,c,this.path,this.target):this.callback.call(null,a,c)};d.acquire=function(a,
c,e,h,l,f){this.uid=w.generateUID();this.removed=!1;this.type=a;this.oldValue=c;this.callback=e;this.getValue=h;this.target=l;this.path=f};d.release=function(){this.target=this.path=this.oldValue=this.callback=this.getValue=null;this.uid=w.generateUID();this.removed=!0};return b}();n.pool=new E.ReentrantObjectPool(n);const v=new D,g=new Set;let u;const x=new Set;k.afterDispatch=function(b){x.add(b);return{remove(){x.delete(b)}}};k["default"]=C;k.dispatch=A;k.dispatchTarget=function(b){const d=Array.from(g);
for(let a=0;a<d.length;a++){const c=d[a];c.target===b&&(B(c),g.delete(c))}};k.isValueInUse=function(b){return G.someSet(g,d=>d.oldValue===b)};k.removeTarget=function(b){for(const d of g.values())d.target===b&&(d.removed=!0)};k.watch=C;k.watchTracked=function(b,d,a=!1){return a?q.reaction(b,d):M(b,d)};Object.defineProperty(k,"__esModule",{value:!0})});