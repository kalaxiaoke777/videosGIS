// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.21/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../Graphic ../../arcade/featureset/support/FeatureSetQueryInterceptor ../../core/Accessor ../../core/Handles ../../core/Logger ../../core/maybe ../../core/promiseUtils ../../core/throttle ../../core/watchUtils ../../core/accessorSupport/decorators/property ../../core/has ../../core/accessorSupport/decorators/cast ../../core/accessorSupport/decorators/subclass ../../popup/content/TextContent ./FeatureAttachments/FeatureAttachmentsViewModel ./FeatureContent/FeatureContentViewModel ./FeatureFields/FeatureFieldsViewModel ./FeatureMedia/FeatureMediaViewModel ./support/arcadeFeatureUtils ./support/featureUtils ./support/relatedFeatureUtils".split(" "),
function(u,h,G,H,f,I,J,C,x,K,L,l,T,M,N,O,P,D,Q,y,R,p,w){var B;const S=J.getLogger("esri.widgets.FeatureViewModel"),E={attachmentsContent:!0,customContent:!0,fieldsContent:!0,mediaContent:!0,textContent:!0};f=B=function(F){function z(a){var b=F.call(this,a)||this;b._handles=new I;b._error=null;b._featureAbortController=null;b.graphicChangedThrottled=K.throttle(b.graphicChanged,1,u._assertThisInitialized(b));b._expressionAttributes=null;b.abilities={...E};b.content=null;b.contentViewModels=[];b.defaultPopupTemplateEnabled=
!1;b.formattedAttributes=null;b.lastEditInfo=null;b.relatedInfos=new Map;b.title="";b.view=null;b._isAllowedContentType=c=>{const {abilities:d}=u._assertThisInitialized(b);return"attachments"===c.type&&d.attachmentsContent||"custom"===c.type&&d.customContent||"fields"===c.type&&d.fieldsContent||"media"===c.type&&d.mediaContent||"text"===c.type&&d.textContent};b._handles.add(L.init(u._assertThisInitialized(b),["graphic","_effectivePopupTemplate","abilities"],()=>b.graphicChangedThrottled()));return b}
u._inheritsLoose(z,F);var g=z.prototype;g.destroy=function(){this._clear();this._cancelFeatureQuery();this._error=null;this._handles.destroy();this.graphic=this._handles=null;this._destroyContentViewModels();this.relatedInfos.clear()};g.castAbilities=function(a){return{...E,...a}};g.setActiveMedia=function(a,b){a=this.contentViewModels[a];a instanceof y&&a.setActiveMedia(b)};g.nextMedia=function(a){a=this.contentViewModels[a];a instanceof y&&a.next()};g.previousMedia=function(a){a=this.contentViewModels[a];
a instanceof y&&a.previous()};g._clear=function(){this._set("title","");this._set("content",null);this._set("formattedAttributes",null)};g.graphicChanged=function(){var a=u._asyncToGenerator(function*(){this._cancelFeatureQuery();this._error=null;this._clear();const {graphic:b}=this;if(b){var c=x.createAbortController();this._featureAbortController=c;try{yield this._queryFeature({signal:c.signal})}catch(d){x.isAbortError(d)||(this._error=d,S.error("error","The popupTemplate could not be displayed for this feature.",
{error:d,graphic:b,popupTemplate:this._effectivePopupTemplate}))}this._featureAbortController===c&&(this._featureAbortController=null)}});return function(){return a.apply(this,arguments)}}();g._cancelFeatureQuery=function(){const {_featureAbortController:a}=this;a&&a.abort();this._featureAbortController=null};g._compileContent=function(a){this._destroyContentViewModels();if(this.graphic)return Array.isArray(a)?a.filter(this._isAllowedContentType).map((b,c)=>{if("attachments"===b.type)return this._compileAttachments(b,
c);if("custom"===b.type)return this._compileCustom(b,c);if("fields"===b.type)return this._compileFields(b,c);if("media"===b.type)return this._compileMedia(b,c);if("text"===b.type)return this._compileText(b,c)}):"string"===typeof a?this._compileText(new O({text:a}),0).text:a};g._destroyContentViewModels=function(){this.contentViewModels.forEach(a=>a&&!a.destroyed&&a.destroy());this._set("contentViewModels",[])};g._compileAttachments=function(a,b){const {graphic:c}=this,{description:d,title:e}=a;this.contentViewModels[b]=
new P({graphic:c,...this._compileTitleAndDesc({title:e,description:d})});return a};g._compileCustom=function(a,b){const {graphic:c}=this,{creator:d,destroyer:e}=a;this.contentViewModels[b]=new D({graphic:c,creator:d,destroyer:e});return a};g._compileTitleAndDesc=function({title:a,description:b}){const {_fieldInfoMap:c,_sourceLayer:d,graphic:e,formattedAttributes:k,_expressionAttributes:m}=this,{attributes:r}=e,q=k.global;return{title:p.substituteFieldsInLinksAndAttributes({attributes:r,fieldInfoMap:c,
globalAttributes:q,expressionAttributes:m,layer:d,text:a}),description:p.substituteFieldsInLinksAndAttributes({attributes:r,fieldInfoMap:c,globalAttributes:q,expressionAttributes:m,layer:d,text:b})}};g._compileFields=function(a,b){const {_effectivePopupTemplate:c,formattedAttributes:d}=this,e=a.clone();a=(null==a?void 0:a.fieldInfos)||(null==c?void 0:c.fieldInfos);const k=null==c?void 0:c.expressionInfos,m={...d.global,...d.content[b]},{description:r,title:q}=e;a=new Q({attributes:m,expressionInfos:k,
fieldInfos:a,...this._compileTitleAndDesc({title:q,description:r})});this.contentViewModels[b]=a;e.fieldInfos=a.formattedFieldInfos.slice(0);return e};g._compileMedia=function(a,b){const {graphic:c,_fieldInfoMap:d,_effectivePopupTemplate:e,relatedInfos:k,_sourceLayer:m,_expressionAttributes:r}=this;var {attributes:q}=c;const t=this.formattedAttributes.global;a=a.clone();const {description:n,mediaInfos:v,title:A}=a;q=new y({activeMediaInfoIndex:a.activeMediaInfoIndex||0,attributes:q,layer:m,fieldInfoMap:d,
formattedAttributes:t,expressionAttributes:r,mediaInfos:v,popupTemplate:e,relatedInfos:k,...this._compileTitleAndDesc({title:A,description:n})});a.mediaInfos=q.formattedMediaInfos.slice(0);this.contentViewModels[b]=q;return a};g._compileText=function(a,b){a=a.clone();const {graphic:c,_fieldInfoMap:d,_sourceLayer:e,_expressionAttributes:k}=this;if(a&&a.text){const {attributes:m}=c;a.text=p.substituteFieldsInLinksAndAttributes({attributes:m,fieldInfoMap:d,globalAttributes:this.formattedAttributes.global,
expressionAttributes:k,layer:e,text:a.text})}this.contentViewModels[b]=new D({graphic:c,creator:a.text});return a};g._compileLastEditInfo=function(){const {_effectivePopupTemplate:a,_sourceLayer:b,graphic:c}=this;if(a){var {lastEditInfoEnabled:d}=a,e=null==b?void 0:b.editFieldsInfo;if(d&&e)return p.formatEditInfo(e,c.attributes)}};g._compileTitle=function(a){const {_fieldInfoMap:b,_sourceLayer:c,graphic:d,_expressionAttributes:e}=this,{attributes:k}=d;return p.substituteFieldsInLinksAndAttributes({attributes:k,
fieldInfoMap:b,globalAttributes:this.formattedAttributes.global,expressionAttributes:e,layer:c,text:a})};g._getTitle=function(){var a=u._asyncToGenerator(function*(){const {_effectivePopupTemplate:b,graphic:c}=this;return p.graphicCallback(null==b?void 0:b.title,{graphic:c})});return function(){return a.apply(this,arguments)}}();g._getContent=function(){var a=u._asyncToGenerator(function*(){const {_effectivePopupTemplate:b,graphic:c}=this;return p.graphicCallback(null==b?void 0:b.content,{graphic:c})});
return function(){return a.apply(this,arguments)}}();g._queryFeature=function(){var a=u._asyncToGenerator(function*(b){const {_featureAbortController:c,_sourceLayer:d,graphic:e,_effectivePopupTemplate:k,spatialReference:m,map:r,view:q}=this,{content:{value:t},title:{value:n}}=yield x.eachAlways({content:this._getContent(),title:this._getTitle()});c===this._featureAbortController&&e&&(yield p.queryUpdatedFeature({graphic:e,popupTemplate:k,layer:d,spatialReference:m},b),{expressionAttributes:{value:b}}=
yield x.eachAlways({checkForRelatedFeatures:this._checkForRelatedFeatures(b),expressionAttributes:R.createCompiledExpressions({popupTemplate:this._effectivePopupTemplate,spatialReference:m,graphic:e,map:r,interceptor:B.interceptor,view:q})}),c===this._featureAbortController&&e&&(this._expressionAttributes=b,this._set("formattedAttributes",this._createFormattedAttributes(t,b)),this._set("title",this._compileTitle(n)),this._set("lastEditInfo",this._compileLastEditInfo()||null),this._set("content",this._compileContent(t)||
null)))});return function(b){return a.apply(this,arguments)}}();g._createFormattedAttributes=function(a,b){const {_effectivePopupTemplate:c,graphic:d,relatedInfos:e,_sourceLayer:k,_fieldInfoMap:m}=this,r={...d.attributes,...b},q={global:p.formatAttributes({fieldInfos:null==c?void 0:c.fieldInfos,graphic:d,attributes:r,layer:k,fieldInfoMap:m,relatedInfos:e}),content:[]};Array.isArray(a)&&a.forEach((t,n)=>{"fields"===t.type&&t.fieldInfos&&(q.content[n]=p.formatAttributes({fieldInfos:t.fieldInfos,graphic:d,
attributes:r,layer:k,fieldInfoMap:m,relatedInfos:e}))});return q};g._checkForRelatedFeatures=function(a){const {graphic:b,_effectivePopupTemplate:c}=this;return this._queryRelatedInfos(b,p.getAllFieldInfos(c),a)};g._queryRelatedInfos=function(){var a=u._asyncToGenerator(function*(b,c,d){const {relatedInfos:e,_sourceLayer:k}=this;e.clear();const m=C.isSome(k.associatedLayer)?yield k.associatedLayer.load(d):k;if(m){var r=c.filter(n=>n&&p.isRelatedField(n.fieldName));if(r&&r.length){c.forEach(n=>this._configureRelatedInfo(n,
m));var q=yield w.queryLayerInfos({relatedInfos:e,layer:m},d);Object.keys(q).forEach(n=>{var v;const A=e.get(n.toString());n=null==(v=q[n])?void 0:v.value;A&&n&&(A.layerInfo=n.data)});var t=yield w.queryRelatedFeatures({graphic:b,relatedInfos:e,layer:m},d);Object.keys(t).forEach(n=>{var v;w.setRelatedFeatures(null==(v=t[n])?void 0:v.value,e.get(n.toString()))})}}});return function(b,c,d){return a.apply(this,arguments)}}();g._configureRelatedInfo=function(a,b){const {relatedInfos:c}=this,d=w.getRelatedFieldInfo(a.fieldName);
if(d){var {layerId:e,fieldName:k}=d;e&&(b=c.get(e.toString())||w.createRelatedInfo(e,b))&&(w.updateRelatedInfo({relatedInfo:b,fieldName:k,fieldInfo:a}),this.relatedInfos.set(e,b))}};u._createClass(z,[{key:"_effectivePopupTemplate",get:function(){return C.isSome(this.graphic)?this.graphic.getEffectivePopupTemplate(this.defaultPopupTemplateEnabled):null}},{key:"_fieldInfoMap",get:function(){return p.createfieldInfoMap(p.getAllFieldInfos(this._effectivePopupTemplate),this._sourceLayer)}},{key:"_sourceLayer",
get:function(){return p.getSourceLayer(this.graphic)}},{key:"state",get:function(){return this.graphic?this._error?"error":this.waitingForContent?"loading":"ready":"disabled"}},{key:"graphic",set:function(a){this._set("graphic",a?a.clone():null)}},{key:"spatialReference",get:function(){return this.get("view.spatialReference")||null},set:function(a){void 0===a?this._clearOverride("spatialReference"):this._override("spatialReference",a)}},{key:"map",get:function(){return this.get("view.map")||null},
set:function(a){void 0===a?this._clearOverride("map"):this._override("map",a)}},{key:"waitingForContent",get:function(){return!!this._featureAbortController}}]);return z}(f);f.interceptor=new H.FeatureSetQueryInterceptor(p.preLayerQueryCallback,p.preRequestCallback);h.__decorate([l.property()],f.prototype,"_error",void 0);h.__decorate([l.property()],f.prototype,"_featureAbortController",void 0);h.__decorate([l.property({readOnly:!0})],f.prototype,"_effectivePopupTemplate",null);h.__decorate([l.property({readOnly:!0})],
f.prototype,"_fieldInfoMap",null);h.__decorate([l.property({readOnly:!0})],f.prototype,"_sourceLayer",null);h.__decorate([l.property()],f.prototype,"abilities",void 0);h.__decorate([M.cast("abilities")],f.prototype,"castAbilities",null);h.__decorate([l.property({readOnly:!0})],f.prototype,"content",void 0);h.__decorate([l.property({readOnly:!0})],f.prototype,"contentViewModels",void 0);h.__decorate([l.property({type:Boolean})],f.prototype,"defaultPopupTemplateEnabled",void 0);h.__decorate([l.property({readOnly:!0})],
f.prototype,"state",null);h.__decorate([l.property({readOnly:!0})],f.prototype,"formattedAttributes",void 0);h.__decorate([l.property({type:G,value:null})],f.prototype,"graphic",null);h.__decorate([l.property({readOnly:!0})],f.prototype,"lastEditInfo",void 0);h.__decorate([l.property()],f.prototype,"relatedInfos",void 0);h.__decorate([l.property()],f.prototype,"spatialReference",null);h.__decorate([l.property({readOnly:!0})],f.prototype,"title",void 0);h.__decorate([l.property()],f.prototype,"map",
null);h.__decorate([l.property({readOnly:!0})],f.prototype,"waitingForContent",null);h.__decorate([l.property()],f.prototype,"view",void 0);return f=B=h.__decorate([N.subclass("esri.widgets.FeatureViewModel")],f)});