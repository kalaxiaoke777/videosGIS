// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.21/esri/copyright.txt for details.
//>>built
define("require exports ../../../chunks/_rollupPluginBabelHelpers ../../../core/Logger ../../../core/promiseUtils ../../../layers/FeatureLayer ./featureUtils".split(" "),function(x,w,r,y,z,A,l){function B(b){return`<ul class="esri-widget__list">${b.map(a=>`<li>${"string"===typeof a?l.applyTextFormattingHTML(l.htmlEntities(a)):a}</li>`).join("")}</ul>`}function C(b){return`<table class="esri-widget__table">${b.keys().map(a=>{var d=b.field(a);d="string"===typeof d?l.applyTextFormattingHTML(l.htmlEntities(d)):
d;return`<tr><th>${a}</th><td>${d}</td></tr>`}).join("")}</table>`}function D({aggregatedFeatures:b,arcadeUtils:a,featureSetVars:d,context:c,viewInfo:e,map:m,graphic:k,interceptor:h}){d.forEach(g=>{g=g.toLowerCase();var f={map:m,spatialReference:e.sr,interceptor:h};"$map"===g&&(c.vars[g]=a.convertMapToFeatureSetCollection(f));"$layer"===g&&(c.vars[g]=a.convertFeatureLayerToFeatureSet({layer:k.sourceLayer,spatialReference:e.sr,interceptor:h}));"$datastore"===g&&(c.vars[g]=a.convertServiceUrlToWorkspace({url:k.sourceLayer.url,
spatialReference:e.sr,interceptor:h}));if("$aggregatedfeatures"===g){f=k.layer;const {fields:p,objectIdField:q,geometryType:n,spatialReference:E,displayField:F}=f;f=new A({fields:p,objectIdField:q,geometryType:n,spatialReference:E,displayField:F,..."feature"===f.type?{templates:f.templates,typeIdField:f.typeIdField,types:f.types}:null,source:b});c.vars[g]=a.convertFeatureLayerToFeatureSet({layer:f,spatialReference:e.sr,interceptor:h})}})}function G(){return new Promise(function(b,a){x(["../../../support/arcadeUtils"],
b,a)})}function H(b){return t.apply(this,arguments)}function t(){t=r._asyncToGenerator(function*({graphic:b,view:a}){const {isAggregate:d,layer:c}=b;if(!d||!c||"2d"!==(null==a?void 0:a.type))return[];a=yield a.whenLayerView(c);if(!a.createQuery||!a.queryFeatures)return[];const e=a.createQuery();e.aggregateIds=[b.getObjectId()];({features:b}=yield a.queryFeatures(e));return b});return t.apply(this,arguments)}function I(b){return u.apply(this,arguments)}function u(){u=r._asyncToGenerator(function*({expressionAttributes:b,
info:a,arcadeUtils:d,interceptor:c,spatialReference:e,map:m,graphic:k,view:h}){const g=`expression/${a.name}`,f=d.createSyntaxTree(a.expression),p=J.filter(n=>d.hasVariable(f,n));yield d.loadScriptDependencies(f,!0,p);const q=d.getViewInfo({spatialReference:e});e=d.createExecContext(k,q);e.interceptor=c;e.useAsync=!0;h=yield H({graphic:k,view:h});D({aggregatedFeatures:h,arcadeUtils:d,featureSetVars:p,context:e,viewInfo:q,map:m,graphic:k,interceptor:c});c=d.createFunction(f,e);c=yield d.executeAsyncFunction(c,
e).catch(n=>K.error("arcade-execution-error",{error:n,graphic:k,expressionInfo:a}));b[g]="string"===typeof c?l.applyTextFormattingHTML(l.htmlEntities(c)):Array.isArray(c)?B(c):c&&"esri.arcade.Dictionary"===c.declaredClass?C(c):c});return u.apply(this,arguments)}function v(){v=r._asyncToGenerator(function*({popupTemplate:b,spatialReference:a,graphic:d,interceptor:c,map:e,view:m}){b=b.expressionInfos;const k=[],h={};if(!b||!b.length)return h;const g=yield G();for(const f of b)k.push(I({expressionAttributes:h,
info:f,arcadeUtils:g,interceptor:c,spatialReference:a,map:e,graphic:d,view:m}));yield z.eachAlways(k);return h});return v.apply(this,arguments)}const J=["$datastore","$map","$layer","$aggregatedfeatures"],K=y.getLogger("esri.widgets.Feature.support.arcadeFeatureUtils");w.createCompiledExpressions=function(b){return v.apply(this,arguments)};Object.defineProperty(w,"__esModule",{value:!0})});