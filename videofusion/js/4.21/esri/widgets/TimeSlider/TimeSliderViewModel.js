// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.21/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../TimeExtent ../../TimeInterval ../../core/Collection ../../core/deprecate ../../core/Evented ../../core/HandleOwner ../../core/lang ../../core/Logger ../../core/maybe ../../core/promiseUtils ../../core/timeUtils ../../core/watchUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/has ../../core/accessorSupport/decorators/subclass ../../support/timeUtils ../../webdoc/Widgets ../../webdoc/widgets/TimeSlider".split(" "),
function(u,m,k,I,D,E,g,J,K,L,e,y,M,w,n,F,R,N,O,P,Q){function B(l){return e.isSome(l)&&void 0!==l.count}function z(l){return e.isSome(l)&&void 0!==l.interval}function G(l){return e.isSome(l)&&void 0!==l.dates}const C=L.getLogger("esri.widgets.Popup.PopupViewModel");g=function(l){function A(a){a=l.call(this,a)||this;a._animationController=null;a._loadingWebDocument=!1;a._timerId=null;a._updateTimeSliderTask=null;a.actions=new D;a.view=null;return a}u._inheritsLoose(A,l);var h=A.prototype;h.initialize=
function(){var a=this;this.handles.add([w.init(this,"effectiveStops",()=>{e.isNone(this.timeExtent)&&this._set("timeExtent",this._getDefaultTimeExtent())}),w.init(this,"view.map",b=>{e.isSome(this._updateTimeSliderTask)&&(this._updateTimeSliderTask.abort(),this._updateTimeSliderTask=null);this._updateTimeSliderTask=y.createTask(function(){var d=u._asyncToGenerator(function*(c){a._loadingWebDocument=!0;yield a._updateTimeSliderFromMap(b,c);a._loadingWebDocument=!1});return function(c){return d.apply(this,
arguments)}}())}),w.init(this,"view",(b,d)=>{this._unregisterWidget(d);this._registerWidget(b)},!0),w.init(this,"timeExtent",b=>{e.isSome(this.view)&&(this.view.timeExtent=b)})])};h.destroy=function(){e.isSome(this._timerId)&&(clearInterval(this._timerId),this._timerId=null);this._unregisterWidget(this.view);this.view=null;e.isSome(this._animationController)&&(this._animationController.abort(),this._animationController=null);e.isSome(this._updateTimeSliderTask)&&(this._updateTimeSliderTask.abort(),
this._updateTimeSliderTask=null)};h.next=function(){this._step({forward:!0,allowRestart:!1})};h.play=function(){this._startAnimation()};h.previous=function(){this._step({forward:!1,allowRestart:!1})};h.stop=function(){this._stopAnimation()};h.triggerAction=function(a){this.emit("trigger-action",{action:a})};h.updateWebDocument=function(a){if("esri.WebMap"===a.declaredClass){const b=new Q({currentTimeExtent:this.timeExtent,fullTimeExtent:this.fullTimeExtent,loop:this.loop,numStops:B(this.stops)?this.stops.count:
null,numThumbs:"time-window"===this.mode?2:1,stopDelay:this.playRate,stopInterval:z(this.stops)?this.stops.interval:null,stops:G(this.stops)?this.stops.dates:null});a.widgets?a.widgets.timeSlider=b:a.widgets=new P({timeSlider:b})}};h.valuesToTimeExtent=function(a){if(e.isNone(a))return null;var b=a.sort((d,c)=>d-c).map(d=>new Date(d));a=0<b.length?b[0]:null;b=1<b.length?b[1]:null;switch(this.mode){case "time-window":return new k({start:a,end:b});case "instant":return new k({start:a,end:a});case "cumulative-from-start":return new k({start:null,
end:a});case "cumulative-from-end":return new k({start:a,end:null});default:return k.allTime}};h._animate=function(){var a=u._asyncToGenerator(function*(){try{yield Promise.all([y.after(this.playRate,null,e.isSome(this._animationController)&&this._animationController.signal),e.isSome(this.view)&&w.whenFalseOnce(this.view,"updating",e.isSome(this._animationController)&&this._animationController.signal)])}catch(b){y.isAbortError(b)||C.error(b);this._animationController=null;return}this._step({forward:!0,
allowRestart:!1});e.isNone(this._animationController)||this._animate()});return function(){return a.apply(this,arguments)}}();h._divideTimeExtentByCount=function(a,b=10){if(!a||!b)return[];const {start:d,end:c}=a;if(e.isNone(d)||e.isNone(c))return[];if(1E4<b)return this._divideTimeExtentByCount(a);a=[];const f=d.getTime(),r=c.getTime()-f;for(let q=0;q<=b;q++)a.push(new Date(f+q/b*r));return a};h._divideTimeExtentByInterval=function(a,b,d=1E4){if(!a||!b)return[];const {start:c,end:f}=a;if(e.isNone(c)||
e.isNone(f))return[];const r=f.getTime()-c.getTime(),q=b.toMilliseconds();if(r/q>d)return this._divideTimeExtentByCount(a);a=[];const {value:x,unit:p}=b;for(b=c;b.getTime()<=f.getTime();)a.push(new Date(b.getTime())),b=M.offsetDate(b,x,p);return a};h._getDefaultTimeExtent=function(){const {effectiveStops:a,mode:b}=this;if(e.isNone(a)||!b)return null;switch(b){case "time-window":return 1<a.length?new k({start:a[0],end:a[1]}):null;case "cumulative-from-start":return 0<a.length?new k({start:null,end:a[0]}):
null;case "cumulative-from-end":return 0<a.length?new k({start:a[0],end:null}):null;case "instant":return 0<a.length?new k({start:a[0],end:a[0]}):null;default:return null}};h._getFullTimeExtentFromWebDocument=function(){var a=u._asyncToGenerator(function*(b,d){const {fullTimeExtent:c}=b.widgets.timeSlider;return c?c:O.getTimeExtentFromLayers(b.allLayers,d)});return function(b,d){return a.apply(this,arguments)}}();h._getModeFromTimeSlider=function(a){var b;const d=null!=(b=a.numThumbs)?b:2;if(a=a.currentTimeExtent){const {start:c,
end:f}=a;return e.isSome(c)&&e.isSome(f)&&c.getTime()===f.getTime()?"instant":2===d?"time-window":e.isNone(c)||0===c.getTime()?"cumulative-from-start":"cumulative-from-end"}return 2===d?"time-window":"cumulative-from-start"};h._getStopsFromTimeSlider=function(a){const {numStops:b,stopInterval:d,stops:c}=a;return c?{dates:K.clone(c)}:d?{interval:d.clone()}:{count:null!=b?b:5}};h._getTimeExtentFromTimeSlider=function(a,b){if(a=a.currentTimeExtent){var d;const {start:c,end:f}=a;a=null!=(d=null!=c?c:
f)?d:null;switch(b){case "time-window":return new k({start:c,end:f});case "cumulative-from-start":return new k({start:null,end:a});case "cumulative-from-end":return new k({start:a,end:null});case "instant":return new k({start:a,end:a})}}return this._getDefaultTimeExtent()};h._registerWidget=function(a){e.isSome(a)&&(a.persistableViewModels.some(b=>b===this)||a.persistableViewModels.add(this))};h._startAnimation=function(){this._stopAnimation();this._animationController=y.createAbortController();this._step({forward:!0,
allowRestart:!0});this._animate()};h._step=function(a){const {forward:b,allowRestart:d}=a;({effectiveStops:a}=this);if(!e.isNone(this.timeExtentValues)&&!e.isNone(a)){var c=a.map(p=>p.getTime());a=this.timeExtentValues.map(p=>{var v=c.indexOf(p);if(-1!==v)return v;v=c.reduce((t,H)=>Math.abs(H-p)<Math.abs(t-p)?H:t);return c.indexOf(v)});var f=a.map(p=>p+=b?1:-1),r=f.some(p=>0>p||p>c.length-1),{loop:q,state:x}=this;if(r)if(q||d){const p=Math.min(...a),v=Math.max(...a);a=(b?a.map(t=>t-p):a.map(t=>t+
(c.length-1-v))).map(t=>c[t]);this.timeExtent=this.valuesToTimeExtent(a)}else"playing"===x&&this.stop();else a=f.map(p=>c[p]),this.timeExtent=this.valuesToTimeExtent(a)}};h._stopAnimation=function(){e.isSome(this._animationController)&&(this._animationController.abort(),this._animationController=null)};h._unregisterWidget=function(a){e.isSome(a)&&a.persistableViewModels.remove(this)};h._updateTimeSliderFromMap=function(){var a=u._asyncToGenerator(function*(b,d){var c;if(b&&"esri.WebMap"===b.declaredClass){yield b.load({signal:d});
var f=null==b?void 0:null==(c=b.widgets)?void 0:c.timeSlider;if(f){c=this._getModeFromTimeSlider(f);this._isOverridden("mode")||(this.mode=c);this._isOverridden("fullTimeExtent")||(this.fullTimeExtent=yield this._getFullTimeExtentFromWebDocument(b,d));if(!this._isOverridden("playRate")){var r;this.playRate=null!=(r=f.stopDelay)?r:2E3}this._isOverridden("stops")||(this.stops=this._getStopsFromTimeSlider(f));this._isOverridden("timeExtent")||(this.timeExtent=this._getTimeExtentFromTimeSlider(f,c));
this._isOverridden("loop")||(this.loop=f.loop)}}});return function(b,d){return a.apply(this,arguments)}}();u._createClass(A,[{key:"effectiveStops",get:function(){const {fullTimeExtent:a,stops:b}=this;if(G(b)){var {dates:d}=b;if(null==d||0===d.length)return null;d=d.sort((q,x)=>q.getTime()-x.getTime());if(e.isNone(a))return d;const {start:f,end:r}=a;return e.isNone(f)||e.isNone(r)?d:d.filter(q=>!(q.getTime()<f.getTime()||q.getTime()>r.getTime()))}if(B(b)){var c=null!=(d=b.timeExtent)?d:e.unwrap(a);
return this._divideTimeExtentByCount(c,b.count)}return z(b)?(d=null!=(c=b.timeExtent)?c:e.unwrap(a),this._divideTimeExtentByInterval(d,b.interval)):[]}},{key:"fullTimeExtent",set:function(a){this._override("fullTimeExtent",a)}},{key:"loop",set:function(a){this._override("loop",a)}},{key:"mode",set:function(a){this._override("mode",a)}},{key:"playRate",set:function(a){0>=a||36E5<a||("playing"===this.state&&this._startAnimation(),this._override("playRate",a))}},{key:"state",get:function(){return e.isNone(this.fullTimeExtent)||
this._loadingWebDocument?"disabled":e.isSome(this._animationController)?"playing":"ready"}},{key:"stops",set:function(a){this._override("stops",a)}},{key:"timeExtent",set:function(a){this._override("timeExtent",a)}},{key:"timeExtentValues",get:function(){const {mode:a,timeExtent:b}=this;if(e.isNone(b)||b.isAllTime||b.isEmpty)return null;const {start:d,end:c}=b;switch(a){case "cumulative-from-end":case "instant":return e.isSome(d)?[d.getTime()]:null;case "cumulative-from-start":return e.isSome(c)?
[c.getTime()]:null;case "time-window":return e.isSome(d)&&e.isSome(c)?[d.getTime(),c.getTime()]:null}}},{key:"values",get:function(){E.deprecatedProperty(C,"values",{replacement:"timeExtent",version:"4.20"});const {mode:a,timeExtent:b}=this;if(e.isNone(b))return null;if(b.isAllTime)return"time-window"===a?[null,null]:[null];if(b.isEmpty)return"time-window"===a?[void 0,void 0]:[void 0];const {start:d,end:c}=b;switch(a){case "time-window":return[d,c];case "instant":case "cumulative-from-end":return[d];
case "cumulative-from-start":return[c]}},set:function(a){E.deprecatedProperty(C,"values",{replacement:"timeExtent",version:"4.20"});if(e.isNone(a))this.timeExtent=null;else{var b=a[0];if(e.isNone(b))this.timeExtent=new k({start:b,end:b});else switch(a=1<a.length&&a[1],this.mode){case "time-window":this.timeExtent=new k({start:b,end:a});break;case "instant":this.timeExtent=new k({start:b,end:b});break;case "cumulative-from-end":this.timeExtent=new k({start:b,end:null});break;case "cumulative-from-start":this.timeExtent=
new k({start:null,end:b})}}}}]);return A}(J.HandleOwnerMixin(g.EventedAccessor));m.__decorate([n.property()],g.prototype,"_animationController",void 0);m.__decorate([n.property()],g.prototype,"_loadingWebDocument",void 0);m.__decorate([n.property({type:D})],g.prototype,"actions",void 0);m.__decorate([n.property({readOnly:!0})],g.prototype,"effectiveStops",null);m.__decorate([n.property({type:k,value:null})],g.prototype,"fullTimeExtent",null);m.__decorate([n.property({nonNullable:!0,value:!1})],g.prototype,
"loop",null);m.__decorate([n.property({nonNullable:!0,value:"time-window"})],g.prototype,"mode",null);m.__decorate([n.property({nonNullable:!0,value:1E3})],g.prototype,"playRate",null);m.__decorate([n.property({readOnly:!0})],g.prototype,"state",null);m.__decorate([n.property({cast:l=>{if(e.isNone(l))return null;z(l)&&(l.interval=F.ensureType(I,l.interval));if(z(l)||B(l))l.timeExtent=F.ensureType(k,l.timeExtent);return l},value:{count:10}})],g.prototype,"stops",null);m.__decorate([n.property({type:k,
value:null})],g.prototype,"timeExtent",null);m.__decorate([n.property({readOnly:!0})],g.prototype,"timeExtentValues",null);m.__decorate([n.property({value:null})],g.prototype,"values",null);m.__decorate([n.property()],g.prototype,"view",void 0);m.__decorate([n.property()],g.prototype,"next",null);m.__decorate([n.property()],g.prototype,"play",null);m.__decorate([n.property()],g.prototype,"previous",null);m.__decorate([n.property()],g.prototype,"stop",null);m.__decorate([n.property()],g.prototype,
"updateWebDocument",null);return g=m.__decorate([N.subclass("esri.widgets.Popup.PopupViewModel")],g)});