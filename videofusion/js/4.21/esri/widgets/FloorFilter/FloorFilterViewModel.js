// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.21/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/Collection ../../core/Error ../../core/HandleOwner ../../core/maybe ../../core/promiseUtils ../../core/time ../../core/watchUtils ../../core/accessorSupport/decorators/property ../../core/has ../../core/accessorSupport/ensureType ../../core/Logger ../../core/accessorSupport/decorators/subclass ../../webdoc/Widgets ../../webdoc/widgets/FloorFilter ../support/GoTo".split(" "),function(x,m,Q,V,l,R,W,X,H,n,da,ea,fa,Y,Z,aa,
ba){l=function(S){function I(b){b=S.call(this,b)||this;b.filterMenuOpen=!1;b.filterMenuType="site";b.filterMode="base-floors";b.levelsExpanded=!0;b.searchTerm=null;b.view=null;b._updateFloorFilterTask=null;return b}x._inheritsLoose(I,S);var h=I.prototype;h.initialize=function(){this.handles.add([H.init(this,"view.map",b=>{R.isSome(this._updateFloorFilterTask)&&(this._updateFloorFilterTask.abort(),this._updateFloorFilterTask=null);this._updateFloorFilterTask=W.createTask(()=>this._updateFloorFilterFromMap(b).then(()=>
{this._setInitialViewState()}))}),H.init(this,"view",(b,a)=>{this._unregisterWidget(a);this._registerWidget(b)},!0),H.watch(this,"view.widthBreakpoint",b=>{this._viewWidthBreakpoint=b}),H.watch(this,"view.heightBreakpoint",b=>{this._viewHeightBreakpoint=b})])};h.destroy=function(){this._unregisterWidget(this.view);this.view=null;R.isSome(this._updateFloorFilterTask)&&(this._updateFloorFilterTask.abort(),this._updateFloorFilterTask=null)};h.filterFacilities=function(b){let a=b;this.searchTerm&&(a=
b.filter(c=>{({name:c}=c);return c.toLowerCase().includes(this.searchTerm.toLowerCase())}));this.site&&(a=a.filter(c=>c.siteId===this.site));return a.sort((c,d)=>{c=c.name;d=d.name;return c>d?1:c===d?0:-1})};h.filterSites=function(b){let a=b;this.searchTerm&&(a=b.filter(c=>{({name:c}=c);return c.toLowerCase().includes(this.searchTerm.toLowerCase())}));return a.sort((c,d)=>{c=c.name;d=d.name;return c>d?1:c===d?0:-1})};h.getBaseLevel=function(b){var a,c;const d=null==(a=this.filterFeatures)?void 0:
null==(c=a.levels)?void 0:c.levelsInfo;let e=null;if(b){const {id:f}=b;d&&0<d.length&&d.forEach(g=>{0===g.verticalOrder&&g.facilityId===f&&(e=g)})}return e};h.getFacility=function(b){var a,c,d,e;return null!=(a=null==(c=this.filterFeatures)?void 0:null==(d=c.facilities)?void 0:null==(e=d.facilitiesInfo)?void 0:e.find(f=>f.id===b))?a:null};h.getFacilityLevels=function(b){var a,c;return b&&null!=(a=this.filterFeatures)&&null!=(c=a.levels)&&c.levelsInfo?this.filterFeatures.levels.levelsInfo.filter(d=>
d.facilityId===b).sort((d,e)=>{d=d.verticalOrder;e=e.verticalOrder;return d>e?-1:d===e?0:1}):[]};h.getLevel=function(b){var a,c,d,e;return null!=(a=null==(c=this.filterFeatures)?void 0:null==(d=c.levels)?void 0:null==(e=d.levelsInfo)?void 0:e.find(f=>f.id===b))?a:null};h.getSite=function(b){var a,c,d,e;return null!=(a=null==(c=this.filterFeatures)?void 0:null==(d=c.sites)?void 0:null==(e=d.sitesInfo)?void 0:e.find(f=>f.id===b))?a:null};h.goTo=function(b){var {view:a}=this;a&&b&&({geometry:b}=b,b&&
b.extent&&(a={duration:X.Milliseconds(1E3),easing:"out-back"},this.callGoTo({target:b.extent,options:a})))};h.setFloors=function(b){var a,c,d;null==(a=this.view)?void 0:null==(c=a.map)?void 0:null==(d=c.allLayers)?void 0:d.forEach(e=>{"feature"===e.type&&this._computeViewAllModeFloors(e)});this.view.floors=new Q(this._computeFloors(b))};h.updateWebDocument=function(b){if("esri.WebMap"===b.declaredClass){var a,c,d;const e=new aa({enabled:this.enabled,longNames:this.longNames,minimized:this.minimized,
pinnedLevels:this.pinnedLevels,site:null!=(a=this.site)?a:null,facility:null!=(c=this.facility)?c:null,level:null!=(d=this.level)?d:null});b.widgets?b.widgets.floorFilter=e:b.widgets=new Z({floorFilter:e})}};h._computeFloors=function(b){if("single-floor"===this.filterMode)this._computeSingleFloor(b);else if("base-floors"===this.filterMode)return"3d"===this.view.type?this._computeBaseFloors3D(b):this._computeBaseFloors(b);return this._computeEmptyFloors()};h._computeSingleFloor=function(b){if(!b)return this._computeEmptyFloors();
const a=[];"all"===(null==b?void 0:b.id)?this.getFacilityLevels(b.facilityId).forEach(c=>{c.id&&a.push(c.id)}):b&&a.push(b.id);return a};h._computeBaseFloors=function(b){var a,c;const d=null==(a=this.filterFeatures)?void 0:null==(c=a.levels)?void 0:c.levelsInfo;if(!d||!d.length)return this._computeEmptyFloors();const e=[];"all"===(null==b?void 0:b.id)?this.getFacilityLevels(b.facilityId).forEach(g=>{g.id&&e.push(g.id)}):b&&e.push(b.id);const f=null==b?void 0:b.facilityId;d.forEach(g=>{const {id:k,
facilityId:t,verticalOrder:q}=g;f||0!==q||e.includes(k)?t===f||0!==q||e.includes(k)||e.push(k):e.push(k)});return e};h._computeBaseFloors3D=function(b){var a,c;const d=null==(a=this.filterFeatures)?void 0:null==(c=a.levels)?void 0:c.levelsInfo;if(!d||!d.length)return this._computeEmptyFloors();const e=[];a=null==b?void 0:b.id.split("--");1<(null==a?void 0:a.length)&&"all"===a[0]?this.getFacilityLevels(b.facilityId).forEach(g=>{g.id&&e.push(g.id)}):b&&e.push(b.id);const f=null==b?void 0:b.facilityId;
d.forEach(g=>{const {id:k,facilityId:t}=g;f||e.includes(k)?t===f||e.includes(k)||e.push(k):e.push(k)});return e};h._computeEmptyFloors=function(){return[]};h._setFilterLayers=function(){var b=x._asyncToGenerator(function*(){var {view:a}=this;if(!this._isOverridden("filterLayers")){if("esri.WebMap"!==a.map.declaredClass&&"esri.WebScene"!==a.map.declaredClass)throw new V("Map must be a webmap or webscene");{var c;a=a.map;const J=null==a?void 0:a.allLayers;if(0<(null==J?void 0:null==(c=J.items)?void 0:
c.length)){var d,e,f,g,k,t,q,p,r,u,A,y;const B={siteLayer:null,facilityLayer:null,levelLayer:null},M=null==(d=a.floorInfo)?void 0:null==(e=d.siteLayer)?void 0:e.layerId,N=null==(f=a.floorInfo)?void 0:null==(g=f.facilityLayer)?void 0:g.layerId,O=null==(k=a.floorInfo)?void 0:null==(t=k.levelLayer)?void 0:t.layerId;c=(null==(q=a.floorInfo)?void 0:null==(p=q.siteLayer)?void 0:p.sublayerId)||(null==(r=a.floorInfo)?void 0:null==(u=r.facilityLayer)?void 0:u.sublayerId)||(null==(A=a.floorInfo)?void 0:null==
(y=A.levelLayer)?void 0:y.sublayerId);if(N&&O){q=J.items.filter(w=>"feature"===w.type||"scene"===w.type);p=J.items.filter(w=>"map-image"===w.type);if(0<(null==p?void 0:p.length)&&c){var v,C,D,E,F,T;yield Promise.all(p.map(z=>z.load()));const w=null==(v=a.floorInfo)?void 0:null==(C=v.siteLayer)?void 0:C.sublayerId,G=null==(D=a.floorInfo)?void 0:null==(E=D.facilityLayer)?void 0:E.sublayerId,ca=null==(F=a.floorInfo)?void 0:null==(T=F.levelLayer)?void 0:T.sublayerId;p.forEach(z=>{const K=z.id;z=null==
z?void 0:z.allSublayers;const U=null==z?void 0:z.items;(K===M||K===N||K===O)&&0<(null==U?void 0:U.length)&&z.items.forEach(L=>{const P=L.id;K===M&&P===w?B.siteLayer=L:P===G?B.facilityLayer=L:P===ca&&(B.levelLayer=L)})})}0<(null==q?void 0:q.length)&&q.forEach(w=>{const G=w.id;G===M?B.siteLayer=w:G===N?B.facilityLayer=w:G===O&&(B.levelLayer=w)});this.filterLayers=B}}}}});return function(){return b.apply(this,arguments)}}();h._getFilterFeatures=function(){var b=x._asyncToGenerator(function*(){if(this._isOverridden("filterFeatures"))return Promise.resolve(this.filterFeatures);
const a={sites:null,facilities:null,levels:null};var c=yield this._getSites();a.sites=c;c=yield this._getFacilities();a.facilities=c;c=yield this._getLevels();a.levels=c;return a});return function(){return b.apply(this,arguments)}}();h._getSites=function(){var b=x._asyncToGenerator(function*(){var a,c;const {filterLayers:d,view:e}=this;var f=e.map;const {siteLayer:g}=d,k={sitesInfo:[]};if(!g||null==f||null==(a=f.floorInfo)||!a.siteLayer)return k;a=g.createQuery();a.where="1\x3d1";a.returnGeometry=
!0;a.outFields=["*"];a.returnZ=!0;"type"in g&&"scene"===g.type&&(a.multipatchOption="xyFootprint");const {siteIdField:t,nameField:q}=f.floorInfo.siteLayer;f=yield g.queryFeatures(a);0<(null==f?void 0:null==(c=f.features)?void 0:c.length)&&f.features.forEach(p=>{var r=p.attributes;p=p.geometry;const u=r[t];r=r[q];u&&r&&k.sitesInfo.push({id:u,name:r,geometry:p})});return k});return function(){return b.apply(this,arguments)}}();h._getFacilities=function(){var b=x._asyncToGenerator(function*(){var a,
c;const {filterLayers:d,view:e}=this;var f=e.map;const {facilityLayer:g}=d,k={facilitiesInfo:[]};if(!g||null==f||null==(a=f.floorInfo)||!a.facilityLayer)return k;a=g.createQuery();a.where="1\x3d1";a.returnGeometry=!0;a.outFields=["*"];a.returnZ=!0;"type"in g&&"scene"===g.type&&(a.multipatchOption="xyFootprint");const {facilityIdField:t,siteIdField:q,nameField:p}=f.floorInfo.facilityLayer;f=yield g.queryFeatures(a);0<(null==f?void 0:null==(c=f.features)?void 0:c.length)&&f.features.forEach(r=>{var u=
r.attributes;r=r.geometry;const A=u[t],y=u[q];u=u[p];A&&u&&k.facilitiesInfo.push({id:A,siteId:y,name:u,geometry:r})});return k});return function(){return b.apply(this,arguments)}}();h._getLevels=function(){var b=x._asyncToGenerator(function*(){var a,c;const {filterLayers:d,view:e}=this;var f=e.map;const {levelLayer:g}=d,k={levelsInfo:[]};if(!g||null==f||null==(a=f.floorInfo)||!a.levelLayer)return k;a=g.createQuery();a.where="1\x3d1";a.returnGeometry=!0;a.outFields=["*"];a.returnZ=!0;const {levelIdField:t,
facilityIdField:q,longNameField:p,shortNameField:r,levelNumberField:u,verticalOrderField:A}=f.floorInfo.levelLayer;f=yield g.queryFeatures(a);0<(null==f?void 0:null==(c=f.features)?void 0:c.length)&&f.features.forEach(y=>{var v=y.attributes;y=v[t];const C=v[q],D=v[p],E=v[r],F=v[u];v=v[A];y&&C&&D&&E&&"number"===typeof F&&"number"===typeof v&&k.levelsInfo.push({id:y,facilityId:C,longName:D,shortName:E,levelNumber:F,verticalOrder:v})});return k});return function(){return b.apply(this,arguments)}}();
h._registerWidget=function(b){(null==b?0:b.persistableViewModels.some(a=>a===this))||(null==b?void 0:b.persistableViewModels.add(this))};h._unregisterWidget=function(b){null==b?void 0:b.persistableViewModels.remove(this)};h._setInitialViewState=function(){var b=x._asyncToGenerator(function*(){this.view&&(yield this._setFilterLayers(),this._getFilterFeatures().then(a=>{a&&(this.filterFeatures=a,this.hasFacilities&&this.hasLevels?(this.hasMultipleSites||(this.filterMenuType="facility"),this.view.when().then(()=>
{if(this.facility&&this.level){this.filterMenuType="facility";var c=this.getFacility(this.facility),d=this.getLevel(this.level);this.setFloors(d);this.goTo(c)}else this.facility&&!this.level?(this.filterMenuType="facility",c=this.getFacility(this.facility),d=this.getBaseLevel(c),this.site||(this.site=c.siteId||void 0),this.level=(null==d?void 0:d.id)||void 0,this.setFloors(d),this.goTo(c)):!this.facility&&this.level?(this.filterMenuType="facility",c=this.getLevel(this.level),d=this.getFacility(null==
c?void 0:c.facilityId),this.facility=(null==d?void 0:d.id)||void 0,this.site||(this.site=(null==d?void 0:d.siteId)||void 0),this.setFloors(c),this.goTo(d)):!this.site||this.facility||this.level?this.setFloors(null):(this.filterMenuType="site",c=this.getSite(this.site),this.setFloors(null),this.goTo(c))})):console.error("Facilities and Levels are required for the Floor Filter widget"))}).catch(a=>{console.error("Couldn't retrieve sites, facilities, and levels",a)}))});return function(){return b.apply(this,
arguments)}}();h._callOverride=function(b,a){this._override(b,a)};h._updateFloorFilterFromMap=function(){var b=x._asyncToGenerator(function*(a){var c;a&&"esri.WebMap"===a.declaredClass&&(a=null==a?void 0:null==(c=a.widgets)?void 0:c.floorFilter)&&(this._isOverridden("enabled")||(this.enabled=a.enabled),this._isOverridden("longNames")||(this.longNames=a.longNames),this._isOverridden("minimized")||(this.minimized=a.minimized),this._isOverridden("pinnedLevels")||(this.pinnedLevels=a.pinnedLevels),this._isOverridden("site")||
(this.site=a.site),this._isOverridden("facility")||(this.facility=a.facility),this._isOverridden("level")||(this.level=a.level))});return function(a){return b.apply(this,arguments)}}();h._computeViewAllModeFloors=function(b){var a;const {filterFeatures:c}=this;if(null!=(a=b.floorInfo)&&a.viewAllMode&&this.hasLevels&&this.hasFacilities&&"base-floors"===this.filterMode){const {level:d,facility:e}=this,f=[];c.levels.levelsInfo.forEach(g=>{const {id:k,facilityId:t}=g;e&&t===e?d&&k===d&&f.push(k):f.push(k)});
b.floorInfo.viewAllLevelIds=new Q(f)}};x._createClass(I,[{key:"enabled",set:function(b){this._callOverride("enabled",b)}},{key:"facility",set:function(b){if(b&&this._isOverridden("facility")){const a=this.getFacility(b);this.hasMultipleSites&&(this.site=(null==a?void 0:a.siteId)||void 0)}this._callOverride("facility",b)}},{key:"filterFeatures",set:function(b){this._callOverride("filterFeatures",b)}},{key:"filterLayers",set:function(b){this._callOverride("filterLayers",b)}},{key:"hasFacilities",get:function(){var b,
a,c,d;return(null==(b=this.filterLayers)?void 0:b.facilityLayer)&&0<(null==(a=this.filterFeatures)?void 0:null==(c=a.facilities)?void 0:null==(d=c.facilitiesInfo)?void 0:d.length)}},{key:"hasLevels",get:function(){var b,a,c,d;return(null==(b=this.filterLayers)?void 0:b.levelLayer)&&0<(null==(a=this.filterFeatures)?void 0:null==(c=a.levels)?void 0:null==(d=c.levelsInfo)?void 0:d.length)}},{key:"hasMultipleSites",get:function(){var b,a,c,d;return(null==(b=this.filterLayers)?void 0:b.siteLayer)&&1<(null==
(a=this.filterFeatures)?void 0:null==(c=a.sites)?void 0:null==(d=c.sitesInfo)?void 0:d.length)}},{key:"isNormalMode",get:function(){let b=!0;const a=this._viewWidthBreakpoint,c=this._viewHeightBreakpoint;if("small"===a||"xsmall"===a||"small"===c||"xsmall"===c)b=!1;return b}},{key:"level",set:function(b){if(b){var a=null,c=null;a=null==b?void 0:b.split("--");if(1<(null==a?void 0:a.length)&&"all"===a[0])c=a[1],a={id:b,facilityId:c,shortName:null,longName:null,levelNumber:null,verticalOrder:null};else{var d;
a=this.getLevel(b);c=null==(d=a)?void 0:d.facilityId}if(this.level!==b||this.isNormalMode||this.levelsExpanded){if(a&&this.hasFacilities&&this.hasLevels){this.facility=c;if(this.hasMultipleSites){var e;this.site=null==(e=this.getFacility(c))?void 0:e.siteId}this.setFloors(a)}else this._isOverridden("level")&&(this.site=this.facility=void 0,this.hasMultipleSites&&(this.filterMenuType="site"),this.setFloors(null));this._callOverride("level",b)}else b=this.getFacilityLevels(c),1<(null==b?void 0:b.length)&&
(this.levelsExpanded=!0)}else this._callOverride("level",b),this.site=this.facility=void 0,this.setFloors(null)}},{key:"longNames",set:function(b){this._callOverride("longNames",b)}},{key:"minimized",set:function(b){this._callOverride("minimized",b)}},{key:"pinnedLevels",set:function(b){this._callOverride("pinnedLevels",b)}},{key:"site",set:function(b){this._callOverride("site",b)}},{key:"state",get:function(){return this.view&&this.filterFeatures&&this.hasFacilities&&this.hasLevels?"ready":this.view&&
!this.filterFeatures?"loading":"disabled"}}]);return I}(ba.GoToMixin(l.HandleOwner));m.__decorate([n.property({value:!1})],l.prototype,"enabled",null);m.__decorate([n.property({value:void 0})],l.prototype,"facility",null);m.__decorate([n.property({value:null})],l.prototype,"filterFeatures",null);m.__decorate([n.property({value:null})],l.prototype,"filterLayers",null);m.__decorate([n.property()],l.prototype,"filterMenuOpen",void 0);m.__decorate([n.property()],l.prototype,"filterMenuType",void 0);m.__decorate([n.property()],
l.prototype,"filterMode",void 0);m.__decorate([n.property()],l.prototype,"hasFacilities",null);m.__decorate([n.property()],l.prototype,"hasLevels",null);m.__decorate([n.property()],l.prototype,"hasMultipleSites",null);m.__decorate([n.property({readOnly:!0})],l.prototype,"isNormalMode",null);m.__decorate([n.property({value:void 0})],l.prototype,"level",null);m.__decorate([n.property({value:!1})],l.prototype,"longNames",null);m.__decorate([n.property()],l.prototype,"levelsExpanded",void 0);m.__decorate([n.property({value:!1})],
l.prototype,"minimized",null);m.__decorate([n.property({value:!1})],l.prototype,"pinnedLevels",null);m.__decorate([n.property()],l.prototype,"searchTerm",void 0);m.__decorate([n.property({value:void 0})],l.prototype,"site",null);m.__decorate([n.property({readOnly:!0})],l.prototype,"state",null);m.__decorate([n.property()],l.prototype,"view",void 0);m.__decorate([n.property()],l.prototype,"_viewHeightBreakpoint",void 0);m.__decorate([n.property()],l.prototype,"_viewWidthBreakpoint",void 0);m.__decorate([n.property()],
l.prototype,"updateWebDocument",null);return l=m.__decorate([Y.subclass("esri/widgets/FloorFilter/FloorFilterViewModel")],l)});