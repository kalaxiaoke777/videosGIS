// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.21/esri/copyright.txt for details.
//>>built
define("require exports ../../chunks/_rollupPluginBabelHelpers ../../Graphic ../../core/has ../../core/maybe ../../core/promiseUtils ../../core/screenUtils ../../core/watchUtils ../../core/accessorSupport/diffUtils ../../renderers/support/clickToleranceUtils ../../renderers/support/lengthUtils ../../renderers/visualVariables/support/sizeVariableUtils ../../renderers/visualVariables/support/visualVariableUtils ../../symbols/support/symbolConversion ../../symbols/support/symbolUtils ../../views/3d/layers/graphics/GraphicState ../../views/support/drapedUtils ../../views/support/hitTestSelectUtils".split(" "),
function(U,t,p,ba,va,n,y,D,V,ca,da,ea,fa,W,ha,E,ia,ja,ka){function X(b){const a=b.sourceLayer;var c;if(!(c="feature"!==a.type)){a:switch(a.renderer.type){case "class-breaks":case "simple":case "unique-value":case "dot-density":case "dictionary":c=!0;break a;default:c=!1}c=!c}if(c)return{rotation:null,size:null};let e=c=null;var f=a.renderer.getVisualVariablesForType("rotation").filter(d=>(!d.axis||"heading"===d.axis)&&d.field&&!d.valueExpression&&n.isSome(W.getRotationAngle(d,b)));1===f.length&&(c=
la(f[0],a));f=a.renderer.getVisualVariablesForType("size").filter(d=>d.field&&!d.useSymbolValue&&!d.valueExpression&&"real-world-size"===fa.getTransformationType(d)&&n.isSome(W.getSize(d,b)));1===f.length&&(e=ma(f[0],a));return{rotation:c,size:e}}function la(b,a){const c="heading"===(b.axis||"heading")&&"arithmetic"===b.rotationType?-1:1,e=b.field,f=(b=a.fields&&a.fields.filter(g=>g.name===e))&&1===b.length?b[0].type:"double";var d=0,h=0;return{field:e,getDefault:()=>Promise.resolve(0),getValue:g=>
{h=d-c*g;return F((h+360)%360,f)},initValue:g=>{d=null!=g?g:h;h=0},isUpdatingInteractively:!1}}function na(b,a){switch(a){case "width":return b[0];case "depth":return b[1];case "height":return b[2];default:return b[2]||b[1]||b[0]}}function oa(b,a,c){return G.apply(this,arguments)}function G(){G=p._asyncToGenerator(function*(b,a,c){if(n.isNone(a))return 0;({symbol:a}=ha.to3D(a));if(n.isNone(a)||"web-style"===a.type)return 0;a=a.symbolLayers.getItemAt(0);if(!a)return 0;switch(a.type){case "icon":return{computeIconLayerResourceSize:c}=
yield new Promise(function(e,f){U(["../../symbols/support/symbolLayerUtils"],e,f)}),a.size||Math.min(x.icon,(yield c(a,x.icon))[0])||x.icon;case "text":return a.size||x.text;case "line":return a.size||x.line;case "object":{const {computeObjectLayerResourceSize:e}=yield new Promise(function(f,d){U(["../../symbols/support/symbolLayerUtils"],f,d)});b=yield e(a,b.scale/x.viewScaleSizeFactor);return na(b,c)}case "path":return(null!=a.width?a.width:a.height)||b.scale/x.viewScaleSizeFactor;case "extrude":return a.size||
b.scale/x.viewScaleSizeFactor;case "fill":case "water":return 0;default:return 0}});return G.apply(this,arguments)}function ma(b,a){const c=b.field,e=b.axis,f=(a=a.fields&&a.fields.filter(k=>k.name===c))&&1===a.length?a[0].type:"double";var d=0,h=0;const g=ea.meterIn[b.valueUnit];let l;l="area"===b.valueRepresentation?k=>(k*g/2)**2*Math.PI:"radius"===b.valueRepresentation||"distance"===b.valueRepresentation?k=>k*g/2:k=>k*g;return{field:c,getDefault:function(){var k=p._asyncToGenerator(function*(m,
v){return F(l(yield oa(v,m,e)),f)});return function(m,v){return k.apply(this,arguments)}}(),getValue:(k,m)=>{d||(d=m.pixelSizeAt(m.center));h=d*k;return F(h,f)},initValue:k=>{d=null!=k?k:h;h=0},isUpdatingInteractively:!1}}function F(b,a){switch(a){case "small-integer":case "integer":case "long":return Math.round(b);case "double":case "single":return b;default:return 0}}function z(b){return H.apply(this,arguments)}function H(){H=p._asyncToGenerator(function*(b){const a=yield E.getDisplayedSymbol(b,
{useSourceLayer:!0,ignoreGraphicSymbol:!0}),c=ca.diff(b.symbol,a);n.isSome(c)&&(b.symbol=a)});return H.apply(this,arguments)}function pa(b){if("mesh"===b||"multipatch"===b)throw Error("Mesh and Multipatch not supported");return b}function I(){I=p._asyncToGenerator(function*(b,a,c){yield J(b,a);const e=b.on("create",function(){var f=p._asyncToGenerator(function*(d){if("cancel"===d.state)return J(b,a);"complete"===d.state&&(d=d.graphic,d.sourceLayer||(d.sourceLayer=a.layer),d.attributes||(d.attributes=
{...a.template.prototype.attributes}),yield z(d),c(d))});return function(d){return f.apply(this,arguments)}}());return{remove:()=>{e.remove();b.cancel()}}});return I.apply(this,arguments)}function J(b,a){return K.apply(this,arguments)}function K(){K=p._asyncToGenerator(function*(b,a){const c=a.layer;a={...a.template.prototype.attributes};yield qa(b,c,a);a={graphicProperties:{attributes:a,sourceLayer:c},hasZ:c.capabilities.data.supportsZ};b.layer.elevationInfo=c.elevationInfo;return b.create(pa(c.geometryType),
a)});return K.apply(this,arguments)}function qa(b,a,c){return L.apply(this,arguments)}function L(){L=p._asyncToGenerator(function*(b,a,c){var e;if("3d"===b.view.type){a=new ba({sourceLayer:a,attributes:c});var {rotation:f,size:d}=X(a),h=yield E.getDisplayedSymbol(a,{useSourceLayer:!0}),g=!1;for(const l of[d,f])n.isNone(l)||null!=c[l.field]||(c[l.field]=yield l.getDefault(h,b.view),g=!0);g&&(h=yield E.getDisplayedSymbol(a,{useSourceLayer:!0}));switch(null==(e=h)?void 0:e.type){case "simple-fill":case "polygon-3d":b.polygonSymbol=
h;break;case "simple-line":case "line-3d":b.polylineSymbol=h;break;case "simple-marker":case "point-3d":b.pointSymbol=h}}});return L.apply(this,arguments)}function ra(b,a,c,e){return M.apply(this,arguments)}function M(){M=p._asyncToGenerator(function*(b,a,c,e){if(0===b.length)return[];const {updatable:f,graphicsByLayer:d}=yield c.async(p._asyncToGenerator(function*(){var {results:h}=yield y.whenOrAbort(ka.hitTestSelectSameDistance(a,c),e);const g=new Map,l=({layer:k})=>{var m=g.get(k);return m?m:
(m=[],g.set(k,m),m)};h.forEach(({graphic:k})=>l(k).push(k));h=b.filter(({supports:k,layer:m})=>-1<k.indexOf("update")&&g.has(m));0!==h.length&&c.stopPropagation();return{updatable:h,graphicsByLayer:g}}));return y.whenOrAbort(y.eachAlways(f.map(function(){var h=p._asyncToGenerator(function*({layer:g}){const {objectIdField:l,displayField:k}=g,m=[l];g.fieldsIndex.has(k)&&m.push(k);const v=d.get(g);if(v.some(u=>m.some(w=>!(w in u.attributes)))){const u=g.createQuery();u.outFields=m;u.returnGeometry=!1;
u.objectIds=v.map(w=>w.getObjectId());return g.queryFeatures(u,{signal:e}).then(({features:w})=>w)}return v});return function(g){return h.apply(this,arguments)}}())),e)});return M.apply(this,arguments)}function sa(b,a,c,e){return N.apply(this,arguments)}function N(){N=p._asyncToGenerator(function*(b,a,c,e){if(0===b.length)return[];const f=yield c.async(p._asyncToGenerator(function*(){var {results:d}=yield y.whenOrAbort(a.hitTest(c),e);if(0===d.length)return[];const h=new Set;d.forEach(({graphic:g})=>
h.add(g.layer));d=b.items.filter(({layer:g,supports:l})=>-1<l.indexOf("update")&&h.has(g));0<d.length&&c.stopPropagation();return d}));return y.whenOrAbort(y.eachAlways(f.map(({layer:d})=>{const {objectIdField:h,displayField:g}=d;var l=[h];d.fieldsIndex.has(g)&&l.push(g);const k=d.createQuery();k.outFields=l;k.returnGeometry=!1;l="renderer"in d?da.calculateTolerance({renderer:d.renderer,event:c}):0;k.geometry=ja.createQueryGeometry(c.mapPoint,l,a);k.outSpatialReference=a.spatialReference;return d.queryFeatures(k,
{signal:e}).then(({features:m})=>m)})),e)});return N.apply(this,arguments)}function O(){O=p._asyncToGenerator(function*(b,a,c,e){switch(a.type){case "3d":return ra(b,a,c,e);case "2d":return sa(b,a,c,e)}});return O.apply(this,arguments)}function P(){P=p._asyncToGenerator(function*(b,a,c){const e=b.layer,f=e.createQuery();f.objectIds=[b.getAttribute(e.objectIdField)];f.outFields=["*"];f.outSpatialReference=a.spatialReference;f.returnM=e.capabilities.data.supportsM;f.returnZ=e.capabilities.data.supportsZ;
return(yield e.queryFeatures(f,{signal:c})).features[0]});return P.apply(this,arguments)}function Q(b,a,c,e){return R.apply(this,arguments)}function R(){R=p._asyncToGenerator(function*(b,a,c,e){let f=!1;const {rotation:d,size:h}=e;[d,h].forEach(function(){var g=p._asyncToGenerator(function*(l){if(!n.isNone(l)){var k=a.attributes[l.field];n.isSome(k)?l.initValue(k):(k=yield l.getDefault(a.symbol,b.view),l.initValue(k),a.setAttribute(l.field,k),f=!0)}});return function(l){return g.apply(this,arguments)}}());
f&&"3d"===b.view.type&&(yield z(a));e={multipleSelectionEnabled:!1};"point"===c.geometryType&&(e.enableRotation=n.isSome(d),e.enableScaling=n.isSome(h));b.layer.elevationInfo=c.elevationInfo;return b.update(a,e)});return R.apply(this,arguments)}function Y(b,a,c,e){return S.apply(this,arguments)}function S(){S=p._asyncToGenerator(function*(b,a,c,e){var f;if(n.isSome(a.geometry)&&"point"===(null==(f=a.geometry)?void 0:f.type)){f=e.rotation;var d=c.toolEventInfo;d=!d||"rotate-start"!==d.type&&"rotate"!==
d.type&&"rotate-stop"!==d.type?null:d;if(n.isSome(f)&&n.isSome(d))if("rotate-stop"===d.type)f.isUpdatingInteractively=!1,f.initValue();else{f.isUpdatingInteractively=!0;const {field:h,getValue:g}=f;a.attributes[h]=g(d.angle,b)}e=e.size;c=c.toolEventInfo;c=!c||"scale-start"!==c.type&&"scale"!==c.type&&"scale-stop"!==c.type?null:c;if(n.isSome(e)&&n.isSome(c))if("scale-stop"===c.type)e.isUpdatingInteractively=!1,e.initValue();else{e.isUpdatingInteractively=!0;const {field:h,getValue:g}=e;a.attributes[h]=
g(c.xScale,b)}"3d"===b.type&&(yield z(a))}});return S.apply(this,arguments)}function T(){T=p._asyncToGenerator(function*(b,a,c,e,f){const d=b.clone();yield z(d);e.map.add(c.layer);c.layer.add(d);const h=b.sourceLayer,g=e.whenLayerView(h),l=()=>{const r=b.attributes[b.layer.objectIdField];g.then(q=>q.setVisibility(r,!1),()=>{});return{remove(){g.then(q=>q.setVisibility(r,!0),()=>{})}}};let k=null,m=null;if("3d"===e.type){const r=new ia.GraphicState({graphic:d});k=e.trackGraphicState(r);V.init(r,"displaying",
q=>{m=q?l():n.removeMaybe(m)})}else m=l();yield Q(c,d,h,a);let v=null;g.then(r=>v=r,()=>{});const u=a.size,w=a.rotation,Z=b.watch("attributes",function(){var r=p._asyncToGenerator(function*(q){let A=!1;for(const B in q){const C=q[B];C!==d.attributes[B]&&(d.setAttribute(B,C),n.isSome(u)&&!u.isUpdatingInteractively&&u.field===B&&u.initValue(C),n.isSome(w)&&!w.isUpdatingInteractively&&w.field===B&&w.initValue(C),n.isNone(v)||v.requiredFields.includes(B))&&(A=!0)}A&&"3d"===e.type&&(yield z(d))});return function(q){return r.apply(this,
arguments)}}()),ta=c.on("update",function(){var r=p._asyncToGenerator(function*(q){const A=q.graphics[0];if("complete"===q.state)return Q(c,A,h,a);yield Y(e,A,q,a);f(A.clone())});return function(q){return r.apply(this,arguments)}}()),ua=c.on(["undo","redo"],function(){var r=p._asyncToGenerator(function*(q){f(q.graphics[0].clone())});return function(q){return r.apply(this,arguments)}}()),aa=()=>{};return{interactive:{remove(){ua.remove();ta.remove();c.cancel();Z&&Z.remove();this.remove=aa}},visual:{remove(){n.removeMaybe(m);
e.whenLayerView(h).then(r=>V.whenFalseOnce(r,"updating")).then(()=>{n.removeMaybe(k);c.layer.remove(d);this.remove=aa})}}}});return T.apply(this,arguments)}const x={icon:D.px2pt(24),text:D.px2pt(12),line:D.px2pt(1),viewScaleSizeFactor:100};t.avoidFeatureTemplateSelectionWithOnlyOneItem=function(b,a){b.viewModel.refreshCreationTemplates();if("awaiting-feature-creation-info"===a[0].id){var c=b.viewModel.featureTemplatesViewModel.items;1!==c.length?c=null:(c=c[0],c="items"in c?1===c.items.length?c.items[0]:
null:c);n.isSome(c)&&(b.creationInfo={layer:c.layer,template:c.template},a.shift())}return a};t.createWorkflowSteps=function(b,a,c){let e=!1;return b.filter(f=>e?!0:e=f===a).map(f=>c[f]())};t.fetchCandidates=function(b,a,c,e){return O.apply(this,arguments)};t.fetchFullFeature=function(b,a,c){return P.apply(this,arguments)};t.findLayerInfo=function(b,a){return b&&b.find(c=>c.layer===a)};t.getVisualVariableAttributes=X;t.setUpFeatureAdd=function(b,a,c){return I.apply(this,arguments)};t.setUpGeometryUpdate=
function(b,a,c,e,f){return T.apply(this,arguments)};t.sizeDefaults=x;t.startCreatingNewFeature=J;t.startUpdatingFeature=Q;t.updateGraphicSymbolWhenRequired=z;t.visualVariableInteractiveUpdate=Y;Object.defineProperty(t,"__esModule",{value:!0})});