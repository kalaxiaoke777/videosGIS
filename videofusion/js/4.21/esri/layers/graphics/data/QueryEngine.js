// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.21/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../core/Error ../../../core/lang ../../../core/maybe ../../../core/MemCache ../../../core/unitUtils ../../../geometry/support/aaBoundingBox ../../../geometry/support/aaBoundingRect ../../../geometry/support/boundsUtils ../../../geometry/support/jsonUtils ../../../geometry/support/normalizeUtils ../../../geometry/support/spatialReferenceUtils ./attributeSupport ./projectionSupport ./QueryEngineCapabilities ./QueryEngineResult ./spatialQuerySupport ./timeSupport ./utils ../../support/FieldsIndex ../../support/PromiseQueue ../../../support/arcadeOnDemand".split(" "),
function(K,m,w,A,L,R,M,D,N,T,G,S,O,x,B,U,v,C,V,p,W,X,Y){function Z(y){return y.every(l=>"exceedslimit"!==l.statisticType)}const H=new Set,aa=new R.MemCacheStorage(2E6);let ba=0,ea=function(){function y(e){this.capabilities={query:U.queryCapabilities};this.geometryType=e.geometryType;this.hasM=e.hasM;this.hasZ=e.hasZ;this.objectIdField=e.objectIdField;this.spatialReference=e.spatialReference;this.definitionExpression=e.definitionExpression;this.featureStore=e.featureStore;this.aggregateAdapter=e.aggregateAdapter;
this._changeHandle=this.featureStore.events.on("changed",()=>this.clearCache());this.timeInfo=e.timeInfo;e.cacheSpatialQueries&&(this._geometryQueryCache=new R.MemCache(ba++ +"$$",aa));this.fieldsIndex=new W(e.fields);e.scheduler&&e.priority&&(this._frameQueue=new X,this._frameTask=e.scheduler.registerTask(e.priority,this))}var l=y.prototype;l.destroy=function(){this._frameTask&&(this._frameTask.remove(),this._frameTask=null,this._frameQueue.cancelAll(),this._frameQueue=null);this.clearCache();this._geometryQueryCache&&
this._geometryQueryCache.destroy();this._changeHandle&&(this._changeHandle.remove(),this._changeHandle=null);this.fieldsIndex.destroy()};l.clearCache=function(){this._geometryQueryCache&&this._geometryQueryCache.clear();this._timeExtent=this._allItems=null};l.executeQuery=function(){var e=m._asyncToGenerator(function*(a={},b){let c=A.clone(a),d;try{c=yield this._schedule(()=>p.normalizeQuery(c,this.definitionExpression,this.spatialReference),b),c=yield this._reschedule(()=>this._checkQuerySupport(c),
b),d=yield this._reschedule(()=>this._executeGeometryQuery(c,b),b),d=yield this._reschedule(()=>d.executeAggregateIdsQuery(c),b),d=yield this._reschedule(()=>d.executeObjectIdsQuery(c),b),d=yield this._reschedule(()=>d.executeTimeQuery(c),b),d=yield this._reschedule(()=>d.executeAttributesQuery(c),b)}catch(g){if(g!==p.QUERY_ENGINE_EMPTY_RESULT)throw g;d=new v([],null,this)}return d.createQueryResponse(c)});return function(){return e.apply(this,arguments)}}();l.executeQueryForCount=function(){var e=
m._asyncToGenerator(function*(a={},b){let c=A.clone(a),d;c.returnGeometry=!1;c.returnCentroid=!1;c.outSR=null;try{c=yield this._schedule(()=>p.normalizeQuery(c,this.definitionExpression,this.spatialReference),b),c=yield this._reschedule(()=>this._checkQuerySupport(c),b),d=yield this._reschedule(()=>this._executeGeometryQuery(c,b),b),d=yield this._reschedule(()=>d.executeAggregateIdsQuery(c),b),d=yield this._reschedule(()=>d.executeObjectIdsQuery(c),b),d=yield this._reschedule(()=>d.executeTimeQuery(c),
b),d=yield this._reschedule(()=>d.executeAttributesQuery(c),b)}catch(g){if(g!==p.QUERY_ENGINE_EMPTY_RESULT)throw g;return 0}return d.createQueryResponseForCount(c)});return function(){return e.apply(this,arguments)}}();l.executeQueryForExtent=function(){var e=m._asyncToGenerator(function*(a={},b){let c=A.clone(a),d;a=c.outSR;try{c=yield this._schedule(()=>p.normalizeQuery(c,this.definitionExpression,this.spatialReference),b);c=yield this._reschedule(()=>this._checkQuerySupport(c),b);c.returnGeometry=
!0;c.returnCentroid=!1;c.outSR=null;d=yield this._reschedule(()=>this._executeGeometryQuery(c,b),b);d=yield this._reschedule(()=>d.executeAggregateIdsQuery(c),b);d=yield this._reschedule(()=>d.executeObjectIdsQuery(c),b);d=yield this._reschedule(()=>d.executeTimeQuery(c),b);d=yield this._reschedule(()=>d.executeAttributesQuery(c),b);const g=d.size;if(!g)return{count:g,extent:null};D.set(u,D.NEGATIVE_INFINITY);this.featureStore.forEachBounds(d.items,h=>D.expandWithAABB(u,h),ca);const k={xmin:u[0],
ymin:u[1],xmax:u[3],ymax:u[4],spatialReference:p.cleanFromGeometryEngine(this.spatialReference)};this.hasZ&&isFinite(u[2])&&isFinite(u[5])&&(k.zmin=u[2],k.zmax=u[5]);const f=B.project(k,d.spatialReference,a);f.spatialReference=p.cleanFromGeometryEngine(a||this.spatialReference);if(0===f.xmax-f.xmin){const h=M.getMetersPerUnitForSR(f.spatialReference);f.xmin-=h;f.xmax+=h}if(0===f.ymax-f.ymin){const h=M.getMetersPerUnitForSR(f.spatialReference);f.ymin-=h;f.ymax+=h}if(this.hasZ&&null!=f.zmin&&null!=
f.zmax&&0===f.zmax-f.zmin){const h=M.getMetersPerUnitForSR(f.spatialReference);f.zmin-=h;f.zmax+=h}return{count:g,extent:f}}catch(g){if(g===p.QUERY_ENGINE_EMPTY_RESULT)return{count:0,extent:null};throw g;}});return function(){return e.apply(this,arguments)}}();l.executeQueryForIds=function(){var e=m._asyncToGenerator(function*(a={},b){return this.executeQueryForIdSet(a,b).then(c=>Array.from(c))});return function(){return e.apply(this,arguments)}}();l.executeQueryForIdSet=function(){var e=m._asyncToGenerator(function*(a=
{},b){let c=A.clone(a),d;c.returnGeometry=!1;c.returnCentroid=!1;c.outSR=null;try{c=yield this._schedule(()=>p.normalizeQuery(c,this.definitionExpression,this.spatialReference),b);c=yield this._reschedule(()=>this._checkQuerySupport(c),b);d=yield this._reschedule(()=>this._executeGeometryQuery(c,b),b);d=yield this._reschedule(()=>d.executeAggregateIdsQuery(c),b);d=yield this._reschedule(()=>d.executeObjectIdsQuery(c),b);d=yield this._reschedule(()=>d.executeTimeQuery(c),b);d=yield this._reschedule(()=>
d.executeAttributesQuery(c),b);const g=d.items,k=new Set;yield this._reschedule(()=>{for(const f of g)k.add(d.featureAdapter.getObjectId(f))},b);return k}catch(g){if(g===p.QUERY_ENGINE_EMPTY_RESULT)return new Set;throw g;}});return function(){return e.apply(this,arguments)}}();l.executeQueryForSnapping=function(){var e=m._asyncToGenerator(function*(a,b){const {point:c,distance:d,types:g}=a;if(0===g)return{candidates:[]};const k=yield this._reschedule(()=>this._checkQuerySupport(a.query),b),f=!O.equals(c.spatialReference,
this.spatialReference);f&&(yield B.checkProjectionSupport(c.spatialReference,this.spatialReference));var h="number"===typeof d?d:d.x,q="number"===typeof d?d:d.y;h={xmin:c.x-h,xmax:c.x+h,ymin:c.y-q,ymax:c.y+q,spatialReference:c.spatialReference};h=f?B.project(h,this.spatialReference):h;if(!h)return{candidates:[]};q=(yield S.normalizeCentralMeridian(G.fromJSON(c),null,{signal:b}))[0];const E=(yield S.normalizeCentralMeridian(G.fromJSON(h),null,{signal:b}))[0];if(L.isNone(q)||L.isNone(E))return{candidates:[]};
let n=new v(this._searchFeatures(this._getQueryBBoxes(E.toJSON())),null,this);n=yield this._reschedule(()=>n.executeObjectIdsQuery(k),b);n=yield this._reschedule(()=>n.executeTimeQuery(k),b);n=yield this._reschedule(()=>n.executeAttributesQuery(k),b);b=q.toJSON();b=f?B.project(b,this.spatialReference):b;return n.createSnappingResponse({...a,point:b,distance:f?Math.max(h.xmax-h.xmin,h.ymax-h.ymin)/2:d},c.spatialReference)});return function(a,b){return e.apply(this,arguments)}}();l.executeQueryForLatestObservations=
function(){var e=m._asyncToGenerator(function*(a={},b){if(!this.timeInfo||!this.timeInfo.trackIdField)throw new w("feature-store:unsupported-query","Missing timeInfo or timeInfo.trackIdField",{query:a,timeInfo:this.timeInfo});let c=A.clone(a),d;try{c=yield this._schedule(()=>p.normalizeQuery(c,this.definitionExpression,this.spatialReference),b),c=yield this._reschedule(()=>this._checkQuerySupport(c),b),d=yield this._reschedule(()=>this._executeGeometryQuery(c,b),b),d=yield this._reschedule(()=>d.executeAggregateIdsQuery(c),
b),d=yield this._reschedule(()=>d.executeObjectIdsQuery(c),b),d=yield this._reschedule(()=>d.executeTimeQuery(c),b),d=yield this._reschedule(()=>d.executeAttributesQuery(c),b),d=yield this._reschedule(()=>d.filterLatest(),b)}catch(g){if(g!==p.QUERY_ENGINE_EMPTY_RESULT)throw g;d=new v([],null,this)}return d.createQueryResponse(c)});return function(){return e.apply(this,arguments)}}();l.executeQueryForSummaryStatistics=function(){var e=m._asyncToGenerator(function*(a={},b,c){a=A.clone(a);let d;try{a=
yield this._schedule(()=>p.normalizeQuery(a,this.definitionExpression,this.spatialReference),c),a=yield this._reschedule(()=>this._checkSummaryStatisticsSupport(a,b),c),d=yield this._reschedule(()=>this._executeGeometryQuery(a,c),c),d=yield this._reschedule(()=>d.executeAggregateIdsQuery(a),c),d=yield this._reschedule(()=>d.executeObjectIdsQuery(a),c),d=yield this._reschedule(()=>d.executeTimeQuery(a),c),d=yield this._reschedule(()=>d.executeAttributesQuery(a),c)}catch(g){if(g!==p.QUERY_ENGINE_EMPTY_RESULT)throw g;
d=new v([],null,this)}return d.createSummaryStatisticsResponse(a,b)});return function(){return e.apply(this,arguments)}}();l._schedule=function(){var e=m._asyncToGenerator(function*(a,b){return this._frameQueue?this._frameQueue.push(a,b):a()});return function(a,b){return e.apply(this,arguments)}}();l._reschedule=function(){var e=m._asyncToGenerator(function*(a,b){return this._frameQueue?this._frameQueue.unshift(a,b):a()});return function(a,b){return e.apply(this,arguments)}}();l.runTask=function(e){for(this._budget=
e;!e.done&&this._frameQueue&&this._frameQueue.process();)e.madeProgress();this._budget=null};l._getAll=function(){if(!this._allItems){const e=[];this.featureStore.forEach(a=>e.push(a));this._allItems=new v(e,null,this)}return this._allItems};l._executeGeometryQuery=function(){var e=m._asyncToGenerator(function*(a,b){var c=this;const {geometry:d,outSR:g,spatialRel:k,returnGeometry:f,returnCentroid:h}=a,q=f||h,E=O.isValid(g)&&!O.equals(this.spatialReference,g),n=this._geometryQueryCache?E&&q?JSON.stringify({geometry:d,
spatialRelationship:k,outSpatialReference:g}):JSON.stringify({geometry:d,spatialRelationship:k}):null;if(n){var r=this._geometryQueryCache.get(n);if(!L.isUndefined(r))return r}r=function(){var z=m._asyncToGenerator(function*(t){if(E&&q)return t=yield t.project(g),n&&c._geometryQueryCache.put(n,t,t.size||1),t;n&&c._geometryQueryCache.put(n,t,t.size||1);return t});return function(t){return z.apply(this,arguments)}}();if(!d)return r(this._getAll());const I=this.featureAdapter;if("esriSpatialRelDisjoint"===
k){a=this._searchFeatures(this._getQueryBBoxes(d));if(!a.length)return r(this._getAll());let z,t;const P=new Set;for(var F of a)P.add(I.getObjectId(F));yield this._reschedule(()=>{let Q=0;z=Array(P.size);this.featureStore.forEach(J=>z[Q++]=J);t=P},b);a=yield this._reschedule(m._asyncToGenerator(function*(){const Q=yield C.getSpatialQueryOperator(k,d,c.geometryType,c.hasZ,c.hasM);return new v(yield c._runSpatialFilter(z,J=>!t.has(I.getObjectId(J))||Q(I.getGeometry(J)),b),d,c)}),b);return r(a)}F=this._searchFeatures(this._getQueryBBoxes(d));
if(!F.length)return r=new v([],d,this),n&&this._geometryQueryCache.put(n,r,r.size||1),r;if(this._canExecuteSoloPass(d,a))return r(new v(F,d,this));const da=yield C.getSpatialQueryOperator(k,d,this.geometryType,this.hasZ,this.hasM);a=yield this._runSpatialFilter(F,z=>da(I.getGeometry(z)),b);return r(new v(a,d,this))});return function(a,b){return e.apply(this,arguments)}}();l._runSpatialFilter=function(){var e=m._asyncToGenerator(function*(a,b,c){var d=this;if(!b)return a;if(!this._budget)return a.filter(h=>
b(h));let g=0;const k=[],f=function(){var h=m._asyncToGenerator(function*(){for(;g<a.length;){const q=a[g];b(q)&&k.push(q);d._budget.done&&(yield d._reschedule(()=>f(),c));++g}});return function(){return h.apply(this,arguments)}}();return this._reschedule(()=>f(),c).then(()=>k)});return function(a,b,c){return e.apply(this,arguments)}}();l._canExecuteSoloPass=function(e,a){const {geometryType:b}=this;({spatialRel:a}=a);return C.canQueryWithRBush(e)&&("esriSpatialRelEnvelopeIntersects"===a||"esriGeometryPoint"===
b&&("esriSpatialRelIntersects"===a||"esriSpatialRelContains"===a||"esriSpatialRelWithin"===a))};l._getQueryBBoxes=function(e){if(C.canQueryWithRBush(e)){if(G.isExtent(e))return[N.fromValues(e.xmin,e.ymin,e.xmax,e.ymax)];if(G.isPolygon(e))return e.rings.map(a=>N.fromValues(Math.min(a[0][0],a[2][0]),Math.min(a[0][1],a[2][1]),Math.max(a[0][0],a[2][0]),Math.max(a[0][1],a[2][1])))}return[T.getBoundsXY(N.create(),e)]};l._searchFeatures=function(e){for(const c of e)this.featureStore.forEachInBounds(c,d=>
{H.add(d)});const a=Array(H.size);let b=0;H.forEach(c=>a[b++]=c);H.clear();return a};l._checkSummaryStatisticsSupport=function(){var e=m._asyncToGenerator(function*(a,b){if(0>a.distance||null!=a.geometryPrecision||a.multipatchOption||a.pixelSize||a.relationParam||a.text||a.outStatistics||a.groupByFieldsForStatistics||a.having||a.orderByFields)throw new w("feature-store:unsupported-query","Unsupported query options",{query:a});return Promise.all([this._checkAttributesQuerySupport(a),this._checkSummaryStatisticsParamsSupport(b),
C.checkSpatialQuerySupport(a,this.geometryType,this.spatialReference),B.checkProjectionSupport(this.spatialReference,a.outSR)]).then(()=>a)});return function(a,b){return e.apply(this,arguments)}}();l._checkSummaryStatisticsParamsSupport=function(){var e=m._asyncToGenerator(function*(a){var b=[];a.valueExpression&&({arcadeUtils:b}=yield Y.loadArcade(),b=b.extractFieldNames(a.valueExpression));a.field&&b.push(a.field);a.normalizationField&&b.push(a.normalizationField);if(!b.length)throw new w("feature-store:unsupported-query",
"params should have at least a field or valueExpression",{params:a});x.validateFields(this.fieldsIndex,b,"params contains missing fields")});return function(a){return e.apply(this,arguments)}}();l._checkQuerySupport=function(){var e=m._asyncToGenerator(function*(a){if(0>a.distance||null!=a.geometryPrecision||a.multipatchOption||a.pixelSize||a.relationParam||a.text)throw new w("feature-store:unsupported-query","Unsupported query options",{query:a});return Promise.all([this._checkAttributesQuerySupport(a),
this._checkStatisticsQuerySupport(a),C.checkSpatialQuerySupport(a,this.geometryType,this.spatialReference),B.checkProjectionSupport(this.spatialReference,a.outSR)]).then(()=>a)});return function(a){return e.apply(this,arguments)}}();l._checkAttributesQuerySupport=function(e){const {outFields:a,orderByFields:b,returnDistinctValues:c,outStatistics:d}=e,g=d?d.map(k=>k.outStatisticFieldName&&k.outStatisticFieldName.toLowerCase()):[];if(b&&0<b.length){const k=b.map(f=>{const h=f.toLowerCase();return-1<
h.indexOf(" asc")?h.split(" asc")[0]:-1<h.indexOf(" desc")?h.split(" desc")[0]:f}).filter(f=>-1===g.indexOf(f));x.validateFields(this.fieldsIndex,k,"orderByFields contains missing fields")}if(a&&0<a.length)x.validateFields(this.fieldsIndex,a,"outFields contains missing fields");else if(c)throw new w("feature-store:unsupported-query","outFields should be specified for returnDistinctValues",{query:e});x.validateWhere(this.fieldsIndex,e.where)};l._checkStatisticsQuerySupport=function(){var e=m._asyncToGenerator(function*(a){const {outStatistics:b,
groupByFieldsForStatistics:c,having:d}=a;var g=c&&c.length,k=b&&b.length;if(d){if(!g||!k)throw new w("feature-store:unsupported-query","outStatistics and groupByFieldsForStatistics should be specified with having",{query:a});x.validateHaving(this.fieldsIndex,d,b)}if(k&&Z(b)){k=b.map(f=>f.onStatisticField);x.validateFields(this.fieldsIndex,k,"onStatisticFields contains missing fields");g&&x.validateFields(this.fieldsIndex,c,"groupByFieldsForStatistics contains missing fields");for(const f of b){const {onStatisticField:h,
statisticType:q}=f;if(("percentile_disc"===q||"percentile_cont"===q)&&"statisticParameters"in f){if({statisticParameters:g}=f,!g)throw new w("feature-store:unsupported-query","statisticParamters should be set for percentile type",{definition:f,query:a});}else if("count"!==q&&h&&x.hasInvalidFieldType(h,this.fieldsIndex))throw new w("feature-store:unsupported-query","outStatistics contains non-numeric fields",{definition:f,query:a});}}});return function(a){return e.apply(this,arguments)}}();m._createClass(y,
[{key:"featureAdapter",get:function(){return this.featureStore.featureAdapter}},{key:"fullExtent",get:function(){const e=this.featureStore.fullBounds;return e?{xmin:e[0],ymin:e[1],xmax:e[2],ymax:e[3],spatialReference:p.cleanFromGeometryEngine(this.spatialReference)}:null}},{key:"timeExtent",get:function(){return this.timeInfo?this._timeExtent?this._timeExtent:this._timeExtent=V.getTimeExtent(this.timeInfo,this.featureStore):null}},{key:"running",get:function(){return 0<this._frameQueue.length}}]);
return y}();const ca=D.create(),u=D.create();K.Feature=function(y,l=null,e,a,b){this.attributes=y;this.geometry=e;this.centroid=a;this.filterFlags=b;this.groupId=-1;this.displayId=l};K["default"]=ea;Object.defineProperty(K,"__esModule",{value:!0})});