// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.21/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../core/maybe ../../../geometry/support/quantizationUtils ../../../geometry/support/spatialReferenceUtils ../featureConversionUtils ./AttributesBuilder ./attributeSupport ./projectionSupport ./timeSupport ./utils ../../support/fieldUtils ../../../smartMapping/statistics/support/utils ../../../support/arcadeOnDemand".split(" "),function(H,F,P,I,U,J,V,N,W,C,Q,D,X){function R(l){return l.substr(24,12)+l.substr(19,4)+l.substr(16,2)+l.substr(14,2)+
l.substr(11,2)+l.substr(9,2)+l.substr(6,2)+l.substr(4,2)+l.substr(2,2)+l.substr(0,2)}function S(l,g,a,b){if(a&&"esriFieldTypeDate"===a.type){const c=(new Date(l)).getTime(),e=(new Date(g)).getTime();if(!isNaN(c)&&!isNaN(e))return b?e-c:c-e}return"number"===typeof l&&"number"===typeof g?b?g-l:l-g:"string"===typeof l&&"string"===typeof g?(l=l.toUpperCase(),g=g.toUpperCase(),!a||"esriFieldTypeGUID"!==a.type&&"esriFieldTypeGlobalID"!==a.type?b=(b?l>g:l<g)?-1:(b?l<g:l>g)?1:0:(a=R(l),g=R(g),b=(b?a>g:a<
g)?-1:(b?a<g:a>g)?1:0),b):b?1:-1}function Y(l,g,a,b,c,e){c-=a;e-=b;l=Math.min(1,Math.max(0,((l-a)*c+(g-b)*e)/(c*c+e*e)));return{x:a+c*l,y:b+e*l}}function Z(l,g){return l?g?4:3:g?3:2}return function(){function l(a,b,c){this.items=a;this.queryGeometry=b;this.definitionExpression=c.definitionExpression;this.geometryType=c.geometryType;this.hasM=c.hasM;this.hasZ=c.hasZ;this.objectIdField=c.objectIdField;this.spatialReference=c.spatialReference;this.fieldsIndex=c.fieldsIndex;this.timeInfo=c.timeInfo;this.featureAdapter=
c.featureAdapter;this.aggregateAdapter=c.aggregateAdapter}var g=l.prototype;g.createQueryResponseForCount=function(a){const b=new J(a,this.featureAdapter,this.fieldsIndex);if(!a.outStatistics)return b.countDistinctValues(this.items);const {groupByFieldsForStatistics:c,having:e}=a;if(null==c||!c.length)return 1;const d=new Map,f=new Map,m=new Set;a=a.outStatistics;for(const h of a){({statisticType:a}=h);a="exceedslimit"!==a?h.onStatisticField:void 0;if(!f.has(a)){var k=[];for(const n of c){const p=
this._getAttributeValues(b,n,d);k.push(p)}f.set(a,this._calculateUniqueValues(k,b.returnDistinctValues))}a=f.get(a);for(const n in a){const {data:p,items:u}=a[n];k=p.join(",");e&&!b.validateItems(u,e)||m.add(k)}}return m.size};g.createQueryResponse=function(a){let b;b=a.outStatistics?a.outStatistics.some(c=>"exceedslimit"===c.statisticType)?this._createExceedsLimitQueryResponse(a):this._createStatisticsQueryResponse(a):this._createFeatureQueryResponse(a);a.returnQueryGeometry&&(I.isValid(a.outSR)&&
!I.equals(this.queryGeometry.spatialReference,a.outSR)?b.queryGeometry=C.cleanFromGeometryEngine({spatialReference:a.outSR,...N.project(this.queryGeometry,this.queryGeometry.spatialReference,a.outSR)}):b.queryGeometry=C.cleanFromGeometryEngine({spatialReference:a.outSR,...this.queryGeometry}));return b};g.createSnappingResponse=function(a,b){const c=this.featureAdapter,e=Z(this.hasZ,this.hasM),{x:d,y:f}=a.point,m="number"===typeof a.distance?a.distance:a.distance.x,k="number"===typeof a.distance?
a.distance:a.distance.y,h={candidates:[]},n="esriGeometryPolygon"===this.geometryType;b=this.getPointCreator(a.point,this.spatialReference,b);for(const v of this.items){var p=c.getGeometry(v);if(F.isNone(p))continue;const {coords:q,lengths:w}=p;if(a.types&1){p=0;for(var u=0;u<w.length;u++){var x=w[u];for(var z=0;z<x;z++,p+=e){var y=q[p],t=q[p+1];if(z!==x-1){const A=q[p+e],B=q[p+e+1],{x:G,y:K}=Y(d,f,y,t,A,B);var r=(d-G)/m;const E=(f-K)/k;r=r*r+E*E;1>=r&&h.candidates.push({type:"edge",objectId:c.getObjectId(v),
distance:Math.sqrt(r),target:b(G,K),start:b(y,t),end:b(A,B)})}}}}if(a.types&2)for(p=n?q.length-e:q.length,u=0;u<p;u+=e)x=q[u],z=q[u+1],y=(d-x)/m,t=(f-z)/k,y=y*y+t*t,1>=y&&h.candidates.push({type:"vertex",objectId:c.getObjectId(v),distance:Math.sqrt(y),target:b(x,z)})}h.candidates.sort((v,q)=>v.distance-q.distance);return h};g.getPointCreator=function(a,b,c){const e=F.isSome(c)&&!I.equals(b,c)?d=>N.project(d,b,c):d=>d;return null!=a.z&&null!=a.m?(d,f)=>e({x:d,y:f,z:a.z,m:a.m}):null!=a.z?(d,f)=>e({x:d,
y:f,z:a.z}):null!=a.m?(d,f)=>e({x:d,y:f,m:a.m}):(d,f)=>e({x:d,y:f})};g.executeAttributesQuery=function(a){var b=V.getWhereClause(a.where,this.fieldsIndex);if(!b)return Promise.resolve(this);if(b.isStandardized){let c=0;const e=[];for(const d of this.items)b.testFeature(d,this.featureAdapter)&&(e[c++]=d);b=new l(e,this.queryGeometry,this);b.definitionExpression=a.where;return Promise.resolve(b)}return Promise.reject(new TypeError("Where clause is not standardized"))};g.executeAggregateIdsQuery=function(a){if(!a.aggregateIds||
!a.aggregateIds.length||F.isNone(this.aggregateAdapter))return Promise.resolve(this);const b=new Set;for(const e of a.aggregateIds)this.aggregateAdapter.getFeatureObjectIds(e).forEach(d=>b.add(d));const c=this.featureAdapter.getObjectId;return Promise.resolve(new l(this.items.filter(e=>b.has(c(e))),this.queryGeometry,this))};g.executeObjectIdsQuery=function(a){if(!a.objectIds||!a.objectIds.length)return Promise.resolve(this);const b=new Set(a.objectIds),c=this.featureAdapter.getObjectId;return Promise.resolve(new l(this.items.filter(e=>
b.has(c(e))),this.queryGeometry,this))};g.executeTimeQuery=function(a){a=W.getTimeOperator(this.timeInfo,a.timeExtent,this.featureAdapter);if(!F.isSome(a))return Promise.resolve(this);a=this.items.filter(a);return Promise.resolve(new l(a,this.queryGeometry,this))};g.filterLatest=function(){const {trackIdField:a,startTimeField:b,endTimeField:c}=this.timeInfo;var e=c||b;const d=new Map,f=this.featureAdapter.getAttribute;for(const m of this.items){const k=f(m,a),h=f(m,e),n=d.get(k);(!n||h>f(n,e))&&d.set(k,
m)}e=Array.from(d.values());return Promise.resolve(new l(e,this.queryGeometry,this))};g.project=function(){var a=H._asyncToGenerator(function*(b){if(!b||I.equals(this.spatialReference,b))return this;const c=this.featureAdapter,e=(yield N.projectMany(this.items.map(d=>C.getGeometry(this.geometryType,this.hasZ,this.hasM,c.getGeometry(d))),this.spatialReference,b)).map((d,f)=>c.cloneWithGeometry(this.items[f],U.convertFromGeometry(d,this.hasZ,this.hasM)));return new l(e,this.queryGeometry,{definitionExpression:this.definitionExpression,
geometryType:this.geometryType,hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:b,fieldsIndex:this.fieldsIndex,timeInfo:this.timeInfo,featureAdapter:this.featureAdapter})});return function(b){return a.apply(this,arguments)}}();g.createSummaryStatisticsResponse=function(){var a=H._asyncToGenerator(function*(b,c){const {field:e,normalizationField:d,normalizationType:f,normalizationTotal:m,minValue:k,maxValue:h}=c;var n=new J(b,this.featureAdapter,this.fieldsIndex);b=this.fieldsIndex.isDateField(e);
c=c.valueExpression?yield this._getAttributeExpressionValues(n,c.valueExpression,c.viewInfoParams):this._getAttributeNormalizedValues(n,{field:e,normalizationField:d,normalizationType:f,normalizationTotal:m});n=D.isNullCountSupported({normalizationType:f,normalizationField:d,minValue:k,maxValue:h});c=Q.isStringField(this.fieldsIndex.get(e))?D.calculateStringStatistics({values:c,supportsNullCount:n}):D.calculateStatistics({values:c,minValue:k,maxValue:h,useSampleStdDev:!f,supportsNullCount:n});return D.processStatsResult(c,
b)});return function(b,c){return a.apply(this,arguments)}}();g._sortFeatures=function(a,b,c){if(1<a.length&&b&&b.length)for(const e of b.reverse()){b=e.split(" ");const d=b[0],f=this.fieldsIndex.get(d),m=b[1]&&"desc"===b[1].toLowerCase();a.sort((k,h)=>{k=c(k,d,f);h=c(h,d,f);return S(k,h,f,m)})}};g._createFeatureQueryResponse=function(a){const b=this.items,{geometryType:c,hasM:e,hasZ:d,objectIdField:f,spatialReference:m}=this,{outFields:k,outSR:h,quantizationParameters:n,resultRecordCount:p,resultOffset:u,
returnZ:x,returnM:z}=a,y=null!=p?b.length>(u||0)+p:!1,t=k&&(-1<k.indexOf("*")?[...this.fieldsIndex.fields]:k.map(r=>this.fieldsIndex.get(r)));return{exceededTransferLimit:y,features:this._createFeatures(a,b),fields:t,geometryType:c,hasM:e&&z,hasZ:d&&x,objectIdFieldName:f,spatialReference:C.cleanFromGeometryEngine(h?h:m),transform:n&&P.toQuantizationTransform(n)||null}};g._createFeatures=function(a,b){const c=new J(a,this.featureAdapter,this.fieldsIndex),{hasM:e,hasZ:d}=this,{orderByFields:f,quantizationParameters:m,
returnGeometry:k,returnCentroid:h,maxAllowableOffset:n,resultOffset:p,resultRecordCount:u,returnZ:x=!1,returnM:z=!1}=a,y=d&&x,t=e&&z;a=[];var r=0;b=[...b];this._sortFeatures(b,f,(w,A,B)=>c.getFieldValue(w,A,B));if(k||h){var v=P.toQuantizationTransform(m);if(k&&!h)for(var q of b)a[r++]={attributes:c.getAttributes(q),geometry:C.getGeometry(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(q),n,v,y,t)};else if(!k&&h)for(const w of b)a[r++]={attributes:c.getAttributes(w),centroid:C.transformCentroid(this,
this.featureAdapter.getCentroid(w,this),v)};else for(const w of b)a[r++]={attributes:c.getAttributes(w),centroid:C.transformCentroid(this,this.featureAdapter.getCentroid(w,this),v),geometry:C.getGeometry(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(w),n,v,y,t)}}else for(v of b)(q=c.getAttributes(v))&&(a[r++]={attributes:q});r=p||0;null!=u&&(a=a.slice(r,Math.min(a.length,r+u)));return a};g._createExceedsLimitQueryResponse=function(a){var b=!1;let c=Number.POSITIVE_INFINITY,
e=Number.POSITIVE_INFINITY;b=Number.POSITIVE_INFINITY;for(const d of a.outStatistics)if("exceedslimit"===d.statisticType){c=null!=d.maxPointCount?d.maxPointCount:Number.POSITIVE_INFINITY;e=null!=d.maxRecordCount?d.maxRecordCount:Number.POSITIVE_INFINITY;b=null!=d.maxVertexCount?d.maxVertexCount:Number.POSITIVE_INFINITY;break}if("esriGeometryPoint"===this.geometryType)b=this.items.length>c;else if(this.items.length>e)b=!0;else{a=this.hasZ?this.hasM?4:3:this.hasM?3:2;const d=this.featureAdapter;b=this.items.reduce((f,
m)=>{m=d.getGeometry(m);return f+(F.isSome(m)&&m.coords.length||0)},0)/a>b}return{fields:[{name:"exceedslimit",type:"esriFieldTypeInteger",alias:"exceedslimit",sqlType:"sqlTypeInteger",domain:null,defaultValue:null}],features:[{attributes:{exceedslimit:Number(b)}}]}};g._createStatisticsQueryResponse=function(a){var b={attributes:{}};const c=[],e=new Map,d=new Map,f=new Map,m=new Map,k=new J(a,this.featureAdapter,this.fieldsIndex);var h=a.outStatistics;const {groupByFieldsForStatistics:n,having:p,
orderByFields:u}=a;a=n&&n.length;const x=!!a,z=x&&n[0],y=x&&!this.fieldsIndex.get(z);for(const w of h){const {outStatisticFieldName:A,statisticType:B}=w;h=w;var t="exceedslimit"!==B?w.onStatisticField:void 0;const G="percentile_disc"===B||"percentile_cont"===B,K=x&&1===a&&(t===z||y)&&"count"===B;if(x){if(!f.has(t)){var r=[];for(const E of n){var v=this._getAttributeValues(k,E,e);r.push(v)}f.set(t,this._calculateUniqueValues(r,k.returnDistinctValues))}r=f.get(t);for(const E in r){const {count:aa,data:T,
items:ba,itemPositions:ca}=r[E];v=T.join(",");if(!p||k.validateItems(ba,p)){const O=m.get(v)||{attributes:{}};var q=null;if(K)q=aa;else{const L=this._getAttributeValues(k,t,e);q=ca.map(M=>L[M]);q=G&&"statisticParameters"in h?this._getPercentileValue(h,q):this._getStatisticValue(h,q,null,k.returnDistinctValues)}O.attributes[A]=q;n.forEach((L,M)=>O.attributes[this.fieldsIndex.get(L)?L:`EXPR_${M+1}`]=T[M]);m.set(v,O)}}}else t=this._getAttributeValues(k,t,e),b.attributes[A]=G&&"statisticParameters"in
h?this._getPercentileValue(h,t):this._getStatisticValue(h,t,d,k.returnDistinctValues);c.push({name:A,alias:A,type:"esriFieldTypeDouble"})}b=x?Array.from(m.values()):[b];this._sortFeatures(b,u,(w,A)=>w.attributes[A]);return{fields:c,features:b}};g._getStatisticValue=function(a,b,c,e){const {onStatisticField:d,statisticType:f}=a;a=null;a=null!=c&&c.has(d)?c.get(d):Q.isStringField(this.fieldsIndex.get(d))?D.calculateStringStatistics({values:b,returnDistinct:e}):D.calculateStatistics({values:b,minValue:null,
maxValue:null,useSampleStdDev:!0});c&&c.set(d,a);return a["var"===f?"variance":f]};g._getPercentileValue=function(a,b){const {onStatisticField:c,statisticParameters:e,statisticType:d}=a,{value:f,orderBy:m}=e,k="desc"===m,h=this.fieldsIndex.get(c);a=[...b].filter(n=>null!=n).sort((n,p)=>S(n,p,h,k));return this._calculatePercentile(a,f,"percentile_disc"===d)};g._getAttributeValues=function(a,b,c){if(c.has(b))return c.get(b);const e=this.fieldsIndex.get(b),d=this.items.map(f=>a.getFieldValue(f,b,e));
c.set(b,d);return d};g._getAttributeNormalizedValues=function(a,b){return this.items.map(c=>a.getNormalizedValue(c,{field:b.field,fieldInfo:this.fieldsIndex.get(b.field),normalizationField:b.normalizationField,normalizationFieldInfo:this.fieldsIndex.get(b.normalizationField),normalizationType:b.normalizationType,normalizationTotal:b.normalizationTotal}))};g._getAttributeExpressionValues=function(){var a=H._asyncToGenerator(function*(b,c,e){const {arcadeUtils:d}=yield X.loadArcade(),f=d.createFunction(c),
m=e&&d.getViewInfo(e);return this.items.map(k=>b.getExpressionValue(k,{compiledFunc:f,viewInfo:m},d))});return function(b,c,e){return a.apply(this,arguments)}}();g._calculateUniqueValues=function(a,b){const c={},e=this.items,d=e.length;for(let f=0;f<d;f++){const m=e[f],k=[];for(const n of a)k.push(n[f]);const h=k.join(",");b?null==c[h]&&(c[h]={count:1,data:k,items:[m],itemPositions:[f]}):null==c[h]?c[h]={count:1,data:k,items:[m],itemPositions:[f]}:(c[h].count++,c[h].items.push(m),c[h].itemPositions.push(f))}return c};
g._calculatePercentile=function(a,b,c){if(0===a.length)return null;if(0>=b)return a[0];if(1<=b)return a[a.length-1];var e=(a.length-1)*b,d=Math.floor(e);b=d+1;e%=1;d=a[d];const f=a[b];return b>=a.length||c||"string"===typeof d||"string"===typeof f?d:d*(1-e)+f*e};H._createClass(l,[{key:"size",get:function(){return this.items.length}}]);return l}()});