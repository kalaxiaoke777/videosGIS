// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.21/esri/copyright.txt for details.
//>>built
define("exports ../../core/Error ../../core/maybe ../../geometry/Extent ../../geometry/Point ../../geometry/projectionEllipsoid ../../geometry/support/WKIDUnitConversion ../ogc/xmlUtils ./TileInfo".split(" "),function(y,K,L,D,E,M,A,F,N){function r(b,a){for(let d=0;d<a.childNodes.length;d++){const c=a.childNodes[d];if(c.nodeType===Node.ELEMENT_NODE&&c.nodeName===b)return c}return null}function v(b,a){const d=[];for(let c=0;c<a.childNodes.length;c++){const e=a.childNodes[c];e.nodeType===Node.ELEMENT_NODE&&
e.nodeName===b&&d.push(e)}return d}function w(b,a){const d=[];for(let c=0;c<a.childNodes.length;c++){const e=a.childNodes[c];e.nodeType===Node.ELEMENT_NODE&&e.nodeName===b&&d.push(e)}return d.map(c=>c.textContent)}function n(b,a){b.split("\x3e").forEach(d=>{a&&(a=r(d,a))});return a&&a.textContent}function x(b,a,d,c){let e;Array.prototype.slice.call(c.childNodes).some(f=>{if(-1<f.nodeName.indexOf(b)){var g=r(a,f);g=g&&g.textContent;if(g===d||d.split(":")&&d.split(":")[1]===g)return e=f,!0}return!1});
return e}function G(b,a){var d;const c=[];var e=null==(d=b.layerMap)?void 0:d.get(a);if(e){d=v("ResourceURL",e);e=v("Dimension",e);if(e.length){var f=n("Identifier",e[0]);var g=w("Default",e[0])||w("Value",e[0])}if(1<e.length){var h=n("Identifier",e[1]);var p=w("Default",e[1])||w("Value",e[1])}b.dimensionMap.set(a,{dimensions:g,dimensions2:p});d.forEach(l=>{let k=l.getAttribute("template");if("tile"===l.getAttribute("resourceType")){if(f&&g.length)if(-1<k.indexOf("{"+f+"}"))k=k.replace("{"+f+"}",
"{dimensionValue}");else{var m=k.toLowerCase().indexOf("{"+f.toLowerCase()+"}");-1<m&&(k=k.substring(0,m)+"{dimensionValue}"+k.substring(m+f.length+2))}h&&p.length&&(-1<k.indexOf("{"+h+"}")?k=k.replace("{"+h+"}","{dimensionValue2}"):(m=k.toLowerCase().indexOf("{"+h.toLowerCase()+"}"),-1<m&&(k=k.substring(0,m)+"{dimensionValue2}"+k.substring(m+h.length+2))));c.push({template:k,format:l.getAttribute("format"),resourceType:"tile"})}});return c}}function O(b){const a=[];F.visitXML(b,{BoundingBox:d=>{const c=
d.getAttribute("crs"),e=H(c),f=c.includes("epsg")&&B(e.wkid);let g,h,p,l;F.visitXML(d,{LowerCorner:k=>{[g,h]=k.textContent.split(" ").map(m=>Number.parseFloat(m));f&&([g,h]=[h,g])},UpperCorner:k=>{[p,l]=k.textContent.split(" ").map(m=>Number.parseFloat(m));f&&([p,l]=[l,p])}});a.push({xmin:g,ymin:h,xmax:p,ymax:l,spatialReference:e})}});return a}function P(b,a){return v("Style",b).map(d=>{var c=r("LegendURL",d),e=r("Keywords",d);e=e&&w("Keyword",e);c=c&&c.getAttribute("xlink:href");a&&(c=c&&c.replace(/^http:/i,
"https:"));return{abstract:n("Abstract",d),id:n("Identifier",d),isDefault:"true"===d.getAttribute("isDefault"),keywords:e,legendUrl:c,title:n("Title",d)}})}function Q(b,a,d){return v("TileMatrixSetLink",a).map(c=>r("TileMatrixSet",c).textContent).map(c=>R(b,c,a,d))}function R(b,a,d,c){d=x("TileMatrixSetLink","TileMatrixSet",a,d);d=w("TileMatrix",d);const e=c.find(l=>{l=(l=r("Identifier",l))&&l.textContent;return l===a||a.split(":")&&a.split(":")[1]===l?!0:!1});c=S(e);const f=c.spatialReference,g=
f.wkid;var h=r("TileMatrix",e);h=[parseInt(n("TileWidth",h),10),parseInt(n("TileHeight",h),10)];const p=[];d.length?d.forEach((l,k)=>{l=x("TileMatrix","Identifier",l,e);p.push(I(l,g,k,a))}):v("TileMatrix",e).forEach((l,k)=>{p.push(I(l,g,k,a))});b=T(b,e,c,h,p[0]).toJSON();d=(new N({dpi:96,spatialReference:f,size:h,origin:c,lods:p})).toJSON();return{id:a,fullExtent:b,tileInfo:d}}function H(b){b=b.toLowerCase();let a=parseInt(b.split(":").pop(),10);if(900913===a||3857===a)a=102100;b=b.includes("crs84")||
b.includes("crs:84")?4326:b.includes("crs83")||b.includes("crs:83")?4269:b.includes("crs27")||b.includes("crs:27")?4267:null;L.isSome(b)&&(a=b);return{wkid:a}}function S(b){const a=n("SupportedCRS",b).toLowerCase(),d=H(a);b=r("TileMatrix",b);var c=n("TopLeftCorner",b).split(" ");b=c[0].split("E").map(e=>Number(e));c=c[1].split("E").map(e=>Number(e));b=1<b.length?b[0]*10**b[1]:b[0];c=1<c.length?c[0]*10**c[1]:c[0];return a.includes("epsg")&&B(d.wkid)?new E({x:c,y:b,spatialReference:d}):new E({x:b,y:c,
spatialReference:d})}function T(b,a,d,c,e){var f=r("BoundingBox",a);if(f){var g=n("LowerCorner",f).split(" ");var h=n("UpperCorner",f).split(" ")}g&&1<g.length&&h&&1<h.length?(a=parseFloat(g[0]),c=parseFloat(g[1]),g=parseFloat(h[0]),h=parseFloat(h[1])):(a=r("TileMatrix",a),g=parseInt(n("MatrixWidth",a),10),f=parseInt(n("MatrixHeight",a),10),a=d.x,h=d.y,g=a+g*c[0]*e.resolution,c=h-f*c[1]*e.resolution);return"1.0.0"===b&&B(d.spatialReference.wkid)?new D(c,a,h,g,d.spatialReference):new D(a,c,g,h,d.spatialReference)}
function B(b){return U.some(([a,d])=>b>=a&&b<=d)}function I(b,a,d,c){const e=n("Identifier",b);var f=n("ScaleDenominator",b).split("E").map(g=>Number(g));f=1<f.length?f[0]*10**f[1]:f[0];a=J(a,f,c);f*=1.058267716535433;c=parseInt(n("MatrixWidth",b),10);b=parseInt(n("MatrixHeight",b),10);return{cols:c,level:d,levelValue:e,scale:f,resolution:a,rows:b}}function J(b,a,d){b=A.hasOwnProperty(String(b))?A.values[A[b]]:"default028mm"===d?6370997*Math.PI/180:M.getReferenceEllipsoidFromWKID(b).metersPerDegree;
return 7*a/25E3/b}const U=[[3819,3819],[3821,3824],[3889,3889],[3906,3906],[4001,4025],[4027,4036],[4039,4047],[4052,4055],[4074,4075],[4080,4081],[4120,4176],[4178,4185],[4188,4216],[4218,4289],[4291,4304],[4306,4319],[4322,4326],[4463,4463],[4470,4470],[4475,4475],[4483,4483],[4490,4490],[4555,4558],[4600,4646],[4657,4765],[4801,4811],[4813,4821],[4823,4824],[4901,4904],[5013,5013],[5132,5132],[5228,5229],[5233,5233],[5246,5246],[5252,5252],[5264,5264],[5324,5340],[5354,5354],[5360,5360],[5365,
5365],[5370,5373],[5381,5381],[5393,5393],[5451,5451],[5464,5464],[5467,5467],[5489,5489],[5524,5524],[5527,5527],[5546,5546],[2044,2045],[2081,2083],[2085,2086],[2093,2093],[2096,2098],[2105,2132],[2169,2170],[2176,2180],[2193,2193],[2200,2200],[2206,2212],[2319,2319],[2320,2462],[2523,2549],[2551,2735],[2738,2758],[2935,2941],[2953,2953],[3006,3030],[3034,3035],[3038,3051],[3058,3059],[3068,3068],[3114,3118],[3126,3138],[3150,3151],[3300,3301],[3328,3335],[3346,3346],[3350,3352],[3366,3366],[3389,
3390],[3416,3417],[3833,3841],[3844,3850],[3854,3854],[3873,3885],[3907,3910],[4026,4026],[4037,4038],[4417,4417],[4434,4434],[4491,4554],[4839,4839],[5048,5048],[5105,5130],[5253,5259],[5269,5275],[5343,5349],[5479,5482],[5518,5519],[5520,5520],[20004,20032],[20064,20092],[21413,21423],[21473,21483],[21896,21899],[22171,22177],[22181,22187],[22191,22197],[25884,25884],[27205,27232],[27391,27398],[27492,27492],[28402,28432],[28462,28492],[30161,30179],[30800,30800],[31251,31259],[31275,31279],[31281,
31290],[31466,31700]];y.getTileUrlFromResourceUrls=function(b,a,d,c,e,f,g,h){var {dimensionMap:p}=b;b=G(b,a);const l=p.get(a).dimensions&&p.get(a).dimensions[0];a=p.get(a).dimensions2&&p.get(a).dimensions2[0];p="";if(b&&0<b.length){let k=null;b.some(m=>m.format===c?(k=m,!0):!1);k||(k=b[g%b.length]);p=k.template.replace(/\{Style\}/gi,e).replace(/\{TileMatrixSet\}/gi,d).replace(/\{TileMatrix\}/gi,f).replace(/\{TileRow\}/gi,""+g).replace(/\{TileCol\}/gi,""+h).replace(/\{dimensionValue\}/gi,l).replace(/\{dimensionValue2\}/gi,
a)}return p};y.getTileUrlTemplateFromResourceUrls=function(b,a,d,c){const {dimensionMap:e}=b;b=G(b,a);let f="";if(b&&0<b.length){const g=e.get(a).dimensions&&e.get(a).dimensions[0];a=e.get(a).dimensions2&&e.get(a).dimensions2[0];f=b[0].template;f.indexOf(".xxx")===f.length-4&&(f=f.slice(0,f.length-4));f=f.replace(/\{Style\}/gi,c);f=f.replace(/\{TileMatrixSet\}/gi,d);f=f.replace(/\{TileMatrix\}/gi,"{level}");f=f.replace(/\{TileRow\}/gi,"{row}");f=f.replace(/\{TileCol\}/gi,"{col}");f=f.replace(/\{dimensionValue\}/gi,
g);f=f.replace(/\{dimensionValue2\}/gi,a)}return f};y.parseCapabilities=function(b,a){var d,c;b=b.replace(/ows:/gi,"");var e=(new DOMParser).parseFromString(b,"text/xml").documentElement;const f=new Map;b=new Map;var g=r("Contents",e);if(!g)throw new K("wmtslayer:wmts-capabilities-xml-is-not-valid");var h=r("OperationsMetadata",e);h=null==h?void 0:h.querySelector("[name\x3d'GetTile']");h=(h=null==h?void 0:h.getElementsByTagName("Get"))&&Array.prototype.slice.call(h);const p=null!=(d=-1<(null==a?void 0:
null==(c=a.url)?void 0:c.indexOf("https")))?d:!1;let l=a.serviceMode,k,m=a&&a.url,C;h&&h.length&&h.some(q=>{const t=r("Constraint",q);if(!t||x("AllowedValues","Value",l,t))return m=q.attributes[0].nodeValue,!0;if(!t||x("AllowedValues","Value","RESTful",t)||x("AllowedValues","Value","REST",t))C=q.attributes[0].nodeValue;else if(!t||x("AllowedValues","Value","KVP",t))k=q.attributes[0].nodeValue;return!1});m||(C?(m=C,l="RESTful"):k?(m=k,l="KVP"):m=(a=r("ServiceMetadataURL",e))&&a.getAttribute("xlink:href"));
a=m.indexOf("1.0.0/");-1===a&&"RESTful"===l?m+="/":-1<a&&(m=m.substring(0,a));"KVP"===l&&(m+=-1<a?"":"?");p&&(m=m.replace(/^http:/i,"https:"));const V=n("ServiceIdentification\x3eServiceTypeVersion",e);e=n("ServiceIdentification\x3eAccessConstraints",e);a=v("Layer",g);const W=v("TileMatrixSet",g);g=a.map(q=>{var t=n("Identifier",q);f.set(t,q);{const X=n("Abstract",q),Y=w("Format",q);var u=r("WGS84BoundingBox",q);var z=u?n("LowerCorner",u).split(" "):["-180","-90"];u=u?n("UpperCorner",u).split(" "):
["180","90"];z={xmin:parseFloat(z[0]),ymin:parseFloat(z[1]),xmax:parseFloat(u[0]),ymax:parseFloat(u[1]),spatialReference:{wkid:4326}};u=O(q);const Z=P(q,p),aa=n("Title",q);q=Q(V,q,W);t={id:t,fullExtent:z,fullExtents:u,description:X,formats:Y,styles:Z,title:aa,tileMatrixSets:q}}return t});return{copyright:e,dimensionMap:b,layerMap:f,layers:g,serviceMode:l,tileUrl:m}};y.parseResourceInfo=function(b){b.layers.forEach(a=>{a.tileMatrixSets.forEach(d=>{const c=d.tileInfo;96!==c.dpi&&(c.lods.forEach(e=>
{e.scale=96*e.scale/c.dpi;e.resolution=J(c.spatialReference.wkid,90.71428571428571*e.scale/96,d.id)}),c.dpi=96)})});return b};Object.defineProperty(y,"__esModule",{value:!0})});