// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.21/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/jsonMap","../../../core/maybe","../PixelBlock","./pixelUtils"],function(B,ba,ca,H,W){function M(a,b){return C.get(a)/C.get(b)||1}function N(a,b="geographic"){const [c,d]=a;a=Math.sqrt(c*c+d*d);let e=Math.atan2(d,c)*O;e=(360+e)%360;"geographic"===b&&(e=(450-e)%360);return[a,e]}function X(a,b="geographic"){let c=a[1];"geographic"===b&&(c=(450-c)%360);c%=360;a=a[0];return[a*Math.cos(c/O),a*Math.sin(c/O)]}function da(a=0,b=Math.PI,c=!0){c&&(b=(2*Math.PI-b)%(2*Math.PI));
var d=c?-1:1;c=5*d;const e=20*d,k=25*d;d*=2;let [q,n]=[5,0-e],[l,r]=[q+2,n],[h,g]=[l-0,r+d],[m,f]=[-5,0-k],[v,p]=[m+0,f-d];a=Math.ceil(a/5);let x=Math.floor(a/10);a-=8*x;const t=[],u=[];for(let G=0;G<a/2;G++,x--){0>=x&&1===a%2&&G===(a-1)/2&&(m=0,v=m+0,f=(f+n)/2,p=f-d);const [Y,Z]=y(m,f,b,45);if(0<x){const [P,Q]=y(l,f,b,45),[R,S]=y(q,n,b,45);t.push(P);t.push(Q);t.push(Y);t.push(Z);t.push(R);t.push(S)}else{const [P,Q]=y(l,r,b,45),[R,S]=y(h,g,b,45),[ea,fa]=y(v,p,b,45);u.push(Y);u.push(Z);u.push(ea);
u.push(fa);u.push(R);u.push(S);u.push(P);u.push(Q)}f+=c;n+=c;r+=c;g+=c;p+=c}const [w,A]=y(5,0+e,b,45),[z,I]=y(7,0+e,b,45),[J,D]=y(5,0-k,b,45),[E,T]=y(7,0-k,b,45);return{pennants:t,barbs:u,shaft:[w,A,z,I,J,D,E,T]}}function y(a,b,c,d=1){return[Math.sqrt(a*a+b*b)/d,(2*Math.PI+(2*Math.PI+Math.atan2(b,a))%(2*Math.PI)-c)%(2*Math.PI)]}function F(a,b,c,d){c=M(d||"knots",c);for(d=1;d<b.length;d++)if(d===b.length-1){if(a<b[d]*c)break}else if(a<=b[d]*c)break;return Math.min(d-1,b.length-2)}function ha(a,b,c,
d,e){let k=0;switch(b){case "beaufort_kn":k=F(a,K,"knots",c);break;case "beaufort_km":k=F(a,K,"kilometer-per-hour",c);break;case "beaufort_ft":k=F(a,K,"feet-per-second",c);break;case "beaufort_m":k=F(a,K,"meter-per-second",c);break;case "classified_arrow":k=F(a,e,d,c);break;case "ocean_current_m":k=F(a,ia,"meter-per-second",c);break;case "ocean_current_kn":k=F(a,ja,"knots",c)}return k}function ka(a,b){const {style:c,inputUnit:d,outputUnit:e,breakValues:k}=b;b=L.fromJSON(d);const q=L.fromJSON(e);let n=
0,l=0;const {width:r,height:h,mask:g}=a,m=a.pixels[0];a=a.pixels[1];var f=g?g.filter(t=>0<t).length:r*h;const v=new Float32Array(42*f);f=new Uint32Array(15*f);for(let t=0;t<h;t++)for(let u=0;u<r;u++){var p=t*r+u;if(!g||g[t*r+u]){var x;const w=null!=(x=(a[p]+360)%360/180*Math.PI)?x:2*Math.PI*Math.random(),A=ha(m[p],c,b,q,k);for(let z=0;z<U.length;z+=2)v[n++]=(u+.5)/r,v[n++]=(t+.5)/h,v[n++]=U[z],v[n++]=U[z+1]+w,v[n++]=A,v[n++]=m[p];p=7*(n/42-1);f[l++]=p;f[l++]=p+1;f[l++]=p+2;f[l++]=p+0;f[l++]=p+4;f[l++]=
p+3;f[l++]=p+0;f[l++]=p+2;f[l++]=p+3;f[l++]=p+2;f[l++]=p+5;f[l++]=p+3;f[l++]=p+5;f[l++]=p+6;f[l++]=p+3}}return{vertexData:v,indexData:f}}function aa(a,b){let c=0,d=0;const {width:e,height:k,mask:q}=a;a=a.pixels[0];const n=[],l=[];b="wind_speed"===b.style?5:Number.MAX_VALUE;for(let h=0;h<k;h++)for(let g=0;g<e;g++){var r=h*e+g;if((!q||q[h*e+g])&&a[r]<b){for(let m=0;4>m;m++)n[c++]=(g+.5)/e,n[c++]=(h+.5)/k,n[c++]=2>m?-.5:.5,n[c++]=0===m%2?-.5:.5,n[c++]=0,n[c++]=a[r];r=4*(c/24-1);l[d++]=r;l[d++]=r+1;l[d++]=
r+2;l[d++]=r+1;l[d++]=r+2;l[d++]=r+3}}return{vertexData:new Float32Array(n),indexData:new Uint32Array(l)}}const C=new Map;C.set("meter-per-second",1);C.set("kilometer-per-hour",.277778);C.set("knots",.514444);C.set("feet-per-second",.3048);C.set("mile-per-hour",.44704);const O=180/Math.PI,L=new ba.JSONMap({esriMetersPerSecond:"meter-per-second",esriKilometersPerHour:"kilometer-per-hour",esriKnots:"knots",esriFeetPerSecond:"feet-per-second",esriMilesPerHour:"mile-per-hour"}),U=function(a=0,b=0,c=Math.PI,
d=!0){d&&(c=(2*Math.PI-c)%(2*Math.PI));d=d?-1:1;const e=-7*d,k=-2*d,q=-16*d,[n,l]=y(0,b+13*d,c,29),[r,h]=y(a-5.5,b+e,c,29),[g,m]=y(a+5.5,b+e,c,29),[f,v]=y(a-1.5,b+k,c,29),[p,x]=y(a+1.5,b+k,c,29),[t,u]=y(a-1.5,b+q,c,29),[w,A]=y(a+1.5,b+q,c,29);return[n,l,r,h,f,v,p,x,g,m,t,u,w,A]}(0,0,0),K=[0,1,3,6,10,16,21,27,33,40,47,55,63],ia=[0,.5,1,1.5,2],ja=[0,.25,.5,1,1.5,2,2.5,3,3.5,4],V=[];B.convertVectorFieldData=function(a,b,c="geographic",d=1){if(!W.isValidPixelBlock(a))return a;const {pixels:e,width:k,
height:q}=a;var n=k*q;const l=e[0],r=e[1],h=H.createEmptyBand(a.pixelType,n);n=H.createEmptyBand(a.pixelType,n);let g=0;for(let m=0;m<q;m++)for(let f=0;f<k;f++)"vector-uv"===b?([h[g],n[g]]=N([l[g],r[g]],c),h[g]*=d):([h[g],n[g]]=X([l[g],r[g]],c),h[g]*=d,n[g]*=d),g++;a=new H({pixelType:a.pixelType,width:a.width,height:a.height,mask:a.mask,validPixelCount:a.validPixelCount,maskIsAlpha:a.maskIsAlpha,pixels:[h,n]});a.updateStatistics();return a};B.convertVectorFieldUnit=function(a,b,c=1){if(1===c||!W.isValidPixelBlock(a))return a;
a=a.clone();const {pixels:d,width:e,height:k}=a,q=d[0],n=d[1];let l=0;for(let r=0;r<k;r++)for(let h=0;h<e;h++)"vector-uv"===b?(q[l]*=c,n[l]*=c):q[l]*=c,l++;a.updateStatistics();return a};B.createVFMesh=function(a,b){if("simple_scalar"===b.style)var c=aa(a,b);else if("wind_speed"===b.style){{if(0===V.length)for(var d=0;30>d;d++)V.push(da(5*d,0));b=L.fromJSON(b.inputUnit);b=M(b,"knots");const {width:n,height:l,mask:r}=a;d=a.pixels[0];a=a.pixels[1];const h=[],g=[];let m=0,f=0;for(let v=0;v<l;v++)for(let p=
0;p<n;p++){var e=v*n+p,k=d[e]*b;if((!r||r[v*n+p])&&5<=k){const x=null!=(c=(a[e]+360)%360/180*Math.PI)?c:2*Math.PI*Math.random(),{pennants:t,barbs:u,shaft:w}=V[Math.min(Math.floor(k/5),29)];if(0===t.length+u.length)continue;e=h.length/6;const A=(p+.5)/n,z=(v+.5)/l;for(var q=0;q<t.length;q+=2)h[m++]=A,h[m++]=z,h[m++]=t[q],h[m++]=t[q+1]+x,h[m++]=0,h[m++]=k;for(q=0;q<u.length;q+=2)h[m++]=A,h[m++]=z,h[m++]=u[q],h[m++]=u[q+1]+x,h[m++]=0,h[m++]=k;for(q=0;q<w.length;q+=2)h[m++]=A,h[m++]=z,h[m++]=w[q],h[m++]=
w[q+1]+x,h[m++]=0,h[m++]=k;for(k=0;k<t.length/6;k++)g[f++]=e,g[f++]=e+1,g[f++]=e+2,e+=3;for(k=0;k<u.length/8;k++)g[f++]=e,g[f++]=e+1,g[f++]=e+2,g[f++]=e+1,g[f++]=e+2,g[f++]=e+3,e+=4;g[f++]=e+0;g[f++]=e+1;g[f++]=e+2;g[f++]=e+1;g[f++]=e+3;g[f++]=e+2;e+=4}}c={vertexData:new Float32Array(h),indexData:new Uint32Array(g)}}}else c=ka(a,b);return c};B.createVFMeshScalar=aa;B.getUnitConversionFactor=M;B.sampleVectorField=function(a,b,c,d=[0,0],e=.5){const {width:k,height:q,mask:n}=a,[l,r]=a.pixels,[h,g]=d;
a=Math.round((k-h)/c);d=Math.round((q-g)/c);var m=a*d;const f=new Float32Array(m),v=new Float32Array(m);m=new Uint8Array(m);b="vector-uv"===b;for(let x=0;x<d;x++)for(let t=0;t<a;t++){let u=0;const w=x*a+t,A=Math.max(0,x*c+g),z=Math.max(0,t*c+h),I=Math.min(q,A+c),J=Math.min(k,z+c);for(let D=A;D<I;D++)for(let E=z;E<J;E++){var p=D*k+E;if(!n||n[p]){u++;p=b?[l[p],r[p]]:[l[p],(360+r[p])%360];const [T,G]=b?p:X(p);f[w]+=T;v[w]+=G}}if(u>=(I-A)*(J-z)*(1-e)){m[w]=1;const [D,E]=N([f[w]/u,v[w]/u]);f[w]=D;v[w]=
E}else m[w]=0,f[w]=0,v[w]=0}c=new H({width:a,height:d,pixels:[f,v],mask:m});c.updateStatistics();return c};B.snapImageToSymbolTile=function(a,b,c,d,e){if(!ca.isSome(e)||!e.spatialReference.equals(a.spatialReference))return{extent:a,width:b,height:c,resolution:a.width/b};const k=e.xmin;e=e.ymax;d=Math.max(d||0,30);b=((a.xmax-a.xmin)/Math.ceil(1/d*b)+(a.ymax-a.ymin)/Math.ceil(1/d*c))/2;a.xmin=k+Math.floor((a.xmin-k)/b)*b;a.xmax=k+Math.ceil((a.xmax-k)/b)*b;a.ymin=e+Math.floor((a.ymin-e)/b)*b;a.ymax=
e+Math.ceil((a.ymax-e)/b)*b;return{extent:a,width:Math.round(a.width/b),height:Math.round(a.height/b),resolution:b}};B.unitKebabDict=L;B.uvComponentToVector=N;Object.defineProperty(B,"__esModule",{value:!0})});