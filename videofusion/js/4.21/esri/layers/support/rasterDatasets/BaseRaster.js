// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.21/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../geometry ../../../request ../../../core/Error ../../../core/JSONSupport ../../../core/Logger ../../../core/maybe ../../../core/Promise ../../../core/promiseUtils ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../arcgisLayerUrl ../commonProperties ../RasterStorageInfo ../TileInfo ./RawBlockCache ../rasterFormats/RasterCodec ../rasterFunctions/pixelUtils ../rasterFunctions/rasterProjectionHelper ../rasterFunctions/vectorFieldUtils ../../../geometry/Point ../../../geometry/Extent".split(" "),
function(x,A,y,Z,P,aa,ba,w,ca,Q,D,la,ma,da,ea,fa,ha,R,B,ia,S,t,ja,M,T){y=function(U){function L(){var b=U.apply(this,arguments)||this;b.rasterJobHandler=null;b.datasetName=null;b.datasetFormat=null;b.rasterInfo=null;b.ioConfig={sampling:"closest"};return b}x._inheritsLoose(L,U);var n=L.prototype;n.init=function(){var b=x._asyncToGenerator(function*(){const a=t.load();this.addResolvingPromise(a);yield this.when()});return function(){return b.apply(this,arguments)}}();n.normalizeCtorArgs=function(b){b&&
b.ioConfig&&(b={...b,ioConfig:{resolution:null,bandIds:null,sampling:"closest",tileInfo:R.create(),...b.ioConfig}});return b};n.open=function(){var b=x._asyncToGenerator(function*(a){throw new P("BaseRaster:open-not-implemented","open() is not implemented");});return function(a){return b.apply(this,arguments)}}();n.fetchTile=function(){var b=x._asyncToGenerator(function*(a,c,f,e={}){const {tileInfo:d}=e;a=d.lodAt(a);c=this.getTileExtent({x:a.resolution,y:a.resolution},c,f,d.origin,d.spatialReference,
d.size);e=this._getRequestOptionsWithSliceId(e);return this.fetchPixels(c,d.size[0],d.size[1],e)});return function(a,c,f){return b.apply(this,arguments)}}();n.identify=function(){var b=x._asyncToGenerator(function*(a,c={}){c=this._getRequestOptionsWithSliceId(c);const {spatialReference:f,extent:e}=this.rasterInfo;var {datumTransformation:d}=c;d=t.projectPoint(a,f,d);if(!e.intersects(d)||w.isSome(this.rasterInfo.transform)&&(d=this.rasterInfo.transform.inverseTransform(d),!this.rasterInfo.nativeExtent.intersects(d)))return{location:d,
value:null};let g=0;if(c.srcResolution)g=t.snapPyramid(c.srcResolution,this.rasterInfo,this.ioConfig.sampling).pyramidLevel;else if(g=yield this.computeBestPyramidLevelForLocation(a,c),null==g)return{location:d,value:null};a=this.identifyPixelLocation(d,g,null);if(null===a)return{location:d,value:null};const {row:h,col:l,rowOffset:k,colOffset:m}=a;a=B.getRasterId(this.url,c.sliceId);const p=`${g}/${h}/${l}`;let u=B.getBlock(a,null,p);w.isNone(u)&&(u=this.fetchRawTile(g,h,l,c),B.putBlock(a,null,p,
u));c=yield u;if(w.isNone(c)||!c.pixels||0===c.pixels.length)return{location:d,value:null};const E=k*this.rasterInfo.storageInfo.blockHeight+m;c=!c.mask||c.mask[E]?c.pixels.map(q=>q[E]):null;a=this.rasterInfo.dataType;return("vector-magdir"===a||"vector-uv"===a)&&1<(null==c?void 0:c.length)?(a="vector-magdir"===a?[c[0],c[1]]:ja.uvComponentToVector([c[0],c[1]]),{location:d,value:c,magdirValue:a,pyramidLevel:g}):{location:d,value:c,pyramidLevel:g}});return function(a){return b.apply(this,arguments)}}();
n.fetchPixels=function(){var b=x._asyncToGenerator(function*(a,c,f,e={}){a=t.snapExtent(a);var d=t.getWorldWrapCount(a),g=this.rasterInfo.spatialReference,h=!a.spatialReference.equals(g),{datumTransformation:l}=e,k=new M({x:(a.xmax-a.xmin)/c,y:(a.ymax-a.ymin)/f,spatialReference:a.spatialReference});const m=e.srcResolution||(h?t.projectResolution(k,g,a,l):k);if(!m)return null;const {pyramidLevel:p,pyramidResolution:u,excessiveReading:E}=t.snapPyramid(m,this.rasterInfo,this.ioConfig.sampling);if(E)return null;
var q=this.rasterInfo.storageInfo;g=h?t.projectExtent(a,g,l):a;const C=w.unwrap(this.rasterInfo.transform);C&&(g=C.inverseTransform(g));if(null==g)return null;var z={x:Math.floor((g.xmin-q.origin.x)/u.x+.1),y:Math.floor((q.origin.y-g.ymax)/u.y+.1)};const r=Math.ceil((g.xmax-g.xmin)/u.x-.1),F=Math.ceil((g.ymax-g.ymin)/u.y-.1);if(8<r/c||8<F/f||2<=d)return null;var v=yield this.fetchRawPixels(p,z,{width:r,height:F,wrapCount:d},e);if(!v)return null;const G=0<p?q.pyramidBlockWidth:q.blockWidth;q=0<p?q.pyramidBlockHeight:
q.blockHeight;z=G===r&&q===F&&0===z.x%G&&0===z.y%q;if(!h&&z&&1===v.pixelBlocks.length&&G===c&&q===f&&m.x===k.x&&m.y===k.y)return{extent:a,srcExtent:g,pixelBlock:v.pixelBlocks[0]};d=t.getProjectionOffsetGrid(a,v.extent,k,l,C,0<d);h=!e.requestRawData;l={rows:d.spacing[0],cols:d.spacing[1]};k=w.unwrap(this._getRasterTileAlignmentInfo(p,v.extent.xmin));const {pixelBlocks:H,mosaicSize:I,isPartiallyFilled:N}=v;this.rasterJobHandler?c=yield this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:H,srcMosaicSize:I,
destDimension:h?{width:c,height:f}:null,coefs:h?d.coefficients:null,sampleSpacing:h?l:null,interpolation:e.interpolation,alignmentInfo:k},e):(v=S.mosaic(H,I,null,null,k),c=h?S.approximateTransform(v,{width:c,height:f},d.coefficients,l,e.interpolation):v);return e.requestRawData?{srcExtent:g,pixelBlock:c,transformGrid:d,extent:a,isPartiallyFilled:N}:{srcExtent:g,extent:a,pixelBlock:c}});return function(a,c,f){return b.apply(this,arguments)}}();n.fetchRawPixels=function(){var b=x._asyncToGenerator(function*(a,
c,f,e){const {origin:d,blockBoundary:g}=this.rasterInfo.storageInfo,{blockWidth:h,blockHeight:l}=this.getBlockWidthHeight(a);let {x:k,y:m}=c,{width:p,height:u,wrapCount:E}=f;var q=w.unwrap(this._getRasterTileAlignmentInfo(a,0));e.buffer&&(k-=e.buffer.cols,m-=e.buffer.rows,p+=2*e.buffer.cols,u+=2*e.buffer.rows);c=Math.floor(k/h);f=Math.floor(m/l);const C=Math.floor((k+p-1)/h),z=Math.floor((m+u-1)/l);var r=g[a];if(!r)return null;const {minRow:F,minCol:v,maxCol:G,maxRow:H}=r;if(z<F||C<v||f>H||c>G)return null;
r=[];let I=!1;const N=null==this.ioConfig.allowPartialFill?e.allowPartialFill:this.ioConfig.allowPartialFill;for(let J=f;J<=z;J++)for(let K=c;K<=C;K++){const O=0===E||null==q||K<q.worldColumnCountFromOrigin?K:K%q.worldColumnCountFromOrigin-q.originColumnOffset;if(J>=F&&O>=v&&H>=J&&G>=O){const V=this._fetchRawTile(a,J,O,e);N?r.push(new Promise(W=>{V.then(ka=>W(ka)).catch(()=>{I=!0;W(null)})})):r.push(V)}else r.push(null)}if(0===r.length)return null;e=yield Promise.all(r);q={height:(z-f+1)*l,width:(C-
c+1)*h};({spatialReference:r}=this.rasterInfo);a=this.getPyramidPixelSize(a);const {x:X,y:Y}=a;return{extent:new T({xmin:d.x+c*h*X,xmax:d.x+(C+1)*h*X,ymin:d.y-(z+1)*l*Y,ymax:d.y-f*l*Y,spatialReference:r}),pixelBlocks:e,mosaicSize:q,isPartiallyFilled:I}});return function(a,c,f,e){return b.apply(this,arguments)}}();n.fetchRawTile=function(b,a,c,f){throw new P("BaseRaster:read-not-implemented","fetchRawTile() is not implemented");};n.computeExtent=function(b){return t.projectExtent(this.rasterInfo.extent,
b)};n.decodePixelBlock=function(b,a){return!this.rasterJobHandler||a.useCanvas?ia.decode(b,a):this.rasterJobHandler.decode({data:b,options:a})};n.request=function(){var b=x._asyncToGenerator(function*(a,c,f){var e,d;const {customFetchParameters:g}=this.ioConfig,{range:h,query:l,headers:k}=c;f=null!=(e=null!=(d=f)?d:c.retryCount)?e:this.ioConfig.retryCount;e=h?{Range:`bytes=${h.from}-${h.to}`}:null;try{return yield Z(a,{...c,query:{...l,...g},headers:{...k,...e}})}catch(m){if(0<f)return f--,this.request(a,
c,f);throw m;}});return function(a,c,f){return b.apply(this,arguments)}}();n.getSliceIndex=function(b){const {multidimensionalInfo:a}=this.rasterInfo;if(!w.isSome(a)||null==b||!b.length)return null;let c=0;const f=b[0].variableName;for(let g=0;g<a.variables.length;g++){var e=a.variables[g];const h=e.dimensions;if(e.name!==f){c+=h.map(k=>this._getDimensionValuesCount(k)).reduce((k,m)=>k+m);break}e=h.map(k=>this._getDimensionValuesCount(k));const l=h.length;for(let k=0;k<l;k++){var d=b.filter(m=>m.dimensionName===
h[k].name)[0];if(null==d)return null;d=Array.isArray(d.values[0])?d.values[0][0]:d.values[0];d=this._getIndexFromDimensions(d,h[k]);if(-1===d)return null;e.shift();c=k===l-1?c+d:c+d*e.reduce((m,p)=>m+p)}}return c};n.updateTileInfo=function(){const {storageInfo:b,spatialReference:a,extent:c,pixelSize:f}=this.rasterInfo;if(!b.tileInfo){const d=[];var e=b.maximumPyramidLevel||0;let g=Math.max(f.x,f.y),h=1/.0254*96*g;for(let l=0;l<=e;l++)d.push({level:e-l,resolution:g,scale:h}),g*=2,h*=2;e=new M({x:c.xmin,
y:c.ymax,spatialReference:a});b.tileInfo=new R({origin:e,size:[b.blockWidth,b.blockHeight],spatialReference:a,lods:d});b.isVirtualTileInfo=!0}};n.createRemoteDatasetStorageInfo=function(b,a=512,c=512,f){const {width:e,height:d,nativeExtent:g,pixelSize:h,spatialReference:l}=b,k=new M({x:g.xmin,y:g.ymax,spatialReference:l});null==f&&(f=Math.max(0,Math.round(Math.log(Math.max(e,d))/Math.LN2-8)));const m=this.computeBlockBoundary(g,512,512,{x:g.xmin,y:g.ymax},[h],f);b.storageInfo=new ha({blockWidth:a,
blockHeight:c,pyramidBlockWidth:a,pyramidBlockHeight:c,origin:k,firstPyramidLevel:1,maximumPyramidLevel:f,blockBoundary:m})};n.computeBestPyramidLevelForLocation=function(){var b=x._asyncToGenerator(function*(a,c){return 0});return function(a){return b.apply(this,arguments)}}();n.computeBlockBoundary=function(b,a,c,f,e,d=0,g=2){if(1===e.length&&0<d){e=[...e];let {x:k,y:m}=e[0];for(let p=0;p<d;p++)k*=g,m*=g,e.push({x:k,y:m})}d=[];const {x:h,y:l}=f;for(f=0;f<e.length;f++){const {x:k,y:m}=e[f];d.push({minCol:Math.floor((b.xmin-
h+.1*k)/a/k),maxCol:Math.floor((b.xmax-h-.1*k)/a/k),minRow:Math.floor((l-b.ymax+.1*m)/c/m),maxRow:Math.floor((l-b.ymin-.1*m)/c/m)})}return d};n.getPyramidPixelSize=function(b){const {nativePixelSize:a}=this.rasterInfo,{pyramidResolutions:c,pyramidScalingFactor:f}=this.rasterInfo.storageInfo;if(0===b)return a;if(w.isSome(c)&&c.length)return c[b-1];b=f**b;return{x:a.x*b,y:a.y*b}};n.identifyPixelLocation=function(b,a,c){const {spatialReference:f,nativeExtent:e}=this.rasterInfo,{blockWidth:d,blockHeight:g,
maximumPyramidLevel:h,origin:l}=this.rasterInfo.storageInfo;b=t.projectPoint(b,f,c);if(!e.intersects(b)||0>a||a>h)return null;c=this.getPyramidPixelSize(a);const {x:k,y:m}=c;c=(l.y-b.y)/m/g;const p=(b.x-l.x)/k/d;return{pyramidLevel:a,row:Math.floor(c),col:Math.floor(p),rowOffset:Math.min(g-1,Math.floor((c-Math.floor(c))*g)),colOffset:Math.min(d-1,Math.floor((p-Math.floor(p))*d)),srcLocation:b}};n.getTileExtent=function(b,a,c,f,e,d){const [g,h]=d;c=f.x+c*g*b.x;a=f.y-a*h*b.y;return new T({xmin:c,xmax:c+
g*b.x,ymin:a-h*b.y,ymax:a,spatialReference:e})};n.getBlockWidthHeight=function(b){return{blockWidth:0<b?this.rasterInfo.storageInfo.pyramidBlockWidth:this.rasterInfo.storageInfo.blockWidth,blockHeight:0<b?this.rasterInfo.storageInfo.pyramidBlockHeight:this.rasterInfo.storageInfo.blockHeight}};n.isBlockOutside=function(b,a,c){b=this.rasterInfo.storageInfo.blockBoundary[b];return!b||b.maxRow<a||b.maxCol<c||b.minRow>a||b.minCol>c};n._fetchRawTile=function(b,a,c,f){var e=this.rasterInfo.storageInfo.blockBoundary[b];
if(!e)return Promise.resolve(null);const {minRow:d,minCol:g,maxCol:h,maxRow:l}=e;if(a<d||c<g||a>l||c>h)return Promise.resolve(null);const k=B.getRasterId(this.url,f.sliceId),m=`${b}/${a}/${c}`;e=B.getBlock(k,f.registryId,m);if(w.isNone(e)){const p=Q.createAbortController();e=this.fetchRawTile(b,a,c,{...f,signal:p.signal});B.putBlock(k,f.registryId,m,e,p);e.catch(()=>B.deleteBlock(k,f.registryId,m))}if(f.signal)Q.onAbort(f,()=>{B.decreaseRefCount(k,f.registryId,m)});return e};n._getIndexFromDimensions=
function(b,a){const {extent:c,interval:f,unit:e,values:d}=a;if(null!=d&&d.length)return Array.isArray(d[0])?d.findIndex(k=>k[0]<=b&&k[1]>=b):d.indexOf(b);if(b>c[1])return-1;const g=c[0];let h=-1;if("ISO8601"===e){var l;switch((null==(l=a.intervalUnit)?void 0:l.toLowerCase())||"seconds"){case "seconds":h=Math.round((b-g)/1E3/f);break;case "minutes":h=Math.round((b-g)/6E4/f);break;case "hours":h=Math.round((b-g)/36E5/f);break;case "days":h=Math.round((b-g)/864E5/f);break;case "years":h=Math.round(((new Date(b)).getUTCFullYear()-
(new Date(g)).getUTCFullYear())/f);break;case "decades":h=Math.round(((new Date(b)).getUTCFullYear()-(new Date(g)).getUTCFullYear())/10/f)}return h}return Math.round((b-g)/f)};n._getDimensionValuesCount=function(b){const {extent:a,interval:c,unit:f,values:e}=b;let d=(null==e?void 0:e.length)||0;if(d)return d;const g=a[0];if(0===d&&"ISO8601"===f){var h;switch((null==(h=b.intervalUnit)?void 0:h.toLowerCase())||"seconds"){case "seconds":d=Math.round((a[1]-a[0])/1E3/c);break;case "minutes":d=Math.round((a[1]-
a[0])/6E4/c);break;case "hours":d=Math.round((a[1]-a[0])/36E5/c);break;case "days":d=Math.round((a[1]-a[0])/864E5/c);break;case "years":d=Math.round(((new Date(a[1])).getUTCFullYear()-(new Date(g)).getUTCFullYear())/c);break;case "decades":d=Math.round(((new Date(a[1])).getUTCFullYear()-(new Date(g)).getUTCFullYear())/10/c)}return d}return Math.round((a[1]-a[0])/c)};n._getRasterTileAlignmentInfo=function(b,a){null==this._rasterTileAlighmentInfo&&(this._rasterTileAlighmentInfo=t.getRasterDatasetAlignmentInfo(this.rasterInfo));
return w.isSome(this._rasterTileAlighmentInfo.pyramidsInfo)?{startX:a,halfWorldWidth:this._rasterTileAlighmentInfo.halfWorldWidth,hasGCSSShiftTransform:this._rasterTileAlighmentInfo.hasGCSSShiftTransform,...this._rasterTileAlighmentInfo.pyramidsInfo[b]}:null};n._getRequestOptionsWithSliceId=function(b){var a;null!=(a=b.multidimensionalDefinition)&&a.length&&w.isSome(this.rasterInfo.multidimensionalInfo)&&null==b.sliceId&&(b={...b,sliceId:this.getSliceIndex(b.multidimensionalDefinition)||0});return b};
x._createClass(L,[{key:"url",set:function(b){this._set("url",ea.sanitizeUrl(b,ba.getLogger(this.declaredClass)))}}]);return L}(ca.EsriPromiseMixin(aa.JSONSupport));A.__decorate([D.property()],y.prototype,"_rasterTileAlighmentInfo",void 0);A.__decorate([D.property(fa.url)],y.prototype,"url",null);A.__decorate([D.property({type:String,json:{write:!0}})],y.prototype,"datasetName",void 0);A.__decorate([D.property({type:String,json:{write:!0}})],y.prototype,"datasetFormat",void 0);A.__decorate([D.property()],
y.prototype,"rasterInfo",void 0);A.__decorate([D.property()],y.prototype,"ioConfig",void 0);A.__decorate([D.property()],y.prototype,"sourceJSON",void 0);return y=A.__decorate([da.subclass("esri.layers.support.rasterDatasets.BaseRaster")],y)});