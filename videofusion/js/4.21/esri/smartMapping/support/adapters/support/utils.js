// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.21/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/promiseUtils ../../../../renderers/support/heatmapUtils ../../../../rest/support/ClassBreaksDefinition ../../../../rest/support/generateRendererUtils ../../../statistics/support/predominanceUtils ../../utils ../../../../support/arcadeOnDemand".split(" "),function(n,t,S,K,T,U,V,u,W){function B(){B=t._asyncToGenerator(function*(a,b,c){const d=[];if(b)for(const e of b)b=a.getField(e),"availableFields"in c&&-1===c.availableFields.indexOf(b.name)&&
d.push(b.name);return d});return B.apply(this,arguments)}function C(){C=t._asyncToGenerator(function*(a,b,c){b=yield w(a,b);b=L(b,a.minValue,a.maxValue);const d=X(b,!a.normalizationType);c&&["avg","stddev","variance"].forEach(e=>{null!=d[e]&&(d[e]=Math.ceil(d[e]))});return d});return C.apply(this,arguments)}function L(a,b,c){b=null==b?-Infinity:b;c=null==c?Infinity:c;return a.filter(d=>Number.isFinite(d)&&d>=b&&d<=c)}function w(a,b){return D.apply(this,arguments)}function D(){D=t._asyncToGenerator(function*(a,
b){const c=a.field,d="function"===typeof c,e=a.valueExpression,g=a.normalizationType,k=a.normalizationField,f=a.normalizationTotal,h=[];a=a.view;let m=null,l=null;if(e){if(!v){const {arcadeUtils:q}=yield W.loadArcade();v=q}m=v.createFunction(e);l=a&&v.getViewInfo({viewingMode:"2d"===a.type?"map":a.viewingMode,scale:a.scale,spatialReference:a.spatialReference})}if(!b)return h;b.forEach(q=>{var r=q.attributes;if(e){var p=v.createExecContext(q,l);p=v.executeFunction(m,p)}else d?p=c.call(null,q):r&&(p=
r[c]);g&&Number.isFinite(p)&&(r=r&&parseFloat(r[k]),q=p,p=null,"log"===g&&0!==q?p=Math.log(q)*Math.LOG10E:"percent-of-total"===g&&Number.isFinite(f)&&0!==f?p=q/f*100:"field"===g&&Number.isFinite(r)&&0!==r?p=q/r:"natural-log"===g&&0<q?p=Math.log(q):"square-root"===g&&0<q&&(p=q**.5));h.push(p)});return h});return D.apply(this,arguments)}function X(a,b){let c=Number.POSITIVE_INFINITY,d=Number.NEGATIVE_INFINITY,e=null,g=null;var k=null;let f=null;for(var h of a)e+=h,c=Math.min(c,h),d=Math.max(d,h);if(h=
a.length){g=e/h;k=0;for(const m of a)k+=(m-g)**2;f=b?1<h?k/(h-1):0:0<h?k/h:0;k=Math.sqrt(f)}else d=c=null;return{avg:g,count:h,max:d,min:c,stddev:k,sum:e,variance:f}}function M(a){const b=a.field,c=a.classificationMethod||"equal-interval",d=a.normalizationType,e=a.normalizationField,g=new T;g.classificationField=b;g.breakCount=a.breakCount;g.classificationMethod=c;g.standardDeviationInterval="standard-deviation"===c?a.standardDeviationInterval||1:void 0;g.normalizationType=d;g.normalizationField=
"field"===d?e:void 0;return g}function E(){E=t._asyncToGenerator(function*(a,b){var c=a.normalizationTotal;const d=M({field:a.field,normalizationType:a.normalizationType,normalizationField:a.normalizationField,classificationMethod:a.classificationMethod,standardDeviationInterval:a.standardDeviationInterval,breakCount:a.numClasses||5});b=yield w(a,b);b=L(b,a.minValue,a.maxValue);c=U.createGenerateRendererClassBreaks({definition:d,values:b,normalizationTotal:c});return N(a,c)});return E.apply(this,
arguments)}function N(a,b){let c=b.classBreaks;const d=c[0].minValue,e=c[c.length-1].maxValue,g="standard-deviation"===a.classificationMethod,k=Y;c=c.map(f=>{const h=f.label;f={minValue:f.minValue,maxValue:f.maxValue,label:h};if(g&&h){const m=h.match(k).map(l=>+l.trim());2===m.length?(f.minStdDev=m[0],f.maxStdDev=m[1],0>m[0]&&0<m[1]&&(f.hasAvg=!0)):1===m.length&&(-1<h.indexOf("\x3c")?(f.minStdDev=null,f.maxStdDev=m[0]):-1<h.indexOf("\x3e")&&(f.minStdDev=m[0],f.maxStdDev=null))}return f});return{minValue:d,
maxValue:e,classBreakInfos:c,normalizationTotal:b.normalizationTotal}}function F(a,b,c){const d=(b-a)/c,e=[];let g;for(let k=1;k<=c;k++)g=a+d,g=Number(g.toFixed(16)),e.push([a,k===c?b:g]),a=g;return e}function O(a){const {field:b,normalizationType:c,normalizationField:d,normalizationTotal:e,layer:g}=a;a=u.isIntegerField(g,b);let k=b;"percent-of-total"===c?k=`((${a?u.castIntegerFieldToFloat(b):b} / ${e}) * 100)`:"log"===c?k=`(log(${b}) * ${Z})`:"field"===c?k=`(${a?u.castIntegerFieldToFloat(b):b} / ${d})`:
"natural-log"===c?k=`(log(${a?u.castIntegerFieldToFloat(b):b}))`:"square-root"===c&&(k=`(power(${a?u.castIntegerFieldToFloat(b):b}, 0.5))`);return k}function G(){G=t._asyncToGenerator(function*(a,b,c){const {min:d,max:e,normTotal:g}=b,k=a.numBins||10,f=b.intervals||F(d,e,k);b=f.map((h,m)=>({minValue:f[m][0],maxValue:f[m][1],count:0}));a=yield w(a,c);for(const h of a)null!=h&&h>=d&&h<=e&&(a=aa(f,h),-1<a&&b[a].count++);return{bins:b,minValue:d,maxValue:e,normalizationTotal:g}});return G.apply(this,
arguments)}function aa(a,b){let c=-1;for(let d=a.length-1;0<=d;d--)if(b>=a[d][0]){c=d;break}return c}function P(a,b){let c;b=b.toLowerCase();if(a)for(const d in a)if(d.toLowerCase()!==b){c=a[d];break}return c}function H(a,b){let c;b=b.toLowerCase();if(a)for(const d in a)if(d.toLowerCase()===b){c=a[d];break}return c}function I(a,b){if(b)for(const c in a)a[c].label=b[c];return{count:a}}function Q(a,b,c){const d=a.count;a=[];c&&b&&"coded-value"===b.type&&b.codedValues.forEach(e=>{e=e.code;d.hasOwnProperty(e)||
(d[e]={data:e,count:0})});for(const e in d)b=d[e],a.push({value:b.data,count:b.count,label:b.label});return{uniqueValueInfos:a}}function J(){J=t._asyncToGenerator(function*(a,b,c){b=yield w(a,b);const d={};for(let e of b){if(null==e||"string"===typeof e&&""===e.trim())e=null;null==d[e]?d[e]={count:1,data:e}:d[e].count++}return Q({count:d},c,a.returnAllCodedValues)});return J.apply(this,arguments)}const ba=/_value$/i,Y=/\s*(\+|-)?((\d+(\.\d+)?)|(\.\d+))\s*/gi,Z=Math.LOG10E,R="min max avg stddev count sum variance nullcount".split(" ");
let v=null;n.calculateClassBreaksFromMemory=function(a,b){return E.apply(this,arguments)};n.calculateHeatmapStats=function(a,b=10,c,d,e,g){const k=new Float64Array(e*g),f=K.createKernel(b);b=Math.round(3*b);let h=Number.POSITIVE_INFINITY,m=Number.NEGATIVE_INFINITY;var l=0;let q=0,r=0,p=0;c=K.createValueFunction(d,c);for(const {geometry:y,attributes:ca}of a){a=y.x-b;d=y.y-b;const da=Math.max(0,a);l=Math.max(0,d);const ea=Math.min(g,y.y+b),fa=Math.min(e,y.x+b),ha=+c(ca);for(let z=l;z<ea;z++){const ia=
f[z-d];for(let A=da;A<fa;A++){l=z*e+A;var x=k[l];l=k[l]+=ia*f[A-a]*ha;x=l-x;q+=x;r+=x*x;l<h&&(h=l);l>m&&(m=l);p++}}}return p?{mean:q/p,stdDev:Math.sqrt((r-q*q/p)/p),min:h,max:m,mid:(m-h)/2,count:p}:{mean:0,stddev:0,min:0,max:0,mid:0,count:0}};n.calculateHistogramFromMemory=function(a,b,c){return G.apply(this,arguments)};n.calculateStatsFromMemory=function(a,b,c){return C.apply(this,arguments)};n.calculateUniqueValuesFromMemory=function(a,b,c){return J.apply(this,arguments)};n.createCBDefn=M;n.createUVResult=
Q;n.ensureFeaturesJSON=function(a){return a.map(b=>b.toJSON())};n.generateBinParams=function(a){const b=[],c=a.classBreaks,d=c[0].minValue,e=c[c.length-1].maxValue;c.forEach(g=>{b.push([g.minValue,g.maxValue])});return{min:d,max:e,intervals:b,sqlExpr:O({field:a.field,normalizationType:a.normalizationType,normalizationField:a.normalizationField,normalizationTotal:a.normalizationTotal,layer:a.layer}),excludeZerosExpr:a.where,normTotal:a.normalizationTotal}};n.getDataValues=w;n.getEqualIntervalBins=
F;n.getFieldExpr=O;n.getHistogramFromFeatureSet=function(a,b,c,d,e){const g={};a&&a.features&&a.features.forEach(f=>{var h=f.attributes;f=P(h,"countOFExpr");h=H(h,"countOFExpr");0!==f&&(g[f]=h)});const k=[];F(b,c,d).forEach((f,h)=>{h=(h+1).toString();k.push({minValue:f[0],maxValue:f[1],count:g.hasOwnProperty(h)?g[h]:0})});return{bins:k,minValue:b,maxValue:c,normalizationTotal:e}};n.getMissingFields=function(a,b,c){return B.apply(this,arguments)};n.getPredominantCategoriesFromUVInfos=function(a,b){const c=
a.map(e=>e.value),d=b.filter(e=>-1===c.indexOf(e));for(const e of d)a.push({value:e,count:0});a.sort((e,g)=>b.indexOf(e.value)-b.indexOf(g.value));for(const e of a)e.value===V.noDominantCategoryField&&(e.value=null);return{predominantCategoryInfos:a}};n.getSummaryStatisticsFromFeatureSet=function(a,b){a=(a=a&&a.features)&&a[0]&&a[0].attributes;const c={};for(const d in a)c[d.replace(ba,"").toLowerCase()]=a[d];null!=c.totalcount&&c.totalcount>=c.count&&(c.nullcount=c.totalcount-c.count);delete c.totalcount;
c.min===c.max&&null!=c.min&&null==c.stddev&&(c.stddev=c.variance=0);b&&("min max avg stddev sum variance".split(" ").forEach(d=>{null!=c[d]&&(c[d]=Math.ceil(c[d]))}),c.min===c.max&&null!=c.min&&(c.avg=c.min,c.stddev=c.variance=0));return c};n.getUniqueValuesFromFeatureSet=function(a,b,c,d,e,g){const k="countOF"+(c||"Expr"),f={};let h=!1;(a&&a.features).forEach(m=>{var l=m.attributes;m=H(l,k);l=c?H(l,c):P(l,k);null===l&&0===m&&(h=!0);if(null==l||"string"===typeof l&&""===l.trim())l=null;null==f[l]?
f[l]={count:m,data:l}:f[l].count+=m});return c&&h?b.queryFeatureCount({whereClause:c+" is NULL",view:d,signal:g}).then(m=>{f["null"].count+=m||0;return I(f,e)}).catch(()=>{S.throwIfAborted(g);return I(f,e)}):Promise.resolve(I(f,e))};n.msSinceUnixEpochSQL=function(a,b){return u.getDateDiffSQL(a,new Date(0),b,"milliseconds").sqlExpression};n.processSummaryStatisticsResult=function(a){let b;for(b in a)-1<R.indexOf(b)&&(Number.isFinite(a[b])||(a[b]=null));return a};n.resolveCBResult=N;n.statisticTypes=
R;Object.defineProperty(n,"__esModule",{value:!0})});