// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.21/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/colorUtils ../../core/JSONSupport ../../core/Logger ../../core/maybe ../../core/accessorSupport/decorators/property ../../core/has ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/subclass ../../layers/support/RasterInfo ../../layers/support/rasterFunctions/pixelUtils ../../layers/support/rasterFunctions/surfaceUtils ./colorRampUtils".split(" "),function(I,A,J,y,K,u,B,P,Q,L,M,r,C,D){function N(w,
z){const {attributeTable:n,bandCount:b}=w;return!u.isSome(n)||1<b||z&&null==n.fields.find(a=>a.name.toLowerCase()===z.toLowerCase())?!1:!0}function O(w){const {bandCount:z,colormap:n}=w;return u.isSome(n)&&n.length&&1===z}function E(w){return r.isValidPixelBlock(w)&&0!==w.validPixelCount}const F=K.getLogger("esri.renderers.support.RasterSymbolizer"),G={u1:[0,1],u2:[0,3],u4:[0,15],u8:[0,255],s8:[-128,127],u16:[0,65535],s16:[-32768,32767],u32:[0,4294967295],s32:[-2147483648,2147483647],f32:[-3.4*1E39,
3.4*1E39],f64:[-Number.MAX_VALUE,Number.MAX_VALUE]};y=function(w){function z(b){return w.call(this,b)||this}I._inheritsLoose(z,w);var n=z.prototype;n.bind=function(){const {rendererJSON:b}=this;if(!b)return!1;this.lookup={rendererJSON:{}};let a;switch(b.type){case "uniqueValue":a=this._updateUVRenderer(b);break;case "rasterColormap":a=this._updateColormapRenderer(b);break;case "rasterStretch":a=this._updateStretchRenderer(b);break;case "classBreaks":a=this._updateClassBreaksRenderer(b);break;case "rasterShadedRelief":a=
this._updateShadedReliefRenderer(b);break;case "vectorField":a=this._updateVectorFieldRenderer()}return a};n.symbolize=function(b){let a=b&&b.pixelBlock;if(!E(a))return a;if(b.simpleStretchParams&&"rasterStretch"===this.rendererJSON.type)return this.simpleStretch(a,b.simpleStretchParams);try{3<a.pixels.length&&(a=r.extractBands(a,[0,1,2]));let d;switch(this.rendererJSON.type){case "uniqueValue":case "rasterColormap":d=this._symbolize_colormap(a);break;case "classBreaks":d=this._symbolize_classBreaks(a);
break;case "rasterStretch":d=this._symbolize_stretch(a,b.bandIds);break;case "rasterShadedRelief":({extent:b}=b),d=this._symbolize_shadedRelief(a,{isGCS:b.spatialReference.isGeographic,resolution:{x:(b.xmax-b.xmin)/a.width,y:(b.ymax-b.ymin)/a.height}})}return d}catch(d){return F.error("symbolize",d.message),a}};n.simpleStretch=function(b,a){if(!E(b))return b;try{return 3<b.pixels.length&&(b=r.extractBands(b,[0,1,2])),r.stretch(b,a)}catch(d){return F.error("symbolize",d.message),b}};n.generateWebGLParameters=
function(b){if(-1<["uniqueValue","rasterColormap","classBreaks"].indexOf(this.rendererJSON.type)){var a;const {indexedColormap:f,offset:k}=(null==(a=this.lookup)?void 0:a.colormapLut)||{};return{colormap:f,colormapOffset:k,type:"lut"}}const {pixelBlock:d,isGCS:h,resolution:c,bandIds:e}=b;({rendererJSON:b}=this);return"rasterStretch"===b.type?this.generateStretchWebGLParams(d,b,e):"rasterShadedRelief"===b.type?this.generateShadedReliefWebGLParams(b,h,c):"vectorField"===b.type?this._generateVectorFieldWebGLParams(b):
null};n._isLUTChanged=function(b){if(!this.lookup||!this.lookup.rendererJSON)return!0;if("colorRamp"in this.rendererJSON){const a=this.rendererJSON.colorRamp;if(b)return JSON.stringify(a)!==JSON.stringify(this.lookup.rendererJSON.colorRamp);({...this.rendererJSON});({...this.lookup.rendererJSON})}return JSON.stringify(this.rendererJSON)!==JSON.stringify(this.lookup.rendererJSON)};n._symbolize_colormap=function(b){return this._isLUTChanged()&&!this.bind()?b:r.colorize(b,this.lookup.colormapLut)};n._symbolize_classBreaks=
function(b){const a=-1<["u8","u16","s8","s16"].indexOf(this.rasterInfo.pixelType);return this._isLUTChanged()&&!this.bind()?b:a?r.colorize(b,this.lookup.colormapLut):r.remapColor(b,this.lookup.remapLut)};n._symbolize_stretch=function(b,a){const {pixelType:d,bandCount:h}=this.rasterInfo,c=this.rendererJSON,e=-1<["u8","u16","s8","s16"].indexOf(d);let f;var {dra:k}=c;var g=c.useGamma?c.gamma:null;if("histogramEqualization"===c.stretchType){var l=k?null:this.lookup.histogramLut;a=this.getStretchCutoff(c,
b,a,!l);g=r.stretch(b,{...a,gamma:g});g=r.lookupPixels(g,{lut:k?a.histogramLut:l,offset:0})}else if(e){var q;if(k)k=this.getStretchCutoff(c,b,a),f=r.createStretchLUT({pixelType:d,...k,gamma:g});else{if(this._isLUTChanged()&&!this.bind())return b;f=this.lookup?this.lookup.stretchLut:null}if(!f)return b;1<h&&(null==a?void 0:a.length)===(null==(l=u.unwrap(b))?void 0:l.pixels.length)&&(null==(q=f)?void 0:q.lut.length)===h&&(f={lut:a.map(t=>f.lut[t]),offset:f.offset});g=r.lookupPixels(b,f)}else k=this.getStretchCutoff(c,
b,a),g=r.stretch(b,{...k,gamma:g});if(c.colorRamp){if(this._isLUTChanged(!0)&&!this.bind())return b;g=r.colorize(g,this.lookup.colormapLut)}return g};n._symbolize_shadedRelief=function(b,a){var d,h,c=this.rendererJSON;a=C.hillshade(b,{...c,...a});if(!c.colorRamp||this._isLUTChanged(!0)&&!this.bind())return a;c=this.lookup?this.lookup.hsvMap:null;if(!c)return a;const e=null!=(d=null==(h=u.unwrap(this.rasterInfo.statistics))?void 0:h[0])?d:{min:0,max:8E3};C.tintHillshade(a,b,c,e);return a};n._updateVectorFieldRenderer=
function(){const {bandCount:b,dataType:a}=this.rasterInfo;return 2===b&&("vector-magdir"===a||"vector-uv"===a)};n._updateUVRenderer=function(b){const {bandCount:a,attributeTable:d,pixelType:h}=this.rasterInfo,c=b.field1;if(!c)return!1;const e=b.defaultSymbol;var f=1===a&&["u8","s8"].includes(h);if(!N(this.rasterInfo,c)&&!f)return!1;const k=[];if(d){const g=d.fields.filter(l=>"value"===l.name.toLowerCase())[0];if(!g)return!1;d.features.forEach(l=>{var q,t=b.uniqueValueInfos.filter(p=>String(p.value)===
String(l.attributes[c]))[0];(t=null==t?void 0:null==(q=t.symbol)?void 0:q.color)?k.push([l.attributes[g.name]].concat(t)):e&&k.push([l.attributes[g.name]].concat(e.color))})}else{if("value"!==c.toLowerCase())return!1;b.uniqueValueInfos.forEach(g=>{var l;const q=null==g?void 0:null==(l=g.symbol)?void 0:l.color;q?k.push([parseInt(""+g.value,10)].concat(q)):e&&k.push([parseInt(""+g.value,10)].concat(e.color))})}if(0===k.length)return!1;f=r.createColormapLUT({colormap:k});this.lookup={rendererJSON:b,
colormapLut:f};return this.canRenderInWebGL=!0};n._updateColormapRenderer=function(b){if(!O(this.rasterInfo))return!1;var a=b.colormapInfos.map(d=>[d.value].concat(d.color)).sort((d,h)=>d[0]-h[0]);if(!a||0===a.length)return!1;a=r.createColormapLUT({colormap:a});this.lookup={rendererJSON:b,colormapLut:a};return this.canRenderInWebGL=!0};n._updateShadedReliefRenderer=function(b){if("elevation"!==this.rasterInfo.dataType)return!1;if(b.colorRamp){var a=D.convertColorRampToColormap(b.colorRamp,256,!0);
a=r.createColormapLUT({colormap:a});const d=[],h=a.indexedColormap;for(let c=0;c<h.length;c+=4){const e=J.toHSV({r:h[c],g:h[c+1],b:h[c+2]});d.push([e.h/60,e.s/100,255*e.v/100])}this.lookup={rendererJSON:b,colormapLut:a,hsvMap:d}}else this.lookup=null;return this.canRenderInWebGL=!0};n._updateClassBreaksRenderer=function(b){var a=-1<["u8","u16","s8","s16"].indexOf(this.rasterInfo.pixelType),d=b.classBreakInfos;if(null==d||!d.length)return!1;d=d.sort((k,g)=>k.classMaxValue-g.classMaxValue);const h=
d[d.length-1];var c=b.minValue;if(!a){a=[];for(var e=0;e<d.length;e++){var f;a.push({value:null!=(f=d[e].classMinValue)?f:c,mappedColor:d[e].symbol.color});c=d[e].classMaxValue}a.push({value:h.classMaxValue,mappedColor:h.symbol.color});this.lookup={rendererJSON:b,remapLut:a};this.canRenderInWebGL=!1;return!0}f=[];c=Math.floor(b.minValue);for(a=0;a<d.length;a++){for(e=d[a];c<e.classMaxValue;c++)f.push([c].concat(e.symbol.color));c=Math.ceil(e.classMaxValue)}h.classMaxValue===c&&f.push([h.classMaxValue].concat(h.symbol.color));
d=r.createColormapLUT({colormap:f,fillUnspecified:!1});this.lookup={rendererJSON:b,colormapLut:d};return this.canRenderInWebGL=!0};n._isHistogramRequired=function(b){return"percentClip"===b||"histogramEqualization"===b};n._isValidRasterStatistics=function(b){return u.isSome(b)&&0<b.length&&null!=b[0].min&&null!=b[0].max};n._updateStretchRenderer=function(b){var a;let {stretchType:d,dra:h}=b;if(!("none"===d||null!=(a=b.statistics)&&a.length||this._isValidRasterStatistics(this.rasterInfo.statistics)||
h))return!1;var c=u.unwrap(b.histograms||this.rasterInfo.histograms);!this._isHistogramRequired(b.stretchType)||null!=c&&c.length||h||(d="minMax");const {gamma:e,useGamma:f,colorRamp:k}=b;a=this.rasterInfo.pixelType;const g=!h&&-1<["u8","u16","s8","s16"].indexOf(a);"histogramEqualization"===d?(a=c.map(l=>r.createHistogramEqualizationLUT(l)),this.lookup={rendererJSON:b,histogramLut:a}):g&&(c=this.getStretchCutoff(b),a=r.createStretchLUT({pixelType:a,...c,gamma:f?e:null}),this.lookup={rendererJSON:b,
stretchLut:a});k&&(a=D.convertColorRampToColormap(k,256,!0),this.lookup||(this.lookup={rendererJSON:b}),this.lookup.colormapLut=r.createColormapLUT({colormap:a}),this.lookup.rendererJSON=b);return this.canRenderInWebGL=!0};n.getStretchCutoff=function(b,a=null,d,h){var c,e,f,k=b.stretchType;if(b.dra)if("minMax"===k&&u.isSome(a)&&a.statistics)a=a.statistics.map(x=>[x.minValue,x.maxValue,0,0]);else{var g=r.estimateStatisticsHistograms(a);a=u.isSome(g)?g.statistics:null;g=u.isSome(g)?g.histograms:null}else{var l;
a=0<(null==(l=b.statistics)?void 0:l.length)?b.statistics:u.unwrap(this.rasterInfo.statistics);g=b.histograms||u.unwrap(this.rasterInfo.histograms)}!this._isHistogramRequired(k)||null!=(c=g)&&c.length||(k="minMax");l=(null==(e=a)?void 0:e.length)||(null==(f=g)?void 0:f.length)||this.rasterInfo.bandCount;e=[];f=[];let q;let t,p,m;a&&!Array.isArray(a[0])&&(a=a.map(x=>[x.min,x.max,x.avg,x.stddev]));switch(k){case "none":a=G[this.rasterInfo.pixelType]||G.f32;for(c=0;c<l;c++)e[c]=a[0],f[c]=a[1];break;
case "minMax":for(c=0;c<l;c++)e[c]=a[c][0],f[c]=a[c][1];break;case "standardDeviation":for(c=0;c<l;c++)e[c]=a[c][2]-b.numberOfStandardDeviations*a[c][3],f[c]=a[c][2]+b.numberOfStandardDeviations*a[c][3],e[c]<a[c][0]&&(e[c]=a[c][0]),f[c]>a[c][1]&&(f[c]=a[c][1]);break;case "histogramEqualization":for(c=0;c<l;c++)e[c]=g[c].min,f[c]=g[c].max;break;case "percentClip":for(c=0;c<g.length;c++){a=g[c];t=new Uint32Array(a.size);var v=a.counts;q=0;l=(a.max-a.min)/a.size;p=-.5===a.min&&1===l?.5:0;for(m=0;m<a.size;m++)q+=
v[m],t[m]=q;v=b.minPercent*q/100;for(m=0;m<a.size;m++)if(t[m]>v){e[c]=a.min+l*(m+p);break}v=(1-b.maxPercent/100)*q;for(m=a.size-2;0<=m;m--)if(t[m]<v){f[c]=a.min+l*(m+2-p);break}}break;default:for(c=0;c<l;c++)e[c]=a[c][0],f[c]=a[c][1]}let H;"histogramEqualization"===k?(k=g[0].size||256,b=0,h&&(H=g.map(x=>r.createHistogramEqualizationLUT(x)))):(k=b.max||255,b=b.min||0);return this.getSelectedBandCutoffs({minCutOff:e,maxCutOff:f,outMax:k,outMin:b,histogramLut:H},d)};n.getSelectedBandCutoffs=function(b,
a){if(null==a||0===a.length)return b;const d=Math.max.apply(null,a),{minCutOff:h,maxCutOff:c,outMin:e,outMax:f,histogramLut:k}=b;return h.length===a.length||h.length<=d?b:{minCutOff:a.map(g=>h[g]),maxCutOff:a.map(g=>c[g]),histogramLut:k?a.map(g=>k[g]):null,outMin:e,outMax:f}};n.generateStretchWebGLParams=function(b,a,d){let h=null,c=null;var e=this.lookup&&this.lookup.colormapLut;a.colorRamp&&e&&(h=e.indexedColormap,c=e.offset);"histogramEqualization"===a.stretchType&&(a={...a,stretchType:"minMax"});
({gamma:e}=a);const f=!!(a.useGamma&&e&&e.some(v=>1!==v)),{minCutOff:k,maxCutOff:g,outMin:l,outMax:q}=this.getStretchCutoff(a,b,d);var t=0;u.isSome(b)&&(t=b.getPlaneCount(),2===t&&(b=b.clone(),b.statistics=[b.statistics[0]],b.pixels=[b.pixels[0]]));b=Math.min(3,(null==d?void 0:d.length)||t||this.rasterInfo.bandCount);d=new Float32Array(b);t=h||f?1:255;let p;for(p=0;p<b;p++)d[p]=(q-l)/(g[p]-k[p])/t;const m=new Float32Array(b);if(f)for(p=0;p<b;p++)m[p]=1<e[p]?2<e[p]?6.5+(e[p]-2)**2.5:6.5+100*(2-e[p])**
4:1;return{bandCount:b,outMin:l/t,outMax:q/t,minCutOff:k,maxCutOff:g,factor:d,useGamma:f,gamma:f?e:[1,1,1],gammaCorrection:f?m:[1,1,1],colormap:h,colormapOffset:c,stretchType:a.stretchType,type:"stretch"}};n.generateShadedReliefWebGLParams=function(b,a,d){var h,c,e;let f=null,k=null;const g=this.lookup&&this.lookup.colormapLut;b.colorRamp&&g&&(f=g.indexedColormap,k=g.offset);a=C.calculateHillshadeParams({...b,isGCS:a,resolution:d});d=null==(h=u.unwrap(this.rasterInfo.statistics))?void 0:h[0];return{...a,
minValue:null!=(c=null==d?void 0:d.min)?c:0,maxValue:null!=(e=null==d?void 0:d.max)?e:8E3,hillshadeType:"traditional"===b.hillshadeType?0:1,type:"hillshade",colormap:f,colormapOffset:k}};n._generateVectorFieldWebGLParams=function(b){var a,d,h,c,e;const {style:f,inputUnit:k,outputUnit:g,visualVariables:l,symbolTileSize:q,flowRepresentation:t}=b;let p;var m=null!=(a=null==l?void 0:l.find(v=>"sizeInfo"===v.type))?a:{type:"sizeInfo",field:"Magnitude",maxDataValue:null==(d=this.rasterInfo.statistics)?
void 0:d[0].max,maxSize:.8*q,minDataValue:null==(h=this.rasterInfo.statistics)?void 0:h[0].min,minSize:.2*q};a=m?m.minDataValue:null==(c=this.rasterInfo.statistics)?void 0:c[0].min;d=m?m.maxDataValue:null==(e=this.rasterInfo.statistics)?void 0:e[0].max;e=u.isSome(m.maxSize)&&u.isSome(m.minSize)?[m.minSize/q,m.maxSize/q]:[.2,.8];if("wind_speed"===f||"simple_scalar"===f)e[0]=e[1]=(e[0]+e[1])/2;c=u.isSome(a)&&u.isSome(d)?[a,d]:null;if("classified_arrow"===f)if(u.isSome(a)&&u.isSome(d)&&u.isSome(m))for(p=
[],a=(m.maxDataValue-m.minDataValue)/5,d=0;6>d;d++)p.push(m.minDataValue+a*d);else p=[0,1E-6,3.5,7,10.5,14];m="flow_to"===t===("ocean_current_kn"===f||"ocean_current_m"===f)?0:Math.PI;a=null==l?void 0:l.find(v=>"rotationInfo"===v.type);return{breakValues:p,dataRange:c,inputUnit:k,outputUnit:g,symbolTileSize:q,symbolPercentRange:e,style:f||"single_arrow",rotation:m,rotationType:(null==a?void 0:a.rotationType)||b.rotationType,type:"vectorField"}};return z}(y.JSONSupport);A.__decorate([B.property({json:{write:!0}})],
y.prototype,"rendererJSON",void 0);A.__decorate([B.property({type:M,json:{write:!0}})],y.prototype,"rasterInfo",void 0);A.__decorate([B.property({json:{write:!0}})],y.prototype,"lookup",void 0);A.__decorate([B.property()],y.prototype,"canRenderInWebGL",void 0);return y=A.__decorate([L.subclass("esri.renderers.support.RasterSymbolizer")],y)});