/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import t from"../Camera.js";import"../geometry.js";import i from"../Graphic.js";import r from"../Ground.js";import s from"../Viewpoint.js";import a from"../core/Collection.js";import{b as n}from"../chunks/domUtils.js";import o from"../core/Error.js";import{createResolver as l,createAbortController as h,isAbortError as c,createTask as d,after as u,createAbortError as p,throwIfAborted as m,isAborted as g,onAbort as f,isPromise as v,isPromiseLike as _,o as y}from"../core/promiseUtils.js";import{t as x,h as w,m as b}from"../chunks/handleUtils.js";import{i as C,clone as T,k as S,o as P,j as R,b as M,d as D,p as A,h as O,m as F,r as I,u as z,g as E,c as L,s as V,f as k,q as j}from"../core/lang.js";import{L as U}from"../chunks/Logger.js";import{M as q,S as H,b as B,P as N,addFrameTask as G,c as W,setFrameDuration as Q}from"../core/scheduling.js";import{on as Z,init as Y,when as X,whenOnce as K,once as J,whenFalse as $,whenTrueOnce as ee}from"../core/watchUtils.js";import{initialize as te}from"../core/workers/workers.js";import{b as ie,s as re,d as se,c as ae,e as ne,f as oe}from"../chunks/screenUtils.js";import{property as le}from"../core/accessorSupport/decorators/property.js";import{cast as he}from"../core/accessorSupport/decorators/cast.js";import{subclass as ce}from"../core/accessorSupport/decorators/subclass.js";import{e as de}from"../chunks/ensureType.js";import{c as ue,m as pe,r as me,j as ge,b as fe,e as ve,l as _e,k as ye,a as xe,n as we,T as be,f as Ce,s as Te,u as Se,g as Pe,J as Re,U as Me,w as De,C as Ae,h as Oe,S as Fe,d as Ie,F as ze,i as Ee,t as Le,o as Ve,x as ke,p as je,q as Ue,Z as qe,y as He,V as Be,K as Ne,W as Ge,A as We,X as Qe,Y as Ze,_ as Ye,M as Xe,B as Ke,$ as Je,E as $e,H as et,z as tt,a0 as it,a1 as rt,a2 as st,G as at,a3 as nt,a4 as ot,a5 as lt}from"../chunks/mathUtils.js";import ht from"../geometry/HeightModelInfo.js";import{canProjectToWGS84ComparableLonLat as ct,projectPointToWGS84ComparableLonLat as dt,projectPointToVector as ut,projectVectorToVector as pt,projectVectorToDehydratedPoint as mt,projectVectorToPoint as gt,projectBoundingRect as ft,projectWithoutEngine as vt,lonLatToSphericalPCPF as _t,canProjectWithoutEngine as yt,project as xt}from"../geometry/projection.js";import{g as wt,c as bt}from"../chunks/projectionEllipsoid.js";import{c as Ct,e as Tt,o as St,w as Pt,h as Rt,f as Mt,g as Dt,a as At,j as Ot,k as Ft,l as It,m as zt,n as Et,p as Lt,q as Vt,r as kt,d as jt,b as Ut,t as qt}from"../chunks/aaBoundingRect.js";import{f as Ht,b as Bt,e as Nt,c as Gt,a as Wt,t as Qt,d as Zt,B as Yt}from"../chunks/boundedPlane.js";import{g as Xt}from"../chunks/scaleUtils.js";import{b as Kt,i as Jt,c as $t}from"../chunks/layerUtils.js";import{e as ei,j as ti,a as ii,i as ri,k as si,D as ai,B as ni,I as oi,c as li,S as hi,d as ci,f as di,g as ui,P as pi,h as mi}from"../chunks/WebGLRequirements.js";import{D as gi}from"../chunks/DOMContainer.js";import fi from"./GroundView.js";import vi from"./View.js";import _i from"./ViewAnimation.js";import yi,{a as xi,g as wi,d as bi,N as Ci,e as Ti}from"../core/Accessor.js";import{b as Si}from"../chunks/deprecate.js";import{e as Pi,m as Ri,a as Mi}from"../chunks/Ellipsoid.js";import{d as Di,e as Ai,s as Oi,f as Fi,g as Ii,C as zi,b as Ei}from"../chunks/mathUtils2.js";import{C as Li,s as Vi,h as ki,c as ji,e as Ui,a as qi,b as Hi,i as Bi,d as Ni,f as Gi,g as Wi,j as Qi,k as Zi,l as Yi,m as Xi,n as Ki,z as Ji,t as $i,o as er}from"../chunks/Clouds.js";import{E as tr}from"../chunks/Evented.js";import ir from"../webscene/Lighting.js";import rr from"../webscene/Environment.js";import sr from"../Color.js";import ar from"../core/Handles.js";import{a as nr,f as or,b as lr,Z as hr,d as cr}from"../chunks/vec4f64.js";import dr,{f as ur,b as pr,h as mr,k as gr}from"../geometry/SpatialReference.js";import{e as fr,d as vr}from"../chunks/styleUtils.js";import{d as _r,c as yr,j as xr,e as wr,l as br,m as Cr,r as Tr,i as Sr,t as Pr,h as Rr,o as Mr,f as Dr}from"../chunks/mat4.js";import{c as Ar,f as Or,I as Fr}from"../chunks/mat4f64.js";import{s as Ir,d as zr,c as Er,a as Lr,g as Vr,f as kr,k as jr,b as Ur,j as qr,n as Hr,h as Br}from"../chunks/vec2.js";import{a as Nr,Z as Gr}from"../chunks/vec2f64.js";import{T as Wr,E as Qr,a as Zr,l as Yr,t as Xr,H as Kr,b as Jr,D as $r,M as es,V as ts,c as is,d as rs,e as ss,P as as,C as ns,f as os,g as ls,h as hs,i as cs}from"../chunks/objectResourceUtils.js";import{S as ds,g as us,R as ps,p as ms,a as gs,b as fs,c as vs,P as _s,D as ys,d as xs,e as ws,C as bs,f as Cs,T as Ts,h as Ss,i as Ps,j as Rs,k as Ms,l as Ds,m as As,n as Os,o as Fs,q as Is,O as zs,r as Es,s as Ls,t as Vs,u as ks,v as js,A as Us,w as qs,x as Hs,y as Bs,z as Ns,B as Gs,E as Ws,F as Qs,G as Zs,H as Ys,I as Xs,J as Ks,K as Js,L as $s,M as ea,N as ta,Q as ia,U as ra,V as sa,W as aa,X as na,Y as oa,Z as la,_ as ha}from"../chunks/OutputDepth.glsl.js";import{G as ca,M as da,A as ua,F as pa,d as ma,O as ga,c as fa,f as va,W as _a,N as ya,o as xa,b as wa,a as ba,R as Ca,S as Ta,e as Sa,s as Pa,g as Ra,h as Ma,T as Da,i as Aa,j as Oa,k as Fa,l as Ia,C as za}from"../chunks/lineUtils.js";import{m as Ea,s as La,d as Va,a as ka,b as ja,v as Ua,V as qa,B as Ha,g as Ba,c as Na,e as Ga}from"../chunks/VertexArrayObject.js";import{b as Wa,i as Qa,f as Za,d as Ya,e as Xa,g as Ka,s as Ja,c as $a,h as en,j as tn,k as rn,l as sn}from"../chunks/sphere.js";import{a as an,s as nn,b as on}from"../chunks/vectorStacks.js";import{P as ln,F as hn,R as cn}from"../chunks/PhysicallyBasedRendering.glsl.js";import{f as dn,t as un,d as pn,e as mn,g as gn,h as fn}from"../chunks/mat3.js";import{c as vn,d as _n}from"../chunks/quatf64.js";import{z as yn,f as xn,a as wn,b as bn,c as Cn}from"../chunks/vec3f32.js";import{F as Tn,R as Sn}from"../chunks/FramebufferObject.js";import{T as Pn}from"../chunks/Texture.js";import{r as Rn}from"../chunks/requestImageUtils.js";import{g as Mn}from"../chunks/glUtil.js";import{n as Dn}from"../chunks/InterleavedLayout.js";import{G as An}from"../chunks/ColorMaterial.js";import{p as On,a as Fn,l as In,u as zn,v as En,r as Ln,i as Vn,b as kn}from"../chunks/Util.js";import{f as jn,g as Un}from"../chunks/assets.js";import{A as qn,H as Hn}from"../chunks/sdfPrimitives.js";import{W as Bn}from"../core/HandleOwner.js";import{p as Nn}from"../chunks/earthUtils.js";import{c as Gn,C as Wn,a as Qn}from"../chunks/sunUtils.js";import Zn from"../webscene/background/ColorBackground.js";import{w as Yn,c as Xn}from"../chunks/ray.js";import{c as Kn,G as Jn,a as $n,T as eo,b as to,d as io,m as ro,F as so,t as ao,P as no,E as oo,e as lo}from"../chunks/ElevationQuery.js";import{n as ho}from"../chunks/compilerUtils.js";import{C as co}from"../chunks/Camera.js";import{I as uo,s as po,a as mo,G as go,O as fo}from"../chunks/Intersector.js";import{c as vo,j as _o,o as yo,q as xo,n as wo,m as bo,r as Co,t as To,f as So,s as Po}from"../chunks/plane.js";import{f as Ro,a as Mo,b as Do}from"../chunks/ray2.js";import{I as Ao,a as Oo,V as Fo}from"../chunks/InputManager.js";import{F as Io,M as zo,Z as Eo,R as Lo,P as Vo,c as ko,l as jo}from"../chunks/resources.js";import{s as Uo}from"../chunks/MapUtils.js";import{T as qo,n as Ho,I as Bo,a as No}from"../chunks/Scheduler.js";import{f as Go,r as Wo}from"../chunks/asyncUtils.js";import{h as Qo,W as Zo,i as Yo,S as Xo}from"../chunks/ScreenSpacePass.js";import{createLabelFunction as Ko}from"../chunks/labelFormatUtils.js";import{i as Jo}from"../chunks/Symbol3DVerticalOffset.js";import{c as $o,a as el,h as tl,e as il,k as rl,f as sl,s as al,l as nl}from"../chunks/aaBoundingBox.js";import{l as ol,D as ll}from"../chunks/DefaultMaterial_COLOR_GAMMA.js";import{a as hl}from"../chunks/triangle.js";import{O as cl}from"../chunks/ArrayPool.js";import{c as dl,a as ul,f as pl,b as ml,d as gl,e as fl,g as vl,i as _l,p as yl,h as xl,j as wl}from"../chunks/frustum.js";import bl from"../geometry/Extent.js";import Cl from"../geometry/Point.js";import{canProject as Tl,y2lat as Sl}from"../geometry/support/webMercatorUtils.js";import{a as Pl}from"../chunks/unitUtils.js";import{i as Rl,g as Ml}from"../chunks/ElevationProvider.js";import{f as Dl,c as Al}from"../chunks/vec4f32.js";import{create as Ol}from"../chunks/geometryServiceUtils.js";import Fl from"../rest/support/ProjectParameters.js";import{M as Il,a as zl}from"../chunks/MemCache.js";import El,{i as Ll}from"./3d/support/SceneViewPerformanceInfo.js";import{S as Vl,c as kl,g as jl,i as Ul,a as ql,r as Hl,w as Bl,I as Nl,b as Gl,d as Wl,e as Ql,f as Zl,h as Yl,j as Xl,k as Kl,l as Jl,m as $l,u as eh,n as th,o as ih}from"../chunks/terrainUtils.js";import{r as rh,e as sh,g as ah,h as nh}from"../chunks/arrayUtils.js";import{isSVG as oh}from"../core/urlUtils.js";import{T as lh}from"../chunks/Texture2.js";import"../symbols.js";import"../geometry/Polygon.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/PolygonSymbol3D.js";import hh from"../symbols/PointSymbol3D.js";import ch from"../symbols/IconSymbol3DLayer.js";import dh from"../symbols/TextSymbol3DLayer.js";import{T as uh,b as ph}from"../chunks/verticalOffsetUtils.js";import{C as mh}from"../chunks/CollectionFlattener.js";import{aliasOf as gh}from"../core/accessorSupport/decorators/aliasOf.js";import{i as fh}from"../chunks/RefreshableLayer.js";import{E as vh}from"../chunks/ElevationQueryTileCache.js";import{a as _h}from"../chunks/LercDecoder.js";import{V as yh,p as xh}from"../chunks/VectorTile.js";import{L as wh}from"../chunks/LayerView3D.js";import bh from"./layers/LayerView.js";import{E as Ch,W as Th,G as Sh,M as Ph,a as Rh,P as Mh,b as Dh,L as Ah,D as Oh,T as Fh,c as Ih,d as zh,e as Eh,f as Lh}from"../chunks/TerrainConst.js";import{f as Vh,c as kh,t as jh,I as Uh,s as qh,a as Hh,b as Bh,h as Nh,d as Gh}from"../chunks/tileUtils.js";import{c as Wh,g as Qh,a as Zh,b as Yh,d as Xh,e as Kh,f as Jh,h as $h,i as ec,s as tc}from"../chunks/rasterUtils.js";import{a as ic,b as rc}from"../chunks/BufferView.js";import sc from"./2d/ViewState.js";import{R as ac}from"../chunks/RenderGeometry.js";import{c as nc,a as oc}from"../chunks/mat3f32.js";import{c as lc,a as hc}from"../chunks/quat.js";import{c as cc,a as dc}from"../chunks/quatf32.js";import{g as uc}from"../chunks/geometryDataUtils.js";import{V as pc}from"../chunks/VertexColor.glsl.js";import{C as mc}from"../chunks/CameraSpace.glsl.js";import{c as gc}from"../chunks/vec3.js";import{E as fc,w as vc,u as _c,V as yc,g as xc,R as wc,S as bc,a as Cc}from"../chunks/EdgeProcessingWorker.js";import{W as Tc}from"../chunks/WorkerHandle.js";import{e as Sc,c as Pc,r as Rc,t as Mc,s as Dc}from"../chunks/screenshotUtils.js";import{c as Ac,a as Oc}from"../chunks/capabilities2.js";import{R as Fc}from"../chunks/RenderingContext.js";import{t as Ic,a as zc}from"../chunks/intersectorUtilsConversions.js";import{h as Ec}from"../chunks/hitTestSelectUtils.js";import{o as Lc}from"../chunks/layerViewUtils.js";import{i as Vc,c as kc}from"../chunks/screenUtils2.js";import{i as jc}from"../chunks/spatialReferenceSupport.js";import Uc from"./ui/DefaultUI.js";import"../chunks/JSONSupport.js";import"../chunks/metadata.js";import"../chunks/reader.js";import"../chunks/object.js";import"../chunks/writer.js";import"../chunks/Message.js";import"../config.js";import"../chunks/string.js";import"../chunks/common.js";import"../geometry/Geometry.js";import"../geometry/Multipoint.js";import"../chunks/zmUtils.js";import"../geometry/Polyline.js";import"../chunks/extentUtils.js";import"../chunks/typeUtils.js";import"../chunks/jsonMap.js";import"../geometry/support/jsonUtils.js";import"../PopupTemplate.js";import"../layers/support/fieldUtils.js";import"../chunks/arcadeOnDemand.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"../chunks/enumeration.js";import"../popup/support/FieldInfoFormat.js";import"../chunks/date.js";import"../chunks/number.js";import"../chunks/locale.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../chunks/chartMediaInfoUtils.js";import"../chunks/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/TextContent.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../support/actions/ActionBase.js";import"../chunks/Identifiable.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../chunks/colorUtils.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"../chunks/utils.js";import"../symbols/edges/Edges3D.js";import"../chunks/materialUtils.js";import"../chunks/opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"../chunks/Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../symbols/patterns/StylePattern3D.js";import"../chunks/symbolLayerUtils3D.js";import"../chunks/Symbol3DOutline.js";import"../symbols/Font.js";import"../chunks/persistableUrlUtils.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"../chunks/collectionUtils.js";import"../portal/Portal.js";import"../intl.js";import"../request.js";import"../kernel.js";import"../chunks/Loadable.js";import"../chunks/Promise.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../chunks/Thumbnail.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"../chunks/urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"../chunks/loadAll.js";import"../core/workers/Connection.js";import"../core/workers/RemoteClient.js";import"../chunks/pe.js";import"../chunks/geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"../chunks/lineSegment.js";import"./input/gamepad/GamepadInputDevice.js";import"../chunks/projector.js";import"../chunks/widgetUtils.js";import"../widgets/Popup.js";import"../chunks/throttle.js";import"../widgets/Feature.js";import"../widgets/Widget.js";import"../chunks/uuid.js";import"../chunks/jsxWidgetSupport.js";import"../widgets/Attachments.js";import"../widgets/Attachments/AttachmentsViewModel.js";import"../rest/query/support/AttachmentInfo.js";import"../rest/support/AttachmentQuery.js";import"../chunks/messageBundle.js";import"../chunks/jsxFactory.js";import"../widgets/Feature/FeatureViewModel.js";import"../rest/support/Query.js";import"../TimeExtent.js";import"../chunks/timeUtils.js";import"../chunks/DataLayerSource.js";import"../layers/support/Field.js";import"../chunks/domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"../chunks/fieldType.js";import"../rest/support/StatisticDefinition.js";import"../rest/support/RelationshipQuery.js";import"../tasks/QueryTask.js";import"../chunks/executeForTopCount.js";import"../chunks/utils4.js";import"../chunks/query.js";import"../geometry/support/normalizeUtils.js";import"../chunks/normalizeUtilsCommon.js";import"../chunks/pbfQueryUtils.js";import"../chunks/pbf.js";import"../chunks/OptimizedFeature.js";import"../chunks/OptimizedFeatureSet.js";import"../chunks/queryZScale.js";import"../chunks/zscale.js";import"../chunks/featureConversionUtils.js";import"../rest/support/FeatureSet.js";import"../rest/support/TopFeaturesQuery.js";import"../rest/support/TopFilter.js";import"../chunks/executeQueryJSON.js";import"../tasks/Task.js";import"../layers/FeatureLayer.js";import"../renderers/ClassBreaksRenderer.js";import"../renderers/Renderer.js";import"../renderers/support/AuthoringInfo.js";import"../renderers/support/AuthoringInfoVisualVariable.js";import"../chunks/colorRamps.js";import"../rest/support/AlgorithmicColorRamp.js";import"../rest/support/ColorRamp.js";import"../rest/support/MultipartColorRamp.js";import"../chunks/VisualVariablesMixin.js";import"../renderers/visualVariables/ColorVariable.js";import"../renderers/visualVariables/VisualVariable.js";import"../chunks/LegendOptions.js";import"../renderers/visualVariables/support/ColorStop.js";import"../renderers/visualVariables/OpacityVariable.js";import"../renderers/visualVariables/support/OpacityStop.js";import"../renderers/visualVariables/RotationVariable.js";import"../renderers/visualVariables/SizeVariable.js";import"../renderers/visualVariables/support/SizeStop.js";import"../chunks/sizeVariableUtils.js";import"../chunks/visualVariableUtils.js";import"../chunks/lengthUtils.js";import"../renderers/support/ClassBreakInfo.js";import"../symbols/support/jsonUtils.js";import"../chunks/symbolConversion.js";import"../chunks/commonProperties.js";import"../renderers/DictionaryRenderer.js";import"../chunks/LRUCache.js";import"../renderers/DotDensityRenderer.js";import"../renderers/support/AttributeColorInfo.js";import"../renderers/HeatmapRenderer.js";import"../renderers/support/HeatmapColorStop.js";import"../renderers/SimpleRenderer.js";import"../renderers/UniqueValueRenderer.js";import"../chunks/diffUtils.js";import"../renderers/support/UniqueValueInfo.js";import"../chunks/devEnvironmentUtils.js";import"../renderers/support/jsonUtils.js";import"../chunks/MultiOriginJSONSupport.js";import"../chunks/ReadOnlyMultiOriginJSONSupport.js";import"../core/sql.js";import"../form/FormTemplate.js";import"../form/ExpressionInfo.js";import"../form/elements/GroupElement.js";import"../form/elements/FieldElement.js";import"../form/elements/support/inputs.js";import"../form/elements/inputs/BarcodeScannerInput.js";import"../form/elements/inputs/TextInput.js";import"../form/elements/inputs/Input.js";import"../form/elements/inputs/ComboBoxInput.js";import"../form/elements/inputs/DateTimePickerInput.js";import"../form/elements/inputs/RadioButtonsInput.js";import"../form/elements/inputs/SwitchInput.js";import"../form/elements/inputs/TextAreaInput.js";import"../form/elements/inputs/TextBoxInput.js";import"../form/support/elements.js";import"../layers/Layer.js";import"../chunks/FeatureIndex.js";import"../chunks/shared.js";import"../chunks/APIKeyMixin.js";import"../chunks/ArcGISService.js";import"../chunks/arcgisLayerUrl.js";import"../chunks/BlendLayer.js";import"../chunks/parser.js";import"../chunks/mat4f32.js";import"../chunks/_commonjsHelpers.js";import"../chunks/CustomParametersMixin.js";import"../chunks/OperationalLayer.js";import"../chunks/commonProperties2.js";import"../support/timeUtils.js";import"../chunks/ElevationInfo.js";import"../chunks/unitConversionUtils.js";import"../chunks/OrderedLayer.js";import"../chunks/PortalLayer.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../chunks/ScaleRangeLayer.js";import"../chunks/TemporalLayer.js";import"../TimeInterval.js";import"../layers/support/TimeInfo.js";import"../chunks/featureReductionUtils.js";import"../layers/support/FeatureReductionSelection.js";import"../layers/support/FeatureReductionCluster.js";import"../layers/support/LabelClass.js";import"../chunks/labelUtils.js";import"../chunks/defaults.js";import"../chunks/defaultsJSON.js";import"../layers/support/FeatureTemplate.js";import"../layers/support/FeatureType.js";import"../chunks/fieldProperties.js";import"../layers/support/FieldsIndex.js";import"../layers/support/GeometryFieldsInfo.js";import"../chunks/labelingInfo.js";import"../layers/support/LayerFloorInfo.js";import"../layers/support/Relationship.js";import"../chunks/styleUtils2.js";import"../support/popupUtils.js";import"../chunks/Heading.js";import"../widgets/support/widget.js";import"../chunks/accessibleHandler.js";import"../chunks/vmEvent.js";import"../widgets/Spinner/SpinnerViewModel.js";import"../chunks/AnchorElementViewModel.js";import"../widgets/Popup/PopupViewModel.js";import"../symbols/support/symbolUtils.js";import"../chunks/utils2.js";import"../chunks/ItemCache.js";import"../symbols/support/cimSymbolUtils.js";import"../chunks/utils3.js";import"../chunks/actions.js";import"../chunks/GoTo.js";import"../chunks/Queue.js";import"../layers/support/ElevationSampler.js";import"../layers/support/TileInfo.js";import"../layers/support/LOD.js";import"../Map.js";import"../Basemap.js";import"../chunks/writeUtils.js";import"../chunks/basemapUtils.js";import"../chunks/TablesMixin.js";import"../chunks/GraphicsCollection.js";import"./BasemapView.js";import"./Magnifier.js";import"../chunks/interactiveToolUtils.js";import"./input/Input.js";import"./input/gamepad/GamepadSettings.js";import"./navigation/Navigation.js";import"./navigation/gamepad/GamepadSettings.js";import"../chunks/heightModelInfoUtils.js";import"../webscene/background/Background.js";import"../chunks/Version.js";import"../chunks/testSVGPremultipliedAlpha.js";import"../chunks/VerticalOffset.glsl.js";import"../chunks/triangulationUtils.js";import"../chunks/earcut.js";import"../chunks/deduplicate.js";import"../chunks/vec2f32.js";import"../chunks/types.js";import"../chunks/dehydratedFeatures.js";import"../chunks/byteSizeEstimations.js";import"../chunks/quantizationUtils.js";import"../chunks/callExpressionWithFeature.js";import"../chunks/lineStippleUtils.js";import"../geometry/support/MeshComponent.js";import"../geometry/support/MeshMaterial.js";import"../geometry/support/MeshTexture.js";import"../geometry/support/MeshMaterialMetallicRoughness.js";import"../chunks/projection.js";import"../chunks/NativeLineMaterial.js";import"../chunks/viewpointUtils.js";import"../chunks/mat2d.js";import"../chunks/mat2df64.js";import"../chunks/PromiseQueue.js";import"../chunks/debugFlags.js";import"./3d/support/LayerPerformanceInfo.js";import"../chunks/config.js";import"../chunks/TiledDisplayObject.js";import"../chunks/DisplayObject.js";import"../chunks/TileKey.js";import"../chunks/mat2df32.js";import"./ui/UI.js";import"../widgets/Attribution.js";import"../widgets/Attribution/AttributionViewModel.js";import"../widgets/Compass.js";import"../widgets/Compass/CompassViewModel.js";import"../widgets/NavigationToggle.js";import"../widgets/NavigationToggle/NavigationToggleViewModel.js";import"../widgets/Zoom.js";import"../widgets/Zoom/ZoomViewModel.js";function qc(e){return"global"===e?1:2}const Hc=()=>import("../chunks/TileLayerView3D.js"),Bc=()=>Promise.resolve().then((function(){return Ix})),Nc={"base-dynamic":()=>import("../chunks/BaseDynamicLayerView3D.js"),"base-elevation":Bc,"base-tile":Hc,"bing-maps":Hc,"building-scene":()=>import("../chunks/BuildingSceneLayerView3D.js"),csv:()=>import("../chunks/CSVLayerView3D.js"),"direct-line-measurement":()=>import("../chunks/DirectLineMeasurementLayerView3D.js"),"area-measurement":()=>import("../chunks/AreaMeasurementLayerView3D.js"),elevation:Bc,feature:()=>import("../chunks/FeatureLayerView3D.js"),geojson:()=>import("../chunks/GeoJSONLayerView3D.js"),graphics:()=>import("../chunks/GraphicsLayerView3D.js"),group:()=>import("../chunks/GroupLayerView.js"),imagery:()=>import("../chunks/ImageryLayerView3D.js"),"integrated-mesh":()=>import("../chunks/IntegratedMeshLayerView3D.js"),"line-of-sight":()=>import("../chunks/LineOfSightLayerView3D.js"),"map-image":()=>import("../chunks/MapImageLayerView3D.js"),"ogc-feature":()=>import("../chunks/OGCFeatureLayerView3D.js"),"open-street-map":Hc,"point-cloud":()=>import("../chunks/PointCloudLayerView3D.js"),scene:e=>null==e.profile||"mesh-pyramids"===e.profile?import("../chunks/SceneLayerView3D.js"):import("../chunks/SceneLayerGraphicsView3D.js"),stream:()=>import("../chunks/StreamLayerView3D.js"),tile:Hc,"imagery-tile":()=>import("../chunks/ImageryTileLayerView3D.js"),"vector-tile":()=>import("../chunks/VectorTileLayerView3D.js"),wcs:()=>import("../chunks/ImageryTileLayerView3D.js"),"web-tile":Hc,wfs:()=>import("../chunks/WFSLayerView3D.js"),wms:()=>import("../chunks/WMSLayerView3D.js"),wmts:()=>import("../chunks/WMTSLayerView3D.js"),slice:()=>import("../chunks/SliceLayerView3D.js"),"geo-rss":null,kml:null,"map-notes":null,route:null,"subtype-group":null,unknown:null,unsupported:null,voxel:null};const Gc=e=>C(Nc[e.type]),Wc=e=>{const t=Nc[e.type];if(!C(t))throw function(e){const t=e.declaredClass?e.declaredClass.slice(e.declaredClass.lastIndexOf(".")+1):"Unknown",i=t.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return new o(`${i}:view-not-supported`,`${t} is not supported in 3D`)}(e);return t(e)},Qc=U.getLogger("esri.views.3d.state.Constraints");let Zc=class extends yi{constructor(e){super(e),this.collision=new Jc,this.distance=1/0,this.minimumPoiDistance=4}get altitude(){return 2===this.mode?null:this._get("altitude")||null}set altitude(e){2!==this.mode?this._set("altitude",e):Qc.warn("Altitude constraint is ignored in local scenes")}clampAltitude(e){return this.altitude?ue(e,this.altitude.min,this.altitude.max):e}clampTilt(e,t){if(!this.tilt)return t;const i=this.tilt(e);return ue(t,i.min,i.max)}clampDistance(e){return Math.min(e,this.distance)}createDefaultTilt(){return 2===this.mode?this.createDefaultTiltLocal():this.createDefaultTiltGlobal()}createConstantMaxTilt(e){return(t,i=Kc)=>(i.min=Xc.min,i.max=e,i)}createDefaultTiltLocal(){const e=this.collision.enabled?Di([[4e3,Xc.max],[1e4,pe(88)],[6e6,pe(88)]]):()=>Xc.max;return(t,i=Kc)=>(i.min=Xc.min,i.max=e(t),i)}createDefaultTiltGlobal(){const e=this.collision.enabled?Di([[4e3,Xc.max],[5e4,pe(88)],[6e6,pe(88)],[2e7,Xc.min]]):Di([[3e5,Xc.max],[3e6,pe(88)],[6e6,pe(88)],[2e7,Xc.min]]);return(t,i=Kc)=>(i.min=Xc.min,i.max=e(t),i)}};e([le()],Zc.prototype,"altitude",null),e([le({readOnly:!0})],Zc.prototype,"collision",void 0),e([le()],Zc.prototype,"distance",void 0),e([le({readOnly:!0})],Zc.prototype,"minimumPoiDistance",void 0),e([le()],Zc.prototype,"tilt",void 0),e([le({constructOnly:!0})],Zc.prototype,"mode",void 0),Zc=e([ce("esri.views.3d.state.Constraints")],Zc);const Yc={min:-2e5,max:4*Pi.radius};const Xc={min:pe(.5),max:pe(179.5)},Kc={min:0,max:0};let Jc=class extends yi{constructor(){super(...arguments),this.enabled=!0,this.elevationMargin=5}};e([le({type:Boolean})],Jc.prototype,"enabled",void 0),e([le({type:Number})],Jc.prototype,"elevationMargin",void 0),Jc=e([ce("esri.views.3d.state.Constraints.CollisionConstraint")],Jc);var $c=Zc;let ed=class extends yi{constructor(){super(...arguments),this.min=Yc.min,this.max=Yc.max}set mode(e){Si(U.getLogger(this.declaredClass),"esri.views.SceneView.constraints.altitude.mode is deprecated. The altitude constraint no longer applies to local scenes and does not have an automatic mode anymore.",{version:"4.6"})}get mode(){return Si(U.getLogger(this.declaredClass),"esri.views.SceneView.constraints.altitude.mode is deprecated. The altitude constraint no longer applies to local scenes and does not have an automatic mode anymore.",{version:"4.6"}),"manual"}};e([le({type:Number})],ed.prototype,"min",void 0),e([le({type:Number})],ed.prototype,"max",void 0),ed=e([ce("esri.views.3d.constraints.AltitudeConstraint")],ed);var td=ed;let id=class extends yi{constructor(){super(...arguments),this.mode="auto"}get near(){return this._get("near")}set near(e){this._set("near",e),e>=this._get("far")&&(this.far=e+1e-9),this.mode="manual"}castNear(e){return Math.max(1e-8,e)}get far(){return this._get("far")}set far(e){this._set("far",e),e<=this._get("near")&&(this.near=e-1e-9),this.mode="manual"}castFar(e){return Math.max(1e-8,e)}autoUpdate(e,t){"auto"===this.mode&&(this._get("near")!==e&&this._set("near",e),this._get("far")!==t&&this._set("far",t))}};e([le({type:Number,value:1e-8})],id.prototype,"near",null),e([he("near")],id.prototype,"castNear",null),e([le({type:Number,value:1e-8})],id.prototype,"far",null),e([he("far")],id.prototype,"castFar",null),e([le({type:["auto","manual"]})],id.prototype,"mode",void 0),id=e([ce("esri.views.3d.constraints.ClipDistanceConstraint")],id);var rd=id;const sd={min:me(Xc.min),max:me(Xc.max)};let ad=class extends yi{constructor(){super(...arguments),this.mode="auto"}get max(){return this._get("max")}set max(e){this._set("max",e),this.mode="manual"}castMax(e){return ue(e,sd.min,sd.max)}autoUpdate(e){"auto"===this.mode&&this._get("max")!==e&&this._set("max",e)}};e([le({type:["auto","manual"]})],ad.prototype,"mode",void 0),e([le({type:Number,value:sd.max})],ad.prototype,"max",null),e([he("max")],ad.prototype,"castMax",null),ad=e([ce("esri.views.3d.constraints.TiltConstraint")],ad);var nd=ad;let od=class extends yi{constructor(){super(...arguments),this.tilt=new nd,this.altitude=new td,this.clipDistance=new rd}};e([le({type:nd})],od.prototype,"tilt",void 0),e([le({type:td})],od.prototype,"altitude",void 0),e([le({type:rd})],od.prototype,"clipDistance",void 0),od=e([ce("esri.views.3d.constraints.Constraints")],od);var ld,hd=od;let cd=ld=class extends yi{set quality(e){-1!==["low","high"].indexOf(e)&&this._set("quality",e)}clone(){return new ld({quality:this.quality})}};e([le({type:["low","high"],value:"low"})],cd.prototype,"quality",null),cd=ld=e([ce("esri.views.3d.environment.SceneViewAtmosphere")],cd);var dd,ud=cd;let pd=dd=class extends(tr.EventedMixin(ir)){constructor(e){super(e),this.positionTimezoneInfo={hours:0,minutes:0,seconds:0,autoUpdated:!0},this.cameraTrackingEnabled=!0,this.ambientOcclusionEnabled=!1,this.waterReflectionEnabled=!1;const t=(new Date).getFullYear(),i=new Date("March 15, "+t+" 12:00:00 UTC");this._set("defaultDate",i),this._set("date",i)}static fromWebsceneLighting(e){return new dd({...e.cloneConstructProperties()})}get defaultDate(){return new Date(this._get("defaultDate").getTime())}set defaultDate(e){const t=this._get("date")===this._get("defaultDate");e=new Date(e.getTime()),this._set("defaultDate",e),t&&this._set("date",e)}set date(e){null!=e&&(this.positionTimezoneInfo.autoUpdated=!1,this._set("date",new Date(e.getTime())))}autoUpdate(e,t){const i=md(this.positionTimezoneInfo);this.positionTimezoneInfo.hours=t.hours,this.positionTimezoneInfo.minutes=t.minutes,this.positionTimezoneInfo.seconds=t.seconds;let r=null;null!=e&&(this.positionTimezoneInfo.autoUpdated=!0,r=this.date&&this.date.getTime(),this._set("date",new Date(e.getTime())));const s=md(this.positionTimezoneInfo);if(i!==s&&(gd.target=this,gd.timezoneOffset=s,this.emit("timezone-will-change",gd)),null!=e)return r!==e.getTime()}clone(){const e=this._get("date")===this._get("defaultDate"),t=new dd({...this.cloneConstructProperties(),defaultDate:this.defaultDate,cameraTrackingEnabled:this.cameraTrackingEnabled,ambientOcclusionEnabled:this.ambientOcclusionEnabled,waterReflectionEnabled:this.waterReflectionEnabled});return e&&t._set("date",t._get("defaultDate")),t.positionTimezoneInfo.autoUpdated=this.positionTimezoneInfo.autoUpdated,t.positionTimezoneInfo.hours=this.positionTimezoneInfo.hours,t.positionTimezoneInfo.minutes=this.positionTimezoneInfo.minutes,t.positionTimezoneInfo.seconds=this.positionTimezoneInfo.seconds,t}cloneWithWebsceneLighting(e){const t=this.clone();return null!=e.date&&(t.date=e.date),t.directShadowsEnabled=e.directShadowsEnabled,t.displayUTCOffset=e.displayUTCOffset,t}};function md({hours:e,minutes:t,seconds:i}){return Math.round(e+t/60+i/3600)}e([le({type:Boolean})],pd.prototype,"cameraTrackingEnabled",void 0),e([le({type:Boolean})],pd.prototype,"ambientOcclusionEnabled",void 0),e([le({type:Boolean})],pd.prototype,"waterReflectionEnabled",void 0),e([le({type:Date})],pd.prototype,"defaultDate",null),e([le({type:Date})],pd.prototype,"date",null),pd=dd=e([ce("esri.views.3d.environment.SceneViewLighting")],pd);const gd={target:null,timezoneOffset:0};var fd;let vd=fd=class extends rr{constructor(e){super(e),this.atmosphere=new ud,this.clouds=null}static fromWebsceneEnvironment(e){const t=e.cloneConstructProperties();return new fd({...t,lighting:pd.fromWebsceneLighting(t.lighting)})}castLighting(e){return this.convertLighting(e)}applyLighting(e){this.lighting=this.convertLighting(e)}convertLighting(e){return e?e instanceof pd?e:e instanceof ir?this.lighting?this.lighting.cloneWithWebsceneLighting(e):pd.fromWebsceneLighting(e):de(pd,e):new pd}clone(){return new fd({lighting:this.lighting.clone(),atmosphere:this.atmosphere.clone(),clouds:null===this.clouds?null:this.clouds.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:T(this.background)})}cloneWithWebsceneEnvironment(e){return new fd({atmosphere:this.atmosphere.clone(),clouds:null===this.clouds?null:this.clouds.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:T(this.background),...e.cloneConstructProperties(),lighting:null!=this.lighting?this.lighting.cloneWithWebsceneLighting(e.lighting):pd.fromWebsceneLighting(e.lighting)})}};e([le({type:ud,json:{read:!1}})],vd.prototype,"atmosphere",void 0),e([le({type:Li,json:{write:!1}})],vd.prototype,"clouds",void 0),e([le()],vd.prototype,"lighting",void 0),e([he("lighting")],vd.prototype,"castLighting",null),vd=fd=e([ce("esri.views.3d.environment.SceneViewEnvironment")],vd);var _d=vd;function yd(e){const t=1e5;return Math.min(1,Math.max(0,(e-t)/9e5))}const xd=ge(5802e-9,13558e-9,331e-7),wd=ge(3*65e-8,5643e-9,255e-9);var bd=Object.freeze({__proto__:null,build:function(e){const t=new ds;return t.attributes.add("position","vec2"),t.include(Wr,{attributeTextureCoordinates:1}),t.varyings.add("worldRay","vec3"),t.varyings.add("eyeDir","vec3"),t.vertex.uniforms.add("projectionInverse","mat4"),t.vertex.uniforms.add("viewInverse","mat4"),t.vertex.code.add(us`void main(void) {
vec3 posViewNear = (projectionInverse * vec4(position, -1, 1)).xyz;
eyeDir = posViewNear;
worldRay = (viewInverse * vec4(posViewNear, 0)).xyz;
forwardTextureCoordinates();
gl_Position = vec4(position, 1, 1);
}`),t.fragment.uniforms.add("lightingMainDirection","vec3").add("radii","vec2").add("scaleHeight","float").add("cameraPosition","vec3").add("nearFar","vec2").add("heightParameters","vec4").add("innerFadeDistance","float").add("altitudeFade","float").add("strength","float").add("depthTex","sampler2D").add("betaRayleigh","vec3").add("betaCombined","vec3").add("skyStrength","float").add("skyHazeMultiplier","float").add("hazeStrength","float").add("mieStrength","float").add("skyHazePow","float").add("sunSize","float").add("sunSpread","float"),e.simplified||t.fragment.uniforms.add("betaMie","float"),t.include(ca),e.haze&&t.fragment.include(ps),t.fragment.code.add(us`vec2 sphereIntersect(vec3 start, vec3 dir, float radius, bool planet) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float c = planet ? heightParameters[1] - radius * radius : heightParameters[2];
float d = (b * b) - 4.0 * a * c;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`),t.fragment.code.add(us`float chapmanApproximation(float X, float h, float cosZenith) {
float c = sqrt(X + h);
float cExpH = c * exp(-h);
if (cosZenith >= 0.0) {
return cExpH / (c * cosZenith + 1.0);
} else {
float x0 = sqrt(1.0 - cosZenith * cosZenith) * (X + h);
float c0 = sqrt(x0);
return 2.0 * c0 * exp(X - x0) - cExpH / (1.0 - c * cosZenith);
}
}`),t.fragment.code.add(us`float getOpticalDepth(vec3 position, vec3 dir) {
float h = length(position) - radii[0];
return scaleHeight * chapmanApproximation(radii[0] / scaleHeight, h / scaleHeight, dot(normalize(position), dir));
}`),t.fragment.code.add(us`
    ${e.simplified?"":us`const int STEPS = 6;`}

    float getGlow(float dist, float radius, float intensity) {
      return pow(radius / max(dist, 1e-6), intensity);
    }

    vec3 getSkyColour(vec3 cameraPos, vec3 rayDir, vec3 lightDir, float terrainDepth) {
      float reducedPlanetRadius = radii[0] * 0.998;
      vec2 rayPlanetIntersect = sphereIntersect(cameraPos, rayDir, reducedPlanetRadius, true);
      vec2 rayAtmosphereIntersect = sphereIntersect(cameraPos, rayDir, radii[1], false);
      bool hitsAtmosphere = (rayAtmosphereIntersect.x <= rayAtmosphereIntersect.y) && rayAtmosphereIntersect.x > 0.0;
      bool insideAtmosphere = heightParameters[0] < radii[1];

      if (!(hitsAtmosphere || insideAtmosphere)) {
        return vec3(0);
      }

      bool hitsPlanet = (rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.x > 0.0;

      ${e.simplified?"":us`float start = insideAtmosphere ? 0.0 : rayAtmosphereIntersect.x;`}

      if (heightParameters[0] < reducedPlanetRadius) {
        // Long light rays from the night side of the planet lead to numerical instability
        // Do not render the atmosphere in such cases
        if (dot(rayDir, normalize(cameraPos)) < -0.025) {
          return vec3(0);
        }
        ${e.simplified?"":us`start = rayPlanetIntersect.y;`}
      }

      float end = hitsPlanet ? rayPlanetIntersect.x : rayAtmosphereIntersect.y;
      float maxEnd = end;

      ${e.haze?us`if (terrainDepth != -1.0) { end = terrainDepth; }`:""}

      vec3 samplePoint = cameraPos + rayDir * end;
      float multiplier = hitsPlanet ? -1.0 : 1.0;
      ${e.simplified?us`
          float sampleOpticalDepth = getOpticalDepth(samplePoint, multiplier * rayDir);
          float cameraOpticalDepth = getOpticalDepth(cameraPos, multiplier * rayDir);
          float lightOpticalDepth = getOpticalDepth(normalize(samplePoint) * radii[0], lightDir);
          float cameraLightOpticalDepth = min(1e6, getOpticalDepth(normalize(cameraPos) * radii[0], lightDir));
          lightOpticalDepth = mix(cameraLightOpticalDepth, lightOpticalDepth, heightParameters[3]);

          if (heightParameters[0] < radii[0]) {
            lightOpticalDepth = cameraLightOpticalDepth;
          }

          float opticalDepth = abs(cameraOpticalDepth - sampleOpticalDepth);
          ${e.haze?us`if (terrainDepth != -1.0) { opticalDepth = min(0.25 * end, opticalDepth); }`:""}

          vec3 scattering =
          ${e.haze?us`betaRayleigh`:us`mix(0.5 * betaRayleigh, betaCombined,(pow(1.0 - clamp(dot(normalize(samplePoint), rayDir), 0.0, 1.0), 10.0)))`}
          * opticalDepth;
          vec3 lightDepth = betaCombined * lightOpticalDepth;
          vec3 absorption = (exp(-scattering) - exp(-lightDepth)) / (lightDepth - scattering);`:us`
          vec3 scattering = vec3(0);
          float lastOpticalDepth = getOpticalDepth(samplePoint, rayDir);
          float stepSize = (end - start) / float(STEPS);
          for (int i = 0; i < STEPS; i++) {
            samplePoint -= stepSize * rayDir;
            float opticalDepth = multiplier * getOpticalDepth(samplePoint, rayDir * multiplier);
            if (i > 0) {
              scattering *= exp(-(betaRayleigh + betaMie) * max(0.0, (opticalDepth - lastOpticalDepth)));
            }

            if (dot(normalize(samplePoint), lightDir) > -0.3) {
              scattering += exp(-(length(samplePoint) - radii[0]) / scaleHeight) * exp(-(betaCombined + betaMie) * getOpticalDepth(samplePoint, lightDir));
            }

            lastOpticalDepth = opticalDepth;
          }`}

      float mu = dot(rayDir, lightDir);
      float mumu = mu * mu;

      ${e.simplified?us``:us`
          float phaseRayleigh = 0.05968310365 * (1.0 + mumu);`}
        ${e.haze?us`
            ${e.simplified?us`
                return absorption * scattering;`:us`
                return scattering * stepSize * phaseRayleigh * betaRayleigh;`}`:us`
            const float g = 0.8;
            const float gg = g * g;
            float phaseMie = end == maxEnd ? 0.11936620731 * ((1.0 - gg) * (mumu + 1.0)) / (pow(1.0 + gg - 2.0 * mu * g, 1.5) * (2.0 + gg)) : 0.0;
            phaseMie += getGlow(1.0-mu, sunSize * 5e-5, sunSpread * 3.0) * smoothstep(0.01, 0.1, length(scattering));
            phaseMie = clamp(phaseMie, 0.0, 128.0);
            ${e.simplified?us`
                return absorption * scattering * (1.0 + mieStrength * 0.15 * phaseMie);`:us`
                return scattering * stepSize * (phaseRayleigh * betaRayleigh + mieStrength * 0.05 * phaseMie * betaMie);`}`}
    }

    vec3 tonemapACES(vec3 x) {
      return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);
    }

    vec4 applyUndergroundAtmosphere(vec3 rayDir, vec3 lightDirection, vec4 fragColor) {
      vec2 rayPlanetIntersect = sphereIntersect(cameraPosition, rayDir, radii[0], true);
      if (!((rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.y > 0.0)) {
        return fragColor;
      }

      float lightAngle = dot(lightDirection, normalize(cameraPosition + rayDir * max(0.0, rayPlanetIntersect.x)));
      vec4 surfaceColor = vec4(vec3(max(0.0, (smoothstep(-1.0, 0.8, 2.0 * lightAngle)))), 1.0 - altitudeFade);
      float relDist = (rayPlanetIntersect.y - max(0.0, rayPlanetIntersect.x)) / innerFadeDistance;
      if (relDist > 1.0) {
        return surfaceColor;
      }

      return mix(gl_FragColor, surfaceColor, smoothstep(0.0, 1.0, relDist * relDist));
    }

    void main() {
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;
      ${e.haze?us`
          vec4 depthSample = texture2D(depthTex, vuv0).rgba;
          if (depthSample != vec4(0)) {
            vec3 cameraSpaceRay = normalize(eyeDir);
            cameraSpaceRay /= cameraSpaceRay.z;
            cameraSpaceRay *= -linearDepthFromTexture(depthTex, vuv0, nearFar);
            terrainDepth = max(0.0, length(cameraSpaceRay));
          }`:us`
          float depthSample = texture2D(depthTex, vuv0).r;
          if (depthSample != 1.0) {
            gl_FragColor = vec4(0);
            return;
          }`}
      vec3 skyCol = getSkyColour(cameraPosition, rayDir, lightingMainDirection, terrainDepth);
      ${e.haze?us`
          float x = sqrt(max(heightParameters[1] - radii[0] * radii[0], 0.0));
          vec3 up = normalize(cameraPosition);
          vec3 upCorrected = normalize((heightParameters[0] - (x * x) / heightParameters[0]) * up + x * (radii[0] / heightParameters[0]) * rayDir);
          float skyHaze = pow( (1.0 - dot(rayDir, upCorrected)) * radii[0] / heightParameters[0], skyHazePow) * skyHazeMultiplier;
          ${e.simplified?us`
              vec3 col = ((depthSample != vec4(0)) ? 0.075 : skyHaze * 0.01) * hazeStrength * skyCol;`:us`
              vec3 col = ((depthSample != vec4(0)) ? 1.0 : skyHaze) * hazeStrength * skyCol;`}
          float alpha = 1.0;`:us`
          vec3 up = normalize(cameraPosition);
          ${e.simplified?us`
              vec3 col = mix(1.0, 3.0, max(0.0, dot(rayDir, up))) * skyStrength * skyCol;`:us`
              vec3 col = mix(4.0, 8.0, max(0.0, dot(rayDir, up))) * skyStrength * skyCol;`}
          float alpha = smoothstep(0.0, mix(0.15, 0.01, heightParameters[3]), length(col));`}
      col = tonemapACES(col);
      gl_FragColor = delinearizeGamma(vec4(col, alpha));
      ${e.haze?"":us`
          if (depthSample == 1.0) {
            gl_FragColor = applyUndergroundAtmosphere(rayDir, lightingMainDirection, gl_FragColor);
          }`}
    }
  `),t}});class Cd extends vs{initializeProgram(e){const t=Cd.shader.get(),i=this.configuration,r=t.build({haze:i.haze,simplified:i.simplified});return new _s(e.rctx,r,ys)}initializePipeline(){return this.configuration.haze?Ea({blending:La(1,0,769,1),colorWrite:Va}):Ea({blending:La(770,1,771,771),depthTest:{func:515},colorWrite:Va})}}Cd.shader=new gs(bd,(()=>Promise.resolve().then((function(){return bd}))));class Td extends fs{constructor(){super(...arguments),this.haze=!1,this.simplified=!1}}e([ms()],Td.prototype,"haze",void 0),e([ms()],Td.prototype,"simplified",void 0);class Sd{constructor(e){this._view=e,this.canRender=!0,this._skyslot=15,this._hazeSlot=16,this._cameraPosition=fe(),this._projectionInverse=Ar(),this._viewInverse=Ar(),this._heightParameters=nr(),this._betasRayleigh=fe(),this._betasCombined=fe(),this._scaleHeight=0,this._radii=Nr(),this._nearFar=Nr(),this._cameraHeight=0,this._cameraHeightSq=0,this._cAtmosphere=0,this._innerFadeDistance=0,this._altitudeFade=0,this._lowerElevationBoundRadius=0,this._lowerBoundEarthRadius=Pi.radius,this._simplified=!1,this._skyStrength=1,this._hazeStrength=3,this._mieStrength=1,this._skyHazeMultiplier=1,this._skyHazePow=0,this._sunSize=1,this._sunSpread=1,this._updateRadius(Pi.radius)}destroy(){this._atmosphereTechnique=S(this._atmosphereTechnique),this._atmosphereHazeTechnique=S(this._atmosphereHazeTechnique),this._vao=P(this._vao),this._handles=R(this._handles)}when(){return Promise.resolve()}setSimplified(e){this._simplified=e}initializeRenderContext(e){const t=e.renderContext.rctx;this._handles=new ar,C(this._view.basemapTerrain.rootTiles)&&this._updateElevation({spatialReference:this._view.basemapTerrain.spatialReference,tile:this._view.basemapTerrain.rootTiles[0],extent:this._view.basemapTerrain.rootTiles[0].extent,context:"ground"}),this._handles.add(Z(this._view,"basemapTerrain","elevation-change",(e=>this._updateElevation(e)),(()=>this._updateElevation()))),this._handles.add(Z(this._view,"basemapTerrain","elevation-bounds-change",(()=>this._updateVisibleElevationBounds())));const i=new Td;i.haze=!1,i.simplified=this._simplified,this._atmosphereTechnique=e.shaderTechniqueRep.acquire(Cd,i),i.haze=!0,this._atmosphereHazeTechnique=e.shaderTechniqueRep.acquire(Cd,i),this._vao=xs(t,ws),this._scaleHeight=8500,ve(this._betasRayleigh,xd[0],xd[1],xd[2]),ve(this._betasCombined,xd[0]+wd[0],xd[1]+wd[1],xd[2]+wd[2])}uninitializeRenderContext(){this.destroy()}render(e){if(e.slot!==this._hazeSlot&&e.slot!==this._skyslot||0!==e.pass)return!1;this._update(e.camera);const t=e.rctx,i=e.offscreenRenderingHelper,r=e.slot===this._skyslot?this._atmosphereTechnique:this._atmosphereHazeTechnique,s=e.slot===this._skyslot?i.depthTexture:i.linearDepthTexture;return t.useProgram(r.program),r.bindPipelineState(t),i.renderDepthDetached((()=>{r.program.bindTexture(s,"depthTex"),this._renderCommon(r.program,e)})),!0}_renderCommon(e,t){if(M(this._vao))return!1;const i=t.rctx;return t.scenelightingData.setLightDirectionUniform(e),e.setUniform4fv("heightParameters",this._heightParameters),e.setUniform3fv("cameraPosition",this._cameraPosition),e.setUniformMatrix4fv("projectionInverse",this._projectionInverse),e.setUniformMatrix4fv("viewInverse",this._viewInverse),e.setUniform2fv("nearFar",this._nearFar),e.setUniform2fv("radii",this._radii),e.setUniform1f("scaleHeight",this._scaleHeight),this._simplified||e.setUniform1f("betaMie",3996e-9),e.setUniform3fv("betaRayleigh",this._betasRayleigh),e.setUniform3fv("betaCombined",this._betasCombined),e.setUniform1f("innerFadeDistance",this._innerFadeDistance),e.setUniform1f("altitudeFade",this._altitudeFade),e.setUniform1f("skyStrength",this._skyStrength),e.setUniform1f("hazeStrength",this._hazeStrength),e.setUniform1f("mieStrength",this._mieStrength),e.setUniform1f("skyHazeMultiplier",this._skyHazeMultiplier),e.setUniform1f("skyHazePow",this._skyHazePow),e.setUniform1f("sunSize",this._sunSize),e.setUniform1f("sunSpread",this._sunSpread),i.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),i.drawArrays(5,0,4),!0}_adjustRadiusForTesselation(e){return e*Math.cos(Math.PI/16/16)}_updateElevation(e){const t=e?e.tile:D(this._view.basemapTerrain.rootTiles,[null])[0];if(M(t)||0!==t.lij[0])return;const i=this._adjustRadiusForTesselation(Pi.radius+t.elevationBounds[0]);i!==this._lowerElevationBoundRadius&&(this._lowerElevationBoundRadius=i,this._lowerBoundEarthRadius=-1,this._updateVisibleElevationBounds())}_updateVisibleElevationBounds(){const e=this._adjustRadiusForTesselation(Pi.radius+this._view.basemapTerrain.elevationBounds.min);(this._lowerBoundEarthRadius<0||e<this._lowerBoundEarthRadius)&&this._updateRadius(e)}_updateRadius(e){this._lowerBoundEarthRadius=e,Ir(this._radii,e,e+1e5),this._innerFadeDistance=2*Math.sqrt(1e4*(2*e-1e4))}_update(e){if(M(e))return;this._cameraHeight=_e(e.eye),this._cameraHeightSq=this._cameraHeight*this._cameraHeight,this._cAtmosphere=this._cameraHeightSq-this._radii[1]*this._radii[1];const t=Math.min(1,Math.max(0,(this._cameraHeight-this._radii[0])/1e5));this._heightParameters=or(this._cameraHeight,this._cameraHeightSq,this._cAtmosphere,t),ye(this._cameraPosition,e.eye),_r(this._projectionInverse,e.projectionMatrix),_r(this._viewInverse,e.viewMatrix),Ir(this._nearFar,e.near,e.far),this._altitudeFade=yd(this._cameraHeight-this._lowerBoundEarthRadius)}static isSupported(e){return e.renderContext.rctx.capabilities.depthTexture}}function Pd(e=Dd){return[e[0],e[1],e[2],e[3]]}function Rd(e,t){return function(e,t,i,r,s=Pd()){return s[0]=e,s[1]=t,s[2]=i,s[3]=r,s}(e[0],e[1],e[2],t,an.get())}function Md(e,t,i=Pd()){return xe(i,e,t),we(i,i),i[3]=Wa(e,t),i}const Dd=[0,0,1,0];function Ad(e){e.fragment.uniforms.add("anchorPosition","vec3").add("anchorPositionCrossFade","vec3").add("fadeInOutFactor","float").add("cloudsHeight","float").add("rotationMatrixClouds","mat4").add("rotationMatrixCloudsCrossFade","mat4").add("radiusCurvatureCorrectionFactor","float").add("radius","float").add("cameraPosition","vec3").add("totalFadeInOut","float").add("crossFade","int").add("crossFadeAnchorFactor","float"),e.include(ln),e.fragment.code.add(us`vec3 intersectWithCloudLayer(vec3 dir, vec3 camPos, vec3 spherePos, float radiusReduction)
{
vec3 dirAnchor = normalize(spherePos);
vec3 sphereOriginOffset = dirAnchor * radiusReduction;
float radiusClouds = radius + cloudsHeight - radiusReduction;
float B = 2.0 * dot(camPos - sphereOriginOffset, dir);
float C = dot(camPos - sphereOriginOffset, camPos - sphereOriginOffset) - radiusClouds * radiusClouds;
float det = B * B - 4.0 * C;
float pointIntDist = max(0.0, 0.5 *(-B + sqrt(det)));
vec3 intersectionPont = camPos + dir * pointIntDist;
intersectionPont =  intersectionPont - spherePos;
return intersectionPont;
}`),e.fragment.code.add(us`vec3 correctForPlanetCurvature(vec3 dir)
{
dir.z = dir.z*(1.-radiusCurvatureCorrectionFactor) + radiusCurvatureCorrectionFactor;
return dir;
}`),e.fragment.code.add(us`vec3 rotateDirectionToAnchorPoint(mat4 rotMat, vec3 inVec)
{
return (rotMat * vec4(inVec, 0.0)).xyz;
}`),e.fragment.code.add(us`const float SUNSET_TRANSITION_FACTOR = 0.3;
const vec3 RIM_COLOR = vec3(0.28, 0.175, 0.035);
const float RIM_SCATTERING_FACTOR = 140.0;
const float BACKLIGHT_FACTOR = 0.2;
const float BACKLIGHT_SCATTERING_FACTOR = 10.0;
const float BACKLIGHT_TRANSITION_FACTOR = 0.3;
const float GAMMA_SRGB = 2.1;
const float INV_GAMMA_SRGB = 0.4761904;
vec3 calculateCloudColor(vec3 worldSpaceRay, vec4 clouds)
{
float upDotLight = dot(normalize(cameraPosition), normalize(lightingMainDirection));
float dirDotLight = max(dot(normalize(-worldSpaceRay), normalize(lightingMainDirection)), 0.0);
float sunsetTransition = clamp(pow(max(upDotLight, 0.0), SUNSET_TRANSITION_FACTOR), 0.0, 1.0);
vec3 ambientLight = calculateAmbientIrradiance(normalize(cameraPosition),  0.0);
vec3 mainLight = evaluateMainLighting(normalize(cameraPosition),  0.0);
vec3 combinedLight = clamp((lightingMainIntensity + ambientLight )/PI, vec3(0.0), vec3(1.0));
vec3 baseCloudColor = pow(combinedLight * pow(clouds.xyz, vec3(GAMMA_SRGB)), vec3(INV_GAMMA_SRGB));
float scatteringMod = max(clouds.a < 0.5 ? clouds.a / 0.5 : - clouds.a / 0.5 + 2.0, 0.0);
float rimLightIntensity = 0.5 + 0.5 *pow(max(upDotLight, 0.0), 0.35);
vec3 directSunScattering = RIM_COLOR * rimLightIntensity * pow(dirDotLight, RIM_SCATTERING_FACTOR) * scatteringMod;
float additionalLight = BACKLIGHT_FACTOR * pow(dirDotLight, BACKLIGHT_SCATTERING_FACTOR) * (1. - pow(sunsetTransition, BACKLIGHT_TRANSITION_FACTOR)) ;
return vec3(baseCloudColor * (1. + additionalLight) + directSunScattering);
}`),e.fragment.code.add(us`vec4 renderCloud(vec3 worldRay)
{
vec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPosition, 0.0);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = textureCube(cubeMap, worldRayRotatedCorrected).rgba;
float totalTransmittance = clamp(cloudData.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);
if (length(cloudData.rgb) == 0.0) {
totalTransmittance = 1.0;
}
return vec4(calculateCloudColor(normalize(-worldRay), cloudData), totalTransmittance);
}`),e.fragment.code.add(us`vec4 renderCloudCrossFade(vec3 worldRay)
{
vec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPosition, 0.0);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = textureCube(cubeMap, worldRayRotatedCorrected).rgba;
vec4 cloudColor = vec4(calculateCloudColor(normalize(-worldRay), cloudData), cloudData.a);
intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPositionCrossFade, 0.0);
worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixCloudsCrossFade, normalize(intersectionPoint));
worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
cloudData = textureCube(cubeMap, worldRayRotatedCorrected).rgba;
vec4 cloudColorCrossFade = vec4(calculateCloudColor(normalize(-worldRay), cloudData), cloudData.a);
cloudColor = mix(cloudColor, cloudColorCrossFade, crossFadeAnchorFactor);
float totalTransmittance = clamp(cloudColor.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);
if (length(cloudColor.rgb) == 0.0) {
totalTransmittance = 1.0;
}
return vec4(cloudColor.rgb, totalTransmittance);
}`)}var Od,Fd,Id,zd=Object.freeze({__proto__:null,build:function(){const e=new ds;return e.attributes.add("position","vec2"),e.varyings.add("worldRay","vec3"),e.vertex.uniforms.add("inverseProjectionMatrix","mat4"),e.vertex.uniforms.add("inverseViewMatrix","mat4"),e.vertex.code.add(us`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1.0, 1.0)).xyz;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0.0)).xyz;
gl_Position = vec4(position, 1.0, 1.0);
}`),e.fragment.uniforms.add("lightingMainDirection","vec3").add("cubeMap","samplerCube"),e.fragment.include(bs),e.fragment.include(Cs),e.include(Qr),e.include(Zr,{pbrMode:0,lightingSphericalHarmonicsOrder:2}),e.include(Ad),e.fragment.code.add(us`void main() {
vec4 cloudsColor = crossFade == 0 ? renderCloud(normalize(worldRay)) : renderCloudCrossFade(normalize(worldRay));
gl_FragColor = vec4((1.0 - totalFadeInOut) * cloudsColor.rgb, cloudsColor.a);
}`),e}});class Ed extends vs{initializeProgram(e){const t=Ed.shader.get().build();return new _s(e.rctx,t,ys)}initializePipeline(){return Ea({blending:ka(1,770),depthTest:{func:515},colorWrite:Va})}}Ed.shader=new gs(zd,(()=>Promise.resolve().then((function(){return zd})))),function(e){e[e.FINISHED=0]="FINISHED",e[e.CHANGE_ANCHOR=1]="CHANGE_ANCHOR",e[e.FADE_IN=2]="FADE_IN"}(Od||(Od={})),function(e){e[e.FINISHED=0]="FINISHED",e[e.FADE_OUT=1]="FADE_OUT",e[e.FADE_IN=2]="FADE_IN"}(Fd||(Fd={})),function(e){e[e.FINISHED=0]="FINISHED",e[e.CROSS_FADE=1]="CROSS_FADE"}(Id||(Id={}));class Ld{constructor(e,t,i){this._viewingMode=t,this._inverseProjectionMatrix=Ar(),this._inverseViewMatrix=Ar(),this._cameraPositionLastFrame=fe(),this._cloudCompositionTechnique=new Ed({rctx:e,viewingMode:this._viewingMode},null),this._vao=xs(e),this._setDefaultParallax(i)}destroy(){this._cloudCompositionTechnique=S(this._cloudCompositionTechnique),this._vao=P(this._vao)}render(e,t){const i=e.camera;if(M(this._vao)||M(i))return!1;const r=e.rctx,s=this._cloudCompositionTechnique.program;return r.useProgram(s),this._cloudCompositionTechnique.bindPipelineState(r),e.scenelightingData.setLightDirectionUniform(s),e.scenelightingData.setUniforms(s),_r(this._inverseProjectionMatrix,i.projectionMatrix),_r(this._inverseViewMatrix,i.viewMatrix),s.setUniformMatrix4fv("inverseProjectionMatrix",this._inverseProjectionMatrix),s.setUniformMatrix4fv("inverseViewMatrix",this._inverseViewMatrix),s.bindTexture(t.colorTexture,"cubeMap"),this._setParallaxParams(i.eye),this._bindParallaxParams(s,e.camera),r.bindVAO(this._vao),s.assertCompatibleVertexAttributeLocations(this._vao),r.drawArrays(5,0,4),!0}isFading(){return this._crossFadeParams.crossFadeStage!==Id.FINISHED||this._fadeInOutParams.fadeInOutStage!==Fd.FINISHED||this._fadeInParams.fadeInStage!==Od.FINISHED}_setDefaultParallax(e){this._parallaxParams={anchorPointClouds:fe(),radius:e,cloudsFadeOutHeightFactor:0,cloudsHeight:1e5,radiusCurvatureCorrectionFactor:0,transform:Ar()},this._parallaxParamsNew={anchorPointClouds:fe(),radius:e,cloudsFadeOutHeightFactor:0,cloudsHeight:1e5,radiusCurvatureCorrectionFactor:0,transform:Ar()},this._crossFadeParams={crossFadeStage:Id.FINISHED,crossFadeFactor:0,distanceThresholdFactor:.3},this._fadeInOutParams={fadeInOutStage:Fd.FINISHED,fadeInOutFactor:0,distanceThresholdFactor:.6},this._fadeInParams={fadeInStage:Od.FINISHED,fadeInFactor:0,distanceThresholdFactor:2}}_isCameraPossitionFinal(e){return be(this._cameraPositionLastFrame,e)}_setFadeInStage(e){const t=this._isCameraPossitionFinal(e);this._fadeInParams.fadeInStage===Od.FINISHED&&(this._fadeInParams.fadeInFactor=1,ye(this._parallaxParams.anchorPointClouds,jd),this._fadeInParams.fadeInStage=Od.CHANGE_ANCHOR,this._crossFadeParams.crossFadeStage=Id.FINISHED,this._fadeInOutParams.fadeInOutStage=Fd.FINISHED),this._fadeInParams.fadeInStage===Od.CHANGE_ANCHOR&&t&&(ye(this._parallaxParams.anchorPointClouds,jd),this._fadeInParams.fadeInStage=Od.FADE_IN,this._startTime=performance.now()),this._fadeInParams.fadeInFactor>0&&this._fadeInParams.fadeInStage===Od.FADE_IN&&(this._fadeInParams.fadeInFactor=1-(performance.now()-this._startTime)/500),this._fadeInParams.fadeInFactor<=0&&this._fadeInParams.fadeInStage===Od.FADE_IN&&(this._fadeInParams.fadeInStage=Od.FINISHED,this._fadeInParams.fadeInFactor=0)}_setCrossFadingStage(){this._crossFadeParams.crossFadeStage===Id.FINISHED&&(ye(this._parallaxParamsNew.anchorPointClouds,jd),this._startTime=performance.now(),this._crossFadeParams.crossFadeFactor=0,this._crossFadeParams.crossFadeStage=Id.CROSS_FADE),this._crossFadeParams.crossFadeFactor<1&&this._crossFadeParams.crossFadeStage===Id.CROSS_FADE&&(this._crossFadeParams.crossFadeFactor=(performance.now()-this._startTime)/500),this._crossFadeParams.crossFadeFactor>=1&&this._crossFadeParams.crossFadeStage===Id.CROSS_FADE&&(this._crossFadeParams.crossFadeStage=Id.FINISHED,this._crossFadeParams.crossFadeFactor=1,ye(this._parallaxParams.anchorPointClouds,this._parallaxParamsNew.anchorPointClouds))}_setFadeInOutStage(e){const t=this._isCameraPossitionFinal(e);this._fadeInOutParams.fadeInOutStage===Fd.FINISHED&&(this._startTime=performance.now(),this._fadeInOutParams.fadeInOutFactor=0,this._fadeInOutParams.fadeInOutStage=Fd.FADE_OUT),this._fadeInOutParams.fadeInOutFactor<1&&this._fadeInOutParams.fadeInOutStage===Fd.FADE_OUT&&(this._fadeInOutParams.fadeInOutFactor=(performance.now()-this._startTime)/250),this._fadeInOutParams.fadeInOutFactor>=1&&this._fadeInOutParams.fadeInOutStage===Fd.FADE_OUT&&(this._fadeInOutParams.fadeInOutFactor=1,ye(this._parallaxParams.anchorPointClouds,jd)),this._fadeInOutParams.fadeInOutFactor>=1&&this._fadeInOutParams.fadeInOutStage===Fd.FADE_OUT&&t&&(this._startTime=performance.now(),this._fadeInOutParams.fadeInOutFactor=1,this._fadeInOutParams.fadeInOutStage=Fd.FADE_IN,this._crossFadeParams.crossFadeStage=Id.FINISHED,this._crossFadeParams.crossFadeFactor=0),this._fadeInOutParams.fadeInOutFactor>0&&this._fadeInOutParams.fadeInOutStage===Fd.FADE_IN&&(this._fadeInOutParams.fadeInOutFactor=1-(performance.now()-this._startTime)/500),this._fadeInOutParams.fadeInOutFactor<=0&&this._fadeInOutParams.fadeInOutStage===Fd.FADE_IN&&(this._fadeInOutParams.fadeInOutStage=Fd.FINISHED,this._fadeInOutParams.fadeInOutFactor=0)}_setParallaxParams(e){we(jd,e),Ce(jd,jd,this._parallaxParams.radius),0===this._parallaxParams.anchorPointClouds[0]&&0===this._parallaxParams.anchorPointClouds[1]&&0===this._parallaxParams.anchorPointClouds[2]&&ye(this._parallaxParams.anchorPointClouds,jd);const t=_e(Te(Ud,this._parallaxParams.anchorPointClouds,jd));let i=!0;t>this._fadeInParams.distanceThresholdFactor*this._parallaxParams.cloudsHeight||this._fadeInParams.fadeInStage!==Od.FINISHED?this._setFadeInStage(e):t>this._fadeInOutParams.distanceThresholdFactor*this._parallaxParams.cloudsHeight||this._fadeInOutParams.fadeInOutStage!==Fd.FINISHED?this._setFadeInOutStage(e):t>this._crossFadeParams.distanceThresholdFactor*this._parallaxParams.cloudsHeight||this._crossFadeParams.crossFadeStage!==Id.FINISHED?this._setCrossFadingStage():i=!1;const r=_e(e),s=r-this._parallaxParams.radius,a=.05*this._parallaxParams.cloudsHeight,n=.1*this._parallaxParams.cloudsHeight,o=1/(a-n),l=-n/(a-n);this._parallaxParams.cloudsFadeOutHeightFactor=1-ue(s*o+l,0,1),this._parallaxParams.radiusCurvatureCorrectionFactor=.84*Math.sqrt(Math.max(r*r-this._parallaxParams.radius*this._parallaxParams.radius,0))/r,Md(Vd,this._parallaxParams.anchorPointClouds,kd),this._parallaxParams.transform=Ar(),yr(this._parallaxParams.transform,this._parallaxParams.transform,kd[3],kd),i&&(Md(Vd,this._parallaxParamsNew.anchorPointClouds,kd),this._parallaxParamsNew.transform=Ar(),yr(this._parallaxParamsNew.transform,this._parallaxParamsNew.transform,kd[3],kd)),ye(this._cameraPositionLastFrame,e)}_bindParallaxParams(e,t){e.setUniform1f("cloudsHeight",this._parallaxParams.cloudsHeight),e.setUniformMatrix4fv("rotationMatrixClouds",this._parallaxParams.transform),e.setUniformMatrix4fv("rotationMatrixCloudsCrossFade",this._parallaxParamsNew.transform),e.setUniform3fv("anchorPosition",this._parallaxParams.anchorPointClouds),e.setUniform3fv("anchorPositionCrossFade",this._parallaxParamsNew.anchorPointClouds),this._fadeInOutParams.fadeInOutStage!==Fd.FINISHED?e.setUniform1f("totalFadeInOut",this._parallaxParams.cloudsFadeOutHeightFactor+Math.max(ue(this._fadeInOutParams.fadeInOutFactor,0,1))):e.setUniform1f("totalFadeInOut",this._parallaxParams.cloudsFadeOutHeightFactor+Math.max(ue(this._fadeInParams.fadeInFactor,0,1))),e.setUniform1f("radiusCurvatureCorrectionFactor",this._parallaxParams.radiusCurvatureCorrectionFactor),e.setUniform1i("crossFade",this._crossFadeParams.crossFadeStage),e.setUniform1f("crossFadeAnchorFactor",ue(this._crossFadeParams.crossFadeFactor,0,1)),e.setUniform1f("radius",this._parallaxParams.radius),e.setUniform3fv("cameraPosition",t.eye)}}const Vd=ge(0,0,1),kd=Pd(),jd=fe(),Ud=fe();var qd=Object.freeze({__proto__:null,build:function(){const e=new ds;return e.attributes.add("position","vec3"),e.fragment.uniforms.add("cloudRadius","float").add("halfCubeMapSize","float").add("power","float").add("sigmaE","float").add("density","float").add("cloudSize","float").add("detailSize","float").add("smoothness","float").add("cloudHeight","float").add("coverage","float").add("viewMatrix","mat3").add("cloudShapeTexture","sampler2D"),e.vertex.code.add(us`void main(void) {
gl_Position = vec4(position, 1.0);
}`),e.fragment.code.add(us`const int STEPS = 200;
const int STEPS_LIGHT = 6;
const float stepL = 300.0 / float(STEPS_LIGHT);
const float cloudStart = 1500.0;
vec3 rayDirection(vec2 fragCoord) {
vec2 xy = fragCoord - halfCubeMapSize;
return normalize(vec3(-xy, -halfCubeMapSize));
}
float remap(float x, float low1, float high1, float low2, float high2) {
return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
}
float saturate(float x) {
return clamp(x, 0.0, 1.0);
}`),e.fragment.code.add("\n    float getCloudShape(vec3 pos) {\n      const float textureWidth = 1560.0;\n      const float dataWidth = 1560.0;\n      const float tileRows = 12.0;\n      const vec3 atlasDimensions = vec3(128.0, 128.0, 144.0);\n\n      //Change from Y being height to Z being height\n      vec3 p = pos.xzy;\n\n      //Pixel coordinates of point in the 3D data\n      vec3 coord = vec3(mod(p, atlasDimensions));\n      float f = fract(coord.z);\n      float level = floor(coord.z);\n      float tileY = floor(level / tileRows);\n      float tileX = level - tileY * tileRows;\n\n      //The data coordinates are offset by the x and y tile, the two boundary cells between each tile pair and the initial boundary cell on the first row/column\n      vec2 offset = atlasDimensions.x * vec2(tileX, tileY) + 2.0 * vec2(tileX, tileY) + 1.0;\n      vec2 pixel = coord.xy + offset;\n      vec2 data = texture2D(cloudShapeTexture, mod(pixel, dataWidth) / textureWidth).xy;\n\n      return 1.0 - mix(data.x, data.y, f);\n    }"),e.fragment.code.add("\n    float clouds(vec3 p) {\n      float cloud = saturate(0.5 * mix(0.0, 1.0, min(2.0 * coverage, 1.0)));\n      float heightFraction = saturate((length(p) - cloudRadius - cloudStart) / cloudHeight);\n\n      //Round the bottom and top of the clouds\n      cloud *= saturate(remap(heightFraction, 0.0, 0.25, 0.0, 1.0)) * saturate(remap(heightFraction, 0.75, 1.0, 1.0, 0.0));\n\n      float shape = getCloudShape(cloudSize * p);\n      shape *= mix(0.0, 1.0, min(2.0 * (1.0 - coverage), 1.0));\n      cloud = saturate(remap(cloud, shape, 1.0, 0.0, 1.0));\n\n      if (cloud <= 0.0) {\n        return 0.0;\n      }\n\n      return density * saturate(remap(cloud, smoothness * getCloudShape(detailSize * p), 1.0, 0.0, 1.0));\n    }"),e.fragment.code.add("\n    vec2 sphereIntersections(vec3 start, vec3 dir, float radius) {\n      float a = dot(dir, dir);\n      float b = 2.0 * dot(dir, start);\n      float c = dot(start, start) - (radius * radius);\n      float d = (b * b) - 4.0 * a * c;\n\n      if (d < 0.0) {\n        return vec2(1e5, -1e5);\n      }\n\n      return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));\n    }\n      \n    float HenyeyGreenstein(float g, float costh) {\n      return (1.0 / (4.0 * 3.1415))  * ((1.0 - g * g) / pow(1.0 + g * g - 2.0 * g * costh, 1.5));\n    }\n    "),e.fragment.code.add("\n    vec3 multipleOctaves(float extinction, float mu, float stepL) {\n      float attenuation = 1.0;\n      float contribution = 1.0;\n      float phaseAttenuation = 1.0;\n      vec3 luminance = vec3(0);\n\n      for (int i = 0; i < 4; i++) {\n        float phase = mix(HenyeyGreenstein(0.0, mu), HenyeyGreenstein(0.3 * phaseAttenuation, mu), 0.7);\n        luminance += contribution * phase * exp(-stepL * extinction * sigmaE * attenuation);\n        attenuation *= 0.2;\n        contribution *= 0.6;\n        phaseAttenuation *= 0.5;\n      }\n\n      return luminance;\n    }"),e.fragment.code.add("\n    vec3 lightRay(vec3 org, vec3 p, float phaseFunction, float mu, vec3 sunDirection) {\n      float lightRayDensity = clouds(p);\n      lightRayDensity += clouds(p + sunDirection * 1.0 * stepL);\n      lightRayDensity += clouds(p + sunDirection * 2.0 * stepL);\n      lightRayDensity += clouds(p + sunDirection * 3.0 * stepL);\n      lightRayDensity += clouds(p + sunDirection * 4.0 * stepL);\n      lightRayDensity += clouds(p + sunDirection * 5.0 * stepL);\n      \n      vec3 beersLaw = multipleOctaves(lightRayDensity, mu, stepL);\n\n      return mix(beersLaw * 2.0 * (1.0 - (exp(-stepL * lightRayDensity * 2.0 * sigmaE ))), beersLaw, 0.5 + 0.5 * mu);\n    }"),e.fragment.code.add('\n    vec3 mainRay(vec3 org, vec3 dir, vec3 sunDirection, float distToStart, float totalDistance, out float totalTransmittance) {\n\n      // This is never true but having the if statement stops later loop unrolling, texture prefetching and WebGL context crashes\n      if (dir.z < 0.0) {\n        return vec3(0);\n      }\n\n      //Variable to track transmittance along view ray. Assume clear sky and attenuate light when encountering clouds.\n      totalTransmittance = 1.0;\n\n      float stepS = totalDistance / float(STEPS);\n      float cameraHeight = length(org);\n\n      //Alignment of view and light directions.\n      float mu = 0.5 + 0.5 * dot(sunDirection, dir);\n      float phaseFunction = mix(HenyeyGreenstein(-0.3, mu), HenyeyGreenstein(0.3, mu), 0.7);\n      \n      vec3 p = org + distToStart  * dir;\n      float dist = distToStart;\n      vec3 color = vec3(0.0);\n\n      for (int i = 0; i < STEPS; i++) {\n\n        float sampleDensity = clouds(p);\n        float sampleSigmaE = sampleDensity * sigmaE;\n\n        if (sampleDensity > 0.0 ) {\n          float ambient = mix((1.2), (1.6), saturate((length(p) - cloudRadius - cloudStart) / cloudHeight));\n\n          vec3 luminance = sampleDensity * (ambient + power * phaseFunction * lightRay(org, p, phaseFunction, mu, sunDirection));\n          float transmittance = exp(-sampleSigmaE * stepS);\n\n          //Better energy conserving integration\n          //"From Physically based sky, atmosphere and cloud rendering in Frostbite" 5.6\n          color += totalTransmittance * (luminance - luminance * transmittance) / sampleSigmaE;\n\n          totalTransmittance *= transmittance;\n\n          //If ray combined transmittance is close to 0, nothing beyond this sample point is visible, so break early.\n          if (totalTransmittance <= 0.001) {\n            totalTransmittance = 0.0;\n            break;\n          }\n\n        }\n\n        dist += stepS;\n        p = org + dir * dist;\n      }\n\n      return color;\n    }'),e.fragment.code.add("\n    void main() {\n      vec3 rayDir = rayDirection(gl_FragCoord.xy);\n      rayDir = normalize(viewMatrix * rayDir);\n\n      vec3 viewPos = vec3(0, 0, cloudRadius + 1.0);\n\n      bool hitsPlanet = rayDir.z < 0.0;\n\n      if (hitsPlanet) {\n        gl_FragColor = vec4(vec3(0), 1);\n        return;\n      }\n\n      vec2 rayStartIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart);\n      vec2 rayEndIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart + cloudHeight);\n      float distToStart = rayStartIntersect.y;\n      float totalDistance = rayEndIntersect.y - distToStart;\n\n      float totalTransmittance = 1.0;\n      vec3 sunDirection = normalize(vec3(0, 0, 1));\n      vec3 col = 0.5 * mainRay(viewPos, rayDir, sunDirection, distToStart, totalDistance, totalTransmittance).rgb;\n\n      gl_FragColor = vec4(col, totalTransmittance);\n    }\n  "),e}});class Hd extends vs{initializeProgram(e){const t=Hd.shader.get().build();return new _s(e.rctx,t,ys)}initializePipeline(){return Ea({blending:La(1,1,0,0),depthTest:{func:515},colorWrite:Va})}}Hd.shader=new gs(qd,(()=>Promise.resolve().then((function(){return qd}))));var Bd=Object.freeze({__proto__:null,build:function(){const e=new ds;return e.attributes.add("position","vec3"),e.vertex.code.add(us`void main(void) {
gl_Position = vec4(position, 1.0);
}`),e.fragment.uniforms.add("tileRows","float").add("tileSize","float"),e.fragment.code.add("\n    #define NUM_CELLS 2.0\n    #define PERLIN_WORLEY 0\n    #define WORLEY 1\n\n    float remap(float x, float low1, float high1, float low2, float high2) {\n      return low2 + (x - low1) * (high2 - low2) / (high1 - low1);\n    }\n\n    float saturate(float x) {\n      return clamp(x, 0.0, 1.0);\n    }\n\n    vec4 taylorInvSqrt(vec4 r) {\n      return 1.79284291400159 - 0.85373472095314 * r;\n    }\n\n    vec4 mod289(vec4 x) {\n      return x - floor( x * (1.0 / 289.0)) * 289.0;\n    }\n\n    vec4 permute(vec4 x) {\n      return mod289(((x * 34.0) + 1.0) * x);\n    }\n\n    vec4 fade(vec4 t) {\n      return (t * t * t) * (t * (t * vec4(6) - vec4(15)) + vec4(10));\n    }\n\n    float glmPerlin(vec4 Position, vec4 rep) {\n      vec4 Pi0 = mod(floor(Position), rep);\n      vec4 Pi1 = mod(Pi0 + float(1), rep);\n      vec4 Pf0 = fract(Position);\n      vec4 Pf1 = Pf0 - float(1);\n      vec4 ix = vec4(Pi0.x, Pi1.x, Pi0.x, Pi1.x);\n      vec4 iy = vec4(Pi0.y, Pi0.y, Pi1.y, Pi1.y);\n      vec4 iz0 = vec4(Pi0.z);\n      vec4 iz1 = vec4(Pi1.z);\n      vec4 iw0 = vec4(Pi0.w);\n      vec4 iw1 = vec4(Pi1.w);\n\n      vec4 ixy = permute(permute(ix) + iy);\n      vec4 ixy0 = permute(ixy + iz0);\n      vec4 ixy1 = permute(ixy + iz1);\n      vec4 ixy00 = permute(ixy0 + iw0);\n      vec4 ixy01 = permute(ixy0 + iw1);\n      vec4 ixy10 = permute(ixy1 + iw0);\n      vec4 ixy11 = permute(ixy1 + iw1);\n\n      vec4 gx00 = ixy00 / float(7);\n      vec4 gy00 = floor(gx00) / float(7);\n      vec4 gz00 = floor(gy00) / float(6);\n      gx00 = fract(gx00) - float(0.5);\n      gy00 = fract(gy00) - float(0.5);\n      gz00 = fract(gz00) - float(0.5);\n      vec4 gw00 = vec4(0.75) - abs(gx00) - abs(gy00) - abs(gz00);\n      vec4 sw00 = step(gw00, vec4(0));\n      gx00 -= sw00 * (step(float(0), gx00) - float(0.5));\n      gy00 -= sw00 * (step(float(0), gy00) - float(0.5));\n\n      vec4 gx01 = ixy01 / float(7);\n      vec4 gy01 = floor(gx01) / float(7);\n      vec4 gz01 = floor(gy01) / float(6);\n      gx01 = fract(gx01) - float(0.5);\n      gy01 = fract(gy01) - float(0.5);\n      gz01 = fract(gz01) - float(0.5);\n      vec4 gw01 = vec4(0.75) - abs(gx01) - abs(gy01) - abs(gz01);\n      vec4 sw01 = step(gw01, vec4(0.0));\n      gx01 -= sw01 * (step(float(0), gx01) - float(0.5));\n      gy01 -= sw01 * (step(float(0), gy01) - float(0.5));\n\n      vec4 gx10 = ixy10 / float(7);\n      vec4 gy10 = floor(gx10) / float(7);\n      vec4 gz10 = floor(gy10) / float(6);\n      gx10 = fract(gx10) - float(0.5);\n      gy10 = fract(gy10) - float(0.5);\n      gz10 = fract(gz10) - float(0.5);\n      vec4 gw10 = vec4(0.75) - abs(gx10) - abs(gy10) - abs(gz10);\n      vec4 sw10 = step(gw10, vec4(0.0));\n      gx10 -= sw10 * (step(float(0), gx10) - float(0.5));\n      gy10 -= sw10 * (step(float(0), gy10) - float(0.5));\n\n      vec4 gx11 = ixy11 / float(7);\n      vec4 gy11 = floor(gx11) / float(7);\n      vec4 gz11 = floor(gy11) / float(6);\n      gx11 = fract(gx11) - float(0.5);\n      gy11 = fract(gy11) - float(0.5);\n      gz11 = fract(gz11) - float(0.5);\n      vec4 gw11 = vec4(0.75) - abs(gx11) - abs(gy11) - abs(gz11);\n      vec4 sw11 = step(gw11, vec4(float(0)));\n      gx11 -= sw11 * (step(float(0), gx11) - float(0.5));\n      gy11 -= sw11 * (step(float(0), gy11) - float(0.5));\n\n      vec4 g0000 = vec4(gx00.x, gy00.x, gz00.x, gw00.x);\n      vec4 g1000 = vec4(gx00.y, gy00.y, gz00.y, gw00.y);\n      vec4 g0100 = vec4(gx00.z, gy00.z, gz00.z, gw00.z);\n      vec4 g1100 = vec4(gx00.w, gy00.w, gz00.w, gw00.w);\n      vec4 g0010 = vec4(gx10.x, gy10.x, gz10.x, gw10.x);\n      vec4 g1010 = vec4(gx10.y, gy10.y, gz10.y, gw10.y);\n      vec4 g0110 = vec4(gx10.z, gy10.z, gz10.z, gw10.z);\n      vec4 g1110 = vec4(gx10.w, gy10.w, gz10.w, gw10.w);\n      vec4 g0001 = vec4(gx01.x, gy01.x, gz01.x, gw01.x);\n      vec4 g1001 = vec4(gx01.y, gy01.y, gz01.y, gw01.y);\n      vec4 g0101 = vec4(gx01.z, gy01.z, gz01.z, gw01.z);\n      vec4 g1101 = vec4(gx01.w, gy01.w, gz01.w, gw01.w);\n      vec4 g0011 = vec4(gx11.x, gy11.x, gz11.x, gw11.x);\n      vec4 g1011 = vec4(gx11.y, gy11.y, gz11.y, gw11.y);\n      vec4 g0111 = vec4(gx11.z, gy11.z, gz11.z, gw11.z);\n      vec4 g1111 = vec4(gx11.w, gy11.w, gz11.w, gw11.w);\n\n      vec4 norm00 = taylorInvSqrt(vec4(dot(g0000, g0000), dot(g0100, g0100), dot(g1000, g1000), dot(g1100, g1100)));\n      g0000 *= norm00.x;\n      g0100 *= norm00.y;\n      g1000 *= norm00.z;\n      g1100 *= norm00.w;\n\n      vec4 norm01 = taylorInvSqrt(vec4(dot(g0001, g0001), dot(g0101, g0101), dot(g1001, g1001), dot(g1101, g1101)));\n      g0001 *= norm01.x;\n      g0101 *= norm01.y;\n      g1001 *= norm01.z;\n      g1101 *= norm01.w;\n\n      vec4 norm10 = taylorInvSqrt(vec4(dot(g0010, g0010), dot(g0110, g0110), dot(g1010, g1010), dot(g1110, g1110)));\n      g0010 *= norm10.x;\n      g0110 *= norm10.y;\n      g1010 *= norm10.z;\n      g1110 *= norm10.w;\n\n      vec4 norm11 = taylorInvSqrt(vec4(dot(g0011, g0011), dot(g0111, g0111), dot(g1011, g1011), dot(g1111, g1111)));\n      g0011 *= norm11.x;\n      g0111 *= norm11.y;\n      g1011 *= norm11.z;\n      g1111 *= norm11.w;\n\n      float n0000 = dot(g0000, Pf0);\n      float n1000 = dot(g1000, vec4(Pf1.x, Pf0.y, Pf0.z, Pf0.w));\n      float n0100 = dot(g0100, vec4(Pf0.x, Pf1.y, Pf0.z, Pf0.w));\n      float n1100 = dot(g1100, vec4(Pf1.x, Pf1.y, Pf0.z, Pf0.w));\n      float n0010 = dot(g0010, vec4(Pf0.x, Pf0.y, Pf1.z, Pf0.w));\n      float n1010 = dot(g1010, vec4(Pf1.x, Pf0.y, Pf1.z, Pf0.w));\n      float n0110 = dot(g0110, vec4(Pf0.x, Pf1.y, Pf1.z, Pf0.w));\n      float n1110 = dot(g1110, vec4(Pf1.x, Pf1.y, Pf1.z, Pf0.w));\n      float n0001 = dot(g0001, vec4(Pf0.x, Pf0.y, Pf0.z, Pf1.w));\n      float n1001 = dot(g1001, vec4(Pf1.x, Pf0.y, Pf0.z, Pf1.w));\n      float n0101 = dot(g0101, vec4(Pf0.x, Pf1.y, Pf0.z, Pf1.w));\n      float n1101 = dot(g1101, vec4(Pf1.x, Pf1.y, Pf0.z, Pf1.w));\n      float n0011 = dot(g0011, vec4(Pf0.x, Pf0.y, Pf1.z, Pf1.w));\n      float n1011 = dot(g1011, vec4(Pf1.x, Pf0.y, Pf1.z, Pf1.w));\n      float n0111 = dot(g0111, vec4(Pf0.x, Pf1.y, Pf1.z, Pf1.w));\n      float n1111 = dot(g1111, Pf1);\n\n      vec4 fade_xyzw = fade(Pf0);\n      vec4 n_0w = mix(vec4(n0000, n1000, n0100, n1100), vec4(n0001, n1001, n0101, n1101), fade_xyzw.w);\n      vec4 n_1w = mix(vec4(n0010, n1010, n0110, n1110), vec4(n0011, n1011, n0111, n1111), fade_xyzw.w);\n      vec4 n_zw = mix(n_0w, n_1w, fade_xyzw.z);\n      vec2 n_yzw = mix(vec2(n_zw.x, n_zw.y), vec2(n_zw.z, n_zw.w), fade_xyzw.y);\n      float n_xyzw = mix(n_yzw.x, n_yzw.y, fade_xyzw.x);\n      return float(2.2) * n_xyzw;\n    }\n\n    float getPerlinNoise(vec3 pos, float frequency) {\n      const float octaveFrequencyFactor = 2.0;\n\n      float sum = 0.0;\n      float weightSum = 0.0;\n      float weight = 1.0;\n\n      for (int oct = 0; oct < 3; oct++) {\n        vec3 p = pos * frequency;\n        float val = 0.5 + 0.5 * glmPerlin(vec4(p, 0.0), vec4(frequency));\n        sum += val * weight;\n        weightSum += weight;\n        weight *= 0.5;\n        frequency *= octaveFrequencyFactor;\n      }\n\n      float noise = (sum / weightSum);\n      noise = saturate(noise);\n      return noise;\n    }\n\n    float hash(float p) {\n      p = fract(p * 0.1031);\n      p *= p + 33.33;\n      p *= p + p;\n      return fract(p);;\n    }\n\n    float noise(vec3 x) {\n      vec3 p = floor(x);\n      vec3 f = fract(x);\n\n      f = f * f * (3.0 - 2.0 * f);\n      float n = p.x + p.y * 57.0 + 113.0 * p.z;\n\n      return mix(\n      mix(\n        mix(hash(n + 0.0), hash(n + 1.0), f.x),\n        mix(hash(n + 57.0), hash(n + 58.0), f.x),\n        f.y),\n      mix(\n        mix(hash(n + 113.0), hash(n + 114.0), f.x),\n        mix(hash(n + 170.0), hash(n + 171.0), f.x),\n        f.y),\n      f.z);\n    }\n\n    float worley(vec3 pos, float numCells) {\n      vec3 p = pos * numCells;\n      float d = 1.0e10;\n\n      for (int x = -1; x <= 1; x++) {\n        for (int y = -1; y <= 1; y++) {\n          for (int z = -1; z <= 1; z++) {\n            vec3 tp = floor(p) + vec3(x, y, z);\n            tp = p - tp - noise(mod(tp, numCells));\n            d = min(d, dot(tp, tp));\n          }\n        }\n      }\n\n      return 1.0 - clamp(d, 0.0, 1.0);\n    }\n\n    vec3 get3Dfrom2D(vec2 uv, float tileRows) {\n      vec2 tile = floor(uv);\n      float z = floor(tileRows * tile.y + tile.x);\n      return vec3(fract(uv), z);\n    }\n\n    float getTextureForPoint(vec3 p, int type) {\n      if (type == PERLIN_WORLEY) {\n\n        const float frequency = 8.0;\n        float perlinNoise = getPerlinNoise(p, frequency);\n\n        float worley0 = worley(p, NUM_CELLS * 2.0);\n        float worley1 = worley(p, NUM_CELLS * 8.0);\n        float worley2 = worley(p, NUM_CELLS * 14.0);\n\n        float worleyFBM = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;\n        return remap(perlinNoise, 0.0, 1.0, worleyFBM, 1.0);\n      }\n\n      float worley0 = worley(p, NUM_CELLS);\n      float worley1 = worley(p, NUM_CELLS * 2.0);\n      float worley2 = worley(p, NUM_CELLS * 4.0);\n      float worley3 = worley(p, NUM_CELLS * 8.0);\n\n      float FBM0 = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;\n      float FBM1 = worley1 * 0.625 + worley2 * 0.25 + worley3 * 0.125;\n      float FBM2 = worley2 * 0.75 + worley3 * 0.25;\n\n      return FBM0 * 0.625 + FBM1 * 0.25 + FBM2 * 0.125;\n    }\n  "),e.fragment.code.add("\n    void main() {\n      const float padWidth = 1.0;\n      float paddedSize = tileSize + 2.0 * padWidth;\n      float tileCount = tileRows * tileRows;\n      vec2 tile = floor((gl_FragCoord.xy - 0.5) / paddedSize);\n\n      bool padCell = false;\n      if (mod(gl_FragCoord.x, paddedSize) == 0.5 || mod(gl_FragCoord.x, paddedSize) == paddedSize - 0.5) {\n        padCell = true;\n      }\n\n      if (mod(gl_FragCoord.y, paddedSize) == 0.5 || mod(gl_FragCoord.y, paddedSize) == paddedSize - 0.5) {\n        padCell = true;\n      }\n\n      bool startPadX = false;\n      bool startPadY = false;\n      bool endPadX = false;\n      bool endPadY = false;\n\n      if (gl_FragCoord.x == tile.x * paddedSize + 0.5) {\n        startPadX = true;\n      }\n\n      if (gl_FragCoord.y == tile.y * paddedSize + 0.5) {\n        startPadY = true;\n      }\n\n      if (gl_FragCoord.x == (tile.x + 1.0) * paddedSize - 0.5) {\n        endPadX = true;\n      }\n\n      if (gl_FragCoord.y == (tile.y + 1.0) * paddedSize - 0.5) {\n        endPadY = true;\n      }\n\n      vec2 padding = vec2(2.0 * padWidth) * tile;\n      vec2 uv;\n\n      if (padCell) {\n        vec2 pixel = gl_FragCoord.xy - padWidth - padding;\n\n        if (startPadX) {\n          pixel.x += tileSize;\t\n        }\n\n        if (startPadY) {\n          pixel.y += tileSize;\t\n        }\n\n        if (endPadX) {\n          pixel.x -= tileSize;\t\n        }\n\n        if (endPadY) {\n          pixel.y -= tileSize;\t\n        }\n\n        uv = vec2(pixel.xy / tileSize);\n      } else {\n        vec2 pixel = gl_FragCoord.xy - padWidth - padding;\n        uv = vec2(pixel.xy / tileSize);\n      }\n\n      vec3 p_ = get3Dfrom2D(uv, tileRows);\n      vec3 p = p_;\n      p.z /= (tileRows * tileRows);\n\n      float worleyPerlinNoise = getTextureForPoint(p, PERLIN_WORLEY);\n      float worleyNoise = getTextureForPoint(p, WORLEY);\n\n      vec3 col = vec3(0);\n      col.r = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));\n\n      p_ = mod(p_ + 1.0, tileRows * tileRows);\n      p = p_;\n      p.z /= (tileRows * tileRows);\n\n      worleyPerlinNoise = getTextureForPoint(p, PERLIN_WORLEY);\n      worleyNoise = getTextureForPoint(p, WORLEY);\n\n      col.g = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));\n\n    \tgl_FragColor = vec4(col, 1.0);\n    }\n  "),e}});class Nd extends vs{initializeProgram(e){const t=Nd.shader.get().build();return new _s(e.rctx,t,ys)}initializePipeline(){return Ea({blending:ka(1,0),depthTest:{func:515},colorWrite:Va})}}Nd.shader=new gs(Bd,(()=>Promise.resolve().then((function(){return Bd}))));class Gd{constructor(e,t){this._shapeTextureDescriptor={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,hasMipmap:!1,width:1,height:1},this._tileSize=1,this._tileRows=1,this._frameBuffer=new Tn(e,{colorTarget:0}),this._vao=xs(e),this.textureAtlas=new Pn(e,this._shapeTextureDescriptor,null),this._technique=new Nd({rctx:e,viewingMode:t.state.viewingMode},null)}destroy(){this._technique=S(this._technique),this._frameBuffer=P(this._frameBuffer),this._vao=P(this._vao),this.textureAtlas=P(this.textureAtlas)}render(e,t){if(M(this._vao)||M(this.textureAtlas))return!1;this._tileSize=e,this._tileRows=Math.ceil(Math.sqrt(this._tileSize));const i=(e+2)*this._tileRows;this._frameBuffer.resize(i,i),this.textureAtlas.resize(i,i),this._frameBuffer.attachColorTexture(this.textureAtlas),t.bindFramebuffer(this._frameBuffer);const r=this._technique.program;t.bindVAO(this._vao),r.assertCompatibleVertexAttributeLocations(this._vao),this._technique.bindPipelineState(t),t.useProgram(r),r.setUniform1f("tileSize",this._tileSize),r.setUniform1f("tileRows",this._tileRows);const s=t.getViewport();return t.setViewport(0,0,i,i),t.gl.drawArrays(t.gl.TRIANGLE_STRIP,0,4),this._frameBuffer.detachColorTexture(),t.setViewport(s.x,s.y,s.width,s.height),!0}}class Wd{constructor(e,t){this._cubeMapSize=2048,this._viewMat3=vn(),this._eye=yn(),this._faceRenderFlags=[],this.viewDirections=[xn(1,0,0),xn(-1,0,0),xn(0,1,0),xn(0,-1,0),xn(0,0,1)],this.upDirections=[xn(0,1,0),xn(0,1,0),xn(0,0,-1),xn(0,0,1),xn(0,1,0)],this._cloudRadius=0,this._viewMatrix=Ar(),this.coverage=.4,this.density=.5,this.cloudSize=.5,this.detailSize=.5,this.smoothness=.7,this.absorption=0,this.cloudHeight=1,this._noiseTextureAtlas=new Gd(e,t),this._noiseTextureAtlas.render(128,e);const i={target:34067,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,hasMipmap:!1,width:this._cubeMapSize,height:this._cubeMapSize};this._frameBufferCube=new Tn(e,{colorTarget:2,width:this._cubeMapSize,height:this._cubeMapSize},i),this._vao=xs(e),this._technique=new Hd({rctx:e,viewingMode:t.state.viewingMode},null);const r=wt(t.spatialReference);this._cloudRadius=.5*r.radius,this.resetRenderFlags()}set coverage(e){this._coverage=e,this.resetRenderFlags()}get coverage(){return this._coverage}set density(e){this._density=this.remap(e,0,1,0,.3),this.resetRenderFlags()}get density(){return this._density}set cloudSize(e){this._cloudSize=this.remap(Math.max(.01,1-e),0,1,0,.02),this.resetRenderFlags()}get cloudSize(){return this._cloudSize}set detailSize(e){this._detailSize=this.remap(Math.max(.01,1-e),0,1,0,.2),this.resetRenderFlags()}get detailSize(){return this._detailSize}set smoothness(e){this._smoothness=this.remap(1-e,0,1,0,.5),this.resetRenderFlags()}get smoothness(){return this._smoothness}set absorption(e){this._sigmaE=1+e,this._power=this.remap(e,0,1,35,70),this.resetRenderFlags()}get absorption(){return this._power}set cloudHeight(e){this._cloudHeight=this.remap(e,0,1,0,1500),this.resetRenderFlags()}get cloudHeight(){return this._cloudHeight}destroy(){this._technique=S(this._technique),this._frameBufferCube=P(this._frameBufferCube),this._vao=P(this._vao),this._noiseTextureAtlas=R(this._noiseTextureAtlas)}resetRenderFlags(){for(let e=0;e<5;e++)this._faceRenderFlags[e]=!0}_allRendered(){for(let e=0;e<5;e++)if(!0===this._faceRenderFlags[e])return!1;return!0}remap(e,t,i,r,s){return r+(e-t)*(s-r)/(i-t)}render(e){if(M(this._vao)||this._allRendered())return!1;this.resetRenderFlags(),e.setViewport(0,0,this._cubeMapSize,this._cubeMapSize),e.bindFramebuffer(this._frameBufferCube,!1,34069);const t=this._technique.program;e.useProgram(t),t.bindTexture(this._noiseTextureAtlas.textureAtlas,"cloudShapeTexture"),t.setUniform1f("cloudRadius",this._cloudRadius),t.setUniform1f("halfCubeMapSize",.5*this._cubeMapSize),t.setUniform1f("power",this._power),t.setUniform1f("sigmaE",this._sigmaE),t.setUniform1f("density",this._density),t.setUniform1f("cloudSize",this._cloudSize),t.setUniform1f("detailSize",this._detailSize),t.setUniform1f("smoothness",this._smoothness),t.setUniform1f("cloudHeight",this._cloudHeight),t.setUniform1f("coverage",this._coverage),e.bindVAO(this._vao),t.assertCompatibleVertexAttributeLocations(this._vao),this._technique.bindPipelineState(e);for(let i=0;i<5;i++)if(this._faceRenderFlags[i]){const r=this.viewDirections[i],s=this.upDirections[i];xr(this._viewMatrix,this._eye,r,s),dn(this._viewMat3,this._viewMatrix),t.setUniformMatrix3fv("viewMatrix",this._viewMat3);const a=34069+i;this._frameBufferCube.framebufferTexture2D(this._frameBufferCube.colorAttachment.glName,e.gl,36064,a),e.gl.drawArrays(e.gl.TRIANGLE_STRIP,0,4),e.gl.flush(),this._faceRenderFlags[i]=!1}return!0}get test(){return{power:this._power,density:this._density,cloudHeight:this._cloudHeight,cloudSize:this._cloudSize,detailSize:this._detailSize,smoothness:this._smoothness}}}var Qd=Object.freeze({__proto__:null,build:function(e){const t=new ds;if(2===e.geometry)t.attributes.add("position","vec2"),t.varyings.add("color","vec4"),t.vertex.uniforms.add("lightingMainDirection","vec3").add("cameraPosition","vec3").add("undergroundFadeAlpha","float"),t.vertex.code.add(us`void main(void) {
float ndotl = dot(normalize(cameraPosition), lightingMainDirection);
float lighting = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));
color = vec4(vec3(lighting), undergroundFadeAlpha);
gl_Position = vec4(position.xy, 1.0, 1.0);
}`),t.fragment.code.add(us`void main() {
gl_FragColor = color;
}`);else{t.include(Ts,{linearDepth:!1}),t.attributes.add("position","vec3"),t.varyings.add("vtc","vec2"),t.varyings.add("falloff","float");const i=1===e.geometry;t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("lightingMainDirection","vec3"),i||(t.varyings.add("innerFactor","float"),t.vertex.uniforms.add("silCircleCenter","vec3").add("silCircleV1","vec3").add("silCircleV2","vec3").add("texV","vec2").add("innerScale","float"));const r=6.2831853,s=1/128;t.vertex.code.add(us`
		void main(void) {
      ${i?us`
      vec3 pos = position;
      float ndotl = lightingMainDirection.z;
      vtc = vec2(0.0, position.z + 0.05);`:us`
      innerFactor = clamp(-position.z, 0.0, 1.0);
      float scale = position.y * (1.0 + innerFactor * innerScale);
      float phi = position.x * ${us.float(r*s)} + 1.0;
      vec3 pos =  (silCircleCenter + sin(phi) * silCircleV1 + cos(phi) * silCircleV2) * scale;
      float ndotl = dot(normalize(position.y > 0.0 ? pos: silCircleCenter), lightingMainDirection);
      vtc.x = position.x  * ${us.float(s)};
      vtc.y = texV.x * (1.0 - position.z) + texV.y * position.z;
      `}
      falloff = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));

		  gl_Position = transformPosition(proj, view, pos);
		  gl_Position.z = gl_Position.w; // project atmosphere onto the far plane
    }
	  `),t.fragment.uniforms.add("tex","sampler2D"),i||t.fragment.uniforms.add("altitudeFade","float"),t.fragment.code.add(us`
		void main() {
			vec4 atmosphereColor = texture2D(tex, vtc) * falloff;
      ${i?us`gl_FragColor = atmosphereColor;`:us`
			vec4 innerColor = vec4(atmosphereColor.rgb, 1.0 - altitudeFade);
			gl_FragColor = mix(atmosphereColor, innerColor, smoothstep(0.0, 1.0, innerFactor));
      `}
    }`)}return t}});class Zd extends vs{initializeProgram(e){const t=Zd.shader.get(),i=this.configuration,r=t.build({geometry:i.geometry});return new _s(e.rctx,r,ys)}initializePipeline(){return 1===this.configuration.geometry?Ea({blending:La(770,1,771,771),culling:ja,depthTest:{func:515},colorWrite:Va}):Ea({blending:La(770,1,771,771),depthTest:{func:515},colorWrite:Va})}}Zd.shader=new gs(Qd,(()=>Promise.resolve().then((function(){return Qd}))));class Yd extends fs{constructor(){super(...arguments),this.geometry=0}}e([ms({count:3})],Yd.prototype,"geometry",void 0);var Xd="data:image/png;base64, iVBORw0KGgoAAAANSUhEUgAAAAEAAAIACAYAAABD1gYFAAAACXBIWXMAAC4jAAAuIwF4pT92AAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAAXVJREFUeNq0k9GWhDAIQ3PjzP9/cuehFqhW19mz++IhkCZAq1prsqT+kSQS9g8Vnqp6VGVWkYVktR6tj3Gr968nLnfwlHzHYyHapkKS73bPd/39eI38AYWj24OGvqdwWjZ3l8IDgacXyl1Dj9tdLOzZiicj+P1YcGk0H2O2vN/VQpTveEHmPHQxZxYlqsQdhUeuCWREuDEvAjqlCqDIMYwIo2ijR1HdYUS58dQrKpgQ0EGeMocsTNXrxzyOhS9kfzlWjn82YuWLqwAnvfNEWJFjYXkJCT0s7AmS0NG4x7Lt6Cpy2MiVPBZmS668QT5AR1cevp7b6CpzQ/ZSNH0vmhy5CsNtdax0MBpXDBiFsrDiMSLKMc8b6hH93bNbEpRsIyHDUhNcfTyeKF16PC7c/2QdczvUnvOB1ylZHVFSMtd5s8C2IW/7w6hwM5GLavLCd1zkiFjB+BwH1DSgctQ7mPOimBLJrw35beSXkd8BM/cCqbXWPgMA+GQQ5sIgkfAAAAAASUVORK5CYII=";const Kd=U.getLogger("esri.views.3d.environment.PanoramicAtmosphere");class Jd{constructor(){this.slot=15,this._atmosphereTechniqueConfig=new Yd,this._readyResolver=l(),this._readyController=h()}get canRender(){return null!=this._texture}destroy(){this._readyResolver.reject(),this._texture=P(this._texture),this._vao=P(this._vao),this._readyController=A(this._readyController)}when(){return this._readyResolver.promise}initializeRenderContext(e){this._atmosphereTechniqueConfig.geometry=1,this._atmosphereTechnique=e.shaderTechniqueRep.acquire(Zd,this._atmosphereTechniqueConfig);const t=e.renderContext.rctx;this._vao=this._createVertexArrayObject(t),this._vaoCount=Ua(this._vao,"geometry"),Rn(Xd,{signal:this._readyController.signal}).then((i=>{this._texture=new Pn(t,{pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0},i),e.requestRender(),this._readyController=null,this._readyResolver.resolve()})).catch((e=>{c(e)||Kd.error("Unable to initialize atmosphere: image request failed",e),this._readyResolver.reject()}))}uninitializeRenderContext(){this.destroy()}render(e){if(e.slot!==this.slot||0!==e.pass)return!1;const t=e.rctx,i=this._atmosphereTechnique.program;var r,s;return t.useProgram(i),this._atmosphereTechnique.bindPipelineState(t),i.bindTexture(this._texture,"tex"),Ss(i,e.camera.projectionMatrix),r=$d,s=e.camera.viewMatrix,wr(r,s),r[12]=0,r[13]=0,r[14]=0,r[15]=1,i.setUniformMatrix4fv("view",$d),i.setUniform4f("color",1,1,1,1),e.scenelightingData.setLightDirectionUniform(i),t.bindVAO(this._vao),i.assertCompatibleVertexAttributeLocations(this._vao),t.drawArrays(4,0,this._vaoCount),!0}_createVertexArrayObject(e){const t=An.createPolySphereGeometry(1,2,!1),i=t.indices.get("position");for(let e=0;e<i.length;e+=3){const t=i[e];i[e]=i[e+2],i[e+2]=t}const r=t.vertexAttributes.get("position").data,s=eu.createBuffer(i.length),a=s.position;for(let e=0;e<i.length;++e){const t=3*i[e];a.set(e,0,r[t]),a.set(e,1,r[t+1]),a.set(e,2,r[t+2])}return new qa(e,ys,{geometry:Mn(eu)},{geometry:Ha.createVertex(e,35044,s.buffer)})}}const $d=Ar(),eu=Dn().vec3f("position");var tu=Object.freeze({__proto__:null,build:function(e){const t=new ds;return t.attributes.add("position","vec2"),t.attributes.add("uv0","vec2"),t.varyings.add("worldRay","vec3"),t.varyings.add("vtc","vec2"),e.haze&&t.varyings.add("eyeDir","vec3"),t.vertex.uniforms.add("projectionInverse","mat4"),t.vertex.uniforms.add("viewInverse","mat4"),t.vertex.code.add(us`
    void main(void) {
      vec3 posViewNear = (projectionInverse * vec4(position, -1, 1)).xyz;

      worldRay = (viewInverse * vec4(posViewNear, 0)).xyz;
      vtc = uv0;

      ${e.haze?us`eyeDir = posViewNear;`:""}

      gl_Position = vec4(position, 1, 1);
    }
  `),t.fragment.uniforms.add("lightingMainDirection","vec3").add("invWavelength","vec3").add("invWavelengthScaled","vec3").add("radii","vec2").add("atmosphereParameters1","vec4").add("atmosphereParameters2","vec4").add("cameraPosition","vec3").add("nearFar","vec2").add("heightParameters","vec4"),e.haze?t.fragment.uniforms.add("depthTex","sampler2D"):t.fragment.uniforms.add("atmosphereParameters3","vec3").add("innerFadeDistance","float").add("altitudeFade","float"),t.fragment.include(bs),t.fragment.code.add(us`const float krESun = 0.075;
const float kmESun = 0.015;
#define innerRadius radii[0]
#define outerRadius radii[1]
#define shellScale atmosphereParameters1.x
#define shellDepth vec2(atmosphereParameters1.y, atmosphereParameters2.y)
#define scaleOverScaleDepth vec2(atmosphereParameters1.z, atmosphereParameters2.z)
#define oneOverScaleDepth vec2(atmosphereParameters1.w, atmosphereParameters2.w)`),e.haze||t.fragment.code.add(us`#define g atmosphereParameters2.x
#define gSq atmosphereParameters3.x
#define miePhaseCoefficients atmosphereParameters3.y
#define lowerAlphaBlendBound atmosphereParameters3.z`),t.fragment.code.add(us`
  // The camera's current height
  #define cameraHeight heightParameters[0]
  // cameraHeight^2
  #define cameraHeightSq heightParameters[1]
  // cameraHeightSq - outerRadiusSq; // C = ||o-c||^2 - r^2
  #define C heightParameters[2]
  // cameraHeightSq - (innerRadiusSq - 63756370000.0); // C = ||o-c||^2 - r^2
  #define CSur heightParameters[3]

  ${e.haze?"// Camera HDR\n        const float exposure = 1.5;\n        const vec3 oneOverGamma = vec3(1.0); //Gamma = 1.0":"const float exposure = 2.0;\n        const vec3 oneOverGamma = vec3(0.454545); // Gamma = 2.2\n        vec3 reinhardTM(vec3 inputColor, float _exposure) {\n          vec3 intermediate = inputColor * _exposure;\n          intermediate /= ( 1.0 + intermediate );\n          return pow(intermediate, oneOverGamma);\n        }\n        "}
    // Loop constants for integral approximation
    const float samples = 5.0;
    const int maxSamples = 5;

    // ToneMapping operators
    vec3 expTM(vec3 inputColor,float _exposure) {
        return pow(1.0 - exp(inputColor * -_exposure), oneOverGamma);
    }

    // Approximation for inner integral based on a radii ratio of 10.25:10
    float scale(float _cos) {
      float x = 1.0 - _cos;
      return exp( -0.00287 + x * ( 0.459 + x * ( 3.83 + x * (-6.80 + x * 5.25 ))));
    }

    void main() {
      // Obtain ray from Camera
      vec3 worldSpaceRay = normalize(worldRay);

      // Compute Atmosphere intersection; i.e. ray/sphere intersection
      float B = 2.0 * dot(cameraPosition, worldSpaceRay); // B = 2(l * (o-c))
      float det = B * B - 4.0 * C; // det = B^2 - 4.0* C

      // idealized sphere intersection to discard early some pixels
      float detSur = B * B - 4.0 * CSur; // det = B^2 - 4.0* C

      // the minimal sample start position:
      // at the camera by default, on the earth radius surface if the camera is underground.
      float minRayStart = 0.0;
  `),e.haze||t.fragment.code.add(us`float surfaceBlend = 0.0;
vec4 surfaceColor = vec4(0.0);
if (detSur >= 0.0) {
float nearSurface = max(0.0, 0.5 *(-B - sqrt(detSur)));
float farSurface = max(0.0, 0.5 *(-B + sqrt(detSur)));
if (nearSurface == 0.0) {
minRayStart = farSurface;
}
vec3 vPos = cameraPosition + worldSpaceRay * nearSurface;
float lightAngle = dot(lightingMainDirection, normalize(vPos));
float brightness = max(0.0, (smoothstep(-1.0, 0.8, 2.0 * lightAngle)));
surfaceColor = vec4(brightness, brightness, brightness, 1.0 - altitudeFade);
float relDist = (farSurface - nearSurface) / innerFadeDistance;
if (relDist > 1.0) {
gl_FragColor = surfaceColor;
return;
}
surfaceBlend = smoothstep(0.0, 1.0, relDist * relDist);
}`),t.fragment.code.add(us`
    if (det >= 0.0) {
    ${e.haze?"\n          float depthSample = texture2D(depthTex, vtc).r;\n\n          float zNear = nearFar[0];\n          float zFar = nearFar[1];\n\n          // http://web.archive.org/web/20130416194336/http://olivers.posterous.com/linear-depth-in-glsl-for-real\n          float zNorm = 2.0 * depthSample - 1.0;\n          float linDepth = 2.0 * zNear * zFar /\n            (zFar + zNear - zNorm * (zFar - zNear));\n\n          float rayEnd;\n          float altitudeAlpha = 1.0;\n\n          // find intersections with ground, but only between the near and far\n          // clipping planes.\n          if (depthSample < 1.0 && depthSample > 0.0) {\n            vec3 cameraSpaceRay = normalize(eyeDir);\n            cameraSpaceRay /= cameraSpaceRay.z;\n            cameraSpaceRay *= linDepth;\n\n            float cameraSpaceRayLength = length(cameraSpaceRay);\n\n            vec3 world = cameraPosition + worldSpaceRay * cameraSpaceRayLength;\n            float worldRadiusSq = dot(world, world);\n\n            // Handle tall structures:\n            // https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/5450\n            float transitionStart = innerRadius + 20000.0;\n            float transitionHeight = 25000.0;\n            float transitionEnd = transitionStart + transitionHeight;\n\n            float edge0 = transitionStart * transitionStart;\n            float edge1 = transitionEnd * transitionEnd;\n\n            altitudeAlpha = 1.0 - clamp((worldRadiusSq - edge0) / (edge1 - edge0), 0.0, 1.0);\n            rayEnd = cameraSpaceRayLength;\n\n            if (altitudeAlpha > 0.0 && detSur > 0.0) {\n              float nearSurface = 0.5 * ( -B - sqrt(detSur) );\n              float interp = clamp(((cameraHeight - innerRadius) - 2000000.0) / 6000000.0, 0.0, 1.0);\n              rayEnd = mix(cameraSpaceRayLength, nearSurface, interp);\n            }\n          }":""}
    float rayStart = 0.5 *(-B - sqrt(det)); //near intersection with atmosphere
    ${e.haze?"float near = abs(rayStart);\n        float far = abs(rayEnd);":"float rayEnd = 0.5 *(-B + sqrt(det)); //far intersection with atmosphere"}

    float scatterDistance; // calculate its scattering offset
    // Calculate the ray's starting position
    if (rayStart < minRayStart)
    { // ray starts from camera or inner radius sphere to far
      rayStart = minRayStart;
      ${e.haze?"":"// clamp to value at inner radius altitude\n          scatterDistance = shellScale * min(0.0, innerRadius - cameraHeight);"}
    }
    ${e.haze?"":"else { // outside atmosphere\n          scatterDistance = -1.0;\n        }"}
    // Initialize the scattering loop variables
    vec3 start = cameraPosition + worldSpaceRay * rayStart;
  `),e.haze&&t.fragment.code.add(us`vec3 end = cameraPosition + worldSpaceRay * rayEnd;
float endLength = length(end);
vec2 altitudeInterval = vec2(length(start) - innerRadius, endLength - innerRadius);
if (altitudeInterval.x < 0.0) {
altitudeInterval = -altitudeInterval;
}
float lightAngle = dot(lightingMainDirection, end) / endLength;
if (near > far)
{
if (altitudeInterval.x < altitudeInterval.y)
{
end = cameraPosition + worldSpaceRay * rayStart;
start = cameraPosition + worldSpaceRay * rayEnd;
worldSpaceRay *= -1.0;
float tmp = altitudeInterval.x;
altitudeInterval.x = altitudeInterval.y;
altitudeInterval.y = tmp;
}
else if (altitudeInterval.x == altitudeInterval.y)
{
altitudeInterval.x += 1.0;
}
}
if (altitudeInterval.x > outerRadius - innerRadius)
{
scatterDistance = innerRadius - outerRadius;
} else
{
scatterDistance = altitudeInterval.y - altitudeInterval.x;
}`),t.fragment.code.add(us`vec2 opticalStartDepth = exp(scatterDistance * oneOverScaleDepth);
float rayLength = rayEnd - rayStart;
float sampleLength = rayLength / samples;
float scaledLength = sampleLength * shellScale;
vec3 sampleRay = worldSpaceRay * sampleLength;
vec3 samplePoint = start + sampleRay * 0.5;`),e.haze?t.fragment.code.add(us`float cameraAngle = dot(-worldSpaceRay, end) / length(end);
float scaleCameraAngle = scale(cameraAngle);
vec2 cameraOffset = scaleCameraAngle * opticalStartDepth;
float scaledValues = scale(lightAngle) + scaleCameraAngle;
vec2 scaledValuesDepth = scaledValues * shellDepth;`):t.fragment.code.add(us`float cameraAngle = dot(worldSpaceRay, start / length(start));
float angleMultiplier = cameraAngle > 0.0 ? cameraAngle : 0.0;
float scaleCameraAngle = scale(cameraAngle);
vec2 cameraOffset = scaleCameraAngle * opticalStartDepth * shellDepth;`),t.fragment.code.add(us`vec3 frontColor = vec3(0.0);
vec3 frontColorBlue = vec3(0.0);
vec3 attenuate = vec3(0.0);
vec3 attenuateBlue = vec3(0.0);
for(int i=0; i<maxSamples; i++) {
float height = length(samplePoint);
float altitude = abs(height - innerRadius);
vec2 depth = exp(-altitude * scaleOverScaleDepth);`),e.haze?t.fragment.code.add(us`vec2 scatter = depth * scaledValuesDepth - cameraOffset;`):t.fragment.code.add(us`float lightAngle = dot(lightingMainDirection, samplePoint) / height;
float cameraAngle = dot(worldSpaceRay, samplePoint) / height;
float tmpScaledValues = scale(lightAngle) - scale(cameraAngle);
vec2 scatter = cameraOffset + tmpScaledValues * depth * shellDepth;`),t.fragment.code.add(us`attenuate = exp(-scatter.x * invWavelengthScaled);
attenuateBlue = exp(-scatter.y * invWavelengthScaled);
frontColor += attenuate * depth.x;
frontColorBlue += attenuateBlue * depth.y;
samplePoint += sampleRay;
}
float LdotR = clamp(dot(lightingMainDirection, -worldSpaceRay ),-0.9999999,1.0);
float LdotRSq = LdotR * LdotR + 1.0;`),e.haze?t.fragment.code.add(us`vec3 colorCoefficients = (scaledLength * 0.75 * LdotRSq) * (krESun * invWavelength + kmESun );
vec3 color = colorCoefficients * frontColor;
vec3 colorBlue = colorCoefficients * frontColorBlue;`):t.fragment.code.add(us`vec3 rayleighCoefficients = (scaledLength * 0.75 * LdotRSq * krESun) * invWavelength;
float mieCoefficients = scaledLength * kmESun * miePhaseCoefficients * LdotRSq / pow(1.0 + gSq - 2.0 * g * LdotR, 1.5);
vec3 color = rayleighCoefficients * frontColor + mieCoefficients * frontColor;
vec3 colorBlue = rayleighCoefficients * frontColorBlue + mieCoefficients * frontColorBlue;`),t.fragment.code.add(us`vec3 ldrBlue = expTM(colorBlue, 2.0 * exposure);
vec3 ldrRed = expTM(color, exposure);
vec3 LDR = mix(ldrBlue, ldrRed, 0.2);`),e.haze?t.fragment.code.add(us`LDR *= (1.0 - cameraAngle);
vec3 hsv = rgb2hsv(LDR);
hsv.y = clamp(hsv.y * 1.5, 0.0, 1.0);
LDR = hsv2rgb(hsv);
vec3 finalColor = LDR;`):t.fragment.code.add(us`vec3 ldrReinhard = reinhardTM(color, exposure);
LDR += angleMultiplier * ldrReinhard;
float side = (rayEnd + rayStart) * 0.5;
float atmoHeight = sqrt(cameraHeightSq - side * side);
float h2 = clamp(1.0 - ( atmoHeight - lowerAlphaBlendBound ) / ( outerRadius - lowerAlphaBlendBound ), 0.0, 1.0);
vec3 finalColor = LDR * h2;
vec3 hsv = rgb2hsv(finalColor);
hsv.y = clamp(hsv.y * 1.5, 0.0, 1.0);
finalColor = hsv2rgb(hsv);`),t.fragment.code.add(us`
    ${e.haze?"gl_FragColor = vec4(finalColor, 1.0) * altitudeAlpha;":"float atmosStrength = clamp((length(ldrRed) - 0.05) * 1.05, 0.0, 1.0);\n          gl_FragColor = vec4(finalColor, atmosStrength * clamp(1.0 - ( atmoHeight - innerRadius ) / (outerRadius - innerRadius), 0.0, 1.0));\n          if (surfaceBlend > 0.0) {\n            gl_FragColor = mix(gl_FragColor, surfaceColor, surfaceBlend);\n          }"}
      } else { // Outside Atmosphere
        gl_FragColor = vec4(0.0);
      }
    }
  `),t}});class iu extends vs{initializeProgram(e){const t=iu.shader.get(),i=this.configuration,r=t.build({haze:i.haze});return new _s(e.rctx,r,ys)}initializePipeline(){return this.configuration.haze?Ea({blending:La(1,0,769,1),colorWrite:Va}):Ea({blending:La(770,1,771,771),depthTest:{func:515},colorWrite:Va})}}iu.shader=new gs(tu,(()=>Promise.resolve().then((function(){return tu}))));class ru extends fs{constructor(){super(...arguments),this.haze=!1}}e([ms()],ru.prototype,"haze",void 0);class su{constructor(e){this._view=e,this.canRender=!0,this._skyslot=15,this._hazeSlot=16,this._renderData={texDepth:Nr(),cameraPosition:fe(),projectionInverse:Ar(),viewInverse:Ar(),heightParameters:nr(),atmosphereParameters1:nr(),atmosphereParameters2:nr(),atmosphereParameters3:fe(),invWavelength:ou,invWavelengthScaled:lu,radii:Nr(),scale:0,scaleDepth:hu,lowerAlphaBlendBound:0,scaleOverScaleDepth:0,oneOverScaleDepth:0,scaleDepthBlue:cu,oneOverScaleDepthBlue:uu,scaleOverScaleDepthBlue:0,g:pu,g2:pu*pu,miePhaseCoefficients:mu,nearFar:Nr(),cameraHeight:0,cameraHeightSq:0,C:0,CSur:0,innerFadeDistance:0,altitudeFade:0},this._lowerElevationBoundRadius=0,this._lowerBoundEarthRadius=Pi.radius,this._updateRadius(Pi.radius)}destroy(){this._handles&&(this._handles.destroy(),this._handles=null),this._vao&&(this._vao.dispose(),this._vao=null)}when(){return Promise.resolve()}initializeRenderContext(e){const t=e.renderContext.rctx;this._handles=new ar,C(this._view.basemapTerrain.rootTiles)&&this._updateElevation({spatialReference:this._view.basemapTerrain.spatialReference,tile:this._view.basemapTerrain.rootTiles[0],extent:this._view.basemapTerrain.rootTiles[0].extent,context:"ground"}),this._handles.add(Z(this._view,"basemapTerrain","elevation-change",(e=>this._updateElevation(e)),(()=>this._updateElevation()))),this._handles.add(Z(this._view,"basemapTerrain","elevation-bounds-change",(()=>this._updateVisibleElevationBounds()),(()=>this._updateVisibleElevationBounds())));const i=new ru;i.haze=!1,this._atmosphereTechnique=e.shaderTechniqueRep.acquire(iu,i),i.haze=!0,this._atmosphereHazeTechnique=e.shaderTechniqueRep.acquire(iu,i),this._vao=this._createVertexArrayObject(t)}uninitializeRenderContext(){this.destroy()}render(e){return(e.slot===this._hazeSlot||e.slot===this._skyslot)&&0===e.pass&&(this._update(e.camera),e.slot===this._skyslot&&this._renderSky(e),e.slot===this._hazeSlot&&this._renderHaze(e),!0)}_renderSky(e){const t=e.rctx,i=this._atmosphereTechnique.program;t.useProgram(i),this._atmosphereTechnique.bindPipelineState(t),i.setUniform3fv("atmosphereParameters3",this._renderData.atmosphereParameters3),this._renderCommon(i,e)}_renderHaze(e){const t=e.rctx,i=e.offscreenRenderingHelper,r=this._atmosphereHazeTechnique.program;t.useProgram(r),this._atmosphereHazeTechnique.bindPipelineState(t),i.renderDepthDetached((()=>{const t=i.depthTexture;r.bindTexture(t,"depthTex"),this._renderCommon(r,e)}))}_renderCommon(e,t){const i=t.rctx;e.setUniform3fv("invWavelength",this._renderData.invWavelength),e.setUniform3fv("invWavelengthScaled",this._renderData.invWavelengthScaled),t.scenelightingData.setLightDirectionUniform(e),e.setUniform4fv("heightParameters",this._renderData.heightParameters),e.setUniform3fv("cameraPosition",this._renderData.cameraPosition),e.setUniformMatrix4fv("projectionInverse",this._renderData.projectionInverse),e.setUniformMatrix4fv("viewInverse",this._renderData.viewInverse),e.setUniform2fv("nearFar",this._renderData.nearFar),e.setUniform2fv("radii",this._renderData.radii),e.setUniform4fv("atmosphereParameters1",this._renderData.atmosphereParameters1),e.setUniform4fv("atmosphereParameters2",this._renderData.atmosphereParameters2),e.setUniform1f("innerFadeDistance",this._renderData.innerFadeDistance),e.setUniform1f("altitudeFade",this._renderData.altitudeFade),i.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),i.drawArrays(5,0,4)}_createVertexArrayObject(e){const t=gu.createBuffer(4);return t.position.setVec(0,[-1,-1]),t.position.setVec(1,[1,-1]),t.position.setVec(2,[-1,1]),t.position.setVec(3,[1,1]),t.uv0.setVec(0,[0,0]),t.uv0.setVec(1,[1,0]),t.uv0.setVec(2,[0,1]),t.uv0.setVec(3,[1,1]),new qa(e,ys,{geometry:Mn(gu)},{geometry:Ha.createVertex(e,35044,t.buffer)})}_adjustRadiusForTesselation(e){const t=Math.PI/16/16;return e*Math.cos(t)}_updateElevation(e){const t=e?e.tile:D(this._view.basemapTerrain.rootTiles,[null])[0];if(M(t)||0!==t.lij[0])return;const i=this._adjustRadiusForTesselation(Pi.radius+t.elevationBounds[0]);i!==this._lowerElevationBoundRadius&&(this._lowerElevationBoundRadius=i,this._lowerBoundEarthRadius=-1,this._updateVisibleElevationBounds())}_updateVisibleElevationBounds(){const e=this._adjustRadiusForTesselation(Pi.radius+this._view.basemapTerrain.elevationBounds.min);(this._lowerBoundEarthRadius<0||e<this._lowerBoundEarthRadius)&&this._updateRadius(e)}_updateRadius(e){this._lowerBoundEarthRadius=e;const t=e,i=t/10*10.25,r=1/(i-t),s=r/hu,a=r/cu,n=.3*(i-t)+t,o=this._renderData;Re(o.atmosphereParameters1,r,hu,s,du),Re(o.atmosphereParameters2,pu,cu,a,uu),ve(o.atmosphereParameters3,pu*pu,mu,n),Ir(o.radii,t,i),o.scale=r,o.lowerAlphaBlendBound=n,o.scaleOverScaleDepth=s,o.scaleOverScaleDepthBlue=a;o.innerFadeDistance=2*Math.sqrt(1e4*(2*t-1e4))}_update(e){e&&(this._renderData.cameraHeight=_e(e.eye),this._renderData.cameraHeightSq=this._renderData.cameraHeight*this._renderData.cameraHeight,this._renderData.C=this._renderData.cameraHeightSq-this._renderData.radii[1]*this._renderData.radii[1],this._renderData.CSur=this._renderData.cameraHeightSq-this._renderData.radii[0]*this._renderData.radii[0],this._renderData.heightParameters=or(this._renderData.cameraHeight,this._renderData.cameraHeightSq,this._renderData.C,this._renderData.CSur),ye(this._renderData.cameraPosition,e.eye),_r(this._renderData.projectionInverse,e.projectionMatrix),_r(this._renderData.viewInverse,e.viewMatrix),Ir(this._renderData.nearFar,e.near,e.far),this._renderData.altitudeFade=yd(this._renderData.cameraHeight-this._lowerBoundEarthRadius))}static isSupported(e){return e.renderContext.rctx.capabilities.depthTexture}}const au=.02*Math.PI,nu=.004*Math.PI,ou=ge(1/.65**4,1/.57**4,1/.475**4),lu=Se(ou);Ce(lu,lu,au),Pe(lu,lu,ge(nu,nu,nu));const hu=.25,cu=.05,du=1/hu,uu=1/cu,pu=-.99999,mu=(1-pu*pu)/(2+pu*pu)*1.5,gu=Dn().vec2f("position").vec2f("uv0");const fu=U.getLogger("esri.views.3d.environment.SimpleAtmosphere"),vu=Di([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]);class _u{constructor(e){this.view=e,this.slot=15,this._renderData={texV:Nr(),silCircleCenter:fe(),silCircleV1:fe(),silCircleV2:fe(),altitudeFade:0,innerScale:0,undergroundFadeAlpha:0},this._fadeVaoCount=0,this._readyResolver=l(),this._readyController=h(),this.texV1=1,this.isOnMars=ur(e.spatialReference);const t=wt(e.spatialReference);this.planetRadius=t.radius,this.outerRimWidth=t.outerAtmosphereRimWidth,this.innerRimFactor=(this.planetRadius+-1e4)/this.planetRadius,this.middleRimFactor=(this.planetRadius+0)/this.planetRadius,this.outerRimFactor=(this.planetRadius+this.outerRimWidth)/this.planetRadius,this.texV0=0/this.outerRimWidth,this.texVScale=this.texV1-this.texV0}get canRender(){return null!=this._texture}when(){return this._readyResolver.promise}initializeRenderContext(e){const t=e.renderContext.rctx;this._cameraChangeHandle=Y(this.view,"state.camera",(()=>e.requestRender()),!0);const i=new Yd;i.geometry=0,this._atmosphereConeTechnique=e.shaderTechniqueRep.acquire(Zd,i),i.geometry=2,this._atmosphereUndergroundTechnique=e.shaderTechniqueRep.acquire(Zd,i),this._vao=this._createRibbon(t),this._vaoCount=Ua(this._vao,"geometry"),this._fadeVao=xs(t),this._fadeVaoCount=Ua(this._fadeVao,"geometry"),Rn(this.isOnMars?"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAIACAYAAAE00TaTAAAACXBIWXMAAA7AAAAOwAFq1okJAAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAAp1JREFUSMd9lcmSEzEQRCtflnqxYZgIThBDAP//kXDQ0pJtuDhqycxWZ5fKERFCERARIAVEyCjCtSFFEjWVa9q7OdJE0oiidIhKhRBROlhloiGVhaYERQHJWFEwMpYKrjUlibI2cqSJIJEpKNmM2c3GkRTOJDnThTMpnMWu0VFszs3Jfbe5bza3w+a229yOIs6zmP3czfn1K2w/for8+EVU15pNmmyqkeJyclinXNJRu1xrUaJmjmdzJiejVNt7zZVBRAIq1RwrsrrWnez+SR7WmQQP/1itKz2q/pmzuJtYnNy2bth9x9z2NLfDcB7FHOcGx6ebOb9/iPzxG/ztg4iorglFiKjzF9HSNphCoRb1OY3RZQJrYgRdT68bmgXGDdBzrTG8qNS7QP/m19ef7tGlcoH7vESYkK70uoPuOLEetz0IqeGoWQW6MlB/j36EnipYGKPWwDRg/RkNhXCNJIzAhMk6PrDePJNII6JHqM5VWqYApCtNFPe0GFFGtOWopWCrEVBSoiQi06KkRRaD08IlxXa/ifz8Jvz2LvjyLnh7F/r8Rei8a8xfjNkIrpmMOQ1C02COrkTEHxGhh+6DQJfXc/eZprXxcIyVIf1LJVgWvKaHvwI/1aQxtv851SQ/nqGXL6MHFVY3nmhLyqKsWO/+qzWif+yS1TpNKq8NezjGPCV69ciZoQj1PwfN6QRpWyCGVMe1D/AAHt3/gefu1Ign3AVpjOiNXkN90JlpL6TUnzFEUU+Jvks0tkp/dY3Fy1TzI24BWwsYJPyg11Q0FqDwK72xIz2kLojbeuxS1FpgtfNWyMX1gFw0j3W7RNeSHTVEe3VaV7SdCzVywFaEt02w7QH7Eeg4AvZDNdJ+Cu1HENsutO+Byi6ilEBZ9BeCNBJceJIjHgAAAABJRU5ErkJggg==":Xd,{signal:this._readyController.signal}).then((i=>{this._texture=new Pn(t,{pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0},i),e.requestRender(),this._readyController=null,this._readyResolver.resolve()})).catch((e=>{c(e)||fu.error("Unable to initialize simple atmosphere: image request failed",e),this._readyResolver.reject()}))}uninitializeRenderContext(){this.destroy()}destroy(){this._readyResolver.reject(),this._cameraChangeHandle&&(this._cameraChangeHandle.remove(),this._cameraChangeHandle=null),this._texture&&(this._texture.dispose(),this._texture=null),this._fadeVao&&(this._fadeVao.dispose(),this._fadeVao=null),this._vao&&(this._vao.dispose(),this._vao=null),this._readyController&&(this._readyController.abort(),this._readyController=null)}render(e){if(e.slot!==this.slot||0!==e.pass)return!1;this._update(e.camera);const t=e.rctx;if(this._atmosphereConeTechnique.bindPipelineState(t),this._renderData.undergroundFadeAlpha<1){const i=this._atmosphereConeTechnique.program;t.useProgram(i),i.setUniformMatrix4fv("proj",e.camera.projectionMatrix),i.setUniformMatrix4fv("view",e.camera.viewMatrix),i.setUniform3fv("silCircleCenter",this._renderData.silCircleCenter),i.setUniform3fv("silCircleV1",this._renderData.silCircleV1),i.setUniform3fv("silCircleV2",this._renderData.silCircleV2),i.setUniform2fv("texV",this._renderData.texV),i.bindTexture(this._texture,"tex"),e.scenelightingData.setLightDirectionUniform(i),i.setUniform1f("altitudeFade",this._renderData.altitudeFade),i.setUniform1f("innerScale",this._renderData.innerScale),t.bindVAO(this._vao),t.drawArrays(4,0,this._vaoCount)}if(this._renderData.undergroundFadeAlpha>0){const i=this._atmosphereUndergroundTechnique.program;t.useProgram(i),i.setUniform1f("undergroundFadeAlpha",this._renderData.undergroundFadeAlpha),e.scenelightingData.setLightDirectionUniform(i),i.setUniform3fv("cameraPosition",e.camera.eye),t.bindVAO(this._fadeVao),t.drawArrays(5,0,this._fadeVaoCount)}return!0}_update(e){const t=fe(),i=this.planetRadius,r=_e(e.eye),s=r-i;if(s<0){const e=Math.min(-s/5e3,1);this._renderData.undergroundFadeAlpha=e}else this._renderData.undergroundFadeAlpha=0;const a=Math.max(50,s),n=i+-1e4;this._renderData.innerScale=function(e,t,i){const r=Math.sqrt(e*e-t*t),s=Math.sqrt(e*e-i*i);return e*e/(r*s+t*i)}(i+a,i,n)-1,this._renderData.altitudeFade=yd(s),Ce(t,e.eye,(i+50)/r),yu(t,e.center,e.up,i,this._renderData);const o=this._computeScreenRimWidth(e,t,e.up,this._renderData),l=1-511/512,h=vu(s);let c=this.texV0+l*this.texVScale,d=this.texV0+o*h*this.texVScale;if(s>50){yu(e.eye,e.center,e.up,i,this._renderData);const t=this._computeScreenRimWidth(e,e.eye,e.up,this._renderData),r=ue((t-1.5)/(o-1.5),0,1);c=this.texV0+r*l*this.texVScale,d=this.texV0+Me(this.texV1,o*h,r)*this.texVScale}Ir(this._renderData.texV,c,d)}_createRibbon(e){const t=new Float32Array(1155),i=new Uint32Array(1920);t[0]=0,t[1]=0,t[2]=-1;for(let e=0;e<128;e++){const r=9*e+3;t[r+0]=e,t[r+1]=this.innerRimFactor,t[r+2]=-1,t[r+3]=e,t[r+4]=this.middleRimFactor,t[r+5]=0,t[r+6]=e,t[r+7]=this.outerRimFactor,t[r+8]=1;const s=3*e+1,a=127===e?1:s+3,n=15*e;i[n+0]=s,i[n+1]=s+1,i[n+2]=a+1,i[n+3]=a+1,i[n+4]=a,i[n+5]=s,i[n+6]=s+1,i[n+7]=s+2,i[n+8]=a+2,i[n+9]=a+2,i[n+10]=a+1,i[n+11]=s+1,i[n+12]=s,i[n+13]=a,i[n+14]=0}const r=Cu.createBuffer(i.length),s=r.position;for(let e=0;e<i.length;++e){const r=3*i[e];s.set(e,0,t[r]),s.set(e,1,t[r+1]),s.set(e,2,t[r+2])}return new qa(e,ys,{geometry:Mn(Cu)},{geometry:Ha.createVertex(e,35044,r.buffer)})}_computeScreenRimWidth(e,t,i,r){return Pe(wu,r.silCircleCenter,r.silCircleV2),Ce(bu,wu,this.outerRimFactor),br(xu,t,wu,i),On(wu,xu,e.projectionMatrix,e.viewport),On(bu,xu,e.projectionMatrix,e.viewport),De(wu,bu)/e.height}}function yu(e,t,i,r,s){const a=_e(e),n=r*Math.sqrt(a*a-r*r)/a,o=Math.sqrt(r*r-n*n),l=s.silCircleV1,h=s.silCircleV2;return Ce(s.silCircleCenter,e,o/a),xe(l,e,t),Ae(l)<1&&xe(l,e,i),Ce(l,l,n/_e(l)),xe(h,l,e),Ce(h,h,n/_e(h)),n}const xu=Ar(),wu=fe(),bu=fe();const Cu=Dn().vec3f("position");var Tu=Object.freeze({__proto__:null,build:function(){const e=new ds;return e.attributes.add("position","vec3"),e.attributes.add("color","vec4"),e.attributes.add("size","float"),e.varyings.add("vcolor","vec4"),e.varyings.add("vsize","float"),e.vertex.uniforms.add("transform","mat4").add("viewport","vec4").add("pixelRatio","float"),e.include(qn),e.vertex.code.add(us`void main(void) {
vec4 posProj = transform * vec4(position, 0);
gl_Position = alignToPixelCenter(posProj, viewport.zw);
vcolor = color / 1.2;
vsize = size * 5.0 * pixelRatio;
gl_PointSize = vsize;
}`),e.fragment.code.add(us`void main() {
float cap = 0.7;
float scale = 1.0 / cap;
float helper = clamp(length(abs(gl_PointCoord - vec2(0.5))), 0.0, cap);
float alpha = clamp((cap - helper) * scale, 0.0, 1.0);
float intensity = alpha * alpha * alpha;
if (vsize < 3.0) {
intensity *= 0.5;
}
gl_FragColor = vec4(vcolor.xyz, intensity);
}`),e}});class Su extends vs{initializeProgram(e){const t=Su.shader.get().build();return new _s(e.rctx,t,ys)}initializePipeline(){return Ea({blending:La(770,1,771,771),depthTest:{func:515},colorWrite:Va})}bindPass(e){const t=this.makeInfiniteProjectionMatrix(e.camera.projectionMatrix,e.camera.near,Pu);Cr(t,t,e.camera.viewMatrix),Cr(t,t,e.modelMatrix),this.program.setUniformMatrix4fv("transform",t),this.program.setUniform4fv("viewport",e.camera.fullViewport),this.program.setUniform1f("pixelRatio",e.camera.pixelRatio)}makeInfiniteProjectionMatrix(e,t,i){const r=24e-8;return wr(i,e),i[10]=r-1,i[11]=-1,i[14]=(r-2)*t,i}}Su.shader=new gs(Tu,(()=>Promise.resolve().then((function(){return Tu}))));const Pu=Ar(),Ru=U.getLogger("esri.views.3d.environment.Stars");let Mu=class extends yi{constructor(e){super(e),this._loadDataTask=null,this._numPoints=0,this._renderParameter={camera:null,modelMatrix:Ar()},this._updatingTracking=new Bn}get updating(){return this._updatingTracking.updating||this.loading}get loading(){return C(this._loadDataTask)&&!this._loadDataTask.finished}get canRender(){return!this.loading}initialize(){this._loadDataTask=this._createLoadDataTask()}destroy(){this._loadDataTask=A(this._loadDataTask),this._updatingTracking.destroy(),this._numPoints=0,this._technique=P(this._technique),this._vao=P(this._vao)}render(e,t){if(this._ensureResources(e),M(this._technique)||M(this._vao))return!0;const i=this._technique.program;return e.useProgram(i),this._renderParameter.camera=t,this._technique.bindPass(this._renderParameter),this._technique.bindPipelineState(e),e.bindVAO(this._vao),i.assertCompatibleVertexAttributeLocations(this._vao),e.drawArrays(0,0,this._numPoints),!0}_ensureResources(e){if(C(this._technique)||M(zu))return;this._technique=new Su({rctx:e,viewingMode:this.view.state.viewingMode},null),this._numPoints=zu.byteLength/Fu;const t=new Float32Array(zu,0,2*this._numPoints),i=new Uint8Array(zu,2*this._numPoints*4,this._numPoints);this._vao=this._createVertexArrayObject(e,t,i,this._numPoints),this._updatingTracking.add(this.view,"environment.lighting.date",(e=>this._update(e)),2)}_computeDayDuration(e){const t=e,i=new Date(e.getFullYear(),0,1,11,58,56);return(+t-+i)/(+new Date(e.getFullYear()+1,0,1,11,58,55)-+i)}_update(e){if(!e)return;const t=(e.getHours()/12+e.getMinutes()/60*(2/24)+e.getSeconds()/60*(2/1440)-.9972222)%2,i=2*this._computeDayDuration(e),r=this._renderParameter.modelMatrix;wr(r,Ou),Tr(r,r,-i*Math.PI),Cr(r,Au,r),Tr(r,r,-t*Math.PI),this.requestRender()}_hexToRGB(e){return[parseInt(e.substring(0,2),16),parseInt(e.substring(2,4),16),parseInt(e.substring(4,6),16)]}_unpackUint8Attributes(e){return e>=192?[2.9,e-192]:e>=160?[2.5,e-160]:e>=128?[2,e-128]:e>=96?[1.5,e-96]:e>=64?[1,e-64]:e>=32?[.7,e-32]:[.4,e]}_createVertexArrayObject(e,t,i,r){const s=Iu.createBuffer(r),a=s.position,n=s.color,o=s.size;for(let e=0;e<r;e++){const r=t[2*e+0],s=t[2*e+1];a.set(e,0,-Math.cos(r)*Math.sin(s)),a.set(e,1,-Math.sin(r)*Math.sin(s)),a.set(e,2,-Math.cos(s));const l=this._unpackUint8Attributes(i[e]),h=this._hexToRGB(Du[l[1]]);n.set(e,0,255*h[0]),n.set(e,1,255*h[1]),n.set(e,2,255*h[2]),n.set(e,3,255),o.set(e,l[0])}return new qa(e,ys,{geometry:Mn(Iu)},{geometry:Ha.createVertex(e,35044,s.buffer)})}_createLoadDataTask(){if(C(zu))return null;const e=d((async e=>{const{data:t}=await jn("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:e});this._verifyStarData(t),zu=t}));return e.promise.catch((e=>{c(e)||Ru.error(e)})).then((()=>{this.destroyed||(this.requestRender(),this.notifyChange("updating"))})),e}_verifyStarData(e){if(!e)throw new o("stars:no-data-received","Failed to create stars because star catalogue is missing");const t=e.byteLength/Fu;if(t%1!=0||t>5e4||t<5e3)throw new o("stars:invalid-data","Failed to create stars because star catalogue data is invalid")}};e([le({constructOnly:!0})],Mu.prototype,"view",void 0),e([le({constructOnly:!0})],Mu.prototype,"requestRender",void 0),e([le({readOnly:!0})],Mu.prototype,"updating",null),e([le()],Mu.prototype,"_loadDataTask",void 0),e([le()],Mu.prototype,"_updatingTracking",void 0),Mu=e([ce("esri.views.3d.environment.Stars")],Mu);const Du=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],Au=Or(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),Ou=Or(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),Fu=9,Iu=Dn().vec3f("position").vec4u8("color").f32("size");let zu=null;const Eu=[14,15,16];let Lu=class extends yi{constructor(){super(...arguments),this._handles=new ar,this._context=null,this._chapmanQuality="high",this._enableNewAtmosphere=fr(),this._pendingAtmosphere=null,this._atmosphere=null,this._stars=null,this._clouds=null,this._cloudComposition=null,this._cloudsEnabled=!!O("enable-feature:enable-clouds")}get canRender(){return!(!this.view.basemapTerrain||!this.view.basemapTerrain.renderer.canRender)||"global"!==this.view.viewingMode}get updating(){return C(this._pendingAtmosphere)||C(this._stars)&&this._stars.updating}set cloudsEnabled(e){this._cloudsEnabled=e,this._setNeedsRender()}renderCubeMap(){C(this._clouds)&&(this._clouds.resetRenderFlags(),this._context.requestRender())}initialize(){this.view._stage.addRenderPlugin(Eu,this)}destroy(){this._pendingAtmosphere=R(this._pendingAtmosphere),this._atmosphere=R(this._atmosphere),this._stars=R(this._stars),this._handles=R(this._handles),this._clouds=R(this._clouds),this._cloudComposition=R(this._cloudComposition),this.view&&null!=this.view._stage&&(this.view._stage.removeRenderPlugin(this),this._set("view",null))}initializeRenderContext(e){this._context=e,this.setup()}setup(){this._handles.add(X(this.view,"basemapTerrain",(()=>this._updateBasemapTerrain()),!0)),this._handles.add([Y(this.view,["viewingMode","environment.atmosphereEnabled","environment.atmosphere.quality"],(()=>this._updateAtmosphere()),!0),xi((()=>this._updateStars())),xi((()=>{if(this.evaluateCloudsEnabled(),this.ensureClouds(this._context.renderContext.rctx),C(this._clouds)){var e,t;const i=null==(e=this.view)||null==(t=e.environment)?void 0:t.clouds;this._clouds.coverage=null==i?void 0:i.coverage,this._clouds.absorption=null==i?void 0:i.absorption,this._clouds.cloudHeight=null==i?void 0:i.cloudHeight,this._clouds.cloudSize=null==i?void 0:i.cloudSize,this._clouds.density=null==i?void 0:i.density,this._clouds.detailSize=null==i?void 0:i.detailSize,this._clouds.smoothness=null==i?void 0:i.smoothness}}))])}evaluateCloudsEnabled(){var e,t,i,r;this.cloudsEnabled=(null!=(e=null!==(null==(t=this.view)||null==(i=t.environment)?void 0:i.clouds))?e:!!O("enable-feature:enable-clouds"))&&pr(null==(r=this.view)?void 0:r.spatialReference)}uninitializeRenderContext(){C(this._stars)&&(this._stars.destroy(),this._stars=null),C(this._atmosphere)&&(this._atmosphere.uninitializeRenderContext(),this._atmosphere.destroy(),this._atmosphere=null),this._clouds=R(this._clouds),this._cloudComposition=R(this._cloudComposition)}render(e){let t=!0;const i=this._context.renderContext.rctx;if(C(this._stars)&&this._stars.canRender&&15===e.slot&&0===e.pass&&(t=this._stars.render(e.rctx,e.camera)&&t),this._cloudsEnabled&&14===e.slot&&0===e.pass&&(this.ensureClouds(i),C(this._clouds))){const r=e.rctx.getViewport();t=this._clouds.render(i)&&t,e.rctx.setViewport(r.x,r.y,r.width,r.height)}return C(this._atmosphere)&&this._atmosphere.canRender&&(t=this._atmosphere.render(e)&&t),this._cloudsEnabled&&C(this._clouds)&&C(this._cloudComposition)&&15===e.slot&&0===e.pass&&(t=this._cloudComposition.render(e,this._clouds._frameBufferCube)&&t,this._cloudComposition.isFading()&&this._setNeedsRender()),t}ensureClouds(e){if(!(this._cloudsEnabled&&C(this._clouds)&&C(this._cloudComposition))){if(this._cloudsEnabled&&M(this._clouds)&&M(this._cloudComposition)){this._clouds=new Wd(e,this.view);const t=wt(this.view.spatialReference).radius;this._cloudComposition=new Ld(this._context.renderContext.rctx,this.view.state.viewingMode,t)}this._cloudsEnabled||!C(this._clouds)&&!C(this._cloudComposition)||(this._clouds=R(this._clouds),this._cloudComposition=R(this._cloudComposition))}}_setNeedsRender(){this._context&&this._context.requestRender()}_updateStars(){var e,t,i;const r=null!=(e=null==(t=this.view)||null==(i=t.environment)?void 0:i.starsEnabled)&&e;r&&M(this._stars)?(this._stars=new Mu({view:this.view,requestRender:()=>this._context.requestRender}),this._setNeedsRender()):!r&&C(this._stars)&&(this._stars.destroy(),this._stars=null,this._setNeedsRender())}_updateAtmosphere(){const e=this._getAtmosphereType();if(this.atmosphereType===e)return;this.atmosphereType=e,C(this._pendingAtmosphere)&&(this._pendingAtmosphere!==this._atmosphere&&this._pendingAtmosphere.destroy(),this._pendingAtmosphere=null);const t=this._getAtmosphereClass();if(!t)return C(this._atmosphere)&&(this._atmosphere.destroy(),this._atmosphere=null,this._setNeedsRender()),void this._updateBasemapTerrain();const i=new t(this.view);i instanceof Sd&&i.setSimplified("medium"===this._getAtmosphereType()),i.initializeRenderContext(this._context),M(this._atmosphere)&&(this._atmosphere=i,this._setNeedsRender()),this._pendingAtmosphere=i,i.when().then((()=>{C(this._atmosphere)&&this._pendingAtmosphere!==this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=this._pendingAtmosphere),this._pendingAtmosphere=null,this._setNeedsRender(),this._updateBasemapTerrain()})).catch((()=>{this._pendingAtmosphere===i&&(this._pendingAtmosphere=null)}))}_getAtmosphereClass(){const e=this._getAtmosphereType();if(this.atmosphereClassFromType)return this.atmosphereClassFromType(e);switch(e){case"none":return null;case"chapman":case"medium":return Sd;case"realistic":return su;case"panoramic":return Jd;case"simple":return _u;default:return}}_getAtmosphereType(){const e=this.view.get("environment.atmosphereEnabled"),t=this.view.get("environment.atmosphere.quality"),i=this.view.viewingMode;return!e||null==t||mr(this.view.spatialReference)?"none":"local"===i?"panoramic":this._enableNewAtmosphere&&Sd.isSupported(this._context)&&!ur(this.view.spatialReference)?"medium"===this._chapmanQuality?"medium":"chapman":"high"===t&&su.isSupported(this._context)&&!ur(this.view.spatialReference)?"realistic":"simple"}_updateBasemapTerrain(){const e=this.view.basemapTerrain;e&&(e.velvetOverground=null!=this._atmosphere&&"simple"===this.atmosphereType)}get test(){return{atmosphere:this._atmosphere,clouds:this._clouds,enableNewAtmosphere:e=>{this._enableNewAtmosphere=e},setNewAtmosphereQuality:e=>{this._chapmanQuality=e},updateAtmosphere:()=>{this._updateAtmosphere()}}}};e([le({constructOnly:!0})],Lu.prototype,"view",void 0),e([le({constructOnly:!0})],Lu.prototype,"atmosphereClassFromType",void 0),e([le({type:Boolean,readOnly:!0})],Lu.prototype,"updating",null),e([le()],Lu.prototype,"_pendingAtmosphere",void 0),e([le()],Lu.prototype,"_stars",void 0),Lu=e([ce("esri.views.3d.environment.EnvironmentRenderer")],Lu);let Vu=class extends tr.EventedAccessor{constructor(){super(),this._referencePointUpdateDelay=200,this._referencePointUpdateInterval=3e3,this._referencePointUpdateDistThreshold=1e6,this._referencePosUpdateQuery=null,this._referencePosMapCoordsRequested=null,this._viewHandles=new ar,this._preserveAbsoluteDateTime=!1,this._trackingEnabled=!1,this._referencePosResetPreserveAbsoluteTime=!1,this._referencePosUpdateTimer=null,this._referencePosMapCoords=null,this._mainLight=new da,this._ambientLight=new ua,this._moonLight=new pa,this._renderer=null,this._referencePosWGS84Comparable=null,this._resetReferencePosition()}destroy(){this.disconnectView(),this._viewHandles.destroy()}get _view(){var e;return null==(e=this._renderer)?void 0:e.view}get updating(){return!!(!this.disableQueries&&(this._referencePosUpdateQuery||this._referencePosMapCoordsRequested)||this._renderer&&this._renderer.updating)}get referencePositionWGS84Comparable(){return this._referencePosWGS84Comparable}connectView(e){this._renderer||(this._renderer=new Lu({view:e}),this._viewHandles.add([e.watch("environment.lighting.date",(e=>this._lightingDateHandler(e)),!0),e.watch("stationary",(()=>this._interactingStationaryHandler())),e.watch(["environment.lighting.directShadowsEnabled","environment.lighting.ambientOcclusionEnabled","environment.lighting.waterReflectionEnabled","environment.background.color"],(()=>this._updateRenderParamsHandler()),!0),e.watch("spatialReference",(()=>this._resetReferencePosition(!0)),!0),Y(e,"viewingMode",(()=>this._resetReferencePosition(!0)),!0),Y(e,"environment.lighting.cameraTrackingEnabled",(e=>this._updateCameraTracking(e)),!0),Y(e,"state.camera",(()=>this._cameraHandler(null)),!0),this.watch("disableQueries",(()=>this._cameraHandler(null)))]),this._updateRenderParamsHandler(),this._updateLightParams(),this._cameraHandler(),this.notifyChange("updating"))}disconnectView(){this._viewHandles.removeAll(),this._resetReferencePosition(),this._renderer=R(this._renderer)}_updateCameraTracking(e){if(this._trackingEnabled=e,e)this._cameraHandler();else{const e=this._view.environment.lighting;e&&(e.positionTimezoneInfo.autoUpdated=!1)}}_lightingDateHandler(e){if(!e)return;const t=this._view.environment.lighting;if(!t.positionTimezoneInfo.autoUpdated){this._preserveAbsoluteDateTime=!0;const i=this._view.spatialReference;if(!ct(i)){const e=this._view.camera.position;if(!this._referencePosMapCoords||!this._referencePosMapCoords.equals(e))return void this._requestReferencePositionUpdate(e)}if(this._preupdateTracking(e),C(this._referencePosWGS84Comparable)){const e=Nn(this._referencePosWGS84Comparable,qu);C(e)&&(t.autoUpdate(null,e),this._trackingEnabled&&(t.positionTimezoneInfo.autoUpdated=!0))}}this._updateLightParams(e)}_preupdateTracking(e){!this._trackingEnabled&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(e)}_cameraHandler(e=null){if(!this._view.ready)return;const t=this._view.camera;t&&(this._cameraHandlerClientSide(t,e)||this._cameraHandlerServerSide(t))}_cameraHandlerClientSide(e,t){const i=pr(this._view.spatialReference);if(i&&!ct(this._view.spatialReference))return!1;const r=e.position;return M(this._referencePosWGS84Comparable)&&(this._referencePosWGS84Comparable=fe()),i?dt(r,this._referencePosWGS84Comparable):ve(this._referencePosWGS84Comparable,r.longitude,r.latitude,r.z),this.notifyChange("referencePositionWGS84Comparable"),this._autoUpdateTimezone(this._referencePosWGS84Comparable,t)||this._updateLightParams(t),!0}_cameraHandlerServerSide(e){const t=e.position;(!this._referencePosMapCoords||this._referencePosMapCoordsRequested||this._exceedsReferencePosDistThreshold(t))&&this._requestReferencePositionUpdate(t,!0),this._view.mapCoordsHelper&&this._referencePosWGS84Comparable&&(this._referencePosWGS84Comparable[2]=t.z*this._view.mapCoordsHelper.unitInMeters,this._referencePosChanged())}_interactingStationaryHandler(){this._view.stationary&&this._executePendingReferencePositionUpdate()}_updateLightParams(e){const t=this._view.environment.lighting;e=e||t.date;const i=this._view._stage,r=C(this._referencePosWGS84Comparable)?ku:ju;C(this._referencePosWGS84Comparable)&&Gn(e,this._referencePosWGS84Comparable,this._view.state.viewingMode,ku),Ce(this._mainLight.intensity,r.diffuse.color,r.diffuse.intensity*Math.PI),ye(this._mainLight.direction,r.diffuse.directionToLightSource),Ce(this._ambientLight.intensity,r.ambient.color,r.ambient.intensity),Oe(this._moonLight.intensity,Hu,Bu,r.globalFactor);const s=(1-.5*r.globalFactor)*(1-.4*r.noonFactor*(1-r.globalFactor));Ce(this._moonLight.intensity,this._moonLight.intensity,s),ye(this._moonLight.direction,r.diffuse.directionToLightSource),i.renderView.updateLightSources([this._mainLight,this._ambientLight,this._moonLight],1-r.noonFactor,r.globalFactor),this._updateRenderParamsHandler()}_autoUpdateTimezone(e,t=null){if(!this._view.environment.lighting.cameraTrackingEnabled||M(e))return!1;const i=Uu;i.setTime((t||this._view.environment.lighting.date).getTime());const r=Nn(e,qu);if(M(r))return!1;let s=this._view.environment.lighting.positionTimezoneInfo;if(s.autoUpdated){if(s.hours===r.hours&&s.minutes===r.minutes&&s.seconds===r.seconds)return!1}else s=r;const a=i.getUTCHours()-(r.hours-s.hours),n=i.getUTCMinutes()-(r.minutes-s.minutes),o=i.getUTCSeconds()-(r.seconds-s.seconds);return i.setUTCHours(a),i.setUTCMinutes(n),i.setUTCSeconds(o),!t&&this._view.environment.lighting.autoUpdate(i,r)}_updateRenderParamsHandler(){const e=this._view._stage;if(!e)return;const t=F(this._referencePosWGS84Comparable,!0,(e=>Qn(e[2],this._view.state.viewingMode))),i=this._view.environment.background,r=i instanceof Zn?{type:"color",color:lr(sr.toUnitRGBA(i.color))}:{type:"color",color:or(0,0,0,1)};e.renderView.setRenderParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&t,ssao:this._view.environment.lighting.ambientOcclusionEnabled,waterReflectionEnabled:this._view.environment.lighting.waterReflectionEnabled,background:r})}_resetReferencePosition(e=!1){this._cancelReferencePosUpdates(),this._referencePosMapCoords=null,this._referencePosMapCoordsRequested=null,this._referencePosResetPreserveAbsoluteTime=null,this._referencePosWGS84Comparable=null,this.notifyChange("updating"),e&&this._cameraHandler(null)}_requestReferencePositionUpdate(e,t=!1){if(!this.disableQueries&&(this._referencePosMapCoordsRequested?this._referencePosMapCoordsRequested.copy(e):this._referencePosMapCoordsRequested=e.clone(),this._referencePosResetPreserveAbsoluteTime=!!t,!this._referencePosUpdateQuery&&!this._referencePosUpdateTimer&&this._view.stationary)){const e=this._referencePosUpdateQuery=u(this._referencePointUpdateDelay).then((()=>{if(this._referencePosUpdateQuery===e){const t=()=>this._referencePosUpdateQuery!==e;return this._doReferencePositionUpdateQuery(t)}})).catch((e=>{"mapcoordshelper:missing-geometry-service"===e.name&&(this.disableQueries=!0)})).then((()=>{this._referencePosUpdateQuery===e&&(this._referencePosUpdateQuery=null,this._referencePosUpdateTimer||this._executePendingReferencePositionUpdate(),this.notifyChange("updating"))})),t=this._referencePosUpdateTimer=u(this._referencePointUpdateInterval).then((()=>{this._referencePosUpdateTimer===t&&(this._referencePosUpdateTimer=null,this._referencePosUpdateQuery||this._executePendingReferencePositionUpdate())}));this.notifyChange("updating")}}async _doReferencePositionUpdateQuery(e){this._referencePosResetPreserveAbsoluteTime&&(this._preserveAbsoluteDateTime=!1),this._referencePosMapCoords?this._referencePosMapCoords.copy(this._referencePosMapCoordsRequested):this._referencePosMapCoords=this._referencePosMapCoordsRequested.clone(),this._referencePosResetPreserveAbsoluteTime=null,this._referencePosMapCoordsRequested=null;const t=await this._view.mapCoordsHelper.toGeographic(this._referencePosMapCoords);if(!e()&&!isNaN(t[0])&&!isNaN(t[1])){const e=this._referencePosMapCoords.z*this._view.mapCoordsHelper.unitInMeters;this._referencePosWGS84Comparable?(this._referencePosWGS84Comparable[0]=t[0],this._referencePosWGS84Comparable[1]=t[1],this._referencePosWGS84Comparable[2]=e):this._referencePosWGS84Comparable=[t[0],t[1],e],this._referencePosChanged()}}_executePendingReferencePositionUpdate(){const e=this._referencePosMapCoordsRequested;e&&this._requestReferencePositionUpdate(e,this._referencePosResetPreserveAbsoluteTime)}_referencePosChanged(){this._preserveAbsoluteDateTime?this._updateLightParams():this._autoUpdateTimezone(this._referencePosWGS84Comparable)||this._updateLightParams(),this.notifyChange("referencePositionWGS84Comparable")}_exceedsReferencePosDistThreshold(e){if(this._referencePosMapCoords){let t=this._referencePosMapCoords.distance(e);return this._view.mapCoordsHelper&&(t*=this._view.mapCoordsHelper.unitInMeters),t>this._referencePointUpdateDistThreshold}return!0}_cancelReferencePosUpdates(){const e=!!this._referencePosUpdateQuery;return this._referencePosUpdateQuery=null,this._referencePosUpdateTimer=null,e}get test(){const e=this;return{renderer:this._renderer,set referencePointUpdateInterval(t){e._referencePointUpdateInterval=t},set referencePointUpdateDistThreshold(t){e._referencePointUpdateDistThreshold=t},set referencePosUpdateTimer(t){e._referencePosUpdateTimer=t},set referencePointUpdateDelay(t){e._referencePointUpdateDelay=t}}}};e([le({type:Boolean,readOnly:!0})],Vu.prototype,"updating",null),e([le()],Vu.prototype,"disableQueries",void 0),e([le()],Vu.prototype,"referencePositionWGS84Comparable",null),e([le()],Vu.prototype,"_renderer",void 0),e([le()],Vu.prototype,"_referencePosWGS84Comparable",void 0),Vu=e([ce("esri.views.3d.environment.SceneViewEnvironmentManager")],Vu);const ku=new Wn,ju=new Wn,Uu=new Date,qu={hours:0,minutes:0,seconds:0},Hu=ge(.22,.22,.33),Bu=ge(.22,.22,.22);function Nu(e,t){return 0!=(e&t)}function Gu(e,t,i,r,s,a){0!==e&&(i?(a.min=Math.min(a.min,t),a.max=Math.max(a.max,t)):null!=r?(a.min-=Math.max(0,(t-a.min)*(1-r)),a.max+=Math.max(0,(t-a.max)*(1-r))):s&&(a.min-=Math.max(0,t-a.min-s),a.max+=Math.max(0,t-a.max-s)))}const Wu={selection:0,interactionType:0,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:0};function Qu(e,t,i,r){return t=t||e.viewForward,ye(r,t),Ce(r,r,Fe(Ie(t,i))),r}function Zu(e,t,i=Wu){if(!function(e,t){const i=e.state.constraints.altitude;if(!e.state.isGlobal||!i)return!1;if(2===t.interactionType&&Nu(t.selection,1))return!1;return!0}(e,i))return 0;const r=function(e,t){return t.min=e.min,t.max=e.max,t}(e.state.constraints.altitude,Yu);!function(e,t,i){const r=t.interactionType;if(0===r)return;const{min:s,max:a}=i,{interactionStartCamera:n,interactionFactor:o}=t,l=2===r||1===r,h=Zu(e,n),c=0===h?0:e.renderCoordsHelper.getAltitude(n.eye);i.min=s,i.max=a;Gu(h,c,l,o,.05*c,i)}(e,i,r);const s=e.renderCoordsHelper.getAltitude(t.eye),a=ue(s,r.min,r.max)-s;return Math.abs(a)<=1e-6?0:a}const Yu={min:0,max:0},Xu=fe(),Ku=fe(),Ju=fe(),$u=fe();function ep(e,t,i=Wu){if(!e.state.isLocal)return 0;const r=e.state.constraints.distance;if(!e.pointsOfInterest.surfaceOrigin.renderLocation||r===1/0)return 0;ip.min=0,ip.max=r,function(e,t,i){const r=t.interactionType;if(0===r)return;const{min:s,max:a}=i,{interactionStartCamera:n,interactionFactor:o}=t,l=1===r||4===r,h=ep(e,n),c=0===h?0:tp(e,n);i.min=s,i.max=a;Gu(h,c,l,o,.05*c,i)}(e,i,ip);const s=tp(e,t),a=ip.max-s;return a>=-1e-6?0:a}function tp(e,t){const i=e.pointsOfInterest.surfaceOrigin;return De(t.eye,i.renderLocation)}const ip={min:0,max:0},rp=fe(),sp=fe(),ap=fe(),np=fe(),op=fe();function lp(e,t,i=0){const r=e.state.constraints;if(!r.collision.enabled)return!1;const s=Vi(e,t.eye),a=e.renderCoordsHelper.getAltitude(t.eye),n=s+r.collision.elevationMargin;if(a>=n)return!1;const o=_e(t.eye);if(Te(hp,t.center,t.eye),t.eye=e.renderCoordsHelper.setAltitude(cp,n,t.eye),1===i)t.center=Pe(hp,t.eye,hp);else if(2===i){const e=(o-a+n)/o;t.center=Ce(hp,t.center,e)}return!0}const hp=fe(),cp=fe();function dp(e,t,i){e.worldUpAtPosition(t,up),Te(pp,i,t);const r=_e(pp);return 0===r?0:Ee(Ie(pp,up)/r)}const up=fe(),pp=fe();function mp(e,t,i=Wu,r=Wu,s){if(!e.state.constraints.tilt)return 0;const a=t.distance,n=e.state.constraints.tilt(a,Cp);return function(e,t,i){if(0===t.interactionType)return;const{interactionStartCamera:r,interactionFactor:s}=t,{min:a,max:n}=i,o=mp(e,r,Wu,t),l=0===o?0:dp(e.renderCoordsHelper,r.center,r.eye);i.min=a,i.max=n,2===t.interactionType?(Nu(t.selection,2)&&_p(e,r,i),Gu(o,l,!0,s,bp,i)):Gu(o,l,!1,s,bp,i)}(e,i,n),2===r.interactionType&&Nu(r.selection,2)&&_p(e,r.interactionStartCamera,n),1===i.tiltMode||1===r.tiltMode?function(e,t,i,r){r&&(r.requiresTwoSteps=!1);switch(e.viewingMode){case"global":return function(e,t,i,r){const s=gp(e,t,Tp),a=ue(s.tiltAtCenter,i.min,i.max);if(!fp(s.tiltAtCenter-a))return 0;let n,o;s.centerIsOnSurface?(n=function(e){const{constraints:t,eyeCenterDistance:i,tiltAtCenter:r}=e;let s=r,a=t.clampTilt(i,r);const n=vp(e,a);if(t.clampTilt(n,r)===a)return a;let o=0;for(;o<10&&fp(a-s);){const i=(s+a)/2,r=vp(e,i);fp(t.clampTilt(r,i)-i)?s=i:a=i,o++}return a}(s),o=function(e,t){const i=Ve(e.radius/e.eyeRadius*Math.sin(e.tiltAtCenter)),r=Ve(e.radius/e.eyeRadius*Math.sin(t));if(e.eyeRadius>e.radius)return i-r;return r-i}(s,n)):(n=s.constraints.clampTilt(s.eyeCenterDistance,s.tiltAtCenter),r&&n<Math.PI/2&&(r.requiresTwoSteps=!0,n=Math.PI/2-1e-5),o=function(e,t){const i=e.tiltAtCenter-Math.PI/2,r=t-Math.PI/2;return i-r}(s,n));r&&(r.eyeCenterDistance=vp(s,n));return o}(e,t,i,r);case"local":return function(e,t,i,r){const s=dp(e.renderCoordsHelper,t.center,t.eye),a=ue(s,i.min,i.max),n=s-a;if(!fp(n))return 0;if(r){const i=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,s=e.renderCoordsHelper.getAltitude(t.eye)-i,n=Math.cos(a);Math.abs(n)>1e-4?r.eyeCenterDistance=s/n:r.eyeCenterDistance=t.distance}return n}(e,t,i,r);default:return void ho(e.viewingMode)}}(e,t,n,s):function(e,t,i){const r=dp(e.renderCoordsHelper,t.center,t.eye),s=ue(r,i.min,i.max),a=r-s;if(!fp(a))return 0;return a}(e,t,n)}function gp(e,t,i){const r=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,s=r+wt(e.spatialReference).radius,a=e.renderCoordsHelper.intersectManifold(t.ray,r,wp);return i.eyeCenterDistance=t.distance,i.centerIsOnSurface=!1,C(a)?(i.eyeCenterDistance=De(t.eye,a),i.tiltAtCenter=dp(e.renderCoordsHelper,a,t.eye),i.centerIsOnSurface=!0):e.state.isLocal?i.tiltAtCenter=dp(e.renderCoordsHelper,t.center,t.eye):(Ya(Xa(s),t.ray,wp),i.eyeCenterDistance=De(t.eye,wp),i.tiltAtCenter=Ee(-Ie(t.viewForward,we(wp,wp)))),i.radius=s,i.eyeRadius=_e(t.eye),i.constraints=e.state.constraints,i}function fp(e){return Math.abs(e)>1e-9}function vp(e,t){if(!e.centerIsOnSurface)return e.eyeCenterDistance;const i=Math.PI-ue(t,0,Math.PI),r=Ve(e.radius/e.eyeRadius*Math.sin(i)),s=Math.PI-i-r,a=Math.sin(s)/Math.sin(i);if(e.eyeRadius<e.radius&&a>1){const t=Math.PI-r,s=Math.PI-i-t;return Math.sin(s)/Math.sin(i)*e.eyeRadius}return a*e.eyeRadius}function _p(e,t,i){if(e.state.isLocal)return;const r=e.state.constraints;if(!r.altitude)return;const s=Ae(t.center),a=Math.sqrt(s),n=t.distance,o=wt(e.spatialReference).radius,l=r.altitude.min+o,h=r.altitude.max+o,c=(l*l-n*n-s)/(-2*a*n),d=(h*h-n*n-s)/(-2*a*n);i.min=Math.max(i.min,Math.min(Math.PI-Ee(d),i.max)),i.max=Math.min(i.max,Math.PI-Ee(c))}const yp=fe(),xp=Ar(),wp=fe(),bp=pe(5),Cp={min:0,max:0},Tp={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,eyeCenterDistance:0,tiltAtCenter:0},Sp={eyeCenterDistance:0,requiresTwoSteps:!1};const Pp=e=>e*e,Rp=e=>1-Pp(1-e),Mp=e=>e*e*e,Dp=e=>1-Mp(1-e),Ap=e=>e<.5?Mp(2*e)/2:(Dp(2*(e-.5))+1)/2,Op=e=>e*e*e*e,Fp=e=>1-Op(1-e),Ip=e=>e*e*e*e*e,zp=e=>1-Ip(1-e),Ep=e=>1-Math.cos(e*Math.PI/2),Lp=e=>1-Ep(1-e),Vp=e=>2**(10*(e-1)),kp=e=>1-Vp(1-e),jp=e=>-(Math.sqrt(1-e*e)-1),Up=e=>1-jp(1-e);function qp(e){const t=2*(e-Math.sqrt((e-1)*e)),i=t/2/e;return r=>r<i?e*r*r:t*r-t+1}function Hp(e,t){return(i,r)=>i<t?t*e(i/t,r):1-e((1-i)/(1-t),r)*(1-t)}const Bp=Hp(qp(1),1),Np=Hp(qp(1),0),Gp=Hp(qp(1),.5),Wp=Hp(qp(2),1),Qp=Hp(qp(2),0),Zp=Hp(qp(2),.5),Yp=Hp(qp(3),1),Xp=Hp(qp(3),0),Kp=Hp(qp(3),.5),Jp=Hp(qp(4),1),$p=Hp(qp(4),0),em=Hp(qp(4),.5),tm={linear:function(e){return e},"in-quad":Pp,"out-quad":Rp,"in-out-quad":e=>e<.5?Pp(2*e)/2:(Rp(2*(e-.5))+1)/2,"in-coast-quad":Bp,"out-coast-quad":Np,"in-out-coast-quad":Gp,"in-cubic":Mp,"out-cubic":Dp,"in-out-cubic":Ap,"in-coast-cubic":Wp,"out-coast-cubic":Qp,"in-out-coast-cubic":Zp,"in-quart":Op,"out-quart":Fp,"in-out-quart":e=>e<.5?Op(2*e)/2:(Fp(2*(e-.5))+1)/2,"in-coast-quart":Yp,"out-coast-quart":Xp,"in-out-coast-quart":Kp,"in-quint":Ip,"out-quint":zp,"in-out-quint":e=>e<.5?Ip(2*e)/2:(zp(2*(e-.5))+1)/2,"in-coast-quint":Jp,"out-coast-quint":$p,"in-out-coast-quint":em,"in-sine":Ep,"out-sine":Lp,"in-out-sine":e=>e<.5?Ep(2*e)/2:(Lp(2*(e-.5))+1)/2,"in-expo":Vp,"out-expo":kp,"in-out-expo":e=>e<.5?Vp(2*e)/2:(kp(2*(e-.5))+1)/2,"in-circ":jp,"out-circ":Up,"in-out-circ":e=>e<.5?jp(2*e)/2:(Up(2*(e-.5))+1)/2};function im(e,t,i=am,r=t){let s=!1;r!==t&&r.copyFrom(t),r.computeUp(e.state.viewingMode);for(let t=0;t<nm;t++){let t=0;for(const a of sm)if(Nu(i.selection,a.type)){const n=Math.abs(a.error(e,r,i));a.apply(e,r,i)&&(s=!0,t+=n)}if(0===t)break}const a=Nu(i.selection,8),n=function(e,t){switch(e){case 4:return 1;case 5:return t.state.isGlobal?2:1;default:return 0}}(i.interactionType,e);return a&&lp(e,r,n)&&(s=!0),s&&r.computeUp(e.state.viewingMode),s}function rm(e,t){const i="number"==typeof e?e:zr(e,t),r=Math.min(1,i/150);return Ap(r)}const sm=[{type:1,error:function(e,t,i){return mp(e,t,i)*t.distance},apply:function e(t,i,r=Wu,s=!0){Sp.eyeCenterDistance=0,Sp.requiresTwoSteps=!1;const a=mp(t,i,r,void 0,Sp);if(0===a)return!1;switch(Sr(xp),yr(xp,xp,-a,i.viewRight),r.tiltMode){case 1:Le(yp,i.viewForward,xp),Ce(yp,yp,Sp.eyeCenterDistance),i.center=Pe(wp,i.eye,yp);break;case 0:Te(yp,i.center,i.eye),Le(yp,yp,xp),i.eye=Te(wp,i.center,yp);break;default:ho(r.tiltMode)}return i.up=Le(wp,i.up,xp),!Sp.requiresTwoSteps||!s||e(t,i,r,!1)}},{type:2,error:Zu,apply:function(e,t,i=Wu){const r=Zu(e,t,i);if(0===r)return!1;const s=e.renderCoordsHelper,a=s.getAltitude(t.eye)+r,n=Qu(t,i.interactionDirection,function(e,t,i,r){return e.renderCoordsHelper.worldUpAtPosition(t.eye,r),Ce(r,r,i),r}(e,t,Fe(r),Ku),Xu),o=ye(Ju,t.viewForward),l=s.intersectInfiniteManifold(Yn(t.eye,n),a,$u);return t.eye=C(l)?l:s.setAltitude($u,a,t.eye),t.center=Kn($u,t.eye,o,t.center),!0}},{type:4,error:ep,apply:function(e,t,i=Wu){const r=ep(e,t,i);if(0===r)return!1;const s=e.pointsOfInterest.surfaceOrigin,a=tp(e,t)+r,n=ye(rp,t.eye),o=Qu(t,i.interactionDirection,function(e,t,i){const r=e.pointsOfInterest.surfaceOrigin;return ze(i,t.eye,r.renderLocation)}(e,t,np),ap);if(!Qa(Za(s.renderLocation,a),Yn(t.eye,o),op))return!1;t.eye=op;const l=Te(sp,t.eye,n);t.center=Pe(op,t.center,l);const h=e.renderCoordsHelper.getAltitude(t.center),c=e.renderCoordsHelper.intersectInfiniteManifold(t.ray,h,op);return C(c)&&(t.center=c),!0}}],am={selection:15,interactionType:0,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:0},nm=5,om=fe(),lm=fe(),hm=fe(),cm=fe(),dm=fe(),um=fe(),pm={upward:ge(0,0,1),forward:ge(0,1,0),sideway:ge(1,0,0)},mm=vn();class gm{constructor(e=1){this.viewingMode=e,this.center=fe(),this.pitch=0,this.yaw=0,this.distance=0,this.lookAtDirection=Se(pm.forward)}pixelsPerPanAtZoom(e){return this.size/2/(this._zoomToPanScale*e)}zoomAtPixelsPerPan(e){return this.size/2/(this._zoomToPanScale*e)}pixelsPerRotateAtZoom(){const e=Math.max(Math.cos(Math.abs(this.pitch)),.5);return this.size/2/e}compareTo(e,t){if(t||(t={pan:0,rotate:0,sourceZoom:0,targetZoom:0}),1===this.viewingMode){const i=(_e(this.center)+_e(e.center))/2;t.pan=Ai(this.center,e.center)*i}else t.pan=De(this.center,e.center);let i=Math.abs(e.yaw-this.yaw);i>=Math.PI&&(i=2*Math.PI-i);const r=Math.abs(e.pitch-this.pitch);return t.rotate=Math.max(i,r),t.sourceZoom=this.distance,t.targetZoom=e.distance,t}interpolate(e,t,i){1===this.viewingMode?Oi(e.center,t.center,i.pan,this.center):Oe(this.center,e.center,t.center,i.pan),this.distance=Me(e.distance,t.distance,i.zoom),this.pitch=Me(e.pitch,t.pitch,i.rotate);let r=e.yaw;const s=t.yaw;Math.abs(s-r)>=Math.PI&&(r+=2*(r<s?1:-1)*Math.PI),this.yaw=Me(r,s,i.rotate)}copyFrom(e){ye(this.center,e.center),this.pitch=e.pitch,this.yaw=e.yaw,this.distance=e.distance,ye(this.lookAtDirection,e.lookAtDirection),this.size=e.size,this.copyFromCommon(e),this.viewingMode=e.viewingMode}copyFromRenderCamera(e){const t=this._lookAtOrientation(e.center,mm);ye(this.center,e.center),Te(cm,e.center,e.eye),ke(cm,cm,t),ke(dm,e.up,t),this.distance=_e(cm),cm[0]/=this.distance,cm[1]/=this.distance,cm[2]/=this.distance,this.pitch=this._eyeUpToPitch(cm),this.yaw=this._eyeUpToYaw(cm,dm),this.size=Math.sqrt(e.width*e.width+e.height*e.height),this.copyFromCommon(e)}copyFromCommon(e){this.fov=e.fov,this._zoomToPanScale=Math.atan(.5*this.fov)}copyToRenderCamera(e){const t=this._lookAtOrientation(this.center,mm);un(t,t),this._axisAngleVec3(pm.sideway,this.pitch-Math.PI/2,pm.forward,cm),this._axisAngleVec3(pm.upward,this.yaw,cm),this._axisAngleVec3(pm.sideway,this.pitch-Math.PI/2,pm.upward,dm),this._axisAngleVec3(pm.upward,this.yaw,dm),Ce(cm,cm,this.distance),ke(cm,cm,t),ke(dm,dm,t),e.center=this.center,e.eye=Te(cm,this.center,cm),e.up=dm}_axisAngleVec3(e,t,i,r=i){const s=Math.cos(t),a=Math.sin(t);return Ce(om,i,s),xe(lm,e,i),Ce(lm,lm,a),Ce(hm,e,(1-s)*Ie(e,i)),Pe(r,Pe(r,om,lm),hm)}_lookAtOrientation(e,t=vn()){return this._upAtLookAt(e,hm),xe(om,this.lookAtDirection,hm),we(om,om),0===om[0]&&0===om[1]&&0===om[2]&&ye(om,pm.sideway),xe(lm,hm,om),we(lm,lm),t[0]=om[0],t[1]=lm[0],t[2]=hm[0],t[3]=om[1],t[4]=lm[1],t[5]=hm[1],t[6]=om[2],t[7]=lm[2],t[8]=hm[2],t}_upAtLookAt(e,t){return 2===this.viewingMode?ye(t,pm.upward):we(t,e)}_eyeUpToPitch(e){return Math.PI-Ai(pm.upward,e)}_eyeUpToYaw(e,t){const i=um;return Math.abs(t[2])<.5?(ye(i,t),e[2]>0&&Ce(i,i,-1)):ye(i,e),xe(lm,i,pm.upward),we(lm,lm),Ai(pm.sideway,lm,pm.upward)}}const fm=2,vm=q(500),_m=q(8e3);class ym{constructor(e){this.createCamera=e,this.compared={sourceZoom:0,targetZoom:0,pan:0,rotate:0},this.settings={desiredScreenFlow:fm},this.source=e(),this.target=e()}clone(){const e=new ym(this.createCamera);return e.copyFrom(this),e}copyFrom(e){this.update(e.source,e.target,e.settings)}update(e,t,i){this.source!==e&&this.source.copyFrom(e),this.target!==t&&this.target.copyFrom(t),this.compared=this.source.compareTo(this.target,this.compared),this.settings.desiredScreenFlow=null!=i.desiredScreenFlow?i.desiredScreenFlow:fm,this.desiredPixelFlow=this.settings.desiredScreenFlow*this.target.size,this.halfWindowSize=this.target.size/2}halfWindowPanAtZoom(e){const t=this.target.pixelsPerPanAtZoom(e);return this.halfWindowSize/t}get hasZoom(){return Math.abs(this.compared.sourceZoom-this.compared.targetZoom)>1e-5}get hasPan(){return this.compared.pan>1e-9}get hasRotate(){return this.compared.rotate>1e-9}}class xm{constructor(e){e&&this.update(e)}get time(){return this._time}update(e){e&&(this.definition?this.definition.copyFrom(e):this.definition=e.clone()),this._updatePrecomputedVariables(),this._updatePixelFlow()}_updatePrecomputedVariables(){const e=this.definition,t=e.compared,i=t.sourceZoom,r=t.targetZoom;this._zoomSign=i>r?1:-1,this._panPixelsAtSource=t.pan*e.source.pixelsPerPanAtZoom(i);const s=(e.source.pixelsPerRotateAtZoom(i)+e.target.pixelsPerRotateAtZoom(r))/2;this._rotatePixels=t.rotate*s}_updatePixelFlow(){const e=this.definition.compared.sourceZoom,t=this.definition.compared.targetZoom,{hasZoom:i,hasPan:r,hasRotate:s}=this.definition;let a=0,n=0;i&&(r&&(a=(t/e-1)/(-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2*this._panPixelsAtSource)),s&&(n=this._zoomSign*(Math.log(e/t)/Math.LN2)*this.definition.halfWindowSize/this._rotatePixels)),this._zoomPixelFlow=0,this._panPixelFlow=0,this._rotatePixelFlow=0;const o=this.definition.desiredPixelFlow;if(i&&r&&s){const e=a+n+a*n;this._zoomPixelFlow=a*n/e*o,this._panPixelFlow=n/e*o,this._rotatePixelFlow=a/e*o}else if(i&&r){const e=1+a;this._zoomPixelFlow=a/e*o,this._panPixelFlow=1/e*o}else if(i&&s){const e=1+n;this._zoomPixelFlow=n/e*o,this._rotatePixelFlow=1/e*o}else if(r&&s){const e=this._panPixelsAtSource/this._rotatePixels,t=1+e;this._panPixelFlow=e/t*o,this._rotatePixelFlow=1/t*o}else r?this._panPixelFlow=o:i?this._zoomPixelFlow=o:s&&(this._rotatePixelFlow=o);this._time=s?this.rotateTime:i?this.zoomTime:r?this.panTime:H(0)}get rotateTime(){return this.definition.hasRotate?H(this._rotatePixels/this._rotatePixelFlow):H(0)}get zoomTime(){return this.definition.hasZoom?H(this._zoomSign*(Math.log(this.definition.compared.sourceZoom/this.definition.compared.targetZoom)/Math.LN2)*this.definition.halfWindowSize/this._zoomPixelFlow):H(0)}get panTime(){if(this.definition.hasPan){if(this.definition.hasZoom){const e=-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2,t=e*this._panPixelsAtSource;return H(Math.log(t*(this._zoomPixelFlow/this._panPixelFlow)+1)/(e*this._zoomPixelFlow))}return H(this._panPixelsAtSource/this._panPixelFlow)}return H(0)}_interpolateComponentsZoom(e){if(0===e||1===e)return e;if(this.definition.hasZoom){const t=this.definition.compared.sourceZoom,i=this.definition.compared.targetZoom;return(t*(t/i)**-e-t)/(i-t)}return e}_interpolateComponentsPan(e){if(0===e||1===e)return e;if(this.definition.hasPan&&this.definition.hasZoom){const t=-1/(this._zoomSign*this.definition.halfWindowSize)*this._zoomPixelFlow;return 1/this._panPixelsAtSource*(this._panPixelFlow*(2**(t*e*this._time)-1))/(t*Math.LN2)}return e}_interpolateComponentsRotate(e){return e}interpolateComponentsAt(e,t){e=Math.min(Math.max(e,0),1);const i=this._interpolateComponentsZoom(e),r=this._interpolateComponentsPan(e),s=this._interpolateComponentsRotate(e);return t?(t.zoom=i,t.pan=r,t.rotate=s):t={zoom:i,pan:r,rotate:s},t}}function wm(e,t,i){const r=t-e.compared.sourceZoom,s=e.halfWindowPanAtZoom(r);return-e.halfWindowSize*(i.ascensionFactor*Math.LN2*e.compared.pan+s)*Math.log(e.compared.sourceZoom/t)/(e.desiredPixelFlow*Math.LN2*s)}function bm(e,t,i){const r=1/t,s=Math.log(e.compared.sourceZoom*r),a=1/e.desiredPixelFlow,n=1/Math.LN2,o=t-e.compared.sourceZoom,l=1/o,h=(i.ascensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(o))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*r*a*n*l*h-e.halfWindowSize*s*a*n*l+e.halfWindowSize*s*a*n*h/(o*o)}function Cm(e,t,i){const r=t-e.compared.sourceZoom,s=1/r,a=1/t,n=Math.log(e.compared.sourceZoom*a),o=(i.ascensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(r))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*s*(-2*s*a*o+2*s*n+2*a-2*n*o/(r*r)-o/(t*t))/(e.desiredPixelFlow*Math.LN2)}function Tm(e,t){return-e.halfWindowSize*Math.log(e.compared.sourceZoom/t)/(e.desiredPixelFlow*Math.LN2)}function Sm(e,t){return e.halfWindowSize/(t*e.desiredPixelFlow*Math.LN2)}function Pm(e,t){return-e.halfWindowSize/(t*t*e.desiredPixelFlow*Math.LN2)}function Rm(e,t,i){return e.halfWindowSize*(-e.halfWindowPanAtZoom(t)-i.descensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(e.compared.targetZoom))*Math.log(t/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2*e.halfWindowPanAtZoom(-t+e.compared.targetZoom))}function Mm(e,t,i){const r=Math.log(t/e.compared.targetZoom),s=1/e.desiredPixelFlow,a=1/Math.LN2,n=-t+e.compared.targetZoom,o=1/n,l=(-e.halfWindowPanAtZoom(t)-i.descensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(e.compared.targetZoom))/e.halfWindowPanAtZoom(1);return-e.halfWindowSize*r*s*a*o+e.halfWindowSize*r*s*a*l/(n*n)+e.halfWindowSize*s*a*o*l/t}function Dm(e,t,i){const r=t-e.compared.targetZoom,s=1/r,a=1/t,n=Math.log(t/e.compared.targetZoom),o=(e.halfWindowPanAtZoom(t)+i.descensionFactor*Math.LN2*e.compared.pan-e.halfWindowPanAtZoom(e.compared.targetZoom))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*s*(-2*s*a*o-2*s*n+2*a+2*n*o/(r*r)-o/(t*t))/(e.desiredPixelFlow*Math.LN2)}function Am(e,t){return e.halfWindowSize*Math.log(t/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2)}function Om(e,t){return e.halfWindowSize/(t*e.desiredPixelFlow*Math.LN2)}function Fm(e,t){return-e.halfWindowSize/(t*t*e.desiredPixelFlow*Math.LN2)}function Im(e,t){let i=function(e,t){const i=Math.max(e.compared.sourceZoom,e.compared.targetZoom),r=e.source.zoomAtPixelsPerPan(e.desiredPixelFlow/e.compared.pan)/2;if(r<i)return null!=t.maximumDistance?i+(t.maximumDistance-i)/2:1.5*i;if(t.maximumDistance)return Math.min(t.maximumDistance,r);return r}(e,t);const r={ascensionFactor:null!=t.ascensionFactor?t.ascensionFactor:.5,descensionFactor:null!=t.descensionFactor?t.descensionFactor:.5},s=0===r.ascensionFactor,a=0===r.descensionFactor,n=s?Tm:wm,o=s?Sm:bm,l=s?Pm:Cm,h=a?Am:Rm,c=a?Om:Mm,d=a?Fm:Dm,u=t=>n(e,t,r)+function(e,t,i){return-e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t))}(e,t,r)+h(e,t,r),p=t=>o(e,t,r)+function(e,t,i){return e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t*t))}(e,t,r)+c(e,t,r),m=t=>l(e,t,r)+function(e,t,i){return-2*e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t*t*t))}(e,t,r)+d(e,t,r);let g=u(i);const f=function(e){const t=Math.LN2*e.compared.pan,i=e.compared.sourceZoom-e.compared.targetZoom,r=e.halfWindowPanAtZoom(i),s=e.halfWindowSize*Math.log(e.compared.sourceZoom/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2*r);return e.compared.sourceZoom<=e.compared.targetZoom?s*(t-r):s*(t+r)}(e);let v;const _=t.maximumIterations||20,y=null!=t.maximumDistance?t.maximumDistance:1/0;for(v=0;v<_;v++){const t=1e-6,r=(p(i)+t)/m(i);if(isNaN(r)||i>=y&&r<0){if(!isFinite(y))return null;i=y,g=u(i);break}if(i-=r,i<e.compared.sourceZoom||i<e.compared.targetZoom)return null;const s=u(i);if(Math.abs(s-g)/g<=.005)break;g=s}return g>.7*f||i<e.compared.sourceZoom||i<e.compared.targetZoom?null:i}class zm extends class{constructor(){this.segments=[]}get time(){return this.segments.reduce(((e,t)=>H(e+t.time)),H(0))}interpolateComponentsAt(e,t){e=Math.min(Math.max(e,0),1),e*=this.time;let i=0,r=0;const s=this.definition;for(let a=0;a<this.segments.length;a++){const n=this.segments[a],o=n.definition;if(e<=n.time||a===this.segments.length-1){t=this.segmentInterpolateComponentsAt(n,e/n.time,t),s.hasPan?t.pan=(i+o.compared.pan*t.pan)/s.compared.pan:t.pan=1,s.hasRotate?t.rotate=(r+o.compared.rotate*t.rotate)/s.compared.rotate:t.rotate=1;const a=t.zoom*(o.compared.targetZoom-o.compared.sourceZoom)+o.compared.sourceZoom,l=this.segments[0].definition.compared.sourceZoom,h=this.segments[this.segments.length-1].definition.compared.targetZoom;return s.hasZoom?t.zoom=(a-l)/(h-l):t.zoom=1,t}e-=n.time,i+=o.compared.pan,r+=o.compared.rotate}}segmentInterpolateComponentsAt(e,t,i){return e.interpolateComponentsAt(t,i)}}{constructor(e,t){super(),this._preallocSegments=[new xm,new xm,new xm],this.update(e,t)}update(e,t){if(!e)return;this.definition?this.definition.copyFrom(e):this.definition=e.clone();let i=null;t&&t.apex&&(i=Im(e,t.apex)),this.segments.length=0,this._ascensionSegment=null,this._descensionSegment=null,null==i?this._updateWithoutApex():this._updateWithApex(i,t.apex)}segmentInterpolateComponentsAt(e,t,i){return i=e.interpolateComponentsAt(t,i),e===this._ascensionSegment?i.zoom=Rp(i.zoom):e===this._descensionSegment&&(i.zoom=Pp(i.zoom)),i}_updateWithApex(e,t){const[i,r,s]=this._preallocSegments,a=null!=t.ascensionFactor?t.ascensionFactor:.5,n=Math.min(1-a,null!=t.ascensionFactor?t.descensionFactor:.5),o=1-a-n;i.definition?i.definition.copyFrom(this.definition):i.definition=this.definition.clone(),i.definition.compared.targetZoom=e,i.definition.compared.pan=this.definition.compared.pan*a,i.definition.compared.rotate=this.definition.compared.rotate*a,i.update(),this._ascensionSegment=i,this.segments.push(i),o>0&&(r.definition?r.definition.copyFrom(this.definition):r.definition=this.definition.clone(),r.definition.copyFrom(this.definition),r.definition.compared.sourceZoom=e,r.definition.compared.targetZoom=e,r.definition.compared.pan=this.definition.compared.pan*o,r.definition.compared.rotate=this.definition.compared.rotate*o,r.update(),this.segments.push(r)),s.definition?s.definition.copyFrom(this.definition):s.definition=this.definition.clone(),s.definition.compared.sourceZoom=e,s.definition.compared.pan=this.definition.compared.pan*n,s.definition.compared.rotate=this.definition.compared.rotate*n,s.update(),this._descensionSegment=s,this.segments.push(s)}_updateWithoutApex(){const[e]=this._preallocSegments;e.update(this.definition),this.segments.push(e)}}const Em={zoom:0,pan:0,rotate:0};class Lm{constructor(e){this.createCamera=e,this._time=q(0),this.definition=new ym(e),this.path=new zm}get time(){return this._time}update(e,t,i){this.definition.update(e,t,i),this.path.update(this.definition,i),this._time=this._applyTimeSettings(B(this.path.time),i),this._easing=i.easing?i.easing:this._time>=1e3?Gp:kp}cameraAt(e,t){t=t||this.createCamera(),e=Math.min(Math.max(0,e),1),e=this._normalizedEasing(e);const i=this.path.interpolateComponentsAt(e,Em);return t.interpolate(this.definition.source,this.definition.target,i),t}_normalizedEasing(e){const t=this._easing(0,this._time),i=this._easing(1,this._time);return(this._easing(e,this._time)-t)/(i-t)}_applyTimeSettings(e,t){const i=null!=t.speedFactor?t.speedFactor:1;null!=t.duration?e=t.duration:null!=t.speedFactor&&(e=q(e/i));const r=null!=t.minDuration?t.minDuration:vm/i,s=null!=t.maxDuration?t.maxDuration:_m/i;return q(Math.min(Math.max(r,e),s))}}const Vm=fe();class km{constructor(e){this.currentTime=q(0),this._animation=new Lm((()=>new gm(e))),this._current=new gm(e)}get finished(){return this.currentTime>=this._animation.time}get time(){return this._animation.time}update(e,t,i){const r=this._animation.definition.source,s=this._animation.definition.target,a=Te(Vm,t.center,e.center),n=_e(a);n>=1e-5?(a[0]/=n,a[1]/=n,a[2]/=n):(a[0]=0,a[1]=1,a[0]=0),ye(r.lookAtDirection,a),ye(s.lookAtDirection,a),r.copyFromRenderCamera(e),s.copyFromRenderCamera(t),this._current.copyFrom(r),this._animation.update(r,s,i),this.currentTime=q(0),e.almostEquals(t)&&(this.currentTime=this._animation.time)}cameraAt(e,t){return this._animation.cameraAt(e,this._current),t=t||new co,this._current.copyToRenderCamera(t),t}step(e,t){return this.finished||(this.currentTime=q(this.currentTime+B(e)),this.currentTime>=this.time&&(this.currentTime=this.time)),this.cameraAt(this.currentTime/this.time,t)}}var jm;!function(e){e.Ready="ready",e.Rejected="rejected",e.Running="running",e.Stopped="stopped",e.Finished="finished"}(jm||(jm={}));let Um=class extends yi{constructor(){super(...arguments),this.state=jm.Ready}get active(){return this.state===jm.Running}get isInteractive(){return!1}get canStop(){return!1}stopController(){return!!this.canStop&&(this.state=jm.Stopped,!0)}finishController(){this.state=jm.Finished}get steppingFinished(){return!1}};e([le({readOnly:!0})],Um.prototype,"active",null),e([le()],Um.prototype,"state",void 0),Um=e([ce("esri.views.3d.state.controllers.CameraController")],Um);let qm=class extends Um{get canStop(){return!0}set asyncResult(e){this._asyncResult&&(this._asyncResult.reject(p()),this._asyncResult=null),this.state===jm.Finished||this.state===jm.Stopped?this.state===jm.Finished?e.resolve():e.reject(p()):this._asyncResult=e}get asyncResult(){return this._asyncResult}onControllerStart(){this.state=jm.Running,C(this.viewAnimation)&&this.viewAnimation.when((()=>this.updateStateFromViewAnimation()),(()=>this.updateStateFromViewAnimation()))}updateStateFromViewAnimation(){!C(this.viewAnimation)||this.state!==jm.Ready&&this.state!==jm.Running||(this.viewAnimation.state===_i.State.FINISHED?this.finish():this.viewAnimation.state===_i.State.STOPPED&&(this.state=jm.Stopped))}onControllerEnd(){C(this.viewAnimation)&&!this.viewAnimation.done&&(this.state===jm.Finished?this.viewAnimation.finish():this.state===jm.Stopped&&this.viewAnimation.stop()),this._asyncResult&&(this.state===jm.Finished?this._asyncResult.resolve():this._asyncResult.reject(p()))}finish(){this.finishController()}};qm=e([ce("esri.views.3d.state.controllers.AnimationController")],qm);let Hm=class extends qm{constructor(e){super(e),this.view=null,this.mode="interaction",this.hasTarget=!1}get intersectionHelper(){return this.view.sceneIntersectionHelper}initialize(){this.animation=new km(this.view.state.viewingMode),this.viewAnimation="interaction"===this.mode?null:new _i}get isInteractive(){return"interaction"===this.mode}begin(e,t){this.hasTarget=!0;const i=this.animationSettings(t);Bm.copyFrom(this.view.state.camera);const r=new uo(this.view.state.viewingMode);this.intersectionHelper.intersectRay(Bm.ray,r,Nm)&&(Bm.center=Nm),this.animation.update(Bm,e,i),this.animation.finished&&this.finish()}finish(){this.animation.currentTime=this.animation.time,super.finish()}get steppingFinished(){return this.hasTarget&&this.animation.finished}stepController(e,t){this.hasTarget&&this.animation.step(e,t)}onControllerEnd(e){this.hasTarget&&(this.animation.cameraAt(this.animation.currentTime/this.animation.time,e),this.animation.currentTime=this.animation.time),super.onControllerEnd(e)}animationSettings(e={}){return{apex:{maximumDistance:this.view.state.constraints.clampAltitude(1/0)/6,ascensionFactor:void 0,descensionFactor:void 0},...e,easing:"string"==typeof e.easing?tm[e.easing]:e.easing}}};e([le({constructOnly:!0})],Hm.prototype,"view",void 0),e([le({constructOnly:!0})],Hm.prototype,"mode",void 0),Hm=e([ce("esri.views.3d.state.controllers.PointToPointAnimationController")],Hm);const Bm=new co,Nm=fe();function Gm(e,t,i=function(e){return{operations:e,value:e.create()}}(e)){return i.operations=e,e.copy(t,i.value),i}function Wm(e,t,i,r){return e.operations.setAltitudeAt(e.value,t,i,r)}function Qm(e,t,i){return e.operations.elevate(e.value,t,i.value)}const Zm=fe();function Ym(e,t,i,r,s){return s[0]=Ie(e,t),s[1]=Ie(e,i),s[2]=Ie(e,r),s}function Xm(e,t,i,r,s){ye(i,e),ye(Km,t),we(Km,Km),xe(r,Km,i),xe(s,r,i)}const Km=fe();function Jm(e,t,i,r){const s=Ro(t,i,$m);return Qa(e,s,r)}const $m=Xn();function eg(e,t,i){return i[0]=t[0]/(e.fullWidth/e.pixelRatio),i[1]=t[1]/(e.fullHeight/e.pixelRatio),i}function tg(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}function ig(e,t,i){const r=nn.get();Sr(r),yr(r,r,i[3],i),Te(Wg,e.eye,t),Le(Wg,Wg,r),e.eye=Pe(Wg,Wg,t),Te(Wg,e.center,t),Le(Wg,Wg,r),e.center=Pe(Wg,Wg,t),e.up=Le(Wg,e.up,r)}function rg(e,t,i,r){return _o(e,Mo(t,i,Kg),r)}function sg(e,t,i,r){const s=on.get();let a=1-i;Te(s,t,e.eye);const n=_e(s);let o=n*(1-a);a>=0&&o<r&&(o=r,a=-(o-n)/n),Math.abs(n-o)<1e-6||(Ce(s,s,a),e.eye=Pe(Wg,e.eye,s),e.center=Oe(Wg,e.center,t,a))}function ag(e,t,i){t.getScreenCenter(ng),Jm(e,t,ng,Wg)&&(t.center=Wg);const r=t.distance,s=r*i;if(Math.abs(r-s)<1e-6)return;const a=Ce(on.get(),t.viewForward,s);t.eye=Te(Wg,t.center,a)}const ng=ie();function og(e,t){ve(t,0,0,0);for(const i of e)Pe(t,t,i);Ce(t,t,1/e.length)}function lg(e,t,i,r){return Math.sin(e/_e(t))*(i+r.radius)}function hg(e,t,i,r){return lg(Math.PI/2,t,i,r)+(e-Math.PI/2)}var cg;!function(e){e[e.Vertical=0]="Vertical",e[e.Horizontal=1]="Horizontal"}(cg||(cg={}));const dg=3e4,ug=pe(6),pg={Pole:.95,Angle:pe(18),Tilt:45},mg=pe(80);function gg(e,t,i,r,s){const a=fe(),n=$a();let o=!0,l=!0;return e.intersectScreen(i,a)?n[3]=_e(a):(l=!1,t.aboveGround?n[3]=Math.max(_e(t.center),.9*s.radius):n[3]=_e(t.eye)-t.relativeElevation,r?yg(n,t,i,a):o=Jm(n,t,i,a)),{sphere:n,scenePickPoint:o?a:null,hasGeometryIntersection:l}}function fg(e,t,i,r){if(_e(e.eye)-r.radius>dg)return cg.Horizontal;if(!i)return cg.Vertical;Ro(e,t,Jg);return-Fe(e.relativeElevation)*(.5*Math.PI+Wa(e.eye,Jg.direction))<ug?cg.Vertical:cg.Horizontal}function vg(e,t,i){Te(_g,i,t),e.eye=Te(Wg,e.eye,_g),e.center=Te(Wg,e.center,_g)}const _g=fe();function yg(e,t,i,r){const s=Ro(t,i,Kg);return!M(s)&&(Ya(e,s,xg),Qa(e,s,r)?!(je(xg,s.origin)<je(r,s.origin))||(ye(r,xg),!1):(Te(wg,t.eye,t.center),we(wg,wg),yo(wg,-Ie(we(wg,wg),xg),bg),_o(bg,s,r),!1))}const xg=fe(),wg=fe(),bg=vo();function Cg(e,t,i,r,s,a){let n;if(xe(Yg,e,t),Te(Qg,e,t),_e(e)<=s||!r.aboveGround){xe(i,Qg,r.eye);const o=Ie(e,t)/(_e(e)*_e(t)),l=Math.cos(ue(Fi.normalize(pe(a)),0,mg));n=-Ee(o)-Math.max(0,_e(t)-s)/(l*s)}else Te(Tg,r.eye,r.center),xe(i,Qg,Tg),n=-_e(Qg)/s;return we(i,i),Ce(i,i,_e(Yg)),n}const Tg=fe();function Sg(e,t,i,r){let s,a;const n=Math.cos(ue(Fi.normalize(pe(r)),0,mg));return s=t>i?-(t-i)/(n*i):t<-i?Math.PI-(t+i)/(n*i):Ee(t/i),a=e>i?-(e-i)/(n*i):e<-i?Math.PI-(e+i)/(n*i):Ee(e/i),(a-s)*i}function Pg(e,t,i,r,s,a,n,o,l,h){xe(Yg,e,t),Xm(a.up,a.eye,Eg,Lg,Vg),Xm([0,0,1],a.eye,Fg,Ig,zg),ye(i,Ig),ye(r,Fg),we(i,i),Ce(i,i,_e(Yg)),Ym(e,we(Lg,Lg),we(Vg,Vg),we(Eg,Eg),kg),Ym(t,Lg,Vg,Eg,jg),function(e,t,i,r,s,a,n,o,l,h){const c=Sg(e[2],t[2],n[3],l),d=h?Sg(e[0],t[0],n[3],180):t[0]-e[0],u=Math.sin(o)*d-Math.cos(o)*c,p=Math.cos(o)*d+Math.sin(o)*c;we(Wg,s);const m=h?u/Math.sqrt(Math.abs(n[3]**2-Ie(i,Wg)**2)):u/n[3],g=p/Math.sqrt(Math.abs(n[3]**2-Ie(i,r)**2));Ir(a,m,g)}(kg,jg,e,Fg,Ig,s,n,o,l,h)}function Rg(e,t,i,r,s,a){Sr(Hg),Sr(Bg),Sr(Ng),yr(Hg,Hg,r,i),yr(Bg,Bg,a,s),Cr(Ng,Hg,Bg),Te(Wg,e.eye,t),Le(Wg,Wg,Ng),e.eye=Pe(Wg,Wg,t),Te(Wg,e.center,t),Le(Wg,Wg,Ng),e.center=Pe(Wg,Wg,t),Te(Wg,e.up,t),Le(Wg,Wg,Ng),e.up=Pe(Wg,Wg,t)}function Mg(e,t,i,r,s,a,n=pg.Pole,o=pg.Angle){const l=Math.abs(r)>Math.PI-o||Math.abs(r)<o,h=Math.abs(e[2])<i*n||Math.abs(t)>i;return!!(l&&h&&a.aboveGround&&s<pg.Tilt)}function Dg(e,t,i,r,s,a){if(a)Md(i,r,qg),ig(t,e,qg);else{const a=Cg(i,r,Xg,t,e[3],s);ig(t,e,Rd(Xg,a))}}function Ag(e,t,i,r,s,a,n){const o=n?20:1;let l,h;ye(Gg,r),Zg.copyFrom(t);for(let r=0;r<o&&je(i,Gg)>1e-12&&(l=je(i,Gg),Pg(i,Gg,Ig,Fg,Ug,Zg,e,s,a,n),Rg(Zg,e,Fg,Ug[1],Ig,Ug[0]),c=Gg,d=Gg,u=e,p=Fg,m=Ug[1],g=Ig,f=Ug[0],Sr(Hg),Sr(Bg),Sr(Ng),yr(Hg,Hg,m,p),yr(Bg,Bg,f,g),Cr(Ng,Hg,Bg),Te(d,c,u),Le(d,d,Ng),Pe(d,d,u),h=je(i,Gg),h<l||0===r);r++)t.copyFrom(Zg);var c,d,u,p,m,g,f}function Og(e,t,i,r,s,a,n,o,l){Mg(e.center,Ie(e.up,e.center),_e(e.center),-Fi.normalize(pe(a)),n,t)?function(e,t,i,r,s,a){const{eye:n}=e;Xm([0,0,1],n,Fg,Ig,zg);const o=t.translation[0]*i.pan,l="zoom"===s.mode?0:t.translation[1]*i.pan,h=Math.max(Math.sqrt(Math.abs(1-Ie(e.center,Fg)**2/_e(e.center)**2)),.5),c=(Math.sin(a)*l+Math.cos(a)*o)/h,d=-Math.cos(a)*l+Math.sin(a)*o;switch(yr(r.pan.matrix,r.pan.matrix,c,Fg),r.pan.enabled=!0,s.mode){case"pan":yr(r.pan.matrix,r.pan.matrix,d,Ig),r.pan.enabled=!0;break;case"zoom":r.zoom=-t.translation[1]*i.zoom}}(t,i,r,o,l,-Fi.normalize(pe(s))):function(e,t,i,r,s){const{eye:a,viewRight:n}=e,o=xe(on.get(),n,a),l=t.translation[0]*i.pan;switch(0!==l&&(yr(r.pan.matrix,r.pan.matrix,-l,o),r.pan.enabled=!0),s.mode){case"pan":{const e=t.translation[1]*i.pan;0!==e&&(yr(r.pan.matrix,r.pan.matrix,e,n),r.pan.enabled=!0);break}case"zoom":r.zoom=-t.translation[1]*i.zoom}}(t,i,r,o,l)}const Fg=fe(),Ig=fe(),zg=fe(),Eg=fe(),Lg=fe(),Vg=fe(),kg=fe(),jg=fe(),Ug=Nr(),qg=Pd(),Hg=Ar(),Bg=Ar(),Ng=Ar(),Gg=fe(),Wg=fe(),Qg=fe(),Zg=new co,Yg=fe(),Xg=fe(),Kg={origin:fe(),direction:fe()},Jg={origin:fe(),direction:fe()};let $g=class extends Hm{constructor(){super(...arguments),this.zoomLocation=fe(),this.tmpCamera=new co,this.tmpViewDir=fe(),this.tmpRayDir={origin:fe(),direction:fe()},this.targetOnSphere=fe(),this.tmpCenter=fe(),this.constraintOptions={selection:7,interactionType:1,interactionFactor:null,interactionStartCamera:new co,interactionDirection:null,tiltMode:0},this.sphere=$a()}initialize(){this.intersector=new uo(this.view.state.viewingMode)}zoomStep(e,t){if(!this.active)return;const i=this.view.state,{interactionStartCamera:r}=this.constraintOptions;this.animation.finished?r.copyFrom(i.camera):this.animation.cameraAt(1,r);let s=!1,a=!1;this.intersectionHelper.intersectScreen(t,this.zoomLocation)&&(s=e>0,a=!0),this.tmpCamera.copyFrom(i.camera),s?this.intersectionHelper.intersectRay(this.tmpCamera.ray,this.intersector,this.tmpCenter)&&(this.tmpCamera.center=this.tmpCenter):this.intersectionHelper.intersectRay(this.tmpCamera.ray,this.intersector,this.zoomLocation)?this.tmpCamera.center=this.zoomLocation:ye(this.zoomLocation,this.tmpCamera.center),this.updateCamera(this.tmpCamera,e,this.zoomLocation,t,a),this.begin(this.tmpCamera)}animationSettings(){return{apex:null,duration:q(600),easing:kp}}updateCamera(e,t,i,r,s){if(fg(e,r,s,wt(this.view.spatialReference))===cg.Horizontal||O("disable-feature:context-navigation")){let s=.6**t;this.sphere[3]=_e(i),Te(this.tmpViewDir,e.center,e.eye);const a=_e(this.tmpViewDir);let n=a*s;if(s<=1&&n<4&&(n=4,s=n/a),Math.abs(a-n)<1e-6)return;const o=_e(e.center);if(this.sphere[3]!==o){const t=this.sphere[3]+s*(o-this.sphere[3]);e.center=Ce(ef,e.center,t/o)}Ce(this.tmpViewDir,this.tmpViewDir,-s),e.eye=Pe(ef,e.center,this.tmpViewDir),im(this.view,e,this.constraintOptions),je(i,e.center)>1e-12&&Jm(this.sphere,e,r,this.targetOnSphere)&&function(e,t,i,r,s,a,n){Mg(i,Ie(t.up,i),e[3],-Fi.normalize(pe(s)),a,t,pg.Pole,pg.Angle)?Ag(e,t,i,r,-Fi.normalize(pe(s)),a,n):Dg(e,t,i,r,a,n)}(this.sphere,e,i,this.targetOnSphere,this.view.camera.heading,this.view.camera.tilt,!0)}else{let s=.6**Math.abs(t);const a=t>0?1:-1;let n;Ro(e,r,this.tmpRayDir),we(this.tmpRayDir.direction,this.tmpRayDir.direction),this.view.camera.position.hasZ&&(n=Math.abs(this.view.camera.position.z));let o=Math.max(12*n,20);const l=this.view._stage.renderView.getMinimalDepthForArea(r[0],r[1],this.view.state.camera,60);o=o>l?l:o,Ce(this.tmpRayDir.direction,this.tmpRayDir.direction,o),Pe(i,this.tmpRayDir.origin,this.tmpRayDir.direction);let h=o*s;if(t>0&&h<4&&(h=4,s=h/o),Math.abs(o-h)<1e-6)return;Ce(this.tmpRayDir.direction,this.tmpRayDir.direction,a*(1-s)),e.eye=Pe(ef,e.eye,this.tmpRayDir.direction),e.center=Pe(ef,e.center,this.tmpRayDir.direction)}lp(this.view,e)}};$g=e([ce("esri.views.3d.state.controllers.global.ZoomStepController")],$g);const ef=fe();let tf=class extends Hm{constructor(){super(...arguments),this.zoomLocation=fe(),this.tmpCamera=new co,this.tmpRayDir=fe(),this.tmpCenter=fe(),this.constraintOptions={selection:15,interactionType:1,interactionFactor:null,interactionStartCamera:new co,interactionDirection:null,tiltMode:0}}zoomStep(e,t){if(!this.active)return;const i=this.view.state,{interactionStartCamera:r}=this.constraintOptions;this.animation.finished?r.copyFrom(i.camera):this.animation.cameraAt(1,r),this.tmpCamera.copyFrom(i.camera);const s=new uo(this.view.state.viewingMode);e>0?(this.intersectionHelper.intersectScreenFreePointFallback(t,this.zoomLocation),this.intersectionHelper.intersectRay(this.tmpCamera.ray,s,this.tmpCenter)&&(this.tmpCamera.center=this.tmpCenter)):this.intersectionHelper.intersectRay(this.tmpCamera.ray,s,this.zoomLocation)?this.tmpCamera.center=this.zoomLocation:ye(this.zoomLocation,this.tmpCamera.center);const a=.6**e;if(!vr()){let e=this.view._stage.renderView.getMinimalDepthForArea(t[0],t[1],this.view.state.camera,60);const i=Math.max(14*Math.abs(this.view.camera.position.z),20);if(e=e?Math.min(e,i):i,e){const t=fe();Te(t,this.zoomLocation,this.tmpCamera.eye),e<_e(t)&&(we(t,t),Pe(this.zoomLocation,this.tmpCamera.eye,Ce(t,t,e)))}}this.updateCamera(this.tmpCamera,a,this.zoomLocation),this.begin(this.tmpCamera)}animationSettings(){return{apex:null,duration:q(600),easing:kp}}updateCamera(e,t,i){Te(this.tmpRayDir,i,e.eye);const r=_e(this.tmpRayDir);let s=r*t;t<=1&&s<4&&(s=4,t=s/r),Math.abs(r-s)<1e-6||(Ce(this.tmpRayDir,this.tmpRayDir,t),e.eye=Te(rf,i,this.tmpRayDir),e.center=Oe(rf,e.center,i,1-t),im(this.view,e,this.constraintOptions))}};tf=e([ce("esri.views.3d.state.controllers.local.ZoomStepController")],tf);const rf=fe();class sf extends Ao{constructor(e,t){super(!0),this.view=e,this.registerIncoming("double-click",t,(e=>this.handleDoubleClick(e)))}handleDoubleClick(e){const t=e.data;if(ei(t,"primary")){const i=this.view.state.isGlobal?new $g({view:this.view,mode:"animation"}):new tf({view:this.view,mode:"animation"});this.view.state.switchCameraController(i),i.zoomStep(Math.log(.5)/Math.log(.6),ie(t.x,t.y)),e.stopPropagation()}}}let af=class extends Um{constructor(){super(...arguments),this.startCamera=new co,this.currentCamera=new co}get isInteractive(){return!0}stepController(e,t){t.copyViewFrom(this.currentCamera),this.currentCamera.copyFrom(t)}onControllerStart(e){this.state=jm.Running,this.startCamera.copyFrom(e),this.currentCamera.copyFrom(e)}onControllerEnd(e){e.copyViewFrom(this.currentCamera)}};af=e([ce("esri.views.3d.state.controllers.InteractiveController")],af);let nf=class extends af{constructor(e){super(e),this.view=null,this.pivot=0,this.lastPoint=Nr(),this.tmpWorldUp=fe(),this.tmpViewDir=fe(),this.tmpRotCurPoint=Nr(),this.tmpTransf=Ar(),this.tmpAxis=fe(),this.tmpPivotPoint=fe(),this.pivotPos=fe(),this.constraintOptions={selection:15,interactionType:2,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:0}}get intersectionHelper(){return this.view.sceneIntersectionHelper}initialize(){this.rotScale=0===this.pivot?3:1.5}begin(e){if(this.active){switch(this.pivot){case 1:ye(this.pivotPos,this.startCamera.eye),this.constraintOptions.interactionType=3,this.constraintOptions.tiltMode=1,this.constraintOptions.selection=0;break;case 0:this.intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this.pivotPos)||ye(this.pivotPos,this.startCamera.center),O("disable-feature:context-navigation")||this.constrainPivotPoint(e),this.startCamera.center=this.pivotPos,this.constraintOptions.interactionType=2,this.constraintOptions.tiltMode=0,this.constraintOptions.selection=11}this.constraintOptions.interactionStartCamera=this.startCamera,eg(this.startCamera,e,this.lastPoint)}}constrainPivotPoint(e){const t=this.startCamera,i=fe();Te(i,this.pivotPos,t.eye);let r=_e(i);this.view.camera.position.hasZ&&(r=Math.min(r,7*Math.abs(this.view.camera.position.z)));const s=wt(this.view.spatialReference),a=ie(t.width/t.pixelRatio*.5,t.height/t.pixelRatio*.5),n=fg(this.startCamera,a,!0,s);let o=this.view._stage.renderView.getMinimalDepthForArea(t.fullWidth/t.pixelRatio*.5,t.fullHeight/t.pixelRatio*.5,t,225,90),l=this.view._stage.renderView.getMinimalDepthForArea(e[0],e[1],t,90);void 0===o&&void 0===l||(o=void 0===o?l:o,l=void 0===l||n===cg.Horizontal?o:l,r=o>l?l:o),we(i,i),ye(this.pivotPos,Pe(this.tmpPivotPoint,t.eye,Ce(this.tmpPivotPoint,i,r)))}update(e){if(this.active){switch(this.pivot){case 1:this.currentCamera.center=this.applyRotation(this.currentCamera,e,this.currentCamera.center,this.pivotPos);break;case 0:this.currentCamera.center=this.pivotPos,this.currentCamera.eye=this.applyRotation(this.currentCamera,e,this.currentCamera.eye,this.pivotPos)}im(this.view,this.currentCamera,this.constraintOptions)}}end(){this.active&&this.finishController()}applyRotation(e,t,i,r){this.view.renderCoordsHelper.worldUpAtPosition(r,this.tmpWorldUp),eg(e,t,this.tmpRotCurPoint);let s=(this.lastPoint[1]-this.tmpRotCurPoint[1])*this.rotScale,a=(this.tmpRotCurPoint[0]-this.lastPoint[0])*this.rotScale;Te(this.tmpViewDir,i,r);const n=_e(this.tmpViewDir),o=Ee(Ie(this.tmpViewDir,this.tmpWorldUp)/n);if(1===this.pivot){s*=-.5;const e=.5*Math.PI-o,t=.5*Math.PI*.99;s=e-Math.max(-t,Math.min(t,e+s))}return s=ue(s+o,Xc.min,Xc.max)-o,Sr(this.tmpTransf),xe(this.tmpAxis,e.up,this.tmpViewDir),0===this.pivot&&(a=-a),yr(this.tmpTransf,this.tmpTransf,a,this.tmpWorldUp),yr(this.tmpTransf,this.tmpTransf,s,this.tmpAxis),Le(this.tmpViewDir,this.tmpViewDir,this.tmpTransf),e.up=Le(of,e.up,this.tmpTransf),Pe(of,r,this.tmpViewDir),Er(this.lastPoint,this.tmpRotCurPoint),of}};e([le({constructOnly:!0})],nf.prototype,"view",void 0),e([le()],nf.prototype,"pivot",void 0),nf=e([ce("esri.views.3d.state.controllers.RotateController")],nf);const of=fe();class lf extends Ao{constructor(e,t,i,r){super(!0),this.view=e,this.pointerAction=t,this.pivot=i,this.registerIncoming("drag",r,(e=>this.handleDrag(e)))}handleDrag(e){const t=e.data;if(t.pointers.size>1)return;if(!ti(e.data,this.pointerAction))return;const i=ie(t.center.x,t.center.y);switch(t.action){case"start":this.cameraController&&(this.cameraController.end(),this.cameraController=null),this.cameraController=new nf({view:this.view,pivot:this.pivot}),this.view.state.switchCameraController(this.cameraController),this.cameraController.begin(i);break;case"update":this.cameraController&&this.cameraController.update(i);break;case"end":this.cameraController&&(this.cameraController.end(),this.cameraController=null)}e.stopPropagation()}}let hf=class extends af{constructor(e){super(e),this.view=null,this.pickPoint=fe(),this.tmpP0=Nr(),this.panAxisAngle=Pd(),this.tmpRayDir=fe(),this.targetOnSphere=fe(),this.tmpRay={origin:fe(),direction:fe()},this.dragBeginPoint=ie(),this.normalizedAnchorPoint=Nr(),this.constraintOptions={selection:7,interactionType:1,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:0},this.sphere=$a(),this.hasPickPoint=!1}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;Er(this.dragBeginPoint,e),eg(this.startCamera,e,this.normalizedAnchorPoint);const t=wt(this.view.spatialReference),i=gg(this.intersectionHelper,this.startCamera,e,!1,t);if(this.navMode=fg(this.startCamera,e,i.hasGeometryIntersection,t),this.navMode===cg.Horizontal||O("disable-feature:context-navigation"))this.hasPickPoint=!!i.scenePickPoint,this.pickPoint=i.scenePickPoint,this.sphere=i.sphere;else{let t;Ro(this.startCamera,e,this.tmpRay),we(this.tmpRay.direction,this.tmpRay.direction),this.view.camera.position.hasZ&&(t=Math.abs(this.view.camera.position.z));let i=30*t;const r=this.view._stage.renderView.getMinimalDepthForArea(e[0],e[1],this.view.state.camera,70);i=i>r?r:i,this.hasPickPoint=!0,Ce(this.tmpRay.direction,this.tmpRay.direction,i),Pe(this.pickPoint,this.tmpRay.origin,this.tmpRay.direction)}this.constraintOptions.interactionStartCamera=this.startCamera}update(e){if(this.active){if(this.currentCamera.eye=this.startCamera.eye,this.currentCamera.center=this.startCamera.center,this.currentCamera.up=this.startCamera.up,this.navMode===cg.Horizontal||O("disable-feature:context-navigation")){Te(this.tmpRayDir,this.currentCamera.center,this.currentCamera.eye);const t=_e(this.tmpRayDir);eg(this.currentCamera,e,this.tmpP0);const i=12*(this.normalizedAnchorPoint[1]-this.tmpP0[1]);let r=t*2**i;const s=this.view.state.constraints.minimumPoiDistance;if(i<0&&r<s&&(r=s),Math.abs(t-r)<1e-6)return;if(this.hasPickPoint&&r<t){const e=1-(1-r/t)*(1-this.sphere[3]/_e(this.currentCamera.center));this.currentCamera.center=Ce(cf,this.currentCamera.center,e)}Ce(this.tmpRayDir,this.tmpRayDir,-r/t),this.currentCamera.eye=Pe(cf,this.currentCamera.center,this.tmpRayDir),this.constraintOptions.interactionFactor=rm(this.dragBeginPoint,e),im(this.view,this.currentCamera,this.constraintOptions),this.hasPickPoint&&(yg(this.sphere,this.currentCamera,this.dragBeginPoint,this.targetOnSphere),Md(this.pickPoint,this.targetOnSphere,this.panAxisAngle),ig(this.currentCamera,this.sphere,this.panAxisAngle))}else{const t=_e(this.tmpRay.direction);eg(this.currentCamera,e,this.tmpP0);const i=12*(this.normalizedAnchorPoint[1]-this.tmpP0[1]);let r=t*2**i;const s=this.view.state.constraints.minimumPoiDistance;if(i<0&&r<s&&(r=s),Math.abs(t-r)<1e-6)return;Ce(this.tmpRayDir,this.tmpRay.direction,1-r/t),this.currentCamera.eye=Pe(cf,this.currentCamera.eye,this.tmpRayDir),this.currentCamera.center=Pe(cf,this.currentCamera.center,this.tmpRayDir)}lp(this.view,this.currentCamera)}}end(){this.active&&this.finishController()}};e([le({constructOnly:!0})],hf.prototype,"view",void 0),hf=e([ce("esri.views.3d.state.controllers.global.ZoomController")],hf);const cf=fe();let df=class extends af{constructor(e){super(e),this.view=null,this.tmpP=fe(),this.tmpDir=fe(),this.tmpN=fe(),this.tmpP0=Nr(),this.tmpPoi=fe(),this.tmpRayDir=fe(),this.dragBeginPoint=ie(),this.normalizedAnchorPoint=Nr(),this.constraintOptions={selection:15,interactionType:1,interactionFactor:0,interactionStartCamera:null,interactionDirection:fe(),tiltMode:0},this.plane=vo()}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;let t;Er(this.dragBeginPoint,e),eg(this.startCamera,e,this.normalizedAnchorPoint),this.intersectionHelper.intersectScreenFreePointFallback(e,this.tmpP),Te(this.tmpDir,this.tmpP,this.startCamera.eye),we(this.tmpDir,this.tmpDir),this.view.camera.position.hasZ&&(t=Math.abs(this.view.camera.position.z));let i=30*t;const r=this.view._stage.renderView.getMinimalDepthForArea(e[0],e[1],this.view.state.camera,70);i=i>r?r:i,Ce(this.tmpDir,this.tmpDir,i),Pe(this.tmpP,this.startCamera.eye,this.tmpDir),Te(this.tmpN,this.startCamera.eye,this.startCamera.center),we(this.tmpN,this.tmpN),this.tmpN[1]<0&&Ue(this.tmpN,this.tmpN),xo(this.tmpP,this.tmpN,this.plane),this.constraintOptions.interactionStartCamera=this.startCamera}update(e){if(!this.active)return;rg(this.plane,this.currentCamera,this.dragBeginPoint,this.tmpPoi)||ye(this.tmpPoi,this.currentCamera.center),eg(this.currentCamera,e,this.tmpP0);let t=4*(this.tmpP0[1]-this.normalizedAnchorPoint[1]);Er(this.normalizedAnchorPoint,this.tmpP0),Te(this.tmpRayDir,this.tmpPoi,this.currentCamera.eye);const i=_e(this.tmpRayDir);let r=i*(1-t);ye(this.constraintOptions.interactionDirection,this.tmpRayDir),Ce(this.constraintOptions.interactionDirection,this.constraintOptions.interactionDirection,Fe(t)/i);const s=this.view.state.constraints.minimumPoiDistance;t>=0&&r<s&&(r=s,t=-(r-i)/i),Math.abs(i-r)<1e-6||(Ce(this.tmpRayDir,this.tmpRayDir,t),this.currentCamera.eye=Pe(uf,this.currentCamera.eye,this.tmpRayDir),Oe(uf,this.currentCamera.center,this.tmpPoi,t),this.tmpPoi[2]>this.startCamera.center[2]?uf[2]=Math.max(this.startCamera.center[2],uf[2]):uf[2]=Math.min(this.startCamera.center[2],uf[2]),this.currentCamera.center=uf,this.constraintOptions.interactionFactor=rm(this.dragBeginPoint,e),im(this.view,this.currentCamera,this.constraintOptions))}end(){this.active&&this.finishController()}};e([le({constructOnly:!0})],df.prototype,"view",void 0),df=e([ce("esri.views.3d.state.controllers.local.ZoomController")],df);const uf=fe();class pf extends Ao{constructor(e,t,i){super(!0),this.view=e,this.pointerAction=t,this.registerIncoming("drag",i,(e=>this.handleDrag(e)))}handleDrag(e){const t=e.data;if(t.pointers.size>1)return;if(!ti(e.data,this.pointerAction))return;const i=ie(t.center.x,t.center.y);switch(t.action){case"start":this.cameraController&&(this.cameraController.end(),this.cameraController=null),this.view.state.isGlobal?this.cameraController=new hf({view:this.view}):this.cameraController=new df({view:this.view}),this.view.state.switchCameraController(this.cameraController),this.cameraController.begin(i);break;case"update":this.cameraController&&this.cameraController.update(i);break;case"end":this.cameraController&&(this.cameraController.end(),this.cameraController=null)}e.stopPropagation()}}let mf=class extends af{constructor(e){super(e),this.transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},this.keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],this.tmpCamera=new co,this.constraintOptions={selection:15,interactionType:0,interactionStartCamera:new co,interactionFactor:0,interactionDirection:null,tiltMode:1}}handleEventGamepad(e){const t=ii(e,this.view.navigation.gamepad,this.transformation);("end"===e.action||ri(t))&&this.finishController()}activateDirection(e){this.keysButtonState[e]=1,si(this.keysButtonState,this.transformation)}deactivateDirection(e){this.keysButtonState[e]=0;const t=si(this.keysButtonState,this.transformation);ri(t)&&this.finishController()}onControllerStart(e){this.filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this.headingStart=this.view.camera.heading,super.onControllerStart(e)}updateFilteredSurfaceElevation(e){const t=this.view.pointsOfInterest.cameraOnSurface.location.z;this.filteredSurfaceElevation+=1*(t-this.filteredSurfaceElevation)*e}stepController(e,t){this.updateStartHeading(),this.updateFilteredSurfaceElevation(e),this.currentCamera.copyViewFrom(t),this.updateCameraCenter(),this.constraintOptions.interactionStartCamera.copyFrom(this.currentCamera),this.calculateControlTransformation(e,this.currentCamera,bf),this.applyDisabledMovementTypes(bf),this.applyPan(bf.pan),this.applyRotate(bf.rotate),this.applyZoom(bf.zoom),this.applyAscend(bf.ascend),this.constraintOptions.interactionType=0,this.constraintOptions.selection=8,im(this.view,this.currentCamera,this.constraintOptions),super.stepController(e,t)}updateStartHeading(){0!==this.transformation.heading&&(this.headingStart=this.view.camera.heading)}applyRotate(e){if(!e.enabled)return;const t=this.currentCamera;Te(Cf,t.center,t.eye),Le(Cf,Cf,e.matrix),t.center=Pe(Cf,Cf,t.eye),t.up=Le(Cf,t.up,e.matrix),this.constraintOptions.interactionType=3,this.constraintOptions.selection=7,im(this.view,t,this.constraintOptions)}applyPan(e,t=this.currentCamera){if(!e.enabled)return;t.eye=Le(Cf,t.eye,e.matrix),t.center=Le(Cf,t.center,e.matrix);this.view.state.isGlobal&&(t.up=Le(Cf,t.up,e.matrix)),this.constraintOptions.interactionType=4,this.constraintOptions.selection=15,im(this.view,t,this.constraintOptions)}applyZoom(e){if(!e)return;const t=this.currentCamera.viewForward;this.currentCamera.eye=Pe(Cf,this.currentCamera.eye,Ce(on.get(),t,e)),ye(Tf,t),Ue(Tf,Tf),this.constraintOptions.interactionDirection=Tf,this.constraintOptions.interactionType=1,this.constraintOptions.selection=7,im(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null}applyAscend(e){if(!e)return;const t=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,on.get());this.constraintOptions.interactionDirection=ye(Tf,t);if(this.view.state.isGlobal){const t=_e(this.currentCamera.eye),i=(t+e)/t;this.currentCamera.eye=Ce(Cf,this.currentCamera.eye,i),this.currentCamera.center=Ce(Cf,this.currentCamera.center,i)}else{const i=Ce(on.get(),t,e);this.currentCamera.eye=Pe(Cf,this.currentCamera.eye,i),this.currentCamera.center=Pe(Cf,this.currentCamera.center,i)}this.updateCameraCenter(),this.constraintOptions.interactionType=5,this.constraintOptions.selection=8,im(this.view,this.currentCamera,this.constraintOptions)&&this.updateCameraCenter(),this.constraintOptions.selection=7,im(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null}calculateControlTransformation(e,t,i){!function(e){e.zoom=0,e.ascend=0,e.pan.enabled=!1,Sr(e.pan.matrix),e.rotate.enabled=!1,Sr(e.rotate.matrix)}(i);const r=this.computeVelocities(e);this.view.state.isLocal?this.calculateControlTransformationLocal(r,t,i):this.calculateControlTransformationGlobal(r,t,i)}updateCameraCenter(){const e=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,t=this.view.renderCoordsHelper,i=this.currentCamera.ray;this.currentCamera.center=t.intersectManifoldClosestSilhouette(i,e,Cf)}calculateControlTransformationLocal(e,t,i){const{viewRight:r,viewForward:s}=t,a=this.transformation,n=this.view.navigation.gamepad,o=ve(on.get(),s[0],s[1],0);we(o,o);const l=a.translation[0]*e.pan;if(0!==l){const e=Ce(on.get(),r,l);Pr(i.pan.matrix,i.pan.matrix,e),i.pan.enabled=!0}switch(n.mode){case"pan":{const t=-a.translation[1]*e.pan;if(0!==t){const e=Ce(on.get(),o,t);Pr(i.pan.matrix,i.pan.matrix,e),i.pan.enabled=!0}i.zoom=a.zoom*e.zoom;break}case"zoom":i.zoom=(-a.translation[1]+a.zoom)*e.zoom;break;default:ho(n.mode)}const h=a.translation[2]*e.ascend;i.ascend=h;const c=-a.heading*e.rotate;0!==c&&(yr(i.rotate.matrix,i.rotate.matrix,c,this.view.renderCoordsHelper.worldUpAtPosition(t.eye,on.get())),i.rotate.enabled=!0);const d=a.tilt*e.rotate,u=dp(this.view.renderCoordsHelper,t.center,t.eye),p=ue(u+d,Xc.min,Xc.max)-u;p&&(yr(i.rotate.matrix,i.rotate.matrix,p,r),i.rotate.enabled=!0)}calculateControlTransformationGlobal(e,t,i){const{eye:r,viewRight:s}=t,a=this.transformation,n=this.view.navigation.gamepad,o=xe(on.get(),s,r);we(o,o),Ue(o,o),Og(this.startCamera,t,a,e,this.view.camera.heading,this.headingStart,this.view.camera.tilt,i,n),this.tmpCamera.copyFrom(this.currentCamera),this.applyPan(bf.pan,this.tmpCamera);const l=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,h=a.translation[2]*e.ascend;i.ascend=h;const c=-a.heading*e.rotate;0!==c&&(yr(i.rotate.matrix,i.rotate.matrix,c,this.tmpCamera.eye),i.rotate.enabled=!0);const d=a.tilt*e.rotate,u=this.clampTiltDeltaGlobalToValidRange(d,t.ray,l);0!==u&&(yr(i.rotate.matrix,i.rotate.matrix,u,this.tmpCamera.viewRight),i.rotate.enabled=!0),i.zoom+=a.zoom*e.zoom}clampTiltDeltaGlobalToValidRange(e,t,i){const r=wt(this.view.spatialReference),s=lg(Xc.min,t.origin,i,r);let a=0,n=0;const o=on.get();if(this.view.renderCoordsHelper.intersectManifold(t,i,o)){a=lg(dp(this.view.renderCoordsHelper,o,t.origin),t.origin,i,r),n=lg(Xc.max,t.origin,i,r)}else{Ya(Xa(i+r.radius),t,o);a=hg(Ee(-Ie(t.direction,we(o,o))),t.origin,i,r),n=hg(Xc.max,t.origin,i,r)}return ue(a+e,s,n)-a}getPointAbsoluteSurfaceElevation(e,t,i){const{renderCoordsHelper:r}=this.view,s=r.getAltitude(e),a=t+Math.abs(s-t);return r.setAltitude(i,a,e),a}clampedDistanceToSurface(e,t){const{renderCoordsHelper:i}=this.view,{camera:r}=this.view.state,{direction:s}=ki(this.view,t,0,ff,Sf),a=i.intersectManifoldClosestSilhouette(Yn(t,s),e,on.get()),n=De(t,a),o=i.intersectManifoldClosestSilhouette(Yn(t,ze(on.get(),t,r.center)),e,on.get()),l=De(t,o);return Math.min(n,l)}computeHeadingRotateRadius(e){const{renderCoordsHelper:t,state:i}=this.view,{camera:r,isGlobal:s}=i,a=t.intersectManifoldClosestSilhouette(r.ray,this.filteredSurfaceElevation,on.get());if(s){const t=Te(on.get(),e,a),i=_e(t);Ce(t,t,1/i);const r=we(on.get(),e),s=Ee(Ie(r,t));return i*Math.sin(Math.min(vf,s))}{const i=ye(on.get(),e);return t.setAltitude(i,this.filteredSurfaceElevation),De(a,i)}}minimumAscendVelocity(){return this.view.state.constraints.collision.enabled?0:yf}computeVelocities(e){const t=this.filteredSurfaceElevation,i=t+wt(this.view.spatialReference).radius,{camera:r,isGlobal:s}=this.view.state,a=on.get(),n=this.getPointAbsoluteSurfaceElevation(r.eye,t,a),o=this.clampedDistanceToSurface(t,a),l=r.width/2,h=_f*r.width,c=_f*r.width,d=o*Math.tan(.5*r.fovX)/l,u=d/i,p=d/this.computeHeadingRotateRadius(a),m=n-t;return{pan:(s?u:d)*h*e,ascend:Math.max(this.minimumAscendVelocity()*e,2**(h*e/l)*m-m),zoom:2**(h*e/l)*o-o,rotate:ue(p*c,xf,wf)*e}}applyDisabledMovementTypes(e){!C(this.disableMovements)||void 0!==this.disableMovements.mode&&this.view.state.viewingMode!==this.disableMovements.mode||(e.zoom=this.disableMovements.zoom?0:e.zoom,e.ascend=this.disableMovements.ascend?0:e.ascend,e.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&Sr(e.pan.matrix),e.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&Sr(e.rotate.matrix))}static activatesFor(e,t){const i=ii(t,e.navigation.gamepad,gf);return!("end"===t.action||ri(i))}};e([le({constructOnly:!0})],mf.prototype,"view",void 0),e([le({constructOnly:!0})],mf.prototype,"gamepadDevice",void 0),e([le({constructOnly:!0})],mf.prototype,"disableMovements",void 0),mf=e([ce("esri.views.3d.state.controllers.GamepadKeyboardController")],mf);const gf={translation:[0,0,0],heading:0,tilt:0,zoom:0},ff=80,vf=pe(ff),_f=.75,yf=5,xf=pe(30),wf=pe(80),bf={zoom:0,ascend:0,pan:{enabled:!1,matrix:Ar()},rotate:{enabled:!1,matrix:Ar()}},Cf=fe(),Tf=fe(),Sf=ji();class Pf extends Ao{constructor(e){super(!0),this.view=e,this.watchHandles=new ar,this.handle=this.registerIncoming("gamepad",(e=>this.handleEventGamepad(e))),this.handle.pause()}onInstall(e){super.onInstall(e),this.watchHandles.add([Y(this.view.navigation.gamepad,"enabled",(e=>{e?this.handle.resume():(this.handle.pause(),this.cameraControllerGamepad&&(this.cameraControllerGamepad.finishController(),this.cameraControllerGamepad=null))})),this.view.navigation.gamepad.watch("device",(e=>{this.cameraControllerGamepad&&e&&this.cameraControllerGamepad.gamepadDevice!==e&&(this.cameraControllerGamepad.finishController(),this.cameraControllerGamepad=null)}))])}onUninstall(){this.watchHandles.removeAll(),super.onUninstall()}handleEventGamepad(e){const t=this.view.navigation.gamepad.device;if(t&&e.data.device!==t)return;const i=this.cameraControllerGamepad&&this.cameraControllerGamepad.active;if(i||mf.activatesFor(this.view,e.data)){if(!i){const t=new mf({view:this.view,gamepadDevice:e.data.device});this.view.state.switchCameraController(t)&&(this.cameraControllerGamepad=t)}this.cameraControllerGamepad&&this.cameraControllerGamepad.active&&this.cameraControllerGamepad.gamepadDevice===e.data.device&&this.cameraControllerGamepad.handleEventGamepad(e.data)}}}class Rf extends Ao{constructor(e,t){super(!0),this.view=e,this.disableMovements={pan:!0,zoom:!1,ascend:!0,rotate:!1,mode:2},this.keyToNumber={[t.left]:0,[t.right]:1,[t.forward]:2,[t.backward]:3,[t.up]:4,[t.down]:5,[t.headingLeft]:6,[t.headingRight]:7,[t.tiltUp]:8,[t.tiltDown]:9,[t.zoomIn]:10,[t.zoomOut]:11},this.registerIncoming("key-down",null,(e=>this.handleKeyDown(e))),this.registerIncoming("key-up",null,(e=>this.handleKeyUp(e))),this.registerIncoming("blur",null,(()=>this.handleBlur()))}handleKeyDown(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const t=this.keyToNumber[e.data.key];null!=t&&(this.cameraControllerKeyboard&&this.cameraControllerKeyboard.active||(this.cameraControllerKeyboard=new mf({view:this.view,disableMovements:this.disableMovements}),this.view.state.switchCameraController(this.cameraControllerKeyboard)),this.cameraControllerKeyboard.active&&(this.cameraControllerKeyboard.activateDirection(t),e.stopPropagation()))}handleBlur(){this.cameraControllerKeyboard&&this.cameraControllerKeyboard.active&&(this.cameraControllerKeyboard.finishController(),this.cameraControllerKeyboard=null)}handleKeyUp(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const t=this.keyToNumber[e.data.key];null!=t&&this.cameraControllerKeyboard&&this.cameraControllerKeyboard.active&&(this.cameraControllerKeyboard.deactivateDirection(t),e.stopPropagation())}}class Mf extends Ao{constructor(e,t){super(!0),this.view=e,this.registerIncoming("mouse-wheel",t,(e=>this.handleMouseWheel(e)))}handleMouseWheel(e){if(!this.view.navigation.mouseWheelZoomEnabled)return;const t=e.data;this.cameraController&&this.cameraController.active||(this.cameraController=this.view.state.isGlobal?new $g({view:this.view,mode:"interaction"}):new tf({view:this.view,mode:"interaction"}),this.view.state.switchCameraController(this.cameraController)),this.cameraController.zoomStep(-1/60*t.deltaY,ie(t.x,t.y)),e.preventDefault(),e.stopPropagation()}}class Df{constructor(e){this._gain=e}reset(e){this._value=e}set gain(e){this._gain=e}get value(){return void 0===this._value?0:this._value}update(e){void 0===this._value?this._value=e:this._value=this._gain*e+(1-this._gain)*this._value}}let Af=class extends qm{constructor(e){super(e),this.view=null,this.beginCamera=new co,this.elapsedTimeSec=0,this.constraintOptions={selection:15,interactionType:4,interactionFactor:0,interactionStartCamera:new co,interactionDirection:null,tiltMode:0}}initialize(){this.constraintOptions.interactionType=this.interactionType,this.viewAnimation=new _i}get steppingFinished(){return this.momentum.isFinished(this.elapsedTimeSec)}onControllerStart(e){this.beginCamera.copyFrom(e),this.constraintOptions.interactionStartCamera=this.beginCamera,super.onControllerStart(e)}stepController(e,t){t.copyViewFrom(this.beginCamera),this.elapsedTimeSec+=e,this.momentumStep(this.elapsedTimeSec,t),im(this.view,t,this.constraintOptions)}};e([le({constructOnly:!0})],Af.prototype,"view",void 0),Af=e([ce("esri.views.3d.state.controllers.momentum.MomentumController")],Af);let Of=class extends Af{constructor(e){super(e),this.interactionType=4,this.tmpPan=fe()}momentumStep(e,t){const i=this.momentum.value(e);Ce(this.tmpPan,this.momentum.direction,i),t.eye=Te(Ff,t.eye,this.tmpPan),t.center=Te(Ff,t.center,this.tmpPan),this.constraintOptions.interactionDirection=this.tmpPan}};e([le({constructOnly:!0})],Of.prototype,"momentum",void 0),Of=e([ce("esri.views.3d.state.controllers.momentum.PanPlanarMomentumController")],Of);const Ff=fe(),If=fe(),zf=fe();let Ef=class extends Af{constructor(e){super(e),this.interactionType=4}momentumStep(e,t){const i=this.momentum.value1(e),r=this.momentum.value2(e);ye(zf,t.eye),we(zf,zf),xe(this.momentum.axis2,zf,this.momentum.axis1),Rg(t,If,this.momentum.axis1,i,this.momentum.axis2,r)}};e([le({constructOnly:!0})],Ef.prototype,"momentum",void 0),Ef=e([ce("esri.views.3d.state.controllers.momentum.PanSphericalMomentumController")],Ef);let Lf=class extends Af{constructor(e){super(e),this.interactionType=2}set center(e){this._set("center",Se(e))}set axis(e){this._set("axis",Se(e))}momentumStep(e,t){const i=this.momentum.value(e);ig(t,this.center,Rd(this.axis,i))}};e([le({constructOnly:!0})],Lf.prototype,"momentum",void 0),e([le({constructOnly:!0})],Lf.prototype,"center",null),e([le({constructOnly:!0})],Lf.prototype,"axis",null),Lf=e([ce("esri.views.3d.state.controllers.momentum.MomentumController")],Lf);let Vf=class extends Af{constructor(e){super(e),this.interactionType=1,this.constraintOptions.interactionDirection=fe()}set zoomCenter(e){this._set("zoomCenter",Se(e))}momentumStep(e,t){ye(this.constraintOptions.interactionDirection,t.eye);const i=this.momentum.valueDelta(0,e);sg(t,this.zoomCenter,i,this.view.state.constraints.minimumPoiDistance),this.constraintOptions.interactionDirection=ze(this.constraintOptions.interactionDirection,t.eye,this.constraintOptions.interactionDirection)}};e([le({constructOnly:!0})],Vf.prototype,"momentum",void 0),e([le({constructOnly:!0})],Vf.prototype,"zoomCenter",null),Vf=e([ce("esri.views.3d.state.controllers.momentum.ZoomPlanarMomentumController")],Vf);let kf=class extends Af{constructor(e){super(e),this.interactionType=1,this.radius=0,this.tmpSceneCenter=fe(),this.tmpZoomAxisAngle=Pd(),this.sphere=$a()}set screenCenter(e){this._set("screenCenter",ie(e[0],e[1]))}set sceneCenter(e){this._set("sceneCenter",Se(e))}initialize(){this.sphere[3]=this.radius}momentumStep(e,t){const i=this.momentum.valueDelta(0,e);ag(this.sphere,t,i),this.constraintOptions.interactionType=1,im(this.view,t,this.constraintOptions),yg(this.sphere,t,this.screenCenter,this.tmpSceneCenter),Md(this.sceneCenter,this.tmpSceneCenter,this.tmpZoomAxisAngle),ig(t,this.sphere,this.tmpZoomAxisAngle),this.constraintOptions.interactionType=4}};e([le({constructOnly:!0})],kf.prototype,"momentum",void 0),e([le({constructOnly:!0})],kf.prototype,"screenCenter",null),e([le({constructOnly:!0})],kf.prototype,"sceneCenter",null),e([le({constructOnly:!0})],kf.prototype,"radius",void 0),kf=e([ce("esri.views.3d.state.controllers.momentum.ZoomSphericalMomentumController")],kf);class jf{constructor(e){this.gain=e}update(e){this.hasFilteredValue?this.filteredValue=(1-this.gain)*this.filteredValue+this.gain*e:this.filteredValue=e}reset(){this.filteredValue=void 0}get hasFilteredValue(){return void 0!==this.filteredValue}}class Uf extends zo{constructor(e,t,i,r,s,a=0,n){super(e,t,i),this.angularVelocity1=r,this.axis1=s,this.angularVelocity2=a,this.axis2=n}value1(e){return super.valueFromInitialVelocity(this.angularVelocity1,e)}value2(e){return super.valueFromInitialVelocity(this.angularVelocity2,e)}}class qf{constructor(e=300,t=12,i=.84){this.minimumInitialVelocity=e,this.stopVelocity=t,this.friction=i,this.enabled=!0,this.tmpAxis1=fe(),this.tmpAxis2=fe(),this.tmpAngles=Nr(),this.time=new Io(.3),this.screen=[new Io(.4),new Io(.4)],this.angle1=new jf(.6),this.angle2=new jf(.6),this.axis1=fe(),this.axis2=fe(),this.lastScene=fe()}addMomentumDirectRotation(e,t,i,r,s,a){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(i)<.01)return;let e=Cg(this.lastScene,t,this.tmpAxis2,r,s,a);this.angle2.update(0),Ae(this.tmpAxis2)<1e-5?e=0:we(this.axis1,this.tmpAxis2),this.angle1.update(e),ye(this.lastScene,t)}this.screen[0].update(e[0]),this.screen[1].update(e[1]),this.time.update(i)}}addMomentumPreserveHeading(e,t,i,r,s,a,n){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(i)<.01)return;Pg(this.lastScene,t,this.tmpAxis2,this.tmpAxis1,this.tmpAngles,r,s,a,n,!1),Ae(this.tmpAxis2)<1e-5?(this.angle1.update(0),this.angle2.update(0)):(this.angle1.update(this.tmpAngles[1]),this.angle2.update(this.tmpAngles[0]),we(this.axis1,this.tmpAxis1),we(this.axis2,this.tmpAxis2)),ye(this.lastScene,t)}this.screen[0].update(e[0]),this.screen[1].update(e[1]),this.time.update(i)}}reset(){this.screen[0].reset(),this.screen[1].reset(),this.angle1.reset(),this.angle2.reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.screen[0].hasFilteredDelta)return null;const e=this.screen[0].filteredDelta,t=this.screen[1].filteredDelta,i=Math.sqrt(e*e+t*t)/this.time.filteredDelta;return Math.abs(i)<this.minimumInitialVelocity?null:this.createMomentum(i,this.stopVelocity,this.friction)}createMomentum(e,t,i){const r=this.angle1.filteredValue/this.time.filteredDelta,s=this.angle2.filteredValue/this.time.filteredDelta;return new Uf(e,t,i,r,this.axis1,s,this.axis2)}}let Hf=class extends af{constructor(e){super(e),this.view=null,this.smoothRotation=new Df(.05),this.rotationAxis=fe(),this.panningPlane=vo(),this.smoothScaling=new Df(.05),this.zoomCenterScreen=ie(),this.zoomMomentumEstimator=new Eo,this.rotationMomentumEstimator=new Lo,this.panSphericalMomentumEstimator=new qf,this.panPlanarMomentumEstimator=new Vo,this.adjustedSphere=$a(),this.tmp3d=fe(),this.tmpScreenPointArray=ie(),this.beginScreenPoint=ie(),this.beginScenePoint=fe(),this.screenPickPoint=ie(),this.navMode=cg.Horizontal,this.tmpInteractionDirection=fe(),this.constraintOptions={selection:15,interactionType:0,interactionFactor:0,interactionStartCamera:new co,interactionDirection:null,tiltMode:0}}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;const t=this.view.navigation.momentumEnabled;this.zoomMomentumEstimator.enabled=t,this.rotationMomentumEstimator.enabled=t,this.panPlanarMomentumEstimator.enabled=t,this.panSphericalMomentumEstimator.enabled=t,this.beginHeading=-Fi.normalize(pe(this.view.camera.heading)),this.beginRadius=e.radius,this.pointerCount=e.pointers.size,this.beginAngle=e.angle,this.smoothRotation.reset(),re(e.center,this.screenPickPoint),Er(this.beginScreenPoint,this.screenPickPoint);const i=wt(this.view.spatialReference),r=gg(this.intersectionHelper,this.startCamera,this.screenPickPoint,!0,i);this.scenePickPoint=r.scenePickPoint,this.sphere=r.sphere,ye(this.beginScenePoint,this.scenePickPoint),this.navMode=fg(this.startCamera,this.screenPickPoint,r.hasGeometryIntersection,i),this.navMode===cg.Vertical&&this.preparePlanarPanMode(e),this.constraintOptions.interactionStartCamera.copyFrom(this.startCamera)}preparePlanarPanMode(e){const t=Ue(this.tmp3d,this.startCamera.viewForward);xo(this.scenePickPoint,t,this.panningPlane);const i=ie(this.screenPickPoint[0],0),r=fe(),s=_e(this.startCamera.eye);this.adjustedSphere[3]=s<this.sphere[3]?s-100:this.sphere[3],yg(this.adjustedSphere,this.startCamera,i,r);const a=se();this.startCamera.projectToRenderScreen(r,a);const n=.9*a[1];if(this.screenPickPoint[1]=Math.min(this.screenPickPoint[1],n),this.intersectionHelper.intersectScreen(this.screenPickPoint,this.scenePickPoint)&&xo(this.scenePickPoint,wo(this.panningPlane),this.panningPlane),!vr()){const e=fe(),t=fe(),i=fe(),r=80,s=5,a=50;Te(e,this.scenePickPoint,this.currentCamera.eye),we(e,e);const n=s*Math.max(Math.abs(this.view.camera.position.z),a),o=this.view._stage.renderView.getMinimalDepthForArea(this.screenPickPoint[0],this.screenPickPoint[1],this.view.state.camera,r),l=o?Math.min(o,n):n;ye(i,Pe(t,this.currentCamera.eye,Ce(t,e,l))),this.panningPlane[3]=-Ie(this.panningPlane,i),this.startCamera.center=Pe(t,this.startCamera.eye,Ce(t,this.startCamera.viewForward,l))}const o=re(e.center,this.tmpScreenPointArray);rg(this.panningPlane,this.startCamera,o,this.beginScenePoint)}update(e){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1;this.navMode===cg.Horizontal?(t&&this.zoomSpherical(e),this.panningSpherical(e),t&&this.rotateSpherical(e)):(t&&this.zoomPlanar(e),this.panningPlanar(e),t&&this.rotatePlanar(e))}end(e){e.pointers.size===this.pointerCount&&this.update(e),this.finishController();const t=this.zoomMomentumEstimator.evaluateMomentum();if(t)return this.navMode===cg.Horizontal?new kf({view:this.view,momentum:t,screenCenter:this.zoomCenterScreen,sceneCenter:this.beginScenePoint,radius:this.sphere[3]}):new Vf({view:this.view,momentum:t,zoomCenter:this.beginScenePoint});const i=this.rotationMomentumEstimator.evaluateMomentum();if(i)return new Lf({view:this.view,momentum:i,center:this.sphere,axis:this.rotationAxis});if(this.navMode===cg.Horizontal){const e=this.panSphericalMomentumEstimator.evaluateMomentum();if(e)return new Ef({view:this.view,momentum:e})}else{const e=this.panPlanarMomentumEstimator.evaluateMomentum();if(e)return new Of({view:this.view,momentum:e})}return null}zoomSpherical(e){const t=this.beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this.smoothScaling.gain=i,this.smoothScaling.update(t),ag(this.sphere,this.currentCamera,this.smoothScaling.value),re(e.center,this.zoomCenterScreen),this.zoomMomentumEstimator.add(this.smoothScaling.value,.001*e.timestamp),this.constraintOptions.interactionType=1,this.constraintOptions.interactionFactor=rm(e.radius-this.beginRadius),im(this.view,this.currentCamera,this.constraintOptions)}panningSpherical(e){const t=re(e.center,this.tmpScreenPointArray);yg(this.sphere,this.currentCamera,t,this.tmp3d),Mg(this.beginScenePoint,Ie(this.currentCamera.up,this.beginScenePoint),this.sphere[3],this.beginHeading,this.view.camera.tilt,this.startCamera)?(Ag(this.sphere,this.currentCamera,this.beginScenePoint,this.tmp3d,this.beginHeading,this.view.camera.tilt,!1),this.panSphericalMomentumEstimator.addMomentumPreserveHeading(t,this.tmp3d,.001*e.timestamp,this.startCamera,this.sphere,this.beginHeading,this.view.camera.tilt)):(Dg(this.sphere,this.currentCamera,this.beginScenePoint,this.tmp3d,this.view.camera.tilt,!1),this.panSphericalMomentumEstimator.addMomentumDirectRotation(t,this.tmp3d,.001*e.timestamp,this.startCamera,this.sphere[3],this.view.camera.tilt)),this.constraintOptions.interactionType=4,this.constraintOptions.interactionFactor=rm(this.screenPickPoint,t),im(this.view,this.currentCamera,this.constraintOptions)}rotateSpherical(e){we(this.rotationAxis,this.scenePickPoint),this.currentCamera.aboveGround||Ue(this.rotationAxis,this.rotationAxis);const t=this.smoothRotation.value,i=t+tg(e.angle-t),r=.00125*Math.min(Math.max(e.radius,40),120);this.smoothRotation.gain=r,this.smoothRotation.update(i);const s=this.smoothRotation.value-this.beginAngle;this.rotationMomentumEstimator.add(s,.001*e.timestamp),ig(this.currentCamera,this.sphere,Rd(this.rotationAxis,s)),this.constraintOptions.interactionType=2,this.constraintOptions.interactionFactor=rm(e.radius*i),im(this.view,this.currentCamera,this.constraintOptions)}panningPlanar(e){const t=re(e.center,this.tmpScreenPointArray);rg(this.panningPlane,this.currentCamera,t,this.tmp3d)&&(vg(this.currentCamera,this.beginScenePoint,this.tmp3d),this.panPlanarMomentumEstimator.add(t,this.tmp3d,.001*e.timestamp),this.constraintOptions.interactionType=4,this.constraintOptions.interactionFactor=rm(this.beginScreenPoint,t),this.constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this.tmpInteractionDirection),im(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null)}zoomPlanar(e){const t=this.beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this.smoothScaling.gain=i,this.smoothScaling.update(t),this.zoomMomentumEstimator.add(this.smoothScaling.value,.001*e.timestamp),sg(this.currentCamera,this.beginScenePoint,this.smoothScaling.value,this.view.state.constraints.minimumPoiDistance),this.constraintOptions.interactionType=1,this.constraintOptions.interactionFactor=rm(e.radius-this.beginRadius),im(this.view,this.currentCamera,this.constraintOptions)}rotatePlanar(e){ye(this.rotationAxis,this.beginScenePoint),this.currentCamera.aboveGround||Ue(this.rotationAxis,this.rotationAxis);const t=this.smoothRotation.value;let i=e.angle-t;i=tg(i);const r=t+i,s=.00125*Math.min(Math.max(e.radius,40),120);this.smoothRotation.gain=s,this.smoothRotation.update(r);const a=this.smoothRotation.value-this.beginAngle;this.rotationMomentumEstimator.add(a,.001*e.timestamp),ig(this.currentCamera,this.sphere,Rd(this.rotationAxis,a)),this.constraintOptions.interactionType=2,this.constraintOptions.interactionFactor=rm(e.radius*a),im(this.view,this.currentCamera,this.constraintOptions)}};e([le({constructOnly:!0})],Hf.prototype,"view",void 0),Hf=e([ce("esri.views.3d.state.controllers.global.PinchAndPanController")],Hf);const Bf=ge(0,0,1),Nf=16/180*Math.PI;let Gf=class extends af{constructor(e){super(e),this.view=null,this.rotationValueSmooth=new Df(.05),this.scalingValueSmooth=new Df(.05),this.planeHorizontal=vo(),this.planeVertical=vo(),this.rotationMomentumEstimator=new Lo,this.panMomentumEstimator=new Vo(300,12,.9),this.zoomMomentumEstimator=new Eo,this.beginCenter=fe(),this.tmpPoints=[],this.beginCenterScreen=ie(),this.tmpCentroid3d=fe(),this.tmpCentroid2d=ie(),this.tmp2d=ie(),this.constraintOptions={selection:15,interactionType:0,interactionFactor:0,interactionStartCamera:new co,interactionDirection:null,tiltMode:0}}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;const t=this.view.navigation.momentumEnabled;this.zoomMomentumEstimator.enabled=t,this.rotationMomentumEstimator.enabled=t,this.panMomentumEstimator.enabled=t,this.beginRadius=e.radius,this.pointerCount=e.pointers.size,this.beginAngle=e.angle,this.rotationValueSmooth.reset(),this.scalingValueSmooth.reset(),re(e.center,this.beginCenterScreen),yo(Bf,0,this.planeHorizontal);const i=fe();this.intersectionHelper.intersectScreenFreePointFallback(this.beginCenterScreen,i);const r=fe();Ue(r,this.startCamera.viewForward);const s=fe();ye(s,Bf);const a=Ie(r,s),n=Ve(a<0?-a:a);if(this.panMode=n>=Nf?cg.Horizontal:cg.Vertical,bo(this.planeHorizontal,i,this.planeHorizontal),this.startCamera.aboveGround||Co(this.planeHorizontal,this.planeHorizontal),this.panMode===cg.Vertical){if(Ce(s,s,a),Te(this.planeVertical,r,s),we(this.planeVertical,this.planeVertical),bo(this.planeVertical,i,this.planeVertical),!vr()){const e=fe(),t=fe(),r=fe();Te(e,i,this.currentCamera.eye),we(e,e);const s=5*Math.max(Math.abs(this.view.camera.position.z),50),a=this.view._stage.renderView.getMinimalDepthForArea(this.beginCenterScreen[0],this.beginCenterScreen[1],this.view.state.camera,80),n=a?Math.min(a,s):s;ye(r,Pe(t,this.currentCamera.eye,Ce(t,e,n))),this.planeVertical[3]=-Ie(this.planeVertical,r)}this.computePlanePoints(e.pointers,this.planeVertical,this.startCamera,this.tmpPoints),og(this.tmpPoints,this.beginCenter)}else this.computePlanePoints(e.pointers,this.planeHorizontal,this.startCamera,this.tmpPoints),og(this.tmpPoints,this.beginCenter);this.constraintOptions.interactionStartCamera.copyFrom(this.startCamera)}update(e){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1,i=this.panMode===cg.Horizontal?this.planeHorizontal:this.planeVertical,r=this.beginCenter;if(t){const t=this.beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this.scalingValueSmooth.gain=i,this.scalingValueSmooth.update(t),sg(this.currentCamera,r,this.scalingValueSmooth.value,this.view.state.constraints.minimumPoiDistance),this.zoomMomentumEstimator.add(this.scalingValueSmooth.value,.001*e.timestamp),this.constraintOptions.interactionType=1,this.constraintOptions.interactionFactor=rm(Math.abs(e.radius-this.beginRadius)),im(this.view,this.currentCamera,this.constraintOptions)}if(this.computePlanePoints(e.pointers,i,this.currentCamera,this.tmpPoints),og(this.tmpPoints,this.tmpCentroid3d),re(e.center,this.tmpCentroid2d),vg(this.currentCamera,r,this.tmpCentroid3d),this.panMomentumEstimator.add(this.tmpCentroid2d,this.tmpCentroid3d,.001*e.timestamp),this.constraintOptions.interactionType=4,this.constraintOptions.interactionFactor=rm(this.beginCenterScreen,this.tmpCentroid2d),im(this.view,this.currentCamera,this.constraintOptions),t){const t=this.planeHorizontal,i=r,s=this.rotationValueSmooth.value,a=s+tg(e.angle-s),n=.00125*Math.min(Math.max(e.radius,40),120);this.rotationValueSmooth.gain=n,this.rotationValueSmooth.update(a);const o=this.rotationValueSmooth.value-this.beginAngle;this.rotationMomentumEstimator.add(o,.001*e.timestamp),ig(this.currentCamera,i,Rd(t,o)),this.constraintOptions.interactionType=2,this.constraintOptions.interactionFactor=rm(Math.abs(e.radius*o)),im(this.view,this.currentCamera,this.constraintOptions)}}end(e){e.pointers.size===this.pointerCount&&this.update(e),this.finishController();const t=this.zoomMomentumEstimator.evaluateMomentum();if(t)return new Vf({view:this.view,momentum:t,zoomCenter:this.beginCenter});const i=this.rotationMomentumEstimator.evaluateMomentum();if(i)return new Lf({view:this.view,momentum:i,center:this.beginCenter,axis:wo(this.planeHorizontal)});const r=this.panMomentumEstimator.evaluateMomentum();return r?new Of({view:this.view,momentum:r}):null}computePlanePoints(e,t,i,r){r.length=e.size;const s=this.tmp2d;let a=0;return e.forEach((e=>{s[0]=e.x,s[1]=e.y,void 0===r[a]&&(r[a]=fe()),rg(t,i,s,r[a]),a+=1})),r}};e([le({constructOnly:!0})],Gf.prototype,"view",void 0),Gf=e([ce("esri.views.3d.state.controllers.local.PinchAndPanController")],Gf);class Wf extends Ao{constructor(e,t,i){super(!0),this.view=e,this.pointerAction=t,this.lastEndTimestamp=0,this.lastTimestamp=0,this.registerIncoming("drag",i,(e=>this.handleDrag(e)))}handleDrag(e){if("mouse"===e.data.pointerType&&!ti(e.data,this.pointerAction))return;const t=e.timestamp-this.lastEndTimestamp,i=this.momentum&&this.momentum.active&&t<40;switch(e.data.action){case"start":case"update":if(i)break;this.controller&&this.controller.active?e.data.timestamp-this.lastTimestamp>2&&(this.controller.update(e.data),this.lastTimestamp=e.timestamp):this.startController(e);break;case"end":case"removed":this.endController(e,!0);break;case"added":this.endController(e,!1),this.startController(e)}e.stopPropagation()}endController(e,t){if(this.controller&&this.controller.active){this.lastEndTimestamp=e.timestamp;const i=this.controller.end(e.data);t&&i&&(this.momentum=i,this.view.state.switchCameraController(this.momentum))}this.controller=null}startController(e){this.controller=this.createController(),this.view.state.switchCameraController(this.controller),this.controller.begin(e.data),this.lastTimestamp=e.timestamp}createController(){return this.view.state.isGlobal?new Hf({view:this.view}):new Gf({view:this.view})}}class Qf extends Ao{constructor(e,t){super(!0),this.view=e,this.registerIncoming("pointer-down",t,(()=>this.view.state.stopActiveCameraController()))}}class Zf extends Ao{constructor(e,t){super(!0),this.key=e,this.registerIncoming("key-down",t,(e=>this._handleKeyDown(e)))}_handleKeyDown(e){e.data.key===this.key&&(this.activate(),e.stopPropagation())}}class Yf extends Zf{constructor(e,t,i){super(t,i),this.view=e}activate(){this.view.goTo({heading:0}).catch((()=>{}))}}class Xf extends Zf{constructor(e,t,i){super(t,i),this.view=e}activate(){this.view.goTo({tilt:0}).catch((()=>{}))}}class Kf extends Ao{constructor(e,t=!1){super(!0),this.view=e,this.invert=t,this.registerIncoming("vertical-two-finger-drag",(e=>this.handleTwoFinger(e)))}handleTwoFinger(e){var t,i,r;const s=this.invert?-1:1,a=ie(0,e.data.delta*s);switch(e.data.action){case"begin":null==(t=this.cameraController)||t.end(),this.cameraController=new nf({view:this.view,pivot:0}),this.view.state.switchCameraController(this.cameraController),this.cameraController.begin(a);break;case"update":null==(i=this.cameraController)||i.update(a);break;case"end":null==(r=this.cameraController)||r.end(),this.cameraController=null}}}class Jf extends Ao{constructor(e=20,t=40){super(!1),this._threshold=e,this._maxDelta=t,this.state="ready",this.emittedArtificalEnd2=!1,this._vertical=this.registerOutgoing("vertical-two-finger-drag"),this._artificalDrag=this.registerOutgoing("drag"),this.dragEventSeparator=new ai({start:(e,t)=>this.observeStart(e,t),update:(e,t,i)=>this.observeUpdate(e,t,i),end:(e,t)=>this.observeEnd(t)}),this.registerIncoming("drag",(e=>this.dragEventSeparator.handle(e)))}get failed(){return"failed"===this.state}observeStart(e,t){1===e&&this.emittedArtificalEnd2&&(this.emittedArtificalEnd2=!1,this._artificalDrag.emit({action:"start",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),t.stopPropagation()),this.state=2===e?"ready":"failed"}observeUpdate(e,t,i){if("failed"!==this.state&&2===e)return"active"===this.state?(this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"update"}),void t.stopPropagation()):void(this.checkMovementWithinLimits(t.data,i.data)?this.checkVerticalThresholdReached(t.data,i.data)&&(this.state="active",this.emittedArtificalEnd2=!0,this._thresholdReachedCenter=t.data.center,this._artificalDrag.emit({action:"end",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"begin"}),t.stopPropagation()):this.state="failed")}observeEnd(e){"active"===this.state&&(this._vertical.emit({delta:e.data.center.y-this._thresholdReachedCenter.y,action:"end"}),this.state="ready",e.stopPropagation())}checkMovementWithinLimits(e,t){let i=-1/0,r=1/0,s=-1/0,a=1/0;t.pointers.forEach((e=>{i=Math.max(i,e.x),r=Math.min(r,e.x),s=Math.max(s,e.y),a=Math.min(a,e.y)}));let n=-1/0,o=1/0,l=-1/0,h=1/0;e.pointers.forEach((e=>{n=Math.max(n,e.x),o=Math.min(o,e.x),l=Math.max(l,e.y),h=Math.min(h,e.y)}));const c=i-r,d=s-a,u=n-o,p=l-h;return Math.abs(e.center.x-t.center.x)<this._threshold&&Math.abs(u-c)<=this._maxDelta&&Math.abs(p-d)<=this._maxDelta}checkVerticalThresholdReached(e,t){let i=Math.abs(e.center.y-t.center.y);return e.pointers.forEach(((e,r)=>{const s=t.pointers.get(r);i=Math.min(i,Math.abs(e.y-s.y))})),i>=this._threshold}}let $f=class extends yi{constructor(){super(...arguments),this._handles=new ar}destroy(){this._handles&&(this._handles.removeAll(),this._handles=null),this.disconnect()}get primaryDragAction(){return this._get("primaryDragAction")}set primaryDragAction(e){"pan"!==e&&"rotate"!==e||e===this._get("primaryDragAction")||(this._set("primaryDragAction",e),this._updateMode())}get mode(){return this._get("mode")}set mode(e){"default"!==e&&"pro"!==e||e===this._get("mode")||(this._set("mode",e),this._updateMode())}disconnect(){this.view.viewEvents.disconnect(),this._inputManager&&(this._inputManager.destroy(),this._inputManager=null),this._source&&(this._source.destroy(),this._source=null)}connect(){const e=this.view;this._source=new ni(this.view.surface,e.input);const t=[new oi,new li,new hi,new ci(this.view.navigation),new Jf],i=new Oo({eventSource:this._source,recognizers:t});this._inputManager=i,i.installHandlers("prevent-context-menu",[new di],Fo.INTERNAL),this._modeDragPan=new Wf(e,"primary"),this._modeDragRotate=new lf(e,"secondary",0),this._modeDragZoom=new pf(e,"tertiary");const r="b",s={left:"ArrowLeft",right:"ArrowRight",forward:"ArrowUp",backward:"ArrowDown",up:"u",down:"j",headingLeft:"a",headingRight:"d",tiltUp:"w",tiltDown:"s",zoomIn:"+",zoomOut:"-"},a="n",n="p";i.installHandlers("navigation",[new Qf(e),new sf(e),new Pf(e),new Rf(e,s),new Mf(e),new Xf(e,n),new Yf(e,a),new lf(e,"primary",1,[r]),new lf(e,"secondary",0,[r]),new Wf(e,"tertiary",[r]),this._modeDragRotate,this._modeDragZoom,this._modeDragPan,new Kf(e)],Fo.INTERNAL),this.view.viewEvents.connect(i),this._updateMode(),Y(this.view.navigation,"browserTouchPanEnabled",(e=>{this._source.browserTouchPanningEnabled=!e}))}_updateMode(){const e=this.mode,t=this.primaryDragAction,i=ev.get(e).get(t);this._modeDragPan&&(this._modeDragPan.pointerAction=i.pan),this._modeDragRotate&&(this._modeDragRotate.pointerAction=i.rotate),this._modeDragZoom&&(this._modeDragZoom.pointerAction=i.zoom)}get test(){return{inputManager:this._inputManager,modeDragPan:this._modeDragPan,modeDragRotate:this._modeDragRotate,modeDragZoom:this._modeDragZoom}}};e([le()],$f.prototype,"view",void 0),e([le({value:"pan"})],$f.prototype,"primaryDragAction",null),e([le({value:"default"})],$f.prototype,"mode",null),e([le({readOnly:!0,aliasOf:"_inputManager.hasPendingInputs"})],$f.prototype,"hasPendingInputs",void 0),e([le({readOnly:!0,aliasOf:"_inputManager.latestPointerType"})],$f.prototype,"latestPointerType",void 0),e([le()],$f.prototype,"_inputManager",void 0),$f=e([ce("esri.views.3d.input.SceneInputManager")],$f);const ev=new Map,tv=new Map,iv=new Map;tv.set("pan",{pan:"primary",rotate:"secondary",zoom:"tertiary"}),tv.set("rotate",{pan:"secondary",rotate:"primary",zoom:"tertiary"}),iv.set("pan",{pan:"primary",rotate:"tertiary",zoom:"secondary"}),iv.set("rotate",{pan:"tertiary",rotate:"primary",zoom:"secondary"}),ev.set("default",tv),ev.set("pro",iv);var rv=$f;let sv,av,nv=!1,ov=!1,lv=!1,hv=!1,cv=null;function dv(e){lv=ma.DECONFLICTOR_SHOW_VISIBLE,hv=ma.DECONFLICTOR_SHOW_INVISIBLE,nv=lv||hv,ov=ma.DECONFLICTOR_SHOW_GRID,cv=null,nv||ov?cv=()=>function(e){null==sv&&(sv=document.createElement("canvas"),sv.setAttribute("id","canvas2d"),e.surface.parentElement.style.position="relative",e.surface.parentElement.appendChild(sv));const t=e.width*e.pixelRatio,i=e.height*e.pixelRatio;sv.setAttribute("width",`${t}px`),sv.setAttribute("height",`${i}px`),sv.setAttribute("style",`position:absolute;left:0px;top:0px;display:block;pointer-events:none;width:${e.width}px;height:${e.height}px`),av=sv.getContext("2d"),av.clearRect(0,0,e.width,e.height),av.font="12px Arial"}(e):sv&&(sv.parentElement.removeChild(sv),sv=null)}function uv(){cv&&(cv(),cv=null)}function pv(e,t,i,r,s){uv();const a=sv.height,n=av;n.beginPath(),n.lineWidth=1,n.strokeStyle=s,n.moveTo(e,a-i),n.lineTo(t,a-i),n.stroke(),n.lineTo(t,a-r),n.stroke(),n.lineTo(t,a-i),n.stroke(),n.lineTo(e,a-i),n.stroke(),n.lineTo(e,a-i),n.stroke(),n.closePath()}function mv(e,t){nv&&(t&&lv||!t&&hv)&&pv(e.aabr[0],e.aabr[2],e.aabr[1],e.aabr[3],t?"green":"red")}const gv=fe(),fv=nr(),vv=nr(),_v=fe(),yv=Ar(),xv=$a(),wv=Xn(),bv=fe(),Cv=Ct();class Tv{constructor(){this.aabr=Ct(),this.distance=0,this.culled=!1,this.visible=!1}}class Sv{constructor(e,t,i={}){this.graphics3DGraphic=e,this.slicePlaneEnabled=t,this.info=i}}class Pv{constructor(){this.active=new Map,this.visible=new Map}clear(){this.active.clear(),this.visible.clear()}}class Rv{}class Mv{constructor(){this.sortArray=new N({allocator:e=>e||new Rv})}}class Dv{constructor(){this.camera=new co,this.slicePlane=Gt(),this.slicePlaneEnabled=!1}copyFrom(e){this.camera.copyFrom(e.camera),Wt(e.slicePlane,this.slicePlane),this.slicePlaneEnabled=e.slicePlaneEnabled}}let Av=class extends yi{constructor(){super(...arguments),this._dirty=!1,this._runningViewState=new Dv,this._state=0,this.graphics=new Pv,this.iterators=new Mv,this.accBinsNumX=15,this.accBinsNumY=20,this.accBinsSizeX=0,this.accBinsSizeY=0,this.accBins=null,this.accNumTests=0}get dirty(){return this._dirty}get state(){return this._state}destroy(){this.graphics.clear(),this.iterators=null}setDirty(){!this._dirty&&this.graphics.active.size>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return 0!==this._state||this._dirty}get updatingProgress(){if(!this.updating)return 1;const e=this._state/4;return this._dirty?.5*e:e}get running(){return this.view.ready&&null!=this.view.state&&this.updating}runTask(e){switch(this._state){case 0:this.startUpdate(),e.madeProgress();case 1:if(this._state=1,!this.processActiveGraphics(e))return;case 2:if(this._state=2,!this.sortVisibleGraphics(e))return;case 3:if(this._state=3,!this.deconflictVisibleGraphics(e))return;default:!function(e,t){if(!ov||!av)return;uv();const i=av;let r=0;for(let t=0;t<e.accBinsNumX;t++)for(let s=0;s<e.accBinsNumY;s++){const a=e.accBins[t][e.accBinsNumY-1-s];r+=a.length;const n=t*e.accBinsSizeX,o=(t+1)*e.accBinsSizeX,l=s*e.accBinsSizeY,h=(s+1)*e.accBinsSizeY;i.fillText(a.length.toFixed(),n+5,l+15),pv(n,o,l,h,"blue")}i.fillText("total totalShownLabels: "+r,70,40),i.fillText("total visible labels: "+t.size,70,50),i.fillText("total numTests: "+e.accNumTests,70,30)}(this,this.graphics.visible),this._state=0,this.notifyChange("updating")}}modifyGraphics(e,t){t?e.forEach((e=>this.addToActiveGraphics(e))):e.forEach((e=>this.removeFromActiveGraphics(e))),this.setDirty()}layerSupportsDeconfliction(e){if(M(e)||"object3d"!==e.type)return!1;const t=e.stageObject;if(1!==(t?t.getNumGeometryRecords():0))return!1;return t.getGeometryRecord(0).material instanceof Hn}startUpdate(){dv(this.view),this._dirty=!1,this._runningViewState.copyFrom(this.viewState);const{fullWidth:e,fullHeight:t}=this._runningViewState.camera;this.initBins(e,t),this.resetIterators()}addToActiveGraphics(e){e.info[this.visibilityGroup]=new Tv,this.graphics.active.set(e.graphics3DGraphic.graphic.uid,e),this.setDirty()}removeFromActiveGraphics(e){this.removeFromVisibleGraphics(e),function(e,t){const i=e.graphics3DGraphic;i.destroyed||i.clearVisibilityFlag(3,t)}(e,this.visibilityGroup),delete e.info[this.visibilityGroup],this.graphics.active.delete(e.graphics3DGraphic.graphic.uid),this.setDirty()}addToVisibleGraphics(e){this.graphics.visible.set(e.graphics3DGraphic.graphic.uid,e)}removeFromVisibleGraphics(e){this.graphics.visible.delete(e.graphics3DGraphic.graphic.uid)}processActiveGraphics(e){const t=this.ensureActiveGraphicsIterator(),i=_r(yv,this._runningViewState.camera.projectionMatrix),r="global"===this.view.viewingMode&&1===this.view.map.ground.opacity&&this._runningViewState.camera.relativeElevation>0?xv:null;let s=0;for(C(r)&&(Le(r,qe,this._runningViewState.camera.viewMatrix),r[3]=wt(this.view.spatialReference).radius,s=en(r,qe));!e.done;){e.madeProgress();const a=t.next();if(a.done)return this.resetActiveGraphicsIterator(),!0;const n=a.value,o=n&&n.info[this.visibilityGroup];o&&(this.collectGraphics3DGraphics(n,i,r,s),o.culled?this.removeFromVisibleGraphics(n):this.addToVisibleGraphics(n))}return!1}sortVisibleGraphics(e){const t=this.ensureSortGraphicsIterator();for(;!e.done;){const i=t.next();if(e.madeProgress(),i.done)return this.resetSortGraphicsIterator(),!0}return!1}deconflictVisibleGraphics(e){const t=this.ensureVisibleGraphicsIterator(),i=1===this.visibilityGroup;for(;!e.done;){e.madeProgress();const r=t.next();if(r.done)return this.resetVisibleGraphicsIterator(),!0;const s=r.value,a=s.info[this.visibilityGroup];if(!a||a.culled)continue;const n=s.graphics3DGraphic,o=(!i||n.isVisible())&&!this.isConflicted(s);o&&this.addToBins(s),a.visible=o,this.setGraphicVisibility(s,o),mv(a,o)}return!1}resetIterators(){this.iterators.active=null,this.iterators.visible=null,this.iterators.sort=null}ensureActiveGraphicsIterator(){return this.iterators.active||(this.iterators.active=Ov(this.graphics.active)),this.iterators.active}resetActiveGraphicsIterator(){this.iterators.active=null}ensureVisibleGraphicsIterator(){return this.iterators.visible||(this.iterators.visible=Ov(this.graphics.visible)),this.iterators.visible}resetVisibleGraphicsIterator(){this.iterators.visible=null}ensureSortGraphicsIterator(){return this.iterators.sort||(this.iterators.sort=function*(e,t,i){t.clear(),e.forEach(((e,r)=>{const s=t.pushNew();s.id=r,s.prio=e.info?-e.info[i].distance:Number.MAX_VALUE})),yield;const r=t.iterableSort(((e,t)=>t.prio-e.prio));for(let e=r.next();!e.done;e=r.next())yield;t.forAll((t=>{const i=e.get(t.id);i&&(e.delete(t.id),e.set(t.id,i))})),t.clear()}(this.graphics.visible,this.iterators.sortArray,this.visibilityGroup)),this.iterators.sort}resetSortGraphicsIterator(){this.iterators.sort=null}collectGraphics3DGraphics(e,t,i,r){const s=e.graphics3DGraphic;if(s.destroyed)return;const a=e.info[this.visibilityGroup];if(!s.isVisible(0,3))return void(a.culled=!0);const n=this.getGraphicsLayers(s);Tt(a.aabr);let o=null;for(const s of n){if(!this.layerSupportsDeconfliction(s))continue;const n=s.stageObject.getGeometryRecord(0).material;if(M(o)){if(o=this.getProjectionInfo(s,t,Iv),o.isOutsideScreen||this.isCulledBySlice(e,gv)||C(i)&&this.isCulledByHorizon(o,i,r))return void(a.culled=!0);!ma.DISABLE_DECONFLICTOR_VISIBILITY_OFFSET&&a.visible&&(o.distance*=.7)}this.expandBoundingRect(a,s,n,o)}M(o)?a.culled=!0:(a.distance=o.distance,a.culled=!1)}getProjectionInfo(e,t,i){const r=this._runningViewState.camera,s=e.stageObject,a=s.getGeometryRecord(0),n=a.material,o=tn(s.boundingVolumeWorldSpace.bounds);Le(gv,o,r.viewMatrix);const l=a.geometry.vertexAttributes,h=l.get("normal").data,c=l.get("auxpos1").data;return n.applyShaderOffsetsView(gv,h,s.transformation,c,r,i.scaleInfo,gv),Re(fv,gv[0],gv[1],gv[2],1),He(vv,fv,r.projectionMatrix),Ce(i.positionNDC,vv,1/vv[3]),n.applyShaderOffsetsNDC(i.positionNDC,c,r,i.positionNDC,_v),i.distanceWithoutPolygonOffset=r.depthNDCToWorld(_v[2]),i.distance=_v[2]===i.positionNDC[2]?i.distanceWithoutPolygonOffset:r.depthNDCToWorld(i.positionNDC[2]),Re(vv,i.positionNDC[0],i.positionNDC[1],i.positionNDC[2],1),He(fv,vv,t),Be(fv,fv,1/fv[3]),ve(i.positionView,gv[0],gv[1],gv[2]),i}isCulledByHorizon(e,t,i){return ye(wv.direction,e.positionView),ve(wv.origin,0,0,0),!!Qa(t,wv,bv)&&e.distanceWithoutPolygonOffset>i}isCulledBySlice(e,t){return e.slicePlaneEnabled&&this._runningViewState.slicePlaneEnabled&&Nt(this._runningViewState.slicePlane,t)}expandBoundingRect(e,t,i,{positionNDC:r,scaleInfo:s}){const a=this._runningViewState.camera,n=t.getScreenSize(Fv);Ps(n,s.factor,n),n[0]*=a.pixelRatio,n[1]*=a.pixelRatio;const o=St(i.calculateRelativeScreenBounds(n,s.factorAlignment.scale,Cv),Me(0,a.fullWidth,.5+.5*r[0]),Me(0,a.fullHeight,.5+.5*r[1])),l=this.iconMarginFactor;if(0!==l){const e=l*Math.min(Pt(o),Rt(o));o[0]-=e,o[1]-=e,o[2]+=e,o[3]+=e}Mt(e.aabr,o,e.aabr)}isConflicted(e){const t=e.graphics3DGraphic.graphic.uid,i=e.info[this.visibilityGroup];for(let e=Math.floor(i.aabr[0]/this.accBinsSizeX);e<=Math.floor(i.aabr[2]/this.accBinsSizeX);e++)if(!(e<0||e>=this.accBinsNumX))for(let r=Math.floor(i.aabr[1]/this.accBinsSizeY);r<=Math.floor(i.aabr[3]/this.accBinsSizeY);r++){if(r<0||r>=this.accBinsNumY)continue;const s=this.accBins[e][r];for(let e=0;e<s.length;e++){const r=s.data[e],a=r.info[this.visibilityGroup];if(a&&a.visible&&(r.graphics3DGraphic.graphic.uid!==t&&(this.accNumTests++,Dt(a.aabr,i.aabr))))return!0}}return!1}initBins(e,t){if(null==this.accBins){this.accBins=[];for(let e=0;e<this.accBinsNumX;e++){this.accBins.push([]);const e=this.accBins[this.accBins.length-1];for(let t=0;t<this.accBinsNumY;t++)e.push(new N)}}else for(let e=0;e<this.accBinsNumX;e++)for(let t=0;t<this.accBinsNumY;t++)this.accBins[e][t].clear();this.accBinsSizeX=e/this.accBinsNumX,this.accBinsSizeY=t/this.accBinsNumY,this.accNumTests=0}addToBins(e){const t=e.info[this.visibilityGroup],i=Math.floor(t.aabr[0]/this.accBinsSizeX),r=Math.floor(t.aabr[2]/this.accBinsSizeX),s=Math.floor(t.aabr[1]/this.accBinsSizeY),a=Math.floor(t.aabr[3]/this.accBinsSizeY);for(let t=i;t<=r;t++)if(!(t<0||t>=this.accBinsNumX))for(let i=s;i<=a;i++)i<0||i>=this.accBinsNumY||this.accBins[t][i].push(e)}setGraphicVisibility(e,t){const i=e.graphics3DGraphic;i.destroyed||(i.setVisibilityFlag(3,t,this.visibilityGroup),1===this.visibilityGroup&&this.view.labeler.setLabelGraphicVisibility(i,t))}};function*Ov(e){if(Map.prototype.entries){const t=e.entries();for(let e=t.next();!e.done;e=t.next())yield e.value[1]}else yield*e.values()}e([le({constructOnly:!0})],Av.prototype,"view",void 0),e([le({type:Boolean,readOnly:!0})],Av.prototype,"updating",null),Av=e([ce("esri.views.3d.layers.graphics.Deconflictor")],Av);const Fv=Nr();const Iv=new class{constructor(){this.positionView=fe(),this.positionNDC=fe(),this.distance=0,this.distanceWithoutPolygonOffset=0,this.scaleInfo={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}}}get isOutsideScreen(){const e=this.positionNDC;return e[0]<-1||e[1]<-1||e[2]<-1||e[0]>=1||e[1]>=1}};let zv=class extends Av{constructor(){super(...arguments),this.visibilityGroup=1,this.iconMarginFactor=0,this._lastDeconfliction=0}get viewState(){return this.parent.viewState}runTask(e){if(this.parent.running)return;const t=performance.now();(2===e.state||t-this._lastDeconfliction>2e3)&&(super.runTask(e),0===this.state&&(this._lastDeconfliction=t))}enabledChanged(e,t){this.modifyGraphics(t,e.labelsEnabled)}getGraphicsLayers(e){return e.labelGraphics}};e([le({constructOnly:!0})],zv.prototype,"parent",void 0),zv=e([ce("esri.views.3d.layers.graphics.LabelDeconflictor")],zv);let Ev=class extends Av{constructor(){super(...arguments),this._handles=new ar,this._contexts=new Map,this._viewState=new Dv,this.visibilityGroup=0,this._iconMarginFactor=-.1}get labels(){return this._labels}get viewState(){return this._viewState}initialize(){this._handles.add([this.view.watch("state.camera",(()=>{this.updateViewState(),this.setDirty()})),this.view.watch("map.ground.opacity",((e,t)=>{1!==e&&1!==t||this.setDirty()})),Y(this.view,"slicePlane",(()=>{this.updateSlicePlane(),this.slicePlaneChanged()}))]),this._frameTask=this.view.resourceController.scheduler.registerTask(qo.GRAPHICS_DECONFLICTOR,this),this._labels=new zv({view:this.view,parent:this})}destroy(){this._labels.destroy(),this._labels=null,this._handles.destroy(),this._handles=null,this._frameTask&&(this._frameTask.remove(),this._frameTask=null)}get iconMarginFactor(){return this._iconMarginFactor}set iconMarginFactor(e){this._iconMarginFactor=e,this.setDirty()}setDirty(){this._contexts.size>0&&(super.setDirty(),this._labels.setDirty())}runTask(e){super.runTask(e),this.running||this._labels.setDirty()}setInitialIconVisibilityFlag(e,t){const i=!(this._graphicSupportsDeconfliction(t)&&Lv(e));t.setVisibilityFlag(3,i,0)}updateViewState(){this.view&&this.view.state&&(this._viewState.camera.copyFrom(this.view.state.camera),this.updateSlicePlane())}updateSlicePlane(){const e=this.view?this.view.slicePlane:null;C(e)&&Qt(e,this._viewState.camera.viewMatrix,this._viewState.slicePlane),this._viewState.slicePlaneEnabled=C(e)}slicePlaneChanged(){Uo(this._contexts,((e,t)=>t.symbolCreationContext.slicePlaneEnabled))&&this.setDirty()}addGraphicsOwner(e){let t=this._contexts.get(e);return null==t&&(t=new Map,this._contexts.set(e,t),this.setDirty()),{addGraphic:i=>this.addGraphic(e,t,i),removeGraphic:e=>this.removeGraphic(t,e),labelingInfoChange:()=>this._labels.enabledChanged(e,t),featureReductionChange:()=>this.enabledChanged(e,t),slicePlaneEnabledChange:()=>this._slicePlaneEnabledChanged(e,t),clear:()=>t.forEach((e=>this.removeGraphic(t,e.graphics3DGraphic)))}}removeGraphicsOwner(e){const t=this._contexts.get(e);t&&(t.forEach((e=>this.removeGraphic(t,e.graphics3DGraphic))),this._contexts.delete(e),this.setDirty())}addGraphic(e,t,i){const r=i.graphic.uid,s=new Sv(i,e.symbolCreationContext.slicePlaneEnabled);t.set(r,s),Lv(e)&&this.addToActiveGraphics(s),e.labelsEnabled&&this._labels.addToActiveGraphics(s)}removeGraphic(e,t){const i=t.graphic.uid,r=e.get(i);r&&(this.removeFromActiveGraphics(r),this._labels.removeFromActiveGraphics(r),e.delete(i),this.setDirty())}enabledChanged(e,t){const i=Lv(e);i||function(e){const t=e.graphics3DGraphics;t&&t.forEach((e=>e.clearVisibilityFlag(3)))}(e),this.modifyGraphics(t,i)}_slicePlaneEnabledChanged(e,t){const i=e.symbolCreationContext.slicePlaneEnabled;t.forEach((e=>e.slicePlaneEnabled=i)),this.setDirty()}getGraphicsLayers(e){return e.graphics}_graphicSupportsDeconfliction(e){if(e.isDraped)return!1;const t=e.graphics;if(!t||!t.length)return!1;for(const e of t)if(this.layerSupportsDeconfliction(e))return!0;return!1}};function Lv(e){const t=e.layer;return!(!t||!t.featureReduction||"selection"!==t.featureReduction.type)}function Vv(e){return e instanceof Jn?e.graphics3DSymbol:e instanceof $n?e:null}Ev=e([ce("esri.views.3d.layers.graphics.GraphicsDeconflictor")],Ev);const kv=U.getLogger("esri.views.3d.layers.graphics.labelPlacement");function jv(e){const t=function(e){const t=e.labelClass.labelPlacement,{labelSymbol:i,graphics3DGraphic:r}=e,s=Vv(r.graphics3DSymbol),a=C(s)?s.symbol:null,n=Gv[t]||Hv(e);if("point-3d"===a.type&&a.supportsCallout()&&a.hasVisibleVerticalOffset()&&!r.isDraped)return{placement:null,hasLabelVerticalOffset:!1,verticalOffset:Nv(a.verticalOffset),anchor:null,normalizedOffset:null};if(i&&i.hasVisibleVerticalOffset()&&("point-3d"!==a.type||!a.supportsCallout()||!a.verticalOffset||r.isDraped))return function(e){if("above-center"===e)return!0;return!1}(n.placement)?{placement:"above-center",verticalOffset:Nv(i.verticalOffset),anchor:"bottom",normalizedOffset:[0,n.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(kv.errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+t+" placement)"),null);return{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}}(e);if(M(t))return null;const i=function(e,t){if(t.anchor)return t;const i=e.labelClass.labelPlacement,r=Gv[i],s=r||Hv(e);i&&!r&&kv.warnOncePerTick(`the requested label placement '${i}' is not currently supported in SceneView`);return function(e,t){const i=t.graphics3DGraphic.graphic.geometry;if(M(i))return null;if(C(t.disablePlacement)){return t.labelClass.labelPlacement?(kv.warnOncePerTick(qv(e.placement,t.disablePlacement.logEntityDescription)),Hv(t)):e}const r=i.type;switch(r){case"polyline":case"polygon":case"extent":case"multipoint":if(t.labelClass.labelPlacement)return kv.warnOncePerTick(qv(e.placement,`'${r}' geometries`)),Hv(t);break;case"point":case"mesh":return e}return e}(s,e)}(e,t);if(M(i))return null;const r=i.anchor,s=!!t.hasLabelVerticalOffset;return function(e,t,i){const r=i.graphics3DGraphic.graphic.geometry;if(M(r))return null;switch(r.type){case"point":!function(e,t,i){const r=Uv(i);if(M(r))return;const s=i.graphics3DGraphic.graphics[0];C(s)?s.getCenterObjectSpace(e.translation):ve(e.translation,0,0,0);switch(r.type){case"icon":case"text":!function(e,t,i,r){const{graphics3DGraphic:s}=i,a=C(r)?r.getScreenSize():null;if(!s.isDraped&&C(a)){const r=function(e,t=Zv){const{graphics3DGraphic:i}=e,r=i.graphics[0],s=C(r)?r.stageObject.geometryRecords[0].material:null;if(s&&s instanceof Hn){const e=s.params.anchorPos;t[0]=2*(e[0]-.5),t[1]=2*(e[1]-.5)}else t[0]=0,t[1]=0;return t}(i);Qv[0]=a[0]/2*(t.normalizedOffset[0]-r[0]),Qv[1]=a[1]/2*(t.normalizedOffset[1]-r[1]),e.screenOffset[0]=Qv[0],e.hasLabelVerticalOffset?(e.centerOffset[1]=Qv[1],e.centerOffsetUnits="screen"):e.screenOffset[1]=Qv[1]}else e.hasLabelVerticalOffset||"center"===e.anchor||(Gv[i.labelClass.labelPlacement]&&kv.warnOncePerTick(`the requested placement '${t.placement}' is currently unsupported for draped graphics`),e.anchor="center")}(e,t,i,s);break;case"object":Bv(e,t,s)}}(e,t,i);break;case"polygon":!function(e,t,i){const r=Uv(i);if(M(r))return;switch(r.type){case"extrude":{const r=i.graphics3DGraphic.graphics[0];C(r)?(r.getBoundingBoxObjectSpace(Yv),el(Yv,e.translation),e.translation[2]=tl(Yv)/2):ve(e.translation,0,0,0),Bv(e,t,r);break}}}(e,t,i);break;case"mesh":Bv(e,t,i.graphics3DGraphic.graphics[0])}return e}({anchor:r,verticalOffset:t.verticalOffset,screenOffset:Nr(),centerOffset:or(0,0,0,-1),centerOffsetUnits:"world",translation:fe(),elevationOffset:0,hasLabelVerticalOffset:s},i,e)}function Uv(e){const t=Vv(e.graphics3DGraphic.graphics3DSymbol);return C(t)?t.symbol.symbolLayers.getItemAt(0):null}function qv(e,t){return`the requested label placement '${e}' is currently unsupported for ${t} in SceneView`}function Hv(e){const t=e.graphics3DGraphic.graphic.geometry;if(M(t))return null;switch(t.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:null,anchor:"center"};case"polygon":{const t=Uv(e);return C(t)&&"extrude"===t.type?Gv["above-center"]:{placement:"center-center",normalizedOffset:null,anchor:"center"}}case"point":case"mesh":return Gv["above-center"];default:return}}function Bv(e,t,i){const r=C(i)?i.getBoundingBoxObjectSpace(Yv):Yv,s=ge(r[3]-r[0],r[4]-r[1],r[5]-r[2]),a=Math.sqrt(s[0]*s[0]+s[1]*s[1]);e.centerOffset[0]=a/2*t.normalizedOffset[0];const n=e.translation[2],o=s[2]/2*t.normalizedOffset[1];e.translation[2]=0,e.elevationOffset=n+o;const l=_e(s);e.centerOffset[2]=l/2*t.normalizedOffset[2]}function Nv(e){const{screenLength:t,minWorldLength:i,maxWorldLength:r}=e;return{screenLength:t,minWorldLength:i,maxWorldLength:r}}const Gv={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},Wv={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const e in Wv){const t=Wv[e],i=Gv[e];t.forEach((e=>{Gv[e]=i}))}Object.freeze&&(Object.freeze(Gv),Object.keys(Gv).forEach((function(e){Object.freeze(Gv[e]),Object.freeze(Gv[e].normalizedOffset)})));const Qv=[0,0],Zv=[0,0],Yv=$o();class Xv{constructor(e){this._stage=e,this._materials=new Map}get(e){return this._materials.get(e)}add(e,t){this._materials.set(e,t),this._stage.add(t)}dispose(){this._stage.removeMany(Array.from(this._materials.values())),this._materials.clear()}}var Kv;let Jv=Kv=class extends yi{constructor(e){super(e),this.type=4,this.id=wi(),this.events=new tr,this.glTexture=null,this.needsClear=!1,this.elementsToAddOrUpdate=new Map,this.elementsToRemove=new Map,this.elementsToRender=new Map,this.elements=new Map,this.stageObjects=new Map,this.updating=!1}initialize(){this.stage=this.view._stage,this.canvas=this.create2DCanvas(),this.ctx=this.canvas.getContext("2d"),this.stage.add(this);const e=this.computeAtlasResolution(this.view.width,this.view.height);this.createAtlasRegion(e),this.update2DCanvasSize(),this.resetAtlasCursor()}unload(){C(this.glTexture)&&(this.glTexture.dispose(),this.glTexture=null),this.events.emit("unloaded")}get width(){return this.atlas.size.width}get height(){return this.atlas.size.height}get requiresFrameUpdates(){return!1}createDescriptor(e){return{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,flipped:!0,samplingMode:9987,hasMipmap:!0,preMultiplyAlpha:!0,maxAnisotropy:e.parameters.maxMaxAnisotropy}}load(e){if(C(this.glTexture))return this.glTexture;this.glTexture=new Pn(e,this.createDescriptor(e),this.canvas);const t=this.view.resourceController.scheduler;return this.frameWorker=t.registerTask(qo.TEXT_TEXTURE_ATLAS,this),this.setDirty(),this.glTexture}dispose(){this.elements=null,this.elementsToAddOrUpdate=null,this.elementsToRemove=null,this.elementsToRender=null,this.frameWorker=I(this.frameWorker),this.glTexture&&(this.stage.remove(this),this.glTexture=null),this.canvas.width=0,this.canvas.height=0,this.canvas=null,this.ctx=null}create2DCanvas(){const e=document.createElement("canvas");return e.setAttribute("id","canvas2d"),e.setAttribute("style","display:none"),e.setAttribute("width",512..toString()),e.setAttribute("height",512..toString()),e}update2DCanvasSize(){this.canvas.setAttribute("width",this.atlas.size.width.toString()),this.canvas.setAttribute("height",this.atlas.size.height.toString())}createAtlasRegion(e=512){this.atlas={size:{width:e,height:e},cursor:{x:0,y:0},lineHeight:0}}computeAtlasResolution(e,t){let i=Math.max(e,t);return i+=256,i=Ne(i),i=Math.min(i,4096),i}resizeAtlas(e,t){t=t||e;const i=this.atlas;i.size.width=e,i.size.height=t,C(this.glTexture)&&this.glTexture.resize(e,t),this.update2DCanvasSize()}resetAtlasCursor(){const e=this.atlas;e.cursor.x=$v,e.cursor.y=$v+e_,e.lineHeight=0,this.needsClear=!0}getAtlasUsage(){const e=this.atlas;return(e.cursor.x+e.cursor.y*e.size.width)/(e.size.width*e.size.height)}getExpectedAtlasUsage(){const e=this.elementsToRemove.size,t=this.elementsToAddOrUpdate.size,i=this.elements.size;return this.getAtlasUsage()/i*(i+t-e)}addAtlasElement(e,t,i,r){const s=this.atlas,{renderedWidth:a,renderedHeight:n,displayWidth:o,displayHeight:l}=e.textRenderer;e.placement.offset.x=s.cursor.x,e.placement.offset.y=s.cursor.y,e.placement.size.width=a,e.placement.size.height=n,e.placement.size.displayWidth=o,e.placement.size.displayHeight=l,e.placement.uvMinMax=[e.placement.offset.x/s.size.width,1-(e.placement.offset.y+n)/s.size.height,(e.placement.offset.x+a)/s.size.width,1-e.placement.offset.y/s.size.height],s.cursor.x+=i,s.lineHeight=Math.max(s.lineHeight,r),this.elements.set(t,e)}removeAtlasElement(e){if(e&&this.elements.has(e.textId)){const t=e.placement.offset,i=e.placement.size;this.ctx.clearRect(t.x,t.y,i.width,i.height),this.elements.delete(e.textId)}}ensureStageObjects(e){const t=this.stageObjects.get(e);if(t)return t;const i=new Set;return this.stageObjects.set(e,i),i}addStageObject(e,t){this.ensureStageObjects(e).add(t)}removeStageObject(e,t){const i=this.stageObjects.get(e);i&&i.delete(t)&&(t.geometries[0].vertexAttributes.get("size").data=[0,0],t.geometryVertexAttrsUpdated(0))}_processAddition(e,t){const i=this.atlas,r=e.textId,s=e.textRenderer.renderedWidth,a=e.textRenderer.renderedHeight,n=s+$v,o=a+$v+e_;if(i.cursor.x+n<i.size.width&&i.cursor.y+o<i.size.height)this.addAtlasElement(e,r,n,o),this.elementsToRender.set(r,e),this.elementsToAddOrUpdate.delete(r);else{if(!(i.cursor.y+o+i.lineHeight<i.size.height)){const e=this.getExpectedAtlasUsage(),r=e>.85&&i.size.width<4096;return r&&this.resizeAtlas(2*i.size.width,2*i.size.height),!t||!r&&e>.95&&4096===i.size.width?(this.processRemovals(),0):(this.repack(),1)}i.cursor.x=$v,i.cursor.y+=i.lineHeight,i.lineHeight=0,this.addAtlasElement(e,r,n,o),this.elementsToRender.set(r,e),this.elementsToAddOrUpdate.delete(r)}return 0}processRemovals(){this.elementsToRemove.forEach(((e,t)=>{const i=this.stageObjects.get(t);i&&0!==i.size||this.removeAtlasElement(e),i&&0===i.size&&this.stageObjects.delete(t)})),this.elementsToRemove.clear()}repack(){this.processRemovals(),this.elements.forEach(((e,t)=>{e.rendered=!1,this.elementsToAddOrUpdate.set(t,e)})),this.elements.clear(),this.resetAtlasCursor(),this.elementsToRender.clear()}processRenderingRequest(e){this.ctx.clearRect(e.placement.offset.x,e.placement.offset.y,e.placement.size.width,e.placement.size.height),e.textRenderer.render(this.ctx,e.placement.offset.x,e.placement.offset.y);const t=this.stageObjects.get(e.textId);t&&t.forEach((t=>{t.geometries[0].vertexAttributes.get("uv0").data=new Float32Array(e.placement.uvMinMax),t.geometries[0].vertexAttributes.get("size").data=[e.placement.size.displayWidth,e.placement.size.displayHeight],t.geometryVertexAttrsUpdated(0)})),e.rendered=!0}get running(){return this.updating}runTask(e,t=!0){if(!this.glTexture)return;let i=!1;if(Uo(this.elementsToAddOrUpdate,((e,r)=>{const s=this.elements.get(r);if(s&&s.rendered){const e=this.stageObjects.get(r);return e&&e.forEach((e=>{const t=e.geometries[0].vertexAttributes,i=this.elements.get(r);t.get("uv0").data=new Float32Array(i.placement.uvMinMax),t.get("size").data=new Float32Array([i.placement.size.displayWidth,i.placement.size.displayHeight]),e.geometryVertexAttrsUpdated(0)})),this.elementsToAddOrUpdate.delete(r),!1}return 1===this._processAddition(this.elementsToAddOrUpdate.get(r),t)&&(i=!0,!0)})),i)return void this.runTask(Ho,!1);let r=!1;this.elementsToRender.size>0&&this.needsClear&&(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.needsClear=!1),Uo(this.elementsToRender,((t,i)=>(this.processRenderingRequest(t),this.elementsToRender.delete(i),r=!0,e.madeProgress(),e.done))),r&&C(this.glTexture)&&this.glTexture.setData(this.canvas),this.updating=this.elementsToRender.size>0,!this.updating&&Kv.test.orderedRepackingEnabled&&this.repackOrdered()}addTextTexture(e,t){const i=e.key;this.elementsToAddOrUpdate.has(i)||this.elementsToAddOrUpdate.set(i,{textId:i,placement:{offset:{x:0,y:0},size:{width:0,height:0,displayWidth:0,displayHeight:0},uvMinMax:[]},textRenderer:e,rendered:!1}),this.addStageObject(i,t),this.elementsToRemove.delete(i),this.setDirty()}removeTextTexture(e,t){const i=e.key;this.elementsToRemove.set(i,this.elements.get(i)),this.removeStageObject(i,t)}setDirty(){this.updating=!0}repackOrdered(){if(0===this.elements.size)return;const e=[];this.elements.forEach(((t,i)=>e.push({element:t,key:i})));let t=!0;for(let i=0;i<e.length-1;i++)if(e[i].key.localeCompare(e[i+1].key)>0){t=!1;break}if(!t||this.elementsToRemove.size){e.sort(((e,t)=>e.key.localeCompare(t.key))),this.elements.clear();for(const{element:t,key:i}of e)this.elements.set(i,t);this.repack(),this.setDirty()}}get test(){const{elements:e,stageObjects:t,elementsToRemove:i,atlas:r}=this,s=this;return{elements:e,stageObjects:t,elementsToRemove:i,atlas:r,resizeAtlas:(e,t)=>s.resizeAtlas(e,t),run:(e,t)=>s.runTask(e,t)}}};Jv.test={orderedRepackingEnabled:!1},e([le({constructOnly:!0})],Jv.prototype,"view",void 0),e([le({type:Boolean})],Jv.prototype,"updating",void 0),Jv=Kv=e([ce("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],Jv);const $v=2,e_=2;var t_=Jv;const i_=U.getLogger("esri.views.3d.layers.graphics.Labeler");let r_=class extends yi{constructor(){super(...arguments),this._dirty=!1,this._labels=new Map,this._labelsToAdd=new Map,this._labelsToRemove=new Map,this._labelingContexts=new Array}setup(){this.dispose(),this._handles=new ar,this._handles.add([this.view.watch("state.camera",(()=>this.setDirty())),this.view.watch("pixelRatio",(()=>this._resetAllLabels())),this.view.resourceController.scheduler.registerTask(qo.LABELER,this)]),this._textTextureAtlas=new t_({view:this.view}),this._hudMaterialCollection=new Xv(this.view._stage),this._calloutMaterialCollection=new Xv(this.view._stage)}dispose(){this._handles=R(this._handles),this._textTextureAtlas=P(this._textTextureAtlas),this._hudMaterialCollection=P(this._hudMaterialCollection),this._calloutMaterialCollection=P(this._calloutMaterialCollection),this._labelingContexts.length=0,this._labels.clear(),this._labelsToAdd.clear(),this._labelsToRemove.clear()}_activateLabelingContext(e){e.labels.forEach(((e,t)=>{this._labels.set(t,e),e.graphics3DGraphic.setVisibilityFlag(0,!0,1)})),e.active=!0}_deactivateLabelingContext(e){e.labels.forEach(((e,t)=>{e.graphics3DGraphic.setVisibilityFlag(0,!1,1),this.setLabelGraphicVisibility(e.graphics3DGraphic,!1),this._labels.delete(t)})),e.active=!1}_addLabelTextureToAtlas(e){for(const t of e.graphics3DGraphic.labelGraphics){if(!t._labelClass)continue;const i=e.textRenderers[t._labelIndex];i&&this._textTextureAtlas.addTextTexture(i,t.stageObject)}e.rendered=!0}_removeLabelTextureFromAtlas(e){for(const t of e.graphics3DGraphic.labelGraphics){if(!t._labelClass)continue;const i=e.textRenderers[t._labelIndex];i&&this._textTextureAtlas.removeTextTexture(i,t.stageObject)}e.rendered=!1}get running(){var e;return!!this.view.ready&&(this._dirty||(null==(e=this._textTextureAtlas)?void 0:e.updating)||this.deconflictor.running)}runTask(e){this._updateLabels(e),!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(e)}_updateLabels(e){if(this._dirty){this._dirty=!1;for(const t of this._labelingContexts)if(s_(t)){if(!n_(t)){if(o_(t)){this._deactivateLabelingContext(t);continue}if(this._createLabelClassContext(t),a_(t)){this._dirty=!0;continue}if(!n_(t))continue}Uo(t.labelsToInitialize,((i,r)=>(this._ensureGraphics3DResources(i)&&(this._labels.set(r,i),this.deconflictor.setDirty(),e.madeProgress()),(i.visible&&i.hasTextTextureResources||!i.visible&&i.hasGraphics3DResources)&&(t.labelsToInitialize.delete(r),e.madeProgress()),e.done)))&&(this._dirty=!0)}this._labelsToRemove.forEach((e=>this._removeLabelTextureFromAtlas(e))),this._labelsToAdd.forEach((e=>this._addLabelTextureToAtlas(e))),this._labelsToRemove.clear(),this._labelsToAdd.clear(),this._dirty||this.notifyChange("updating")}}async _createLabelClassContextAsync(e){const t=e.labelClassAbortController.signal;await e.layer.when(),m(t),e.scaleVisibility&&e.scaleVisibility.updateScaleRangeActive();const i=e.graphics3DCore,r=i.layer,s=r.labelingInfo&&r.labelingInfo.filter((e=>!!e.symbol));if(!s||0===s.length)return;const a=new Array(s.length);let n=!1;await Go(s,(async(r,s)=>{const o=r.symbol,l=Vv(i.getOrCreateGraphics3DSymbol(o));if(M(l))return void i_.error("Failed to create Graphics3DSymbol for label");await l.load(),m(t);let h=null;Jo(o)&&o.hasVisibleCallout()&&(h=ro(o,i.symbolCreationContext),await h.load(),m(t));const c=await Wo(Ko(r,e.layer.fieldsIndex,this.view.spatialReference));m(t),!0===c.ok?a[s]={labelClass:r,labelFunction:c.value,graphics3DSymbol:l,graphics3DCalloutSymbolLayer:h,calloutSymbolLayerIndex:0,textRenderParameters:this._createTextRenderParameters(l.symbol)}:(i_.error(`Label expression failed to evaluate: ${c.error}`),n=!0)})),m(t),n||(e.labelClassContexts=a)}async _createLabelClassContext(e){return e.labelClassPromise||(e.labelClassPromise=this._createLabelClassContextAsync(e).catch((t=>{if(c(t))throw t;e.labelClassContexts=null})).then((()=>{e.labelClassAbortController=null,this.notifyChange("updating")})).catch((()=>{})),this.notifyChange("updating")),e.labelClassPromise}_createTextRenderParameters(e){const t=e.symbolLayers.getItemAt(0);return t&&"text"===t.type?eo.fromSymbol(t,this.view.pixelRatio):null}_destroyLabelClassContext(e){for(const t of e.labelClassContexts)--t.graphics3DSymbol.referenced,t.graphics3DSymbol=null;const t=e.labelClassAbortController;e.labelClassAbortController=h(),t&&t.abort(),e.labelClassContexts=[],e.labelClassPromise=null,this.notifyChange("updating")}_createTextSymbolGraphic(e,t,i,r,s){const a={text:e.text,centerOffset:i.centerOffset,translation:i.translation,elevationOffset:i.elevationOffset,screenOffset:i.screenOffset,anchor:i.anchor,centerOffsetUnits:i.centerOffsetUnits,verticalOffset:i.verticalOffset,debugDrawBorder:ma.LABELS_SHOW_BORDER,displayWidth:e.displayWidth,displayHeight:e.displayHeight};return l_.graphic=t,l_.renderingInfo=null,l_.layer=r,s.createLabel(l_,a,this._hudMaterialCollection,this._textTextureAtlas)}_createLineCalloutGraphic(e,t,i,r,s){const a={symbol:t,translation:r.translation,elevationOffset:r.elevationOffset,screenOffset:r.screenOffset,centerOffset:r.centerOffset,centerOffsetUnits:r.centerOffsetUnits,materialCollection:this._calloutMaterialCollection};return l_.graphic=e,l_.renderingInfo=a,l_.layer=s,i.createGraphics3DGraphic(l_)}_ensureGraphics3DResources(e){if(e.hasGraphics3DResources)return!1;const t=e.graphics3DGraphic;if(t.destroyed)return!1;this._ensureTextTextureResources(e);const i=e.labelingContext,r=i.labelClassContexts;if(!r||0===r.length||!i.emptySymbolLabelSupported&&0===t.graphics.length)return!1;let s=!1;const a=t.graphic,n=i.layer,o=Kt(i.layer),l=this.view._stage;for(let h=0;h<r.length;h++){const c=e.textRenderers[h];if(!c)continue;const d=r[h],u=d.graphics3DSymbol;let p=null;u.symbol&&"label-3d"===u.symbol.type&&(p=u.symbol);const m=u.symbolLayers[0];if(!m)continue;const g=d.labelClass,f=jv({graphics3DGraphic:t,labelSymbol:p,labelClass:g,disablePlacement:i.disablePlacement});if(M(f))continue;m.setElevationInfoOverride(i.elevationInfoOverride);const v=this._createTextSymbolGraphic(c,a,f,n,m);if(!v)return!1;v._labelClass=g,v._labelIndex=h,t.addLabelGraphic(v,l,i.stageLayer),t.setVisibilityFlag(0,o,1),t.clearVisibilityFlag(1,1),t.setVisibilityFlag(3,!1,1),s=!0;const _=d.graphics3DCalloutSymbolLayer;if(_&&f.hasLabelVerticalOffset){_.setElevationInfoOverride(i.elevationInfoOverride);const e=this._createLineCalloutGraphic(a,p,_,f,n);e&&(d.calloutSymbolLayerIndex=t.labelGraphics.length,t.addLabelGraphic(e,l,i.stageLayer))}break}return i.scaleVisibility&&s&&i.scaleVisibility.updateGraphicLabelScaleVisibility(t),e.hasGraphics3DResources=!0,!0}_destroyGraphics3DResources(e){const t=e.labelingContext.labelClassContexts;for(const i of e.graphics3DGraphic.labelGraphics){if(null==i._labelClass)continue;const e=t[i._labelIndex].graphics3DSymbol.symbolLayers[0];null!=e&&e.onRemoveGraphic(i)}e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1}_ensureTextTextureResources(e){if(e.hasTextTextureResources)return;const t=e.labelingContext,i=t.labelClassContexts;if(!i||0===i.length)return;const r=e.graphics3DGraphic.graphic;for(let s=0;s<i.length;s++){const a=i[s];if(e.textRenderers[s]=null,!a.textRenderParameters)continue;const n=a.labelFunction;let o;if("arcade"===n.type)try{const e=n.needsHydrationToEvaluate()?Qo(r,t.layer):r;o=n.evaluate(e)}catch(e){o=null}else o=n.evaluate(r);M(o)||""===o||/^\s+$/.test(o)||(e.textRenderers[s]=new to(o,a.textRenderParameters))}e.hasTextTextureResources=!0}_destroyTextTextureResources(e){e.textRenderers=[],e.hasTextTextureResources=!1}_addGraphic(e,t){const i={hasGraphics3DResources:!1,hasTextTextureResources:!1,visible:!1,rendered:!1,labelingContext:e,graphics3DGraphic:t,textRenderers:[]},r=t.graphic.uid;e.labels.set(r,i),e.labelsToInitialize.set(r,i),this.setDirty(),this.deconflictor.setDirty()}_removeGraphic(e,t){const i=t.graphic.uid,r=e.labels.get(i);r&&(this._destroyGraphic(r,i),e.labels.delete(i),e.labelsToInitialize.delete(i),this.setDirty(),this.deconflictor.setDirty())}_destroyGraphic(e,t){this._labels.has(t)&&(this._labels.delete(t),this._labelsToAdd.delete(t),this._labelsToRemove.delete(t)),e.hasTextTextureResources&&(this._removeLabelTextureFromAtlas(e),this._destroyTextTextureResources(e)),e.hasGraphics3DResources&&this._destroyGraphics3DResources(e)}async _labelingInfoChange(e,t){if(!t)return this._visibilityInfoChange(e),this._resetLabels(e),this._createLabelClassContext(e);for(const i of t){const t=e.labels.get(i);t&&(this._removeGraphic(e,t.graphics3DGraphic),this._addGraphic(e,t.graphics3DGraphic))}}_globalPropertyChanged(e,t){for(const i of t.labelClassContexts){const r=new Map;t.labels.forEach((e=>{const t=e.graphics3DGraphic;r.set(t.graphic.uid,t)}));const s=e=>e.labelGraphics[0];if(z(i.graphics3DSymbol.symbolLayers[0]).globalPropertyChanged(e,r,s),i.graphics3DCalloutSymbolLayer){const t=e=>e.labelGraphics[i.calloutSymbolLayerIndex];i.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,r,t)}}}_visibilityInfoChange(e){const t=e.layer.labelsVisible;t&&!e.active&&this._activateLabelingContext(e),!t&&e.active&&this._deactivateLabelingContext(e),this.setDirty()}_resetAllLabels(){for(const e of this._labelingContexts)this._resetLabels(e)}_resetLabels(e){e.labels.forEach(((t,i)=>{this._destroyGraphic(t,i),t.visible=!1,t.rendered=!1,e.labelsToInitialize.set(i,t)})),this._destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()}_findLabelingContext(e){for(const t of this._labelingContexts)if(t.graphics3DCore===e)return t;return null}addGraphicsOwner(e,t,i){const r=i&&i.emptySymbolLabelSupported||!1,s=i&&i.elevationInfoOverride||null,a=i&&i.disablePlacement||null;if(this._findLabelingContext(e))return;const n=e.layer,o={graphics3DCore:e,layer:n,scaleVisibility:t,emptySymbolLabelSupported:r,elevationInfoOverride:s,disablePlacement:a,active:n.labelsVisible,labelClassPromise:null,labelClassAbortController:h(),labelClassContexts:[],labels:new Map,labelsToInitialize:new Map,stageLayer:new Zo({isPickable:!0},n.uid)};return this.view._stage.add(o.stageLayer),this._labelingContexts.push(o),this.setDirty(),{addGraphic:e=>this._addGraphic(o,e),removeGraphic:e=>this._removeGraphic(o,e),featureReductionChange:()=>{},layerLabelsEnabled:()=>Kt(o.layer),labelingInfoChange:e=>this._labelingInfoChange(o,e),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",o),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",o),visibilityInfoChange:()=>this._visibilityInfoChange(o),reset:()=>this._resetLabels(o),clear:()=>{}}}removeGraphicsOwner(e){const t=this._findLabelingContext(e);if(!t)return;const i=this._labelingContexts.indexOf(t);this._labelingContexts.splice(i,1),t.labels.forEach((e=>this._removeGraphic(t,e.graphics3DGraphic))),this.view._stage.remove(t.stageLayer),t.stageLayer=null,this.setDirty()}setLabelGraphicVisibility(e,t){const i=e.graphic.uid,r=this._labels.get(i);r&&r.visible!==t&&(t&&!r.rendered?(this._labelsToAdd.set(i,r),this._labelsToRemove.delete(i),r.hasTextTextureResources||r.labelingContext.labelsToInitialize.set(i,r)):!t&&r.rendered&&(this._labelsToRemove.set(i,r),this._labelsToAdd.delete(i)),r.visible=t,this.setDirty())}setDirty(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){var e;return this._dirty||(null==(e=this._textTextureAtlas)?void 0:e.updating)||this.deconflictor.updating||this._labelingContexts.some((e=>a_(e)))}get updatingProgress(){if(!this.updating||!this._textTextureAtlas)return 1;const e=this._labelingContexts.length>0?this._labelingContexts.reduce(((e,t)=>e+(a_(t)?0:1)),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}get test(){return{textTextureAtlas:this._textTextureAtlas,resetAllLabels:()=>this._resetAllLabels()}}};function s_(e){return e.active&&Kt(e.layer)}function a_(e){return e.labelClassPromise&&!!e.labelClassAbortController}function n_(e){return e.labelClassContexts&&e.labelClassContexts.length}function o_(e){return null===e.labelClassContexts}e([le({constructOnly:!0})],r_.prototype,"view",void 0),e([le({constructOnly:!0})],r_.prototype,"deconflictor",void 0),e([le()],r_.prototype,"_textTextureAtlas",void 0),e([le({type:Boolean,readOnly:!0})],r_.prototype,"updating",null),r_=e([ce("esri.views.3d.layers.graphics.Labeler")],r_);const l_=new io(null,null,null);class h_{constructor(){this.gltfCache=new Map,this.wosrCache=new Map,this.evictHandles=new ar}loadGLTF(e,t,i){const r=i?`gltfPBR:${e}`:`gltf:${e}`;return this.fromCache(this.gltfCache,r,(t=>ol(new ll(t.streamDataRequester),e,t,i)),t)}loadWOSR(e,t){const i=`wosr:${e}:${t.disableTextures}`;return this.fromCache(this.wosrCache,i,(t=>Yr(e,t)),t)}destroy(){this.evictHandles.destroy(),this.gltfCache.clear(),this.wosrCache.clear()}get size(){return this.wosrCache.size+this.gltfCache.size}fromCache(e,t,i,r){return new Promise(((s,a)=>{if(g(r))return void a(p());const n=f(r,(()=>{this.remove(e,t),a(p())})),o=e.get(t);if(o)return this.evictHandles.remove(t),o.refCount++,void o.item.then(s,a);const l=h(),c={...r,signal:l.signal},d={refCount:1,abortController:l,item:i(c).then((i=>(d.abortController=null,i.remove=()=>this.remove(e,t),i)))};e.set(t,d),d.item.then((e=>{C(n)&&n.remove(),s(e)}),(e=>{C(n)&&n.remove(),a(e)}))}))}remove(e,t){const i=e.get(t);i&&(i.refCount--,0===i.refCount&&this.evictHandles.add(x((()=>{e.delete(t),C(i.abortController)&&i.abortController.abort()}),c_),t))}}let c_=1e4;class d_{constructor(e,t,i,r=null){this.lij=[0,0,0],this.extent=Ct(),this.resolution=0,this.loadPriority=0,this.measures={visibility:2,screenRect:Ct(),distance:0,shouldSplit:!1},this.used=!1,r&&this.acquire(e,t,i,r)}acquire(e,t,i,r){this.tilingScheme=r,this.id=d_.id(e,t,i),this.lij[0]=e,this.lij[1]=t,this.lij[2]=i,r.getExtent(e,t,i,this.extent),this.resolution=r.resolutionAtLevel(e)}release(){this.tilingScheme=null}getChildren(e){const t=this.lij[0]+1,i=2*this.lij[1],r=2*this.lij[2];return e?(e[0].acquire(t,i,r,this.tilingScheme),e[1].acquire(t,i+1,r,this.tilingScheme),e[2].acquire(t,i,r+1,this.tilingScheme),e[3].acquire(t,i+1,r+1,this.tilingScheme),e):[new d_(t,i,r,this.tilingScheme),new d_(t,i+1,r,this.tilingScheme),new d_(t,i,r+1,this.tilingScheme),new d_(t,i+1,r+1,this.tilingScheme)]}copyMeasurementsFrom(e){this.measures.visibility=e.measures.visibility,this.measures.shouldSplit=e.measures.shouldSplit,this.measures.distance=e.measures.distance,At(e.measures.screenRect,this.measures.screenRect)}static id(e,t,i){return`${e}/${t}/${i}`}}class u_{constructor(e){this.renderCoordsHelper=e,this.frustum=dl(),this._points=ul(),this.lines=new Array(12),this._origin=fe(),this._direction=fe(),this._altitude=null;for(let e=0;e<12;e++)this.lines[e]={origin:null,direction:fe(),endpoint:null}}get planes(){return this.frustum}get points(){return this._points}get mutablePoints(){return this._points}get direction(){return this._direction}update(e){pl(e.viewMatrix,e.projectionMatrix,this.frustum,this._points),ye(this._origin,e.eye),ye(this._direction,e.viewForward),this._altitude=this.renderCoordsHelper.getAltitude(this._origin),this.updateLines()}updatePoints(e){for(let t=0;t<this._points.length;t++)ye(this._points[t],e[t]);ml(this.frustum,this._points),this.updateLines()}get altitude(){return this._altitude}intersectsSphere(e){return gl(this.frustum,e)}intersectsRay(e){return fl(this.frustum,e)}intersectsLineSegment(e,t){return vl(this.frustum,e,t)}intersectsPoint(e){return _l(this.frustum,e)}updateLines(){const e=this._points;for(let t=0;t<4;t++){const i=t+4;p_(this.lines[t],e[t],e[i]),p_(this.lines[t+4],e[t],3===t?e[0]:e[t+1]),p_(this.lines[t+8],e[i],3===t?e[4]:e[i+1])}}}function p_(e,t,i){e.origin=t,e.endpoint=i,ze(e.direction,t,i)}u_.planePointIndices=yl,u_.nearFarLineIndices=[[0,4],[1,5],[2,6],[3,7]];class m_{constructor(e){this.renderCoordsHelper=e,this.surfaceElevation=0,this.cache=new Map,this.frustum=new u_(e),this.extendedFrustum=new u_(e),this.intersector=new so({renderCoordsHelper:e}),this.renderCoordsHelper=e}begin(e,t){this.surfaceElevation=t,this.aboveGround=this.renderCoordsHelper.getAltitude(e.eye)>t,this.frustum.update(e),this.shortenFrustumFarPlane(this.frustum),this.updateExtendedFrustum(e)}end(){this.cache.clear()}calculate(e){if(this.allTilesInvisible)return 0;const t=1===this.renderCoordsHelper.viewingMode&&e.lij[0]>=g_&&e.lij[0]<f_,i=this.getOrCalculateSingleTileVisibility(e,!t);return 0!==i&&t?this.calculateAggregatedChildrenVisibility(e):i}shortenFrustumFarPlane(e){const t=u_.nearFarLineIndices,i=e.mutablePoints;for(const e of t){const[t,r]=e,s=i[t],a=i[r];Te(x_,a,s),Ce(x_,x_,__),Pe(i[r],s,x_)}e.updatePoints(i)}calculateAggregatedChildrenVisibility(e){let t=0;const i=this.cache.get(e.id);if(null!=i)return i;const r=C_.acquire();e.getChildren(r);for(const e of r){const i=this.calculate(e);if(0!==i&&(t=i,2===i))break}return C_.release(r),this.cache.set(e.id,t),t}getOrCalculateSingleTileVisibility(e,t){const i=this.cache.get(e.id);if(null!=i)return i;const r=this.calculateSingleTileVisibility(e);return t&&this.cache.set(e.id,r),r}calculateSingleTileVisibility(e){if(!this.aboveGround&&1===this.renderCoordsHelper.viewingMode&&e.lij[0]<v_){return 0===this.calculateSingleTileVisibilitySided(e,!1)?this.calculateSingleTileVisibilitySided(e,!0):void 0}return this.calculateSingleTileVisibilitySided(e,this.aboveGround)}calculateSingleTileVisibilitySided(e,t){this.intersector.update(e.extent,e.tilingScheme.spatialReference,this.surfaceElevation,t);const i=wt(e.tilingScheme.spatialReference).radius;return this.intersector.isVisibleInFrustum(this.extendedFrustum,i)?this.intersector.isVisibleInFrustum(this.frustum,i,!0)?2:1:0}updateExtendedFrustum(e){this.extendedFrustum.update(e),this.shortenFrustumFarPlane(this.extendedFrustum);const t=this.renderCoordsHelper.worldUpAtPosition(e.eye,x_);this.aboveGround||Ue(t,t);const i=Ee(-Ie(t,e.viewForward));if(this.allTilesInvisible=i>(Math.PI+e.fovY)/2,this.allTilesInvisible)return;if(this.hasExtendedFrustum=i>e.fovY/2,!this.hasExtendedFrustum)return;const r=this.extendedFrustumParameters(),s=this.extendedFrustum.mutablePoints;for(let e=0;e<4;e++){const t=r.pointIndices[e],i=s[t],a=this.renderCoordsHelper.getAltitude(i);if(r.needsAltitudeAdjustment(a)){switch(this.renderCoordsHelper.worldUpAtPosition(i,x_),t){case 4:case 7:case 0:case 3:To(this.extendedFrustum.planes[0],x_,x_);break;case 5:case 6:case 1:case 2:To(this.extendedFrustum.planes[1],x_,x_)}Ce(x_,x_,r.direction),this.renderCoordsHelper.intersectInfiniteManifold(Yn(i,x_),r.zWithMargin,i)}}if(this.extendedFrustum.updatePoints(s),So(s[0],s[1],s[2],w_),So(s[1],s[2],s[3],b_),Ie(wo(w_),wo(b_))<0){const e=this.extendedFrustum.mutablePoints;this.aboveGround?[e[0],e[1]]=[e[1],e[0]]:[e[3],e[2]]=[e[2],e[3]],this.extendedFrustum.updatePoints(e)}}extendedFrustumParameters(){return this.aboveGround?this.extendedFrustumParametersAboveSurface():this.extendedFrustumParametersBelowSurface()}extendedFrustumParametersAboveSurface(){const e=this.surfaceElevation-y_;return{zWithMargin:e,pointIndices:u_.planePointIndices.bottom,direction:-1,needsAltitudeAdjustment:t=>t>e}}extendedFrustumParametersBelowSurface(){const e=this.surfaceElevation+y_;return{zWithMargin:e,pointIndices:u_.planePointIndices.top,direction:1,needsAltitudeAdjustment:t=>t<e}}}const g_=2,f_=6,v_=12,__=.95,y_=1,x_=fe(),w_=vo(),b_=vo(),C_=new cl(Array,(e=>{4!==e.length&&(e[0]=new d_,e[1]=new d_,e[2]=new d_,e[3]=new d_)}),(e=>{e[0].release(),e[1].release(),e[2].release(),e[3].release()}));class T_{constructor(e){this.camera=new co,this.focusOnMap=[0,0],this.screenRect=Ct(),this.tileSize=e.tileSize,this.renderCoordsHelper=e.renderCoordsHelper,this.tilingScheme=e.tilingScheme,this.visibility=new m_(e.renderCoordsHelper)}begin(e,t,i){this.camera.copyFrom(e),this.surfaceElevation=i,this.focusOnMap[0]=t.x,this.focusOnMap[1]=t.y,Ot(0,0,e.fullWidth,e.fullHeight,this.screenRect),this.visibility.begin(this.camera,i)}end(){this.visibility.end()}updateTile(e){e.measures.visibility=this.visibility.calculate(e),e.measures.distance=Ft(e.extent,this.focusOnMap),0!==e.measures.visibility&&this.updateScreenMeasure(e)}updateScreenMeasure(e){const t=P_,i=1<<t,r=e.measures.screenRect;Tt(r);let s=0;const a=e.lij[0]+t,n=e.lij[1]<<t,o=e.lij[2]<<t,l=this.tileSizeWithBias(e),h=l*l;for(let t=0;t<i;t++)for(let l=0;l<i;l++)if(s+=this.computeScreenArea(e,a,n+t,o+l,r),s>h)return void(e.measures.shouldSplit=!0);e.measures.shouldSplit=!1}tileSizeWithBias(e){return 1===e.measures.visibility?this.tileSize*R_:this.tileSize}computeScreenArea(e,t,i,r,s){const a=1===e.measures.visibility;this.projectToScreen(t,i,r,a,M_),Tt(S_);for(let e=0;e<4;e++)It(S_,M_[e]);return Mt(s,S_,s),hl(M_[0],M_[1],M_[2])+hl(M_[0],M_[2],M_[3])}projectToScreen(e,t,i,r,s){this.tilingScheme.ensureMaxLod(e),this.tilingScheme.getExtent(e,t,i,D_),this.toRenderCoords(D_,0,3,O_[0]),this.toRenderCoords(D_,2,3,O_[1]),this.toRenderCoords(D_,2,1,O_[2]),this.toRenderCoords(D_,0,1,O_[3]),r&&(this.projectToPlane(O_,this.camera.frustum[4]),this.projectToPlane(O_,this.camera.frustum[3]),this.projectToPlane(O_,this.camera.frustum[2]));for(let e=0;e<4;e++)this.camera.projectToRenderScreen(O_[e],I_),this.camera.renderToScreen(I_,s[e])}projectToPlane(e,t){for(let i=0;i<4;i++)F_[i]=Po(t,e[i]);const i=Math.max(F_[0],F_[1],F_[2],F_[3]);if(i>0){const r=Ce(A_,wo(t),-i);for(let t=0;t<4;t++)Pe(e[t],e[t],r)}}toRenderCoords(e,t,i,r){return A_[0]=e[t],A_[1]=e[i],A_[2]=this.surfaceElevation,this.renderCoordsHelper.toRenderCoords(A_,this.tilingScheme.spatialReference,r),r}}const S_=Ct(),P_=2,R_=5,M_=[ie(),ie(),ie(),ie()],D_=Ct(),A_=fe(),O_=[fe(),fe(),fe(),fe()],F_=[0,0,0,0],I_=se(),z_=U.getLogger("esri.views.3d.layers.support.FeatureTileTree3D");let E_=class extends yi{constructor(e){super(e),this.tiles=new a,this.tileSize=512,this._idToTile=new Map,this._handles=new ar,this._clients=new Set,this._dirty=!1,this._newTiles=new N}get tilingScheme(){const e=this.tilingSchemeOwner.tilingScheme;if(!e)return null;return e.clone()}set filterExtent(e){if(C(e)&&!e.spatialReference.equals(this.viewState.spatialReference))return void z_.error("#extent","extent spatial reference needs to be in the same spatial reference as the view");const t=this._get("filterExtent");if(t===e||C(t)&&e&&t.equals(e))return;const i=C(e)?e.clone():null;this._set("filterExtent",i),this._setDirty()}get filterExtentRect(){if(M(this.filterExtent)||!this.tilingScheme)return null;const e=Ct();return ao(this.filterExtent,e,this.tilingScheme.spatialReference),e}get rootTileIds(){return this.filterExtentRect?this.tilingScheme.rootTilesInExtent(this.filterExtentRect):[[0,0,0]]}set suspended(e){e!==this._get("suspended")&&(this._set("suspended",e),this._setDirty())}get updating(){return this._dirty||!!this._pendingTiles}initialize(){this._handles.add(this.watch(["tilingScheme","tileSize"],(()=>this._reset()),!0)),this._handles.add(Y(this,["tileSize","cameraOnSurface.location","tilingScheme","viewState.contentCamera","focus.location"],(()=>this._setDirty()),!0)),this.scheduler&&(this._frameWorker=this.scheduler.registerTask(qo.FEATURE_TILE_TREE,this))}destroy(){this._frameWorker=I(this._frameWorker),this._handles=R(this._handles)}addClient(){const e=L_++;return this._clients.add(e),1===this._clients.size&&this._setDirty(),{remove:()=>this._removeClient(e)}}_removeClient(e){this._clients.delete(e),this._hasClients||this._clear()}get _hasClients(){return this._clients.size>0}_setDirty(){!this._hasClients||this.suspended||this._dirty||(this._frameWorker?(this._dirty=!0,this.notifyChange("updating")):this.runTask(Ho))}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(),this._dirty=!1,this.notifyChange("updating")}get running(){return this.updating}runTask(e){this._dirty=!1,this._pendingTiles||(this._startUpdate(),C(this._frameWorker)&&(this._frameWorker.priority=qo.FEATURE_TILE_TREE_ACTIVE)),this._subdivideTilesForView(e),!this._pendingTiles&&C(this._frameWorker)&&(this._frameWorker.priority=qo.FEATURE_TILE_TREE),this.notifyChange("updating")}_startUpdate(){if(this.suspended)return;if(!this.tilingScheme)return void this._clear();this._tileMeasurements||(this._tileMeasurements=new T_({renderCoordsHelper:this.renderCoordsHelper,tilingScheme:this.tilingScheme,tileSize:this.tileSize}));const e=this.viewState.contentCamera;this._tileMeasurements.begin(e,this.focus.location,this.cameraOnSurface.location.z),this._pendingTiles=this._getRootTiles()}_reset(){this._newTiles.clear(),this._tileMeasurements=null,this._pendingTiles=null,this._setDirty()}_getRootTiles(){return this.rootTileIds.map((e=>new d_(e[0],e[1],e[2],this.tilingScheme)))}_purgeHorizonTiles(e){e.sort(((e,t)=>{const i=e.measures.screenRect,r=t.measures.screenRect;return i[1]+i[3]-(r[1]+r[3])})),Tt(V_);for(let t=0;t<e.length;t++)if(Mt(V_,e.data[t].measures.screenRect,V_),Rt(V_)>k_)return e.data.slice(t,e.length);return[]}_subdivideTilesForView(e){if(this._pendingTiles){for(;this._pendingTiles.length>0&&!e.done;){const t=this._pendingTiles.pop();e.madeProgress(),this.filterExtentRect&&!Dt(this.filterExtentRect,t.extent)||(this._tileMeasurements.updateTile(t),0!==t.measures.visibility&&(t.measures.shouldSplit?(this.tilingScheme.ensureMaxLod(t.lij[0]+1),this._pendingTiles.push(...t.getChildren())):this._newTiles.push(t)))}0===this._pendingTiles.length&&(this._updateTiles(this._purgeHorizonTiles(this._newTiles)),this._newTiles.clear(),this._tileMeasurements.end(),this._pendingTiles=null)}}_updateTiles(e){for(const e of this.tiles.items)e.used=!1;const t=e.filter((e=>{const t=this._idToTile.get(e.id);return t?(t.copyMeasurementsFrom(e),t.used=!0):this._idToTile.set(e.id,e),!t})),i=this.tiles.items.filter((e=>!e.used&&(this._idToTile.delete(e.id),!0)));this.tiles.removeMany(i),this.tiles.addMany(t),this.sortTiles()}sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort(((e,t)=>e.measures.visibility!==t.measures.visibility?2===e.measures.visibility?-1:1:e.measures.distance-t.measures.distance)),this.tiles.forEach(((e,t)=>e.loadPriority=t))}};e([le({constructOnly:!0})],E_.prototype,"scheduler",void 0),e([le({constructOnly:!0})],E_.prototype,"renderCoordsHelper",void 0),e([le({constructOnly:!0})],E_.prototype,"tilingSchemeOwner",void 0),e([le({constructOnly:!0})],E_.prototype,"cameraOnSurface",void 0),e([le({constructOnly:!0})],E_.prototype,"focus",void 0),e([le({constructOnly:!0})],E_.prototype,"viewState",void 0),e([le({constructOnly:!0})],E_.prototype,"terrain",void 0),e([le()],E_.prototype,"tiles",void 0),e([le()],E_.prototype,"tileSize",void 0),e([le({readOnly:!0})],E_.prototype,"tilingScheme",null),e([le()],E_.prototype,"filterExtent",null),e([le({readOnly:!0})],E_.prototype,"filterExtentRect",null),e([le({readOnly:!0})],E_.prototype,"rootTileIds",null),e([le({value:!1})],E_.prototype,"suspended",null),e([le({readOnly:!0})],E_.prototype,"updating",null),E_=e([ce("esri.views.3d.layers.support.FeatureTileTree3D")],E_);let L_=0;const V_=Ct(),k_=10;var j_=E_;let U_=class extends yi{constructor(){super(...arguments),this._propertiesPool=new no({camera:co},this),this._lastSeenCameraProjectionValues=new co,this.events=new tr,this.viewingMode=1,this._cameraChanged=!1,this.updateQueue=new Array,this.processingUpdates=!1}init(e,t){this._set("viewingMode",e),this._set("spatialReference",t),this._set("constraints",new $c({mode:this.viewingMode}))}exit(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new no({camera:co},this)}createInitialCamera(){if(1===this.viewingMode){const e=wt(this.spatialReference).radius;this.camera=new co(ge(4*e,0,0),ge(e,0,0),ge(0,0,1))}else this.camera=new co(ge(0,0,100),ge(0,0,0),ge(0,1,0))}get animation(){return this.cameraController instanceof qm&&C(this.cameraController.viewAnimation)?this.cameraController.viewAnimation:null}get camera(){return this._get("camera")}set camera(e){e!==H_&&H_.copyFrom(e),H_.computeUp(this.viewingMode),B_.camera=H_,this.events.emit("before-camera-change",B_);const t=this._get("camera");if(this.cameraProjectionChanged(this._lastSeenCameraProjectionValues,H_)&&(this._lastSeenCameraProjectionValues.copyFrom(H_),N_.camera=this._lastSeenCameraProjectionValues,this.events.emit("camera-projection-changed",N_)),(!t||!t.equals(H_))&&(this._set("camera",this._propertiesPool.get("camera").copyFrom(H_)),this._cameraChanged=!t||!t.almostEquals(H_),this._cameraChanged)){const e=bi((()=>{this._cameraChanged=!1,e.remove()}))}}get contentCamera(){return C(this._contentCamera)?this._contentCamera:this.camera}set contentCamera(e){this._contentCamera=C(e)?e.clone():null}get fixedContentCamera(){return!!C(this._contentCamera)}get isGlobal(){return 1===this.viewingMode}get isLocal(){return 2===this.viewingMode}get navigating(){return!(!this.cameraController||!this.cameraController.isInteractive)}get stationary(){return!this._cameraChanged&&!this.navigating}get cameraController(){return this._get("cameraController")}set cameraController(e){this.stopActiveCameraController()?(e&&(e.watch("state",(t=>{t!==jm.Finished&&t!==jm.Stopped||(this._set("cameraController",null),this.updateCamera((t=>e.onControllerEnd(t))))}),!0),e.onControllerStart(this.camera)),this._set("cameraController",e)):e&&(e.state=jm.Rejected)}switchCameraController(e){return this.cameraController=e,e.state!==jm.Rejected}stopActiveCameraController(){return!(this.cameraController&&!this.cameraController.stopController())}updateCamera(e){this.updateQueue.push(e),this.processUpdateQueue()}processUpdateQueue(){if(0===this.updateQueue.length||this.processingUpdates)return;this.processingUpdates=!0;const e=this.updateQueue.shift();H_.copyFrom(this._get("camera")),e(H_),this.camera=H_,this.processingUpdates=!1,this.processUpdateQueue()}cameraProjectionChanged(e,t){return e.fov!==t.fov||(e.fullViewport[0]!==t.fullViewport[0]||e.fullViewport[1]!==t.fullViewport[1]||e.fullViewport[2]!==t.fullViewport[2]||e.fullViewport[3]!==t.fullViewport[3]||(e.padding[0]!==t.padding[0]||e.padding[1]!==t.padding[1]||e.padding[2]!==t.padding[2]||e.padding[3]!==t.padding[3]))}};e([le({readOnly:!0,type:_i})],U_.prototype,"animation",null),e([le({type:co})],U_.prototype,"camera",null),e([le({})],U_.prototype,"_contentCamera",void 0),e([le({type:co})],U_.prototype,"contentCamera",null),e([le({readOnly:!0})],U_.prototype,"fixedContentCamera",null),e([le({readOnly:!0})],U_.prototype,"constraints",void 0),e([le({readOnly:!0})],U_.prototype,"events",void 0),e([le({readOnly:!0})],U_.prototype,"isGlobal",null),e([le({readOnly:!0})],U_.prototype,"isLocal",null),e([le({readOnly:!0})],U_.prototype,"viewingMode",void 0),e([le({readOnly:!0})],U_.prototype,"spatialReference",void 0),e([le({readOnly:!0})],U_.prototype,"navigating",null),e([le({readOnly:!0})],U_.prototype,"stationary",null),e([le()],U_.prototype,"_cameraChanged",void 0),e([le()],U_.prototype,"cameraController",null),U_=e([ce("esri.views.3d.state.ViewState")],U_);var q_=U_;const H_=new co,B_={camera:null},N_={camera:null};class G_{constructor(e,t){this.elevationProvider=e,this._referenceEllipsoid=wt(t),this.unitInMeters=Pl(t,this._referenceEllipsoid.metersPerDegree)}compute(e,t,i,r,s){s||(s={near:0,far:0});let a=e[2]*this.unitInMeters;const n=a,o=a-r,l=this.elevationProvider?this.elevationProvider.elevationBounds:null;l&&(a=o>=0?n-this.unitInMeters*l.min:this.unitInMeters*l.max-n);const h={x:(i=C(i)?i:new bl({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0})).xmax-i.xmin,y:i.ymax-i.ymin,z:4*Math.max(i.xmax-i.xmin,i.ymax-i.ymin)},c=Math.max(h.x,h.y,h.z);Te($_,t,e),J_[0]=$_[0]>0?i.xmax:i.xmin,J_[1]=$_[1]>0?i.ymax:i.ymin,J_[2]=$_[2]>0?c/2:-c/2,Te(J_,J_,e),we($_,$_);const d=1.1*Ie(J_,$_)*this.unitInMeters,u=Math.sqrt(a*(a+2*this._referenceEllipsoid.radius)),p=Math.max(i.xmax-i.xmin,i.ymax-i.ymin),m=p*X_*this.unitInMeters,g=p*K_*this.unitInMeters;let f=ue((a-g)/(m-g),0,1);f*=f*f;let v=Me(u,d,f);return v*=Math.max(Math.log(Math.abs(o)),1),v=Math.min(v,Math.max(34064e4,c)),v/=this.unitInMeters,Q_(v,Z_,this.unitInMeters,s)}}class W_{constructor(e){this._referenceEllipsoid=wt(e)}compute(e,t,i,r,s){s||(s={near:0,far:0});const a=_e(e)-this._referenceEllipsoid.radius,n=this._referenceEllipsoid.radius+Math.min(0,r),o=Math.abs(a-r),l=Math.max(o,Math.abs(a));return Q_(1.2*Math.sqrt(l*(l+2*n)),ue(2e4-(Math.log(l)-7.983)/9.011*19e3,1e3,2e4),1,s)}}function Q_(e,t,i,r){const s=Y_/i;return e/t>s?(r.far=e,r.near=r.far/t):(r.near=s,r.far=r.near*t),r}const Z_=2e4,Y_=2,X_=.001,K_=1e-4,J_=fe(),$_=fe();let ey=class extends yi{constructor(e){super(e),this.handles=new ar}initialize(){this.handles.add(this.view.basemapTerrain.on("elevation-change",(e=>this.handleElevationChangeEvent(e))))}destroy(){this.handles&&(this.handles.destroy(),this.handles=null)}handleElevationChangeEvent(e){if(this.view.state.cameraController)return;const t=this.view.state.camera;Ui(this.view,t,e.extent,e.spatialReference)&&this.applyToCurrentCamera()}applyToCurrentCamera(){this.view.state.updateCamera((e=>{lp(this.view,e,1)}))}};e([le({constructOnly:!0})],ey.prototype,"view",void 0),ey=e([ce("esri.views.3d.state.ElevationCollisionConstraint")],ey);var ty=ey;let iy=class extends yi{constructor(e){var t,i,r;super(e),this._handles=new ar,this.nearFarHeuristic=(t=e.view.state.viewingMode,i=e.view.basemapTerrain,r=e.view.renderCoordsHelper.spatialReference,1===t?new W_(r):new G_(i,r))}initialize(){this._handles.add([this.view.watch(["constraints.clipDistance.near","constraints.clipDistance.far"],(()=>this._clipDistanceNearFarChanged())),this.view.watch("constraints.clipDistance.mode",(()=>this._updateNearFar())),this.view.state.events.on("before-camera-change",(e=>this._updateCameraNearFar(e.camera))),this.view.watch("renderDataExtent",(()=>this._updateNearFar()),!0),this.view.watch(["constraints.altitude.min","constraints.altitude.max"],(()=>this._updateAltitude()),!0),this.view.watch("constraints.tilt.max",(()=>this._updateTiltMax()),!0),this.view.watch("constraints.tilt.mode",(()=>this._updateTilt()),!0),this.view.watch("state.camera",(()=>this._updateTiltAutoMax()),!0),this.view.watch(["map.ground.navigationConstraint.type","constraints.collision.enabled"],(()=>this._updateCollision()),!0)]),this.view.state.isLocal&&this._handles.add(Y(this.view,"renderDataExtent",(e=>this._updateLocalSurfaceDistance(e)))),this._updateNearFar(),2!==this.view.state.viewingMode&&this._updateAltitude(),this._updateTilt(),this._updateCollision(),this._set("surfaceCollisionConstraint",new ty({view:this.view}))}destroy(){this._handles=R(this._handles),this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),this._set("surfaceCollisionConstraint",null))}_clipDistanceNearFarChanged(){var e;const t=null==(e=this.view.constraints)?void 0:e.clipDistance;t&&"auto"!==t.mode&&this.view.state.updateCamera((e=>(this._updateCameraNearFarManual(e,t),!0)))}_updateNearFar(){this.view.state.updateCamera((e=>(this._updateCameraNearFar(e),!0)))}_updateCameraNearFar(e){const t=this.view.constraints&&this.view.constraints.clipDistance;"manual"===(t?t.mode:"auto")?this._updateCameraNearFarManual(e,t):this._updateCameraNearFarAuto(e,t)}_updateCameraNearFarAuto(e,t){this.nearFarHeuristic.compute(e.eye,e.center,this.view.renderDataExtent,Vi(this.view,e.eye),e),t&&t.autoUpdate(e.near,e.far)}_updateCameraNearFarManual(e,t){t&&(e.near=t.near,e.far=t.far)}_updateCollision(){var e,t,i;const r=null==(e=this.view.map)||null==(t=e.ground)||null==(i=t.navigationConstraint)?void 0:i.type,s=!r||"stay-above"===r,a=this.view.state.constraints.collision;if(s!==a.enabled){a.enabled=s,s&&this._reapplyConstraints(8);const e=this.view.constraints&&this.view.constraints.tilt;e&&"auto"!==e.mode||this._updateTiltAuto()}}_updateAltitude(){const e=this.view.constraints&&this.view.constraints.altitude;e&&2!==this.view.state.viewingMode?this.view.state.constraints.altitude={min:e.min,max:e.max}:this.view.state.constraints.altitude=null,this._reapplyConstraints()}_updateTiltMax(){const e=this.view.constraints&&this.view.constraints.tilt;e&&"auto"!==e.mode&&(this._updateTiltManual(e),this._reapplyConstraints())}_updateTilt(){const e=this.view.constraints&&this.view.constraints.tilt;"manual"===(e?e.mode:"auto")?this._updateTiltManual(e):this._updateTiltAuto(),this._reapplyConstraints()}_updateTiltManual(e){const t=this.view.state.constraints;t.tilt=t.createConstantMaxTilt(pe(e.max))}_updateTiltAuto(){const e=this.view.state.constraints;e.tilt=e.createDefaultTilt(),this._updateTiltAutoMax()}_updateTiltAutoMax(){const e=this.view.constraints&&this.view.constraints.tilt;if(!e||"auto"!==e.mode)return;const t=this.view.state.constraints;if(t.tilt){const i=t.tilt(this.view.state.camera.distance).max;e.autoUpdate(me(i))}}_updateLocalSurfaceDistance(e){if(M(e))return;let t=Math.max(e.width,e.height);if(t<=0)return;e.hasZ&&(t=Math.max(t,e.zmax-e.zmin));const i=this.view.state,r=3*t/Math.atan(i.camera.fov/2);r!==i.constraints.distance&&(i.constraints.distance=r)}_reapplyConstraints(e=15){this.view.state.updateCamera((t=>im(this.view,t,{selection:e,interactionType:0,interactionFactor:null,interactionStartCamera:null,interactionDirection:null,tiltMode:0})))}};e([le({constructOnly:!0})],iy.prototype,"view",void 0),e([le({readOnly:!0})],iy.prototype,"surfaceCollisionConstraint",void 0),iy=e([ce("esri.views.3d.state.ConstraintsManager")],iy);var ry=iy;let sy=class extends Um{constructor(e){super(e),this.handles=new ar}set desiredCamera(e){this._set("desiredCamera",e.clone())}get canStop(){return!0}get constraintEnabled(){return this.view.state.constraints.collision.enabled}onControllerStart(){this.state=jm.Running,this.handles.add(this.view.basemapTerrain.on("elevation-change",(e=>this.handleElevationChangeEvent(e)))),this.applyCorrection()}onControllerEnd(){this.handles.removeAll()}stepController(){}handleElevationChangeEvent(e){Ui(this.view,this.desiredCamera,e.extent,e.spatialReference)&&this.applyCorrection()}applyCorrection(){this.view.state.updateCamera((e=>{e.copyViewFrom(this.desiredCamera),lp(this.view,e,1)||this.constraintEnabled||(this.state=jm.Stopped)}))}};e([le({constructOnly:!0})],sy.prototype,"view",void 0),e([le({constructOnly:!0})],sy.prototype,"desiredCamera",null),sy=e([ce("esri.views.3d.state.controllers.SurfaceCollisionCorrectionController")],sy);class ay{constructor(e,t,i){this.target=e,this.options=t,this.view=i,this.state="pending",this.abortController=null,this.animationController=null,this.promise=new Promise(((e,t)=>{this.resolveCallback=e,this.rejectCallback=t;const i=h();C(this.options.signal)&&f(this.options.signal,(()=>{this.abort()})),this.abortController=i,this.waitForReady()}))}then(e,t){return this.promise.then(e,t)}catch(e){return this.promise.catch(e)}resolve(e){return this.state="finished",this.resolveCallback(e)}reject(e){return this.state="finished",this.rejectCallback(e)}abort(e=!1){switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":this.reject(p());break;case"wait-for-animation-finish":!e&&C(this.animationController)&&this.view.state.cameraController===this.animationController&&this.animationController.active&&this.animationController.stopController(),this.reject(p())}}waitForReady(){this.state="wait-for-ready",this.view.ready?this.createViewPoint():K(this.view,"ready",this.abortController.signal).then((()=>{this.createViewPoint()}),(e=>{this.reject(e)}))}createViewPoint(){"finished"!==this.state&&(this.state="wait-for-viewpoint",this.animationController=this.options.animate?this.getAnimationController():null,qi(this.view,this.target,this.abortController.signal).then((e=>{if("finished"===this.state)return;const t=this.getCameraFromViewpoint(e);if(!M(t))if(this.options.animate){if(M(this.animationController))return;this.startAnimation(t,this.animationController)}else this.view.stateManager.setStateCamera(t.camera,{applyConstraints:!t.isFullySpecified,positionAndOrientationOnly:!0,doNotCancelGoToOperation:!0}),this.resolve()}),(e=>{this.reject(e)})))}getCameraFromViewpoint(e){const i=!!(this.target instanceof s&&this.target.camera||this.target instanceof t),r=e.camera;if(M(r))return null;if(!this.view.stateManager.isCompatible(r)){const e=r.position,t=e&&e.spatialReference,i=t?t.wkid:"none",s=this.view.spatialReference.wkid;return this.reject(new o("GotoAnimation:incompatible-spatialreference",`Resulting camera has an incompatible spatial reference (camera: ${i}, view: ${s})`,{camera:r})),null}const a=Hi(this.view,r);return M(a)?(this.reject(new o("GotoAnimation:invalid-camera","Resulting camera is invalid")),null):{viewpoint:e,camera:a,isFullySpecified:i}}startAnimation(e,t){this.state="wait-for-animation-finish";const i=t.viewAnimation;if(M(i))return void this.reject(new o("GotoAnimation:missing-animation","Unreachable code in view.stateManager"));if(i.update(e.viewpoint,"running"),!t.active||M(t.viewAnimation)||t.viewAnimation.target!==e.viewpoint||this.view.state.cameraController!==t)return this.abort();let r;e.isFullySpecified?(r=new sy({view:this.view,desiredCamera:e.camera}),lp(this.view,e.camera,1)):im(this.view,e.camera),t.begin(e.camera,this.options);const s=e=>{if(!M(this.view.state))switch(t.state){case jm.Finished:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.resolve()}break;case jm.Ready:case jm.Rejected:case jm.Running:case jm.Stopped:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.reject(e)}}};i.when((()=>{const i=this.view.state.cameraController;r&&(i&&i.active?i instanceof Hm&&C(i.viewAnimation)&&i.viewAnimation.target===e.viewpoint&&(this.view.state.cameraController=r):C(t.viewAnimation)&&t.viewAnimation.target===e.viewpoint&&"finished"===t.state&&(this.view.state.cameraController=r))}),(e=>s(e))),t.asyncResult={resolve:()=>s(),reject:e=>s(e)}}getAnimationController(){let e,t=null;const i=this.view.state.cameraController;return i instanceof Hm&&(i.updateStateFromViewAnimation(),i.active&&(e=i,t=e.viewAnimation)),null!=e||(e=new Hm({view:this.view,mode:"animation"}),t=e.viewAnimation,this.view.state.switchCameraController(e))?e:(C(t)&&t.stop(),this.reject(new o("GotoAnimation:goto-cannot-interrupt","Cannot start an animation while interacting")),null)}}const ny=U.getLogger("esri.views.3d.state.ViewStateManager");let oy=class extends yi{constructor(e){super(e),this.propertiesPool=new no({frustum:u_},this),this.handles=new ar,this.cameraSetByUser=!1,this.gotoOperation=null,this.ready=!1,this.updateDevicePixelRatio=null,this.test={contentCameraResetState:new Map}}get camera(){const e=this._get("camera");if(!this.ready)return e;const t=Bi(this.view,this.view.state.camera);return t&&e&&t.equals(e)?e:t}set camera(e){this.updatePropertyBeforeReady("camera",e)||(this.view.elevationProvider.enableElevationCache(!0),this.setStateCamera(Hi(this.view,e),{applyConstraints:!1})||ny.error("#camera=","Invalid camera",e),this.view.elevationProvider.enableElevationCache(!1))}get contentCamera(){const e=this._get("contentCamera");if(!this.ready)return e;const t=Bi(this.view,this.view.state.contentCamera);return t&&e&&t.equals(e)?e:t}set contentCamera(e){if(this.updatePropertyBeforeReady("contentCamera",e))return;const t=Hi(this.view,e);M(t)?this.view.state.contentCamera=null:(this.updateElevation(t),this.view.state.contentCamera=t)}installContentCameraReset(e){if(this.handles.remove("contentCameraReset"),this.test.contentCameraResetState.clear(),!this.view.state.fixedContentCamera)return!1;const t=this.zoom,i=this.view.state.camera.distance**2,r=Ge(this.view.state.camera.center),s=e.sticky?this.contentCamera.clone():null;return this.handles.add([this.watch("contentCamera",(()=>{e.sticky||(this.handles.remove("contentCameraReset"),this.test.contentCameraResetState.clear())})),this.watch("zoom",(e=>{this.test.contentCameraResetState.set("view.zoom",Math.abs(e-t)/2),Math.abs(e-t)>2?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=s)})),this.view.state.watch("camera",(e=>{const t=je(r,e.center);this.test.contentCameraResetState.set("camera.center",t/i),t>i?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=s)}))],"contentCameraReset"),!0}get center(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")}set center(e){this.updatePropertyBeforeReady("center",e)||(e?this.isCompatible(e)?this.setStateCamera(this.centerToCamera(e),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.runTask():ny.error("#center=","Invalid center",e):ny.error("#center=","Center has an incompatible spatial reference (center: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e):ny.error("#center=","Center may not be null or undefined"))}get extent(){if(!this.ready)return this._get("extent");const e=this.view,t=Ni(e,e.state.camera,e.pointsOfInterest.centerOnContent.renderLocation);return C(t)?t:this._get("extent")}set extent(e){this.updatePropertyBeforeReady("extent",e)||(e?this.isCompatible(e)?this.setStateCamera(this.extentToCamera(e),{applyConstraints:!0})||ny.error("#extent=","Invalid extent",e):ny.error("#extent=","Extent has an incompatible spatial reference (extent: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e):ny.error("#extent=","Extent may not be null or undefined"))}get frustum(){const e=this.propertiesPool.get("frustum");return e.renderCoordsHelper=this.view.renderCoordsHelper,e.update(this.view.state.camera),e}get hasInitialView(){return!!this.view.get("map.initialViewProperties.viewpoint")}get scale(){if(this.ready){const e=this.view.pointsOfInterest.centerOnContent;return Gi(this.view,e.distance,e.location.latitude)}return this._get("scale")}set scale(e){this.updatePropertyBeforeReady("scale",e)||this.setStateCamera(this.scaleToCamera(e),{applyConstraints:!0})||ny.error("#scale=","Invalid scale",e)}get padding(){if(!this.ready)return this._get("padding");const e=this.view.state.camera,t=e.padding,i=e.pixelRatio,r=this._get("padding"),s=Math.round(t[0]/i),a=Math.round(t[1]/i),n=Math.round(t[2]/i),o=Math.round(t[3]/i);return null!=r&&r.top===s&&r.right===a&&r.bottom===n&&r.left===o?r:{top:s,right:a,bottom:n,left:o}}set padding(e){this.updatePropertyBeforeReady("padding",e)||(this.paddingToArray(e,this.view.state.camera.pixelRatio,my),this.view.state.updateCamera((e=>e.padding=my)))}paddingToArray(e,t,i){e?Re(i,e.top||0,e.right||0,e.bottom||0,e.left||0):Re(i,0,0,0,0);for(let e=0;e<4;e++)i[e]=Math.round(i[e]*t)}get screenCenter(){const e=this.padding;return ae((this.view.width-(e.left+e.right))/2+e.left,(this.view.height-(e.top+e.bottom))/2+e.top)}get viewpoint(){return this.ready?Wi(this.view,this.camera):this._get("viewpoint")}set viewpoint(e){if(!this.updatePropertyBeforeReady("viewpoint",e))if(e)if(this.isCompatible(e))this.setStateCamera(this.viewpointToCamera(e),{applyConstraints:!e.camera})||ny.error("#viewpoint=","Invalid viewpoint",e);else{const t=C(e.camera)?e.camera.position:e.targetGeometry,i=C(t)&&t.spatialReference;ny.error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(i?i.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e)}else ny.error("#viewpoint=","Viewpoint may not be null or undefined")}get zoom(){return this.ready?Qi(this.view,this.scale):this._get("zoom")}set zoom(e){this.updatePropertyBeforeReady("zoom",e)||this.setStateCamera(this.zoomToCamera(e),{applyConstraints:!0})||ny.error("#zoom=","Invalid zoom",e)}initialize(){this.handles.add([Z(this.view,"state.events","before-camera-change",(e=>this.updateElevation(e.camera)))]),J(this.view.state,"camera",(e=>this.updateElevation(e)),!0),this.handles.add(G({prepare:()=>this.prepareFrame()})),this.handles.add(this.view.state.watch("cameraController",(()=>{this.cameraSetByUser=!0,this.handles.remove(gy)}))),this.handles.add(Z(this.view,"state.events","camera-projection-changed",(()=>this.notifyChange("scale"))))}destroy(){this.deinit(),this.handles&&(this.handles.destroy(),this.handles=null),this.propertiesPool&&(this.propertiesPool.destroy(),this.propertiesPool=null)}init(){this.constraintsManager=new ry({view:this.view}),this.prepareFrame();const e=this.getInitialProperties();this.cameraSetByUser=!1,this._set("ready",!0);for(const t of e)this.set(t.name,t.value);if(!this.cameraSetByUser){const e=this.view.get("map.initialViewProperties.viewpoint")||this.view.initialExtent;e&&this.isCompatible(e)?this.setInitialView(e):2===this.view.state.viewingMode&&this.handles.add(K(this.view.basemapTerrain,"ready",(()=>{this.handles.remove(gy),this.setInitialView(this.view.dataExtent)})),gy)}}deinit(){this.cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this.cameraSetByUser=!1,this.handles.remove(gy),this.constraintsManager&&(this.constraintsManager.destroy(),this.constraintsManager=null))}async goTo(e,t){const i={animate:!0,...t};return C(this.gotoOperation)&&this.gotoOperation.abort(i.animate),this.gotoOperation=new ay(e,i,this.view),this.view.resourceController.scheduler.stopFrame(),this.gotoOperation}debugSetCameraOnContent(){this.setStateCamera(Zi(this.view),{applyConstraints:!1})}step(e){const t=this.view.state,i=t&&this.view.state.cameraController;i&&(t.updateCamera((t=>{i.stepController(e,t)})),i.steppingFinished&&i.finishController())}cancelGoToOperation(){C(this.gotoOperation)&&(this.gotoOperation.abort(),this.gotoOperation=null)}getInitialProperties(){const e=new Set,t=[];for(const{propertyName:i,overrides:r}of cy){const s=e.has(i),a=this._isOverridden(i);!s&&a&&t.push({name:i,value:this._get(i)}),this._clearOverride(i),(s||a)&&r.forEach((t=>e.add(t)))}return t}setInitialView(e){if(M(e)||this.cameraSetByUser)return;if(e instanceof t)return void this.setStateCamera(Hi(this.view,e),{applyConstraints:!1});if(e instanceof s){if(e.targetGeometry instanceof bl){const t=Yi(this.view,e.targetGeometry,0,.5,0);return void(C(t)&&this.setStateCamera(Hi(this.view,t),{applyConstraints:!0}))}const t={applyConstraints:!e.camera},i=this.viewpointToCamera(e);return void this.setStateCamera(i,t)}const i=Yi(this.view,e,0,.5,0);C(i)&&this.setStateCamera(Hi(this.view,i),{applyConstraints:!0})}updatePropertyBeforeReady(e,t){return!this.ready&&(this._override(e,t),t&&-1!==hy.indexOf(e)&&this._override("hasInitialView",!0),!0)}isCompatible(e){return!M(e)&&(e instanceof s?e.camera?this.isCompatible(e.camera):this.isCompatible(e.targetGeometry):e instanceof t?this.isCompatible(e.position):e.spatialReference&&Tl(e.spatialReference,this.view.spatialReference))}getPreservingHeadingTilt(e=dy){return this.cameraSetByUser?(e.heading=this.camera.heading,e.tilt=this.camera.tilt):(e.heading=0,e.tilt=.5),e}centerPointAtDistanceToCamera(e,t,i=py){const{heading:r,tilt:s}=this.getPreservingHeadingTilt(),a=Xi(this.view,r,s,e,t,1);return M(a)?null:(i.copyFrom(this.view.state.camera),i.eye=a.eye,i.center=a.center,i.up=a.up,i)}centerToCamera(e){const t=this.view.pointsOfInterest.centerOnContent;t.runTask();const i=t.distance;return this.centerPointAtDistanceToCamera(e,i)}extentToCamera(e){const{heading:t,tilt:i}=this.getPreservingHeadingTilt(),r=Yi(this.view,e,t,i,1,uy);return C(r)?Hi(this.view,r):null}scaleToCamera(e){if(null==e)return null;const t=this.view.pointsOfInterest.centerOnContent;t.runTask();const i=t.renderLocation,r=t.location.latitude,s=Ki(this.view,e,r);return this.centerPointAtDistanceToCamera(i,s)}zoomToCamera(e){return this.scaleToCamera(Ji(this.view,e))}viewpointToCamera(e){return Hi(this.view,$i(this.view,e))}setStateCamera(e,t){return!(M(e)||!this.view.state.stopActiveCameraController())&&(this.cameraSetByUser=!0,t.doNotCancelGoToOperation||this.cancelGoToOperation(),this.view.state.updateCamera((i=>{t.positionAndOrientationOnly?(i.eye=e.eye,i.center=e.center,i.up=e.up):i.copyFrom(e),t.applyConstraints&&im(this.view,i)})),t.applyConstraints||(this.view.state.cameraController=new sy({view:this.view,desiredCamera:e})),!0)}prepareFrame(){const{container:e,canvas:t}=this.view;if(!e||!t)return;C(this.updateDevicePixelRatio)&&this.updateDevicePixelRatio();const i=this.view.pixelRatio,r=Math.round(e.clientWidth*i),s=Math.round(e.clientHeight*i);if(0!==r&&0!==s&&(t.width===r&&t.height===s||(t.width=r,t.height=s),this.view.state)){const e=this.view.state.camera;e.fullWidth===r&&e.fullHeight===s&&e.pixelRatio===i||(py.copyFrom(e),py.pixelRatio!==i&&(this.paddingToArray(this.padding,i,my),py.padding=my),py.fullWidth=r,py.fullHeight=s,py.pixelRatio=i,this.view.state.camera=py)}}updateElevation(e){const t=this.view.basemapTerrain&&this.view.basemapTerrain.spatialReference,i=this.view.renderCoordsHelper.getAltitude(e.eye),r=t?Vi(this.view,e.eye):0;e.relativeElevation=i-r}};e([le({type:t,dependsOn:["view.state.camera","ready"]})],oy.prototype,"camera",null),e([le({type:t,dependsOn:["view.state.contentCamera","ready"]})],oy.prototype,"contentCamera",null),e([le({type:Cl})],oy.prototype,"center",null),e([le({type:bl})],oy.prototype,"extent",null),e([le({readOnly:!0})],oy.prototype,"frustum",null),e([le({readOnly:!0})],oy.prototype,"hasInitialView",null),e([le({readOnly:!0,type:Boolean})],oy.prototype,"ready",void 0),e([le({type:Number})],oy.prototype,"scale",null),e([le()],oy.prototype,"padding",null),e([le({readOnly:!0})],oy.prototype,"screenCenter",null),e([le({constructOnly:!0})],oy.prototype,"view",void 0),e([le({type:s})],oy.prototype,"viewpoint",null),e([le({type:Number})],oy.prototype,"zoom",null),e([le({constructOnly:!0})],oy.prototype,"updateDevicePixelRatio",void 0),oy=e([ce("esri.views.3d.state.ViewStateManager")],oy);var ly=oy;const hy=["camera","viewpoint","extent","scale","center","zoom"],cy=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],dy={heading:0,tilt:0},uy=new t,py=new co,my=nr(),gy="pending-initial-view";class fy{constructor(e,t,i){this.viewingMode=e,this.layerProvider=t,this.view=i,this.externalIntersectionHandlers=new N,this.tolerance=uo.DEFAULT_TOLERANCE,this.tmpRay=Xn(),this.validateHUDIntersector=new uo(this.viewingMode),this.validateHUDIntersector.options.hud=!1}intersectScreen(e,t){return this.intersectRay(this.getPickRay(e,this.tmpRay),yy(this.viewingMode),t)}intersectScreenFreePointFallback(e,t){return this.intersectRayFreePointFallback(this.getPickRay(e,this.tmpRay),t)}intersectRayFreePointFallback(e,t){return this.intersectRay(e,yy(this.viewingMode),t)||this.intersectRayFreePointLocal(e,t)}intersectRay(e,t,i,r){return t.options.selectionMode=!1,t.options.store=0,this.computeIntersection(e,t,r),!!t.results.min&&t.results.min.getIntersectionPoint(i)}getCenterRayWithSubpixelOffset(e,t,i=.5,r=.5){return e.getRenderCenter(Cy,i,r),Cy[0]+=.0466,Cy[1]-=.0123,Do(e,Cy,t)}intersectIntersectorScreen(e,t,i){this.computeIntersection(this.getPickRay(e,this.tmpRay),t,i)}intersectToolIntersectorScreen(e,t,i){const r=this.getPickRay(e,this.tmpRay);this.intersectToolIntersectorRay(r,t,i)}intersectToolIntersectorRay(e,t,i){t.options.selectionMode=!0,this.computeIntersection(e,t,i);const r=t.results.min;!!this.view.basemapTerrain&&this.view.basemapTerrain.opaque||r.hasIntersectionPoint&&"TerrainRenderer"!==r.intersector||(t.options.selectionMode=!1,this.computeIntersection(e,t,i))}setTolerance(e=uo.DEFAULT_TOLERANCE){this.tolerance=e}addIntersectionHandler(e){this.externalIntersectionHandlers.push(e),this.externalIntersectionHandlers.sort(((e,t)=>"Terrain"===e.type?1:"Terrain"===t.type?-1:0))}removeIntersectionHandler(e){this.externalIntersectionHandlers.removeUnordered(e),this.externalIntersectionHandlers.sort(((e,t)=>"Terrain"===e.type?1:"Terrain"===t.type?-1:0))}getPickRay(e,t=Xn()){const i=this.view.state.camera;return Mo(i,e,t)}intersectRayFreePointLocal(e,t){if(2!==this.viewingMode||M(e))return!1;const i=this.view.renderDataExtent;if(M(i))return Pe(t,e.origin,we(on.get(),e.direction)),!0;const r={x:i.xmax-i.xmin,y:i.ymax-i.ymin,z:8*Math.max(i.xmax-i.xmin,i.ymax-i.ymin)},s=Math.max(r.x,r.y,r.z);if(0===s)return Pe(t,e.origin,we(on.get(),e.direction)),!0;const a=this.view.state.camera,n=Math.max(0,i.xmin-a.eye[0],a.eye[0]-i.xmax),o=Math.max(0,i.ymin-a.eye[1],a.eye[1]-i.ymax),l=Math.sqrt(n*n+o*o),h=Math.abs(a.relativeElevation)+Number.MIN_VALUE,c=Math.max(0,Math.log(s/h))**2;let d=s/Math.max(1,c);d=Math.max(d,Math.min(l,s));const u=Ce(on.get(),e.direction,d/_e(e.direction));return Pe(t,e.origin,u),!0}intersectElevationFromScreen(e,t,i=0,r=null){return this.intersectElevation(this.getPickRay(e,this.tmpRay),t,i,r)}intersectElevation(e,t,i=0,r=null){if(M(e))return null;const s=C(t)?t.mode:"absolute-height",a=C(t)?D(t.offset,0):0,n="on-the-ground"!==s?a+i:0,o=n/this.view.renderCoordsHelper.unitInMeters;if("absolute-height"===s){if(this.view.renderCoordsHelper.intersectInfiniteManifold(e,n,by)){const e=this.view.computeMapPointFromVec3d(by);return e.z-=a,e}return null}const l=this.view.state.camera,h=ne(on.get());l.projectToRenderScreen(e.origin,h);const c=this.prepareFilters(null,xy),d=this.view.slicePlane,u=C(d)?po(d):null,p=new uo(this.viewingMode);p.options.store=0,p.options.verticalOffset=o;const m=e.origin,g=Pe(on.get(),m,e.direction);p.reset(m,g),p.point=h,p.camera=l,p.filterPredicate=null;const f=C(r)?"type"in r&&"graphics"===r.type?e=>e.metadata.layerUid!==r.uid:e=>e.metadata.graphicUid!==r.uid:null;switch(s){case"relative-to-scene":{const e=e=>(M(f)||f(e))&&e.metadata&&e.metadata.isElevationSource;p.intersect(c.layers,h,l,this.tolerance,null,e),this.externalIntersectionHandlers.forAll((e=>{if("I3S"===e.type||"Terrain"===e.type){const t=e.slicePlane?u:null;e.intersect(p,t,p.rayBeginPoint,p.rayEndPoint,h)}}))}break;case"on-the-ground":case"relative-to-ground":this.externalIntersectionHandlers.forAll((e=>{if(e.isGround){const t=e.slicePlane?u:null;e.intersect(p,t,p.rayBeginPoint,p.rayEndPoint,h)}}))}if(p.results.min.getIntersectionPoint(by)){const e=this.view.computeMapPointFromVec3d(by);return e.z=i,e}return null}computeIntersection(e,t,i){if(M(e))return;const r=this.view.state.camera,s=ne(on.get());r.projectToRenderScreen(e.origin,s);const a=this.prepareFilters(i,xy);t.options.selectOpaqueTerrainOnly=!i||!("include"in i||"exclude"in i);const n=e.origin,o=Pe(on.get(),e.origin,e.direction);t.reset(n,o),t.intersect(a.layers,s,r,this.tolerance);const l=this.view.slicePlane,h=C(l)?po(l):null;t.intersect(a.sliceableLayers,s,r,this.tolerance,h);const c=i&&(i.requiresGroundFeedback||i.enableDraped);this.externalIntersectionHandlers.forAll((e=>{if(t.options.isFiltered=!a.filterLayerUid(e.intersectionHandlerId),e.isGround&&c||!t.options.isFiltered){const i=e.slicePlane?h:null;e.intersect(t,i,n,o,s)}}));const d=on.get();if(i&&i.enableDraped&&t.results.ground.getIntersectionPoint(d)){const e=this.view.basemapTerrain.overlayManager.renderer,i=this.view.renderCoordsHelper.spatialReference,r=on.get();this.view.renderCoordsHelper.fromRenderCoords(d,r,this.view.spatialReference),r[2]=D(this.view.elevationProvider.getElevation(d[0],d[1],d[2],i,"ground"),0),e.intersect(t,r,a.filterRenderGeometry)}t.sortResults();const u=t.results.hud;if(u.hasIntersectionPoint){const e=ne(on.get()),i=on.get(),s=on.get();this.unprojectHUDResultRay(u.center,e,i,s);const n=De(u.center,i)/De(i,s)*.99;this.validateHUDIntersector.reset(i,s),this.validateHUDIntersector.intersect(a.layers,e,r,this.tolerance),this.validateHUDIntersector.intersect(a.sliceableLayers,e,r,this.tolerance,h),this.externalIntersectionHandlers.forAll((t=>{if(!a.filterLayerUid(t.intersectionHandlerId))return;const r=t.slicePlane?h:null;t.intersect(this.validateHUDIntersector,r,i,s,e)}));const o=this.validateHUDIntersector.results.min;(null==o.dist||n<=o.dist)&&(t.results.min.copyFrom(u),t.results.all.splice(0,0,u))}}prepareFilters(e,t){const i=[],r=[];return this.layerProvider.forEachLayer((e=>{e.isPickable&&(e.isSliceable?r:i).push(e)})),t.include=e&&e.include,t.exclude=e&&e.exclude,t.layers.length=0,t.sliceableLayers.length=0,vy(i,t.filterLayer,t.layers),vy(r,t.filterLayer,t.sliceableLayers),t}unprojectHUDResultRay(e,t,i,r){const s=this.view.state.camera;s.projectToRenderScreen(e,t);const a=ne(on.get());a[0]=t[0],a[1]=t[1],a[2]=0,s.unprojectFromRenderScreen(a,i),a[2]=1,s.unprojectFromRenderScreen(a,r)}}function vy(e,t,i){for(const r of e)t&&!t(r)||i.push(r);return i}let _y;function yy(e){return _y||(_y=new uo(e)),_y.viewingMode=e,_y}const xy={include:null,exclude:null,layers:[],sliceableLayers:[],filterLayer:e=>xy.filterLayerUid(e.apiLayerUid),filterLayerUid(e){const{include:t,exclude:i}=xy;return M(e)?null==t&&null==i:(null==t||t.has(e))&&(null==i||!i.has(e))},filterRenderGeometry:e=>xy.filterLayerUid(e.layerUid)};function wy(e){return"object"==typeof e&&"intersect"in e}const by=fe(),Cy=se();let Ty=class extends(tr.EventedMixin(yi)){constructor(e){super(e),this.im=new Array,this.ground=new Array,this.scene=new Array,this.handles=new Map,this.lastElevationQuery=null,this.elevationCacheEnabled=!1}destroy(){this._elevationQuery=R(this._elevationQuery)}get elevationQuery(){return M(this._elevationQuery)&&(this._elevationQuery=new oo(this.view.resourceController.scheduler,this.view.spatialReference,(()=>this.view.map&&this.view.map.ground),{maximumAutoTileRequests:4})),this._elevationQuery}enableElevationCache(e){e||(this.lastElevationQuery=null),this.elevationCacheEnabled=e}getElevation(e,t,i,r,s){if(this.elevationCacheEnabled&&null!=this.lastElevationQuery){const a=this.lastElevationQuery;if(e===a.x&&t===a.y&&i===a.z&&r.equals(a.spatialReference)&&s===a.queryContext)return a.result}let a=null;return a=Sy(a,this.im,e,t,i,r,s),M(a)&&(a=Sy(a,this.ground,e,t,i,r,s)),"scene"===s&&(a=Sy(a,this.scene,e,t,i,r,s)),this.elevationCacheEnabled&&(this.lastElevationQuery={x:e,y:t,z:i,spatialReference:r,queryContext:s,result:a}),a}queryElevation(e,t,i,r,s,a=null,n=0){const o=l();return this.elevationQuery.queryElevation(e,t,a,n).then((a=>{"scene"===s&&(a=Sy(a,this.scene,e,t,i,r,s)),o.resolve(a)})).catch((a=>{c(a)?o.reject(a):o.resolve(this.getElevation(e,t,i,r,s))})),o.promise}register(e,t){this.handles.set(t,t.on("elevation-change",(e=>this.emit("elevation-change",e)))),this[e].push(t)}unregister(e){this.handles.has(e)&&(this.handles.get(e).remove(),this.handles.delete(e));for(const t of[this.im,this.ground,this.scene]){const i=t.indexOf(e);i>-1&&t.splice(i,1)}}};function Sy(e,t,i,r,s,a,n){for(const o of t){const t=o.getElevation(i,r,s,a,n);C(t)&&(e=C(e)?Math.max(t,e):t)}return e}e([le({constructOnly:!0})],Ty.prototype,"view",void 0),e([le({readOnly:!0,aliasOf:"view.basemapTerrain.spatialReference"})],Ty.prototype,"spatialReference",void 0),Ty=e([ce("esri.views.3d.support.CombinedElevationProvider")],Ty);class Py{static isValidProfile(e){return e in Py.profiles}static getDefaultProfile(){return O("trident")||O("esri-iPhone")?"low":"medium"}static apply(e,t){const i=Py.profiles[e];t.graphics3D.maxTotalNumberOfFeatures=i.graphics3D.maxTotalNumberOfFeatures,t.graphics3D.maxTotalNumberOfPrimitives=i.graphics3D.maxTotalNumberOfPrimitives,t.graphics3D.polygonLodFactor=i.graphics3D.polygonLodFactor,t.graphics3D.polylineLodFactor=i.graphics3D.polylineLodFactor;{const e=t.sceneService["3dObject"],r=i.sceneService["3dObject"];e.lodFactor=r.lodFactor,e.lodCrossfadeinDuration=r.lodCrossfadeinDuration,e.lodCrossfadeoutDuration=r.lodCrossfadeoutDuration,e.lodCrossfadeUncoveredDuration=r.lodCrossfadeUncoveredDuration}t.sceneService.point.lodFactor=i.sceneService.point.lodFactor,t.sceneService.integratedMesh.lodFactor=i.sceneService.integratedMesh.lodFactor,t.sceneService.pointCloud.lodFactor=i.sceneService.pointCloud.lodFactor,t.sceneService.uncompressedTextureDownsamplingEnabled=i.sceneService.uncompressedTextureDownsamplingEnabled,t.tiledSurface.lodBias=i.tiledSurface.lodBias,t.tiledSurface.angledSplitBias=i.tiledSurface.angledSplitBias,t.tiledSurface.reduceTileLevelDifferences=i.tiledSurface.reduceTileLevelDifferences,t.tiledSurface.textureFadeDuration=i.tiledSurface.textureFadeDuration,t.antialiasingEnabled=i.antialiasingEnabled,t.physicallyBasedRenderingEnabled=i.physicalBasedRenderingEnabled,t.highQualityTransparency=i.highQualityTransparency,t.memoryLimit=i.memoryLimit,t.additionalCacheMemory=i.additionalCacheMemory,t.frameRate=i.frameRate,t.maximumRenderResolution=i.maximumRenderResolution,t.maximumPixelRatio=i.maximumPixelRatio}}function Ry(){const e=!!O("esri-mobile");return{low:{graphics3D:{maxTotalNumberOfFeatures:25e3,maxTotalNumberOfPrimitives:85e4,polygonLodFactor:.5,polylineLodFactor:1},sceneService:{"3dObject":{lodFactor:.2,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:0},point:{lodFactor:1},integratedMesh:{lodFactor:.6},pointCloud:{lodFactor:.5},uncompressedTextureDownsamplingEnabled:!0},tiledSurface:{lodBias:-1,angledSplitBias:.5,reduceTileLevelDifferences:!1,textureFadeDuration:0},antialiasingEnabled:!1,physicalBasedRenderingEnabled:!1,highQualityTransparency:!1,memoryLimit:200,additionalCacheMemory:0,frameRate:0,maximumRenderResolution:null,maximumPixelRatio:1},medium:{graphics3D:{maxTotalNumberOfFeatures:5e4,maxTotalNumberOfPrimitives:17e5,polygonLodFactor:e?.8:1,polylineLodFactor:e?1.2:1.5},sceneService:{"3dObject":{lodFactor:1,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:400},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:e},tiledSurface:{lodBias:0,angledSplitBias:1,reduceTileLevelDifferences:!O("disable-feature:reduce-map-tile-levels"),textureFadeDuration:400},antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,memoryLimit:e?600:750,additionalCacheMemory:e?0:150,frameRate:0,maximumRenderResolution:null,maximumPixelRatio:1},high:{graphics3D:{maxTotalNumberOfFeatures:5e4,maxTotalNumberOfPrimitives:17e5,polygonLodFactor:e?1.2:2,polylineLodFactor:e?1.2:2},sceneService:{"3dObject":{lodFactor:1,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:400},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:!1},tiledSurface:{lodBias:0,angledSplitBias:1,reduceTileLevelDifferences:!O("disable-feature:reduce-map-tile-levels"),textureFadeDuration:400},antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,memoryLimit:e?900:1500,additionalCacheMemory:0,frameRate:0,maximumRenderResolution:e?null:4096,maximumPixelRatio:e?1:null}}}Py.debug={reset(){const e=Ry();for(const t in e)Py.profiles[t]=e[t]}},function(e){e.profiles=Ry()}(Py||(Py={}));var My=Py;let Dy=class extends yi{constructor(){super(...arguments),this.color=new sr([0,255,255]),this.haloColor=null,this.haloOpacity=1,this.fillOpacity=.25,this.shadowOpacity=.4,this.shadowColor=new sr([0,0,0]),this.shadowDifference=.2}static toEngineOptions(e){const t=sr.toUnitRGBA(e.color),i=C(e.haloColor)?sr.toUnitRGBA(e.haloColor):t,r=sr.toUnitRGBA(e.shadowColor);return{color:Dl(t[0],t[1],t[2],t[3]),haloColor:Dl(i[0],i[1],i[2],i[3]),haloOpacity:e.haloOpacity,haloOpacityOccluded:.25*e.haloOpacity,fillOpacity:e.fillOpacity,fillOpacityOccluded:.25*e.fillOpacity,shadowOpacity:e.shadowOpacity,shadowColor:Dl(r[0],r[1],r[2],r[3]),occludedShadowOpacity:e.shadowOpacity*(1-e.shadowDifference)}}};e([le({type:sr})],Dy.prototype,"color",void 0),e([le({type:sr})],Dy.prototype,"haloColor",void 0),e([le()],Dy.prototype,"haloOpacity",void 0),e([le()],Dy.prototype,"fillOpacity",void 0),e([le()],Dy.prototype,"shadowOpacity",void 0),e([le({type:sr})],Dy.prototype,"shadowColor",void 0),e([le()],Dy.prototype,"shadowDifference",void 0),Dy=e([ce("esri.views.3d.support.HighlightOptions")],Dy);var Ay=Dy;class Oy{constructor(e,t,i=null){this.spatialReference=t,this.unitInMeters=Pl(this.spatialReference,wt(this.spatialReference).metersPerDegree),this._geometryServicePromise=Wo(this.loadGeometryService(e,i))}async loadGeometryService(e,t){if(t)return t;try{return await Ol(e&&e.get("portalItem"))}catch{throw new o("mapcoordshelper:missing-geometry-service","Must specify geometryService in esri/config")}}async awaitGeometryService(){const e=await this._geometryServicePromise;if(!0===e.ok)return e.value;throw e.error}async toGeographic(e){const t=await this.awaitGeometryService();let i,r=!0;Array.isArray(e[0])&&"number"!=typeof e[0]?i=e:(i=[e],r=!1);const s=i.map((e=>e instanceof Cl?e:new Cl(e,this.spatialReference))),a=new Fl({geometries:s,outSpatialReference:dr.WGS84}),n=(await t.project(a)).map((e=>"point"===e.type?[e.x,e.y]:void 0));return r?n:n[0]}}let Fy=class extends yi{constructor(){super(...arguments),this.minTotalNumberOfFeatures=2e3,this.maxTotalNumberOfFeatures=5e4,this.maxTotalNumberOfPrimitives=17e5,this.polygonLodFactor=1,this.polylineLodFactor=1}};e([le()],Fy.prototype,"minTotalNumberOfFeatures",void 0),e([le()],Fy.prototype,"maxTotalNumberOfFeatures",void 0),e([le()],Fy.prototype,"maxTotalNumberOfPrimitives",void 0),e([le()],Fy.prototype,"polygonLodFactor",void 0),e([le()],Fy.prototype,"polylineLodFactor",void 0),Fy=e([ce("esri.views.3d.support.QualitySettings.Graphics3DSettings")],Fy);let Iy=class extends yi{constructor(){super(...arguments),this.lodFactor=1}};e([le()],Iy.prototype,"lodFactor",void 0),Iy=e([ce("esri.views.3d.support.QualitySettings.LoDFactorSettings")],Iy);let zy=class extends Iy{constructor(){super(...arguments),this.lodCrossfadeinDuration=0,this.lodCrossfadeoutDuration=0,this.lodCrossfadeUncoveredDuration=0}};zy=e([ce("esri.views.3d.support.QualitySettings.LoDFactor3DObjectSettings")],zy);let Ey=class extends yi{constructor(){super(...arguments),this["3dObject"]=new zy,this.point=new Iy,this.integratedMesh=new Iy,this.pointCloud=new Iy,this.uncompressedTextureDownsamplingEnabled=!1}};e([le({type:zy})],Ey.prototype,"3dObject",void 0),e([le({type:Iy})],Ey.prototype,"point",void 0),e([le({type:Iy})],Ey.prototype,"integratedMesh",void 0),e([le({type:Iy})],Ey.prototype,"pointCloud",void 0),e([le()],Ey.prototype,"uncompressedTextureDownsamplingEnabled",void 0),Ey=e([ce("esri.views.3d.support.QualitySettings.SceneServiceSettings")],Ey);let Ly=class extends yi{constructor(){super(...arguments),this.lodBias=0,this.angledSplitBias=1,this.reduceTileLevelDifferences=!0,this.textureFadeDuration=500}};e([le()],Ly.prototype,"lodBias",void 0),e([le()],Ly.prototype,"angledSplitBias",void 0),e([le()],Ly.prototype,"reduceTileLevelDifferences",void 0),e([le()],Ly.prototype,"textureFadeDuration",void 0),Ly=e([ce("esri.views.3d.support.QualitySettings.TiledSurfaceSettings")],Ly);let Vy=class extends yi{constructor(){super(...arguments),this.graphics3D=new Fy,this.sceneService=new Ey,this.tiledSurface=new Ly,this.antialiasingEnabled=!0,this.physicallyBasedRenderingEnabled=!1,this.highQualityTransparency=!0}};e([le({type:Fy})],Vy.prototype,"graphics3D",void 0),e([le({type:Ey})],Vy.prototype,"sceneService",void 0),e([le({type:Ly})],Vy.prototype,"tiledSurface",void 0),e([le()],Vy.prototype,"antialiasingEnabled",void 0),e([le()],Vy.prototype,"physicallyBasedRenderingEnabled",void 0),e([le()],Vy.prototype,"highQualityTransparency",void 0),e([le()],Vy.prototype,"memoryLimit",void 0),e([le()],Vy.prototype,"additionalCacheMemory",void 0),e([le()],Vy.prototype,"frameRate",void 0),e([le()],Vy.prototype,"maximumRenderResolution",void 0),e([le()],Vy.prototype,"maximumPixelRatio",void 0),Vy=e([ce("esri.views.3d.support.QualitySettings.QualitySettings")],Vy);var ky=Vy;class jy{constructor(e,t,i,r){this.viewingMode=e,this.spatialReference=t,this.unitInMeters=i,this.coordinateSystem=r,this._coordinateSystem=function(e){const{value:t,operations:i}=e;return{operations:i,value:i.create(t)}}(r)}set extent(e){e&&function(e,t,i){e.operations.setExtent(e.value,t,i.value)}(this.coordinateSystem,e,this.coordinateSystem)}getAltitude(e){return t=this.coordinateSystem,i=e,t.operations.altitudeAt(t.value,i);var t,i}setAltitude(e,t,i=e){return Wm(this.coordinateSystem,i,t,e)}setAltitudeOfTransformation(e,t){!function(e,t,i,r){t!==r&&wr(r,t),ve(Zm,r[12],r[13],r[14]),Wm(e,Zm,i,Zm),r[12]=Zm[0],r[13]=Zm[1],r[14]=Zm[2]}(this.coordinateSystem,t,e,t)}worldUpAtPosition(e,t){return i=this.coordinateSystem,r=e,s=t,i.operations.axisAt(i.value,r,2,s);var i,r,s}worldBasisAtPosition(e,t,i){return function(e,t,i,r){return e.operations.axisAt(e.value,t,i,r)}(this.coordinateSystem,e,t,i)}basisMatrixAtPosition(e,t){const i=this.worldBasisAtPosition(e,0,on.get()),r=this.worldBasisAtPosition(e,1,on.get()),s=this.worldBasisAtPosition(e,2,on.get());return Rr(t,i[0],i[1],i[2],0,r[0],r[1],r[2],0,s[0],s[1],s[2],0,0,0,0,1),t}intersectManifoldClosestSilhouette(e,t,i){var r,s,a;return Qm(this.coordinateSystem,t,this._coordinateSystem),r=this._coordinateSystem,s=e,a=i,r.operations.intersectRayClosestSilhouette(r.value,s,a),i}intersectManifold(e,t,i){Qm(this.coordinateSystem,t,this._coordinateSystem);const r=on.get();return s=this._coordinateSystem,a=e,n=r,s.operations.intersectRay(s.value,a,n)?ye(i,r):null;var s,a,n}intersectInfiniteManifold(e,t,i){if(1===this.viewingMode)return this.intersectManifold(e,t,i);Qm(this.coordinateSystem,t,this._coordinateSystem);const r=this._coordinateSystem.value,s=on.get();return _o(r.plane,e,s)?ye(i,s):null}toRenderCoords(e,t,i){return Rl(e)?ut(e,t,this.spatialReference):pt(e,t,i,this.spatialReference)}fromRenderCoords(e,t,i=null){return Rl(t)?(C(i)&&(t.spatialReference=i),mt(e,this.spatialReference,t)):t instanceof dr?gt(e,this.spatialReference,t):pt(e,this.spatialReference,t,i)?t:null}static create(e,t){switch(e){case 2:return new jy(2,t,Pl(t),Gm(Bt,Ht([0,0,0],[0x4000000000000,0,0],[0,0x4000000000000,0])));case 1:return new jy(1,t,1,function(e){return Gm(Ja,Ka(0,0,0,wt(e).radius))}(t))}}}const Uy=(()=>{const e=new Array;return e[0]=10,e[1]=10,e[2]=10,e[3]=10,e[4]=5,e})(),qy=30,Hy=U.getLogger("esri.views.3d.support.MemoryController");class By{constructor(e){this._view=e,this.events=new tr,this.minQuality=.1,this._maxMemory=500,this._additionalCacheMemory=100,this._quality=1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._memoryUsed=0,this._memoryPredicted=0,this._cacheStorage=new Il,this._numQualityChanges=0,this._updating=!1}destroy(){this.events=null,this._cacheStorage.destroy()}getMemCache(e,t){return new zl(e,this._cacheStorage,t)}set maxMemory(e){null!=e&&e>0&&(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(1),this._maxMemory=e)}get maxMemory(){return this._maxMemory}set additionalCacheMemory(e){null!=e&&e>=0&&(this._additionalCacheMemory=e)}disableMemCache(){this._additionalCacheMemory=-4096}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._memoryUsed}resetStableQuality(){this._stableQuality=0}update(){if(this._updateMemory(),this._memoryPredicted<=0&&!this._updating)return;let e=this._layersUpdating();if(this._memoryPredicted<.6&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(1);else if(e)(this._memoryPredicted>1.1||this._memoryUsed>1)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>this.minQuality&&this._downscaleMemoryUsed<this._memoryUsed&&(this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._memoryUsed,this._canFastRecover=!1));else if(this._downscaleMemoryUsed=0,this._memoryUsed>1)this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._memoryPredicted;else if(this._stableQuality!==this._quality)if(this._memoryUsed<.75&&this._quality<1){this._stableQuality=this._quality;const t=.05;e=this._updateQuality(this._quality+t)}else this._quality<1&&(this._canFastRecover=!0);this.updating!==e&&(this._updating=e,this.events.emit("updating-changed",this.updating))}_updateQuality(e){return(e=Math.min(Math.max(e,this.minQuality),1))!==this._quality&&(this._quality=e,this.events.emit("quality-changed",this._quality),++this._numQualityChanges,!0)}_layersUpdating(){return this._view.allLayerViews.some((e=>!!e.updating))}_updateMemory(){let e=0,t=0;this._view.basemapTerrain&&this._view.basemapTerrain.getUsedMemory&&(e+=this._view.basemapTerrain.getUsedMemory());const i=this._view._stage&&this._view._stage.renderView&&this._view._stage.renderView.edgeView;C(i)&&(e+=i.usedMemory),this._view.allLayerViews&&this._view.allLayerViews.forEach((i=>{if(Ll(i)){const r=i.ignoresMemoryFactor()?this._quality:1;e+=i.getUsedMemory()*r,t+=i.getUnloadedMemory()*r}}));const r=null==this._warnMemoryUsage||Math.round(10*e)!==Math.round(10*this._warnMemoryUsage),s=1048576*this._maxMemory;if(e>s&&r){this._warnMemoryUsage=e;const i=e=>(e/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",r=Math.round(100*this._quality);Hy.warn(`Memory Limit exceeded! Limit: ${i(s)} Current: ${i(e)} Projected: ${i(e+t)} Quality: ${r}%`)}this._memoryUsed=e/s,this._memoryPredicted=(e+t)/s;const a=s-e;this._cacheStorage.maxSize=Math.max(0,a+1048576*this._additionalCacheMemory),this.events.emit("memory-used",this._memoryUsed)}get test(){const e=this;return{cacheStorage:this._cacheStorage,resetQualityChanges:()=>{const t=e._numQualityChanges;return e._numQualityChanges=0,t}}}}let Ny=class extends yi{constructor(){super(...arguments),this.updating=!1}};var Gy;e([le({readOnly:!0})],Ny.prototype,"updating",void 0),Ny=e([ce("esri.views.3d.support.ResourceController")],Ny),function(t){let i=class extends Ny{constructor(){super(...arguments),this._scheduler=null,this._memoryController=null,this._streamDataLoader=null,this._cameraChangeTime=0,this._handles=new ar,this._frameTask=null,this._scheduleTask=Bo,this._state=2}initialize(){var e;this._cameraChangeTime=this.now(),this._scheduler=No(this.now),this._memoryController=(e=this.view,new By(e)),this._streamDataLoader=new Vl,this._streamDataLoader.setup(30,Uy,this._scheduler),this._handles.add([this.view.watch("state.camera",((e,t)=>this._cameraChangedHandler(e,t)),!0),this.view.watch("stationary",(()=>this._stationaryChangedHandler())),this._memoryController.events.on("updating-changed",(()=>this.notifyChange("updating")))]),this._frameTask=G({update:e=>this.frame(e)}),this._scheduleTask=this._scheduler.registerTask(qo.RESOURCE_CONTROLLER)}destroy(){this._handles=R(this._handles),this._scheduleTask.remove(),this._frameTask=I(this._frameTask),this._streamDataLoader=R(this._streamDataLoader),this._memoryController=R(this._memoryController),this._scheduler=R(this._scheduler)}get updating(){var e,t;return!!(null!=(e=this._memoryController)&&e.updating||null!=(t=this._streamDataLoader)&&t.updating)}get scheduler(){return this._scheduler}get memoryController(){return this._memoryController}schedule(e,t,i){return this._scheduleTask.schedule(e,t,i)}createStreamDataRequester(e){const t=this._streamDataLoader;return{request:(i,r,s)=>t.request(i,r,e,s),get busy(){return!t.hasDownloadSlots(e)}}}frame(e){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step(W(e.deltaTime)),!this._scheduler)||(this._scheduler.state=this.state,this._scheduler.updateBudget(e)?(this._memoryController.update(),this._scheduler.frame()):this._memoryController.updating&&this._memoryController.update())}_cameraChangedHandler(e,t){e&&t&&e.almostEquals(t)||(this._cameraChangeTime=this._scheduler.now,this._scheduler.state=this.state)}_stationaryChangedHandler(){this.memoryController.resetStableQuality()}get state(){const e=this.view;return e.animation?this._state=0:e.interacting?this._state=1:(0===this._state&&(this._cameraChangeTime=0),this._scheduler.now-this._cameraChangeTime<=r?this._state=1:this._state=2),this._state}get test(){return{getQueueStats:e=>this._streamDataLoader.test.loadQueue.getStatsForType(e),state:this.state}}};e([le({constructOnly:!0})],i.prototype,"view",void 0),e([le({constructOnly:!0})],i.prototype,"now",void 0),e([le()],i.prototype,"_scheduler",void 0),e([le()],i.prototype,"_memoryController",void 0),e([le()],i.prototype,"_streamDataLoader",void 0),e([le({readOnly:!0})],i.prototype,"updating",null),i=e([ce("esri.views.3d.support.ResourceController")],i),t.ResourceController=i;const r=300}(Gy||(Gy={}));class Wy{constructor(e,t,i,r){this._streamDataRequester=e,this._stage=t,this._textureOptions=i,this._textureRequests=new Map,this._frameTask=C(r)?r.registerTask(qo.TEXTURE_UNLOAD):Bo}destroy(){this._frameTask.remove(),this._textureRequests.forEach((e=>this.releaseTextureRequest(e))),this._textureRequests.clear()}async fromUrl(e,t,i){m(i);const r=C(i)&&i.signal,s=this.makeUid(e,t);let a=this._textureRequests.get(s);if(!a){const i=h(),r=this._streamDataRequester.request(e,"image",{uid:s,signal:i.signal});a={referenceCount:0,texture:null,textureAsync:null,abortController:i},this._textureRequests.set(s,a),a.textureAsync=r.then((i=>{const r=this.createTexture(e,i,t);return a.texture=r,a.abortController=null,this.addToStage(r),{uid:s,texture:r}}),(e=>{throw a.abortController=null,e}))}return a.referenceCount++,new Promise(((e,t)=>{f(r,(()=>{t(p())})),a.textureAsync.then(e,t)})).catch((e=>{throw this.release(s),e}))}fromData(e,t){const i=this.makeUid(e);let r=this._textureRequests.get(i);return r||(r={referenceCount:0,texture:t(),textureAsync:null,abortController:null},this.addToStage(r.texture),this._textureRequests.set(i,r)),r.referenceCount++,{uid:i,texture:r.texture}}release(e){if(!this._textureRequests)return;const t=this._textureRequests.get(e);t?(t.referenceCount<1&&console.warn("TextureCollection: reference count is < 1 for "+e),t.referenceCount--,t.referenceCount<1&&this._frameTask.schedule((()=>this.releaseNow(e)))):console.warn(`TextureCollection: texture doesn't exist: '${e}'`)}get test(){return{textureRequests:this._textureRequests}}releaseNow(e){if(!this._textureRequests)return;const t=this._textureRequests.get(e);!t||t.referenceCount>0||(this.releaseTextureRequest(t),this._textureRequests.delete(e))}releaseTextureRequest(e){e.texture?this.removeFromStage(e.texture):e.abortController&&(e.abortController.abort(),e.abortController=null)}createTexture(e,t,i){const r={...this._textureOptions,powerOfTwoResizeMode:2};if(oh(e)){if(i||0===t.width&&0===t.height){const e=t.width?t.height/t.width:1;i=i||64,e>1?(t.width=Math.round(i/e),t.height=i):(t.width=i,t.height=Math.round(i*e))}this._stage.renderView&&Xr(this._stage.renderView.renderingContext).svgAlwaysPremultipliesAlpha&&(r.preMultiplyAlpha=!1)}return r.width=t.width,r.height=t.height,new lh(t,r)}addToStage(e){this._stage.add(e)}removeFromStage(e){this._stage.remove(e)}makeUid(e,t){return null!=t?`${e}.${t}px`:e}}class Qy{constructor(e){this.textures=null,this.streamDataRequester=null,this.graphicsOwners=[],this.screenSizePerspectiveHandles=null,this.cimSymbolRasterizer=null,this.viewState=e.viewState,this.view=e.view,this.pointsOfInterest=e.pointsOfInterest,this.objectResourceCache=e.objectResourceCache,this.streamDataRequester=e.resourceController.createStreamDataRequester(4),this.textures=new Wy(this.streamDataRequester,e.view._stage,{preMultiplyAlpha:!0,wrap:{s:33071,t:33071}},e.resourceController.scheduler);const t=wt(this.view.spatialReference).radius;this.screenSizePerspectiveSettings=Rs(e.viewingMode,t),this.screenSizePerspectiveSettingsLabels=Ms(e.viewingMode,t)}destroy(){this.textures.destroy(),this.textures=null,this.streamDataRequester=null}addGraphicsOwner(e){if(!e)return{remove(){}};this.graphicsOwners.push(e);const t="layer"in e?e.watch("layer.screenSizePerspectiveEnabled",(()=>this.updateScreenSizePerspectiveEnabled())):null;return this.updateScreenSizePerspectiveEnabled(),{remove:()=>{t&&(t.remove(),rh(this.graphicsOwners,e),this.updateScreenSizePerspectiveEnabled())}}}updateScreenSizePerspectiveEnabled(){const e=this.graphicsOwners.some((e=>!0===e.get("layer.screenSizePerspectiveEnabled")));if(e&&!this.screenSizePerspectiveHandles){this.screenSizePerspectiveHandles=new ar;const e=()=>this.updateScreenSizePerspectiveSettings();this.screenSizePerspectiveHandles.add([this.pointsOfInterest.centerOnSurfaceInfrequent.watch("distance",e,!0),this.viewState.events.on("camera-projection-changed",e)]),this.updateScreenSizePerspectiveSettings()}else!e&&this.screenSizePerspectiveHandles&&(this.screenSizePerspectiveHandles.destroy(),this.screenSizePerspectiveHandles=null)}updateScreenSizePerspectiveSettings(){const e=this.pointsOfInterest;Zy.distance=e.centerOnSurfaceInfrequent.distance,Zy.fovY=this.viewState.camera.fovY,this.screenSizePerspectiveSettings.update(Zy),this.screenSizePerspectiveSettingsLabels.update(Zy),this.view._stage.renderView.setNeedsRender()}}const Zy={distance:0,fovY:0};class Yy{constructor(e,t,i=""){this.graphics=e,this._symbol=new hh({symbolLayers:[new ch({material:{color:t},outline:{color:[255,255,255],size:1},resource:{primitive:"circle"}}),new dh({text:i,halo:{color:"white",size:1/.75},material:{color:t},size:12})]})}show(e,t){if(M(t))return;this.hide();const r=new Cl({x:e[0],y:e[1],z:e[2],spatialReference:t});this._graphic=new i({geometry:r,symbol:this._symbol}),this.graphics.add(this._graphic)}hide(){C(this._graphic)&&(this.graphics.remove(this._graphic),this._graphic=null)}}let Xy=class extends yi{constructor(e){super(e),this.handles=new ar}destroy(){this.handles.destroy()}};e([le({constructOnly:!0})],Xy.prototype,"renderCoordsHelper",void 0),e([le({constructOnly:!0})],Xy.prototype,"surface",void 0),e([le({constructOnly:!0})],Xy.prototype,"state",void 0),Xy=e([ce("esri.views.3d.support.PointOfInterest")],Xy);const Ky=Array;let Jy=class extends Xy{constructor(e){super(e),this._dirty=!1,this._propertiesPool=new no({location:Cl,renderLocation:Ky},this),this._estimatedSurfaceAltitude=0,this._pendingElevationQueryController=null,this.cameraName="camera",this.renderLocation=fe(),this.tmpPoint=new Cl}initialize(){if(this.scheduler&&this.handles.add(this.scheduler.registerTask(this.task,this)),this.runTask(),this.map){const e=()=>this._setDirty();this.handles.add(Z(this.map,"ground.layers","change",e,e,e))}this._updateRenderLocation()}destroy(){this._cancelPendingRequest(),this._propertiesPool.destroy(),this._propertiesPool=null}get _camera(){return this.state[this.cameraName]}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}get scale(){const e=this._camera,t=De(e.eye,this.renderLocation),i={renderCoordsHelper:this.renderCoordsHelper,state:{camera:e}};return Gi(i,t,0)}get updating(){return this._dirty||null!=this._pendingElevationQueryController}updateRenderLocation(){this._setDirty(),this._updateRenderLocation()}_setDirty(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))}_cancelPendingRequest(){const e=this._pendingElevationQueryController;e&&(this._pendingElevationQueryController=null,e.abort(),this.notifyChange("updating"))}get running(){return!this._pendingElevationQueryController&&this._dirty}runTask(){if(this._cancelPendingRequest(),this._dirty=!1,this.notifyChange("updating"),!this.map||!this.map.ground)return void this._updateSurfaceAltitude(0);this.renderCoordsHelper.fromRenderCoords(this._camera.eye,this.tmpPoint,this.state.spatialReference);let e=h();this.map.ground.queryElevation(this.tmpPoint,{signal:e.signal,cache:this.cache}).then((e=>this._updateSurfaceAltitude(e.geometry.z))).catch((e=>{c(e)||this._updateSurfaceAltitude(0)})).catch((()=>{})).then((()=>{this._pendingElevationQueryController===e&&(this._pendingElevationQueryController=null,this.notifyChange("updating")),e=null})),this._pendingElevationQueryController=e}_updateSurfaceAltitude(e){this._estimatedSurfaceAltitude!==e&&(this._estimatedSurfaceAltitude=e,this._updateRenderLocation())}_updateRenderLocation(){this.renderCoordsHelper.setAltitude($y,this._estimatedSurfaceAltitude,this._camera.eye),We(this._get("renderLocation"),$y)||this._set("renderLocation",ye(this._propertiesPool.get("renderLocation"),$y))}};e([le({constructOnly:!0})],Jy.prototype,"scheduler",void 0),e([le({constructOnly:!0})],Jy.prototype,"cache",void 0),e([le({constructOnly:!0})],Jy.prototype,"task",void 0),e([le({constructOnly:!0})],Jy.prototype,"cameraName",void 0),e([le({readOnly:!0})],Jy.prototype,"location",null),e([le({constructOnly:!0})],Jy.prototype,"map",void 0),e([le({readOnly:!0})],Jy.prototype,"renderLocation",void 0),e([le({readOnly:!0})],Jy.prototype,"scale",null),e([le({readOnly:!0})],Jy.prototype,"updating",null),Jy=e([ce("esri.views.3d.support.CameraOnSurface")],Jy);const $y=fe();var ex=Jy;const tx=Array;let ix=class extends Xy{constructor(e){super(e),this._propertiesPool=new no({location:Cl,renderLocation:tx},this),this._currentSurfaceAltitude=0,this._latestSurfaceAltitude=0,this.cameraName="camera",this.distance=0,this.renderLocation=fe(),this.updating=!1}initialize(){this._frameWorker=this.scheduler.registerTask(this.task,this),this.runTask()}destroy(){this._frameWorker&&(this._frameWorker.remove(),this._frameWorker=null),this._propertiesPool.destroy(),this._propertiesPool=null}get _camera(){return this.state[this.cameraName]}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}updateRenderLocation(){this.updating=!0,this._updateRenderLocation()}get estimatedSurfaceAltitude(){return this._latestSurfaceAltitude}get running(){return this.updating}runTask(){this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this.updating=!1}_updateRenderLocation(){const e=sx;let t=this.calculateSurfaceIntersection(this._currentSurfaceAltitude,e);const i=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!t&&i&&(t=this.calculateSurfaceIntersection(this._latestSurfaceAltitude,e),t&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));const r=ax;t&&this.latestSurfaceAltitudeChangesDistanceSignificantly(e,r)&&(ye(e,r),this._currentSurfaceAltitude=this._latestSurfaceAltitude),t?this.distance=De(this._camera.eye,e):(Ce(e,this._camera.viewForward,this._get("distance")),Pe(e,e,this._camera.eye)),We(this._get("renderLocation"),e)||this._set("renderLocation",ye(this._propertiesPool.get("renderLocation"),e))}calculateSurfaceIntersection(e,t){const i=this._camera;if(!this.renderCoordsHelper.intersectManifold(i.ray,e,t))return!1;if(this.state.isGlobal){const r=wt(this.renderCoordsHelper.spatialReference).radius,s=r+e,a=Ae(i.eye),n=a<s*s,o=De(i.eye,t);if(n&&o>r/4){const e=s-Math.sqrt(a);return Ce(t,i.viewForward,e),Pe(t,t,i.eye),!0}}else{const e=this.surface.ready?this.surface.extent:null;C(e)&&ft(e,this.surface.spatialReference,nx,this.renderCoordsHelper.spatialReference)&&(t[0]=ue(t[0],nx[0],nx[2]),t[1]=ue(t[1],nx[1],nx[3]))}return!0}latestSurfaceAltitudeChangesDistanceSignificantly(e,t){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||null==e)return!1;if(this.calculateSurfaceIntersection(this._latestSurfaceAltitude,t)){if(ma.TESTS_DISABLE_UPDATE_THRESHOLDS)return!0;const i=this._camera.eye,r=De(i,e),s=De(i,t);if(Math.abs(s-r)/r>rx)return!0}return!1}};e([le({constructOnly:!0})],ix.prototype,"scheduler",void 0),e([le({constructOnly:!0})],ix.prototype,"task",void 0),e([le({constructOnly:!0})],ix.prototype,"cameraName",void 0),e([le()],ix.prototype,"distance",void 0),e([le({constructOnly:!0})],ix.prototype,"estimateSurfaceAltitudeAtCenter",void 0),e([le({readOnly:!0})],ix.prototype,"location",null),e([le({readOnly:!0})],ix.prototype,"renderLocation",void 0),e([le()],ix.prototype,"updating",void 0),ix=e([ce("esri.views.3d.support.CenterOnSurface")],ix);const rx=.05,sx=fe(),ax=fe(),nx=Ct();var ox=ix;class lx{constructor(e){this.handles=new ar,this.events=new tr,this.contentLayerViews=e.contentLayerViews,this.handles.add(this.contentLayerViews.on("change",(e=>this.layerViewsChanged(e)))),this.layerViewsChanged({added:this.contentLayerViews.toArray(),removed:[],moved:[],target:this.contentLayerViews})}destroy(){this.handles&&(this.handles.destroy(),this.handles=null)}layerViewsChanged(e){e.added.forEach((e=>{"esri.views.3d.layers.SceneLayerView3D"===e.declaredClass&&this.handles.add(e.on("visible-geometry-changed",(()=>this.contentChanged())),e.uid)})),e.removed.forEach((e=>this.handles.remove(e.uid)))}contentChanged(){this.events.emit("request-update",hx)}}const hx={},cx=Array;let dx=class extends Xy{constructor(e){super(e),this._propertiesPool=new no({location:Cl,renderLocation:cx},this),this._dirty=!0,this.renderLocation=this._propertiesPool.get("renderLocation")}initialize(){this.handles.add([this.centerOnSurface.watch("renderLocation",(()=>this.updateRenderLocation())),this.state.watch("contentCamera",(()=>this.updateRenderLocation()))]),this.scheduler&&this.handles.add(this.scheduler.registerTask(qo.POINT_OF_INTEREST_FREQUENT,this))}destroy(){this._propertiesPool.destroy(),this._propertiesPool=null}get updating(){return this._dirty||this.centerOnSurface.updating}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}get running(){return this._dirty}runTask(){const e=this._get("renderLocation"),t=this.centerOnSurface.renderLocation,i=this.renderCoordsHelper,r=this.state.contentCamera;this._dirty=!1,i.worldUpAtPosition(t,ux);const s=Math.max(0,(Math.acos(Ie(ux,r.viewForward))-.5*Math.PI)*(r.aboveGround?1:-1));if(Number.isNaN(s)){if(!e||!be(e,t)){const e=this._propertiesPool.get("renderLocation");ye(e,t),this._set("renderLocation",e)}return}const a=1-ue(s/(.5*Math.PI),0,1),n=a*a*a;this._calculateScreenHorizontalEdgeOnSurface(mx);const o=this._propertiesPool.get("renderLocation");Oe(o,t,mx,n),e&&be(e,o)||this._set("renderLocation",o)}_calculateScreenHorizontalEdgeOnSurface(e){const t=this.state.contentCamera,i=t.getRenderCenter(se());if(i[1]=t.aboveGround?t.padding[2]:t.fullHeight-t.padding[0],this.estimateSurfaceIntersectionAtRenderPoint(i,e))return e;const r=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation);if(t.unprojectFromRenderScreen(i,px)){Te(px,px,t.eye);const i=we(px,px);if(this.renderCoordsHelper.intersectManifold(Yn(t.eye,i),r,e))return e}return this.renderCoordsHelper.setAltitude(e,r,t.eye)}updateRenderLocation(){this._dirty=!0}};e([le()],dx.prototype,"_dirty",void 0),e([le({constructOnly:!0})],dx.prototype,"scheduler",void 0),e([le({constructOnly:!0})],dx.prototype,"centerOnSurface",void 0),e([le({constructOnly:!0})],dx.prototype,"estimateSurfaceIntersectionAtRenderPoint",void 0),e([le({readOnly:!0})],dx.prototype,"updating",null),e([le({readOnly:!0})],dx.prototype,"location",null),e([le({readOnly:!0})],dx.prototype,"renderLocation",void 0),dx=e([ce("esri.views.3d.support.CenterOnSurface")],dx);const ux=fe(),px=fe(),mx=fe();var gx=dx;let fx=class extends yi{constructor(e){super(e),this.location=null,this._updateController=null,this._handles=new ar}get renderLocation(){if(!this.location)return null;const e=fe();return this.view.renderCoordsHelper.toRenderCoords(this.location,e),e}initialize(){this.view.state.isLocal&&(this._handles.add([this.watch(["surfaceView.spatialReference","surfaceView.extent"],(()=>this._update())),Z(this,"surface.layers","change",(()=>this._update()))]),this._update())}destroy(){this._handles.destroy()}_update(){if(this._updateController&&(this._updateController.abort(),this._updateController=null),!this.surfaceView||M(this.surfaceView.extent)||!this.surfaceView.spatialReference)return void this._set("location",null);const e=zt(this.surfaceView.extent),t=new Cl({x:e[0],y:e[1],z:0,spatialReference:this.surfaceView.spatialReference});this.surface&&this.surface.layers.length>0?(this._set("location",null),this._updateController=h(),this.surface.queryElevation(t,{noDataValue:0,signal:this._updateController.signal,cache:this.cache}).then((e=>{this._updateController=null,this._set("location",e.geometry)})).catch((e=>{c(e)||e&&"elevation-query:invalid-layer"===e.name||console.error("StableSurfaceCenter failed to update: ",e)}))):this._set("location",t)}};e([le({constructOnly:!0})],fx.prototype,"view",void 0),e([le({constructOnly:!0})],fx.prototype,"cache",void 0),e([le({readOnly:!0,aliasOf:"view.map.ground"})],fx.prototype,"surface",void 0),e([le({readOnly:!0,aliasOf:"view.basemapTerrain"})],fx.prototype,"surfaceView",void 0),e([le({readOnly:!0})],fx.prototype,"location",void 0),e([le({readOnly:!0})],fx.prototype,"renderLocation",null),fx=e([ce("esri.views.3d.terrain.StableSurfaceCenter")],fx);let vx=class extends yi{constructor(){super(...arguments),this.handles=new ar,this._tileGeometryUpdateExtent=Tt(),this._tileGeometryUpdateSpatialReference=null,this.events=new tr,this.updating=!1}initialize(){this.handles.add([this.surface.on("elevation-change",(e=>this._tileGeometryChanged(e))),this.scheduler.registerTask(qo.SURFACE_GEOMETRY_UPDATES,this)])}destroy(){this.handles&&(this.handles.destroy(),this.handles=null)}get running(){return this.updating}runTask(){this.updating&&(this._centerIntersectsExtent(this._tileGeometryUpdateExtent,this._tileGeometryUpdateSpatialReference)&&this.events.emit("request-update",_x),Tt(this._tileGeometryUpdateExtent),this._set("updating",!1))}_tileGeometryChanged(e){this._tileGeometryUpdateSpatialReference=e.spatialReference,Mt(this._tileGeometryUpdateExtent,e.tile.extent,this._tileGeometryUpdateExtent),this._set("updating",!0)}_furthestCenterOnSurface(){let e=this.centerOnSurfaces[0];for(let t=1;t<this.centerOnSurfaces.length;t++){const i=this.centerOnSurfaces[t];i.distance>e.distance&&(e=i)}return e}_centerIntersectsExtent(e,t){const i=this.state.camera.eye,r=wx,s=this._furthestCenterOnSurface();return this.renderCoordsHelper.fromRenderCoords(i,yx,t),this.renderCoordsHelper.fromRenderCoords(s.renderLocation,xx,t),yx[0]<xx[0]?(r[0]=yx[0],r[2]=xx[0]):(r[0]=xx[0],r[2]=yx[0]),yx[1]<xx[1]?(r[1]=yx[1],r[3]=xx[1]):(r[1]=xx[1],r[3]=yx[1]),Dt(r,e)}};e([le({constructOnly:!0})],vx.prototype,"state",void 0),e([le({constructOnly:!0})],vx.prototype,"centerOnSurfaces",void 0),e([le({constructOnly:!0})],vx.prototype,"renderCoordsHelper",void 0),e([le({constructOnly:!0})],vx.prototype,"scheduler",void 0),e([le({constructOnly:!0})],vx.prototype,"surface",void 0),e([le({readOnly:!0})],vx.prototype,"updating",void 0),vx=e([ce("esri.views.3d.support.SurfaceGeometryUpdates")],vx);const _x={},yx=fe(),xx=fe(),wx=Tt();let bx=class extends yi{constructor(e){super(e),this._handles=new ar,this._tmpRay=Xn(),this._centerRayDirty=!0,this._surfaceAltitudeAtCenter=0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenter=0,this._contentAltitudeAtCenterDirty=!0,this._propertiesPool=new no({renderPointOfView:Cx},this),this.renderPointOfView=fe(),this._pois=new Array,this._debugCenters=new Map}initialize(){var e;const{state:t,basemapTerrain:i,renderCoordsHelper:r,map:s}=this.view;this._surfaceIntersector=new uo(t.viewingMode),t.isGlobal?this._surfaceIntersector.options.backfacesTerrain=!1:this._surfaceIntersector.options.backfacesTerrain=!0,this._surfaceIntersector.options.invisibleTerrain=!1,this._surfaceIntersector.options.store=0,this._contentIntersector=new uo(t.viewingMode);const a=()=>this._estimateSurfaceAltitudeAtCenter(),n=this.view.resourceController.scheduler,o=z(null==(e=this.view.basemapTerrain)?void 0:e.elevationQueryCache),l={state:t,scheduler:n,surface:i,renderCoordsHelper:r};this._set("centerOnSurfaceInfrequent",new ox({...l,task:qo.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:a})),this._set("centerOnSurfaceFrequent",new ox({...l,task:qo.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:a})),this._set("contentCenterOnSurface",new ox({...l,task:qo.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:a,cameraName:"contentCamera"})),this._set("centerOnContent",new ox({...l,task:qo.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()})),this._set("cameraOnSurface",new ex({...l,cache:o,task:qo.POINT_OF_INTEREST_INFREQUENT,map:s})),this._set("contentCameraOnSurface",new ex({...l,cache:o,task:qo.POINT_OF_INTEREST_INFREQUENT,map:s,cameraName:"contentCamera"})),this._set("surfaceGeometryUpdates",new vx({...l,centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]})),this._set("contentGeometryUpdates",new lx({contentLayerViews:this.view.allLayerViews,renderCoordsHelper:r})),this._set("surfaceOrigin",new fx({cache:o,view:this.view})),this._set("focus",new gx({state:t,scheduler:n,surface:i,renderCoordsHelper:r,centerOnSurface:this.contentCenterOnSurface,estimateSurfaceIntersectionAtRenderPoint:(e,t)=>this._estimateSurfaceIntersectionAtRenderPoint(e,this.view.state.contentCamera,t)})),this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.contentCenterOnSurface,this.cameraOnSurface,this.contentCameraOnSurface,this.focus);const h=this.view.graphics;this._debugCenters.set(this.centerOnContent,new Yy(h,"red","CenterOnContent")),this._debugCenters.set(this.centerOnSurfaceFrequent,new Yy(h,"red","CenterOnSurface")),this._debugCenters.set(this.centerOnSurfaceInfrequent,new Yy(h,"red","CenterOnSurface")),this._debugCenters.set(this.contentCenterOnSurface,new Yy(h,"red","ContentCenterOnSurface")),this._debugCenters.set(this.cameraOnSurface,new Yy(h,"blue","CameraOnSurface")),this._debugCenters.set(this.contentCameraOnSurface,new Yy(h,"blue","ContentCameraOnSurface")),this._debugCenters.set(this.focus,new Yy(h,"green","Focus")),this._handles.add([t.watch("camera",(e=>this._cameraChanged(e)),!0),i.watch("extent",(()=>this._updateCenterPointsOfInterest())),$(i,"updating",(()=>this._updateCenterPointsOfInterest()),!0),this.surfaceGeometryUpdates.events.on("request-update",(()=>this._updateCenterPointsOfInterest())),this.contentGeometryUpdates.events.on("request-update",(()=>this._updateCenterOnContent())),Y(ma,"SHOW_POI",(e=>this._setDebug(e)))]),this._cameraChanged(this.view.state.camera);for(const e of this._pois)e.runTask()}destroy(){this._setDebug(!1),this._handles.destroy(),this._propertiesPool.destroy();for(const e of this._pois)e.destroy();this.surfaceOrigin.destroy()}get updating(){var e;return!!(null!=(e=this.surfaceGeometryUpdates)&&e.updating||this._pois.some((e=>e.updating)))}get centerRay(){return this._centerRayDirty&&(this._centerRay=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.camera,this._tmpRay),this._centerRayDirty=!1),this._centerRay}_estimateContentAltitudeAtCenter(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;const e=this.centerRay;return M(e)||(this.view.sceneIntersectionHelper.intersectRay(e,this._contentIntersector,Tx,Px)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(Tx):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter()),this._contentAltitudeAtCenter}_estimateSurfaceAltitudeAtCenter(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;const e=this.centerRay;if(M(e))return this._surfaceAltitudeAtCenter;const t=e.origin,i=Pe(Tx,e.origin,e.direction);return this._surfaceIntersector.resetWithRay(e),this._surfaceIntersector.camera=this.view.state.camera,this.view.basemapTerrain.intersect(this._surfaceIntersector,null,t,i),this._surfaceIntersector.results.min.getIntersectionPoint(Tx)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(Tx)),this._surfaceAltitudeAtCenter}_estimateSurfaceIntersectionAtRenderPoint(e,t,i){const r=Do(t,e,Sx);if(M(r))return null;const s=r.origin,a=Pe(Tx,r.origin,r.direction);return this._surfaceIntersector.resetWithRay(r),this._surfaceIntersector.camera=t,this.view.basemapTerrain.intersect(this._surfaceIntersector,null,s,a),this._surfaceIntersector.results.min.getIntersectionPoint(i)?i:null}_cameraChanged(e){this._updateCenterPointsOfInterest();const t=e.eye;We(this.renderPointOfView,t)||this._set("renderPointOfView",ye(this._propertiesPool.get("renderPointOfView"),t))}_updateCenterPointsOfInterest(){this._centerRayDirty=!0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenterDirty=!0;for(const e of this._pois)e.updateRenderLocation()}_updateCenterOnContent(){this._contentAltitudeAtCenterDirty=!0,this.centerOnContent.updateRenderLocation()}_setDebug(e){if(!e)return this._debugCenters.forEach((e=>e.hide())),void this._handles.remove("debug");for(const e of this._pois)this._handles.add(Y(e,"renderLocation",(t=>this._debugCenters.get(e).show(t,e.renderCoordsHelper.spatialReference))),"debug")}get test(){return{update:()=>{this.surfaceGeometryUpdates.runTask();for(const e of this._pois)e.runTask()},surfaceGeometryUpdates:this.surfaceGeometryUpdates}}};e([le({readOnly:!0})],bx.prototype,"centerOnContent",void 0),e([le({readOnly:!0})],bx.prototype,"centerOnSurfaceFrequent",void 0),e([le({readOnly:!0})],bx.prototype,"centerOnSurfaceInfrequent",void 0),e([le({readOnly:!0})],bx.prototype,"contentCenterOnSurface",void 0),e([le({readOnly:!0})],bx.prototype,"cameraOnSurface",void 0),e([le({readOnly:!0})],bx.prototype,"contentCameraOnSurface",void 0),e([le({readOnly:!0})],bx.prototype,"focus",void 0),e([le({readOnly:!0})],bx.prototype,"renderPointOfView",void 0),e([le({readOnly:!0})],bx.prototype,"surfaceOrigin",void 0),e([le({readOnly:!0})],bx.prototype,"contentGeometryUpdates",void 0),e([le({readOnly:!0})],bx.prototype,"surfaceGeometryUpdates",void 0),e([le({constructOnly:!0})],bx.prototype,"view",void 0),e([le({readOnly:!0})],bx.prototype,"updating",null),bx=e([ce("esri.views.3d.support.PointsOfInterest")],bx);const Cx=Array,Tx=fe(),Sx=Xn(),Px={exclude:new Set([uh])};var Rx=bx;const Mx={value:.5,readOnly:!0},Dx={readOnly:!0,value:.5,get(){return this.updating?this.updatingProgressValue:1}},Ax=t=>{let i=class extends t{get imageFormatIsOpaque(){return!1}get isOpaque(){return this.fullOpacity>=1&&this.imageFormatIsOpaque}get dataLevelRange(){const e=this.tileInfo.lods,t=e[0].scale,i=e[e.length-1].scale;return this.levelRangeFromScaleRange(t,i)}get displayLevelRange(){const e=this.tileInfo.lods,t=this.layer.minScale||e[0].scale,i=this.layer.maxScale||e[e.length-1].scale,r=this.levelRangeFromScaleRange(t,i);return this.layer.maxScale&&r.maxLevel++,r}getTileUrl(e,t,i){return this.layer.getTileUrl(e,t,i)}_addTilingSchemeMatchPromise(){const e=this._getTileInfoSupportError(this.tileInfo,this.layer.fullExtent);if(e)this.addResolvingPromise(Promise.reject(e));else{const e=ee(this.view,"basemapTerrain.tilingSchemeLocked").then((()=>{const e=this.view.basemapTerrain.tilingScheme,t=this._getTileInfoCompatibilityError(this.tileInfo,e);if(t)throw t}));this.addResolvingPromise(e)}}_getTileInfoSupportError(e,t){const i=kl(e,t,this.view.spatialReference,this.view.state.viewingMode);if(i){const e={layer:this.layer,error:i};let t;switch(i.name){case"tilingscheme:spatial-reference-mismatch":case"tilingscheme:global-unsupported-spatial-reference":case"tilingscheme:local-unsupported-spatial-reference":t=new o("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",e);break;default:t=new o("layerview:tiling-scheme-unsupported","The tiling scheme of this layer is not supported by SceneView",e)}return t}return null}_getTileInfoCompatibilityError(e,t){return t.compatibleWith(e)?null:new o("layerview:tiling-scheme-incompatible","The tiling scheme of this layer is incompatible with the tiling scheme of the surface")}levelRangeFromScaleRange(e,t){const i={minLevel:0,maxLevel:1/0},r=this.view&&this.view.basemapTerrain&&this.view.basemapTerrain.tilingScheme;if(!r)return i;const s=r.levels[0],a=e=>{const t=Math.log(s.scale/e)/Math.LN2;return.5-Math.abs(.5-t%1)<1e-9?Math.round(t):Math.ceil(t)};return null!=e&&e>0&&(i.minLevel=Math.max(0,a(e))),null!=t&&t>0&&(i.maxLevel=Math.max(0,a(t))),i}isUpdating(){return!!(this.view&&this.view.basemapTerrain&&this.view.basemapTerrain.updating)}};return e([le({readOnly:!0})],i.prototype,"imageFormatIsOpaque",null),e([le({readOnly:!0})],i.prototype,"updating",void 0),e([le(Dx)],i.prototype,"updatingProgress",void 0),e([le(Mx)],i.prototype,"updatingProgressValue",void 0),e([le({readOnly:!0})],i.prototype,"fullExtent",void 0),e([le({readOnly:!0})],i.prototype,"isOpaque",null),e([le({readOnly:!0})],i.prototype,"dataLevelRange",null),e([le({readOnly:!0})],i.prototype,"displayLevelRange",null),e([le()],i.prototype,"layer",void 0),e([le({readOnly:!0})],i.prototype,"tileInfo",void 0),i=e([ce("esri.views.3d.layers.TiledLayerView3D")],i),i};let Ox=class extends(Ax(wh(bh))){constructor(){super(...arguments),this.type="elevation-3d"}initialize(){const e=this.get("view.map.allLayers"),t=e&&e.includes(this.layer),i=this.get("view.map.ground.layers"),r=i&&i.includes(this.layer);if(t&&!r){const e=new o("layerview:elevation-layer-only","3D elevation layer '"+this.layer.id+"' can only be added in the map ground");this.addResolvingPromise(Promise.reject(e))}this._addTilingSchemeMatchPromise()}};e([le({readOnly:!0,aliasOf:"layer.fullExtent"})],Ox.prototype,"fullExtent",void 0),e([le()],Ox.prototype,"layer",void 0),e([le({readOnly:!0,aliasOf:"layer.tileInfo"})],Ox.prototype,"tileInfo",void 0),Ox=e([ce("esri.views.3d.layers.ElevationLayerView3D")],Ox);var Fx=Ox,Ix=Object.freeze({__proto__:null,default:Fx});class zx{constructor(e=0,t=0){this.min=e,this.max=t,this.level=0,this.hasNoDataValues=!1}copyFrom(e){this.min=e.min,this.max=e.max,this.level=e.level,this.hasNoDataValues=e.hasNoDataValues}}class Ex{constructor(e,t,i){this.type="elevation",this.samplerData=null,this.level=e[0],this.i=e[1],this.j=e[2],this.extent=t;const r=i.noDataValue,s=i.values;let a=1/0,n=-1/0,o=!0,l=!1;for(let e=0;e<s.length;e++){const t=s[e];t!==r?(a=t<a?t:a,n=t>n?t:n,o=!1):l=!0}o&&(a=0,n=0),n=n>-3e38?n:0,this.samplerData={pixelData:i.values,width:i.width,height:i.height,noDataValue:r,safeWidth:.99999999*(i.width-1),dx:(i.width-1)/(t[2]-t[0]),dy:(i.width-1)/(t[3]-t[1]),x0:t[0],y1:t[3]},this.bounds=[a,n],this.hasNoDataValues=l}release(){this.samplerData=null,this.bounds=null}computeMinMaxValue(e,t,i,r){r.min=1/0,r.max=-1/0,r.hasNoDataValues=!1;const s=e-this.level;if(s<=0)return r;const a=2**s;if(!(Math.floor(t/a)===this.i&&Math.floor(i/a)===this.j))return r;let n=1/0,o=-1/0;const l=this.samplerData.width,h=this.samplerData.pixelData,c=.5*Ch;let d=(l-1)/a,u=(i-this.j*a)*d,p=(t-this.i*a)*d;if(d<1){const e=Math.floor(u),t=Math.floor(p),i=e+t*l,s=h[i],a=h[i+1],n=h[i+l],o=h[i+l+1];if(s+a+n+o<c){const i=u-e,l=p-t,h=Ii(s,a,n,o,i,l),c=Ii(s,a,n,o,i+d,l),m=Ii(s,a,n,o,i,l+d),g=Ii(s,a,n,o,i+d,l+d);return r.min=Math.min(h,c,m,g),r.max=Math.max(h,c,m,g),r}u=e,p=t,d=1}else u=Math.floor(u),p=Math.floor(p),d=Math.ceil(d);for(let e=u;e<=u+d;e++)for(let t=p;t<=p+d;t++){const i=h[e+t*l];i<c?(n=Math.min(n,i),o=Math.max(o,i)):r.hasNoDataValues=!0}return r.min=n,r.max=o,r}static sample(e,t,i){for(const r of i){if(!r)continue;const i=r.safeWidth,s=r.width,a=r.pixelData;let n=ue(r.dy*(r.y1-t),0,i),o=ue(r.dx*(e-r.x0),0,i);const l=Math.floor(n),h=Math.floor(o),c=l*s+h,d=c+s,u=a[c],p=a[d],m=a[c+1],g=a[d+1];if(u+p+m+g<.5*Ch){n-=l,o-=h;const e=u+(m-u)*o;return e+(p+(g-p)*o-e)*n}}return null}}let Lx=class extends yi{constructor(e){super(e),this._handles=new ar}initialize(){this._handles.add([this.layerViews.on("change",(()=>this.notifyChange("stencilEnabledExtents")))])}destroy(){this._handles.destroy(),this._handles=null}get layerViewsExtent(){return this._computeLayerViewsExtent()}get tiledLayersExtent(){return this._computeTiledLayersExtent()}get stencilEnabledExtents(){return this._computeStencilEnabledExtents()}_computeStencilEnabledExtents(){const e=[];return this.layerViews.forEach((t=>{const i=t.layer;if("IntegratedMeshLayer"===i.operationalLayerType&&null!=this.viewSpatialReference){const t=jx(i.fullExtent,this.viewSpatialReference);C(t)&&e.push(Et(t))}})),e}};e([le({readOnly:!0})],Lx.prototype,"layerViewsExtent",null),e([le({readOnly:!0})],Lx.prototype,"tiledLayersExtent",null),e([le({readOnly:!0})],Lx.prototype,"stencilEnabledExtents",null),e([le()],Lx.prototype,"viewSpatialReference",void 0),e([le()],Lx.prototype,"tilingScheme",void 0),e([le()],Lx.prototype,"defaultTiledLayersExtent",void 0),e([le({constructOnly:!0})],Lx.prototype,"layers",void 0),e([le({constructOnly:!0})],Lx.prototype,"layerViews",void 0),Lx=e([ce("esri.views.3d.terrain.ExtentHelper")],Lx);let Vx=class extends Lx{_computeLayerViewsExtent(){return this._globalExtent}_computeTiledLayersExtent(){return this._globalExtent}get _globalExtent(){return this.viewSpatialReference.isWebMercator?Th:Sh}};Vx=e([ce("esri.views.3d.terrain.ExtentHelperGlobal")],Vx);let kx=class extends Lx{_computeLayerViewsExtent(){const e=Tt(),t=this.viewSpatialReference;this.layerViews.forEach((i=>{const r=i.layer;if(i.isResolved()&&("graphics"!==r.type||!r.internal)){const r=jx("fullExtentInLocalViewSpatialReference"in i&&i.fullExtentInLocalViewSpatialReference||i.layer.fullExtent,t);Mt(e,r,e)}}));const i=Lt(e)?e:null,r=this._get("layerViewsExtent");return Vt(i,r)?r:i}_computeTiledLayersExtent(){const e=this.tilingScheme;if(!e)return null;const t=this.viewSpatialReference,i=Tt();this.layers.forEach((r=>{if(r.loaded&&Jt(r)){const{tileInfo:s,fullExtent:a}=jl(r,t,2);(s&&Ul(r)&&a||s&&e.compatibleWith(s)&&a&&a.spatialReference.equals(e.spatialReference))&&Mt(i,a,i)}})),Mt(i,this.defaultTiledLayersExtent,i);const r=Lt(i)?i:null,s=this._get("tiledLayersExtent");return Vt(r,s)?s:r}};function jx(e,t){return e&&!e.spatialReference.equals(t)?vt(e,e.spatialReference,t):e}kx=e([ce("esri.views.3d.terrain.ExtentHelperLocal")],kx);const Ux=q(40),qx=q(50);function Hx(){var e;const t=null==(e=E.require)?void 0:e.modules;if(t){const e=Object.keys(t);for(const i of e)-1!==i.search(".glsl")&&delete t[i]}}const Bx=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]];let Nx,Gx=class extends yi{constructor(e){super(e),this._handles=new ar,this._spatialReference=null,this._renderSR=null,this._overlaySREqualsRenderSR=!0,this._drapeSources=new Map,this._drapeTargets=new Set,this._placementDirty=!1,this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this._layerViewsDirty=!0,this._hasUnusedRenderTargets=!1,this._longitudeCyclical=null,this._latestOriginId=0,this._maxResolution=O("esri-mobile")?2048:4096,this._animationTimeLast=0}get running(){return(this._placementDirty||this._layerViewsDirty)&&(this._drapeSources.size>0||this.view.graphics.length>0||ma.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&this.surface.ready}get _isSpherical(){return this.view.state.isGlobal}get _worldToPCSRatio(){return C(this._spatialReference)&&this._spatialReference.isGeographic?wt(this._spatialReference).metersPerDegree:1}get view(){return this.surface.view}get updating(){return this.running||this.renderer.updating}get hasHighlights(){return this.renderer.hasHighlights}get rendersOccluded(){return this.renderer.rendersOccluded}initialize(){const e=this.view;this.renderer=new ga({view:e,worldToPCSRatio:this._worldToPCSRatio,spatialReference:this._spatialReference}),this._groundIntersector=new uo(this.view.state.viewingMode),this._groundIntersector.options.backfacesTerrain=!0,this._groundIntersector.options.invisibleTerrain=!0,this._groundIntersector.options.hud=!1,this._handles.add([this.renderer.events.on("has-highlights",(()=>{this._setDrawTexturesDirty(),this.notifyChange("hasHighlights")})),this.renderer.events.on("has-water",(t=>{var i;return null==(i=e._stage)?void 0:i.renderView.setRenderParameters({hasOverlayWater:t})})),this.renderer.events.on("renders-occluded",(()=>{this._setDrawTexturesDirty(),this.notifyChange("rendersOccluded")})),this.renderer.events.on("content-changed",(()=>this._setDrawTexturesDirty())),this.renderer.events.on("textures-disposed",(()=>this.updateDrapeTargets())),e.watch(["pointsOfInterest.renderPointOfView","pointsOfInterest.centerOnSurfaceFrequent.location","pixelRatio"],(()=>this.setPlacementDirty())),this.surface.on("elevation-change",(()=>this.setPlacementDirty())),e.allLayerViews.on("after-changes",(()=>this._layerViewsDirty=!0)),e.on("resize",(()=>this.setPlacementDirty())),G({preRender:e=>{this.renderer.processSyncLayers(),this._updateLayerViews(),this.renderer.hasOverlays&&(this._dispatchRendererUpdate(e),this._drawOverlayTextures(this.renderer.overlays)),this._hasUnusedRenderTargets&&this._collectUnusedRenderTargetMemory()}}),e.resourceController.scheduler.registerTask(qo.OVERLAY,this),e._stage.renderView.events.on("force-camera-for-screenshot",(e=>{this._updateOverlays(e),this.renderer.hasOverlays&&this._drawOverlayTextures(this.renderer.overlays)}))]),this._updateLayerViews()}destroy(){this._drapeSources.forEach(((e,t)=>this.unregisterDrapeSource(t))),this._drapeTargets.forEach((e=>this._unregisterDrapeTarget(e))),this.renderer.dispose(),this._handles&&(this._handles.destroy(),this._handles=null),C(Nx)&&(Nx.hide(),Nx=null)}get hasOverlays(){return this.renderer.hasOverlays}setSpatialReference(e){this._spatialReference=e,this.renderer.spatialReference=e,this._longitudeCyclical=null;const t=this.view.renderSpatialReference;C(e)&&C(t)?(this._renderSR=t,this._overlaySREqualsRenderSR=e.equals(this._renderSR),this._isSpherical&&(this._longitudeCyclical=e.isWebMercator?new zi(-20037508.342787,20037508.342787):new zi(-180,180),this.renderer.longitudeCyclical=this._longitudeCyclical),this.renderer&&(this.renderer.worldToPCSRatio=this._worldToPCSRatio)):this.renderer.disposeOverlays()}getGpuMemoryUsage(){return this.renderer.gpuMemoryUsage}_updateLayerViews(){if(!this._layerViewsDirty)return;const e=new Set;for(const t of this.view.allLayerViews.items)e.add(t.uid),"drapeSourceType"in t&&!this._drapeSources.has(t)&&this._registerDrapeSource(t,0),"drapeTargetType"in t&&!this._drapeTargets.has(t)&&this._registerDrapeTarget(t);this._drapeSources.forEach(((t,i)=>{0!==t||e.has(i.uid)||this.unregisterDrapeSource(i)})),this._drapeTargets.forEach((t=>{e.has(t.uid)||this._unregisterDrapeTarget(t)})),this.renderer.updateLayerOrder(),this._setDrawTexturesDirty(),this._layerViewsDirty=!1}registerDrapeSource(e){this._registerDrapeSource(e,1)}_registerDrapeSource(e,t){this._drapeSources.set(e,t),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources),this._updateDrapeSource(e),this._setContentDirty(),this.notifyChange("running")}_updateDrapeSource(e){2===this.renderer.overlays.length&&C(e.setDrapingExtent)&&C(this._spatialReference)&&e.setDrapingExtent(this.renderer.overlays,this._spatialReference)}unregisterDrapeSource(e){this._drapeSources.has(e)&&(this._drapeSources.delete(e),this.renderer.ensureDrapeSources(this._drapeSources),this._setContentDirty(),this.notifyChange("running"))}_registerDrapeTarget(e){this._drapeTargets.add(e),this._updateDrapeTarget(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources)}updateDrapeTargets(){this._drapeTargets.forEach((e=>this._updateDrapeTarget(e)))}_updateDrapeTarget(e){e.setDrapingTextures(this.renderer.overlays)}_unregisterDrapeTarget(e){this._drapeTargets.delete(e),this.renderer.ensureDrapeTargets(this._drapeTargets)}_setContentDirty(){this.setPlacementDirty(),this._setDrawTexturesDirty()}setPlacementDirty(){this._placementDirty=!0}runTask(){this._updateOverlays(this.view.state.camera)}_updateOverlays(e){if(!this._spatialReference)return;this._updateLayerViews();const t=fa(e.fullWidth,e.fullHeight,this._maxResolution);this._computeOverlayExtents(e,t,Zx);const i=Pt(Zx.inner)/Pt(Zx.outer);this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);const r=this._updateOverlay(0,Zx.inner,t,1),s=this._updateOverlay(1,Zx.outer,t,i);(r||s)&&(this._drapeSources.forEach(((e,t)=>this._updateDrapeSource(t))),this.surface.updateTileOverlayParams(),this._setDrawTexturesDirty()),this._placementDirty=!1}_updateOverlay(e,t,i,r){if(0===this.renderer.overlays.length)return!1;const s=this.renderer.overlays[e];if(!function(e,t){const i=1e-5,r=ma.TESTS_DISABLE_UPDATE_THRESHOLDS?0:i*Math.max(e[2]-e[0],e[3]-e[1],t[2]-t[0],t[3]-t[1]);for(let i=0;i<4;i++)if(Math.abs(t[i]-e[i])>r)return!0;return!1}(t,s.extent)&&i===s.resolution&&s.pixelRatio===r)return!1;At(s.extent,t),s.resolution=i,s.pixelRatio=r;const a=zt(s.extent);return s.renderLocalOrigin=va(a[0],a[1],0,"OV_"+this._latestOriginId++),!0}setTileParameters(e){const t=e.renderData.overlay;if(this.renderer.overlays.length>0){const i=this.renderer.overlays[0],r=this.renderer.overlays[1],s=kt(e.extent,this.surface.extent,Yx);this._rectInsideRect(i.extent,s)||this._rectanglesOverlap(s,i.extent)||this._rectanglesOverlap(s,r.extent)?(this._setTileOverlayData(s,0,t),this._setTileOverlayData(s,1,t)):(this._clearTileOverlayData(0,t),this._clearTileOverlayData(1,t))}else this._clearTileOverlayData(0,t),this._clearTileOverlayData(1,t)}overlayPixelSizeInMapUnits(e){if(0===this.renderer.overlays.length)return 0;const t=this.renderer.overlays[0],i=this.renderer.overlays[1],r=this._pointIsInExtent(e,t.extent)?t:i;return(r.extent[2]-r.extent[0])/r.resolution}_setTileOverlayData(e,t,i){if(0===this.renderer.overlays.length)return;const r=this.renderer.overlays[t].extent,s=Pt(r),a=Rt(r);let n=e[0];if(this._longitudeCyclical){n=this._longitudeCyclical.minimalMonotonic(r[0],n);const t=this._longitudeCyclical.minimalMonotonic(r[0],e[2]);n>t&&(n=t-(e[2]-e[0]))}i.setScale(t,Pt(e)/s,Rt(e)/a),i.setOffset(t,(n-r[0])/s,(e[1]-r[1])/a)}_clearTileOverlayData(e,t){t.setScale(e,-1,-1),t.setOffset(e,-1,-1)}async reloadShaders(){Hx(),await this.renderer.reloadShaders(),this.runTask()}_dispatchRendererUpdate(e){const t=q(e.time-this._animationTimeLast);t<qx&&M(this.forcedAnimationTime)||(this._animationTimeLast=e.time,this.renderer.updateLogic({dt:t,forcedTime:this.forcedAnimationTime,camera:this.view.state.camera})&&(this._drawTexturesAnimateDirty=!0))}_setDrawTexturesDirty(){this.renderer.hasOverlays?this._drawTexturesDirty=!0:this.setPlacementDirty()}_intersectGroundFromView(e,t,i,r){const s=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,Kx,t,i);if(M(s))return!1;const a=s.origin,n=Pe(Qx,s.origin,s.direction);return this._groundIntersector.reset(a,n),this._groundIntersector.intersect([],null,e),this.view.basemapTerrain.intersect(this._groundIntersector,null,a,n),this._groundIntersector.results.min.getIntersectionPoint(r)}_findHorizonBasedPointOfInterest(e,t){let i=.5;const r=.55,s=this.view.renderCoordsHelper.getAltitude(e.eye),a=this.view.pointsOfInterest.centerOnSurfaceFrequent,n=1e-5,o=ue(a.estimatedSurfaceAltitude,e.aboveGround?-1/0:s+n,e.aboveGround?s-n:1/0),l=e.aboveGround;if("global"===this.view.viewingMode){const t=Qx;Ya(Xa(wt(this.view.spatialReference).radius+o),Yn(e.eye,e.viewForward),t),Te(t,t,e.eye);const s=Fi.normalize(rn(e.viewForward,t,e.viewRight))/e.fovY+.5,a=s<=0||s>=1?.5:r;i=l?a*s:s+a*(1-s)}else{const t=.5*Math.PI-Math.acos(-e.viewForward[2]),s=Math.tan(t),a=or(0,s,1,0),n=He(a,a,e.projectionMatrix)[1],o=ue(.5+.5*n,0,1);i=1===o||0===o?.5:l?o*r:1-(1-o)*r}return!!this._intersectGroundFromView(e,.5,i,t)&&Qe(t,e.eye)<a.distance*a.distance}_computeOverlayExtents(e,t,i){const r=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,s=fe();this._findHorizonBasedPointOfInterest(e,s)||ye(s,r);const a=De(e.eye,s),n=dp(this.view.renderCoordsHelper,r,e.eye),o=Math.PI/2-Math.abs(n-Math.PI/2);ma.OVERLAY_SHOW_CENTER?(M(Nx)&&(Nx=new Yy(this.view.graphics,"red")),Nx.show(s,this._renderSR)):C(Nx)&&Nx.hide(),this._overlaySREqualsRenderSR||pt(s,this._renderSR,s,this._spatialReference);const l=this.surface.extent;let h=t*e.perRenderPixelRatio*a/2,c=!1,d=1/0;this._isSpherical&&C(l)&&C(this._spatialReference)&&(this._spatialReference.isWebMercator?(h/=Math.cos(Sl(s[1])),d=l[3]):(c=!0,h/=wt(this._spatialReference).metersPerDegree,d=90),h>=d&&(h=d,s[1]=0,this._spatialReference.isWebMercator&&(s[0]=0))),!this._isSpherical&&C(this._spatialReference)&&this._spatialReference.isGeographic&&(h/=wt(this._spatialReference).metersPerDegree,d=90);let u=1;c&&(u=1/Math.max(.2,Math.cos(Math.abs(pe(s[1])))),h*u>180&&(u=180/h));const p=Math.log(2)/12;h=Math.exp(Math.round(Math.log(h)/p)*p);const m=h*u,g=.5*t/(32*m),f=.5*t/(32*h);s[0]=Math.round(s[0]*g)/g,s[1]=Math.round(s[1]*f)/f;const v=i.inner;v[0]=s[0]-m,v[1]=s[1]-h,v[2]=s[0]+m,v[3]=s[1]+h,this._isSpherical&&this._shiftExtentToFitBounds(v,1/0,d);const _=i.outer;if(6*m>Pt(l))At(_,z(l));else if(o<=.25*Math.PI)_[0]=v[0]-m,_[1]=v[1]-h,_[2]=v[2]+m,_[3]=v[3]+h;else{pt(e.eye,this._renderSR,Qx,this._spatialReference),Lr(Wx,s,Qx);let t=-Math.atan2(Wx[1],Wx[0])+.125*Math.PI;t<0&&(t+=2*Math.PI);const i=Math.floor(t/(.25*Math.PI));Be(Wx,Bx[i],2*h),Wx[0]*=u,Wx[2]*=u,Ze(_,v,Wx)}if(this._isSpherical)_[0]=this._longitudeCyclical.clamp(_[0]),_[2]=this._longitudeCyclical.clamp(_[2]),_[1]=Math.max(_[1],-d),_[3]=Math.min(_[3],d);else{const e=kt(v,l,Yx),t=kt(_,l,Xx);jt(e,t)&&(_[2]=_[0],_[3]=_[1])}}_drawOverlayTextures(e){if(0===e.length||!this._drawTexturesDirty&&!this._drawTexturesAnimateDirty)return;const t=this._drawOverlay(e[0]),i=this._drawOverlay(e[1]);0!==t&&0!==i||this.surface.updateTileOverlayParams(),this._collectUnusedRenderTargetMemory(),this.updateDrapeTargets(),this._drawTexturesAnimateDirty=!1,this._drawTexturesDirty?(this._drawTexturesDirty=!1,this.surface.requestRender(),this.surface.requestUpdate()):this.surface.requestRender(0)}_drawOverlay(e){return this._longitudeCyclical?e.setupGeometryViewsCyclical(this._longitudeCyclical):e.setupGeometryViewsDirect(),e.draw(this.renderer,this.view.state.camera.pixelRatio)}_collectUnusedRenderTargetMemory(){if(this._hasUnusedRenderTargets=!1,this.renderer.hasOverlays){const e=performance.now();this._hasUnusedRenderTargets=this.renderer.collectUnusedRenderTargetMemory(e)}}_rectanglesOverlap(e,t){return!M(e)&&(this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):Dt(e,t))}_rectInsideRect(e,t){return!M(t)&&(this._longitudeCyclical?this._longitudeCyclical.contains(e[0],e[2],t[0])&&this._longitudeCyclical.contains(e[0],e[2],t[2])&&t[1]>e[1]&&t[3]<e[3]:jt(e,t))}_pointIsInExtent(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];const i=e.x,r=e.y;return i>t[0]&&i<t[2]&&r>t[1]&&r<t[3]}_shiftExtentToFitBounds(e,t,i){let r=0,s=0;e[0]<-t?r=e[0]+t:e[2]>t&&(r=t-e[2]),e[1]<-i?s=e[1]+i:e[3]>i&&(s=i-e[3]),St(e,r,s)}get test(){return{renderer:this.renderer,update:()=>this.runTask()}}};e([le()],Gx.prototype,"_spatialReference",void 0),e([le({readOnly:!0})],Gx.prototype,"running",null),e([le()],Gx.prototype,"_placementDirty",void 0),e([le()],Gx.prototype,"_layerViewsDirty",void 0),e([le()],Gx.prototype,"_isSpherical",null),e([le()],Gx.prototype,"_worldToPCSRatio",null),e([le()],Gx.prototype,"renderer",void 0),e([le({constructOnly:!0})],Gx.prototype,"surface",void 0),e([le({readOnly:!0,aliasOf:"surface.suspended"})],Gx.prototype,"suspended",void 0),e([le({readOnly:!0})],Gx.prototype,"updating",null),e([le({type:Boolean})],Gx.prototype,"hasHighlights",null),e([le({type:Boolean})],Gx.prototype,"rendersOccluded",null),Gx=e([ce("esri.views.3d.terrain.OverlayManager")],Gx);const Wx=nr(),Qx=fe(),Zx={inner:Ct(),outer:Ct()},Yx=Ct(),Xx=Ct(),Kx=Xn();class Jx{constructor(e,t){this._factoryCallback=e,this._lengthCallback=t,this._pool=new Map}acquire(e){if(!Jx.test.disabled){const t=this._pool.get(e);if(t&&0!==t.length)return t.pop()}try{return this._factoryCallback(e)}catch(t){const i=window.performance&&window.performance.memory;let r="";throw i&&(r=`\n  totalJSHeapSize: ${i.totalJSHeapSize}, usedJSHeapSize: ${i.usedJSHeapSize}, jsHeapSizeLimit: ${i.jsHeapSizeLimit}`),console.log("Array allocation of size "+e+" failed: "+t+r),t}}release(e){if(Jx.test.disabled)return;const t=this._lengthCallback(e);let i=this._pool.get(t);i||(i=new N({shrink:!0}),this._pool.set(t,i)),i.push(e)}clear(){this._pool.clear()}get test(){return{size:this._pool.size}}}Jx.test={disabled:!1};const $x=Dn().vec3f("position").vec2f("uv0"),ew=new Jx((e=>$x.createBuffer(e)),(e=>e.count));class tw{constructor(){this.indices=null,this.vertexAttributes=null,this.boundingBox=il(),this.numSurfaceIndices=0,this.numSkirtIndices=0,this.numWithoutSkirtIndices=0,this.numVertsPerRow=0,this.skirtLength=0,this.uvOffsetAndScale=nr()}}class iw{constructor(e,t,i){this.values=e,this.numSurfaceIndices=t,this.numSkirtIndices=i}}const rw=new Map;function sw(e,t,i,r){const s=(2&i)>0,a=t+(r?1024:0)+(s?2048:0);let n=rw.get(a);n||(n=function(e,t,i){const r=e-1,s=e-1,a=e*e,n=2*r+2*s;let o=r*s*2*3,l=6*n,h=6*(2*r+s-1);i&&(o*=2,l*=2,h*=2);const c=a+n>65536?new Uint32Array(o+l):new Uint16Array(o+l);let d,u,p,m,g=0,f=0,v=o,_=0;for(let e=0;e<=s;e++){t&&(_=0===e?h:e===s?-h:0),v+=_;for(let t=0;t<=r;t++){const n=ow(t,e,r,s);if(n>-1){const o=lw(t,e,r,s);0!==o&&(d=g,u=a+n,p=a+(0===t&&1===e?0:n+1),m=g+o,i?(c[v+0]=d,c[v+1]=u,c[v+2]=u,c[v+3]=p,c[v+4]=p,c[v+5]=d,c[v+6]=p,c[v+7]=m,c[v+8]=m,c[v+9]=d,c[v+10]=d,c[v+11]=p,v+=12):(c[v+0]=d,c[v+1]=u,c[v+2]=p,c[v+3]=p,c[v+4]=m,c[v+5]=d,v+=6))}++g,t<r&&e<s&&(d=e*(r+1)+t,u=d+1,p=u+(r+1),m=p-1,i?(c[f+0]=d,c[f+1]=u,c[f+2]=u,c[f+3]=p,c[f+4]=p,c[f+5]=d,c[f+6]=p,c[f+7]=m,c[f+8]=m,c[f+9]=d,c[f+10]=d,c[f+11]=p,f+=12):(c[f+0]=d,c[f+1]=u,c[f+2]=p,c[f+3]=p,c[f+4]=m,c[f+5]=d,f+=6))}v-=_}return new iw(c,o,l)}(t,s,r),rw.set(a,n)),e.indices=n.values,e.numSurfaceIndices=n.numSurfaceIndices,e.numSkirtIndices=n.numSkirtIndices,e.numWithoutSkirtIndices=e.numSurfaceIndices+(i?6*(t-1)*(r?2:1):0)}function aw(e,t,i,r){e<r[0]&&(r[0]=e),e>r[3]&&(r[3]=e),t<r[1]&&(r[1]=t),t>r[4]&&(r[4]=t),i<r[2]&&(r[2]=i),i>r[5]&&(r[5]=i)}function nw(e,t){const i=t>e?1:0;return 2+4*i+(1-2*i)*(e+t)}function ow(e,t,i,r){return 0===t?e:e===i?i+t:t===r?i+r+(i-e):0===e&&t>0?2*i+r+(r-t):-1}function lw(e,t,i,r){return 0===t&&e!==i?1:e===i&&t!==r?i+1:t===r&&0!==e?-1:0===e&&0!==t?-(i+1):0}const hw=new Array(Ph+1),cw=new Array(Ph+1),dw=new Array(Ph+1),uw=new Array(Ph+1),pw=fe();class mw{get updating(){return!!this._tileRequested}init(e,t,i,r){this.tile=e,this._layerIdx=t,this._layerClass=i,this._suspended=r,this._tileLayerInfo=e.getLayerInfo(t,i),this._tileRequested=null;const s=this._findAncestorWithData();this._setUpsampleTile(s)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}setSuspension(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){const e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()}dataArrived(e){this._setUpsampleTile(e),this._tileRequested=null,e===this.tile?this.tile.updateRenderData(this._layerClass,0):this._requestNext()}dataMissing(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}_requestNext(){if(this._suspended)return!0;const e=this._findNextDownload();if(this._tileRequested){if(e===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return C(e)?e.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=e):this._agentDone(),!!this._tileRequested}_findNextDownload(){const e=this._layerIdx,t=this._layerClass,i=this.tile.surface.layerViewByIndex(e,t),r=ql(i),{minLevel:s,maxLevel:a}=i.dataLevelRange,n=this._desiredMinLevelDelta,o=this._progressiveLevelModulo+n,l=this._scaleRangeEnabled?Vh:()=>!0;let h=this.tile;const c=h.level;let d;const u=this._tileLayerInfo.upsampleInfo,p=u?u.tile.level:-1,m=L(r,"tilemapCache");for(;h&&l(h,r,!1)&&h.level>=s;){const i=h.level,r=c-i,l=h.layerInfo[t][e];if(l.data&&r>=n){i>p&&this._setUpsampleTile(h),l.dataInvalidated&&(d=h);break}if((M(m)||"unavailable"!==m.getAvailability(h.lij[0],h.lij[1],h.lij[2]))&&i<=a&&!l.data&&!l.dataMissing&&((M(d)||h.level===s||i%Mh==0||c-d.level<n)&&(d=h),r>=o))break;h=h.parent}return C(d)&&c-d.level<n&&this._tileLayerInfo.upsampleInfo&&(d=null),d}_findAncestorWithData(){const e=this.tile.vlevel,t=this._desiredMinLevelDelta;let i;for(let r=this.tile;r;r=r.parent)if(r.hasLayerData(this._layerIdx,this._layerClass)){if(e-r.level>=t)return r;i=r}return i}_setUpsampleTile(e){this._tileLayerInfo.setUpsampleInfo(this.tile,e),this.tile.updateRenderData(this._layerClass,0)}get test(){return{findNextDownload:()=>this._findNextDownload(),tileLayerInfo:this._tileLayerInfo}}}const gw=new Error("Abstract method called on TileAgent"),fw=new class extends mw{get _desiredMinLevelDelta(){throw gw}get _progressiveLevelModulo(){throw gw}dispose(){}};class vw extends mw{constructor(){super(...arguments),this._scaleRangeEnabled=!1}get _desiredMinLevelDelta(){return Dh-(this.tile.vlevel-this.tile.level)}get _progressiveLevelModulo(){return 0}}class _w extends mw{constructor(){super(),this._scaleRangeEnabled=!0}get _desiredMinLevelDelta(){return 0}get _progressiveLevelModulo(){return Mh}}const yw={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};class xw{constructor(e,t,i=null,r=null){this.type="raster-tile",this._memoryUsed=null,this._source=null,this._symbolizerParameters=null,this._bandIds=null,this._interpolation=null,this._dirty=!1,this._transformGrid=null,this.isRendereredSource=!1,this.symbolizerRenderer=null,this.rawPixelData=null,this.lij=null,this.scale=1,this.offset=[0,0],this.opacity=1,this.lij=e,this.source=t,this.width=i||t.width,this.height=r||t.height}get source(){return this._source}set source(e){this._source=e,this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null,this._memoryUsed=null)}get symbolizerParameters(){return this.isRendereredSource?{...yw,maxCutOff:[1,1,1],factor:[1,1,1]}:this._symbolizerParameters||yw}set symbolizerParameters(e){this._symbolizerParameters=e}get bandIds(){return this._bandIds}set bandIds(e){if(C(e)&&e.length>0){this._bandIds&&e.every(((e,t)=>!!this._bandIds[t]&&e===this._bandIds[t]))||(this._bandIds=e,this._dirty=!0)}else this._bandIds=null}get interpolation(){return this._interpolation||"nearest"}set interpolation(e){if(this._interpolation=e,this._rasterTexture){const t=this._getRasterTextureInterpolation(e);this._rasterTexture.setSamplingMode("bilinear"===t?9729:9728)}}get transformGrid(){return this._transformGrid}set transformGrid(e){this._transformGrid=e,this._transformGridTexture&&(this._transformGridTexture.dispose(),this._transformGridTexture=null,this._memoryUsed=null)}bind(e){return!!(this.source&&this.source.pixels&&this.source.pixels.length>0)&&(this._rasterTexture&&!this._dirty||this._updateRasterTexture(e,this.bandIds),this._rasterTexture&&(this._updateColormapTexture(e),this.transformGrid&&!this._transformGridTexture&&(this._transformGridTexture=Wh(e,this.transformGrid))),!0)}getUniforms(){const e=Qh(this.scale,this.offset),{symbolizerParameters:t,transformGrid:i,width:r,height:s,opacity:a}=this;return{basic:e,common:Zh(i,[r,s],[this.source.width,this.source.height],a),colormap:t.colormap?Yh(t.colormap,t.colormapOffset):null,stretch:"stretch"===this.symbolizerParameters.type?Xh(this.symbolizerParameters):null,hillshade:"hillshade"===this.symbolizerParameters.type?Kh(this.symbolizerParameters):null}}getTextures(){const e=new Array,t=[];return this._rasterTexture&&(t.push(this._rasterTexture),e.push("u_image"),this._transformGridTexture&&(t.push(this._transformGridTexture),e.push("u_transformGrid")),this._colormapTexture&&(t.push(this._colormapTexture),e.push("u_colormap"))),{names:e,textures:t}}get memoryUsage(){if(M(this._memoryUsed)){const e=this.getTextures();if(null==e)return 0;this._memoryUsed=e.textures.map((e=>e.descriptor.width*e.descriptor.height*4)).reduce(((e,t)=>e+t),0)}return this._memoryUsed}release(){return this._rasterTexture=P(this._rasterTexture),this._transformGridTexture=P(this._transformGridTexture),this._colormapTexture=P(this._colormapTexture),this.source=null,this.transformGrid=null,this.rawPixelData=null,!0}_updateRasterTexture(e,t){const i=this.source?this.source.extractBands(t):null;if(!(i&&i.pixels&&i.pixels.length>0))return void(this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null));const r=M(t)&&M(this.bandIds)||C(t)&&C(this.bandIds)&&t.join("")===this.bandIds.join("");if(this._rasterTexture){if(r)return;this._rasterTexture.dispose(),this._rasterTexture=null}const s=this._getRasterTextureInterpolation(this.interpolation);this._rasterTexture=Jh(e,i,s,this.isRendereredSource||this.hasStretchTypeNone())}hasStretchTypeNone(){return"stretchType"in this.symbolizerParameters&&"none"===this.symbolizerParameters.stretchType&&!this.symbolizerParameters.useGamma&&"u8"===this.source.pixelType}_getRasterTextureInterpolation(e){return"lut"===this.symbolizerParameters.type||"nearest"===e||"majority"===e?"nearest":"bilinear"}_updateColormapTexture(e){const t=this._colormap,i=this.symbolizerParameters.colormap;return i?t?i.length!==t.length||i.some(((e,i)=>e!==t[i]))?(this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),this._colormapTexture=$h(e,i),void(this._colormap=i)):void 0:(this._colormapTexture=$h(e,i),void(this._colormap=i)):(this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),void(this._colormap=null))}}class ww{constructor(){this.waitingAgents=new N,this._upsampleInfo=null,this.loadingAgent=null,this.requestPromise=null,this.requestAbort=null,this.pendingUpdates=0}static acquire(e){const t=bw.acquire();return t._init(e),t}release(){this.dispose(),Cw.delete(this),bw.release(this)}dispose(){this.loadingAgent=P(this.loadingAgent),this.abortRequest(),this._unsetUpsampleInfo(),this.pendingUpdates=0,this._data=Hl(this._data)}static prune(){bw.prune(0)}_init(e){this.waitingAgents.clear(),this._data=Hl(this._data),this.dataMissing=!1,this.dataInvalidated=!1,this._unsetUpsampleInfo(),this.abortRequest(),this.loadingAgent=null,this.pendingUpdates=0,this._pool=e,this.elevationBounds=null}invalidateSourceData(){this.dataInvalidated=!0,this.dataMissing=!1,this._unsetUpsampleInfo()}abortRequest(){this.requestAbort=A(this.requestAbort),this.requestPromise=null}get upsampleInfo(){return this._upsampleInfo}_unsetUpsampleInfo(){this._upsampleInfo&&(this._upsampleInfo.tile.unrefMapData(),this._pool.release(this._upsampleInfo),this._upsampleInfo=null)}setUpsampleInfo(e,t){if(e===t||M(t))this._unsetUpsampleInfo();else{if(null==this._upsampleInfo)this._upsampleInfo=this._pool.acquire();else{if(this._upsampleInfo.tile===t)return;this._upsampleInfo.tile.unrefMapData()}t.refMapData(),kh(e,t,this._upsampleInfo)}}get data(){return this._data}set data(e){Hl(this._data),this._data=e}}const bw=new cl(ww,null,(()=>{})),Cw=new Map;class Tw{constructor(e){this._texture=e,this.type="tile-texture",this._refCount=1}retain(){++this._refCount}release(){--this._refCount,0===this._refCount&&this._texture.dispose()}get texture(){return this._texture}generateMipmap(){this._texture.generateMipmap()}get descriptor(){return this._texture.descriptor}}const Sw=fe(),Pw=fe(),Rw=fe(),Mw=nr();class Dw{constructor(){this.fovX=0,this.fovY=0,this.relativeWidthLimit=0,this.relativeHeightLimit=0,this.maxLod=0,this.angledSplitBias=0,this.aboveGround=!0}}class Aw{constructor(e){this._numSubdivisionAtLevel=e,this.lij=[0,0,0],this._children=[null,null,null,null],this._dirty=!0,this._previouslyRendered=!1,this.extent=Ct(),this._elevationBounds=Nr(),this.layerInfo=[[],[]],this.extentInRadians=Ct(),this.centerAtSeaLevel=fe(),this._center=[fe(),$a(),fe()],this.up=Ye(),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._maxTesselation=0,this._usedMemory=Lw,this._mapTileMemory=0,this._mapDataRefCount=0,this._screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._curvatureHeight=0}static prune(){Iw.prune(0),zw.prune(0),ww.prune()}get usedMemory(){return this._usedMemory===Lw&&this._updateMemoryUsed(),this._usedMemory+(this.isCached?0:this.mapTileMemory)}get cachedMemory(){return this.isCached?this.mapTileMemory:0}get mapTileMemory(){this._usedMemory===Lw&&this._updateMemoryUsed();let e=this._mapTileMemory;for(const{data:t}of this.layerInfo[1])t instanceof yh&&(e+=t.memoryUsage);return e}get isCached(){return!this.shouldLoad&&this._mapDataRefCount<=0}get maxTesselation(){return this._maxTesselation}get numSubdivisionsAtLevel(){return this._numSubdivisionAtLevel}get isWithinClippingArea(){return this._isWithinClippingArea}get intersectsClippingArea(){return this._intersectsClippingArea}get clippingArea(){return this._clippingArea}get parent(){return this._parent}get children(){return this._children}get surface(){return this._surface}get elevationBounds(){return this._elevationBounds}get level(){return this.lij[0]}get edgeLen(){return this._edgeLen}get radius(){return this._center[1][3]}get screenDepth(){return this._screenDepth}get visible(){if(this._dirty){this._dirty=!1;const e=this._isVisible(this.surface.frustum);e!==this._visible&&(this._visible=e,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setNeedsRender(),this.updateAgentSuspension())}return this._visible}get loadable(){return this.visible||this._surface.view.state.fixedContentCamera}get rendered(){const e=!!this.renderData;return e!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=e,this._surface.renderer.setNeedsRender()),e}get shouldLoad(){if(!this.loadable)return!1;if(1===this._surface.lodSnapping){const e=this.level-this._surface.snapLevel;if(0===e)return!0;if(1===e)return!1}return this.isLeaf}init(e,t,i){this.lij[0]=e[0],this.lij[1]=e[1],this.lij[2]=e[2],this.ellipsoid=wt(i.tilingScheme.spatialReference),i.tilingScheme.getExtent(e[0],e[1],e[2],this.extent),i.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,i.upsampleMapCache.pop(jh(this)),this._edgeLen=0,this._edgeLen2=0,this._center[1][3]=0,this.vlevel=e?e[0]:0,t&&t.elevationBounds?Er(this._elevationBounds,t.elevationBounds):Ir(this._elevationBounds,0,0),this._pendingUpdates=0,this.renderData=null,this._screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=t,this.unsetChildren(),this._surface=i,this.updateVisibility();for(const e of Ah){const t=i.numLayers(e),r=this.layerInfo[e];for(const e of r)e.release();r.length=t;for(let i=0;i<t;i++)r[i]=ww.acquire(this._surface.upsampleInfoPool),0===e&&this.findElevationBoundsForLayer(i,-1)}this.computeElevationBounds(),this._maxTesselation=Math.min(i.tilingScheme.pixelSize,Ph)}release(){Bl(!this.renderData,"tile.renderData was not unloaded"),this._surface.upsampleMapCache.pop(jh(this));for(const e of Ah){for(const t of this.layerInfo[e])t.release();this.layerInfo[e].length=0}this._parent=null,this._surface=null,this._usedMemory=Lw}refMapData(){++this._mapDataRefCount,this.isCached||this._surface.upsampleMapCache.pop(jh(this))}unrefMapData(){if(--this._mapDataRefCount,this.isCached){const e=this.cachedMemory;e>0&&(this._surface.upsampleMapCache.put(jh(this),this,e),this.setMemoryDirty())}}setMemoryDirty(){this._usedMemory=Lw}get cpuImageMemorySize(){const e=this._surface.tilingScheme.pixelSize;return e*e*4}_updateMemoryUsed(){this._usedMemory=0,this._mapTileMemory=0;const e=this.cpuImageMemorySize;for(const{data:t}of this.layerInfo[1])t instanceof Tw?this._mapTileMemory+=Ba(t.texture):t instanceof HTMLImageElement||t instanceof Nl?this._mapTileMemory+=e:t instanceof xw&&(this._mapTileMemory+=t.memoryUsage);for(const t of this.layerInfo[0])this._usedMemory+=t.data?e:0;this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._mapTileMemory+=Ba(this.renderData.textureDescriptor)),this.isCached&&this._surface.upsampleMapCache.updateSize(jh(this),this,this.cachedMemory)}getUsedMemoryForLayer(e,t){const i=this.layerInfo[e][t];if(!i||!i.data)return 0;if(1!==e||this.isCached){if(0===e)return this.cpuImageMemorySize}else{const e=i.data;if(e instanceof Tw)return Ba(e.texture);if(e instanceof HTMLImageElement||e instanceof Nl)return this.cpuImageMemorySize;if(e instanceof yh||e instanceof xw)return e.memoryUsage}return 0}updateScreenDepth(e){ye(Mw,this._center[1]),Mw[3]=1,He(Mw,Mw,e),this._screenDepth=Mw[2]<0?0:Mw[2]/Mw[3]}shouldSplit(e,t,i){if(C(e.frustum)&&!this._isVisible(e.frustum))return 0;const r=this.level;Te(Sw,this._center[1],t);let s=Ae(Sw),a=1;Te(Pw,this._center[0],t);const n=Ae(Pw);n<s&&(s=n,a=0),Te(Pw,this._center[2],t);const o=Ae(Pw);if(o<s&&(s=o,a=2),this._edgeLen2>s&&r<e.maxLod)return 2;const l=Math.sqrt(s),h=e.fovX*l*2,c=this._edgeLen/h,d=()=>{const t=r+Math.ceil(-Xe(e.relativeWidthLimit/c));return t!==this.vlevel?(this.vlevel=t,4):1};if(1===i){if(1===this._surface.snapLevel-r)return r>=e.maxLod?d():2}const u=Ie(this.up,Sw),p=this._elevationBounds[1]-this._elevationBounds[0],m=p/this.edgeLen;if(e.aboveGround&&u>0&&m<.001){if(u/l-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-m>0)return 0}if(c<e.relativeWidthLimit)return this.vlevel!==this.level?(this.vlevel=this.level,4):0;if(r>=e.maxLod)return d();if(r>6){Te(Pw,this._center[a],t),Ce(Rw,this.up,u),Te(Rw,Rw,Pw);const i=Ae(Rw);if(i>this.radius*this.radius){Ce(Rw,Rw,this.radius/Math.sqrt(i)),Pe(Rw,Rw,this._center[a]),Te(Rw,t,Rw);const r=Math.min(1,(Math.abs(Ie(Rw,this.up))+.5*p+this._curvatureHeight)/_e(Rw)),s=.1/e.angledSplitBias,n=e.fovY*l*2;if(r*(this._edgeLen/n)<s*e.relativeHeightLimit)return 0}}return 2}setChildren(e,t,i,r){Bl(!!(e&&t&&i&&r),"Null child passed"),this._children[0]=e,this._children[1]=t,this._children[2]=i,this._children[3]=r}unsetChildren(){this._children[0]=null,this._children[1]=null,this._children[2]=null,this._children[3]=null}load(e){this.refMapData();for(const e of Ah)this._createOrUpdateAgents(0,e);e.loadTile(this)}unload(e){e.unloadTile(this);for(const e of Ah){const t=this.layerInfo[e];for(const e of t)e.loadingAgent&&e.loadingAgent!==fw&&(Fw(e.loadingAgent),e.loadingAgent=null),e.pendingUpdates=0}this.resetPendingUpdate(32),this.resetPendingUpdate(64),this.resetPendingUpdate(128),this.unrefMapData()}unloadMapData(){const e=this.layerInfo[1];for(const t of e)t.loadingAgent&&t.loadingAgent!==fw&&(Fw(t.loadingAgent),t.loadingAgent=null),t.pendingUpdates=0;this.renderData&&this.renderData.releaseTexture(),this.setMemoryDirty()}updateClippingStatus(e){if(Vt(e,this._clippingArea))return!1;const t=this._intersectsClippingArea,i=this._isWithinClippingArea;C(e)?(this._intersectsClippingArea=this.intersectsExtent(e),this._isWithinClippingArea=this._isWithinExtent(e)):(this._intersectsClippingArea=!0,this._isWithinClippingArea=!0),this._clippingArea=e,this.updateVisibility();const r=i&&this._isWithinClippingArea,s=!(i||t||this._isWithinClippingArea||this._intersectsClippingArea);return!this.renderData||r||s||this.setPendingUpdate(32),!0}updateVisibility(){this._dirty=!0,this._surface.setTileTreeDirty()}getLayerInfo(e,t){return this.layerInfo[t][e]}hasLayerData(e,t){const i=this.layerInfo[t][e];return!(!i||!i.data||i.dataInvalidated)}get updating(){if(this.hasPendingUpdates)return!0;for(const e of Ah){const t=this.layerInfo[e];for(const e of t)if(e.loadingAgent&&e.loadingAgent!==fw&&e.loadingAgent.updating)return!0}return!1}isSuspended(e){return!!this.hasPendingUpdate(2)||0!==e&&!this.loadable}get hasPendingUpdates(){return 0!==this._pendingUpdates}hasPendingUpdate(e){return(this._pendingUpdates&e)===e}setPendingUpdate(e){this._pendingUpdates|=e,2===e||8===e?this._surface.setTileTreeDirty():this._surface.requestUpdate()}resetPendingUpdate(e){return!!this.hasPendingUpdate(e)&&(this._pendingUpdates&=~e,!0)}requestLayerData(e,t,i){const r=this.layerInfo[t][e];if(r.waitingAgents.has(i))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),i.tile.lij.toString(),t,e),!0;if(r.waitingAgents.push(i),r.data&&!r.dataInvalidated)return console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),i.tile.lij.toString(),t,e),i.dataArrived(this),!0;if(r.requestPromise)return!0;A(r.requestAbort),r.requestAbort=h();const s=this._surface.requestTileData(this,e,t,r.requestAbort);if(!s)return r.requestAbort=null,!1;const a=()=>{r.requestPromise===s&&(r.requestPromise=null,r.requestAbort=null)};return r.requestPromise=s,s.then(a,a),!0}get isLeaf(){return null==this._children[0]}hasLij(e){return this.lij[0]===e[0]&&this.lij[1]===e[1]&&this.lij[2]===e[2]}findByLij(e){if(this.hasLij(e))return this;if(this.isLeaf)return null;const t=this._children[0].findByLij(e)||this._children[1].findByLij(e)||this._children[2].findByLij(e)||this._children[3].findByLij(e);return t||null}distanceToSquared(e){return Ae(Te(Rw,this._center[1],e))}containsPoint(e){const t=this.extent;return e[0]>=t[0]&&e[1]>=t[1]&&e[0]<=t[2]&&e[1]<=t[3]}unrequestLayerData(e,t,i){const r=this.layerInfo[t][e],s=r.waitingAgents,a=null!=s.removeUnordered(i);Bl(a,"agent has not requested this piece of map data"),s.length<1&&(r.abortRequest(),this._updateMemoryUsed())}dataArrived(e,t,i){const r=this.layerInfo[t][e];r.data=i,r.dataInvalidated=!1,r.waitingAgents.forAll((e=>e.dataArrived(this))),r.waitingAgents.clear(),this._updateMemoryUsed()}dataMissing(e,t,i){i.notInTilemap||console.error(`Tile ${this.lij.toString()} layer ${t}/${e} error ${i}`);const r=this.layerInfo[t][e];r.dataMissing=!0,r.waitingAgents.forAll((e=>e.dataMissing())),r.waitingAgents.clear(),this._updateMemoryUsed()}updateRenderData(e,t){switch(e){case 1:return this.updateTexture(t);case 0:return this.updateGeometry()}}updateTexture(e){this.renderData&&(this.resetPendingUpdate(0===e?64:128),this.setPendingUpdate(0===e?128:64))}updateGeometry(){this.setPendingUpdate(32);for(const e of this.layerInfo[0])e.pendingUpdates|=32}invalidateLayerData(e,t){this.layerInfo[t][e].invalidateSourceData(),this.restartAgents(t)}computeElevationBounds(){Ir(this._elevationBounds,Number.MAX_VALUE,-Number.MAX_VALUE);const e=this.layerInfo[0];let t=!0;for(const i of e)C(i.elevationBounds)&&(this._elevationBounds[0]=Math.min(this._elevationBounds[0],i.elevationBounds.min),this._elevationBounds[1]=Math.max(this._elevationBounds[1],i.elevationBounds.max),i.elevationBounds.hasNoDataValues||(t=!1));t&&(this._elevationBounds[0]=Math.min(this._elevationBounds[0],0),this._elevationBounds[1]=Math.max(this._elevationBounds[1],0)),this.updateRadiusAndCenter(),this._surface.setTileTreeDirty()}_updateCenter(){const e=.5*(this._elevationBounds[0]+this._elevationBounds[1]);Ce(Rw,this.up,e),Pe(this._center[1],this.centerAtSeaLevel,Rw),Ce(Rw,this.up,this._elevationBounds[0]),Pe(this._center[0],this.centerAtSeaLevel,Rw),Ce(Rw,this.up,this._elevationBounds[1]),Pe(this._center[2],this.centerAtSeaLevel,Rw)}findElevationBoundsForLayer(e,t){const i=this.layerInfo[0][e];if(C(i.elevationBounds)&&i.elevationBounds.level>=t)return;const r=this._surface.layerViewByIndex(e,0),s=ql(r);if(!Vh(this,s,!1))return;const a=Ew;let n=!1;if(i.data){const e=i.data;a.min=e.bounds[0],a.max=e.bounds[1],a.hasNoDataValues=e.hasNoDataValues,a.level=this.lij[0],n=!0}else{let t,i,r=0;for(let s=this._parent;s&&(!i||r<Dh)&&(r=this.vlevel-s.level,t=i||t,i=s.layerInfo[0][e].data,!(!i&&t&&r>=Dh));s=s.parent);i=i||t,i&&(i.computeMinMaxValue(this.lij[0],this.lij[1],this.lij[2],a),a.min!==1/0&&(a.level=i.level,n=!0))}n&&(M(i.elevationBounds)&&(i.elevationBounds=new zx),i.elevationBounds.copyFrom(a))}modifyLayers(e,t,i){const r=this.layerInfo[i];for(const e of r)e.loadingAgent&&e.loadingAgent!==fw&&(Fw(e.loadingAgent),e.loadingAgent=null),e.waitingAgents.clear();for(let t=0;t<r.length;++t)void 0===e[t]&&r[t].release();const s=new Array(...r),a=t.length;r.length=a;for(let e=0;e<a;e++){const i=t[e];r[e]=i>-1?s[i]:ww.acquire(this._surface.upsampleInfoPool)}this._updateMemoryUsed()}restartAgents(e){this.renderData&&(this._createOrUpdateAgents(0,e),this.updateRenderData(e,0))}updateAgents(e){if(this.renderData){const t=this.layerInfo[e];for(const e of t)e.loadingAgent===fw&&(e.loadingAgent=null);this._createOrUpdateAgents(0,e)}}updateAgentSuspension(){for(const e of Ah){const t=this.isSuspended(e);for(const i of this.layerInfo[e])i.loadingAgent&&i.loadingAgent!==fw&&(i.loadingAgent.setSuspension(t),i.loadingAgent===fw&&this.updateRenderData(e,0))}}removeLayerAgent(e,t){const i=this.layerInfo[t][e];i.loadingAgent&&i.loadingAgent!==fw&&i.loadingAgent.dispose(),i.loadingAgent=null}agentDone(e,t){const i=this.layerInfo[t][e];i.loadingAgent=fw,i.data||i.upsampleInfo||this._createOrUpdateAgents(e+1,t)}_createOrUpdateAgents(e,t){const i=this.isSuspended(t),r=this.layerInfo[t];for(let s=e;s<r.length;++s){const e=r[s];let a=!1;const n=this._surface.layerViewByIndex(s,t),o=ql(n);if(e.loadingAgent?Vh(this,o,!1)?(e.loadingAgent!==fw&&e.loadingAgent.setSuspension(i),e.loadingAgent!==fw&&(a=e.loadingAgent.update())):e.dispose():Vh(this,o,!1)&&(e.loadingAgent=Ow(this,s,t,i),a=e.loadingAgent.startLoading(),a?e.loadingAgent===fw&&this.setPendingUpdate(32):(Fw(e.loadingAgent),e.loadingAgent=fw)),e.loadingAgent===fw&&this.updateRenderData(t,0),a&&n.isOpaque)return}}_isWithinExtent(e){const t=this.extent;return t[0]>=e[0]&&e[2]>=t[2]&&t[1]>=e[1]&&e[3]>=t[3]}intersectsExtent(e){const t=this.extent;return t[2]>=e[0]&&e[2]>=t[0]&&t[3]>=e[1]&&e[3]>=t[1]}get test(){return{cachedMemory:this.cachedMemory}}}function Ow(e,t,i,r){const s=0===i?zw.acquire():Iw.acquire();return s.init(e,t,i,r),s}function Fw(e){e.dispose(),e instanceof vw?zw.release(e):e instanceof _w&&Iw.release(e)}const Iw=new cl(_w),zw=new cl(vw),Ew=new zx,Lw=-1;class Vw extends Aw{constructor(e,t,i){super(Vw.NumSubdivisionsAtLevel),this.horizontalScaleFactor=1,void 0!==e&&this.init(e,t,i)}init(e,t,i){super.init(e,t,i);const r=i.view.renderSpatialReference,s=C(r)&&gr(r)&&i.spatialReference.isGeographic;this.horizontalScaleFactor=s?this.ellipsoid.radius*Math.PI/180:1,this._edgeLen=(this.extent[2]-this.extent[0])*this.horizontalScaleFactor,this._edgeLen2=this._edgeLen*this._edgeLen,this.centerAtSeaLevel[0]=Me(this.extent[0],this.extent[2],.5)*this.horizontalScaleFactor,this.centerAtSeaLevel[1]=Me(this.extent[1],this.extent[3],.5)*this.horizontalScaleFactor,this.centerAtSeaLevel[2]=0,this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateCenter();const e=(this.extent[2]-this.extent[0])*Math.SQRT1_2,t=.5*(this.elevationBounds[0]-this.elevationBounds[1]);this._center[1][3]=Math.sqrt(e*e+t*t)}_isVisible(e){return this.intersectsClippingArea&&xl(e,this._aabb())}_aabb(){return rl(this.extent[0]*this.horizontalScaleFactor,this.extent[1]*this.horizontalScaleFactor,this.elevationBounds[0],this.extent[2]*this.horizontalScaleFactor,this.extent[3]*this.horizontalScaleFactor,this.elevationBounds[1])}intersectsRay(e,t,i,r,s){kw[0]=1/t[0],kw[1]=1/t[1],kw[2]=1/t[2];const a=s*(this.extent[2]-this.extent[0])*.1;return As(this._aabb(),e,kw,i+a,r)}createGeometry(e,t){!function(e,t,i,r,s){const a=t[0],n=t[1],o=t[2]-a,l=t[3]-n,h=e.clippingArea,c=C(h)?Math.max(0,(h[0]-t[0])/o):0,d=C(h)?Math.max(0,(h[1]-t[1])/l):0,u=C(h)?Math.min(1,(h[2]-t[0])/o):1,p=C(h)?Math.min(1,(h[3]-t[1])/l):1,m=u>c?1/(u-c):1,g=p>d?1/(p-d):1,f=-c*m,v=-d*g,_=.1*o,y=e.numVertsPerRow-1,x=e.numVertsPerRow-1,w=e.numVertsPerRow*e.numVertsPerRow,b=2*y+2*x,T=ew.acquire(w+b),S=T.position.typedBuffer,P=T.uv0.typedBuffer,R=s.geometryInfo.boundingBox;il(R);let M=0;for(let t=0;t<=x;t++){const s=t/x;let c=v+s*g,d=n+s*l;C(h)&&(d<h[1]?(d=h[1],c=0):d>h[3]&&(d=h[3],c=1));for(let s=0;s<=y;s++){const n=s/y;let l=f+n*m,u=a+n*o;C(h)&&(u<h[0]?(u=h[0],l=0):u>h[2]&&(u=h[2],l=1));const p=e.samplerData&&Ex.sample(u,d,e.samplerData)||0,g=u*r-i[0],v=d*r-i[1],x=p-i[2];aw(g,v,x,R);const b=Rh*M;S[b+0]=g,S[b+1]=v,S[b+2]=x,P[b+0]=l,P[b+1]=c;const T=ow(s,t,y,y);if(T>-1){const e=Rh*(w+T);S[e+0]=g,S[e+1]=v,S[e+2]=x,P[e+0]=nw(l,c),P[e+1]=_}++M}}s.geometryInfo.numVertsPerRow=e.numVertsPerRow,s.geometryInfo.vertexAttributes=T,s.geometryInfo.skirtLength=_,Re(s.geometryInfo.uvOffsetAndScale,c,d,u-c,p-d),sw(s.geometryInfo,e.numVertsPerRow,0,e.wireframe)}(e,this.extent,t,this.horizontalScaleFactor,this.renderData),this.setMemoryDirty()}}Vw.NumSubdivisionsAtLevel=[2,2,2,2,2,2,2,2];const kw=fe();class jw extends Aw{constructor(e,t,i){super(Uw),this.obb=new Array(8),this.isWebMercator=!1;for(let e=0;e<8;e++)this.obb[e]=fe();void 0!==e&&this.init(e,t,i)}init(e,t,i){super.init(e,t,i),this.isWebMercator=i.tilingScheme.spatialReference.isWebMercator;const r=this.ellipsoid.radius,s=this.extentInRadians[0],a=this.extentInRadians[1],n=this.extentInRadians[2],o=this.extentInRadians[3],l=e[0],h=Me(a,o,.5),c=Me(s,n,.5),d=0===l?0:Math.min(Math.abs(a),Math.abs(o));this._edgeLen=(n-s)*Math.cos(d)*r,this._edgeLen2=this._edgeLen*this._edgeLen,this._curvatureHeight=r-Math.sqrt(r*r-this._edgeLen2/4),_t(this.centerAtSeaLevel,c,h,this.ellipsoid.radius,0);const u=Ge(this.centerAtSeaLevel);we(u,u),this.up=u,this._updateOBB(),this.updateRadiusAndCenter()}updateRadiusAndCenter(){if(0===this.lij[0])ve(this._center[1],0,0,0),ve(this._center[0],0,0,0),ve(this._center[2],0,0,0),this.ellipsoid||(this.ellipsoid=wt(this.surface.spatialReference)),this._center[1][3]=this.ellipsoid.radius+this.elevationBounds[1];else{this._updateCenter();const e=Math.max(je(this._center[1],this.obb[0]),je(this._center[1],this.obb[1]));this._center[1][3]=Math.sqrt(e)}}_isVisible(e){if(!this.intersectsClippingArea)return!1;if(!gl(e,this._center[1]))return!1;if(this.lij[0]<10)return!0;const t=this.obb;for(let i=0;i<6;i++){const r=4===i,s=e[i];r&&(qw[0]=s[0],qw[1]=s[1],qw[2]=s[2],qw[3]=s[3]-this.surface.view.state.camera.near);const a=r?qw:s;let n;for(n=0;n<8;n++){const e=t[n];if(a[0]*e[0]+a[1]*e[1]+a[2]*e[2]+a[3]<0)break}if(8===n)return!1}return!0}computeElevationBounds(){super.computeElevationBounds(),this._updateOBB()}createGeometry(e,t){const i=this._isPole(this.lij[1],this.lij[0]);!function(e,t,i,r,s,a,n,o){const l=s[0],h=s[1],c=s[2],d=s[3],u=.1*n.radius*(d-h),p=e.numVertsPerRow-1,m=e.numVertsPerRow-1,g=e.numVertsPerRow*e.numVertsPerRow,f=2*p+2*m,v=ew.acquire(g+f),_=v.position.typedBuffer,y=v.uv0.typedBuffer,x=r.geometryInfo.boundingBox;il(x);const w=t[2]-t[0],b=t[3]-t[1],C=c-l,T=i[0],S=i[1],P=i[2];for(let e=0;e<=p;e++){const i=e/p,r=l+i*C;hw[e]=Math.sin(r),cw[e]=Math.cos(r),dw[e]=i,uw[e]=t[0]+i*w}const R=a&&!!(1&o),M=a&&!!(2&o);let D=0;for(let i=0;i<=m;i++){let r=i/m;const s=Me(h,d,r),o=Math.cos(s),l=Math.sin(s);let c;a?(c=n.halfSemiMajorAxis*Math.log((1+l)/(1-l)),r=(c-t[1])/b):c=180*s/Math.PI;for(let t=0;t<=p;t++){const s=dw[t],a=hw[t],h=cw[t];let d=n.radius;e.samplerData&&(d+=Ex.sample(uw[t],c,e.samplerData)||0);const f=h*o*d-T,v=a*o*d-S,w=l*d-P;aw(f,v,w,x);const b=Rh*D;_[b+0]=f,_[b+1]=v,_[b+2]=w,y[b+0]=s,y[b+1]=r;const C=ow(t,i,p,m);if(C>-1){const e=Rh*(g+C),t=R&&0===i?-1:M&&i===m?1:0,a=0===t?f:-T,o=0===t?v:-S,l=0===t?w:n.radius*t-P;_[e+0]=a,_[e+1]=o,_[e+2]=l,y[e+0]=0===t?nw(s,r):s,y[e+1]=0===t?u:r,0!==t&&aw(a,o,l,x)}++D}}r.geometryInfo.numVertsPerRow=e.numVertsPerRow,r.geometryInfo.vertexAttributes=v,r.geometryInfo.skirtLength=u,Re(r.geometryInfo.uvOffsetAndScale,0,0,1,1),sw(r.geometryInfo,e.numVertsPerRow,a?o:0,e.wireframe),r.intersectionData=null}(e,this.extent,t,this.renderData,this.extentInRadians,this.isWebMercator,this.ellipsoid,i),this.setMemoryDirty()}_updateOBB(){const e=this.extentInRadians,t=this.obb;for(let i=0;i<2;i++){const r=this.elevationBounds[i];let s=4*i;_t(t[s++],e[0],e[1],this.ellipsoid.radius,r),_t(t[s++],e[0],e[3],this.ellipsoid.radius,r),_t(t[s++],e[2],e[3],this.ellipsoid.radius,r),_t(t[s++],e[2],e[1],this.ellipsoid.radius,r)}if(this.isWebMercator){const e=this._isPole(this.lij[1],this.lij[0]);2===e?(ve(t[1],0,0,this.ellipsoid.radius),ve(t[2],0,0,this.ellipsoid.radius),ve(t[5],0,0,this.ellipsoid.radius),ve(t[6],0,0,this.ellipsoid.radius)):1===e&&(ve(t[0],0,0,-this.ellipsoid.radius),ve(t[3],0,0,-this.ellipsoid.radius),ve(t[4],0,0,-this.ellipsoid.radius),ve(t[7],0,0,-this.ellipsoid.radius))}}_isPole(e,t){let i=0;return e===(1<<t)-1&&(i+=1),0===e&&(i+=2),i}intersectsRay(e,t,i,r,s){const a=this._center[1],n=a[3],o=a[0],l=a[1],h=a[2],c=n+i+.2*this.ellipsoid.radius*Math.abs(s*(this.extentInRadians[3]-this.extentInRadians[1])),d=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],u=o-e[0],p=l-e[1],m=h-e[2],g=(u*t[0]+p*t[1]+m*t[2])/d,f=t[0]*g-u,v=t[1]*g-p,_=t[2]*g-m;return f*f+v*v+_*_<c*c}}const Uw=[128,64,32,16,16,8,8,4],qw=vo();class Hw{constructor(e){this._getFadeDuration=e,this._fadeStart=0,this._delayedTime=0}clear(){this._current=R(this._current),this._next=R(this._next),this._waiting=R(this._waiting),this._delayed=R(this._delayed)}get current(){if(M(this._current))return null;if(!this._isFadingEnabled){const e=this._delayed||this._waiting||this._next||this._current;e!==this._current&&(this._current=null,this.clear(),this._current=e)}let e=0;if(C(this._delayed)&&(e=performance.now(),e>=this._delayedTime&&(this._push(this._delayed,0),this._delayed=null)),C(this._next)){e=e||performance.now();const t=this._fadeDuration,i=C(this._current)&&this._next.texture===this._current.texture,r=0!==this._next.type,s=e-this._fadeStart>=t;(i||r||s)&&(R(this._current),this._current=this._next,this._next=this._waiting,this._waiting=null,this._fadeStart=this._alignFadeStart(e))}return this._current}get next(){return this._next}get fadeFactor(){if(M(this._next))return 1;const e=Math.max(0,performance.now()-this._fadeStart),t=this._fadeDuration;return e>t?0:1-e/t}get isFading(){return C(this._next)||C(this._delayed)}push(e,t=0){this._delayed=R(this._delayed),this._push(e,t)}_push(e,t){if(this._isFadingEnabled||this.clear(),M(this._current))return void(this._current=e);const i=performance.now();return 0!==t?(this._delayed=e,void(this._delayedTime=i+t)):M(this._next)?(this._next=e,void(this._fadeStart=this._alignFadeStart(i))):void(M(e)||(R(this._waiting),this._waiting=e))}get _fadeDuration(){return M(this._waiting)?this._getFadeDuration():.5*this._getFadeDuration()}_alignFadeStart(e){const t=this._getFadeDuration();return e+t-e%t}get _isFadingEnabled(){return this._getFadeDuration()>0}}class Bw{constructor(){this._scales=[-1,-1,-1,-1],this._offsets=[-1,-1,-1,-1]}clear(){this._scales[0]=this._scales[1]=this._scales[2]=this._scales[3]=-1,this._offsets[0]=this._offsets[1]=this._offsets[2]=this._offsets[3]=-1}setScale(e,t,i){this._scales[2*e]=t,this._scales[2*e+1]=i}setOffset(e,t,i){this._offsets[2*e]=t,this._offsets[2*e+1]=i}get scales(){return this._scales}get offsets(){return this._offsets}}class Nw{constructor(){this.geometryInfo=new tw,this.intersectionData=null,this._textureRef=new Hw((()=>this.tile.surface.textureFadeDuration)),this.overlay=new Bw}init(e){this.tile=e,this.clear();const t=this.geometryInfo;t.indices=null,t.vertexAttributes=null,il(t.boundingBox),t.numSurfaceIndices=0,t.numSkirtIndices=0,t.numWithoutSkirtIndices=0,t.numVertsPerRow=0,this.intersectionData=null,this.geometryState={numVertsPerRow:0,samplerData:null,clippingArea:null,wireframe:!1},this.localOrigin=null,this.overlay.clear()}clear(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear()}updateGeometry(e,t){return!!this._updateGeometryState(t)&&(this._releaseGeometry(),this._createGeometry(e),!0)}releaseGeometry(){return!!this._releaseGeometry()&&(this.geometryState={numVertsPerRow:0,samplerData:null,clippingArea:null,wireframe:!1},!0)}ensureTexture(e,t){return C(this._texture)&&this._texture.descriptor.width!==e&&this.releaseTexture(),M(this._texture)&&(this._texture=t(),this.tile.setMemoryDirty()),this._texture}releaseTexture(){C(this._texture)&&(this._texture.release(),this._texture=null,this.tile.setMemoryDirty())}_updateGeometryState(e){const t=this._getElevationInfo(),i=this.tile.level;let r=i<8?this.tile.numSubdivisionsAtLevel[i]+1:2;if(t.samplerData){const e=this.tile.vlevel-i,s=Math.max(i-t.maxTileLevel,Dh-e),a=this.tile.maxTesselation;r=ue(1+(a>>s),2,a+1)}let s=this.tile.clippingArea;this.tile.intersectsClippingArea&&!this.tile.isWithinClippingArea||(s=null);const a=this.geometryState;let n=!1;return a.numVertsPerRow!==r&&(a.numVertsPerRow=r,n=!0),t.changed&&(a.samplerData=t.samplerData,n=!0),sh(a.clippingArea,s)||(a.clippingArea=s,n=!0),a.wireframe!==e&&(a.wireframe=e,n=!0),n}_createGeometry(e){this.tile.createGeometry(this.geometryState,this.localOrigin);const t=this.geometryInfo.vertexAttributes,i=this.geometryInfo.indices,r=e.gl;this._vao=new qa(e,ys,{geometry:Mn(t.layout)},{geometry:Ha.createVertex(e,r.STATIC_DRAW,t.buffer)},Ha.createIndex(e,r.STATIC_DRAW,i))}_releaseGeometry(){return!!this._vao&&(this._vao.dispose(),this._vao=null,e=this.geometryInfo,ew.release(e.vertexAttributes),e.vertexAttributes=null,e.indices=null,!0);var e}get vao(){return this._vao}setTextureReference(e,t=0){e!==this._texture&&this.releaseTexture(),this._textureRef.push(e,t)}get textureReference(){return this._textureRef.current}get nextTextureReference(){return this._textureRef.next}get textureFadeFactor(){return this._textureRef.fadeFactor}get textureIsFading(){return this._textureRef.isFading}_getElevationInfo(){const e=this.geometryState.samplerData,t=this.tile.layerInfo[0],i=t.length;let r=new Array(i),s=0,a=0,n=!1;for(let o=0;o<i;o++){const i=t[o];if(i.upsampleInfo){const t=i.upsampleInfo.tile,l=t.layerInfo[0][o].data,h=l&&l.samplerData;e&&e[s]===h||(n=!0),r[s++]=h,a=Math.max(a,t.lij[0])}else if(i.data){const t=this.tile.surface.layerViewByIndex(o,0);if(Vh(this.tile,t.layer,!1)){const t=i.data;e&&e[s]===t.samplerData||(n=!0),r[s++]=t.samplerData,a=this.tile.lij[0]}}}return e&&e.length!==s&&(n=!0),s>0?r.length=s:r=null,{changed:n,samplerData:r,maxTileLevel:a}}get estimatedGeometryMemoryUsage(){return this.geometryInfo.indices.byteLength+this.geometryInfo.vertexAttributes.byteLength}get textureDescriptor(){return C(this._texture)?this._texture.descriptor:null}get test(){return{hasTexture:null!=this._texture}}}class Gw{constructor(){this.extent=nr(),this.minLevel=0,this.maxLevel=0,this.callback=null}}class Ww{constructor(){this._queries=new N({initialSize:10}),this._queriesInvPtr=0,this._queryQueue=new N({initialSize:30}),this._queryPool=new cl(Gw)}queryVisibleLevelRange(e,t,i,r){const s=this._queryPool.acquire();Ke(s.extent,e),s.minLevel=t||-Number.MAX_VALUE,s.maxLevel=null!=i?i:Number.MAX_VALUE,s.callback=r,this._queryQueue.push(s)}hasPendingQueries(){return 0!==this._queryQueue.length}prepareQueries(){for(;this._queries.length<this._queries.data.length&&this._queryQueue.length>0;){const e=this._queryQueue.pop();this._queries.push(e)}this._queriesInvPtr=this._queries.length}processQueries(){for(let e=0;e<this._queries.length;e++){const t=this._queries.data[e];this._queryPool.release(t),t.callback(e>=this._queriesInvPtr),t.callback=null}this._queries.clear()}scaleQueriesForTile(e){const t=e.lij[0];let i=0;for(;i<this._queriesInvPtr;){const r=this._queries.data[i],s=r.extent;t>=r.minLevel&&t<=r.maxLevel&&s[0]<=e.extent[2]&&s[2]>=e.extent[0]&&s[1]<=e.extent[3]&&s[3]>=e.extent[1]?(this._queries.swapElements(i,this._queriesInvPtr-1),this._queriesInvPtr--):i++}}}class Qw{constructor(){this._renderParams={context:null,drawPhase:1,state:ko(new sc({viewpoint:new s({targetGeometry:new Cl(0,0),scale:1,rotation:0}),size:[256,256]})),stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,driverTestResult:null,profiler:null,renderingOptions:null,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1}}dispose(){this._renderParams=null}render(e,t,i,r,s,a,n,o,l,h){const c=a.adjustLevel(t[0]),d=this._renderParams;d.context=e,d.painter=r,d.glyphMosaic=r.glyphMosaic,d.spriteMosaic=r.spriteMosaic,d.pixelRatio=h,d.displayLevel=c,d.requiredLevel=c;const u=a.getScale(t[0]),[p,m]=a.getShift(t,n*u),g=.125*n*u/l,f=i.transforms.dvs;f[0]=g,f[4]=-g,f[6]=-1-p-o[0]*n*2,f[7]=1+m+(1-o[1])*n*2-2,d.state.size[0]=l,d.state.size[1]=l,i.stage||i.attachWithContext(e),i.triangleCount=0,r.drawTile(d,i,s)}}var Zw=Object.freeze({__proto__:null,build:function(){const e=new ds;return e.attributes.add("position","vec2"),e.attributes.add("uv0","vec2"),e.vertex.uniforms.add("scale","float"),e.vertex.uniforms.add("offset","vec2"),e.varyings.add("uv","vec2"),e.vertex.code.add(us`void main(void) {
gl_Position = vec4(position, 0.0, 1.0);
uv = uv0 * scale + offset;
}`),e.fragment.uniforms.add("tex","sampler2D"),e.fragment.uniforms.add("opacity","float"),e.fragment.code.add(us`void main() {
vec4 color = texture2D(tex, uv);
gl_FragColor = vec4(color.xyz, 1.0) * color.a * opacity;
}`),e}});class Yw extends vs{initializeProgram(e){const t=Yw.shader.get().build();return new _s(e.rctx,t,ys)}initializePipeline(){const e=2===this.configuration.mode?ka(1,771):1===this.configuration.mode?ka(0,770):null;return Ea({blending:e,colorWrite:Va})}}Yw.shader=new gs(Zw,(()=>Promise.resolve().then((function(){return Zw}))));class Xw extends fs{constructor(){super(...arguments),this.mode=0}}function Kw(e){e.attributes.add("position","vec2"),e.attributes.add("uv0","vec2"),e.vertex.uniforms.add("u_scale","float"),e.vertex.uniforms.add("u_offset","vec2"),e.varyings.add("v_texcoord","vec2"),e.vertex.code.add(us`void main(void) {
v_texcoord = uv0 * u_scale + u_offset;
gl_Position = vec4(position, 0.0, 1.0);
}`)}function Jw(e){e.fragment.uniforms.add("u_colormap","sampler2D"),e.fragment.uniforms.add("u_colormapOffset","float"),e.fragment.uniforms.add("u_colormapMaxIndex","float"),e.fragment.code.add(us`vec4 colormap(vec4 currentPixel, bool isFloat) {
float clrIndex = isFloat ? currentPixel.r - u_colormapOffset : currentPixel.r * 255.0 - u_colormapOffset;
vec4 result;
if (currentPixel.a == 0.0 || clrIndex > u_colormapMaxIndex) {
result = vec4(0.0, 0.0, 0.0, 0.0);
} else {
vec2 clrPosition = vec2((clrIndex + 0.5) / (u_colormapMaxIndex + 1.0), 0.0);
vec4 color = texture2D(u_colormap, clrPosition);
result = vec4(color.rgb, 1.0) * color.a * u_opacity;
}
return result;
}`)}function $w(e){e.fragment.uniforms.add("u_transformGrid","sampler2D"),e.fragment.uniforms.add("u_transformSpacing","vec2"),e.fragment.uniforms.add("u_transformGridSize","vec2"),e.fragment.uniforms.add("u_targetImageSize","vec2"),e.fragment.code.add(us`vec2 projectPixelLocation(vec2 coords) {
vec2 index_image = floor(coords * u_targetImageSize);
vec2 oneTransformPixel = vec2(0.25 / u_transformGridSize.s, 1.0 / u_transformGridSize.t);
vec2 index_transform = floor(index_image / u_transformSpacing) / u_transformGridSize;
vec2 pos = fract((index_image + vec2(0.5, 0.5)) / u_transformSpacing);
vec2 srcLocation;
vec2 transform_location = index_transform + oneTransformPixel * 0.5;
if (pos.s <= pos.t) {
vec4 ll_abc = texture2D(u_transformGrid, vec2(transform_location.s, transform_location.t));
vec4 ll_def = texture2D(u_transformGrid, vec2(transform_location.s + oneTransformPixel.s, transform_location.t));
srcLocation.s = dot(ll_abc.rgb, vec3(pos, 1.0));
srcLocation.t = dot(ll_def.rgb, vec3(pos, 1.0));
} else {
vec4 ur_abc = texture2D(u_transformGrid, vec2(transform_location.s + 2.0 * oneTransformPixel.s, transform_location.t));
vec4 ur_def = texture2D(u_transformGrid, vec2(transform_location.s + 3.0 * oneTransformPixel.s, transform_location.t));
srcLocation.s = dot(ur_abc.rgb, vec3(pos, 1.0));
srcLocation.t = dot(ur_def.rgb, vec3(pos, 1.0));
}
return srcLocation;;
}`)}function eb(e){e.include($w),e.fragment.uniforms.add("u_image","sampler2D"),e.fragment.uniforms.add("u_isFloatTexture","bool"),e.fragment.uniforms.add("u_flipY","bool"),e.fragment.uniforms.add("u_applyTransform","bool"),e.fragment.uniforms.add("u_opacity","float"),e.fragment.code.add(us`vec2 getPixelLocation(vec2 coords) {
vec2 targetLocation = u_flipY ? vec2(coords.s, 1.0 - coords.t) : coords;
if (!u_applyTransform) {
return targetLocation;
}
return projectPixelLocation(targetLocation);
}
bool isOutside(vec2 coords){
if (coords.t>1.00001 ||coords.t<-0.00001 || coords.s>1.00001 ||coords.s<-0.00001) {
return true;
} else {
return false;
}
}
vec4 getPixel(vec2 pixelLocation) {
return texture2D(u_image, pixelLocation);
}`)}e([ms({count:3})],Xw.prototype,"mode",void 0);var tb=Object.freeze({__proto__:null,build:function(e){const t=new ds;return t.include(Kw),t.include(eb),t.include(Jw),0===e.output?function(e,t){e.fragment.uniforms.add("u_bandCount","int"),e.fragment.uniforms.add("u_minCutOff","float",3),e.fragment.uniforms.add("u_maxCutOff","float",3),e.fragment.uniforms.add("u_factor","float",3),e.fragment.uniforms.add("u_minOutput","float"),e.fragment.uniforms.add("u_maxOutput","float"),e.fragment.uniforms.add("u_useGamma","bool"),e.fragment.uniforms.add("u_gamma","float",3),e.fragment.uniforms.add("u_gammaCorrection","float",3),e.fragment.code.add(us`float stretchOneValue(float val, float minCutOff, float maxCutOff, float minOutput, float maxOutput, float factor, bool useGamma, float gamma, float gammaCorrection) {
if (val >= maxCutOff) {
return maxOutput;
} else if (val <= minCutOff) {
return minOutput;
}
float stretchedVal;
if (useGamma) {
float tempf = 1.0;
float outRange = maxOutput - minOutput;
float relativeVal = (val - minCutOff) / (maxCutOff - minCutOff);
if (gamma > 1.0) {
tempf -= pow(1.0 / outRange, relativeVal * gammaCorrection);
}
stretchedVal = (tempf * outRange * pow(relativeVal, 1.0 / gamma) + minOutput) / 255.0;
} else {
stretchedVal = minOutput + (val - minCutOff) * factor;
}
return stretchedVal;
}`);const i=t.applyColormap?us`gl_FragColor = colormap(vec4(grayVal, grayVal, grayVal, currentPixel.a), !u_useGamma);`:us`gl_FragColor = vec4(grayVal, grayVal, grayVal, 1.0) * currentPixel.a * u_opacity;`;e.fragment.code.add(us`
      void main() {
        vec2 pixelLocation = getPixelLocation(v_texcoord);
        if (isOutside(pixelLocation)) {
          gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
          return;
        }

        vec4 currentPixel = getPixel(pixelLocation);
        ${0===t.stretchType?us`
        gl_FragColor = vec4(currentPixel.rgb, 1.0) * currentPixel.a * u_opacity;`:us`
        if (currentPixel.a == 0.0) {
          gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
          return;
        }
        if (u_bandCount == 1) {
          float grayVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          ${i}
        } else {
          float redVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          float greenVal = stretchOneValue(currentPixel.g, u_minCutOff[1], u_maxCutOff[1], u_minOutput, u_maxOutput, u_factor[1], u_useGamma, u_gamma[1], u_gammaCorrection[1]);
          float blueVal = stretchOneValue(currentPixel.b, u_minCutOff[2], u_maxCutOff[2], u_minOutput, u_maxOutput, u_factor[2], u_useGamma, u_gamma[2], u_gammaCorrection[2]);
          gl_FragColor = vec4(redVal, greenVal, blueVal, 1.0) * currentPixel.a * u_opacity;
        }`}
      }`)}(t,e):1===e.output?function(e){e.fragment.code.add(us`void main() {
vec2 pixelLocation = getPixelLocation(v_texcoord);
if (isOutside(pixelLocation)) {
gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
return;
}
vec4 currentPixel = getPixel(pixelLocation);
gl_FragColor = colormap(currentPixel, true);
}`)}(t):2===e.output&&function(e,t){e.fragment.uniforms.add("u_hillshadeType","int"),e.fragment.uniforms.add("u_sinZcosAs","float",6),e.fragment.uniforms.add("u_sinZsinAs","float",6),e.fragment.uniforms.add("u_cosZs","float",6),e.fragment.uniforms.add("u_weights","float",6),e.fragment.uniforms.add("u_factor","vec2"),e.fragment.uniforms.add("u_applyColormap","bool"),e.fragment.uniforms.add("u_minValue","float"),e.fragment.uniforms.add("u_maxValue","float"),e.fragment.uniforms.add("u_srcImageSize","vec2"),e.fragment.include(bs),e.fragment.code.add(us`vec4 overlay(float val, float minValue, float maxValue, float hillshade, float alpha) {
val = clamp((val - minValue) / (maxValue - minValue), 0.0, 1.0);
vec4 rgb = colormap(vec4(val, val, val, 1.0), false);
vec3 hsv = rgb2hsv(rgb.xyz);
hsv.z = hillshade;
return vec4(hsv2rgb(hsv) * alpha, alpha);
}`),e.fragment.code.add(us`float getNeighborHoodAlpha(float a, float b, float c, float d, float e, float f, float g, float h, float i){
if (a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0) {
return 0.0;
}  else {
return e;
}
}`);const i=t.applyColormap?us`gl_FragColor = overlay(ve.r, u_minValue, u_maxValue, hillshade, alpha);`:us`hillshade *= alpha;
gl_FragColor = vec4(hillshade, hillshade, hillshade, alpha);`;e.fragment.code.add(us`
    void main() {
      vec2 pixelLocation = getPixelLocation(v_texcoord);
      if (isOutside(pixelLocation)) {
        gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
        return;
      }

      vec4 currentPixel = getPixel(pixelLocation);
      if (currentPixel.a == 0.0) {
        gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
        return;
      }

      //mirror edge pixels
      vec2 axy = vec2(-1.0, -1.0);
      vec2 bxy = vec2(0.0, -1.0);
      vec2 cxy = vec2(1.0, -1.0);
      vec2 dxy = vec2(-1.0, 0.0);
      vec2 fxy = vec2(1.0, 0.0);
      vec2 gxy = vec2(-1.0, 1.0);
      vec2 hxy = vec2(0.0, 1.0);
      vec2 ixy = vec2(1.0, 1.0);
      vec2 onePixel = 1.0 / u_srcImageSize;
      if (pixelLocation.s < onePixel.s) {
        axy[0] = 1.0;
        dxy[0] = 1.0;
        gxy[0] = 1.0;
      }
      if (pixelLocation.t < onePixel.t) {
        axy[1] = 1.0;
        bxy[1] = 1.0;
        cxy[1] = 1.0;
      }
      if (pixelLocation.s > 1.0 - onePixel.s) {
        cxy[0] = -1.0;
        fxy[0] = -1.0;
        ixy[0] = -1.0;
      }
      if (pixelLocation.t > 1.0 - onePixel.t) {
        gxy[1] = -1.0;
        hxy[1] = -1.0;
        ixy[1] = -1.0;
      }

      // calculate hillshade
      vec4 va = texture2D(u_image, pixelLocation + onePixel * axy);
      vec4 vb = texture2D(u_image, pixelLocation + onePixel * bxy);
      vec4 vc = texture2D(u_image, pixelLocation + onePixel * cxy);
      vec4 vd = texture2D(u_image, pixelLocation + onePixel * dxy);
      vec4 ve = texture2D(u_image, pixelLocation);
      vec4 vf = texture2D(u_image, pixelLocation + onePixel * fxy);
      vec4 vg = texture2D(u_image, pixelLocation + onePixel * gxy);
      vec4 vh = texture2D(u_image, pixelLocation + onePixel * hxy);
      vec4 vi = texture2D(u_image, pixelLocation + onePixel * ixy);

      // calculate the rate of z change along the x, y, and diagonal direction
      float dzx = (vc + 2.0 * vf + vi - va - 2.0 * vd - vg).r * u_factor.s;
      float dzy = (vg + 2.0 * vh + vi - va - 2.0 * vb - vc).r * u_factor.t;
      float dzd = sqrt(1.0 + dzx * dzx + dzy * dzy);
      float hillshade = 0.0;

      // traditional single light source
      if (u_hillshadeType == 0){
        float cosDelta = u_sinZsinAs[0] * dzy - u_sinZcosAs[0] * dzx;
        float z = (u_cosZs[0] + cosDelta) / dzd;
        if (z < 0.0)  z = 0.0;
        hillshade = z;
      } else {
        // multi-directional with 6 light sources
        for (int k = 0; k < 6; k++) {
        float cosDelta = u_sinZsinAs[k] * dzy - u_sinZcosAs[k] * dzx;
        float z = (u_cosZs[k] + cosDelta) / dzd;
        if (z < 0.0) z = 0.0;
        hillshade = hillshade + z * u_weights[k];
        if (k == 5) break;
        }
      }

      // set color
      float alpha = getNeighborHoodAlpha(va.a, vb.a, vc.a, vd.a, ve.a, vf.a, vg.a, vh.a, vi.a);
      alpha *= u_opacity;
      ${i}
    }
  `)}(t,e),t}});class ib extends vs{get uniformLocationInfos(){return this._uniformLocationInfos||(this._uniformLocationInfos=ec(this._context,this.program)),this._uniformLocationInfos}initializeProgram(e){const t=ib.shader.get(),i=this.configuration,r=t.build({output:i.colorizerType,applyColormap:i.applyColormap,stretchType:i.stretchType});return this._context=e.rctx,new _s(e.rctx,r,ys)}initializePipeline(){const e=2===this.configuration.mode?ka(1,771):1===this.configuration.mode?ka(0,770):null;return Ea({blending:e,colorWrite:Va})}bindPass(e){tc(this.program,this.uniformLocationInfos,e.basic),tc(this.program,this.uniformLocationInfos,e.common),C(e.colormap)&&tc(this.program,this.uniformLocationInfos,e.colormap),0===this.configuration.colorizerType&&C(e.stretch)?tc(this.program,this.uniformLocationInfos,e.stretch):2===this.configuration.colorizerType&&C(e.hillshade)&&tc(this.program,this.uniformLocationInfos,e.hillshade)}}ib.shader=new gs(tb,(()=>Promise.resolve().then((function(){return tb}))));class rb extends fs{constructor(){super(...arguments),this.mode=2,this.colorizerType=0,this.stretchType=0,this.applyColormap=!0}}e([ms({count:3})],rb.prototype,"mode",void 0),e([ms({count:3})],rb.prototype,"colorizerType",void 0),e([ms({count:2})],rb.prototype,"stretchType",void 0),e([ms()],rb.prototype,"applyColormap",void 0);class sb{constructor(e,t,i,r,s,a,n){this.texture=e,this.type=t,e.retain(),this.offsetAndScale=or(i.offset[0],i.offset[1],i.scale,i.scale),this.opacities=ge(r,n?a:0,s)}destroy(){this.texture.release()}}class ab{constructor(e){this._rctx=e,this._pools=new Map}acquire(e){return this.getPool(e).acquire()}release(e){this.getPool(e.width).release(e)}clear(){this._pools.forEach((e=>e.destroy())),this._pools.clear()}getPool(e){let t=this._pools.get(e);if(!t){const i=Tn.bind(Tn,this._rctx,{colorTarget:0,depthStencilTarget:1,width:e,height:e});t=new cl(i),this._pools.set(e,t)}return t}}class nb{constructor(e,t,i){this._rctx=e,this.tileSize=t,this._backgroundIsGrid=!1,this._backgroundTexture=null,this._backgroundColor=null,this._blackTex=null,this._vectorTileHelper=new Qw,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._vaoQuad=xs(this._rctx,ws);const r=new Xw;r.mode=2,this._blendLayersTechnique=i.acquire(Yw,r),r.mode=1,this._applyOpacityTechnique=i.acquire(Yw,r),this._techniqueRep=i,this._blackTex=new Tw(Os(this._rctx,[0,0,0,1])),this._fboPool=new ab(this._rctx)}get backgroundIsGrid(){return this._backgroundIsGrid}get backgroundColor(){return this._backgroundColor}dispose(){this._fboPool&&(this._fboPool.clear(),this._fboPool=null),this._vaoQuad=P(this._vaoQuad),this._backgroundTexture=S(this._backgroundTexture),this._blackTex=S(this._blackTex),this._blendLayersTechnique=P(this._blendLayersTechnique),this._applyOpacityTechnique=P(this._applyOpacityTechnique),this._vectorTileHelper=P(this._vectorTileHelper)}updateTileTexture(e,t){const i=e.layerInfo[1];for(const e of i)e.pendingUpdates&=-1;if(!e.renderData)return;const r=e.surface,s=r.baseOpacity;let a=0,n=0,o=this.tileSize,l=!1;const h=r.view.pixelRatio;let c=i.length,d=0;for(;d<i.length&&!l;d++){const t=r.layerViewByIndex(d,1),u=t.fullOpacity;if(lb[d]=u,$t(t.layer)&&c>=i.length&&(c=d),0===u)continue;++n;const p=ob(e,d,hb);p&&(Gl(t)?o=Math.max(o,this.tileSize*h):1===s&&1===u&&(t.isOpaque||this._dataToTexture(p)&&p.sourceLayerInfo.data.descriptor.isOpaque)&&(l=!0),++a)}this._cleanupFBOPool(h,i.length),o=function(e){const t=Ne(e),i=t*t,r=e*e;if(i===r)return e;const s=t/2;return i-r<r-s*s?t:s}(o);const u=o/this.tileSize,p=d-1;0!==a?1===a&&(l||this._backgroundIsGrid||C(this._backgroundColor))&&this._useLayerTexture(e,p,c,lb[p])||this._composeMapLayers(e,t,p,c,l,lb,o,u):this._useBackgroundTexture(e,n)}_useBackgroundTexture(e,t){let i=0;(e.surface.view.layerViewManager.updating||t>0)&&(i=5e3),this._backgroundTexture&&M(e.renderData.textureReference)&&(i=0),e.renderData.setTextureReference(C(this._backgroundTexture)?new sb(this._backgroundTexture,0,cb,e.surface.baseOpacity,1,1,!1):null,i)}_useLayerTexture(e,t,i,r){const s=t<i,a=s?1:e.surface.baseOpacity,n=s?e.surface.baseOpacity:1,o=ob(e,t,hb);return!!this._dataToTexture(o)&&(e.renderData.setTextureReference(new sb(o.sourceLayerInfo.data,0,o,a,r,n,!0)),!0)}_composeMapLayers(e,t,i,r,s,a,n,o){const l=this._rctx,h=this._fboPool.acquire(n);l.bindFramebuffer(h),l.setViewport(0,0,n,n),l.setClearColor(0,0,0,0),l.setClearDepth(1),l.clearSafe(16640);let c=!1;!s&&C(this._backgroundTexture)&&this._drawRasterData(this._blendLayersTechnique,this._backgroundTexture.texture,1,Gr);const d=e.surface.baseOpacity;let u=!1,p=9987;for(let t=i;t>=0;t--){const i=ob(e,t,hb);i&&(t<r&&d<1&&!u&&(this._drawRasterData(this._applyOpacityTechnique,this._blackTex.texture,1,Gr,d),u=!0),0!==a[t]&&(Wl(i)?c=this._drawVectorData(this._blendLayersTechnique,i,o,a[t],n,h,c):Ql(i)?(this._drawImageryTileData(i,a[t]),this.hasNearestInterpolation(i)&&(p=9728)):this._dataToTexture(i)&&this._drawRasterData(this._blendLayersTechnique,i.sourceLayerInfo.data.texture,i.scale,i.offset,a[t])))}const m=e.renderData.ensureTexture(n,(()=>this._buildTexture(n,p))),g=l.bindTexture(m.texture,Pn.TEXTURE_UNIT_FOR_UPDATES),f=m.descriptor;l.gl.copyTexImage2D(l.gl.TEXTURE_2D,0,f.pixelFormat,0,0,f.width,f.height,0),m.generateMipmap(),l.bindTexture(g,Pn.TEXTURE_UNIT_FOR_UPDATES),l.bindFramebuffer(null),this._fboPool.release(h);const v=u?1:d;e.renderData.setTextureReference(new sb(m,t,cb,v,1,1,!1))}_drawQuad(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(5,0,Ua(this._vaoQuad,"geometry"))}_drawRasterData(e,t,i,r,s=1){if(M(t))return;const a=this._rctx,n=e.program;a.setPipelineState(e.pipeline),a.useProgram(n),n.bindTexture(t,"tex"),n.setUniform1f("scale",i),n.setUniform2f("offset",r[0],r[1]),n.setUniform1f("opacity",s),this._drawQuad(n)}hasNearestInterpolation(e){const t=e.sourceLayerInfo.data;return!!t.source&&"nearest"===t.interpolation}_drawImageryTileData(e,t=1){const i=e.sourceLayerInfo.data;if(!i.source)return;e.tile.surface.layerViewByIndex(e.layerIndex,1).ensureSymbolizerParameters(i);const r=this._getRasterColorizerTechnique(i),s=this._rctx,a=r.program;if(s.setPipelineState(r.pipeline),s.useProgram(a),!i.bind(s))return;i.opacity=t,i.scale=e.scale,i.offset=e.offset;const{names:n,textures:o}=i.getTextures();n.forEach(((e,t)=>a.bindTexture(o[t],e))),r.bindPass(i.getUniforms()),this._drawQuad(a),s.bindVAO()}_getRasterColorizerTechnique(e){const t=e.symbolizerParameters,i=["stretch","lut","hillshade"].indexOf(t.type);return this._rasterColorizerConfig||(this._rasterColorizerConfig=new rb,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.colorizerType=i,this._rasterColorizerConfig.applyColormap=!!t.colormap,this._rasterColorizerConfig.stretchType=e.hasStretchTypeNone()?0:1,this._rasterColorizerTechnique=this._techniqueRep.releaseAndAcquire(ib,this._rasterColorizerConfig,this._rasterColorizerTechnique),this._rasterColorizerTechnique}_drawVectorData(e,t,i,r,s,a,n){const o=this._rctx,l=t.sourceLayerInfo.data,h=t.tile.surface.layerViewByIndex(t.layerIndex,1);let c;return o.setPipelineState(e.pipeline),r<1?(c=this._fboPool.acquire(s),o.bindFramebuffer(c),o.setClearColor(1,1,1,0),o.clearSafe(16640)):n&&o.clearSafe(256),this._vectorTileHelper.render(o,t.sourceLod,l,h.painter,h.layer.styleRepository,h.schemaHelper,Math.round(1/t.scale),t.offset,this.tileSize,i),!C(c)||(o.bindFramebuffer(a),this._drawRasterData(e,c.colorTexture,1,[0,0],r),this._fboPool.release(c),n)}_dataToTexture(e){return Zl(e)&&this._rasterDataToTexture(e),Yl(e)}_rasterDataToTexture(e){const t=e.sourceLayerInfo;t.data=this._buildTexture(t.data),e.tile.setMemoryDirty()}setBackground(e,t){S(this._backgroundTexture),this._backgroundIsGrid=t,e instanceof HTMLImageElement?(this._backgroundTexture=this._buildTexture(e),this._backgroundColor=null):(this._backgroundTexture=new Tw(Os(this._rctx,or(e[0]||0,e[1]||0,e[2]||0,1))),this._backgroundColor=ge(e[0]||0,e[1]||0,e[2]||0))}_buildTexture(e,t=9987){if(M(e))return null;const i={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:t,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0},r=this._rctx;let s;if("number"==typeof e)i.width=i.height=e,s=new Tw(new Pn(r,i));else if(e instanceof Nl)i.isOpaque=e.isOpaque,s=new Tw(new Pn(r,i,e.image)),e.release();else try{s=new Tw(new Pn(r,i,e))}catch(e){s=new Tw(Fs(r)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const a=r.bindTexture(s.texture,Pn.TEXTURE_UNIT_FOR_UPDATES);return s.generateMipmap(),r.bindTexture(a,Pn.TEXTURE_UNIT_FOR_UPDATES),s}_cleanupFBOPool(e,t){e===this._lastPixelRatio&&t===this._lastNumLayers||(this._fboPool.clear(),this._lastPixelRatio=e,this._lastNumLayers=t)}get test(){return{backgroundTexture:this._backgroundTexture}}}function ob(e,t,i){i.layerIndex=t;const r=e.layerInfo[1][t];if(r.data)return Ir(i.offset,0,0),i.tile=e,i.scale=1,i.sourceLod=e.lij,i.sourceLayerInfo=r,i;const s=r.upsampleInfo;if(s){const e=s.tile.layerInfo[1][t];return i.tile=s.tile,Er(i.offset,s.offset),i.scale=s.scale,i.sourceLod=s.tile.lij,i.sourceLayerInfo=e,i}return null}const lb=new Array,hb={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0},cb={offset:[0,0],scale:1},db=1e-6;class ub{constructor(e,t,i,r,s){this.aabb=e,this.axis=t,this.d=i,this.midStartIndex=r,this.rightStartIndex=s}}class pb{constructor(e,t,i,r){this.globalTriangleVertexIndices=e,this.firstTriangleIndex=t,this.positionAttribute=r,this.bspNodeTree=new Array,this.vertexPositionBuffer=r.data,this.vertexPositionStride=r.stride;const s=i-t,a=s<=vb?new Uint16Array(s):new Uint32Array(s);this.indices=a;for(let e=0;e<s;++e)a[e]=e;{const n=function(e,t,i,r,s){const a=i-t,n=new Float32Array(6*a);for(let i=0;i<a;++i){const a=3*(i+t),o=e[a+0]*s,l=e[a+1]*s,h=e[a+2]*s;for(let e=0;e<3;++e){const t=r[o+e],s=r[l+e],a=r[h+e];n[6*i+e]=Math.min(t,s,a),n[6*i+3+e]=Math.max(t,s,a)}}return n}(e,t,i,r.data,r.stride),o=(e,t,i)=>{const r=function(e,t,i,r){if(r<=i)return sl(NaN,NaN,NaN,NaN,NaN,NaN);{const r=6*e[i];for(let e=0;e<3;++e)gb[e]=t[r+0+e],fb[e]=t[r+3+e]}for(let s=i+1;s<r;++s){const i=6*e[s];for(let e=0;e<3;++e)gb[e]=Math.min(gb[e],t[i+0+e]),fb[e]=Math.max(fb[e],t[i+3+e])}return sl(gb[0],gb[1],gb[2],fb[0],fb[1],fb[2])}(a,n,e,t),s=t-e;if(s<=20){const i=new ub(r,void 0,0,e,t);return this.bspNodeTree.push(i),i}const{axis:l,midValue:h}=function(e){const t=e[3]-e[0],i=e[4]-e[1],r=e[5]-e[2],s=t>i?t>r?0:i>r?1:2:i>r?1:r>t?2:0;return{axis:s,midValue:(e[s]+e[s+3])/2}}(r),c=function(e,t,i,r,s,a){let n=i,o=r;for(;n<o;){const i=e[n];t[6*i+s+3]<=a?++n:(--o,e[n]=e[o],e[o]=i)}let l=n;o=r;for(;l<o;){const i=e[o-1];t[6*i+s]>=a?--o:(e[o-1]=e[l],e[l]=i,++l)}return{next:n,mid:l}}(a,n,e,t,l,h),d=(e,t)=>{if(i>15)return;const r=t-e;return r<20||r>=.8*s?void 0:o(e,t,i+1)},u=new ub(r,l,h,c.next,c.mid);return this.bspNodeTree.push(u),u.leftNode=d(e,c.next),u.rightNode=d(c.mid,t),u};o(0,s,0),this.triangleVertexIndices=function(e,t,i,r){const s=r-i;let a=0;for(let e=i;e<r;++e)for(let i=0;i<3;++i)a=Math.max(t[3*e+i],a);const n=a<=vb?new Uint16Array(3*s):new Uint32Array(3*s);for(let r=0;r<s;++r){const s=3*(e[r]+i);for(let e=0;e<3;++e){const i=t[s+e];n[3*r+e]=i}}return n}(a,e,t,i)}}intersectRayTriangleRange(e,t){{if(e>=t)return;const i=this.triangleVertexIndices,r=this.positionAttribute.data,s=this.positionAttribute.stride,a=this.rayOrigin,n=a[0],o=a[1],l=a[2],h=this.rayDirection,c=h[0],d=h[1],u=h[2];for(let a=e,h=3*e;a<t;++a){const e=i[h]*s,t=r[e],p=r[e+1],m=r[e+2],g=i[h+1]*s,f=r[g],v=r[g+1],_=r[g+2],y=i[h+2]*s,x=r[y],w=r[y+1],b=r[y+2];h+=3;const C=f-t,T=v-p,S=_-m,P=x-t,R=w-p,M=b-m,D=d*M-R*u,A=u*P-M*c,O=c*R-P*d,F=C*D+T*A+S*O;if(Math.abs(F)<=Number.EPSILON)continue;const I=n-t,z=o-p,E=l-m,L=I*D+z*A+E*O;if(F>0){if(L<0||L>F)continue}else if(L>0||L<F)continue;const V=z*S-T*E,k=E*C-S*I,j=I*T-C*z,U=c*V+d*k+u*j;if(F>0){if(U<0||L+U>F)continue}else if(U>0||L+U<F)continue;const q=(P*V+R*k+M*j)/F;if(q>=0){const e=this.indices[a]+this.firstTriangleIndex,t=Ds(C,T,S,P,R,M,mb);this.callback(q,t,e)}}}pb.numFacesTested+=t-e}intersectRay(e,t){pb.numFacesTested=0;const i=ge(e.r0[0],e.r0[1],e.r0[2]),r=function(e,t){const i=fe();return Je(i,e,t),i}(ge(e.r1[0],e.r1[1],e.r1[2]),i);if(Ae(r)<db)return;this.rayOrigin=i,this.rayDirection=r;const s=this.triangleVertexIndices.length/3;this.callback=t;const a=this.bspNodeTree[0];this.intersectRayBSP(a,0,s)}intersectRayBSP(e,t,i){const r=this.rayOrigin,s=this.rayDirection;if(!function(e,t,i){const r=t,s=i;let a=0,n=1/0;for(let t=0;t<3;++t){{const i=e[t];if(r[t]<i){if(s[t]<=db)return!1;const e=(i-r[t])/s[t];a=Math.max(a,e)}else if(s[t]<=-db){const e=(i-r[t])/s[t];n=Math.min(n,e)}if(a>n)return!1}{const i=e[t+3];if(r[t]>i){if(s[t]>=-db)return!1;const e=(i-r[t])/s[t];a=Math.max(a,e)}else if(s[t]>=db){const e=(i-r[t])/s[t];n=Math.min(n,e)}if(a>n)return!1}}return!0}(e.aabb,r,s))return;const a=e.axis,n=e.d;if(r[a]<n||s[a]<0){const i=t,r=e.midStartIndex;if(i<r){const t=e.leftNode;void 0!==t?this.intersectRayBSP(t,i,r):this.intersectRayTriangleRange(i,r)}}if(this.intersectRayTriangleRange(e.midStartIndex,e.rightStartIndex),r[a]>n||s[a]>0){const t=e.rightStartIndex,r=i;if(t<r){const i=e.rightNode;void 0!==i?this.intersectRayBSP(i,t,r):this.intersectRayTriangleRange(t,r)}}}}pb.numFacesTested=0;const mb=fe(),gb=ge(1/0,1/0,1/0),fb=ge(-1/0,-1/0,-1/0);const vb=65535;function _b(e,t){e.varyings.add("tbnTangent","vec3"),e.varyings.add("tbnBiTangent","vec3"),1===t.viewingMode?e.vertex.code.add(us`void forwardVertexTangent(vec3 n) {
tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), n));
tbnBiTangent = normalize(cross(n, tbnTangent));
}`):e.vertex.code.add(us`void forwardVertexTangent(vec3 n) {
tbnTangent = vec3(1.0, 0.0, 0.0);
tbnBiTangent = normalize(cross(n, tbnTangent));
}`),e.fragment.code.add(us`mat3 getTBNMatrix(vec3 n) {
return mat3(tbnTangent, tbnBiTangent, n);
}`)}function yb(e,t){e.extensions.add("GL_OES_standard_derivatives"),3!==t.pbrMode&&4!==t.pbrMode||e.include(_a,t),e.vertex.uniforms.add("overlayTexOffset","vec4"),e.vertex.uniforms.add("overlayTexScale","vec4"),e.varyings.add("vtcOverlay","vec4"),e.vertex.code.add(us`void setOverlayVTC(in vec2 uv) {
vtcOverlay = vec4(uv, uv) * overlayTexScale + overlayTexOffset;
}`),e.fragment.uniforms.add("ovColorTex","sampler2D"),e.fragment.uniforms.add("overlayOpacity","float"),e.fragment.code.add(us`bool isValid(vec2 uv, vec2 dxdy) {
return (uv.x >= 0.0 + dxdy.x) && (uv.x <= 1.0 - dxdy.x) && (uv.y >= 0.0 + dxdy.y) && (uv.y <= 1.0 - dxdy.y);
}
vec4 getOverlayColor(sampler2D ov0Tex, vec4 texCoords) {
vec4 color0 = texture2D(ov0Tex, vec2(texCoords.x * 0.5, texCoords.y));
vec4 color1 = texture2D(ov0Tex, vec2(texCoords.z * 0.5 + 0.5, texCoords.w));
bool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));
bool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));
return mix(color1 * float(isValid1), color0, float(isValid0));
}`),e.fragment.code.add(us`vec4 getCombinedOverlayColor() {
return overlayOpacity * getOverlayColor(ovColorTex, vtcOverlay);
}`),3!==t.pbrMode&&4!==t.pbrMode||(e.include(Qr),e.fragment.code.add(us`vec4 getOverlayWaterColor(vec4 maskInput, vec4 colorInput, vec3 vposEyeDir,
float shadow, vec3 localUp, mat3 tbn, vec3 position) {
vec3 n = normalize(tbn *  (2.0 * maskInput.rgb - vec3(1.0)));
vec3 v = vposEyeDir;
vec3 final = getSeaColor(n, v, lightingMainDirection, colorInput.rgb, lightingMainIntensity, localUp, 1.0 - shadow, maskInput.w, position);
return vec4(final, colorInput.w);
}`))}function xb(e){e.vertex.code.add(us`vec3 applySkirts(inout vec2 uv, vec3 vpos, vec3 vnormal, float skirtScale) {
float skirtLength = 0.0;
if (uv.x >= 2.0) {
skirtLength = uv.y * skirtScale;
vec2 x = vec2(uv.x) - vec2(3.5, 4.5);
uv = clamp(vec2(1.5) - abs(x), vec2(0.0), vec2(1.0));
}
return vpos - vnormal * skirtLength;
}`)}function wb(e,t){e.varyings.add("vtc","vec2"),e.vertex.uniforms.add("texOffsetAndScale","vec4"),e.fragment.uniforms.add("tex","sampler2D"),e.fragment.uniforms.add("textureOpacities","vec3"),t.textureFadingEnabled&&(e.vertex.uniforms.add("nextTexOffsetAndScale","vec4"),e.varyings.add("nvtc","vec2"),e.fragment.uniforms.add("texNext","sampler2D"),e.fragment.uniforms.add("nextTexOpacities","vec3"),e.fragment.uniforms.add("fadeFactor","float")),e.vertex.code.add(us`
  void forwardTextureCoordinates(in vec2 uv) {
    vtc = uv * texOffsetAndScale.zw + texOffsetAndScale.xy;
    ${t.textureFadingEnabled?us`nvtc = uv * nextTexOffsetAndScale.zw + nextTexOffsetAndScale.xy;`:us``}
  }`),t.useGrid?(e.fragment.code.add(us`float lineFactorAtPosition(float value) {
float pos = value * 129.0;
if(pos < 0.5 || pos > 128.5) {
return 1.0;
}
pos = pos + 0.5;
float modulo = mod(pos, 16.0);
return modulo <= 2.0 ?  1.0 - abs(modulo - 1.0) : 0.0;
}
float lineFactorAtUV(vec2 uv) {
return max(lineFactorAtPosition(uv.x), lineFactorAtPosition(uv.y));
}
float lineFactor(vec2 uv) {
vec2 offset = fwidth(uv) * 0.25;
return (lineFactorAtUV(vec2(uv.x + offset.x, uv.y + offset.y)) +
lineFactorAtUV(vec2(uv.x - offset.x, uv.y + offset.y)) +
lineFactorAtUV(vec2(uv.x + offset.x, uv.y - offset.y)) +
lineFactorAtUV(vec2(uv.x - offset.x, uv.y - offset.y))) / 4.0;
}
vec4 gridColor(vec2 uv) {
float line = lineFactor(uv) * 0.1 + 0.9;
float backgroundOpacity = textureOpacities.y;
return vec4(1.0, 0.972, 0.918, 1.0) * line * backgroundOpacity;
}`),e.fragment.code.add(us`vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {
if (opacities.y <= 0.0) {
return color * opacities.z * opacities.x;
}
vec4 grid = gridColor(uv);
float alpha = opacities.z * color.a;
return mix(grid, color, alpha) * opacities.x;
}`)):t.hasBackgroundColor?(e.fragment.uniforms.add("backgroundColor","vec3"),e.fragment.code.add(us`vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {
if (opacities.y <= 0.0) {
return color * opacities.z * opacities.x;
}
float alpha = opacities.z * color.a;
float backgroundOpacity = opacities.y;
return mix(vec4(backgroundColor, 1.0) * backgroundOpacity, color, alpha) * opacities.x;
}`)):e.fragment.code.add(us`vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {
return color;
}`),t.textureFadingEnabled?e.fragment.code.add(us`vec4 getTileColor() {
vec4 color = getColor(texture2D(tex, vtc), vtc, textureOpacities);
if (fadeFactor >= 1.0) {
return color;
}
vec4 nextColor = getColor(texture2D(texNext, nvtc), nvtc, nextTexOpacities);
return mix(nextColor, color, fadeFactor);
}`):e.fragment.code.add(us`vec4 getTileColor() {
return getColor(texture2D(tex, vtc), vtc, textureOpacities);
}`)}var bb=Object.freeze({__proto__:null,build:function(e){const t=new ds;if(t.include(Kr,{name:"Terrain Shader",output:e.output}),t.include(xb),t.attributes.add("position","vec3"),t.attributes.add("uv0","vec2"),t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("origin","vec3").add("skirtScale","float"),0===e.output){t.include(Ts,{linearDepth:!1}),t.include(ya,e),t.include(wb,e);const i=0!==e.overlayMode,r=2===e.overlayMode;i&&t.include(yb,{pbrMode:3,useCustomDTRExponentForWater:!1,ssrEnabled:e.ssrEnabled,highStepCount:e.highStepCount}),r&&t.include(_b,e),t.varyings.add("vnormal","vec3"),t.varyings.add("vpos","vec3"),t.vertex.uniforms.add("viewNormal","mat4"),e.receiveShadows&&t.varyings.add("linearDepth","float"),e.tileBorders&&t.varyings.add("vuv","vec2"),e.atmosphere&&(t.vertex.uniforms.add("lightingMainDirection","vec3"),t.varyings.add("wnormal","vec3"),t.varyings.add("wlight","vec3")),e.screenSizePerspective&&(t.vertex.uniforms.add("screenSizePerspective","vec4"),t.varyings.add("screenSizeDistanceToCamera","float"),t.varyings.add("screenSizeCosAngle","float")),t.vertex.code.add(us`
      void main(void) {
        vpos = position;
        vnormal = getLocalUp(vpos, origin);

        vec2 uv = uv0;
        vpos = applySkirts(uv, vpos, vnormal, skirtScale);
        ${e.atmosphere?us`
        wnormal = normalize((viewNormal * vec4(normalize(vpos + origin), 1.0)).xyz);
        wlight = normalize((view  * vec4(lightingMainDirection, 1.0)).xyz);`:""}
        ${e.tileBorders?us`vuv = uv;`:""}
        ${e.screenSizePerspective?us`
        vec3 viewPos = (view * vec4(vpos, 1.0)).xyz;
        screenSizeDistanceToCamera = length(viewPos);
        vec3 viewSpaceNormal = (viewNormal * vec4(normalize(vpos + origin), 1.0)).xyz;
        screenSizeCosAngle = abs(viewSpaceNormal.z);`:""}
        gl_Position = transformPosition(proj, view, vpos);
        ${e.receiveShadows?us`linearDepth = gl_Position.w;`:""}
        forwardTextureCoordinates(uv);
        ${i?us`setOverlayVTC(uv);`:""}
        ${r?us`forwardVertexTangent(vnormal);`:us``}
      }
    `),t.extensions.add("GL_OES_standard_derivatives"),t.extensions.add("GL_EXT_shader_texture_lod"),t.include(Is,e),t.include(Jr,e),t.fragment.uniforms.add("camPos","vec3").add("viewDirection","vec3").add("ssaoTex","sampler2D").add("viewportPixelSz","vec4"),e.screenSizePerspective&&t.fragment.uniforms.add("screenSizePerspective","vec4"),r&&(t.fragment.uniforms.add("ovWaterTex","sampler2D"),t.fragment.uniforms.add("view","mat4")),t.fragment.code.add(us`const float sliceOpacity = 0.2;
float lum(vec3 c) {
return (min(min(c.r, c.g), c.b) + max(max(c.r, c.g), c.b)) * 0.5;
}`),t.fragment.code.add(us`
      void main() {
        ${e.receiveShadows?us`float shadow = readShadowMap(vpos, linearDepth);`:us`float shadow = 0.0;`}
        float vndl = dot(normalize(vnormal), lightingMainDirection);

        float ssao = viewportPixelSz.w < .0 ? 1.0 : texture2D(ssaoTex, (gl_FragCoord.xy - viewportPixelSz.xy) * viewportPixelSz.zw).a;
        vec4 tileColor = getTileColor();
        ${i?us`
            vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
            vec4 overlayColor = overlayOpacity * overlayColorOpaque;
            vec4 groundColor = tileColor;
            tileColor = tileColor * (1.0 - overlayColor.a) + overlayColor;`:""}
        if (rejectBySlice(vpos)) {
          tileColor *= sliceOpacity;
        }
        ${e.atmosphere?us`
            float ndotl = clamp(vndl, 0.0, 1.0);
            vec3 atm = vec3(max(0.0, dot(wlight, wnormal)) + clamp(1.0 - dot(-viewDirection, wnormal), 0.0, 1.0));
            atm *= clamp(1.0 - lum(tileColor.rgb) * 1.5, 0.0, 1.0); //avoid atmosphere on bright base maps
            atm *= clamp(ndotl * 2.0, 0.0, 1.0); // avoid atmosphere on dark side of the globe
            atm *= tileColor.a; // premultiply with tile alpha`:""}

        vec3 albedo = ${e.atmosphere?us`atm + tileColor.rgb;`:us`tileColor.rgb;`}
        vec3 normal = normalize(vnormal);

        // heuristic shading function used in the old terrain, now used to add ambient lighting
        float additionalAmbientScale = smoothstep(0.0, 1.0, clamp(vndl * 2.5, 0.0, 1.0));
        vec3 additionalLight = ssao * lightingMainIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;

        gl_FragColor = vec4(evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight), tileColor.a);
        ${r?us`
            vec4 overlayWaterMask = getOverlayColor(ovWaterTex, vtcOverlay);
            float waterNormalLength = length(overlayWaterMask);
            if (waterNormalLength > 0.95) {
              mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, vnormal);
              vec4 waterOverlayColor = vec4(overlayColor.w > 0.0 ? overlayColorOpaque.xyz/overlayColor.w : vec3(1.0), overlayColor.w);
              vec4 viewPosition = view*vec4(vpos, 1.0);
              vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vpos - camPos), shadow, vnormal, tbnMatrix, viewPosition.xyz);
              vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
              // un-gamma the ground color to mix in linear space
              gl_FragColor = mix(groundColor, waterColorNonLinear, waterColorLinear.w);
            }`:""}
        ${e.screenSizePerspective?us`
          float perspectiveScale = screenSizePerspectiveScaleFloat(1.0, screenSizeCosAngle, screenSizeDistanceToCamera, screenSizePerspective);
          if (perspectiveScale <= 0.25) {
            gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 0.0, 1.0), perspectiveScale * 4.0);
          }
          else if (perspectiveScale <= 0.5) {
            gl_FragColor = mix(gl_FragColor, vec4(0.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.25) * 4.0);
          }
          else if (perspectiveScale >= 0.99) {
            gl_FragColor = mix(gl_FragColor, vec4(0.0, 1.0, 0.0, 1.0), 0.2);
          }
          else {
            gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.5) * 2.0);
          }`:""}
        ${e.tileBorders?us`
            vec2 dVuv = fwidth(vuv);
            vec2 edgeFactors = smoothstep(vec2(0.0), 1.5 * dVuv, min(vuv, 1.0 - vuv));
            float edgeFactor = 1.0 - min(edgeFactors.x, edgeFactors.y);
            gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 0.0, 1.0), edgeFactor);`:""}
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
      }
    `)}return 1!==e.output&&3!==e.output||(t.include(Ts,{linearDepth:!0}),t.include(zs,{output:e.output}),t.include(ya,e),t.varyings.add("linearDepth","float"),t.vertex.uniforms.add("nearFar","vec2"),t.vertex.code.add(us`void main(void) {
vec3 normal = getLocalUp(position, origin);
vec2 uv = uv0;
vec3 vpos = applySkirts(uv, position, normal.xyz, skirtScale);
gl_Position = transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);
}`),t.fragment.code.add(us`void main() {
outputDepth(linearDepth);
}`)),2===e.output&&(t.include(Ts,{linearDepth:!1}),t.include(ya,e),t.varyings.add("vnormal","vec3"),t.varyings.add("vpos","vec3"),t.vertex.uniforms.add("viewNormal","mat4"),t.vertex.code.add(us`void main(void) {
vec3 normal = getLocalUp(position, origin);
vec2 uv = uv0;
vpos = applySkirts(uv, position, normal, skirtScale);
gl_Position = transformPosition(proj, view, vpos);
vnormal = normalize((viewNormal * vec4(normal, 1.0)).xyz);
}`),t.fragment.code.add(us`void main() {
vec3 normal = normalize(vnormal);
if (gl_FrontFacing == false) {
normal = -normal;
}
gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 0.0);
}`)),4===e.output&&(t.include(Ts,{linearDepth:!1}),t.include(ya,e),t.include(yb,{pbrMode:0}),t.vertex.code.add(us`void main() {
vec3 vnormal = getLocalUp(position, origin);
vec2 uv = uv0;
vec3 vpos = applySkirts(uv, position, vnormal, skirtScale);
setOverlayVTC(uv);
gl_Position = transformPosition(proj, view, vpos);
}`),t.include(Es),t.fragment.code.add(us`void main() {
vec4 overlayColor = getCombinedOverlayColor();
if (overlayColor.a == 0.0) {
gl_FragColor = vec4(0.0);
return;
}
outputHighlight();
}`)),t}});class Cb extends vs{initializeProgram(e){const t=Cb.shader.get(),i=this.configuration,r=t.build({overlayMode:i.overlayMode,output:i.output,viewingMode:e.viewingMode,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,textureFadingEnabled:i.textureFadingEnabled&&!i.renderOccluded,hasBackgroundColor:i.hasBackgroundColor,useGrid:i.useGrid,receiveShadows:i.receiveShadows&&!i.renderOccluded,receiveAmbientOcclusion:!1,atmosphere:i.atmosphere,tileBorders:i.tileBorders,screenSizePerspective:i.screenSizePerspective,pbrMode:0,ssrEnabled:i.ssrEnabled,highStepCount:!1});return new _s(e.rctx,r,ys)}initializePipeline(){const e=this.configuration,t=e.backfaceCullingEnabled&&!e.renderOccluded;return Ea({blending:e.renderOccluded?ka(1,771):null,culling:t&&ja,depthTest:!e.renderOccluded&&{func:513},depthWrite:!e.renderOccluded&&Na,colorWrite:Va,stencilTest:e.stencilEnabled?Ls(1):null})}}Cb.shader=new gs(bb,(()=>Promise.resolve().then((function(){return bb}))));class Tb extends fs{constructor(){super(...arguments),this.output=0,this.overlayMode=0,this.atmosphere=!1,this.receiveShadows=!1,this.slicePlaneEnabled=!1,this.backfaceCullingEnabled=!1,this.stencilEnabled=!1,this.textureFadingEnabled=!1,this.hasBackgroundColor=!1,this.useGrid=!1,this.renderOccluded=!1,this.ssrEnabled=!1,this.tileBorders=!1,this.screenSizePerspective=!1}}e([ms({count:8})],Tb.prototype,"output",void 0),e([ms({count:3})],Tb.prototype,"overlayMode",void 0),e([ms()],Tb.prototype,"atmosphere",void 0),e([ms()],Tb.prototype,"receiveShadows",void 0),e([ms()],Tb.prototype,"slicePlaneEnabled",void 0),e([ms()],Tb.prototype,"backfaceCullingEnabled",void 0),e([ms()],Tb.prototype,"stencilEnabled",void 0),e([ms()],Tb.prototype,"textureFadingEnabled",void 0),e([ms()],Tb.prototype,"hasBackgroundColor",void 0),e([ms()],Tb.prototype,"useGrid",void 0),e([ms()],Tb.prototype,"renderOccluded",void 0),e([ms()],Tb.prototype,"ssrEnabled",void 0),e([ms()],Tb.prototype,"tileBorders",void 0),e([ms()],Tb.prototype,"screenSizePerspective",void 0);const Sb=$o(),Pb=nr();let Rb=class extends yi{constructor(e){super(e),this.type="Terrain",this.isGround=!0,this.tileSize=256,this.rctx=null,this._isTransparent=!1,this._scaleRangeQueries=new Ww,this.renderDataPool=new cl(Nw),this._patchGroups=new N({allocator:e=>e||{root:null,origin:null,patches:new N},deallocator:e=>(e.root=null,e.origin=null,e.patches.clear(),e)}),this.patchGroupsDirty=!0,this.patchGroupsMap=new Map,this.tileIterator=new Uh,this.highestVisibleLODTile=null,this.visible=!0,this._opaque=!0,this._skirtScale=1,this._velvetOverground=!0,this.castShadows=!0,this._ssrEnabled=!1,this.emptyTex=null,this.tileRenderer=null,this.tileBackgroundInitialized=!1,this.tileBackgroundUpdating=!1,this.stencilEnabledLayerExtents=[],this.numTrianglesRendered=0,this.numTilesRendered=0,this.numTilesCulled=0,this.numOriginsRendered=0,this.overlayOpacity=1,this.needsHighlight=!1,this.renderOccludedFlags=1}get isGlobal(){return 1===this.stage.viewingMode}initialize(){this.stage.addRenderPlugin([2,7,9],this)}destroy(){this.stage.removeRenderPlugin(this),ew.clear(),rw.clear()}get updating(){return!this.tileBackgroundInitialized||this.tileBackgroundUpdating}get canRender(){return this.visible&&!!this._rootTiles&&this.tileBackgroundInitialized&&!this.renderingDisabled}set renderingDisabled(e){this._set("renderingDisabled",!!e),this.setNeedsRender()}set opaque(e){this._opaque!==e&&(this._opaque=e,this.setNeedsRender())}get needsLinearDepth(){return this.overlayRenderer.hasWater}get opaque(){return this._opaque&&!this.shaderTechniqueConfig.slicePlaneEnabled}set isTransparent(e){this._isTransparent!==e&&(this._isTransparent=e,this.setNeedsRender())}get isTransparent(){return this._isTransparent}set skirtScale(e){e!==this._skirtScale&&(this._skirtScale=e,this.setNeedsRender())}get skirtScale(){return this._skirtScale}get renderPatchBorders(){return!!this.shaderTechniqueConfig.tileBorders}set renderPatchBorders(e){this.shaderTechniqueConfig.tileBorders!==e&&(this.shaderTechniqueConfig.tileBorders=e,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get cullBackFaces(){return this.shaderTechniqueConfig.backfaceCullingEnabled}set cullBackFaces(e){this.shaderTechniqueConfig.backfaceCullingEnabled!==e&&(this.shaderTechniqueConfig.backfaceCullingEnabled=e,this.notifyChange("cullBackFaces"),this.setNeedsRender())}set renderOrder(e){this._set("renderOrder",e),this.setNeedsRender()}set velvetOverground(e){this._velvetOverground!==e&&(this._velvetOverground=e,this.setNeedsRender())}get intersectionHandlerId(){return uh}get slicePlane(){return this.shaderTechniqueConfig.slicePlaneEnabled}set slicePlane(e){this.shaderTechniqueConfig.slicePlaneEnabled!==e&&(this.shaderTechniqueConfig.slicePlaneEnabled=e,this.setNeedsRender())}set textureFadingEnabled(e){this.shaderTechniqueConfig.textureFadingEnabled!==e&&(this.shaderTechniqueConfig.textureFadingEnabled=e,this.setNeedsRender())}setDebugScreenSizePerspective(e){this.shaderTechniqueConfig.screenSizePerspective!==e&&(this.shaderTechniqueConfig.screenSizePerspective=e,this.setNeedsRender())}setRootTiles(e){this._rootTiles=e,this.setNeedsRender()}setNeedsHighlight(e){this.needsHighlight=e,this.setNeedsRender()}setRenderOccludedOverlay(e){this.renderOccludedFlags=e?xa:1,this.setNeedsRender()}setStencilEnabledLayerExtents(e){this.stencilEnabledLayerExtents=e,this.setNeedsRender()}setTileSize(e){this.tileSize=e,this.tileRenderer&&(this.tileRenderer.tileSize=e),this.setNeedsRender()}loadTile(e){e.renderData||(e.renderData=this.renderDataPool.acquire(),e.renderData.init(e),e.renderData.localOrigin=this._getLocalOriginOfTile(e)),this.updateTileGeometry(e),this.updateTileTexture(e,128)}queryVisibleLevelRange(e,t,i,r){this._scaleRangeQueries.queryVisibleLevelRange(e,t,i,r),this.setNeedsRender()}updateTileTexture(e,t){this.tileRenderer&&this.tileBackgroundInitialized&&(this.tileRenderer.updateTileTexture(e,128===t?0:2),this.setNeedsRender(),e.resetPendingUpdate(t))}updateTileGeometry(e){for(const t of e.layerInfo[0])t.pendingUpdates&=-33;e.resetPendingUpdate(32),e.renderData.updateGeometry(this.rctx,this.wireframe)&&this.setNeedsRender()}unloadTile(e){e.renderData&&(e.renderData.releaseGeometry()&&this.setNeedsRender(),this.renderDataPool.release(e.renderData),e.renderData.clear(),e.renderData=null,e.setMemoryDirty(),this.setNeedsRender())}_getLocalOriginOfTile(e){const t=Math.max(0,7*Math.floor((e.lij[0]-3)/7));if(this.isGlobal&&0===t)return qe;for(;e.parent&&e.lij[0]>t;)e=e.parent;return e.centerAtSeaLevel}setVisibility(e){this.visible=e,this.setNeedsRender()}getStats(){return{numTilesRendered:this.numTilesRendered,numTilesCulled:this.numTilesCulled,numTrianglesRendered:this.numTrianglesRendered,numOriginsRendered:this.numOriginsRendered}}set wireframe(e){this._get("wireframe")!==e&&(this._set("wireframe",e),this.allTiles.forAll((t=>{var i;return null==(i=t.renderData)?void 0:i.updateGeometry(this.rctx,e)})),this.setNeedsRender())}setNeedsRender(e=1){this.patchGroupsDirty=!0,this.context.requestRender(e)}setTileBackground(e){this.tileBackground=e,this._updateTileBackground()}initializeRenderContext(e){this.context=e,this.rctx=e.renderContext.rctx,this.shaderTechniques=e.shaderTechniqueRep,this.shaderTechniqueConfig=new Tb,this.tileRenderer=new nb(this.rctx,this.tileSize,this.shaderTechniques),this.tileBackground&&this._updateTileBackground(),this.emptyTex=Fs(this.rctx)}uninitializeRenderContext(){null!=this.emptyTex&&(this.emptyTex.dispose(),this.emptyTex=null),this.tileRenderer&&(this.tileRenderer.dispose(),this.tileRenderer=null)}intersect(e,t,i,r){if(!this._rootTiles||e.options.selectOpaqueTerrainOnly&&e.options.selectionMode&&!this._opaque)return;const s=Fb,a=Ib;Te(s,r,i),ve(a,1/s[0],1/s[1],1/s[2]);const n=e.results.min,o=e.results.max,l=e.results.ground,h=0===e.options.store,c=!!e.results.ground.target;let d;const u=ph(e.verticalOffset),p=this._skirtScale,m=e.tolerance,g=e=>{const t=h&&null!=n.dist?n.dist:1/0;return C(u)||e.intersectsRay(i,s,m,t,p)},f=c=>{const g=c.renderData.geometryInfo;al(Sb,g.boundingBox);const f=c.renderData.localOrigin;C(u)&&(u.localOrigin=f,u.applyToAabb(Sb));const v=-p*g.skirtLength;if(0!==v){const e=c.up;nl(Sb,v*e[0],v*e[1],v*e[2])}const _=Sb;Te(zb,i,f);const y=h&&null!=n.dist?n.dist:1/0;if(!As(_,zb,a,m,y))return;const x=(e,t,i,r)=>{e.set(void 0,jh(t),i,r,Fr,void 0),e.intersector=Lb,e.target={type:"external",metadata:{tile:t}}},w=(a,h)=>{if(a>=0&&(e.options.backfacesTerrain||Ie(h,s)<0)&&(e.options.invisibleTerrain||!e.options.selectionMode||null==t||t(i,r,a))){if((null==l.dist||a<l.dist)&&x(l,c,a,h),e.options.isFiltered)return;2===e.options.store&&(M(d)?(d=new mo(e.ray),x(d,c,a,h),e.results.all.push(d)):a<d.dist&&x(d,c,a,h)),(null==n.dist||a<n.dist)&&x(n,c,a,h),0!==e.options.store&&(null==o.dist||a>o.dist)&&x(o,c,a,h)}},b=Eb;Te(b,r,f);const T=g.indices,S=g.vertexAttributes,P={data:S.getField("position",ic).typedBuffer,size:3,stride:S.stride/4},R=g.numWithoutSkirtIndices/3;if(!C(u)&&R>40){const e=c.renderData;C(e.intersectionData)||(e.intersectionData=new pb(T,0,R,P)),e.intersectionData.intersectRay({r0:zb,r1:b},w)}else js(zb,b,0,R,T,P,null,u,w);if(0!==v){const e=T.length/3;this.isGlobal?function(e,t,i,r,s,a,n,o,l,h){const c=a.position,d=a.uv0,u=e[0],p=e[1],m=e[2],g=t[0]-u,f=t[1]-p,v=t[2]-m;r*=3;for(let e=i*=3;e<r;e+=3){const t=s[e],i=s[e+1],r=s[e+2];let a=c.get(t,0),_=c.get(t,1),y=c.get(t,2),x=c.get(i,0),w=c.get(i,1),b=c.get(i,2),T=c.get(r,0),S=c.get(r,1),P=c.get(r,2);if(d.get(t,0)>=2){const e=a+o[0],t=_+o[1],i=y+o[2],r=n/Math.sqrt(e*e+t*t+i*i);a+=e*r,_+=t*r,y+=i*r}if(d.get(i,0)>=2){const e=x+o[0],t=w+o[1],i=b+o[2],r=n/Math.sqrt(e*e+t*t+i*i);x+=e*r,w+=t*r,b+=i*r}if(d.get(r,0)>=2){const e=T+o[0],t=S+o[1],i=P+o[2],r=n/Math.sqrt(e*e+t*t+i*i);T+=e*r,S+=t*r,P+=i*r}C(l)&&([a,_,y]=l.applyToVertex(a,_,y),[x,w,b]=l.applyToVertex(x,w,b),[T,S,P]=l.applyToVertex(T,S,P));const R=x-a,M=w-_,D=b-y,A=T-a,O=S-_,F=P-y,I=f*F-O*v,z=v*A-F*g,E=g*O-A*f,L=R*I+M*z+D*E;if(Math.abs(L)<=Number.EPSILON)continue;const V=u-a,k=p-_,j=m-y,U=V*I+k*z+j*E;if(L>0){if(U<0||U>L)continue}else if(U>0||U<L)continue;const q=k*D-M*j,H=j*R-D*V,B=V*M-R*k,N=g*q+f*H+v*B;if(L>0){if(N<0||U+N>L)continue}else if(N>0||U+N<L)continue;const G=(A*q+O*H+F*B)/L;G>=0&&h(G,Ds(R,M,D,A,O,F,pw))}}(zb,b,R,e,T,S,v,f,u,w):function(e,t,i,r,s,a,n,o,l){const h=a.position,c=a.uv0,d=e[0],u=e[1],p=e[2],m=t[0]-d,g=t[1]-u,f=t[2]-p;r*=3;for(let e=i*=3;e<r;e+=3){const t=s[e],i=s[e+1],r=s[e+2];let a=h.get(t,0),v=h.get(t,1),_=h.get(t,2),y=h.get(i,0),x=h.get(i,1),w=h.get(i,2),b=h.get(r,0),T=h.get(r,1),S=h.get(r,2);c.get(t,0)>=2&&(_+=n),c.get(i,0)>=2&&(w+=n),c.get(r,0)>=2&&(S+=n),C(o)&&([a,v,_]=o.applyToVertex(a,v,_),[y,x,w]=o.applyToVertex(y,x,w),[b,T,S]=o.applyToVertex(b,T,S));const P=y-a,R=x-v,M=w-_,D=b-a,A=T-v,O=S-_,F=g*O-A*f,I=f*D-O*m,z=m*A-D*g,E=P*F+R*I+M*z;if(Math.abs(E)<=Number.EPSILON)continue;const L=d-a,V=u-v,k=p-_,j=L*F+V*I+k*z;if(E>0){if(j<0||j>E)continue}else if(j>0||j<E)continue;const U=V*M-R*k,q=k*P-M*L,H=L*R-P*V,B=m*U+g*q+f*H;if(E>0){if(B<0||j+B>E)continue}else if(B>0||j+B<E)continue;const N=(D*U+A*q+O*H)/E;N>=0&&l(N,Ds(P,R,M,D,A,O,pw))}}(zb,b,R,e,T,S,v,u,w)}},v=this._rootTiles;if(C(v)){(()=>{const t=this.tileIterator;for(const i of v)for(t.resetOne(i);!t.done;){const i=t.next();(i.visible||e.options.invisibleTerrain&&i.intersectsClippingArea)&&g(i)?null==i.renderData||c&&this._useStencilForTile(i)||f(i):t.skipSubtree()}})()}}render(e){if(9===e.slot){if(0==(e.renderOccludedMask&xa))return!1}else{const t=this.opaque?2:7;if(e.slot!==t)return!1}const t=e.pass,i=1===e.scenelightingData.globalFactor,r=this._updatePatchGroups();switch(t){case 0:{const t=e.shadowMap&&e.shadowMap.enabled;this.shaderTechniqueConfig.receiveShadows!==t&&(this.shaderTechniqueConfig.receiveShadows=t);const i=this.overlayRenderer.isEmpty()?0:this.overlayRenderer.hasWater?2:1;this.shaderTechniqueConfig.overlayMode!==i&&(this.shaderTechniqueConfig.overlayMode=i);const s=9===e.slot?3:1;this._renderMaterialPass(e,0,r,s);break}case 4:case 6:this.castShadows&&i&&this._renderAuxiliaryPass(e,3,r,0);break;case 2:this.isTransparent&&this.overlayRenderer.isEmpty()||this._renderAuxiliaryPass(e,1,r,0);break;case 3:this._renderAuxiliaryPass(e,2,r,0);break;case 5:this.needsHighlight&&(this._renderAuxiliaryPass(e,4,r,2),e.rctx.clearSafe(256))}return this._scaleRangeQueries.hasPendingQueries()&&this.setNeedsRender(),!0}_renderMaterialPass(e,t,i,r){const{rctx:s,camera:a}=e;this._ssrEnabled=e.ssrParams.ssrEnabled,this._setTerrainTechnique(t,3===r);const n=this.shaderTechnique.program;s.useProgram(n),0!==this.shaderTechniqueConfig.overlayMode&&1===r&&e.ssrParams&&wa(n,e.ssrParams),e.shadowMap.bind(n),e.ssaoHelper.bind(n,e.camera),this._bindOverlayData(n,r),n.setUniformMatrix4fv("viewNormal",a.viewInverseTransposeMatrix),Ss(n,a.projectionMatrix),e.scenelightingData.setUniforms(n,!0);const o=a.viewMatrix;ve(Ob,o[12],o[13],o[14]),we(Ob,Ob),n.setUniform3fv("viewDirection",Ob),this.numTilesRendered=0,this.numTilesCulled=0,this.numTrianglesRendered=0,this.numOriginsRendered=0,this._scaleRangeQueries.prepareQueries(),this.opaque?this._renderPatchGroups(e,n,i,r):e.offscreenRenderingHelper.renderToTargets((()=>this._renderPatchGroups(e,n,i,r)),e.offscreenRenderingHelper.tmpColor,e.offscreenRenderingHelper.mainDepth,[0,0,0,0]),this._scaleRangeQueries.processQueries()}_renderAuxiliaryPass(e,t,i,r){this._setTerrainTechnique(t,3===r);const s=e.rctx,a=this.shaderTechnique.program;if(s.useProgram(a),5===e.pass){const t=e.offscreenRenderingHelper;a.bindTexture(t.depthTexture,"depthTex"),a.setUniform4f("highlightViewportPixelSz",0,0,1/t.width,1/t.height)}else a.setUniformMatrix4fv("viewNormal",e.camera.viewInverseTransposeMatrix),2!==e.pass&&4!==e.pass&&6!==e.pass||a.setUniform2fv("nearFar",e.camera.nearFar);this._renderPatchGroupsAuxiliary(e,a,i,r)}_updateTileBackground(){if(!this.tileRenderer)return;this.tileBackgroundUpdating=!0;const e=()=>{this.tileBackgroundInitialized=!0,this.tileBackgroundUpdating=!1,this.shaderTechniqueConfig.useGrid=this.tileRenderer.backgroundIsGrid,this.shaderTechniqueConfig.hasBackgroundColor=!this.tileRenderer.backgroundIsGrid&&!!C(this.tileRenderer.backgroundColor),this.allTiles.forAll((e=>this.tileRenderer.updateTileTexture(e,0))),this.setNeedsRender()};if("string"==typeof this.tileBackground){const t=this.tileBackground;Rn(t).then((i=>{t===this.tileBackground&&this.tileRenderer&&(this.tileRenderer.setBackground(i,this.tileBackground===Oh),e())}))}else{const t=this.tileBackground?sr.toUnitRGBA(this.tileBackground):[0,0,0,0];this.tileRenderer.setBackground(t,!1),e()}}_updatePatchGroups(){const e=this._patchGroups;if(!this.patchGroupsDirty)return e;if(this.highestVisibleLODTile=null,this._renderCollectOrigins(e),0!==this.renderOrder){for(let t=0;t<e.length;t++)qh(this.renderOrder,e.data[t].patches);e.sort(((e,t)=>function(e,t,i){if(0===e.patches.length)return-i;if(0===t.patches.length)return i;return Hh(e.patches.data[0],t.patches.data[0],i)}(e,t,this.renderOrder)))}return this.patchGroupsDirty=!1,e}_renderCollectOrigins(e){const t=this._rootTiles;if(M(t))return;const i=this.isGlobal;e.clear();for(const r of t){const t=e.pushNew();t.root=r,t.origin=i?qe:r.centerAtSeaLevel,t.patches.clear(),this._renderCollectOriginsForRoot(e,t)}e.filterInPlace((e=>e.patches.length>0))}_renderCollectOriginsForRoot(e,t){const i=this.tileIterator;i.resetOne(t.root);const r=this.patchGroupsMap;for(r.clear(),r.set(t.origin,t);!i.done;){const t=i.next(),s=t.renderData;if(!s||t.visible){if(t.lij[0]%7==0){const i=e.pushNew();i.root=t,i.origin=t.centerAtSeaLevel,r.set(t.centerAtSeaLevel,i),i.patches.clear()}if(t.rendered){if(s){const e=r.get(s.localOrigin);e&&e.patches.push(t),(!this.highestVisibleLODTile||t.vlevel>this.highestVisibleLODTile.vlevel)&&(this.highestVisibleLODTile=t),i.skipSubtree()}}else this.numTilesCulled++}else this.numTilesCulled++,i.skipSubtree()}}_useStencilForTile(e){for(const t of this.stencilEnabledLayerExtents)if(e.intersectsExtent(t))return!0;return!1}_renderPatchGroupsAuxiliary(e,t,i,r){this.shaderTechnique.bindPipelineState(e.rctx);const s=this.stencilEnabledLayerExtents.length>0;t.setUniformMatrix4fv("proj",e.camera.projectionMatrix),t.setUniform1f("skirtScale",this._skirtScale),0!==r&&this._bindOverlayData(t,r);for(let a=0;a<i.length;a++){const n=i.data[a];this._bindPatchGroupData(t,n,e.camera.eye,e.camera.viewMatrix);for(let i=0;i<n.patches.length;i++)this._renderPatch(e.rctx,t,n.patches.data[i],4,s,r)}e.rctx.bindVAO(null)}_renderPatchGroups(e,t,i,r){const s=e.rctx,a=e.camera,n=a.viewMatrix;if(this.shaderTechnique.bindPipelineState(s),this.shaderTechniqueConfig.screenSizePerspective&&this.pointsOfInterest){const e=Rs(this.stage.viewingMode,this.ellipsoidRadius),i=this.pointsOfInterest.centerOnSurfaceFrequent.distance;e.update({distance:i,fovY:a.fovY}),Vs(e,t,"screenSizePerspective")}const o=this.stencilEnabledLayerExtents.length>0,l=3===r;l&&(t.bindTexture(this.emptyTex,"tex"),t.setUniform1f("blend",1),t.setUniform4fv("texOffsetAndScale",hr));const h=C(this.tileRenderer.backgroundColor)?this.tileRenderer.backgroundColor:qe;this.shaderTechniqueConfig.hasBackgroundColor&&t.setUniform3fv("backgroundColor",h);const c=l?0:this._skirtScale;t.setUniform1f("skirtScale",c);const d=this.wireframe?1:4;this.shaderTechniqueConfig.textureFadingEnabled&&t.bindTexture(this.emptyTex,"texNext");for(let h=0;h<i.length;h++){const c=i.data[h],u=c.patches;this._bindPatchGroupData(t,c,a.eye,n);const p=e.sliceHelper&&e.sliceHelper.plane;ks(t,this.shaderTechnique.configuration,p,c.origin),e.shadowMap&&e.shadowMap.bindView(t,c.origin),this.numOriginsRendered++;for(let e=0;e<u.length;e++){const i=u.data[e],a=i.renderData.textureReference;if(M(a))continue;if(!l){this._scaleRangeQueries.scaleQueriesForTile(i),Db(i.renderData.geometryInfo.uvOffsetAndScale,a.offsetAndScale,Pb),t.setUniform4fv("texOffsetAndScale",Pb),t.bindTexture(a.texture.texture,"tex");const e=i.renderData.textureFadeFactor,r=e<1?i.renderData.nextTextureReference:null;this.shaderTechniqueConfig.textureFadingEnabled&&C(r)&&e<1?(Db(i.renderData.geometryInfo.uvOffsetAndScale,r.offsetAndScale,Pb),t.setUniform1f("fadeFactor",e),t.setUniform4fv("nextTexOffsetAndScale",Pb),t.setUniform3fv("nextTexOpacities",r.opacities),t.bindTexture(r.texture.texture,"texNext")):t.setUniform1f("fadeFactor",1),i.renderData.textureIsFading&&this.setNeedsRender(),t.setUniform3fv("textureOpacities",a.opacities)}const n=this._renderPatch(s,t,i,d,o,r);i.renderOrder=this.numTilesRendered,this.numTilesRendered++,this.numTrianglesRendered+=n/3}}s.bindVAO(null)}_renderPatch(e,t,i,r,s,a){if(M(i.renderData.vao.indexBuffer))return 0;0!==a&&this._bindOverlayPatchData(t,i.renderData.overlay),s&&(this._useStencilForTile(i)?this.stencilShaderTechnique.bindPipelineState(e):this.shaderTechnique.bindPipelineState(e));const n=0===this._skirtScale?i.renderData.geometryInfo.numWithoutSkirtIndices:i.renderData.vao.indexBuffer.size;return e.bindVAO(i.renderData.vao),t.assertCompatibleVertexAttributeLocations(i.renderData.vao),e.drawElements(r,n,i.renderData.vao.indexBuffer.indexType,0),n}_bindPatchGroupData(e,t,i,r){e.setUniform3fv("origin",t.origin),Pr(Ab,r,t.origin),e.setUniformMatrix4fv("view",Ab),e.setUniform3f("camPos",i[0]-t.origin[0],i[1]-t.origin[1],i[2]-t.origin[2])}_bindOverlayData(e,t){if(0===this.shaderTechniqueConfig.overlayMode)return;e.setUniform1f("overlayOpacity",this.overlayOpacity);const i=this.overlayRenderer.overlays;if(i.length>0){const r=i[0],s=r.getColorTexture(t);if(e.bindTexture(C(s)?s:this.emptyTex,"ovColorTex"),2===this.shaderTechniqueConfig.overlayMode){const i=r.getNormalTexture(t);e.bindTexture(C(i)?i:this.emptyTex,"ovWaterTex")}}}_bindOverlayPatchData(e,t){e.setUniform4fv("overlayTexOffset",t.offsets),e.setUniform4fv("overlayTexScale",t.scales)}_setTerrainTechnique(e,t){this.shaderTechniqueConfig.output=e,0===e&&(this.shaderTechniqueConfig.atmosphere=this.isGlobal&&this._velvetOverground,this.shaderTechniqueConfig.ssrEnabled=this._ssrEnabled),this.shaderTechniqueConfig.renderOccluded=t,this.shaderTechniqueConfig.stencilEnabled=!1,this.shaderTechnique=this.shaderTechniques.releaseAndAcquire(Cb,this.shaderTechniqueConfig,this.shaderTechnique),this.shaderTechniqueConfig.stencilEnabled=!0,this.stencilShaderTechnique=this.shaderTechniques.releaseAndAcquire(Cb,this.shaderTechniqueConfig,this.stencilShaderTechnique)}get test(){return{tileRenderer:this.tileRenderer}}};e([le()],Rb.prototype,"tileBackgroundInitialized",void 0),e([le()],Rb.prototype,"tileBackgroundUpdating",void 0),e([le({constructOnly:!0})],Rb.prototype,"overlayRenderer",void 0),e([le({constructOnly:!0})],Rb.prototype,"stage",void 0),e([le({readOnly:!0})],Rb.prototype,"isGlobal",null),e([le({constructOnly:!0})],Rb.prototype,"allTiles",void 0),e([le({constructOnly:!0})],Rb.prototype,"ellipsoidRadius",void 0),e([le({readOnly:!0})],Rb.prototype,"updating",null),e([le({value:!1})],Rb.prototype,"renderingDisabled",null),e([le()],Rb.prototype,"renderPatchBorders",null),e([le()],Rb.prototype,"cullBackFaces",null),e([le({value:1})],Rb.prototype,"renderOrder",null),e([le()],Rb.prototype,"wireframe",null),Rb=e([ce("esri.views.3d.terrain.TerrainRenderer")],Rb);var Mb=Rb;function Db(e,t,i){const r=e[0]*t[2]+t[0],s=e[1]*t[3]+t[1],a=e[2]*t[2],n=e[3]*t[3];Re(i,r,s,a,n)}const Ab=Ar(),Ob=fe(),Fb=fe(),Ib=fe(),zb=fe(),Eb=fe(),Lb="TerrainRenderer";class Vb{constructor(){this.numNodes=0,this.numLeaves=0,this.numVisible=0,this.numRendered=0,this.numSplit=0,this.numMerged=0,this.numRenderedPerLevel=new Array,this.numLoadedPerLevel=new Array}}let kb=class extends yi{constructor(e){super(e),this._handles=new ar}initialize(){this._handles.add(this.layers.on("change",(()=>this._update()))),this._handles.add(this.extentHelper.watch("layerViewsExtent",(()=>this._setAdHocTilingScheme()))),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()}destroy(){this._handles=R(this._handles),this._waitTask=null}_update(){if(this._waitTask=null,this.tilingSchemeLocked)return;let e;if(this._set("tilingSchemeDone",!1),this.layers.some((t=>!(!Jt(t)||t.isRejected())&&(!(t.isFulfilled()&&!function(e,t,i){return!!jl(e,t,i).tileInfo}(t,this.viewSpatialReference,this.viewingMode))&&(e=t,!Xl(t)&&!Ul(t))))),e)if(e.isResolved()){const t=e,{tileInfo:i}=jl(t,this.viewSpatialReference,this.viewingMode),r=new Fh(i);this._set("tilingSchemeDone",!0),this._lockTilingScheme(r)}else this._updateWhen(e);else this._set("tilingSchemeDone",!0)}_updateWhen(e){const t=e.when().catch((()=>{})).then((()=>{t!==this._waitTask||this.destroyed||this._update()}));this._waitTask=t}_lockTilingScheme(e){if(1===this.viewingMode){const t=e.levels.length-1;e.spatialReference.isWebMercator?e=Fh.makeWebMercatorAuxiliarySphere(t):ct(e.spatialReference)&&(e=Fh.makeGCSWithTileSize(e.spatialReference,e.pixelSize,t))}this.tilingSchemeLocked=!0,this.tilingScheme=e,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this._handles.removeAll(),this._handles.add(this.extentHelper.watch("tiledLayersExtent",(()=>this._updateTiledLayerExtent())))}_updateTiledLayerExtent(){this._set("extent",this.extentHelper.tiledLayersExtent)}_setAdHocTilingScheme(){if(1===this.viewingMode){const e=this.extentHelper.viewSpatialReference,t=ct(e)||ur(e)||mr(e);e.isWebMercator?this.tilingScheme=Fh.WebMercatorAuxiliarySphere:t&&(this.tilingScheme=Fh.makeGCSWithTileSize(e,256)),this._set("extent",this.extentHelper.layerViewsExtent)}else{const e=this.extentHelper.layerViewsExtent;C(e)&&!Vt(e,this.extent)&&(this.tilingScheme=Fh.fromExtent(e,this.extentHelper.viewSpatialReference),this._set("extent",e))}}get test(){return{lockTilingScheme:e=>this._lockTilingScheme(e),done:!this._waitTask}}};e([le()],kb.prototype,"tilingScheme",void 0),e([le({readOnly:!0})],kb.prototype,"extent",void 0),e([le({value:!1})],kb.prototype,"tilingSchemeLocked",void 0),e([le({readOnly:!0,value:!1})],kb.prototype,"tilingSchemeDone",void 0),e([le({constructOnly:!0})],kb.prototype,"viewSpatialReference",void 0),e([le({constructOnly:!0})],kb.prototype,"layers",void 0),e([le({constructOnly:!0})],kb.prototype,"extentHelper",void 0),e([le({constructOnly:!0})],kb.prototype,"viewingMode",void 0),kb=e([ce("esri.views.3d.terrain.TilingSchemeLogic")],kb);class jb{constructor(){this.offset=Nr(),this.scale=0,this.tile=null}init(e,t,i,r){this.tile=e,this.offset[0]=t,this.offset[1]=i,this.scale=r}dispose(){this.tile=null,this.offset[0]=0,this.offset[1]=0,this.scale=0}}const Ub=U.getLogger("esri.views.3d.terrain.TerrainSurface");let qb=class extends(tr.EventedMixin(yi)){constructor(e){super(e),this._elevationBounds=new zx,this._iteratorPool=new cl(Uh,(e=>e.remove=()=>this._iteratorPool.release(e))),this._postorderIterator=new Bh,this._hasPendingUpdates=!1,this._pendingUpdates=0,this._asyncWorkItems=0,this._allTilesDirty=!0,this._allTilesSorted=!0,this._visible=!1,this._usedMemory=Gb,this._performanceInfo=new Vb,this._viewChanged=!1,this._inFrameTask=!1,this._viewChangeUpdateDirty=!1,this._eyePosRenderSR=fe(),this._eyePosSurfaceSR=fe(),this._splitLimits=new Dw,this._snapLevel=1/0,this._frustum=dl(),this._viewProjectionMatrix=Ar(),this._layerViews=[new Array,new Array],this._layerIndexByUid=[new Map,new Map],this._basemapLayerViewHandles=new Map,this._handles=new ar,this._watchUpdatingTracking=new Bn,this._allTiles=new N,this._upsampleInfoPool=new cl(jb),this._rootTilesExtent=Ct(),this._maxNumUpdating=1,this.maxTextureScale=1.2,this.backgroundImage=Oh,this.backgroundColor=null,this._layerViewsDirty=!1}initialize(){this._lercDecoder=_h(this.view.resourceController),this._tilePool=this.view.state.isLocal?new cl(Vw):new cl(jw);const e=this.view.resourceController.memoryController;var t,i;this._upsampleMapCache=e.getMemCache("esri.views.3d.terrain.upsample",(e=>e.unloadMapData())),this._elevationQueryCache=new vh(e.getMemCache("elevation-query")),this._set("overlayManager",new Gx({surface:this})),this._handles.add([this.watch("overlayManager.hasHighlights",(e=>this._renderer.setNeedsHighlight(e))),this.watch("overlayManager.rendersOccluded",(e=>this._renderer.setRenderOccludedOverlay(e)))],"overlayManager"),this._renderer=new Mb({overlayRenderer:this.overlayManager.renderer,ellipsoidRadius:wt(this.view.spatialReference).radius,stage:this.view._stage,allTiles:this._allTiles}),this._handles.add([Y(this,"baseOpacity",(e=>{this._handleLayerViewChanges(),this._updateBaseOpacity(e)}),!0),Y(this,"_background",(()=>{this._handleLayerViewChanges(),this._renderer.setTileBackground(this._background)}),!0),this.view.watch("pointsOfInterest",(e=>{this._renderer.pointsOfInterest=e,this._watchUpdatingTracking.removeAll(),e&&this._watchUpdatingTracking.add(e.focus,"renderLocation",(()=>()=>this._allTilesSorted=!1))})),Y(ma,"TERRAIN_TILE_TREE_SHOW_TILES",(e=>{e&&!this._treeDebugger?import("../chunks/TerrainTileTree3DDebugger.js").then((({TerrainTileTree3DDebugger:e})=>{!this._treeDebugger&&ma.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new e({view:this.view}))})):e||(this._treeDebugger=R(this._treeDebugger))}))]),this._extentHelper=(t=this.viewingMode,i={layers:this.view.map.allLayers,layerViews:this.view.allLayerViews,viewSpatialReference:this.view.spatialReference},1===t?new Vx(i):new kx(i));const r=this.view.defaultsFromMap?new mh({getCollections:()=>{var e,t,i;return null==(e=this.view)||null==(t=e.defaultsFromMap)||null==(i=t.mapCollectionPaths)?void 0:i.map((e=>this.view.map.get(e)))},getChildrenFunction:e=>e&&"layers"in e?e.layers:null}):this.view.map.allLayers,s=new kb({layers:r,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:this.view.spatialReference});this._set("tilingSchemeLogic",s),this._updateTilingScheme(),this._elevationDataRequester=this.view.resourceController.createStreamDataRequester(0),this._mapDataRequester=this.view.resourceController.createStreamDataRequester(1);const a=this.view.resourceController.scheduler;this._frameTask=a.registerTask(qo.TERRAIN_SURFACE,this),this.view.resourceController.memoryController.events.on("quality-changed",(()=>this._viewChangeUpdate())),this._handles.add([Y(this._extentHelper,"stencilEnabledExtents",(e=>this._renderer.setStencilEnabledLayerExtents(e))),this.tilingSchemeLogic.watch("tilingScheme",(()=>this._updateTilingScheme()),!0),this.tilingSchemeLogic.watch("extent",(()=>this._updateClippingExtent()),!0),Y(this,"extent",(()=>this._updateRootTiles())),this.view.on("resize",(()=>this._viewChangeUpdate())),this.view.watch("state.camera",(()=>this._viewChangeUpdate()),!0),this.view.watch("state.contentCamera",(()=>this.view.state.fixedContentCamera&&this._viewChangeUpdate()),!0),this.view.watch("qualitySettings.tiledSurface.lodBias",(()=>this._viewChangeUpdate())),Y(this.view,"qualitySettings.tiledSurface.textureFadeDuration",(e=>this._renderer.textureFadingEnabled=e>0)),this.view.watch("lodSnapping",(()=>this._viewChangeUpdate())),this.view.watch("clippingArea",(()=>this._updateClippingExtent()))]),this._handles.add(this.view.allLayerViews.on("after-changes",(()=>this._layerViewsDirty=!0))),this._layerViewsDirty=!0,this._handleLayerViewChanges()}destroy(){this._frameTask.remove(),this._handles.destroy(),this._watchUpdatingTracking.destroy(),this._lercDecoder=S(this._lercDecoder),this._removeAllTiles(),this._upsampleMapCache=R(this._upsampleMapCache),this._elevationQueryCache=R(this._elevationQueryCache),this._set("tilingSchemeLogic",R(this.tilingSchemeLogic)),this._extentHelper=R(this._extentHelper),this._basemapLayerViewHandles.forEach(((e,t)=>this._unregisterTiledLayerView(t))),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",R(this.overlayManager)),this._tilePool=R(this._tilePool),Aw.prune(),this._treeDebugger&&(this._treeDebugger.destroy(),this._treeDebugger=null),this._renderer=R(this._renderer),this._iteratorPool=R(this._iteratorPool),this._set("view",null),this._upsampleInfoPool=R(this._upsampleInfoPool),xh(),Cw.size>0&&(console.log(`${Cw.size} live TilePerLayerInfo allocations:`),Cw.forEach((e=>console.log(e,"\n"))))}get renderer(){return this._renderer}get frustum(){return this._frustum}get snapLevel(){var e,t;const i=null==(e=this.view.pointsOfInterest)||null==(t=e.contentCameraOnSurface)?void 0:t.scale;if(i){const e=this.view.state.contentCamera;let t=er(this.view,e.eye,e.viewForward,e.up).tilt;t>90&&(t=180-t);const r=2*(t/90)**2,s=Qi(this.view,i)-r;Math.abs(this._snapLevel-s)>.25&&(Math.round(s)!==Math.round(this._snapLevel)&&(this._viewChanged=!0),this._snapLevel=s)}return Math.round(this._snapLevel)}get lodSnapping(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences?1:0}get upsampleInfoPool(){return this._upsampleInfoPool}get upsampleMapCache(){return this._upsampleMapCache}get elevationQueryCache(){return this._elevationQueryCache}get mapTileRequester(){return this._mapDataRequester}get extent(){const e=kt(this.groundExtent,this._userClippingExtent,Ct()),t=this._get("extent");return Vt(e,t)?t:e}get groundExtent(){return D(this._tilingSchemeExtent,this._rootTilesExtent)}get _tilingSchemeExtent(){var e;return null==(e=this.tilingSchemeLogic)?void 0:e.extent}get updating(){return this._hasPendingUpdates||(this._maxNumUpdating=1),!!((this._watchUpdatingTracking.updating||this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||this._asyncWorkItems>0||!this._allTilesSorted||this._renderer.updating||this._layerViewsDirty)&&this.ready&&!this.suspended||this.overlayManager.updating||this._frameTask.updating)}get updatingProgressValue(){return this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating),1-this._pendingUpdates/this._maxNumUpdating}get viewingMode(){return this.view.state.viewingMode}get ready(){return C(this.rootTiles)}set renderOrder(e){this._renderer.renderOrder=e,this._set("renderOrder",e)}set skirtScale(e){this._renderer.skirtScale=e}get skirtScale(){return this._renderer.skirtScale}get spatialReference(){var e,t;return null!=(e=null==(t=this.tilingScheme)?void 0:t.spatialReference)?e:null}get _background(){return null!=this.backgroundColor?this.backgroundColor:this.backgroundImage}set slicePlaneEnabled(e){var t,i;this._renderer.slicePlane=e,this._set("slicePlaneEnabled",e),null==(t=this.view)||null==(i=t._stage)||i.renderView.setRenderParameters({opaqueTerrain:this.opaque})}set velvetOverground(e){e!==this.velvetOverground&&(this._renderer.velvetOverground=e),this._set("velvetOverground",e)}set visible(e){e!==this._visible&&(this._visible=e,this._renderer.setVisibility(e),this.suspended=!e)}get opaque(){return this._renderer.opaque}set suspended(e){this._set("suspended",e),this._viewChangeUpdate()}intersect(e,t,i,r){this._renderer.intersect(e,t,i,r)}getElevation(e,t,i,r){const s=Wb,a=this.getTileWithElevation(e,t,i,r,s);return M(a)?null:Ex.sample(s[0],s[1],a.renderData.geometryState.samplerData)}getTileWithElevation(e,t,i,r,s=Wb){var a;const n=this.rootTiles;if(M(n)||!n.length)return null;if(0===n[0].layerInfo[0].length)return null;if(s[0]=e,s[1]=t,s[2]=i,!pt(s,r,s,null==(a=this.tilingScheme)?void 0:a.spatialReference))return Ub.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;for(let e of n){if(!e.containsPoint(s))continue;for(;e&&!e.rendered&&!e.isLeaf;){let t=0;s[0]>.5*(e.extent[0]+e.extent[2])&&(t+=1),s[1]<.5*(e.extent[1]+e.extent[3])&&(t+=2),e=e.children[t]}const t=e.renderData;return(t&&t.geometryState?t.geometryState.samplerData:null)?e:null}return null}get elevationBounds(){return this._elevationBounds}getScale(e){if(this.tilingScheme){if(!ut(e,Wb,this.spatialReference))return Ub.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;const t=this.rootTiles;if(C(t))for(let e of t)if(e.containsPoint(Wb)){for(;null!=e.children[0];){let t=0;Wb[0]>e.children[0].extent[2]&&(t+=1),Wb[1]<e.children[0].extent[1]&&(t+=2),e=e.children[t]}return this._getLodBiasCorrectedScale(e.level)}}return 1e100}queryVisibleScaleRange(e,t,i,r){const s=t?this.tilingScheme.levelAtScale(t):0,a=i?this.tilingScheme.levelAtScale(i):1/0,n=this.lodBias;this._renderer.queryVisibleLevelRange(e,s+n,a+n,r)}_updateBaseOpacity(e){const t=this._renderer.opaque;this._renderer.opaque=e>=1,this._renderer.isTransparent=this._allTransparentSurfaceLayers();const i=t===this._renderer.opaque?2:1;var r,s;1===i&&(null==(r=this.view)||null==(s=r._stage)||s.renderView.setRenderParameters({opaqueTerrain:this.opaque}));this._updateTileTextures(i)}_updateTilingScheme(){const e=this.tilingSchemeLogic.tilingScheme;e!==this.tilingScheme&&(Bl(!!e,"tiling scheme cannot be reset to undefined"),this.tilingScheme&&this._removeAllTiles(),this._set("tilingScheme",e),this._updateClippingExtent(),e&&(this._updateTiledLayers(),this._renderer.setTileSize(e.pixelSize),this.overlayManager.setSpatialReference(e.spatialReference),this._updateRootTiles()))}_acquireTile(e,t,i,r){const s=this._tilePool.acquire();return Zb[0]=e,Zb[1]=t,Zb[2]=i,s.init(Zb,r,this),s}_updateRootTiles(){const{extent:e,tilingScheme:t}=this;if(!t)return;const i=Qb;let r=t.rootTilesInExtent(e,i,5*Ih);if(C(this.rootTiles)){if(r.length>Ih)return void Ub.warn(zh);const e=this.rootTiles.map((e=>e.lij)),t=ah(e,r,Bb);if(t.removed.length>0||t.added.length>0){const e=this.rootTiles.filter((e=>!(t.removed.findIndex((t=>Bb(t,e.lij)))>-1)||(this._purgeTile(e),!1)));t.added.forEach((t=>e.push(this._newRootTile(t)))),this._setRootTiles(e)}}else r.length>Ih&&(Ub.warn(Eh),r=t.rootTilesInExtent(e,i,Ih)),this._setRootTiles(r.map((e=>this._newRootTile(e))));Vt(i,this._rootTilesExtent)||(this._rootTilesExtent=Ct(i)),this.visible=!0,this._viewChangeUpdate(),this.overlayManager.setPlacementDirty(),this.notifyChange("ready")}_newRootTile(e){const t=this._acquireTile(0,e[1],e[2],null);return 2===t.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping)&&t.setPendingUpdate(2),this._loadTile(t),t}_setRootTiles(e){if(this._set("rootTiles",e),this._allTiles.clear(),C(e)){const t=this._iteratorPool.acquire();for(t.reset(e);!t.done;)this._allTiles.push(t.next());t.remove()}this._renderer.setRootTiles(this.rootTiles),this._updateTileVisibility(e)}_runViewChangeUpdateIfDirty(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())}_viewChangeUpdate(){this.view&&!this.suspended&&this.tilingScheme&&this._visible&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateSkirts(),this._updateTileVisibility(this.rootTiles)))}_updateClippingStatus(e){e.updateClippingStatus(this.extent)&&e.resetPendingUpdate(32)&&this._updateTileGeometry(e)}_updateTileVisibility(e){if(M(e))return;const t=this._iteratorPool.acquire();t.reset(e);const i=Nh(e);let r=i?this._elevationBounds.min:1/0,s=i?this._elevationBounds.max:-1/0;for(;!t.done;){const e=t.next();this._updateClippingStatus(e),e.updateVisibility(),e.setPendingUpdate(16),e.loadable?(e.updateScreenDepth(this._viewProjectionMatrix),e.renderData&&(r=Math.min(e.elevationBounds[0],r),s=Math.max(e.elevationBounds[1],s))):t.skipSubtree()}t.remove(),this._viewChanged=!0,this._allTilesDirty=!0,isFinite(r)&&isFinite(s)&&(this._elevationBounds.min===r&&this._elevationBounds.max===s||(this._elevationBounds.min=r,this._elevationBounds.max=s,this.emit("elevation-bounds-change",null)))}_updateViewDependentParameters(){const e=this.view.state.camera,t=this.view.state.contentCamera,i=Math.tan(.5*t.fovX),r=Math.tan(.5*t.fovY),s=this.tilingScheme.pixelSize,a=2**-this.lodBias*e.pixelRatio;this._splitLimits.aboveGround=e.aboveGround,this._splitLimits.fovX=i,this._splitLimits.fovY=r,this._splitLimits.relativeWidthLimit=s/e.width*this.maxTextureScale*a,this._splitLimits.relativeHeightLimit=s/e.height*this.maxTextureScale*a,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?(M(this._splitLimits.frustum)&&(this._splitLimits.frustum=dl()),wl(t.frustum,this._splitLimits.frustum)):this._splitLimits.frustum=null,wl(e.frustum,this._frustum),Cr(this._viewProjectionMatrix,t.projectionMatrix,t.viewMatrix),ye(this._eyePosRenderSR,t.eye),pt(e.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)}_updateSkirts(){const e=this.view.state.camera,t=this.view.state.constraints.collision.enabled?0:1.11*e.near;this.skirtScale=Kl(this,this._eyePosSurfaceSR,t)}_updateRenderData(e){e.rendered&&!e.shouldLoad&&(Nb(e)?this._loadChildren(e):function(e){return e.isLeaf&&e.parent&&e.parent.shouldLoad}(e)&&this._loadParent(e))}_updateTileGeometry(e){e.updateVisibility(),this._renderer.updateTileGeometry(e),this._elevationUpdate(e),this._usedMemory=Gb}_updateTileTexture(e,t){const i=e.resetPendingUpdate(128)?128:!!e.resetPendingUpdate(64)&&64;i&&(this._renderer.updateTileTexture(e,i),this._usedMemory=Gb,t.madeProgress())}_elevationUpdate(e){Xb.spatialReference=this.spatialReference,Xb.tile=e,Xb.extent=e.extent,this.emit("elevation-change",Xb),Ut(e.extent,this._eyePosSurfaceSR)&&this._updateSkirts()}get running(){return this.updating&&this.ready&&!this.suspended}runTask(e){this._handleLayerViewChanges(e),this._frameTask.processQueue(e),this._inFrameTask=!0,this._pendingUpdates=0,this._hasPendingUpdates=!1,this._updateTileStatus(e),this._sortTiles(e);const t=!this.view.state.fixedContentCamera;this._mergeAndSplit(e,t),e.run((()=>this._updateElevation(e))),e.run((()=>this._updateTextures(e))),t||this._mergeAndSplit(e,!0),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),e.done&&this.requestUpdate(),this.notifyChange("updatingProgressValue")}_updateTileStatus(e){if(!this._viewChanged||!this.rootTiles||e.done)return;this._viewChanged=!1;const t=this._iteratorPool.acquire();for(t.reset(this.rootTiles);!t.done;){const e=t.next();if(e.loadable){const i=e.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping);if(2===i){e.resetPendingUpdate(8),e.isLeaf&&(e.setPendingUpdate(2),t.skipSubtree());continue}e.resetPendingUpdate(2)&&e.updateAgentSuspension(),4===i&&e.updateAgents(0)}if(t.skipSubtree(),!e.isLeaf){e.setPendingUpdate(8),e.resetPendingUpdate(2);const t=this._iteratorPool.acquire();t.resetOne(e);for(let e=t.next();!t.done;e=t.next())this._updateClippingStatus(e),e.updateVisibility(),e.loadable&&e.updateScreenDepth(this._viewProjectionMatrix);t.remove()}}t.remove(),this.requestUpdate(),e.madeProgress()}_sortTiles(e){e.done||this._allTilesSorted||(Gh(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),e.madeProgress())}_mergeAndSplit(e,t){if(this.suspended||!this._allTilesDirty||e.done)return;this._allTilesDirty=!1,this.requestUpdate();let i=0;for(;!e.done;){let r=!1;i=0;const s=!this._allTiles.some((s=>{if(i+=s.usedMemory,s.resetPendingUpdate(8)){if(!t)return s.setPendingUpdate(8),e.done;this._mergeTile(s),r=!0,e.madeProgress()}else s.resetPendingUpdate(2)&&(this._splitTile(s),r=!0,e.madeProgress());return s.resetPendingUpdate(16)&&(this._updateRenderData(s),e.madeProgress()),e.done}));if(r&&(this._allTilesSorted=!1,this._allTilesDirty=!0),s){if(this._usedMemory=i,!r)break}else this._allTilesDirty=!0}0===i&&(this._allTilesDirty=!0),this._sortTiles(e)}_updateElevation(e){return this._allTiles.some((t=>(t.resetPendingUpdate(32)&&(this._updateTileGeometry(t),this._updateTileTexture(t,e),e.madeProgress()),e.done))),e.hasProgressed}_updateTextures(e){return this._allTiles.some((t=>(this._updateTileTexture(t,e),e.done))),e.hasProgressed}_updateClippingExtent(){if(!this.spatialReference)return;let e;C(this.view.clippingArea)&&(e=Ct(),ao(this.view.clippingArea,e,this.spatialReference)||(e=null)),Vt(e,this._userClippingExtent)||(this._userClippingExtent=e,this.updateTileOverlayParams(),this.overlayManager.setPlacementDirty(),this._updateRootTiles())}get lodBias(){const e=this.view.resourceController.memoryController.memoryFactor;return this.view.qualitySettings.tiledSurface.lodBias-(1-e)*Lh}_getLodBiasCorrectedScale(e){const t=this.tilingScheme.levels,i=ue(e-this.lodBias,0,t.length-1),r=i-Math.floor(i);return t[Math.floor(i)].scale*(1-r)+t[Math.ceil(i)].scale*r}_removeAllTiles(){C(this.rootTiles)&&(this.rootTiles.forEach((e=>this._purgeTile(e))),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this.visible=!1}_purgeChildTiles(e){if(e.isLeaf)return!1;let t=this._purgeTile(e.children[0]);return t=this._purgeTile(e.children[1])||t,t=this._purgeTile(e.children[2])||t,t=this._purgeTile(e.children[3])||t,e.unsetChildren(),t}_purgeTile(e){const t=this._purgeChildTiles(e)||e.rendered;return this._allTiles.removeUnordered(e),e.unload(this._renderer),this._tilePool.release(e),t}_splitTile(e){Bl(e.isLeaf,"tile that is already split should not be split again!");const t=e.level+1,i=2*e.lij[1],r=2*e.lij[2];e.setChildren(this._createTile(t,i,r,e),this._createTile(t,i,r+1,e),this._createTile(t,i+1,r,e),this._createTile(t,i+1,r+1,e)),e.setPendingUpdate(16),e.updateAgentSuspension(),this._allTiles.pushArray(e.children),this._allTilesDirty=!0,this._emitTileScaleChange(e,t),++this._performanceInfo.numSplit}_emitTileScaleChange(e,t=e.level){Kb.spatialReference=this.spatialReference,Kb.extent=e.extent,Kb.scale=this._getLodBiasCorrectedScale(t),this.emit("scale-change",Kb)}_createTile(e,t,i,r){Bl(!!r,"_createTile sanity check");const s=this._acquireTile(e,t,i,r);return s.updateClippingStatus(this.extent),s.loadable&&(s.updateScreenDepth(this._viewProjectionMatrix),2===s.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping)&&s.setPendingUpdate(2)),s}_mergeTile(e){Bl(!e.hasPendingUpdate(2),"_mergeTile sanity check"),this._purgeChildTiles(e)&&(Bl(!e.renderData,"_mergeTile sanity check"),this._loadTile(e)),this._allTilesDirty=!0,++this._performanceInfo.numMerged,this._emitTileScaleChange(e)}_loadChildren(e){Bl(e.rendered,"parent should be rendered"),e.unload(this._renderer),this._loadTile(e.children[0]),this._loadTile(e.children[1]),this._loadTile(e.children[2]),this._loadTile(e.children[3])}_loadParent(e){const t=e.parent;this._unloadChildren(t),this._loadTile(t)}_unloadChildren(e){e.isLeaf||(this._unloadChildren(e.children[0]),e.children[0].unload(this._renderer),this._unloadChildren(e.children[1]),e.children[1].unload(this._renderer),this._unloadChildren(e.children[2]),e.children[2].unload(this._renderer),this._unloadChildren(e.children[3]),e.children[3].unload(this._renderer))}_loadTile(e){e.load(this._renderer),e.setPendingUpdate(16),this.requestUpdate(),this.overlayManager&&this.overlayManager.hasOverlays&&this.overlayManager.setTileParameters(e),this._elevationUpdate(e)}_elevationDataArrived(e,t,i){const r=new Ex(e.lij,e.extent,i);e.dataArrived(t,0,r);const s=[e],a=e.level,n=this._iteratorPool.acquire();for(n.reset(s);!n.done;){const e=n.next();e.findElevationBoundsForLayer(t,a),e.computeElevationBounds()}n.remove(),this._updateTileVisibility(s)}_handleLayerViewChanges(e=Ho){if(!this._layerViewsDirty)return;this._layerViewsDirty=!1;let t=!1;const i=new Set;let r=-1;for(const e of this.view.allLayerViews.items)if(i.add(e.uid),Jl(e))if(this._basemapLayerViewHandles.has(e.uid)){const i=this.layerClassFromLayerView(e),s=this._layerIndexByUid[i].get(e.uid);s<r&&(t=!0),r=s}else this._registerTiledLayerView(e),e.layer.loaded&&(t=!0);this._basemapLayerViewHandles.forEach(((e,r)=>{i.has(r)||(this._unregisterTiledLayerView(r),t=!0)})),t&&this._updateTiledLayers(),this._renderer.isTransparent=this._allTransparentSurfaceLayers(),e.madeProgress()}_allTransparentSurfaceLayers(){let e=0===this.view.map.ground.opacity;for(const t of this.view.allLayerViews.items)if(Jl(t)&&!$l(t)&&!$t(t.layer)&&0!==t.fullOpacity)return e=!1,e;return e}layerClassFromLayerView(e){return $l(e)?0:1}_registerTiledLayerView(e){const t=[],i=this.layerClassFromLayerView(e);t.push(e.watch("suspended",(()=>this._updateTiledLayers()))),t.push(e.watch("fullOpacity",(()=>this._updateTileTextures(2)))),t.push(e.layer.watch("scaleRangeId",(()=>this._restartAllAgents(i)))),e.on("data-changed",(()=>{const t=this._layerIndexByUid[i].get(e.uid);null!=t&&this._invalidateLayerData(t,i)})),this._basemapLayerViewHandles.set(e.uid,t)}_unregisterTiledLayerView(e){const t=this._basemapLayerViewHandles.get(e);if(t){for(let e=0;e<t.length;e++)t[e].remove();this._basemapLayerViewHandles.delete(e)}}_updateTiledLayers(){if(!this.tilingScheme||this.view.suspended)return;const e=this.view.allLayerViews,t=[[],[]];let i=null;const r=Tt();e.forEach((e=>{const s=e.layer;if(!s||e.suspended||!Jl(e))return;const a=e.fullExtent;if(!a)return void Ub.warn("Terrain: Map or elevation layer does not have fullExtent: "+s.id);if(!this.tilingScheme.compatibleWith(e.tileInfo))return void Ub.warn("Terrain: tiling scheme of layer "+s.id+" is incompatible with other tiled layers, will not be drawn");Mt(r,a,r);const n=this.layerClassFromLayerView(e);if(1===n){const t=e.displayLevelRange;t.maxLevel!==1/0&&(null===i||t.maxLevel>i)&&(i=t.maxLevel)}t[n].push(e)}));for(const e of Ah){const i=this._layerViews[e],r=t[e];r.reverse();const s=r.length;let a=i.length!==s;const n=new Array(s),o=new Array(i.length);this._layerIndexByUid[e].clear();for(let t=0;t<s;t++){const s=r[t].uid;this._layerIndexByUid[e].set(s,t);const l=i.indexOf(r[t]);n[t]=l,t!==l&&(a=!0),l>-1&&(o[l]=t)}if(a){const t=this._postorderIterator;for(t.reset(this.rootTiles);!t.done;)t.next().modifyLayers(o,n,e);this._layerViews[e]=r,this._restartAllAgents(e),this._updateTileVisibility(this.rootTiles)}}this.tilingScheme.ensureMaxLod(i)&&this._viewChangeUpdate()}_restartAllAgents(e){const t=this._postorderIterator;for(t.reset(this.rootTiles);!t.done;){const i=t.next();i.restartAgents(e),0===e&&i.computeElevationBounds()}}layerViewByIndex(e,t){return this._layerViews[t][e]}numLayers(e){return this._layerViews[e].length}_updateTileTextures(e){this._allTiles.forAll((t=>{t.updateAgents(1),1===e?this.renderer.updateTileTexture(t,64):t.updateRenderData(1,e)})),this._renderer.isTransparent=this._allTransparentSurfaceLayers()}_invalidateLayerData(e,t){this._allTiles.forAll((i=>i.removeLayerAgent(e,t))),this._allTiles.forAll((i=>i.invalidateLayerData(e,t)))}setTileTreeDirty(){this._allTilesDirty=!0}requestRender(e=1){this.renderer.setNeedsRender(e)}requestUpdate(){1==++this._pendingUpdates&&(this._hasPendingUpdates=!0)}requestTileData(e,t,i,r){const s=this.layerViewByIndex(t,i),a=s.layer;return!a.tilemapCache||Gl(s)?this._requestTileData(e,i,s,r):(++this._asyncWorkItems,a.tilemapCache.fetchAvailability(e.lij[0],e.lij[1],e.lij[2],{...r,timeout:6e3}).then((()=>--this._asyncWorkItems)).catch((t=>{throw--this._asyncWorkItems,c(t)||this._dataMissing(e,i,s,{notInTilemap:!0}),t})).then((()=>this._frameTask.schedule((()=>this._requestTileData(e,i,s,r)),r.signal))))}_requestTileData(e,t,i,r){return 0===t?this._requestElevationTileData(e,i,r):this._requestMapTileData(e,i,r)}_requestElevationTileData(e,t,i){if(!$l(t))return void Bl(!1,"_requestElevationTileData can only be called for elevation layer views");const r=r=>{if(--this._asyncWorkItems,g(i))return;const s=this._layerIndexByUid[0].get(t.uid);null!=s?(this._usedMemory=Gb,this.requestUpdate(),this._elevationDataArrived(e,s,r)):Ub.warn("TerrainSurface: received data from unknown layer %d %s",0,e.lij.toString())},s=i=>{--this._asyncWorkItems,c(i)||(this._dataMissing(e,0,t,i),this.requestUpdate())};if(++this._asyncWorkItems,eh(t.layer))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],{noDataValue:Ch,signal:i.signal}).then((e=>{if(g(i))return Ub.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void s(p());this._frameTask.schedule((()=>r(e)),i.signal,s)}),s);const a=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);return this._elevationDataRequester.request(a,"binary",i).then((e=>this._lercDecoder.decode(e,{noDataValue:Ch},i.signal))).then((e=>{r({values:e.pixelData,width:e.width,height:e.height,noDataValue:e.noDataValue,minValue:e.minValue,maxValue:e.maxValue})}),s)}_requestMapTileData(e,t,i){if(t instanceof Fx)return Promise.reject();++this._asyncWorkItems;const r=(r,s)=>{--this._asyncWorkItems,Hl(s),g(i)||(this._dataMissing(e,1,t,r),this.requestUpdate())},s=e=>t=>r(t,e),a=r=>this._frameTask.schedule((()=>{--this._asyncWorkItems,this.requestUpdate(),g(i)?Hl(r):this._mapTileDataArrived(e,t,r)}),i.signal,s(r)).catch(s(r)),n=(e,t=null)=>this._frameTask.schedule((()=>r(e,t)));if(Gl(t)){const r=t.schemaHelper.getLevelRowColumn(e.lij);return t.fetchTile(r[0],r[1],r[2],i).then(a,n)}if(th(t))return t.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then(a,n);if(ih(t)&&eh(t.layer))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then((e=>{if(g(i))return Ub.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void n(p());a(e)}),n);let o=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);fh(t.layer)&&t.layer.refreshTimestamp&&(o+=`${o.includes("?")?"&":"?"}_ts=${t.layer.refreshTimestamp}`);const l=t.hasMixedImageFormats?"image+type":"image";return this._mapDataRequester.request(o,l,i).then(a,n)}_mapTileDataArrived(e,t,i){const r=this._layerIndexByUid[1].get(t.uid);null!=r?e.dataArrived(r,1,i):(Hl(i),Ub.warn("TerrainSurface: received data from unknown layer"))}_dataMissing(e,t,i,r){const s=this._layerIndexByUid[t].get(i.uid);null!=s?e.dataMissing(s,t,r):Ub.warn("TerrainSurface: received data from unknown layer")}updateTileOverlayParams(){this.rootTiles&&this.overlayManager&&(this._allTiles.forAll((e=>{e.renderData&&this.overlayManager.setTileParameters(e)})),this._renderer.setNeedsRender())}get performanceInfo(){const e=this._performanceInfo;return e.numNodes=this._allTiles.length,e.numLeaves=e.numVisible=e.numRendered=e.numLoadedPerLevel.length=e.numRenderedPerLevel.length=0,this._allTiles.forAll((t=>{t.isLeaf&&e.numLeaves++;const i=t.level;t.renderData&&(e.numLoadedPerLevel[i]=(e.numLoadedPerLevel[i]||0)+1),t.visible&&(e.numVisible++,t.rendered&&(e.numRenderedPerLevel[i]=(e.numRenderedPerLevel[i]||0)+1,e.numRendered++))})),e}getUsedMemory(){return this.tilingScheme?(this._usedMemory===Gb&&(this._usedMemory=0,this._allTiles.forAll((e=>this._usedMemory+=e.usedMemory))),this._usedMemory):0}getUsedMemoryForLayerView(e){let t=0;const i=this.layerClassFromLayerView(e),r=this._layerIndexByUid[i].get(e.uid);return this._allTiles.forAll((e=>t+=e.getUsedMemoryForLayer(i,r))),t}getTile(e){if(M(e)||M(this.rootTiles))return null;const t=e.split("/").map((e=>+e));if(0===t[0])return this.rootTiles.find((e=>e.lij[1]===t[1]&&e.lij[2]===t[2]));const i=2**t[0],r=Math.floor(t[1]/i),s=Math.floor(t[2]/i);let a;if(this.rootTiles.some((e=>e.lij[1]===r&&e.lij[2]===s&&(a=e,!0))),a){let e=1<<t[0]-1;for(;a.lij[0]<t[0];){let i=t[1]&e?2:0;if((t[2]&e)>0&&i++,!a.children[i])return null;a=a.children[i],e>>=1}return Bl(a.lij[0]===t[0]&&a.lij[1]===t[1]&&a.lij[2]===t[2],"not the right tile?"),a}return null}get test(){const e=this;return{renderer:e._renderer,lercDecoder:e._lercDecoder,forceReload:()=>{C(e.rootTiles)&&(e._mergeTile(e.rootTiles[0]),e._viewChangeUpdate())},getTiles:()=>e._allTiles.toArray(),getRenderedTiles:()=>(Yb.clear(),e._allTiles.forAll((e=>{e.visible&&e.rendered&&Yb.push(e)})),qh(e.renderOrder,Yb),Yb.toArray()),lockTilingScheme(t,i){e._extentHelper.defaultTiledLayersExtent=i,e.tilingSchemeLogic.test.lockTilingScheme(t)}}}};e([le()],qb.prototype,"_renderer",void 0),e([le()],qb.prototype,"_hasPendingUpdates",void 0),e([le()],qb.prototype,"_asyncWorkItems",void 0),e([le()],qb.prototype,"_allTilesDirty",void 0),e([le()],qb.prototype,"_allTilesSorted",void 0),e([le()],qb.prototype,"_viewChanged",void 0),e([le({readOnly:!0})],qb.prototype,"_watchUpdatingTracking",void 0),e([le()],qb.prototype,"_frameTask",void 0),e([le({readOnly:!0})],qb.prototype,"snapLevel",null),e([le({readOnly:!0})],qb.prototype,"lodSnapping",null),e([le({constructOnly:!0})],qb.prototype,"view",void 0),e([le()],qb.prototype,"_userClippingExtent",void 0),e([le()],qb.prototype,"_rootTilesExtent",void 0),e([le({readOnly:!0})],qb.prototype,"extent",null),e([le({readOnly:!0})],qb.prototype,"groundExtent",null),e([le({readOnly:!0})],qb.prototype,"_tilingSchemeExtent",null),e([le({readOnly:!0})],qb.prototype,"updating",null),e([le(Dx)],qb.prototype,"updatingProgress",void 0),e([le({readOnly:!0})],qb.prototype,"updatingProgressValue",null),e([le()],qb.prototype,"_maxNumUpdating",void 0),e([le({aliasOf:"view.map.ground.opacity"})],qb.prototype,"baseOpacity",void 0),e([le({readOnly:!0})],qb.prototype,"overlayManager",void 0),e([le({readOnly:!0})],qb.prototype,"viewingMode",null),e([le()],qb.prototype,"maxTextureScale",void 0),e([le({readOnly:!0})],qb.prototype,"ready",null),e([le({value:1})],qb.prototype,"renderOrder",null),e([le({readOnly:!0})],qb.prototype,"rootTiles",void 0),e([le({readOnly:!0})],qb.prototype,"spatialReference",null),e([le()],qb.prototype,"backgroundImage",void 0),e([le({type:sr,aliasOf:"view.map.ground.surfaceColor"})],qb.prototype,"backgroundColor",void 0),e([le()],qb.prototype,"_background",null),e([le({value:!1})],qb.prototype,"slicePlaneEnabled",null),e([le({readOnly:!0})],qb.prototype,"tilingScheme",void 0),e([le({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeLocked"})],qb.prototype,"tilingSchemeLocked",void 0),e([le({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeDone"})],qb.prototype,"tilingSchemeDone",void 0),e([le({readOnly:!0})],qb.prototype,"tilingSchemeLogic",void 0),e([le({value:!0})],qb.prototype,"velvetOverground",null),e([gh("_renderer.wireframe")],qb.prototype,"wireframe",void 0),e([le({value:!1})],qb.prototype,"suspended",null),e([le({readOnly:!0,aliasOf:"view.qualitySettings.tiledSurface.textureFadeDuration"})],qb.prototype,"textureFadeDuration",void 0),e([le()],qb.prototype,"_layerViewsDirty",void 0),e([gh("_renderer.renderPatchBorders")],qb.prototype,"renderPatchBorders",void 0),e([gh("_renderer.renderingDisabled")],qb.prototype,"renderingDisabled",void 0),qb=e([ce("esri.views.3d.terrain.TerrainSurface")],qb);var Hb=qb;function Bb(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function Nb(e){return!e.isLeaf&&(e.children[0].shouldLoad||e.children[1].shouldLoad||e.children[2].shouldLoad||e.children[3].shouldLoad||Nb(e.children[0])||Nb(e.children[1])||Nb(e.children[2])||Nb(e.children[3]))}const Gb=-1,Wb=nr(),Qb=Ct(),Zb=[0,0,0],Yb=new N,Xb={spatialReference:null,tile:null,extent:null,context:"ground"},Kb={spatialReference:null,extent:null,scale:0};let Jb=class extends yi{constructor(e){super(e),this._residentGeomRecords=new Map,this._dirtyGeomRecords=new Map,this.dirty=!1}commit(e){this.dirty=!1,this._dirtyGeomRecords.forEach(((t,i)=>this.commitLayer(i,e)))}commitLayer(e,t){const i=this._dirtyGeomRecords.get(e);i&&(i.forEach(((i,r)=>{const s=this._ensureGeomRecord(e,r);i.forEach(((e,i)=>{const a=e[0],n=e[1],o=e[2];let l=!1;if(2&n){const e=s.get(i);if(e){const i=e[1];if(4&o){const e=this.model.getObject(r);this.model.updateRenderGeometryTransformation(e,a,i)&&(l=!0)}l||t.updates.push({renderGeometry:i,updateType:o})}else Fn(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid update")}if(4&n||l){const e=s.get(i);e?(t.removes.push(e[1]),s.delete(i),e[0].disposed&&go.pool.release(e[0])):4===n&&Fn(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid remove")}if(1&n||l){const e=this.model.getObject(r),n=this.model.getRenderGeometry(e,a),o=[a,n];t.adds.push(n),s.set(i,o)}})),0===s.size&&this._residentGeomRecords.get(e).delete(r)})),0===this._residentGeomRecords.get(e).size&&this._residentGeomRecords.delete(e),this._dirtyGeomRecords.delete(e))}getResidentRenderGeometries(e,t){const i=this._residentGeomRecords.get(e);i&&i.forEach((e=>e.forEach((e=>t.push(e[1])))))}_objectStateChanged(e,t){for(const i of t.geometryRecords)this._updateOrCreateDirtyRecord(t,i,null,2,0,0,2,5,e)}visibilityChanged(e){this._objectStateChanged(1,e)}highlightChanged(e){this._objectStateChanged(8,e)}occlusionChanged(e){this._objectStateChanged(16,e)}vertexAttrsUpdated(e){this._updateOrCreateDirtyRecord(e.object,e.record,null,2,0,0,2,5,2)}layerAdded(e){e.objects.forAll((t=>this._layerObjectAdded(e,t)))}layerRemoved(e){e.objects.forAll((t=>this._layerObjectRemoved(e,t)))}layerObjectAdded(e){this._layerObjectAdded(e.layer,e.object)}_layerObjectAdded(e,t){const i=e.id,r=t.geometryRecords;for(let e=0;e<r.length;e++)this._objectGeometryAdded(t,r[e],i)}layerObjectRemoved(e){this._layerObjectRemoved(e.layer,e.object)}layerObjectsAdded(e){for(const t of e.objects)this._layerObjectAdded(e.layer,t)}layerObjectsRemoved(e){for(const t of e.objects)this._layerObjectRemoved(e.layer,t)}_layerObjectRemoved(e,t){const i=e.id,r=t.geometryRecords;for(let e=0;e<r.length;e++)this._objectGeometryRemoved(t,r[e],i)}shaderTransformationChanged(e){const t=this._residentGeomRecords.get(e.id);t&&t.forEach(((e,t)=>{const i=this.model.getObject(t);i&&i.hasVolativeTransformation()&&e.forEach((e=>{e[1].shaderTransformationChanged()}))}))}objectTransformation(e){const t=this._getParentLayerId(e),i=e.id;this._ensureGeomRecord(t,i).forEach((i=>{this._updateOrCreateDirtyRecord(e,i[0],t,2,0,0,2,5,4)}))}objectGeometryAdded(e){this._objectGeometryAdded(e.object,e.record)}_objectGeometryAdded(e,t,i=null){this._updateOrCreateDirtyRecord(e,t,i,1,4,0,0,0)}objectGeometryRemoved(e){this._objectGeometryRemoved(e.object,e.record)}_objectGeometryRemoved(e,t,i=null){this._updateOrCreateDirtyRecord(e,t,i,4,1,2,0,0)}_updateOrCreateDirtyRecord(e,t,i,r,s,a,n,o,l){i=D(i,this._getParentLayerId(e));const h=e.id,c=t.id,d=this._ensureDirtyRecord(i,h),u=d.get(c);if(u){const e=u[1];e&s?(d.delete(c),u[0].disposed&&go.pool.release(u[0])):e&a?(u[1]=r,u[2]=l):e&n?u[2]|=l:e&o||Fn(!1,"ModelDirtySet.objectGeometryAdded: inconsistent state")}else d.set(c,[t,r,l]);this.dirty=this._hasDirtyGeometryRecords}_ensureGeomRecord(e,t){let i=this._residentGeomRecords.get(e);i||(i=new Map,this._residentGeomRecords.set(e,i));let r=i.get(t);return r||(r=new Map,i.set(t,r)),r}get _hasDirtyGeometryRecords(){return Uo(this._dirtyGeomRecords,(e=>Uo(e,(e=>e&&e.size>0))))}_ensureDirtyRecord(e,t){let i=this._dirtyGeomRecords.get(e);i||(i=new Map,this._dirtyGeomRecords.set(e,i));let r=i.get(t);return r||(r=new Map,i.set(t,r)),r}_getParentLayerId(e){return C(e.parentLayer)?e.parentLayer.id:Ci}formatDebugInfo(){const e=["ADD","UPD",void 0,"REM"];let t="";return this._dirtyGeomRecords.forEach(((i,r)=>{i.forEach(((i,s)=>{t.length>0&&(t+="\n"),t+=r+"."+s;const a=[];i.forEach((e=>{const t=e[1];a[t]||(a[t]=[]),a[t].push(e[0].geometry.id)}));for(let i=0;i<a.length;i++)if(a[i]){t+=" "+e[i-1]+": ";for(let e=0;e<a[i].length;e++)t+=a[i][e]+", "}}))})),t}get test(){const e=this;return{get residentLayerCount(){return e._residentGeomRecords.size},get residentObjectCount(){return Array.from(e._residentGeomRecords.values()).reduce(((e,t)=>e+t.size),0)}}}};e([le({constructOnly:!0})],Jb.prototype,"model",void 0),e([le()],Jb.prototype,"dirty",void 0),Jb=e([ce("esri.views.3d.webgl-engine.lib.ModelDirtySet")],Jb);var $b=Jb;const eC=Fn,tC=In;let iC=class extends yi{constructor(){super(),this.dirtySet=new $b({model:this}),this._id2origin=new Map,this._content=new Map}getObject(e){return this._content.get(e)}add(e){const t=e.id;eC(!this._content.has(t),"Model/Stage already contains object to be added"),this._content.set(t,e),Yo(e)&&this.dirtySet.layerAdded(e)}remove(e){eC(this._content.has(e.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(e.id),e.unload(),Yo(e)&&this.dirtySet.layerRemoved(e)}addMany(e){for(const t of e)eC(!this._content.has(t.id),"Model/Stage already contains object to be added"),this._content.set(t.id,t)}removeMany(e){for(const t of e)eC(this._content.has(t.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(t.id),t.unload()}forEachOfType(e,t){this._content.forEach((i=>{i.type===e&&t(i)}))}_getOrigin(e){let t=0;const i=10*e[3]/1e4;i>1&&(t=Math.ceil(tC(i,2)));const r=2**t*1e4,s=Math.round(e[0]/r),a=Math.round(e[1]/r),n=Math.round(e[2]/r),o=t+"_"+s+"_"+a+"_"+n;let l=this._id2origin.get(o);return null==l&&(l=va(s*r,a*r,n*r,o),this._id2origin.set(o,l)),l}getRenderGeometry(e,t){const{geometry:i,material:r,id:s,shaderTransformation:a,origin:n,instanceParameters:o}=t,l=new ac(i,r,null,null,s,i.boundingInfo,a,e.castShadow);return l.updateTransformation((i=>e.getCombinedStaticTransformation(t,i))),l.origin=n||this._getOrigin(l.boundingSphere),l.instanceParameters=o,l}updateRenderGeometryTransformation(e,t,i){i.updateTransformation((i=>e.getCombinedStaticTransformation(t,i)));const r=this._getOrigin(i.boundingSphere);return i.origin!==r}getStats(){const e={},t=Array.from(this._content.values());for(let i=0;i<5;++i)e[i]=t.filter((e=>e.type===i)).length;return{contentTypes:e,dirtySet:this.dirtySet.formatDebugInfo()}}get test(){return{content:Array.from(this._content.values())}}};e([le({constructOnly:!0})],iC.prototype,"dirtySet",void 0),iC=e([ce("esri.views.3d.webgl-engine.parts.Model")],iC);const rC=[0,0,0],sC=[0,0,0];function aC(e,t){const{data:i,size:r}=e,s=i.length/r;if(s<=0)return;const a=new kC(e);qC(rC,a.minProj,a.maxProj),BC(rC,rC,.5),HC(sC,a.maxProj,a.minProj);const n=UC(sC),o=new jC;o.quality=n,s<14&&(e={data:new Float64Array(a.buffer,112,42),size:3});const l=[0,0,0],h=[0,0,0],c=[0,0,0],d=[0,0,0],u=[0,0,0],p=[0,0,0],m=[0,0,0];switch(function(e,t,i,r,s,a,n,o,l,h){if(function(e,t,i){let r=ZC(e.maxVert[0],e.minVert[0]),s=0;for(let t=1;t<7;++t){const i=ZC(e.maxVert[t],e.minVert[t]);i>r&&(r=i,s=t)}NC(t,e.minVert[s]),NC(i,e.maxVert[s])}(e,r,s),ZC(r,s)<1e-6)return 1;HC(n,r,s),WC(n,n);if(function(e,t,i,r){const{data:s,size:a}=e;let n=Number.NEGATIVE_INFINITY,o=0;for(let e=0;e<s.length;e+=a){mC[0]=s[e]-t[0],mC[1]=s[e+1]-t[1],mC[2]=s[e+2]-t[2];const r=i[0]*mC[0]+i[1]*mC[1]+i[2]*mC[2],a=i[0]*i[0]+i[1]*i[1]+i[2]*i[2],l=mC[0]*mC[0]+mC[1]*mC[1]+mC[2]*mC[2]-r*r/a;l>n&&(n=l,o=e)}return NC(r,s,o),n}(t,r,n,a)<1e-6)return 2;return HC(o,s,a),WC(o,o),HC(l,a,r),WC(l,l),GC(i,o,n),WC(i,i),bC(t,i,n,o,l,h),0}(a,e,m,l,h,c,d,u,p,o)){case 1:return void SC(rC,sC,t);case 2:return void FC(e,d,t)}!function(e,t,i,r,s,a,n,o,l){(function(e,t,i,r,s){!function(e,t,i,r,s){const{data:a,size:n}=e;NC(r,a),NC(s,r),i[0]=YC(CC,t),i[1]=i[0];for(let e=n;e<a.length;e+=n){const n=a[e]*t[0]+a[e+1]*t[1]+a[e+2]*t[2];n<i[0]&&(i[0]=n,NC(r,a,e)),n>i[1]&&(i[1]=n,NC(s,a,e))}}(e,t,gC,s,r);const a=YC(i,t);gC[1]-1e-6<=a&&(r[0]=void 0);gC[0]+1e-6>=a&&(s[0]=void 0)})(e,t,i,nC,oC),void 0!==nC[0]&&(HC(lC,nC,i),WC(lC,lC),HC(hC,nC,r),WC(hC,hC),HC(cC,nC,s),WC(cC,cC),GC(dC,hC,a),WC(dC,dC),GC(uC,cC,n),WC(uC,uC),GC(pC,lC,o),WC(pC,pC),bC(e,dC,a,hC,lC,l),bC(e,uC,n,cC,hC,l),bC(e,pC,o,lC,cC,l));void 0!==oC[0]&&(HC(lC,oC,i),WC(lC,lC),HC(hC,oC,r),WC(hC,hC),HC(cC,oC,s),WC(cC,cC),GC(dC,hC,a),WC(dC,dC),GC(uC,cC,n),WC(uC,uC),GC(pC,lC,o),WC(pC,pC),bC(e,dC,a,hC,lC,l),bC(e,uC,n,cC,hC,l),bC(e,pC,o,lC,cC,l))}(e,m,l,h,c,d,u,p,o),IC(e,o.b0,o.b1,o.b2,DC,AC);const g=[0,0,0];HC(g,AC,DC),o.quality=UC(g),o.quality<n?VC(o.b0,o.b1,o.b2,DC,AC,g,t):SC(rC,sC,t)}const nC=[0,0,0],oC=[0,0,0],lC=[0,0,0],hC=[0,0,0],cC=[0,0,0],dC=[0,0,0],uC=[0,0,0],pC=[0,0,0];const mC=[0,0,0];const gC=[0,0];const fC=[0,0,0],vC=[0,0,0],_C=[0,0,0],yC=[0,0,0],xC=[0,0,0],wC=[0,0,0];function bC(e,t,i,r,s,a){if(QC(t)<1e-6)return;GC(fC,i,t),GC(vC,r,t),GC(_C,s,t),TC(e,t,gC),xC[1]=gC[0],yC[1]=gC[1],wC[1]=yC[1]-xC[1];const n=[i,r,s],o=[fC,vC,_C];for(let i=0;i<3;++i){TC(e,n[i],gC),xC[0]=gC[0],yC[0]=gC[1],TC(e,o[i],gC),xC[2]=gC[0],yC[2]=gC[1],wC[0]=yC[0]-xC[0],wC[2]=yC[2]-xC[2];const r=UC(wC);r<a.quality&&(NC(a.b0,n[i]),NC(a.b1,t),NC(a.b2,o[i]),a.quality=r)}}const CC=[0,0,0];function TC(e,t,i){const{data:r,size:s}=e;i[0]=Number.POSITIVE_INFINITY,i[1]=Number.NEGATIVE_INFINITY;for(let e=0;e<r.length;e+=s){const s=r[e]*t[0]+r[e+1]*t[1]+r[e+2]*t[2];i[0]=Math.min(i[0],s),i[1]=Math.max(i[1],s)}}function SC(e,t,i){NC(i.center,e),BC(i.halfSize,t,.5),i.quaternion[0]=0,i.quaternion[1]=0,i.quaternion[2]=0,i.quaternion[3]=1}const PC=[0,0,0],RC=[0,0,0],MC=[0,0,0],DC=[0,0,0],AC=[0,0,0],OC=[0,0,0];function FC(e,t,i){NC(PC,t),Math.abs(t[0])>Math.abs(t[1])&&Math.abs(t[0])>Math.abs(t[2])?PC[0]=0:Math.abs(t[1])>Math.abs(t[2])?PC[1]=0:PC[2]=0,QC(PC)<1e-6&&(PC[0]=PC[1]=PC[2]=1),GC(RC,t,PC),WC(RC,RC),GC(MC,t,RC),WC(MC,MC),IC(e,t,RC,MC,DC,AC),HC(OC,AC,DC),VC(t,RC,MC,DC,AC,OC,i)}function IC(e,t,i,r,s,a){TC(e,t,gC),s[0]=gC[0],a[0]=gC[1],TC(e,i,gC),s[1]=gC[0],a[1]=gC[1],TC(e,r,gC),s[2]=gC[0],a[2]=gC[1]}const zC=[0,0,0],EC=[1,0,0,0,1,0,0,0,1],LC=[0,0,0];function VC(e,t,i,r,s,a,n){EC[0]=e[0],EC[1]=e[1],EC[2]=e[2],EC[3]=t[0],EC[4]=t[1],EC[5]=t[2],EC[6]=i[0],EC[7]=i[1],EC[8]=i[2],function(e,t){const i=t[0]+t[4]+t[8];if(i>0){let r=Math.sqrt(i+1);e[3]=.5*r,r=.5/r,e[0]=(t[5]-t[7])*r,e[1]=(t[6]-t[2])*r,e[2]=(t[1]-t[3])*r}else{let i=0;t[4]>t[0]&&(i=1),t[8]>t[3*i+i]&&(i=2);const r=(i+1)%3,s=(i+2)%3;let a=Math.sqrt(t[3*i+i]-t[3*r+r]-t[3*s+s]+1);e[i]=.5*a,a=.5/a,e[3]=(t[3*r+s]-t[3*s+r])*a,e[r]=(t[3*r+i]+t[3*i+r])*a,e[s]=(t[3*s+i]+t[3*i+s])*a}}(n.quaternion,EC),qC(LC,r,s),BC(LC,LC,.5),BC(n.center,e,LC[0]),BC(zC,t,LC[1]),qC(n.center,n.center,zC),BC(zC,i,LC[2]),qC(n.center,n.center,zC),BC(n.halfSize,a,.5)}class kC{constructor(e){this.minVert=new Array(7),this.maxVert=new Array(7);this.buffer=new ArrayBuffer(448);let t=0;this.minProj=new Float64Array(this.buffer,t,7),t+=56,this.maxProj=new Float64Array(this.buffer,t,7),t+=56;for(let e=0;e<7;++e)this.minVert[e]=new Float64Array(this.buffer,t,3),t+=24;for(let e=0;e<7;++e)this.maxVert[e]=new Float64Array(this.buffer,t,3),t+=24;for(let e=0;e<7;++e)this.minProj[e]=Number.POSITIVE_INFINITY,this.maxProj[e]=Number.NEGATIVE_INFINITY;const i=new Array(7),r=new Array(7),{data:s,size:a}=e;for(let e=0;e<s.length;e+=a){let t=s[e];t<this.minProj[0]&&(this.minProj[0]=t,i[0]=e),t>this.maxProj[0]&&(this.maxProj[0]=t,r[0]=e),t=s[e+1],t<this.minProj[1]&&(this.minProj[1]=t,i[1]=e),t>this.maxProj[1]&&(this.maxProj[1]=t,r[1]=e),t=s[e+2],t<this.minProj[2]&&(this.minProj[2]=t,i[2]=e),t>this.maxProj[2]&&(this.maxProj[2]=t,r[2]=e),t=s[e]+s[e+1]+s[e+2],t<this.minProj[3]&&(this.minProj[3]=t,i[3]=e),t>this.maxProj[3]&&(this.maxProj[3]=t,r[3]=e),t=s[e]+s[e+1]-s[e+2],t<this.minProj[4]&&(this.minProj[4]=t,i[4]=e),t>this.maxProj[4]&&(this.maxProj[4]=t,r[4]=e),t=s[e]-s[e+1]+s[e+2],t<this.minProj[5]&&(this.minProj[5]=t,i[5]=e),t>this.maxProj[5]&&(this.maxProj[5]=t,r[5]=e),t=s[e]-s[e+1]-s[e+2],t<this.minProj[6]&&(this.minProj[6]=t,i[6]=e),t>this.maxProj[6]&&(this.maxProj[6]=t,r[6]=e)}for(let e=0;e<7;++e){let t=i[e];NC(this.minVert[e],s,t),t=r[e],NC(this.maxVert[e],s,t)}}}class jC{constructor(){this.b0=[1,0,0],this.b1=[0,1,0],this.b2=[0,0,1],this.quality=0}}function UC(e){return e[0]*e[1]+e[0]*e[2]+e[1]*e[2]}function qC(e,t,i){e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2]}function HC(e,t,i){e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2]}function BC(e,t,i){e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i}function NC(e,t,i=0){e[0]=t[i+0],e[1]=t[i+1],e[2]=t[i+2]}function GC(e,t,i){const r=t[0],s=t[1],a=t[2],n=i[0],o=i[1],l=i[2];e[0]=s*l-a*o,e[1]=a*n-r*l,e[2]=r*o-s*n}function WC(e,t){const i=t[0]*t[0]+t[1]*t[1]+t[2]*t[2];if(i>0){const r=1/Math.sqrt(i);e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r}}function QC(e){return e[0]*e[0]+e[1]*e[1]+e[2]*e[2]}function ZC(e,t){const i=t[0]-e[0],r=t[1]-e[1],s=t[2]-e[2];return i*i+r*r+s*s}function YC(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}const XC=_n(),KC=fe(),JC=fe(),$C=vn();class eT{constructor(e){const t=56*e;this.buffer=new ArrayBuffer(t),this.obbs=new Array(e);for(let t=0;t<e;t++)this.obbs[t]={center:tt(this.buffer,56*t+0),halfSize:bn(this.buffer,56*t+24),quaternion:dc(this.buffer,56*t+36)}}}function tT(e=[0,0,0],t=[-1,-1,-1],i=[0,0,0,1]){return{center:Se(e),halfSize:wn(t),quaternion:cc(i)}}function iT(e){return tT(e.center,e.halfSize,e.quaternion)}function rT(e,t){ye(t.center,e.center),ye(t.halfSize,e.halfSize),hc(t.quaternion,e.quaternion)}function sT(e,t){return aC(e,t=t||tT()),t}function aT(e,t){const i=Po(t,e.center),r=dT(e,wo(t));return i>r?1:i<-r?-1:0}function nT(e,t){t||(t=$o());const i=pn($C,e.quaternion),r=e.halfSize[0]*Math.abs(i[0])+e.halfSize[1]*Math.abs(i[3])+e.halfSize[2]*Math.abs(i[6]),s=e.halfSize[0]*Math.abs(i[1])+e.halfSize[1]*Math.abs(i[4])+e.halfSize[2]*Math.abs(i[7]),a=e.halfSize[0]*Math.abs(i[2])+e.halfSize[1]*Math.abs(i[5])+e.halfSize[2]*Math.abs(i[8]);return t[0]=e.center[0]-r,t[1]=e.center[1]-s,t[2]=e.center[2]-a,t[3]=e.center[0]+r,t[4]=e.center[1]+s,t[5]=e.center[2]+a,t}function oT(e,t){return Po(t,e.center)-dT(e,wo(t))}function lT(e,t){return Po(t,e.center)+dT(e,wo(t))}function hT(e,t){return aT(e,t[0])<=0&&aT(e,t[1])<=0&&aT(e,t[2])<=0&&aT(e,t[3])<=0&&aT(e,t[4])<=0&&aT(e,t[5])<=0}function cT(e,t,i,r=0){lc(XC,e.quaternion),Te(KC,t,e.center);const s=$e(KC,KC,XC),a=$e(JC,i,XC);let n=-1/0,o=1/0;for(let t=0;t<3;t++)if(Math.abs(a[t])>1e-6){const i=(r+e.halfSize[t]-s[t])/a[t],l=(-r-e.halfSize[t]-s[t])/a[t];n=Math.max(n,Math.min(i,l)),o=Math.min(o,Math.max(i,l))}else if(s[t]>e.halfSize[t]+r||s[t]<-e.halfSize[t]-r)return!1;return n<=o}function dT(e,t){lc(XC,e.quaternion),$e(KC,t,XC);const i=e.halfSize;return Math.abs(KC[0]*i[0])+Math.abs(KC[1]*i[1])+Math.abs(KC[2]*i[2])}function uT(e,t){for(let i=0;i<8;++i){const r=t[i];r[0]=1&i?-e.halfSize[0]:e.halfSize[0],r[1]=2&i?-e.halfSize[1]:e.halfSize[1],r[2]=4&i?-e.halfSize[2]:e.halfSize[2],$e(r,r,e.quaternion),Pe(r,r,e.center)}}(()=>{const e=new Int8Array(162);let t=0;const i=i=>{for(let r=0;r<i.length;r++)e[t+r]=i[r];t+=6};i([6,2,3,1,5,4]),i([0,2,3,1,5,4]),i([0,2,3,7,5,4]),i([0,1,3,2,6,4]),i([0,1,3,2,0,0]),i([0,1,5,7,3,2]),i([0,1,3,7,6,4]),i([0,1,3,7,6,2]),i([0,1,5,7,6,2]),i([0,1,5,4,6,2]),i([0,1,5,4,0,0]),i([0,1,3,7,5,4]),i([0,2,6,4,0,0]),i([0,0,0,0,0,0]),i([1,3,7,5,0,0]),i([2,3,7,6,4,0]),i([2,3,7,6,0,0]),i([2,3,1,5,7,6]),i([0,1,5,7,6,2]),i([0,1,5,7,6,4]),i([0,1,3,7,6,4]),i([4,5,7,6,2,0]),i([4,5,7,6,0,0]),i([4,5,1,3,7,6]),i([0,2,3,7,5,4]),i([6,2,3,7,5,4]),i([6,2,3,1,5,4])})();class pT{constructor(e){this._totalCount=e,this._indexRanges=[0,e]}componentCount(){const e=this._indexRanges;let t=0;for(let i=0;i<e.length;i+=2)t+=e[i+1];return t}reset(e){"all"===e||e.length===this._totalCount?this._indexRanges=[0,this._totalCount]:this._indexRanges=function(e){const t=new Array;if(0===e.length)return t;let i=e[0],r=1;for(let s=1;s<e.length;s++){const a=e[s];i+r===a?r+=1:(t.push(i),t.push(r),i=a,r=1)}return t.push(i),t.push(r),t}(e)}forEachComponent(e){const t=this._indexRanges;for(let i=0;i<t.length;i+=2){const r=t[i],s=r+t[i+1];for(let t=r;t<s;t++)if(!e(t))return!1}return!0}forEachComponentRange(e){const t=this._indexRanges;for(let i=0;i<t.length;i+=2){const r=t[i];if(!e(r,r+t[i+1]))return!1}return!0}computeOffsetRanges(e){const t=new Array(this._indexRanges.length),i=this._indexRanges;for(let r=0;r<i.length;r+=2){const s=i[r],a=s+i[r+1],n=e[s],o=e[a];t[r]=n,t[r+1]=o-n}return t}}class mT extends Us{constructor(e,t){super(),this.pickability=null,this.highlightCounts=null,this.cachedGeometryRanges=null,this.cachedHighlightRanges=null,this.cachedDefaultRanges=null,this.offsets=V(t);const i=this.count;this.visibility=new pT(i),this.materialDataBuffer=e.getBuffer(i),this.materialDataIndices=new Uint16Array(i);for(let e=0;e<i;e++)this.materialDataIndices[e]=this.materialDataBuffer.acquireIndex()}dispose(){super.dispose();for(let e=0;e<this.count;e++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[e])}get count(){return this.offsets.length-1}get geometryRanges(){return M(this.cachedGeometryRanges)&&(this.cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets)),this.cachedGeometryRanges}get highlightRanges(){return M(this.highlightCounts)?null:(this.updateCachedHighlightRanges(),this.cachedHighlightRanges)}get defaultShadowMapRanges(){return M(this.highlightCounts)?this.geometryRanges:(this.updateCachedHighlightRanges(),this.cachedDefaultRanges)}highlightsDirty(){this.cachedHighlightRanges=null,this.cachedDefaultRanges=null}visibilityDirty(){this.cachedGeometryRanges=null,this.highlightsDirty()}updateCachedHighlightRanges(){if((M(this.cachedHighlightRanges)||M(this.cachedDefaultRanges))&&C(this.highlightCounts)){const{highlightRanges:e,defaultRanges:t}=function(e,t,i){const r=[],s=[];let a=i.length,n=i.length;t.forEachComponent((t=>(e[t]>0?(a!==t-1&&(r.length&&r.push(i[a+1]-r[r.length-1]),r.push(i[t])),a=t):(n!==t-1&&(s.length&&s.push(i[n+1]-s[s.length-1]),s.push(i[t])),n=t),!0))),r.length&&r.push(i[a+1]-r[r.length-1]);s.length&&s.push(i[n+1]-s[s.length-1]);return{highlightRanges:r,defaultRanges:s}}(this.highlightCounts,this.visibility,this.offsets);this.cachedHighlightRanges=e,this.cachedDefaultRanges=t}}}class gT extends Us{constructor(){super(...arguments),this.visible=0}}function fT(e,t,i,r){if(i>=t)return e;null==e&&(e=function(e=!0){return{isVisibleBit:!e,data:new Uint32Array(0)}}());const s=e.isVisibleBit;let a=e.data;const n=_T(a),o=i/n|0,l=i-n*o,h=(t-1)/n|0,c=a,d=r===s;if(!(i<c.length*n)&&d){const e=1.5,t=o+1,i=Math.ceil(c.length*e),r=h+1;let s=Math.max(t,i);s=Math.min(s,r),a=new Uint32Array(s),a.set(c)}return o<a.length&&(a[o]=function(e,t,i){return e&~(1<<t)|(i?1:0)<<t}(a[o],l,d)),e.data=a,e}function vT(e,t){if(null==e)return!0;const{isVisibleBit:i,data:r}=e,s=_T(r);return t<r.length*s?function(e,t,i,r){const s=i/r|0,a=i-s*r;return function(e,t){return 0!=(e&1<<t)}(t[s],a)===e}(i,r,t,s):!e.isVisibleBit}function _T(e){return 8*e.BYTES_PER_ELEMENT}e([qs()],gT.prototype,"renderable",void 0),e([qs()],gT.prototype,"components",void 0);class yT{constructor(e,t){this._indices=C(e.indices)?e.indices:uc(e.positions.length/3),this._positions=new ic(e.positions),this._components=t,this._componentIntersectionData=new Array(t.count)}getComponentAabb(e,t){if(C(this._perComponentAabbs)){for(let i=0;i<6;i++)t[i]=this._perComponentAabbs[6*e+i];return t}return this._computePerComponentAabbs(),this.getComponentAabb(e,t)}getComponentPositions(e,t){t.indices=this._indices,t.data=this._positions.typedBuffer,t.stride=this._positions.typedBufferStride,t.startIndex=this._components.offsets[e],t.endIndex=this._components.offsets[e+1]}intersect(e,t,i,r,s,a){const n={data:this._positions.typedBuffer,stride:this._positions.typedBufferStride,size:3},o=this._indices,l=this._components.offsets,h=Hs(e,t,xT);this._components.visibility.forEachComponent((c=>{if(!vT(this._components.pickability,c))return!0;const d=this.getComponentAabb(c,wT);if(C(s)&&s.applyToAabb(d),!Bs(d,e,h,i))return!0;const u=l[c]/3,p=l[c+1]/3,m=(e,t,i)=>{a(c,e,ke(t,t,r),i)},g=p-u;return M(s)&&g>40?(null==this._componentIntersectionData[c]&&(this._componentIntersectionData[c]=new pb(this._indices,u,p,n)),this._componentIntersectionData[c].intersectRay({r0:e,r1:t},m)):js(e,t,u,p,o,n,void 0,s,m),!0}))}_computePerComponentAabbs(){const e=this._components.count;this._perComponentAabbs=new Float32Array(6*e);for(let t=0;t<e;t++)this._computeAABB(t)}_computeAABB(e){const t=this._indices,i=this._positions,r=this._components.offsets,s=r[e],a=r[e+1],n=[0,0,0],o=[1/0,1/0,1/0],l=[-1/0,-1/0,-1/0];for(let e=s;e<a;e++){const r=t[e];i.getVec(r,n),it(o,o,n),rt(l,l,n)}let h=6*e;this._perComponentAabbs[h++]=o[0],this._perComponentAabbs[h++]=o[1],this._perComponentAabbs[h++]=o[2],this._perComponentAabbs[h++]=l[0],this._perComponentAabbs[h++]=l[1],this._perComponentAabbs[h]=l[2]}get positions(){return this._positions}get indices(){return this._indices}}const xT=fe(),wT=$o();class bT{constructor(e,t,i,r){this.material=e,this.drawParameters=t,this.geometry=i,this.meta=r}dispose(){this.material.dispose(),this.geometry.dispose()}}class CT extends Us{constructor(e,t,i,r){super(),this.primitiveType=t,this.parameters=i,this.indexed=r,this.vao=e}}function TT(e){return e?ST(e,1/0,-1/0):{near:1/0,far:-1/0}}function ST(e,t,i){return e.near=t,e.far=i,e}function PT(e,t,i=e){return i.near=Math.min(e.near,t.near),i.far=Math.max(e.far,t.far),i}function RT(e,t){return e.near<=t&&t<=e.far}e([qs()],CT.prototype,"vao",void 0);const MT={near:0,far:0};function DT(e,t){const i=TT(),{eye:r,frustum:s,viewForward:a}=e;t.forAll((e=>{const t=e.obb,n=Ie(Je(NT,t.center,r),a),o=dT(t,a);if(RT(i,n-o)&&RT(i,n+o))return;const l=function(e,t){let i=0;for(let r=0;r<qT;r++){const s=aT(e,t[r]);if(s>0)return-1;0===s&&(i|=1<<r)}return i}(t,s);if(-1===l)return;if(0===l)return OT.far=n+o,OT.near=n-o,void PT(i,OT);const h=AT.pushNew();h.near=n-o,h.far=n+o,h.mask=l,h.object=e}));for(let e=0;e<AT.length;e++){const t=AT.data[e];if(RT(i,t.near)&&RT(i,t.far))continue;OT.far=t.far,OT.near=1/0;const n=jT(t.object.obb,r,zT,(e=>{let i=ET;for(let r=0;r<qT&&e.length>0;r++){if(0==(t.mask&1<<r))continue;LT(s[r],e,i);const a=e;e=i,i=a}for(let t=0;t<e.length;t+=3){ve(FT,e.data[t+0],e.data[t+1],e.data[t+2]);const i=Ie(Je(FT,FT,r),a);OT.near=Math.min(OT.near,i)}}));0===n&&(OT.near=0),PT(i,OT)}return AT.length=0,i}const AT=new N({allocator:e=>e||{near:1/0,far:-1/0,mask:0,object:null},deallocator:e=>(e.object=null,e)}),OT=TT(),FT=fe(),IT=fe(),zT=new N({deallocator:null}),ET=new N({deallocator:null});function LT(e,t,i){i.length=0;const r=t.length-3;VT(FT,t,r);const s=Po(e,FT);s<=0&&(i.push(FT[0]),i.push(FT[1]),i.push(FT[2]));let a=0,n=s;for(;a<r;a+=3){VT(IT,t,a);const r=Po(e,IT);if(n*r<0){Oe(FT,IT,FT,r/(r-n)),kT(i,FT)}r<=0&&kT(i,IT),n=r,ye(FT,IT)}if(n*s<0){VT(IT,t,r);Oe(FT,IT,FT,s/(s-n)),kT(i,FT)}}function VT(e,t,i){return ve(e,t.data[i+0],t.data[i+1],t.data[i+2])}function kT(e,t){e.push(t[0]),e.push(t[1]),e.push(t[2])}function jT(e,t,i,r){lc(BT,e.quaternion),Je(NT,t,e.center),$e(NT,NT,BT);const s=8*((NT[0]<-e.halfSize[0]?-1:NT[0]>e.halfSize[0]?1:0)+3*(NT[1]<-e.halfSize[1]?-1:NT[1]>e.halfSize[1]?1:0)+9*(NT[2]<-e.halfSize[2]?-1:NT[2]>e.halfSize[2]?1:0)+13),a=UT[s];if(0===a)return a;pn(HT,e.quaternion),mn(HT,HT,e.halfSize);const n=(t,i)=>{const r=UT[s+i+1];return ve(t,((1&r)<<1)-1,(2&r)-1,((4&r)>>1)-1),ke(t,t,HT),Pe(t,e.center,t)};return i.length=0,kT(i,n(GT,0)),kT(i,n(WT,1)),kT(i,n(NT,2)),kT(i,n(QT,3)),r(i),1===a?a:(i.length=0,kT(i,GT),kT(i,QT),kT(i,n(NT,4)),kT(i,n(ZT,5)),r(i),2===a||(i.length=0,kT(i,GT),kT(i,ZT),kT(i,n(NT,6)),kT(i,WT),r(i)),a)}const UT=(()=>{const e=new Int8Array(216);let t=0;const i=i=>{for(let r=0;r<i.length;r++)e[t+r]=i[r];t+=8};return i([3,0,6,2,3,1,5,4]),i([2,0,2,3,1,5,4,0]),i([3,1,0,2,3,7,5,4]),i([2,0,1,3,2,6,4,0]),i([1,0,1,3,2,0,0,0]),i([2,1,5,7,3,2,0,0]),i([3,2,0,1,3,7,6,4]),i([2,2,0,1,3,7,6,0]),i([3,3,0,1,5,7,6,2]),i([2,0,1,5,4,6,2,0]),i([1,0,1,5,4,0,0,0]),i([2,1,3,7,5,4,0,0]),i([1,0,2,6,4,0,0,0]),i([0,0,0,0,0,0,0,0]),i([1,1,3,7,5,0,0,0]),i([2,2,3,7,6,4,0,0]),i([1,2,3,7,6,0,0,0]),i([2,3,1,5,7,6,2,0]),i([3,4,0,1,5,7,6,2]),i([2,5,7,6,4,0,1,0]),i([3,5,0,1,3,7,6,4]),i([2,4,5,7,6,2,0,0]),i([1,4,5,7,6,0,0,0]),i([2,5,1,3,7,6,4,0]),i([3,6,0,2,3,7,5,4]),i([2,6,2,3,7,5,4,0]),i([3,7,6,2,3,1,5,4]),e})(),qT=4;const HT=vn(),BT=_n(),NT=fe(),GT=fe(),WT=fe(),QT=fe(),ZT=fe();class YT{constructor(e){this._objects=e}submit(e,t){this._objects.preSubmit(t),this._objects.visibleObjects.forAll((t=>t.renderable.material.submit(e,t)))}queryShadowCasterDepthRange(e){return this._objects.visibleObjects.length?DT(e,this._objects.visibleObjects):null}}function XT(e){const t=Dn().vec3f("position");return e.normals&&t.vec2i16("normalCompressed",{glNormalized:!0}),1===e.textureCoordinates?t.vec2f("uv0"):2===e.textureCoordinates&&(t.vec2f("uv0"),t.vec4u16("uvRegion",{glNormalized:!0})),e.colors&&t.vec4u8("color",{glNormalized:!0}),t.alignTo(4)}function KT(e,t){1===t.componentData&&(e.vertex.uniforms.add("uComponentColorTex","sampler2D"),e.vertex.uniforms.add("uComponentColorTexInvDim","vec2"),e.attributes.add("componentIndex","float"),e.varyings.add("vExternalColorMixMode","mediump float"),e.varyings.add("vExternalColor","vec4"),e.include($r),e.vertex.code.add(us`vec4 _readComponentColor() {
float normalizedIndex = (componentIndex + 0.5) * uComponentColorTexInvDim.x;
vec2 indexCoord = vec2(
mod(normalizedIndex, 1.0),
(floor(normalizedIndex) + 0.5) * uComponentColorTexInvDim.y
);
return texture2D(uComponentColorTex, indexCoord);
}
vec4 forwardExternalColor(out bool castShadows) {
vec4 componentColor = _readComponentColor() * 255.0;
float shadowFlag = mod(componentColor.b * 255.0, 2.0);
componentColor.b -= shadowFlag;
castShadows = shadowFlag >= 1.0;
int decodedColorMixMode;
vExternalColor = decodeSymbolColor(componentColor, decodedColorMixMode) * 0.003921568627451;
vExternalColorMixMode = float(decodedColorMixMode) + 0.5;
return vExternalColor;
}`),e.fragment.code.add(us`void readExternalColor(out vec4 externalColor, out int externalColorMixMode) {
externalColor = vExternalColor;
externalColorMixMode = int(vExternalColorMixMode);
}`)),0===t.componentData&&(e.vertex.uniforms.add("uExternalColor","vec4"),e.fragment.uniforms.add("uExternalColorMixMode","int"),e.varyings.add("vExternalColor","vec4"),e.vertex.code.add(us`vec4 forwardExternalColor(out bool castShadows) {
vExternalColor = uExternalColor;
castShadows = true;
return uExternalColor;
}`),e.fragment.code.add(us`void readExternalColor(out vec4 externalColor, out int externalColorMixMode) {
externalColor = vExternalColor;
externalColorMixMode = uExternalColorMixMode;
}`))}function JT(e,t){const i=e.vertex;switch(i.code.add(us`#define VERTEX_DISCARD_CUTOFF (1.0 - 1.0 / 255.0)`),t.vertexDiscardMode){case 0:i.code.add(us`#define vertexDiscardByOpacity(_opacity_) {}`);break;case 2:i.code.add(us`#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ >  VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`);break;case 1:i.code.add(us`#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ <= VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`)}}function $T(e,t){e.include(pc,t),e.fragment.include(es);const i=e.fragment;i.uniforms.add("uBaseColor","vec4"),i.uniforms.add("uObjectOpacity","float"),t.attributeColor?i.code.add(us`vec3 _baseColor() {
return uBaseColor.rgb * vColor.rgb;
}
float _baseOpacity() {
return uBaseColor.a * vColor.a;
}`):i.code.add(us`vec3 _baseColor() {
return uBaseColor.rgb;
}
float _baseOpacity() {
return uBaseColor.a;
}`),i.code.add(us`vec4 computeMaterialColor(vec4 textureColor, vec4 externalColor, int externalColorMixMode) {
vec3 baseColor = _baseColor();
float baseOpacity = _baseOpacity();
vec3 color = mixExternalColor(
baseColor,
textureColor.rgb,
externalColor.rgb,
externalColorMixMode
);
float opacity = uObjectOpacity * mixExternalOpacity(
baseOpacity,
textureColor.a,
externalColor.a,
externalColorMixMode
);
return vec4(color, opacity);
}`)}function eS(e,t){const i=e.fragment;0===t.doubleSidedMode?i.code.add(us`vec3 _adjustDoublesided(vec3 normal) {
return normal;
}`):1===t.doubleSidedMode?(e.include(ts,t),i.uniforms.add("uTransform_ViewFromCameraLocal_T","vec3"),i.code.add(us`vec3 _adjustDoublesided(vec3 normal) {
vec3 viewDir = vPositionWorldCameraRelative + uTransform_ViewFromCameraLocal_T;
return dot(normal, viewDir) > 0.0 ? -normal : normal;
}`)):2===t.doubleSidedMode&&i.code.add(us`vec3 _adjustDoublesided(vec3 normal) {
return gl_FrontFacing ? normal : -normal;
}`),0===t.normalType||1===t.normalType?(e.include(is,t),i.code.add(us`vec3 shadingNormalWorld() {
return _adjustDoublesided(normalize(vNormalWorld));
}
vec3 shadingNormal_view() {
vec3 normal = normalize(vNormalView);
return gl_FrontFacing ? normal : -normal;
}`)):3===t.normalType?(e.extensions.add("GL_OES_standard_derivatives"),e.include(ts,t),i.code.add(us`vec3 shadingNormalWorld() {
return normalize(cross(
dFdx(vPositionWorldCameraRelative),
dFdy(vPositionWorldCameraRelative)
));
}
vec3 shadingNormal_view() {
return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view)));
}`)):2===t.normalType&&(1===t.viewingMode?(e.include(ts,t),i.code.add(us`vec3 shadingNormalWorld() {
return normalize(positionWorld());
}`)):2===t.viewingMode&&i.code.add(us`vec3 shadingNormalWorld() {
return vec3(0.0, 0.0, 1.0);
}`),e.extensions.add("GL_OES_standard_derivatives"),i.code.add(us`vec3 shadingNormal_view() {
return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view))).xyz;
}`))}function tS(e,t){const i=e.fragment;t.baseColorTexture?(e.include(rs,t),i.uniforms.add("uBaseColorTexture","sampler2D"),i.uniforms.add("uBaseColorTextureSize","vec2"),2===t.attributeTextureCoordinates?(e.include(ss),i.code.add(us`vec4 readBaseColorTexture() {
return textureAtlasLookup(
uBaseColorTexture,
uBaseColorTextureSize,
vuv0,
vuvRegion
);
}`)):i.code.add(us`vec4 readBaseColorTexture() {
return texture2D(uBaseColorTexture, vuv0);
}`)):i.code.add(us`vec4 readBaseColorTexture() { return vec4(1.0); }`)}const iS=new Map([["position",0],["normal",1],["normalCompressed",1],["color",2],["uv0",3],["uvRegion",4],["componentIndex",5]]);var rS=Object.freeze({__proto__:null,attributeLocations:iS,build:function(e){const t=new ds;t.include(ts,e),t.include(is,e),t.include(pc,e),t.include(Wr,e),t.include(hn,e),t.include(KT,e),t.include(Ns,e),t.include(Is,e),t.include(tS,e),t.include(JT,e),t.fragment.uniforms.add("view","mat4"),1!==e.pbrMode&&2!==e.pbrMode||(t.include(as,e),e.hasNormalTexture&&t.include(ns,e)),3===e.output&&1===e.componentData?t.vertex.code.add(us`#define discardShadows(castShadows) { if(!castShadows) { gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`):t.vertex.code.add(us`#define discardShadows(castShadows) {}`);const i=e.overlayEnabled&&0===e.output&&4===e.pbrMode;return e.overlayEnabled&&(t.include(yb,e),1===e.viewingMode?t.vertex.code.add(us`
      const float invEllipsoidRadius = ${us.float(1/(1===e.ellipsoidMode?Pi.radius:2===e.ellipsoidMode?Ri.radius:Mi.radius))};
      vec2 projectOverlay(vec3 pos) {
        return pos.xy / (1.0 + invEllipsoidRadius * pos.z);
      }
      `):t.vertex.code.add(us`vec2 projectOverlay(vec3 pos) { return pos.xy; }`)),i&&(t.varyings.add("tbnTangent","vec3"),t.varyings.add("tbnBiTangent","vec3"),t.varyings.add("groundNormal","vec3"),t.varyings.add("positionView","vec3")),t.vertex.code.add(us`
    void main() {
      bool castShadows;
      vec4 externalColor = forwardExternalColor(castShadows);
      discardShadows(castShadows);

      vertexDiscardByOpacity(externalColor.a);

      if (externalColor.a < ${us.float(Gs)}) {
        // Discard this vertex
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }
      forwardPosition();
      forwardNormal();
      ${i?us`
        positionView = position_view();
        ${1===e.viewingMode?us`
        groundNormal = normalize(positionWorld());
        tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), groundNormal));
        tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`:us`
        groundNormal = vec3(0.0, 0.0, 1.0);
        tbnTangent = vec3(1.0, 0.0, 0.0);
        tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`}
        `:""}

      ${e.overlayEnabled?us`setOverlayVTC(projectOverlay(position));`:""}
      forwardTextureCoordinates();
      forwardVertexColor();
      forwardLinearDepth(); // depends on forwardPosition()
    }
  `),7===e.output&&(t.fragment.include(ps),e.multipassTerrainEnabled&&t.include(Ws,e),t.include($T,e),t.fragment.code.add(us`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);
        ${e.multipassTerrainEnabled?us`terrainDepthTest(gl_FragCoord, vPosition_view.z);`:""}

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        vec4 externalColor;
        int externalColorMixMode;
        readExternalColor(externalColor, externalColorMixMode);

        vec4 materialColor = computeMaterialColor(
          textureColor,
          externalColor,
          externalColorMixMode
        );
        ${e.overlayEnabled?us`
        vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
        vec4 overlayColor = overlayOpacity * overlayColorOpaque;
        materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        gl_FragColor = vec4(materialColor.a);
      }
    `)),0===e.output&&(t.fragment.include(ps),e.multipassTerrainEnabled&&t.include(Ws,e),t.include($T,e),t.include(eS,e),t.include(Jr,e),i&&t.fragment.uniforms.add("ovNormalTex","sampler2D"),e.receiveShadows?(t.include(cn,e),t.fragment.code.add(us`float evaluateShadow() {
return readShadowMap(vPositionWorldCameraRelative, linearDepth);
}`)):t.fragment.code.add(us`float evaluateShadow() { return 0.0; }`),t.fragment.code.add(us`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);
        ${e.multipassTerrainEnabled?us`terrainDepthTest(gl_FragCoord, vPosition_view.z);`:""}

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        vec4 externalColor;
        int externalColorMixMode;
        readExternalColor(externalColor, externalColorMixMode);

        vec4 materialColor = computeMaterialColor(
          textureColor,
          externalColor,
          externalColorMixMode
        );
        ${e.overlayEnabled?us`
        vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
        vec4 overlayColor = overlayOpacity * overlayColorOpaque;
        materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}
    `),1===e.pbrMode||2===e.pbrMode?(t.fragment.code.add(us`
        ${1===e.pbrMode?us`
        applyPBRFactors();
        if (int(externalColorMixMode) == 3) {
          mrr = vec3(0.0, 0.6, 0.2);
        }`:""}
        vec3 normalVertex = shadingNormalWorld();
        float additionalIrradiance = 0.02 * lightingMainIntensity[2];
      `),e.hasNormalTexture?t.fragment.code.add(us`mat3 tangentSpace = computeTangentSpace(normalVertex, vPositionWorldCameraRelative, vuv0);
vec3 shadingNormal = computeTextureNormal(tangentSpace, vuv0);`):t.fragment.code.add(us`vec3 shadingNormal = normalVertex;`),t.fragment.code.add(us`${1===e.viewingMode?us`vec3 normalGround = normalize(positionWorld());`:us`vec3 normalGround = vec3(0.0, 0.0, 1.0);`}
      `),t.fragment.code.add(us`vec3 viewDir = normalize(vPositionWorldCameraRelative);
float ssao = 1.0 - occlusion * (1.0 - evaluateAmbientOcclusion());
vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());
vec4 shadedColor = vec4(evaluateSceneLightingPBR(shadingNormal, materialColor.rgb, evaluateShadow(), ssao, additionalLight, viewDir, normalGround, mrr, emission, additionalIrradiance), materialColor.a);`)):(e.receiveShadows?t.fragment.code.add(us`float shadow = evaluateShadow();`):1===e.viewingMode?t.fragment.code.add(us`float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());
float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);`):t.fragment.code.add(us`float shadow = 0.0;`),t.fragment.code.add(us`
      float ambientOcclusion = evaluateAmbientOcclusion();
      // At global scale we create some additional ambient light based on the main light to simulate global illumination
      vec3 additionalLight = evaluateAdditionalLighting(ambientOcclusion, positionWorld());
      vec4 shadedColor = vec4(evaluateSceneLighting(shadingNormalWorld(), materialColor.rgb, shadow, ambientOcclusion, additionalLight), materialColor.a);
      ${i?us`
          vec4 overlayWaterMask = getOverlayColor(ovNormalTex, vtcOverlay);
          float waterNormalLength = length(overlayWaterMask);
          if (waterNormalLength > 0.95) {
            mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, groundNormal);
            vec4 waterOverlayColor = vec4(overlayColorOpaque.xyz, overlayColor.w);
            vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vPositionWorldCameraRelative), shadow, groundNormal, tbnMatrix, positionView);
            vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
            // un-gamma the ground color to mix in linear space
            shadedColor = mix(shadedColor, waterColorNonLinear, waterColorLinear.w);
          }`:""}
      `)),t.fragment.code.add(us`
        gl_FragColor = highlightSlice(shadedColor, vPositionWorldCameraRelative);
        ${e.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),1!==e.output&&3!==e.output||(t.include(zs,e),t.fragment.code.add(us`void main() {
discardBySlice(vPositionWorldCameraRelative);
vec4 textureColor = readBaseColorTexture();
discardOrAdjustAlpha(textureColor);
outputDepth(linearDepth);
}`)),2===e.output&&(t.include(eS,e),t.fragment.code.add(us`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        // note: the alpha component needs to be 1.0 in order for this material
        // to influence ambient occlusion, see the ssao fragment shader
        float alpha = ${2===e.normalType?"0.0":"1.0"};
        gl_FragColor = vec4(vec3(.5) + .5 * shadingNormal_view(), alpha);
      }
    `)),4===e.output&&(t.include(Es),t.fragment.code.add(us`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        ${e.overlayEnabled?us`
        vec4 overlayColor = getCombinedOverlayColor();

        if (overlayColor.a == 0.0) {
          gl_FragColor = vec4(0.0);
          return;
        }`:""}

        outputHighlight();
      }
    `)),t}});class sS extends vs{bindPass(e){const t=this.program;ts.bindViewProjTransform(t,e.viewTransform),ks(this.program,this.configuration,e.slicePlane),0===e.identifier&&(void 0!==e.ssrParams&&wa(this.program,e.ssrParams),t.setUniformMatrix3fv("uTransformNormal_ViewFromGlobal",e.transformNormal_ViewFromGlobal),2===e.subPass&&t.setUniform2fv("cameraNearFar",e.cameraNearFar),0===e.subPass&&e.lighting.setUniforms(this.program,e.integratedMesh)),1===e.identifier&&this.program.setUniform2fv("cameraNearFar",e.cameraNearFar)}bindMaterial(e,t){const i=this.program;i.setUniform4fv("uBaseColor",e.baseColor),i.setUniform1f("uObjectOpacity",e.objectOpacity),i.setUniform1f("textureAlphaCutoff",e.alphaCutoff),1===e.componentParameters.type?e.componentParameters.texture.bind(i,"uComponentColorTex","uComponentColorTexInvDim"):(i.setUniform4fv("uExternalColor",e.componentParameters.externalColor),i.setUniform1i("uExternalColorMixMode",e.componentParameters.externalColorMixMode)),C(e.baseColorTexture)&&e.baseColorTexture.bind(i,"uBaseColorTexture","uBaseColorTextureSize"),0!==this.configuration.output&&7!==this.configuration.output||(os(this.program,e,this.configuration.isSchematic),C(e.metallicRoughnessTexture)&&e.metallicRoughnessTexture.bind(i,"texMetallicRoughness","texMetallicRoughnessSize"),C(e.emissionTexture)&&e.emissionTexture.bind(i,"texEmission","texEmissionSize"),C(e.occlusionTexture)&&e.occlusionTexture.bind(i,"texOcclusion","texOcclusionSize"),C(e.normalTexture)&&e.normalTexture.bind(i,"normalTexture","normalTextureSize")),e.isIntegratedMesh&&(0===t.identifier&&0===t.subPass?(i.bindTexture(e.overlayColor,"ovColorTex"),i.bindTexture(e.overlayNormal,"ovNormalTex")):2===t.identifier&&i.bindTexture(e.overlayHighlight,"ovColorTex"),i.setUniform1f("overlayOpacity",1)),2===t.identifier&&Qs(this.program,t),0===t.identifier&&0===t.subPass&&(t.ambientOcclusionEnabled&&t.bindAmbientOcclusion(i),t.shadowsEnabled&&t.bindShadowMap(i)),0!==t.identifier||0!==t.subPass&&1!==t.subPass||!t.multipassTerrainParams.multipassTerrainEnabled||(this.program.setUniform2fv("cameraNearFar",t.cameraNearFar),i.setUniform2fv("inverseViewport",t.inverseViewport),t.multipassTerrainParams.terrainLinearDepthTexture&&i.bindTexture(t.multipassTerrainParams.terrainLinearDepthTexture,"terrainDepthTexture"))}bindDraw(e,t){if(ts.bindModelTransform(this.program,e),this.program.setUniformMatrix3fv("uTransformNormal_GlobalFromModel",e.transformNormal_GlobalFromModel),this.program.rebindTextures(),t.isIntegratedMesh){const i=t.overlayTexScale,r=t.overlayTexOffset;this.program.setUniform4fv("overlayTexOffset",[e.toMapSpace[0]*i[0]+r[0],e.toMapSpace[1]*i[1]+r[1],e.toMapSpace[0]*i[2]+r[2],e.toMapSpace[1]*i[3]+r[3]]),this.program.setUniform4fv("overlayTexScale",[e.toMapSpace[2]*i[0],e.toMapSpace[3]*i[1],e.toMapSpace[2]*i[2],e.toMapSpace[3]*i[3]])}}initializeProgram(e){const t=sS.shader.get(),i=this.configuration,r=t.build({multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround,OITEnabled:0===i.transparencyPassType,output:i.output,normalType:0===i.integratedMeshMode?i.hasNormals?1:3:2,attributeColor:i.hasVertexColors,attributeTextureCoordinates:i.vertexTextureCoordinates,componentData:i.componentData,alphaDiscardMode:i.alphaDiscardMode,baseColorTexture:i.baseColorTexture,doubleSidedMode:i.doubleSidedMode,receiveAmbientOcclusion:i.receiveAmbientOcclusion,receiveShadows:i.receiveShadows,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,viewingMode:e.viewingMode,vertexDiscardMode:i.vertexDiscardMode,pbrMode:3===i.integratedMeshMode?4:i.usePBR?i.isSchematic?2:1:0,hasMetalnessAndRoughnessTexture:i.hasMetalnessAndRoughnessTexture,hasEmissionTexture:i.hasEmissionTexture,hasOcclusionTexture:i.hasOcclusionTexture,hasNormalTexture:i.hasNormalTexture,vertexTangents:!1,supportsTextureAtlas:!0,doublePrecisionRequiresObfuscation:ls(e.rctx),overlayEnabled:2===i.integratedMeshMode||3===i.integratedMeshMode,ssrEnabled:i.ssrEnabled,highStepCount:!1,ellipsoidMode:i.ellipsoidMode});return new _s(e.rctx,r,t.attributeLocations)}setPipelineState(e){const t=this.configuration,i=0!==t.integratedMeshMode,r=3===e,s=2===e;return Ea({blending:0!==t.output&&7!==t.output||!t.blendingEnabled?null:r?Zs:Ys(e),culling:Ga(t.cullFace),depthTest:{func:Xs(e)},depthWrite:r||s?Na:null,colorWrite:Va,stencilWrite:i||t.sceneHasOcludees?Ks:null,stencilTest:i?Js(1):t.sceneHasOcludees?$s:null,polygonOffset:r||s?t.polygonOffsetEnabled?{factor:2,units:2}:null:ea})}initializePipeline(){return this.setPipelineState(this.configuration.transparencyPassType)}}sS.shader=new gs(rS,(()=>Promise.resolve().then((function(){return rS}))));class aS extends ts.ModelTransform{constructor(){super(...arguments),this.transformNormal_GlobalFromModel=vn(),this.toMapSpace=nr()}}class nS extends fs{constructor(){super(...arguments),this.output=0,this.hasVertexColors=!1,this.hasNormals=!1,this.vertexTextureCoordinates=0,this.componentData=0,this.slicePlaneEnabled=!1,this.cullFace=2,this.baseColorTexture=!1,this.receiveAmbientOcclusion=!0,this.receiveShadows=!0,this.vertexDiscardMode=0,this.doubleSidedMode=2,this.blendingEnabled=!0,this.alphaDiscardMode=1,this.integratedMeshMode=0,this.ssrEnabled=!1,this.polygonOffsetEnabled=!1,this.usePBR=!1,this.isSchematic=!1,this.hasMetalnessAndRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.sceneHasOcludees=!1,this.transparencyPassType=3,this.ellipsoidMode=1,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}e([ms({count:8})],nS.prototype,"output",void 0),e([ms()],nS.prototype,"hasVertexColors",void 0),e([ms()],nS.prototype,"hasNormals",void 0),e([ms({count:3})],nS.prototype,"vertexTextureCoordinates",void 0),e([ms({count:2})],nS.prototype,"componentData",void 0),e([ms()],nS.prototype,"slicePlaneEnabled",void 0),e([ms({count:3})],nS.prototype,"cullFace",void 0),e([ms()],nS.prototype,"baseColorTexture",void 0),e([ms()],nS.prototype,"receiveAmbientOcclusion",void 0),e([ms()],nS.prototype,"receiveShadows",void 0),e([ms({count:3})],nS.prototype,"vertexDiscardMode",void 0),e([ms({count:3})],nS.prototype,"doubleSidedMode",void 0),e([ms()],nS.prototype,"blendingEnabled",void 0),e([ms({count:4})],nS.prototype,"alphaDiscardMode",void 0),e([ms({count:4})],nS.prototype,"integratedMeshMode",void 0),e([ms()],nS.prototype,"ssrEnabled",void 0),e([ms()],nS.prototype,"polygonOffsetEnabled",void 0),e([ms()],nS.prototype,"usePBR",void 0),e([ms()],nS.prototype,"isSchematic",void 0),e([ms()],nS.prototype,"hasMetalnessAndRoughnessTexture",void 0),e([ms()],nS.prototype,"hasEmissionTexture",void 0),e([ms()],nS.prototype,"hasOcclusionTexture",void 0),e([ms()],nS.prototype,"hasNormalTexture",void 0),e([ms()],nS.prototype,"sceneHasOcludees",void 0),e([ms({count:4})],nS.prototype,"transparencyPassType",void 0),e([ms({count:4})],nS.prototype,"ellipsoidMode",void 0),e([ms()],nS.prototype,"multipassTerrainEnabled",void 0),e([ms()],nS.prototype,"cullAboveGround",void 0);class oS{constructor(){this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){this._dirty=!1}get dirty(){return this._dirty}}function lS(e={}){return(t,i)=>{var r;const s=null!=(r=t._parameterCount)?r:0;if(t._parameterCount=s+1,e.vectorOps){const r=e.vectorOps;Object.defineProperty(t,i,{get(){return this[s]},set(e){const t=this[s];if(null==t)this[s]=e;else{if(r.equals(t,e))return;r.copy(t,e)}this._setDirty()}})}else Object.defineProperty(t,i,{get(){return this[s]},set(t){this[s]!==t&&(e.dispose&&this[s]&&this[s].dispose(),this[s]=t,this._setDirty())}})}}function hS(){return(e,t)=>{var i;const r=null!=(i=e._parameterCount)?i:0;e._parameterCount=r+1,e._parameterBlocks=e._parameterBlocks||[],e._parameterBlocks.push(r),Object.defineProperty(e,t,{get(){return this[r]},set(e){this[r]!==e&&(this[r]=e,this._setDirty())}})}}class cS extends class{constructor(){this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){if(this._dirty=!1,null!=this._parameterBlocks)for(const e of this._parameterBlocks)this[e]._setClean()}get dirty(){return this._dirty||this._checkParameterBlocksDirty()}_checkParameterBlocksDirty(){if(null==this._parameterBlocks)return!1;for(const e of this._parameterBlocks)if(this[e].dirty)return!0;return!1}}{constructor(){super(...arguments),this.baseColor=Dl(1,1,1,1),this.usePBR=!1,this.hasParametersFromSource=!1,this.mrrFactors=xn(1,1,.5),this.emissiveFactor=xn(0,0,0),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null,this.overlayTexOffset=or(-1,-1,-1,-1),this.overlayTexScale=or(0,0,0,0),this.overlayColor=null,this.overlayHighlight=null,this.overlayNormal=null,this.objectOpacity=1,this.commonMaterialParameters=new dS,this.componentParameters=new uS,this.alphaCutoff=ta,this.alphaDiscardMode=1,this.isIntegratedMesh=!1,this.polygonOffsetEnabled=!1,this.ellipsoidMode=1,this.sceneHasOcludees=!1,this._techniqueConfig=new nS}dispose(){this._technique=S(this._technique),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null}getTechnique(e,t,i){const r=this._techniqueConfig;if(r.hasVertexColors=i.colors,r.hasNormals=i.normals,r.vertexTextureCoordinates=i.textureCoordinates,r.usePBR=this.usePBR,r.hasMetalnessAndRoughnessTexture=C(this.metallicRoughnessTexture),r.hasEmissionTexture=C(this.emissionTexture),r.hasOcclusionTexture=C(this.occlusionTexture),r.hasNormalTexture=C(this.normalTexture),r.transparencyPassType=0===t.identifier&&null!=t.transparencyPassType?t.transparencyPassType:3,r.multipassTerrainEnabled=0===t.identifier&&null!=t.multipassTerrainParams&&t.multipassTerrainParams.multipassTerrainEnabled,r.cullAboveGround=0===t.identifier&&null!=t.multipassTerrainParams&&t.multipassTerrainParams.cullAboveGround,r.ellipsoidMode=this.ellipsoidMode,this.dirty){r.componentData=this.componentParameters.type,r.cullFace=this.commonMaterialParameters.cullFace,r.doubleSidedMode=this.commonMaterialParameters.doubleSided?1:0,r.baseColorTexture=C(this.baseColorTexture),r.isSchematic=this.hasParametersFromSource&&!C(this.baseColorTexture);const e=this._computeWhichMaterialPass();r.blendingEnabled=1===e||2===e,r.alphaDiscardMode=this.alphaDiscardMode,r.integratedMeshMode=this.isIntegratedMesh?this.overlayColor?this.overlayNormal?3:2:1:0,r.polygonOffsetEnabled=this.polygonOffsetEnabled,this._setClean()}return r.slicePlaneEnabled=t.slicePlaneEnabled&&this.commonMaterialParameters.slicePlaneEnabled,1===t.identifier?(r.output=3,r.vertexDiscardMode=0):2===t.identifier?(r.output=4,r.vertexDiscardMode=0):(2===this._computeWhichMaterialPass()?r.vertexDiscardMode=t.transparent?2:1:r.vertexDiscardMode=0,r.output=function(e){switch(e){case 0:return 0;case 1:return 7;case 2:return 1;case 3:return 2}}(t.subPass),1===t.subPass&&(r.sceneHasOcludees=t.sceneHasOcludees),0===t.subPass?(r.receiveAmbientOcclusion=t.ambientOcclusionEnabled,r.sceneHasOcludees=t.sceneHasOcludees,r.receiveShadows=t.shadowsEnabled,r.ssrEnabled=t.ssrParams.ssrEnabled):(r.receiveAmbientOcclusion=!1,r.receiveShadows=!1)),this._technique=e.releaseAndAcquire(sS,r,this._technique),this._technique}submit(e,t){if(0===this.objectOpacity)return;const i=t.renderable.geometry,r=t.components,s=t.renderable.drawParameters,a=t.renderable.meta.cameraDepthSquared,n=r.geometryRanges,o=r.highlightRanges,l=r.defaultShadowMapRanges;switch(this._computeWhichMaterialPass()){case 0:e.materialOpaque.submitDraw(this,i,n,s,a);break;case 1:e.materialTransparent.submitDraw(this,i,n,s,a);break;case 2:e.materialOpaque.submitDraw(this,i,n,s,a),e.materialTransparent.submitDraw(this,i,n,s,a);break;case 3:e.materialIntegratedMesh.submitDraw(this,i,n,s,a),this.overlayHighlight&&e.highlightIntegratedMesh.submitDraw(this,i,n,s,a)}const h=2!==this.componentParameters.castShadows;h&&e.shadowMap.submitDraw(this,i,n,s,a),C(o)&&(e.highlight.submitDraw(this,i,o,s,a),h&&e.highlightShadowMap.submitDraw(this,i,o,s,a)),h&&C(l)&&e.defaultShadowMap.submitDraw(this,i,l,s,a)}get attributeLocations(){return iS}_computeWhichMaterialPass(){return this.isIntegratedMesh?3:this.objectOpacity<1?1:0===this.componentParameters.opaqueOverride?0:this.baseColor[3]<1||0===this.alphaDiscardMode||3===this.alphaDiscardMode?1:2===this.componentParameters.transparent?0:0===this.componentParameters.transparent?1:2}}e([lS({vectorOps:nt})],cS.prototype,"baseColor",void 0),e([lS()],cS.prototype,"usePBR",void 0),e([lS()],cS.prototype,"hasParametersFromSource",void 0),e([lS({vectorOps:st})],cS.prototype,"mrrFactors",void 0),e([lS({vectorOps:st})],cS.prototype,"emissiveFactor",void 0),e([lS({dispose:!0})],cS.prototype,"baseColorTexture",void 0),e([lS({dispose:!0})],cS.prototype,"metallicRoughnessTexture",void 0),e([lS({dispose:!0})],cS.prototype,"emissionTexture",void 0),e([lS({dispose:!0})],cS.prototype,"occlusionTexture",void 0),e([lS({dispose:!0})],cS.prototype,"normalTexture",void 0),e([lS({vectorOps:{equals:at,copy:Ke}})],cS.prototype,"overlayTexOffset",void 0),e([lS({vectorOps:{equals:at,copy:Ke}})],cS.prototype,"overlayTexScale",void 0),e([lS()],cS.prototype,"overlayColor",void 0),e([lS()],cS.prototype,"overlayHighlight",void 0),e([lS()],cS.prototype,"overlayNormal",void 0),e([lS()],cS.prototype,"objectOpacity",void 0),e([hS()],cS.prototype,"commonMaterialParameters",void 0),e([hS()],cS.prototype,"componentParameters",void 0),e([lS()],cS.prototype,"alphaCutoff",void 0),e([lS()],cS.prototype,"alphaDiscardMode",void 0),e([lS()],cS.prototype,"isIntegratedMesh",void 0),e([lS()],cS.prototype,"polygonOffsetEnabled",void 0),e([lS()],cS.prototype,"ellipsoidMode",void 0),e([lS()],cS.prototype,"sceneHasOcludees",void 0);class dS extends oS{constructor(){super(...arguments),this.doubleSided=!1,this.cullFace=2,this.slicePlaneEnabled=!0}}e([lS()],dS.prototype,"doubleSided",void 0),e([lS()],dS.prototype,"cullFace",void 0),e([lS()],dS.prototype,"slicePlaneEnabled",void 0);class uS extends oS{constructor(){super(...arguments),this.externalColor=Dl(1,1,1,1),this.externalColorMixMode=1,this.castShadows=0}get transparent(){return this.externalColor[3]<1?0:2}get opaqueOverride(){return 3===this.externalColorMixMode&&1===this.externalColor[3]?0:2}get visible(){return this.externalColor[3]>0?0:2}get type(){return 0}}e([lS({vectorOps:nt})],uS.prototype,"externalColor",void 0),e([lS()],uS.prototype,"externalColorMixMode",void 0),e([lS()],uS.prototype,"castShadows",void 0);class pS extends oS{constructor(){super(...arguments),this.texture=null,this.transparent=2,this.opaqueOverride=2,this.castShadows=2}get type(){return 1}}e([lS()],pS.prototype,"texture",void 0),e([lS()],pS.prototype,"transparent",void 0),e([lS()],pS.prototype,"opaqueOverride",void 0),e([lS()],pS.prototype,"castShadows",void 0);class mS{constructor(e){this._low=Cn(),this._high=Cn(),e&&this.set(e)}get low(){return this._low}get high(){return this._high}set(e){const t=this._low,i=this._high;ye(t,e),Je(i,e,t)}setElements(e,t,i){ve(gS,e,t,i),this.set(gS)}get(e){return Pe(e,this._low,this._high)}getLowScaled(e){return Ce(e,this._low,1)}}const gS=fe();class fS{constructor(e){this.maxCount=e,this._nextIndex=0,this.recycledIndices=[]}get activeCount(){return this._nextIndex-this.recycledIndices.length}get availableCount(){return this.recycledIndices.length+this.maxCount-this._nextIndex}acquire(){return this.recycledIndices.length>0?this.recycledIndices.pop():this.availableCount?this._nextIndex++:void 0}release(e){this.recycledIndices.push(e)}}class vS{constructor(e,t=1){this.rctx=e,this.fieldCount=t,this.textureWidth=4096,this.dirty=!0,this.texture=new Pn(this.rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,width:this.textureWidth,height:1,flipped:!1}),this.data=new rc(new ArrayBuffer(4*this.textureWidth))}dispose(){this.texture.dispose(),this.texture=void 0,this.data=void 0}setData(e,t,i,r,s,a){const n=e*this.fieldCount+t;this.dirty=!0,this.data.set(n,0,i),this.data.set(n,1,r),this.data.set(n,2,s),this.data.set(n,3,a)}setDataElement(e,t,i,r){const s=e*this.fieldCount+t;this.dirty=!0,this.data.set(s,i,r)}resizeToFit(e){const t=e*this.fieldCount;if(t>=this.data.count){const e=Math.ceil((t+1)/this.textureWidth)*this.textureWidth,i=new rc(new ArrayBuffer(4*e));i.typedBuffer.set(this.data.typedBuffer),this.data=i}}updateTexture(){if(!this.dirty)return;const e=this.texture.descriptor.width,t=this.texture.descriptor.height;this.data.count>e*t&&this.texture.resize(e,this.data.count/e),this.texture.setData(this.data.typedBuffer),this.dirty=!1}bind(e,t,i){e.bindTexture(this.texture,t),e.setUniform2f(i,1/this.texture.descriptor.width,1/this.texture.descriptor.height)}}class _S{constructor(e,t=1){this.textureBuffer=new vS(e,t),this.indexManager=new fS(65536)}dispose(){this.textureBuffer.dispose(),this.textureBuffer=void 0}get availableCount(){return this.indexManager.availableCount}get activeCount(){return this.indexManager.activeCount}acquireIndex(){const e=this.indexManager.acquire();return this.textureBuffer.resizeToFit(e),e}releaseIndex(e){this.indexManager.release(e)}}class yS{constructor(e,t=1){this.rctx=e,this.fieldCount=t,this.buffers=[]}garbageCollect(){this.buffers=this.buffers.filter((e=>0!==e.activeCount||(e.dispose(),!1)))}destroy(){this.buffers.forEach((e=>e.dispose())),this.buffers=[]}getBuffer(e){for(const t of this.buffers)if(t.availableCount>=e)return t;if(e>65536)return null;const t=new _S(this.rctx,this.fieldCount);return this.buffers.push(t),t}updateTextures(){for(const e of this.buffers)e.textureBuffer.updateTexture()}}const xS=U.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");class wS{constructor(e){this._renderManager=e,this._objects=[new N,new N],this._renderSubmit=new YT(this),this._renderManager.register(this._renderSubmit),this._componentBufferManager=new yS(e.rctx)}dispose(){Fn(0===this._objects[0].length&&0===this._objects[1].length,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy()}createObject(e){const t=new gT;return t.toMapSpace=e.toMapSpace.slice(),t.transform=e.transform,t.obb=iT(e.obb),t.components=new mT(this._componentBufferManager,e.geometry.componentOffsets),t.renderable=this._createRenderable(e,t.components),t.intersectionGeometry=new yT(e.geometry.positionData,t.components),this._objects[t.visible].push(t),t}destroyObject(e){const t=e;this._objects[t.visible].removeUnordered(t),t.dispose(),this._notifyDirty()}setObjectVisibility(e,t){const i=e;t!==i.visible&&(this._objects[i.visible].removeUnordered(i),this._objects[t].push(i),i.visible=t,this._notifyDirty())}preSubmit(e){const t=e.camera.eye;this.visibleObjects.forAll((e=>{const i=je(t,e.obb.center);e.renderable.meta.cameraDepthSquared=i}))}getMaterial(e){return e.renderable.material}updateMaterial(e,t){const i=e.renderable.material;t(i),i.dirty&&this._notifyDirty()}setAllComponentVisibilities(e,t){const i=e;i.components.visibility.reset(t),i.components.visibilityDirty(),this._notifyDirty()}forEachVisibleComponent(e,t){return e.components.visibility.forEachComponent(t)}getComponentCount(e){const t=e,i=t.components.visibility.componentCount();return{visible:i,invisible:t.components.count-i}}setComponentData(e,t){const i=e,r=i.renderable.material;if(function(e){return"function"==typeof e}(t)){const e=i.components,s=e.materialDataBuffer,a=e.materialDataIndices,n={castShadows:!0,pickable:!0,externalColor:Al(),externalColorMixMode:1},o=s.textureBuffer,l=new Uint8Array(4),h=new Uint32Array(l.buffer);let c=0,d=0,u=0,p=!1,m=0;for(let i=0;i<e.count;i++)t(i,n),c+=+(n.externalColor[3]<1),d+=+(3===n.externalColorMixMode&&1===n.externalColor[3]),u+=+n.castShadows,lo(n.externalColor,n.externalColorMixMode,l),l[2]=254&l[2]|+n.castShadows,o.setData(a[i],0,l[0],l[1],l[2],l[3]),p=p||i>0&&m!==h[0],m=h[0],n.pickable!==vT(e.pickability,i)&&(e.pickability=fT(e.pickability,e.count,i,n.pickable));p?(r.componentParameters=new pS,r.componentParameters.castShadows=CS(u,e.count),r.componentParameters.transparent=CS(c,e.count),r.componentParameters.opaqueOverride=CS(d,e.count),r.componentParameters.texture=o,o.updateTexture()):(r.componentParameters=new uS,r.componentParameters.castShadows=n.castShadows?0:2,r.componentParameters.externalColor=n.externalColor,r.componentParameters.externalColorMixMode=n.externalColorMixMode)}else r.componentParameters=new uS,r.componentParameters.castShadows=t.castShadows?0:2,r.componentParameters.externalColor=t.externalColor,r.componentParameters.externalColorMixMode=t.externalColorMixMode;this._notifyDirty()}getComponentAabb(e,t,i){return e.intersectionGeometry.getComponentAabb(t,i)}getComponentObb(e){return e.obb}getObjectTransform(e){return e.transform}getComponentPositions(e,t,i){return e.intersectionGeometry.getComponentPositions(t,i)}intersect(e,t,i,r,s,a){const n=e;C(s)&&(s.localOrigin=n.transform.position);const o=gn(TS,n.transform.rotationScale);Je(SS,t,n.transform.position),Je(PS,i,n.transform.position),ke(SS,SS,o),ke(PS,PS,o);const l=un(TS,o);return n.intersectionGeometry.intersect(SS,PS,r,l,s,a)}addEdges(e,t,i,r){const s=e,{indices:a,positions:n}=s.intersectionGeometry,o=s.components.offsets;return t.addComponentObject(e,s.transform,{center:s.obb.center,radius:(l=s.obb,et(l.halfSize))},n,a,o,i,r);var l}addComponentHighlight(e,t){const i=e.components;M(i.highlightCounts)&&(i.highlightCounts=new Uint32Array(i.count+1));0===i.highlightCounts[t]++&&(i.highlightsDirty(),this._notifyDirty()),i.highlightCounts[i.count]++}removeComponentHighlight(e,t){const i=e.components;if(M(i.highlightCounts))return void xS.warn("Removing non-existing highlight.");const r=i.highlightCounts[t],s=i.highlightCounts[i.count];if(0!==r){if(r>1)return i.highlightCounts[t]=r-1,void(i.highlightCounts[i.count]=s-1);i.highlightCounts[t]=0,i.highlightsDirty(),this._notifyDirty(),1===s?i.highlightCounts=null:i.highlightCounts[i.count]=s-1}else xS.warn("Removing non-existing highlight.")}clearHighlights(e){const t=e.components;C(t.highlightCounts)&&(t.highlightCounts=null,t.highlightsDirty(),this._notifyDirty())}getObjectGPUMemoryUsage(e){return e.renderable.meta.gpuMemoryEstimate}get visibleObjects(){return this._objects[1]}_createRenderable(e,t){const i=this._renderManager.rctx,r=e.geometry,s=r.vertices.layoutParameters,a=Ha.createVertex(i,35044,r.vertices.data),n=k(r.indices,(e=>Ha.createIndex(i,35044,e))),o=Mn(XT(s)),l=new Uint16Array(r.vertices.count);for(let e=0;e<t.count;e++){const i=t.offsets[e],s=t.offsets[e+1],a=t.materialDataIndices[e];if(C(r.indices))for(let e=i;e<s;e++){l[r.indices[e]]=a}else for(let e=i;e<s;e++)l[e]=a}const h=Ha.createVertex(i,35044,l.buffer),c=new mS(e.transform.position),d=oc(e.transform.rotationScale);gn(d,d),un(d,d);const u=new aS;ye(u.worldFromModel_TL,c.low),ye(u.worldFromModel_TH,c.high),fn(u.worldFromModel_RS,e.transform.rotationScale),fn(u.transformNormal_GlobalFromModel,d),Ke(u.toMapSpace,e.toMapSpace);const p=new cS,m=new qa(i,p.attributeLocations,{data:o,componentIndices:bS},{data:a,componentIndices:h},z(n)),g=new CT(m,4,s,C(n)),f={cameraDepthSquared:.5,gpuMemoryEstimate:a.byteSize+h.byteSize+(C(n)?n.byteSize:0)};return new bT(p,u,g,f)}_notifyDirty(){this._renderManager.notifyDirty()}}const bS=Mn(Dn().u16("componentIndex"));function CS(e,t){return e===t?0:0===e?2:1}const TS=nc(),SS=fe(),PS=fe();var RS=Object.freeze({__proto__:null,build:function(e){const t=new ds;return t.include(Xo),t.fragment.uniforms.add("tex","sampler2D"),0===e.function&&(e.hasOpacityFactor?(t.fragment.uniforms.add("opacity","float"),t.fragment.code.add(us`void main() {
gl_FragColor = texture2D(tex, uv) * opacity;
}`)):t.fragment.code.add(us`void main() {
gl_FragColor = texture2D(tex, uv);
}`)),3===e.function&&(t.fragment.uniforms.add("overlayIdx","int"),e.hasOpacityFactor&&t.fragment.uniforms.add("opacity","float"),t.fragment.code.add(us`
      void main() {
        vec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5+ 0.5, uv.y);
        gl_FragColor = texture2D(tex, overlayUV) ${e.hasOpacityFactor?"* opacity":""};
      }`)),1===e.function&&t.fragment.code.add(us`void main() {
gl_FragColor = vec4(1.0 - texture2D(tex, uv).a);
}`),2===e.function&&(t.fragment.uniforms.add("colorTexture","sampler2D"),t.fragment.uniforms.add("alphaTexture","sampler2D"),t.fragment.uniforms.add("frontFaceTexture","sampler2D"),t.fragment.code.add(us`void main() {
vec4 srcColor = texture2D(colorTexture, uv);
float srcAlpha = texture2D(alphaTexture, uv).r;
vec4 frontFace = texture2D(frontFaceTexture, uv);
if(srcColor.a <= 1e-5){
discard;
}
gl_FragColor = vec4(mix(srcColor.rgb/srcColor.a, frontFace.rgb, frontFace.a), 1.0 - srcAlpha);
}`)),t}});class MS extends vs{initializeProgram(e){const t=MS.shader.get().build(this.configuration);return new _s(e.rctx,t,ys)}initializePipeline(){if(1===this.configuration.function)return Ea({colorWrite:{r:!1,g:!0,b:!1,a:!1}});switch(this.configuration.alphaMode){case 0:return Ea({colorWrite:Va});case 1:return Ea({blending:La(770,1,771,771),colorWrite:Va});default:return Ea({blending:ka(1,771),colorWrite:Va})}}}MS.shader=new gs(RS,(()=>Promise.resolve().then((function(){return RS}))));class DS extends fs{constructor(){super(...arguments),this.function=0,this.alphaMode=0,this.hasOpacityFactor=!1}}e([ms({count:4})],DS.prototype,"function",void 0),e([ms({count:3})],DS.prototype,"alphaMode",void 0),e([ms()],DS.prototype,"hasOpacityFactor",void 0);class AS{constructor(e,t){this._rctx=e,this._techniqueRepository=t}dispose(){this._vao=P(this._vao)}compositeTransparent(e,t,i,r=1){const s=this._rctx;OS.alphaMode=1,OS.function=2,OS.hasOpacityFactor=1!==r;const a=this._techniqueRepository.acquire(MS,OS);s.useProgram(a.program),a.bindPipelineState(s),a.program.bindTexture(e,"colorTexture"),a.program.bindTexture(t,"alphaTexture"),a.program.bindTexture(i,"frontFaceTexture");const n=this.ensureVAO();s.bindVAO(n),s.drawArrays(5,0,Ua(n,"geometry")),a.release()}compositeSpecial(e,t){this.composite(e,0,1,t)}composite(e,t=0,i=1,r=0,s=0){const a=this._rctx;OS.alphaMode=t,OS.function=r,OS.hasOpacityFactor=1!==i;const n=this._techniqueRepository.acquire(MS,OS);a.useProgram(n.program),n.bindPipelineState(a),n.program.bindTexture(e,"tex"),OS.hasOpacityFactor&&n.program.setUniform1f("opacity",i),3===r&&n.program.setUniform1i("overlayIdx",s);const o=this.ensureVAO();a.bindVAO(o),a.drawArrays(5,0,Ua(o,"geometry")),n.release()}ensureVAO(){return M(this._vao)&&(this._vao=xs(this._rctx)),this._vao}}const OS=new DS;function FS(e,t,i){return zn(t,e)*(i[1]-i[0])+i[0]}function IS(e,t,i){if(t.size<1e4)return HS.compute(e,t);const r=TT();return i.forAll((t=>{t.isVisible&&PT(r,function(e,t){if(!t.isVisible)return;const i=TT(),r=t.getSpatialQueryAccelerator();C(r)?function(e,t,i){const r=t.eye,s=t.viewForward,a=t.frustum,n=e=>e.isVisible,o=i.objectCount;if(o<500)ST(US,t.near,Math.min(e.near,t.far)),i.forEachInDepthRange(r,s,1,US,((i,r)=>{zS(e,t,i),US.far=e.near,r.setRange(US)}),a,n),ST(US,Math.max(e.far,t.near),t.far),i.forEachInDepthRange(r,s,-1,US,((i,r)=>{zS(e,t,i),US.near=e.far,r.setRange(US)}),a,n);else{const r=Math.max(Math.min(o,500),Math.ceil(.1*o)),l=i.findClosest(s,1,a,n,r),h=i.findClosest(s,-1,a,n,r);l&&h&&(LS(e,t,l.boundingVolumeWorldSpace.bounds),LS(e,t,h.boundingVolumeWorldSpace.bounds))}}(i,e,r):function(e,t,i){if(qS.clear(),i.forAll((e=>{e.isVisible&&0!==e.getNumGeometryRecords()&&qS.add(e)})),qS.empty)return;qS.sort(t),ST(US,t.near,Math.min(e.near,t.far)),qS.forEachInDepthRange(US,1,((i,r)=>{r<e.near&&zS(e,t,i)})),ST(US,Math.max(e.far,t.near),t.far),qS.forEachInDepthRange(US,-1,((t,i,r)=>{e.far=Math.max(e.far,r)}))}(i,e,t.objects);return i}(e,t))})),r}function zS(e,t,i){if(!i.isVisible)return;if(!gl(t.frustum,i.boundingVolumeWorldSpace.bounds))return;const r=i.transformation,s=jS;i.geometryRecords.forEach((i=>{Cr(s,r,i.getShaderTransformation());const a=Ei(s);ES(e,t,i.geometry.boundingInfo,s,a)}))}function ES(e,t,i,r,s){if(M(i))return;const a=t.eye,n=t.viewForward;Le(kS,i.center,r);const o=n[0]*(kS[0]-a[0])+n[1]*(kS[1]-a[1])+n[2]*(kS[2]-a[2]);if(kS[3]=i.radius*s,!(o-kS[3]>e.near&&o+kS[3]<e.far)&&gl(t.frustum,kS))if(i.radius>100&&i.getChildren()){const a=i.getChildren();for(let i=0;i<8;++i)a[i]&&ES(e,t,a[i],r,s)}else BS.unionDepthRangeWithAABB(e,t.viewProjectionMatrix,r,i.bbMin,i.bbMax)}function LS(e,t,i){const r=t.eye,s=t.viewForward,a=(i[0]-r[0])*s[0]+(i[1]-r[1])*s[1]+(i[2]-r[2])*s[2];e.near=Math.min(e.near,a-i[3]),e.far=Math.max(e.far,a+i[3])}const VS=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],kS=$a(),jS=Ar(),US=TT(),qS=new class{constructor(){this._items=new N({allocator:e=>e||{obj:null,distance:0,near:0,far:0},deallocator:e=>(e.obj=null,e.distance=0,e.near=0,e.far=0,e)})}get length(){return this._items.length}get empty(){return 0===this._items.length}clear(){this._items.clear()}add(e){this._items.pushNew().obj=e}sort(e){const t=e.eye,i=e.viewForward;this._items.forAll((e=>{const r=e.obj.boundingVolumeWorldSpace.bounds,s=(r[0]-t[0])*i[0]+(r[1]-t[1])*i[1]+(r[2]-t[2])*i[2];e.distance=s,e.near=s-r[3],e.far=s+r[3]})),this._items.sort(((e,t)=>e.distance-t.distance))}forEachInDepthRange(e,t,i){if(1===t)for(let t=0;t<this._items.length;++t){const r=this._items.data[t];r.far<e.near||r.near>e.far||i(r.obj,r.near,r.far)}else for(let t=this._items.length-1;t>=0;--t){const r=this._items.data[t];r.far<e.near||r.near>e.far||i(r.obj,r.near,r.far)}}},HS=new class{constructor(){this.view=Ar(),this.viewProj=Ar(),this.frustum=dl(),this.geometries=[],this.near=[],this.far=[],this.nearCandidates=[],this.farCandidates=[],this.range={near:0,far:0},this.looseRange={near:0,far:0}}compute(e,t){this.reset(),wr(this.view,e.viewMatrix),Cr(this.viewProj,e.projectionMatrix,this.view),wl(e.frustum,this.frustum);const i=this.view,r=i[2],s=i[6],a=i[10],n=i[14],o=this.range;let l=0;if(t.forEach((e=>{if(!e.instanceParameters.visible)return;if(!e.castShadow)return;let t;e.hasShaderTransformation?(e.computeBoundingSphere(e.getShaderTransformation(),kS,1),t=kS):t=e.boundingSphere;const i=r*t[0]+s*t[1]+a*t[2]+n,o=i-t[3],h=i+t[3];this.geometries[l]=e,this.near[l]=-h,this.far[l]=-o,++l})),0===this.geometries.length)return o;for(let e=0;e<this.geometries.length;++e)this.near[e]>o.far&&(o.far=this.near[e]),this.near[e]>2&&this.far[e]<o.near&&(o.near=this.far[e]);const h=this.looseRange;h.near=Math.max(.5*o.near,2),h.far=2*o.far;let c=0,d=0;for(let e=0;e<this.geometries.length;++e)this.near[e]<o.near&&(this.near[e]>=h.near?o.near=this.near[e]:this.nearCandidates[c++]=e),this.far[e]>o.far&&(this.far[e]<=h.far?o.far=this.far[e]:this.farCandidates[d++]=e);if(0===this.nearCandidates.length&&0===this.farCandidates.length)return o;this.nearCandidates.sort(((e,t)=>this.near[e]<this.near[t]?-1:this.near[e]>this.near[t]?1:0)),this.farCandidates.sort(((e,t)=>this.far[e]<this.far[t]?1:this.far[e]>this.far[t]?-1:0));for(let e=0;e<this.nearCandidates.length;++e){const t=this.nearCandidates[e];if(this.near[t]<o.near){const e=this.geometries[t],i=e.boundingInfo;this.includeNearBoundingInfoRec(i,e.getShaderTransformation())}}for(let e=0;e<this.farCandidates.length;++e){const t=this.farCandidates[e];if(this.far[t]>o.far){const e=this.geometries[t],i=e.boundingInfo;this.includeFarBoundingInfoRec(i,e.getShaderTransformation())}}return o}reset(){this.geometries.length=0,this.near.length=0,this.far.length=0,this.nearCandidates.length=0,this.farCandidates.length=0,this.range.near=Number.MAX_VALUE,this.range.far=-Number.MAX_VALUE}includeNearBoundingInfoRec(e,t){if(M(e))return;const i=e.getCenter();Le(kS,i,t);const r=Ei(t),s=kS[0],a=kS[1],n=kS[2],o=e.getBSRadius()*r,l=this.frustum;if(l[0][0]*s+l[0][1]*a+l[0][2]*n+l[0][3]>o||l[1][0]*s+l[1][1]*a+l[1][2]*n+l[1][3]>o||l[2][0]*s+l[2][1]*a+l[2][2]*n+l[2][3]>o||l[3][0]*s+l[3][1]*a+l[3][2]*n+l[3][3]>o)return;const h=this.view[2]*s+this.view[6]*a+this.view[10]*n+this.view[14],c=h+o;if(!(-(h-o)<2||-c>=this.range.near))if(-c>this.looseRange.near)this.range.near=-c;else{if(o>100){const i=e.getChildren();if(void 0!==i){for(let e=0;e<8;++e)void 0!==i[e]&&this.includeNearBoundingInfoRec(i[e],t);return}}BS.unionDepthRangeWithAABB(this.range,this.viewProj,t,e.getBBMin(),e.getBBMax())}}includeFarBoundingInfoRec(e,t){if(M(e))return;let i=e.getBSRadius();const r=e.getCenter();Le(kS,r,t);const s=Ei(t),a=kS[0],n=kS[1],o=kS[2];i*=s;const l=this.frustum;if(l[0][0]*a+l[0][1]*n+l[0][2]*o+l[0][3]>i||l[1][0]*a+l[1][1]*n+l[1][2]*o+l[1][3]>i||l[2][0]*a+l[2][1]*n+l[2][2]*o+l[2][3]>i||l[3][0]*a+l[3][1]*n+l[3][2]*o+l[3][3]>i)return;const h=this.view[2]*a+this.view[6]*n+this.view[10]*o+this.view[14]-i;if(!(-h<=this.range.far))if(-h<this.looseRange.far)this.range.far=-h;else{if(i>100){const i=e.getChildren();if(void 0!==i){for(let e=0;e<8;++e)void 0!==i[e]&&this.includeFarBoundingInfoRec(i[e],t);return}}BS.unionDepthRangeWithAABB(this.range,this.viewProj,t,e.getBBMin(),e.getBBMax())}}},BS=new class{constructor(){this.modelViewProj=Ar(),this.clipPosition=[nr(),nr(),nr(),nr(),nr(),nr(),nr(),nr()]}unionDepthRangeWithAABB(e,t,i,r,s){const a=this.modelViewProj;Cr(a,t,i);let n=!1;for(let e=0;e<8;++e){const t=this.clipPosition[e],i=0===e||3===e||4===e||7===e?r[0]:s[0],n=0===e||1===e||4===e||5===e?r[1]:s[1],o=e<4?r[2]:s[2];t[0]=a[0]*i+a[4]*n+a[8]*o+a[12],t[1]=a[1]*i+a[5]*n+a[9]*o+a[13],t[2]=a[2]*i+a[6]*n+a[10]*o+a[14],t[3]=a[3]*i+a[7]*n+a[11]*o+a[15]}for(let t=0;t<12;++t){const i=this.clipPosition[VS[t][0]],r=this.clipPosition[VS[t][1]],s=this.clipPosition[VS[t][2]],a=this.clipTriangle(i,r,s);let o=!0;for(let e=0;e<a.length;++e){if(a[e][3]>=2){o=!1;break}}if(!o){n=!0;for(let t=0;t<a.length;++t){const i=a[t][3];i<e.near&&(e.near=i),i>e.far&&(e.far=i)}}}return n}inside(e,t){return 0===t?e[0]>=-e[3]:1===t?e[1]>=-e[3]:2===t?e[0]<=e[3]:3===t?e[1]<=e[3]:void Fn(!1)}intersect(e,t,i){let r=0;return 0===i?r=(-e[3]-e[0])/(t[0]-e[0]+t[3]-e[3]):1===i?r=(-e[3]-e[1])/(t[1]-e[1]+t[3]-e[3]):2===i?r=(e[3]-e[0])/(t[0]-e[0]-t[3]+e[3]):3===i&&(r=(e[3]-e[1])/(t[1]-e[1]-t[3]+e[3])),ot(nr(),e,t,r)}clipTriangle(e,t,i){let r=[e,t,i];for(let e=0;e<4;++e){const t=r;r=[];for(let i=0;i<t.length;++i){const s=t[i],a=t[(i+1)%t.length];this.inside(a,e)?(this.inside(s,e)||r.push(this.intersect(s,a,e)),r.push(a)):this.inside(s,e)&&r.push(this.intersect(s,a,e))}}return r}};let NS=class extends yi{constructor(){super(...arguments),this._handles=new ar,this._magnifier=null,this._imageSources=null,this._imageLoadTask=null,this._resources=null,this.events=new tr,this.attributeLocations=new Map([["position",0]]),this.tmpScreenPoint=ie(),this.tmpRenderPoint=oe()}get updating(){return M(this._imageSources)&&C(this._imageLoadTask)&&!this._imageLoadTask.task.finished}get magnifier(){return this._magnifier}set magnifier(e){if(e===this._magnifier)return;this._handles.removeAll(),this._magnifier=e;const t=()=>{this.updateResourceLoading(),this.events.emit("request-render")};C(this._magnifier)&&this._handles.add(this._magnifier.watch("version",t)),t()}get enabled(){return C(this._validMagnifier)}get _validMagnifier(){return C(this._magnifier)&&this._magnifier.visible&&C(this._magnifier.position)&&this._magnifier.size>0?this._magnifier:null}get factor(){return C(this._magnifier)&&this._magnifier.factor||1}dispose(){this._magnifier=null,this._handles.destroy(),C(this._imageLoadTask)&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this.disposeResources()}render(e,t){const i=this._validMagnifier;if(M(i))return;const r=t.camera.pixelRatio,s=Math.ceil(r*i.size);if(this.updateResources(e,s),M(this._resources))return;const a=this._resources.program;e.useProgram(a);const n=this._resources.textures,o=Math.ceil(1/this.factor*s);n.input.resize(o,o);const l=t.camera.fullWidth,h=t.camera.fullHeight;re(i.position,this.tmpScreenPoint);const c=t.camera.screenToRender(this.tmpScreenPoint,this.tmpRenderPoint),d=.5*o,u=.5*o;c[0]=ue(c[0],d,l-d-1),c[1]=ue(c[1],u,h-u-1);const p=Math.floor(c[0]-d),m=Math.floor(c[1]-u);a.bindTexture(n.input,"textureInput"),e.gl.copyTexImage2D(n.input.descriptor.target,0,n.input.descriptor.pixelFormat,p,m,o,o,0);const g=i.offset.x*r,f=i.offset.y*r,v=(c[0]+g)/l*2-1,_=(c[1]-f)/h*2-1,y=s/l*2,x=s/h*2;e.bindVAO(this._resources.vao),a.bindTexture(n.overlay,"textureOverlay"),a.bindTexture(n.mask,"textureMask"),a.setUniform4f("drawPosition",v,_,y,x),a.setUniform1i("maskEnabled",i.maskEnabled?1:0),a.setUniform1i("overlayEnabled",i.overlayEnabled?1:0),e.setPipelineState(this._resources.pipelineState),e.drawArrays(5,0,4)}updateResourceLoading(){const e=this._validMagnifier;if(M(e))return;const t=e.maskUrl,i=e.overlayUrl;!C(this._imageLoadTask)||this._imageLoadTask.maskUrl===t&&this._imageLoadTask.overlayUrl===i||(this._imageLoadTask.task.abort(),this._imageLoadTask=null,this._imageSources=null),C(this._imageSources)||C(this._imageLoadTask)||(this._imageLoadTask={maskUrl:t,overlayUrl:i,task:d((async e=>{const r=M(t)||M(i)?jo(e):null,s=C(t)?Rn(t,{signal:e}):r.then((e=>e.mask)),a=C(i)?Rn(i,{signal:e}):r.then((e=>e.overlay));this._imageSources={mask:await s,overlay:await a},this.disposeResources(),this.events.emit("request-render")}))},this._imageLoadTask.task.promise.then((()=>this.notifyChange("updating")),(()=>this.notifyChange("updating"))))}updateResources(e,t){if(!this.enabled)return void this.disposeResources();if(C(this._resources)){if(this._resources.textures.size!==t){const i=this.createTextureResources(e,t);if(M(i))return void this.disposeResources();this.disposeTextureResources(this._resources.textures),this._resources.textures=i}return}const i=this.createTextureResources(e,t);M(i)||(this._resources={textures:i,program:this.createProgram(e),vao:xs(e,ia,this.attributeLocations,0,1),pipelineState:Ea({blending:ka(1,771),depthTest:null,depthWrite:null,colorWrite:Va})})}disposeResources(){M(this._resources)||(this.disposeTextureResources(this._resources.textures),this._resources.program.dispose(),this._resources.vao.dispose(),this._resources=null)}disposeTextureResources(e){e.mask.dispose(),e.overlay.dispose(),e.input.dispose()}createTextureResources(e,t){if(M(this._imageSources))return null;this._imageSources.overlay.width=t,this._imageSources.overlay.height=t,this._imageSources.mask.width=t,this._imageSources.mask.height=t;const i=new Pn(e,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0,preMultiplyAlpha:!oh(this._imageSources.overlay.src)||!Xr(e).svgAlwaysPremultipliesAlpha},this._imageSources.overlay),r=new Pn(e,{target:3553,pixelFormat:6406,internalFormat:6406,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0},this._imageSources.mask);return{input:new Pn(e,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1}),mask:r,overlay:i,size:t}}createProgram(e){const t=function(){const e=new ds;return e.attributes.add("position","vec2"),e.vertex.uniforms.add("proj","mat4"),e.vertex.uniforms.add("drawPosition","vec4"),e.varyings.add("vUV","vec2"),e.vertex.code.add(us`void main(void) {
vUV = position;
gl_Position = vec4(drawPosition.xy + vec2(position - 0.5) * drawPosition.zw, 0.0, 1.0);
}`),e.fragment.uniforms.add("textureInput","sampler2D"),e.fragment.uniforms.add("textureMask","sampler2D"),e.fragment.uniforms.add("textureOverlay","sampler2D"),e.fragment.uniforms.add("maskEnabled","bool"),e.fragment.uniforms.add("overlayEnabled","bool"),e.fragment.code.add(us`const float barrelFactor = 1.1;
vec2 barrel(vec2 uv) {
vec2 uvn = uv * 2.0 - 1.0;
if (uvn.x == 0.0 && uvn.y == 0.0) {
return vec2(0.5, 0.5);
}
float theta = atan(uvn.y, uvn.x);
float r = pow(length(uvn), barrelFactor);
return r * vec2(cos(theta), sin(theta)) * 0.5 + 0.5;
}
void main() {
float mask = maskEnabled ? texture2D(textureMask, vUV).a : 1.0;
vec4 inputColor = texture2D(textureInput, barrel(vUV)) * mask;
vec4 overlayColor = overlayEnabled ? texture2D(textureOverlay, vUV) : vec4(0);
gl_FragColor = overlayColor + (1.0 - overlayColor.a) * inputColor;
}`),e}();return new _s(e,t,this.attributeLocations)}};e([le()],NS.prototype,"_imageSources",void 0),e([le()],NS.prototype,"_imageLoadTask",void 0),e([le({readOnly:!0})],NS.prototype,"updating",null),NS=e([ce("esri/views/3d/webgl-engine/lib/MagnifierHelper")],NS);class GS{constructor(e,t=.9){this._alpha=.9,this._startTime=0,this._count=0,this._sum=0,this._smooth=0,this._min=0,this._max=0,this._name=e,this._alpha=t,this.reset()}reset(){this._count=0,this._sum=0,this._smooth=0,this._min=1/0,this._max=0}get name(){return this._name}get count(){return this._count}get average(){return this._count>0?this._sum/this._count:0}get smooth(){return this._smooth}get min(){return this._min}get max(){return this._max}begin(){this._startTime=performance.now()}end(){const e=performance.now()-this._startTime;this._count+=1,this._sum+=e,this._smooth=this._alpha*e+(1-this._alpha)*this._smooth,this._min=Math.min(this._min,e),this._max=Math.max(this._max,e)}toJSON(){return{name:this.name,count:this.count,average:this.average,smooth:this.smooth,min:this.min,max:this.max}}}!function(e){const t={},i={};function r(i){return i in t||(t[i]=new e(i)),t[i]}function s(e){console.log(r(e).toJSON())}e.get=r,e.begin=function(e){r(e).begin()},e.end=function(e,t=!0){r(e).end();const a=performance.now();t&&(!(e in i)||a>=i[e]+1e3)&&(s(e),i[e]=a)},e.log=s,e.logAll=function(){for(const e in t)s(e)}}(GS||(GS={}));var WS=GS;class QS{constructor(){this.identifier=0,this.transparent=!1,this.integratedMesh=!1,this.viewTransform=new ts.ViewProjectionTransform,this.transformNormal_ViewFromGlobal=vn(),this.cameraNearFar=Nr(),this.inverseViewport=Nr(),this.slicePlane=Gt(),this.slicePlaneEnabled=!0,this.ambientOcclusionEnabled=!0,this.shadowsEnabled=!0,this.sceneHasOcludees=!1,this.transparencyPassType=3}}class ZS{constructor(){this.identifier=1,this.viewTransform=new ts.ViewProjectionTransform,this.cameraNearFar=Nr(),this.slicePlane=Gt()}}class YS{constructor(){this.identifier=2,this.viewTransform=new ts.ViewProjectionTransform,this.slicePlane=Gt(),this.inverseViewport=Nr(),this.viewport=nr()}}class XS{constructor(e,t,i=0){this._rctx=e,this._techniqueRepository=t,this._sorting=i,this._draws=new N({initialSize:32,allocator:e=>e||{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._passBoundTechniques=new Set,this._previouslyBoundMaterials=new Map,this._previouslyBoundDraw=new Map}submitDraw(e,t,i,r,s){const a=this._draws.pushNew();a.geometry=t,a.geometryRanges=i,a.material=e,a.bindDrawParams=r,a.depthSquaredHint=s,a.indexType=t.indexed?z(t.vao.indexBuffer).indexType:0}dispatch(e){const t=this._rctx;this._passBoundTechniques.clear(),this._previouslyBoundMaterials.clear(),this._previouslyBoundDraw.clear();let i=null;const r=this._draws.length;for(let s=0;s<r;s++){const r=this._draws.data[s],a=r.geometry,n=r.material.getTechnique(this._techniqueRepository,e,a.parameters);n===i&&3===n.configuration.transparencyPassType||(t.useProgram(n.program),t.setPipelineState(n.pipeline),i=n),this._passBoundTechniques.has(n)||(n.bindPass(e),this._passBoundTechniques.add(n)),t.bindVAO(a.vao),this._previouslyBoundMaterials.get(n)!==r.material&&(n.bindMaterial(r.material,e),this._previouslyBoundMaterials.set(n,r.material)),this._previouslyBoundDraw.get(n)!==r.bindDrawParams&&(n.bindDraw(r.bindDrawParams,r.material,e),this._previouslyBoundDraw.set(n,r.bindDrawParams));const o=r.geometryRanges,l=o.length;if(0!==r.indexType){const e=KS.get(r.indexType);for(let i=0;i<l;i+=2){const s=o[i],n=o[i+1];t.drawElements(a.primitiveType,n,r.indexType,s*e)}}else for(let e=0;e<l;e+=2){const i=o[e],r=o[e+1];t.drawArrays(a.primitiveType,i,r)}}return r>0}prepareSubmit(){this._draws.clear()}finishSubmit(){const e=0===this._sorting?1:-1;this._draws.sort(((t,i)=>{const r=e*(t.depthSquaredHint-i.depthSquaredHint);return 0!==r?r:t.geometry.vao.size-i.geometry.vao.size}))}get count(){return this._draws.length}}const KS=new Map;KS.set(5121,1),KS.set(5123,2),KS.set(5125,4);class JS{constructor(e,t){this.rctx=e,this.shaderTechniqueRepository=t,this.canRender=!0,this._materialPassParams=new QS,this._shadowPassParams=new ZS,this._highlightPassParams=new YS,this._systems=new Set,this._passes={materialOpaque:new XS(e,this.shaderTechniqueRepository),materialTransparent:new XS(e,this.shaderTechniqueRepository,1),materialIntegratedMesh:new XS(e,this.shaderTechniqueRepository),shadowMap:new XS(e,this.shaderTechniqueRepository),highlight:new XS(e,this.shaderTechniqueRepository),highlightIntegratedMesh:new XS(e,this.shaderTechniqueRepository),highlightShadowMap:new XS(e,this.shaderTechniqueRepository),defaultShadowMap:new XS(e,this.shaderTechniqueRepository)}}register(e){this._systems.add(e)}prepareRender(e){if(0!==this._systems.size){for(const e of Object.values(this._passes))e.prepareSubmit();this._systems.forEach((t=>t.submit(this._passes,{camera:e})));for(const e of Object.values(this._passes))e.finishSubmit();this.shaderTechniqueRepository.frameUpdate()}}render(e){if(0===this._systems.size)return!1;switch(this._configure(e),e.slot){case 4:switch(e.pass){case 0:return this._materialPassParams.subPass=0,this._configureMaterialColorPass(e),this._passes.materialOpaque.dispatch(this._materialPassParams);case 2:return this._materialPassParams.subPass=2,this._passes.materialOpaque.dispatch(this._materialPassParams);case 3:return this._materialPassParams.subPass=3,this._passes.materialOpaque.dispatch(this._materialPassParams);case 5:return this._passes.highlight.dispatch(this._highlightPassParams);case 4:return this._passes.shadowMap.dispatch(this._shadowPassParams);case 7:return this._passes.highlightShadowMap.dispatch(this._shadowPassParams);case 6:return this._passes.defaultShadowMap.dispatch(this._shadowPassParams)}return!1;case 6:switch(e.pass){case 0:return this._materialPassParams.subPass=0,this._configureMaterialColorPass(e),this._passes.materialTransparent.dispatch(this._materialPassParams);case 1:return this._materialPassParams.subPass=1,this._configureMaterialColorPass(e),this._passes.materialTransparent.dispatch(this._materialPassParams);case 2:return this._materialPassParams.subPass=2,this._passes.materialTransparent.dispatch(this._materialPassParams);case 3:return this._materialPassParams.subPass=3,this._passes.materialTransparent.dispatch(this._materialPassParams)}return!1;case 1:switch(e.pass){case 0:return this._materialPassParams.subPass=0,this._configureMaterialColorPass(e),this._materialPassParams.ssrParams=e.ssrParams,this._passes.materialIntegratedMesh.dispatch(this._materialPassParams);case 2:return this._materialPassParams.subPass=2,this._passes.materialIntegratedMesh.dispatch(this._materialPassParams);case 3:return this._materialPassParams.subPass=3,this._passes.materialIntegratedMesh.dispatch(this._materialPassParams);case 5:return this._passes.highlightIntegratedMesh.dispatch(this._highlightPassParams)}return!1}return!1}notifyDirty(){this._context.requestRender()}slots(){return[4,6,1]}initializeRenderContext(e){this._context=e}uninitializeRenderContext(){}queryDepthRange(e){const t={near:1/0,far:-1/0};return this._systems.forEach((i=>{const r=i.queryShadowCasterDepthRange(e);C(r)&&PT(t,r,t)})),t}get shadowCastingEnabled(){return this._materialPassParams.shadowsEnabled}set shadowCastingEnabled(e){this._materialPassParams.shadowsEnabled=e}get screenSpaceReflectionsEnabled(){return C(this._materialPassParams.ssrParams.ssrEnabled)}set screenSpaceReflectionsEnabled(e){this._materialPassParams.ssrParams.ssrEnabled=!!e}_configureMaterialColorPass(e){this._materialPassParams.bindShadowMap=t=>{e.shadowMap.bind(t);const i=this._materialPassParams.viewTransform;Pe($S,i.worldFromView_TL,i.worldFromView_TH),e.shadowMap.bindView(t,$S)},this._materialPassParams.bindAmbientOcclusion=t=>e.ssaoHelper.bind(t,e.camera),this._materialPassParams.ambientOcclusionEnabled=!!e.ssaoHelper&&e.ssaoHelper.ready,this._materialPassParams.sceneHasOcludees=e.hasOccludees}_configure(e){const t=4===e.pass||7===e.pass||6===e.pass?this._shadowPassParams:5===e.pass?this._highlightPassParams:this._materialPassParams;this._updateParameters(e,t)}_updateParameters(e,t){const i=e.camera,r=i.viewInverseTransposeMatrix;ve($S,r[3],r[7],r[11]),tP.set($S),ye(t.viewTransform.worldFromView_TH,tP.high),ye(t.viewTransform.worldFromView_TL,tP.low),dn(t.viewTransform.viewFromCameraRelative_RS,i.viewMatrix),wr(t.viewTransform.projFromView,i.projectionMatrix),0===t.identifier?(this._materialPassParams.transparent=6===e.slot,this._materialPassParams.integratedMesh=1===e.slot,this._materialPassParams.lighting=e.scenelightingData,un(eP,t.viewTransform.viewFromCameraRelative_RS),gn(t.transformNormal_ViewFromGlobal,eP),Ir(t.cameraNearFar,i.near,i.far)):1===t.identifier?Ir(t.cameraNearFar,i.near,i.far):2===t.identifier&&(t.highlightDepthTexture=e.highlightDepthTexture,Ke(t.viewport,i.fullViewport)),0!==t.identifier&&2!==t.identifier||(t.inverseViewport[0]=1/i.fullViewport[2],t.inverseViewport[1]=1/i.fullViewport[3]),Zt(e.sliceHelper.plane,t.slicePlane),Te(t.slicePlane.origin,t.slicePlane.origin,$S),t.slicePlaneEnabled=e.sliceHelper.isEnabled,this._materialPassParams.transparencyPassType=e.transparencyPassType,this._materialPassParams.multipassTerrainParams=e.multipassTerrainParams}get needsHighlight(){return this._passes.highlight.count>0||this._passes.highlightIntegratedMesh.count>0}}const $S=fe(),eP=vn(),tP=new mS;var iP=Object.freeze({__proto__:null,build:function(e){const t=new ds,i=t.vertex.code,r=t.fragment.code;return t.attributes.add("position","vec2"),2===e.highlightStage&&(i.add(us`void main() {
gl_Position = vec4(vec2(1.0) - position * 2.0, 0.0, 1.0);
}`),t.fragment.uniforms.add("tex","sampler2D"),t.fragment.uniforms.add("invFramebufferDim","vec2"),r.add(us`void main() {
vec2 coord = gl_FragCoord.xy * invFramebufferDim;
vec4 value = texture2D(tex, coord);
float mx = floor(max(value.g, value.b));
gl_FragColor = vec4(ceil(value.r), mx, mx, 1.0);
}`)),0===e.highlightStage&&(t.attributes.add("uv0","vec2"),e.gridOptimization?(t.vertex.uniforms.add("coverageTex","sampler2D"),t.fragment.uniforms.add("blurSize","vec2"),t.varyings.add("blurCoordinate","vec3")):(t.vertex.uniforms.add("blurSize","vec2"),t.varyings.add("blurCoordinates[5]","vec2")),i.add(us`
    void main() {
      gl_Position = vec4(position, 0.0, 1.0);
      ${e.gridOptimization?us`
      vec4 cov = texture2D(coverageTex, uv0);
      if (cov.r == 0.0) {
        gl_Position = vec4(0.0);
      }
      blurCoordinate = vec3(gl_Position.xy * 0.5 + vec2(0.5), max(cov.g, cov.b));
      `:us`
      vec2 uv = position.xy * 0.5 + vec2(0.5);
      blurCoordinates[0] = uv;
      blurCoordinates[1] = uv + blurSize * 1.407333;
      blurCoordinates[2] = uv - blurSize * 1.407333;
      blurCoordinates[3] = uv + blurSize * 3.294215;
      blurCoordinates[4] = uv - blurSize * 3.294215;
          `}
    }`),t.fragment.uniforms.add("tex","sampler2D"),r.add(us`
    void main() {
      ${e.gridOptimization?us`
          vec2 uv = blurCoordinate.xy;
          vec4 center = texture2D(tex, uv);

          // do not blur if no pixel or all pixels in neighborhood are set
          if (blurCoordinate.z == 1.0) {
            gl_FragColor = center;
          } else {
            vec4 sum = vec4(0.0);
            sum += center * 0.204164;
            sum += texture2D(tex, uv + blurSize * 1.407333) * 0.304005;
            sum += texture2D(tex, uv - blurSize * 1.407333) * 0.304005;
            sum += texture2D(tex, uv + blurSize * 3.294215) * 0.093913;
            sum += texture2D(tex, uv - blurSize * 3.294215) * 0.093913;
            gl_FragColor = sum;
          }`:us`
          vec4 sum = vec4(0.0);
          sum += texture2D(tex, blurCoordinates[0]) * 0.204164;
          sum += texture2D(tex, blurCoordinates[1]) * 0.304005;
          sum += texture2D(tex, blurCoordinates[2]) * 0.304005;
          sum += texture2D(tex, blurCoordinates[3]) * 0.093913;
          sum += texture2D(tex, blurCoordinates[4]) * 0.093913;
          gl_FragColor = sum;`}
    }`)),1===e.highlightStage&&(t.varyings.add("uv","vec2"),e.gridOptimization&&(t.attributes.add("uv0","vec2"),t.vertex.uniforms.add("coverageTex","sampler2D")),i.add(us`
      void main() {
        ${e.gridOptimization?us`
            vec4 cov = texture2D(coverageTex, uv0);
            // if no highlight pixel set in this block, hide block
            if (cov.r == 0.0) {
              gl_Position = vec4(0.0);
              return;
            }`:""}
        gl_Position = vec4(position, 0.0, 1.0);
        uv = position.xy * 0.5 + vec2(0.5);
      }`),t.fragment.uniforms.add("tex","sampler2D"),t.fragment.uniforms.add("origin","sampler2D"),t.fragment.uniforms.add("color","vec4"),t.fragment.uniforms.add("haloColor","vec4"),t.fragment.uniforms.add("outlineSize","float"),t.fragment.uniforms.add("blurSize","float"),t.fragment.uniforms.add("opacities","vec4"),r.add(us`void main() {
vec4 blurredHighlightValue = texture2D(tex, uv);
float highlightIntensity = blurredHighlightValue.a;
if (highlightIntensity == 0.0) {
discard;
}
vec4 origin_color = texture2D(origin, uv);
float outlineIntensity;
float fillIntensity;
if (blurredHighlightValue.g > blurredHighlightValue.b) {
outlineIntensity = haloColor.w * opacities[1];
fillIntensity = color.w * opacities[3];
}
else {
outlineIntensity = haloColor.w * opacities[0];
fillIntensity = color.w * opacities[2];
}
float inner = 1.0 - outlineSize / 9.0;
float outer = 1.0 - (outlineSize + blurSize) / 9.0;
float outlineFactor = smoothstep(outer, inner, highlightIntensity);
float fillFactor = any(notEqual(origin_color, vec4(0.0, 0.0, 0.0, 0.0))) ? 1.0 : 0.0;
float intensity = outlineIntensity * outlineFactor * (1.0 - fillFactor) + fillIntensity * fillFactor;
gl_FragColor = vec4(mix(haloColor.rgb, color.rgb, fillFactor), intensity);
}`)),t}});class rP extends vs{initializeProgram(e){const t=rP.shader.get().build(this.configuration);return new _s(e.rctx,t,ys)}bindApplyPass(e){this.program.setUniform4fv("color",e.color),this.program.setUniform4fv("haloColor",e.haloColor),this.program.setUniform1f("outlineSize",8.6),this.program.setUniform1f("blurSize",.4),this.program.setUniform4f("opacities",e.haloOpacity,e.haloOpacityOccluded,e.fillOpacity,e.fillOpacityOccluded)}initializePipeline(){return 1===this.configuration.highlightStage?Ea({blending:La(770,1,771,771),colorWrite:Va}):Ea({colorWrite:Va})}get primitiveType(){return this.configuration.gridOptimization?4:5}}rP.shader=new gs(iP,(()=>Promise.resolve().then((function(){return iP}))));class sP extends fs{constructor(){super(...arguments),this.highlightStage=0,this.gridOptimization=!1}}e([ms({count:3})],sP.prototype,"highlightStage",void 0),e([ms()],sP.prototype,"gridOptimization",void 0);class aP{constructor(e,t){this._techniqueRep=e,this._rctx=t,this.viewportToRestore=nr(),this.defaultOptions={color:Dl(1,0,1,1),haloColor:Dl(1,0,1,1),haloOpacity:1,fillOpacity:.2,haloOpacityOccluded:.25,fillOpacityOccluded:.05,shadowColor:Dl(1,0,1,1),shadowOpacity:.15,occludedShadowOpacity:.075},this._grid={coverageMipmap:null,vao:null,verticalCellCount:0,horizontalCellCount:0,cellPixelSize:0,mipmapLevels:0,viewportWidth:0,viewportHeight:0}}assertResources(){if(this.quadVAO)return;this.quadVAO=xs(this._rctx);const e={colorTarget:0,depthStencilTarget:0,width:0,height:0},t={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0};this.blur0Fbo=new Tn(this._rctx,e,t),this.blur1Fbo=new Tn(this._rctx,e,t);const i=new sP;i.highlightStage=0,i.gridOptimization=!1,this.blurTechnique=this._techniqueRep.acquire(rP,i),i.highlightStage=0,i.gridOptimization=!0,this.blurGridTechnique=this._techniqueRep.acquire(rP,i),i.highlightStage=1,i.gridOptimization=!1,this.applyTechnique=this._techniqueRep.acquire(rP,i),i.highlightStage=1,i.gridOptimization=!0,this.applyGridTechnique=this._techniqueRep.acquire(rP,i),i.highlightStage=2,i.gridOptimization=!1,this.downsampleTechnique=this._techniqueRep.acquire(rP,i)}dispose(){if(this._grid.coverageMipmap)for(let e=1;e<this._grid.coverageMipmap.length;e++)this._grid.coverageMipmap[e].dispose();this._grid.vao&&this._grid.vao.dispose(!0),this.quadVAO&&(this.quadVAO.dispose(!0),this.quadVAO=null),this.blur0Fbo=P(this.blur0Fbo),this.blur1Fbo=P(this.blur1Fbo)}get profilingCallback(){return ma.HIGHLIGHTS_PROFILE_TO_CONSOLE?e=>console.log(e):null}setDefaultOptions(e){this.defaultOptions=e}render(e,t,i){const r=e.pixelRatio,s=ma.HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED,a=this._rctx;this.assertResources(),Ke(this.viewportToRestore,e.fullViewport);const n=e.fullWidth,o=e.fullHeight,l=Math.ceil(n/r),h=Math.ceil(o/r);this.blur0Fbo.resize(l,h),this.blur1Fbo.resize(l,h),a.bindVAO(this.quadVAO);let c=null;const d=s?this.blurGridTechnique:this.blurTechnique;d.bindPipelineState(a),a.useProgram(d.program),s?(this._gridUpdateResources(t,32),this._gridComputeMipmap(),c=this._grid.vao,d.program.bindTexture(this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture,"coverageTex")):c=this.quadVAO,a.bindVAO(c),a.bindFramebuffer(this.blur0Fbo),a.setViewport(0,0,l,h),a.setClearColor(0,0,0,0),a.clear(16384),d.program.bindTexture(t.colorTexture,"tex"),d.program.setUniform2f("blurSize",1/l,0),a.drawArrays(d.primitiveType,0,Ua(c,"geometry")),a.bindFramebuffer(this.blur1Fbo),a.clear(16384),d.program.bindTexture(this.blur0Fbo.colorTexture,"tex"),d.program.setUniform2f("blurSize",0,1/h),a.drawArrays(d.primitiveType,0,Ua(c,"geometry"));const u=s?this.applyGridTechnique:this.applyTechnique;if(a.bindFramebuffer(i),u.bindPipelineState(a),a.setViewport(this.viewportToRestore[0],this.viewportToRestore[1],this.viewportToRestore[2],this.viewportToRestore[3]),a.useProgram(u.program),u.program.bindTexture(this.blur1Fbo.colorTexture,"tex"),u.program.bindTexture(t.colorTexture,"origin"),s){const e=this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture;u.program.bindTexture(e,"coverageTex")}u.bindApplyPass(this.defaultOptions),a.drawArrays(u.primitiveType,0,Ua(c,"geometry")),a.bindVAO(null)}_gridUpdateResources(e,t){const i=this._rctx,r=this._grid;let s=!1;if(null===r.coverageMipmap&&(r.coverageMipmap=[e],s=!0),r.viewportWidth===e.width&&r.viewportHeight===e.height||(s=!0,r.viewportWidth=e.width,r.viewportHeight=e.height),r.coverageMipmap[0]=e,r.cellPixelSize!==t&&(r.cellPixelSize=t,s=!0),s){for(let e=1;e<r.coverageMipmap.length;e++)r.coverageMipmap[e].dispose();r.mipmapLevels=Math.ceil(Math.log(r.cellPixelSize)*Math.LOG2E),r.coverageMipmap.length=r.mipmapLevels+1;for(let e=0;e<r.mipmapLevels;e++){const t=r.coverageMipmap[e],s={target:3553,pixelFormat:6407,dataType:33635,samplingMode:9729,wrapMode:33071,width:Math.ceil(t.width/2),height:Math.ceil(t.height/2)},a={colorTarget:0,depthStencilTarget:0,width:Math.ceil(t.width/2),height:Math.ceil(t.height/2)};r.coverageMipmap[e+1]=new Tn(i,a,s)}}const a=Math.ceil(e.height/r.cellPixelSize),n=Math.ceil(e.width/r.cellPixelSize);if(!r.vao||r.verticalCellCount!==a||r.horizontalCellCount!==n){r.verticalCellCount=a,r.horizontalCellCount=n;const e=a+1,t=n+1,s=1/a,o=1/n,l=6,h=4,c=new Float32Array(l*h*e*t);let d=0;for(let i=0;i<e;i++)for(let e=0;e<t;e++)c[d+0]=(e-.5)*o*2-1,c[d+1]=(i-.5)*s*2-1,c[d+2]=e*o,c[d+3]=i*s,c[d+4]=(e+.5)*o*2-1,c[d+5]=(i-.5)*s*2-1,c[d+6]=e*o,c[d+7]=i*s,c[d+8]=(e-.5)*o*2-1,c[d+9]=(i+.5)*s*2-1,c[d+10]=e*o,c[d+11]=i*s,c[d+12]=(e-.5)*o*2-1,c[d+13]=(i+.5)*s*2-1,c[d+14]=e*o,c[d+15]=i*s,c[d+16]=(e+.5)*o*2-1,c[d+17]=(i-.5)*s*2-1,c[d+18]=e*o,c[d+19]=i*s,c[d+20]=(e+.5)*o*2-1,c[d+21]=(i+.5)*s*2-1,c[d+22]=e*o,c[d+23]=i*s,d+=l*h;r.vao&&r.vao.dispose(!0),r.vao=new qa(i,ys,{geometry:ws},{geometry:Ha.createVertex(i,35044,c)})}}_gridComputeMipmap(){const e=this._rctx,t=this._grid,i=this.downsampleTechnique.program;this.downsampleTechnique.bindPipelineState(e),e.bindVAO(this.quadVAO),e.useProgram(i);for(let r=0;r<t.mipmapLevels;r++){e.bindFramebuffer(t.coverageMipmap[r+1]),i.bindTexture(t.coverageMipmap[r].colorTexture,"tex");const s=t.coverageMipmap[r+1].width,a=t.coverageMipmap[r+1].height;i.setUniform2f("invFramebufferDim",1/s,1/a),e.setViewport(0,0,s,a),e.drawArrays(5,0,Ua(this.quadVAO,"geometry"))}}getGpuMemoryUsage(){let e=(C(this.blur0Fbo)?this.blur0Fbo.gpuMemoryUsage:0)+(C(this.blur1Fbo)?this.blur1Fbo.gpuMemoryUsage:0);if(this._grid.coverageMipmap)for(const t of this._grid.coverageMipmap)e+=t.gpuMemoryUsage;return e}get test(){return{coverage:this._grid.coverageMipmap,blur:[this.blur0Fbo,this.blur1Fbo]}}}const nP={dataType:5121,internalFormat:6408},oP={};class lP{constructor(e){this.rctx=e,this._activeTargets=new Set,this._depthTextures=new Map,this._depthBuffers=new Map,this._colorTextures=new Map,this._framebuffers=new Map,this._nextId=1,this.depthTextureSupported=e.capabilities.depthTexture}dispose(){this._depthBuffers.forEach((e=>e.dispose())),this._depthBuffers.clear(),this._depthTextures.forEach((e=>e.dispose())),this._depthTextures.clear(),this._colorTextures.forEach((e=>e.dispose())),this._colorTextures.clear(),this._framebuffers.forEach((e=>e.dispose())),this._framebuffers.clear()}disposeTargetResource(e){const t=e.id;this._activeTargets.has(t)&&(this._activeTargets.delete(t),this.disposeWithFramebuffers(this._depthTextures,t),this.disposeWithFramebuffers(this._depthBuffers,t),this.disposeWithFramebuffers(this._colorTextures,t))}disposeWithFramebuffers(e,t){const i=e.get(t);i&&(this._framebuffers.forEach(((e,t)=>{e.colorAttachment!==i&&e.depthStencilAttachment!==i||(e.detachAll(),e.dispose(),this._framebuffers.delete(t))})),i.dispose(),e.delete(t))}getDepthTexture(e,t){if(!this.depthTextureSupported)return;let i=this._depthTextures.get(e.id);return i&&(i.descriptor.width===t.width&&i.descriptor.height===t.height||(i.dispose(),i=void 0)),i||(i=new Pn(this.rctx,{target:3553,pixelFormat:34041,dataType:34042,samplingMode:9728,wrapMode:33071,width:t.width,height:t.height}),this._depthTextures.set(e.id,i),this._activeTargets.add(e.id)),i}getAllocatedDepthTexture(e){return this._depthTextures.get(e.id)}getDepthBuffer(e,t){if(this.depthTextureSupported)return;let i=this._depthBuffers.get(e.id);return i?i.descriptor.width===t.width&&i.descriptor.height===t.height||i.resize(t.width,t.height):(i=new Sn(this.rctx,{internalFormat:34041,...t}),this._depthBuffers.set(e.id,i),this._activeTargets.add(e.id)),i}getColorTexture(e,t){let i=this._colorTextures.get(e.id);return i&&(i.descriptor.width===t.width&&i.descriptor.height===t.height||(i.dispose(),i=void 0)),i||(i=new Pn(this.rctx,{target:3553,pixelFormat:6408,internalFormat:e.internalFormat,dataType:e.dataType,samplingMode:null!=e.samplingMode?e.samplingMode:9729,wrapMode:33071,width:t.width,height:t.height}),this._colorTextures.set(e.id,i),this._activeTargets.add(e.id)),i}getAllocatedColorTexture(e){return this._colorTextures.get(e.id)}registerDepthTarget(e={}){return{id:this._nextId++,...oP,...e}}registerColorTarget(e={}){return{id:this._nextId++,...nP,...e}}getFramebuffer(e,t,i){const r=this.getKey(t,i);let s=this._framebuffers.get(r);const a=this.getColorTexture(t,e);if(this.depthTextureSupported){const t=i?this.getDepthTexture(i,e):void 0;if(!s)return s=i?new Tn(this.rctx,{colorTarget:0,depthStencilTarget:4},a,t):new Tn(this.rctx,{colorTarget:0,depthStencilTarget:0},a),this._framebuffers.set(r,s),s;return(s.width!==e.width||s.height!==e.height||s.colorTexture!==a||s.depthStencilTexture!==t)&&(s.detachAll(),s.resize(e.width,e.height),s.attachColorTexture(a),s.attachDepthStencilTexture(t)),s}const n=i?this.getDepthBuffer(i,e):void 0;if(!s)return s=new Tn(this.rctx,{colorTarget:0,depthStencilTarget:i?3:0},a,n),this._framebuffers.set(r,s),s;return(s.width!==e.width||s.height!==e.height||s.colorTexture!==a)&&(s.detachAll(),s.resize(e.width,e.height),s.attachColorTexture(a),s.attachDepthStencilBuffer(n)),s}getKey(e,t){return`${e.id}_${t?t.id:"X"}_${e.name}${t?"_"+t.name:""}`}getGpuMemoryUsage(){let e=0;const t=new Set,i=i=>{t.has(i)||(t.add(i),e+=Ba(i))};return this._depthTextures.forEach(i),this._colorTextures.forEach(i),this._depthBuffers.forEach(i),e}}class hP{constructor(e,t){this._rctx=e,this._compositingHelper=t,this._currentRenderTarget=0,this.dimensions={width:4,height:4},this._needLastFrameColorTexture=!1,this._background={type:"color",color:[0,0,0,1]};const i=this._rctx,r="webgl2"===i.webglVersion;this.renderTargetHelper=new lP(i);const s=this.renderTargetHelper;this.mainColorTarget0=s.registerColorTarget({name:"mainColorTarget0"}),this.mainColorTarget1=s.registerColorTarget({name:"mainColorTarget1"}),this.frontFaceTarget=s.registerColorTarget({name:"frontFaceTarget"});const a=e=>s.registerColorTarget({name:e,dataType:5126,internalFormat:r?34836:6408,samplingMode:9728});this.colorFloatTarget=a("colorFloatTarget"),this.alphaFloatTarget=a("alphaFloatTarget"),this.mainDepth=s.registerDepthTarget({name:"mainDepth"}),this.linearDepth=s.registerColorTarget({name:"linearDepth",samplingMode:9728}),this.terrainLinearDepth=s.registerColorTarget({name:"terrainLinearDepth"}),this.geometryLinearDepth=s.registerColorTarget({name:"geometryLinearDepth"}),this.normal=s.registerColorTarget({name:"normal"}),this.highlight=s.registerColorTarget({name:"highlight",internalFormat:r?32854:6408,dataType:32819}),this.hudVisibility=s.registerColorTarget({name:"hudVisibility",internalFormat:r?32854:6408,dataType:32819}),this.tmpColor=s.registerColorTarget({name:"tmpColor"}),this.tmpDepth=s.registerDepthTarget({name:"tmpDepth"}),this.hudColor=s.registerColorTarget({name:"hudColor"})}dispose(){this.renderTargetHelper.dispose()}get width(){return this.dimensions.width}get height(){return this.dimensions.height}set background(e){this._background=e}get background(){return this._background}get currentColorTarget(){return 0===this._currentRenderTarget?this.mainColorTarget0:this.mainColorTarget1}get previousColorTarget(){return 0===this._currentRenderTarget?this.mainColorTarget1:this.mainColorTarget0}get currentRenderTarget(){return this._currentRenderTarget}get framebuffer(){return this.getFramebuffer(this.currentColorTarget,this.mainDepth)}getFramebuffer(e,t){return this.renderTargetHelper.getFramebuffer(this.dimensions,e,t)}get colorTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.currentColorTarget)}get depthTexture(){return this.renderTargetHelper.getAllocatedDepthTexture(this.mainDepth)}get linearDepthTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.linearDepth)}get terrainLinearDepthTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.terrainLinearDepth)}get geometryLinearDepthTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.geometryLinearDepth)}get lastFrameColorTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.previousColorTarget)}get normalTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.normal)}get highlightTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.highlight)}get hudVisibilityTexture(){return this.getColorTexture(this.hudVisibility)}get tmpColorTexture(){return this.getColorTexture(this.tmpColor)}get hudColorTexture(){return this.getColorTexture(this.hudColor)}get mainColorTexture(){return this.getColorTexture(this.currentColorTarget)}advanceCurrentRenderTarget(){this._currentRenderTarget=0===this._currentRenderTarget&&this._needLastFrameColorTexture?1:0}initializeFrame(e){const t=this._rctx;this.dimensions.width=e.fullWidth,this.dimensions.height=e.fullHeight,this.bindTarget(this.currentColorTarget,this.mainDepth),t.setClearStencil(0);const i=this._background.color;t.setClearColor(i[0]*i[3],i[1]*i[3],i[2]*i[3],i[3]),t.clearSafe(17664)}composite(){this._compositingHelper.composite(this.colorTexture,0)}renderTmpAndCompositeToMain(e,t,i=!1){this.renderToTargets(e,this.tmpColor,i?this.tmpDepth:this.mainDepth,cP),this._compositingHelper.composite(this.getColorTexture(this.tmpColor),t)}renderHUDVisibility(e,t=!1){this.renderToTargets(e,this.hudVisibility,t?this.tmpDepth:this.mainDepth,dP)}compositeTransparentTerrainOntoHUDVisibility(){this.renderToTargets((()=>{this._compositingHelper.compositeSpecial(this.getColorTexture(this.tmpColor),1)}),this.hudVisibility,this.tmpDepth)}renderOITPass(e,t,i){let r,s;switch(t){case 0:r=this.colorFloatTarget,s=[0,0,0,0];break;case 1:r=this.alphaFloatTarget,s=[1,1,1,1];break;case 2:r=this.frontFaceTarget,s=[0,0,0,0]}i?this.renderToTargets(e,r,this.tmpDepth,s,!0,!0):this.renderToTargets(e,r,this.mainDepth,s,!1)}compositeTransparentTerrainOntoMain(){this.bindFramebuffer(),this._compositingHelper.composite(this.getColorTexture(this.tmpColor),2)}compositeOccludedOntoMain(e){this.bindFramebuffer(),this._compositingHelper.composite(this.getColorTexture(this.tmpColor),2,e)}compositeTransparentOntoOpaque(e){e?(this.bindTarget(this.hudColor,this.tmpDepth),this._rctx.setClearColor(0,0,0,1e-13),this._rctx.clearSafe(16384)):this.bindFramebuffer(),this._compositingHelper.compositeTransparent(this.getColorTexture(this.colorFloatTarget),this.getColorTexture(this.alphaFloatTarget),this.getColorTexture(this.frontFaceTarget))}bindFramebuffer(){this._rctx.bindFramebuffer(this.framebuffer)}renderDepthDetached(e){this.bindTarget(this.currentColorTarget),e(),this.bindTarget(this.currentColorTarget,this.mainDepth)}disposeTarget(e){this.renderTargetHelper.disposeTargetResource(e)}set needLastFrameColorTexture(e){!e&&this._needLastFrameColorTexture&&(this._currentRenderTarget=0,this.disposeTarget(this.mainColorTarget1)),this._needLastFrameColorTexture=e}get needLastFrameColorTexture(){return this._needLastFrameColorTexture}renderToTargets(e,t,i,r,s=!1,a=!1){const n=this._rctx,o=this.bindTarget(t,i);let l=0;if(r){const e=1e-13,t=Math.max(e,r[3]);n.setClearColor(r[0],r[1],r[2],t),l|=16384}return s&&(l|=256),!1===a?a=0:(!0===a&&(a=255),l|=1024),l&&n.clearSafe(l,a),e(),n.gl.flush(),this.bindTarget(this.currentColorTarget,this.mainDepth),o}bindTarget(e,t){const i=this.renderTargetHelper.getFramebuffer(this.dimensions,e,t);return this._rctx.bindFramebuffer(i),i}getColorTexture(e){return this.renderTargetHelper.getColorTexture(e,this.dimensions)}getGpuMemoryUsage(){let e=0;return this.renderTargetHelper&&(e+=this.renderTargetHelper.getGpuMemoryUsage()),e}}const cP=[0,0,0,0],dP=[0,1,0,1];class uP{constructor(e){this.context=e,this.renderPlugins=new Array,this.slots=[];for(let e=0;e<25;++e)this.slots[e]=[]}add(e,t,i=null){const r=t.initializeRenderContext(this.context,i),s=()=>{this.renderPlugins.push(t);for(let i=0;i<e.length;++i){const r=e[i];this.slots[r].push(t)}this.context.requestRender()};if(v(r))return r.then(s);s()}remove(e){const t=this.renderPlugins.length;this.renderPlugins=this.renderPlugins.filter((t=>t!==e)),Fn(this.renderPlugins.length<t,"Removing non-added render plugin");for(let t=0;t<this.slots.length;++t)this.slots[t]=this.slots[t].filter((t=>t!==e));e.uninitializeRenderContext(),this.context.requestRender()}prepareRender(e,t){for(const i of this.renderPlugins)i.prepareRender&&i.prepareRender(e,t)}render(){const e=this.slots[this.context.renderContext.slot];let t=!1;for(const i of e)i.canRender&&i.render(this.context.renderContext)&&(t=!0);return t}queryDepthRange(e){const t=pP;t.near=1/0,t.far=-1/0;for(const i of this.renderPlugins)if(i.queryDepthRange){const r=i.queryDepthRange(e);r&&PT(t,r,t)}return t}get needsHighlight(){return this.renderPlugins.some((e=>e.needsHighlight))}get needsLinearDepth(){return this.renderPlugins.some((e=>e.needsLinearDepth))}get needsLaserlineWithContrastControl(){const e=this.slots[18];return!!e&&e.length>0}get renderOccludedFlags(){let e=0;return this.renderPlugins.forEach((t=>{t.renderOccludedFlags&&(e|=t.renderOccludedFlags)})),e}}const pP={near:0,far:0};var mP=Object.freeze({__proto__:null,shadowCastMaxSamples:255,build:function(e){const t=new ds;t.fragment.include(Cs),t.fragment.include(ps),t.include(mc),t.include(Xo);const{pass:i}=e;if(1===i){const{visualization:i,bandsEnabled:r}=e;t.fragment.constants.add("inverseSampleValue","float",255),t.fragment.uniforms.add("shadowCastMap","sampler2D"),t.fragment.uniforms.add("sampleScale","float"),t.fragment.uniforms.add("opacityFromElevation","float");const s=0===i,a=1===i;t.fragment.uniforms.add("color","vec4"),s?r&&t.fragment.uniforms.add("bandSize","float"):a&&t.fragment.uniforms.add("threshold","float"),t.fragment.code.add(us`
      void main(void) {
        vec4 record = texture2D(shadowCastMap, uv);
        float pixelSamples = record.r * inverseSampleValue;

        if (pixelSamples < 1.0) {
          discard;
        }

        float strength = pixelSamples * sampleScale;

        ${a?us`
            if (strength <= threshold) {
              discard;
            }`:""}

        ${s&&r?us`strength = ceil(strength / bandSize) * bandSize;`:""}

        gl_FragColor = vec4(color.xyz, color.a * opacityFromElevation ${s?us`* strength`:""});
      }
    `)}else 0!==i&&2!==i||(t.include(cn),t.fragment.uniforms.add("depthMap","sampler2D"),t.fragment.uniforms.add("inverseView","mat4"),t.fragment.uniforms.add("nearFar","vec2"),0===i?t.fragment.constants.add("sampleValue","float",.00392156862745098):t.fragment.constants.add("shadowColor","vec4",[0,0,0,.8]),t.fragment.code.add(us`
      void main(void) {

        float depth = rgba2float(texture2D(depthMap, uv));
        // 0.0 is the clear value of depthMap, which means nothing has been drawn there and we should discard
        if (depth == 0.0) {
          discard;
        }

        float currentPixelDepth = linearDepthFromFloat(depth, nearFar);

        if (-currentPixelDepth > nearFar.y || -currentPixelDepth < nearFar.x) {
          discard;
        }

        vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
        vec4 worldSpacePos = inverseView * currentPixelPos;

        mat4 shadowMatrix;
        float linearDepth = -currentPixelDepth;
        int i = chooseCascade(linearDepth, shadowMatrix);

        if (i >= uShadowMapNum) {
          discard;
        }

        vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);

        // vertex completely outside? -> no shadow
        if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
          discard;
        }

        vec2 uvShadow = cascadeCoordinates(i, lvpos);

        float depthShadow = readShadowMapDepth(uvShadow, uShadowMapTex);
        bool shadow = depthShadow < lvpos.z;

        if (!shadow) {
          discard;
        }

        gl_FragColor = ${0===i?us`vec4(sampleValue)`:us`shadowColor`};
      }
    `));return t}});class gP extends vs{initializeProgram(e){const t=gP.shader.get().build(this.configuration);return new _s(e.rctx,t,ys)}initializePipeline(e){return 0===this.configuration.pass?Ea({blending:La(1,1,1,1),colorWrite:Va,depthTest:null,depthWrite:null}):1===this.configuration.pass||2===this.configuration.pass?Ea({blending:Zs,colorWrite:Va,depthTest:null,depthWrite:null}):Ea({})}bindPass(e){if(0===this.configuration.pass||2===this.configuration.pass){const t=e;this.program.bindTexture(t.linearDepthTexture,"depthMap"),t.shadowMap.bind(this.program),t.shadowMap.bindView(this.program,t.camera.center),this.program.setUniform2fv("nearFar",t.camera.nearFar),this.program.setUniformMatrix4fv("inverseView",t.inverseView),this.program.setUniform4fv("projInfo",t.projInfo),this.program.setUniform2fv("zScale",t.zScale)}else if(1===this.configuration.pass){const t=e;if(this.program.bindTexture(t.shadowCastMap,"shadowCastMap"),this.program.setUniform1f("sampleScale",t.sampleScale),this.program.setUniform1f("opacityFromElevation",t.opacityFromElevation),this.program.setUniform4fv("color",t.color),0===this.configuration.visualization&&this.configuration.bandsEnabled){const t=e;this.program.setUniform1f("bandSize",t.bandSize)}else if(1===this.configuration.visualization){const t=e;this.program.setUniform1f("threshold",t.threshold)}}}get primitiveType(){return 5}}gP.shader=new gs(mP,(()=>Promise.resolve().then((function(){return mP}))));class fP extends fs{constructor(){super(...arguments),this.pass=0,this.visualization=0,this.bandsEnabled=!1}}e([ms({count:3})],fP.prototype,"pass",void 0),e([ms()],fP.prototype,"visualization",void 0),e([ms()],fP.prototype,"bandsEnabled",void 0);const vP=or(.01,0,.25,1);class _P{constructor(e,t,i,r){this._techniqueRep=e,this._rctx=t,this._shadowAccumulator=i,this._requestRender=r,this._enabled=!1,this._vao=xs(t),this._visualizationConfig=new fP,this._visualizationConfig.pass=1,this._visualizationConfig.visualization=0,this._visualizeShadowCastTechnique=e.acquire(gP,this._visualizationConfig),this._visualizationParams={shadowCastMap:this._shadowCastTexture,sampleScale:0,color:vP,threshold:.5,bandSize:.1,opacityFromElevation:1}}dispose(){this._stop(),this._vao=P(this._vao),this._visualizeShadowCastTechnique=P(this._visualizeShadowCastTechnique),this._shadowAccumulator=null}render(){this._isRenderingVisualization&&(this._sampleScale=1/this._computedSamples,this._rctx.bindVAO(this._vao),this._rctx.useProgram(this._visualizeShadowCastTechnique.program),this._visualizeShadowCastTechnique.bindPipelineState(this._rctx),this._visualizeShadowCastTechnique.bindPass(this._visualizationParams),this._rctx.drawArrays(this._visualizeShadowCastTechnique.primitiveType,0,Ua(this._vao,"geometry")))}setOptions(e){void 0!==e.enabled&&this._setEnabled(e.enabled),void 0!==e.color&&this._setColor(e.color),void 0!==e.threshold&&(this._threshold=e.threshold),void 0!==e.visualization&&(this._visualization=e.visualization),void 0!==e.bandSize&&(this._bandSize=e.bandSize),void 0!==e.bandsEnabled&&(this._bandsEnabled=e.bandsEnabled)}get opacityFromElevation(){return this._visualizationParams.opacityFromElevation}set opacityFromElevation(e){this._visualizationParams.opacityFromElevation=e}get _isRenderingVisualization(){return this._enabled&&this._computedSamples>0&&this.opacityFromElevation>.001953125}get _computedSamples(){return this._shadowAccumulator.computedSamples}get _shadowCastTexture(){return this._shadowAccumulator.shadowCastTexture}get _sampleScale(){return this._visualizationParams.sampleScale}set _sampleScale(e){this._visualizationParams.sampleScale=e}get _threshold(){return this._visualizationParams.threshold}set _threshold(e){this._threshold!==e&&(this._visualizationParams.threshold=e,this._requestRenderIfRunning())}get _visualization(){return this._visualizationConfig.visualization}set _visualization(e){if(e===this._visualization)return;const t=this._visualizationConfig;t.visualization=e,this._visualizeShadowCastTechnique=this._techniqueRep.releaseAndAcquire(gP,t,this._visualizeShadowCastTechnique),this._requestRenderIfRunning()}get _bandSize(){return this._visualizationParams.bandSize}set _bandSize(e){e!==this._bandSize&&(this._visualizationParams.bandSize=e,this._requestRenderIfRunning())}get _bandsEnabled(){return this._visualizationConfig.bandsEnabled}set _bandsEnabled(e){if(e===this._bandsEnabled)return;const t=this._visualizationConfig;t.bandsEnabled=e,this._visualizeShadowCastTechnique=this._techniqueRep.releaseAndAcquire(gP,t,this._visualizeShadowCastTechnique),this._requestRenderIfRunning()}_setColor(e){const t=this._visualizationParams.color;at(e,t)||(Ke(this._visualizationParams.color,e),this._requestRenderIfRunning())}_setEnabled(e){e!==this._enabled&&(e?this._start():this._stop())}_requestRenderIfRunning(){this._enabled&&this._requestRender()}_start(){this._enabled=!0,this._requestRender()}_stop(){this._enabled=!1,this._requestRender()}}class yP{constructor(){this.camera=new co,this.lightMat=Ar()}}class xP{constructor(e,t,i=0){this.rctx=e,this.viewingMode=t,this._enabled=!1,this._snapshots=new Array,this.textureSize=0,this.maxTextureSize=0,this.numCascades=1,this.maxNumCascades=4,this.splitSchemeLambda=0,this.warp=!0,this.cascadeDistances=[0,0,0,0,0],this.cascades=[],this.maxTextureSize=this.rctx.parameters.maxTextureSize;for(let e=0;e<4;++e)this.cascades.push(new yP);this.snapshotCount=i}dispose(){this.discardDepthTexture(),this.discardAllSnapshots()}set maxCascades(e){this.maxNumCascades=ue(Math.floor(e),1,4)}get maxCascades(){return this.maxNumCascades}set enabled(e){this._enabled=e,e||(this.discardDepthTexture(),this.discardAllSnapshots())}get enabled(){return this._enabled}get snapshotCount(){return this._snapshots.length}set snapshotCount(e){const t=this._snapshots.length;if(e>t){const i=e-t;this._snapshots.length=e;for(let e=0;e<i;++e)this._snapshots[t+e]=null}else if(e<this.snapshotCount){const i=t-e;for(let t=0;t<i;++t)this.discardSnapshot(e+t);this._snapshots.length=e}}getSnapshot(e){return this.enabled?this._snapshots[e]:null}getCascades(){for(let e=0;e<this.numCascades;++e)EP[e]=this.cascades[e];return EP.length=this.numCascades,EP}start(e,t,i){Fn(this.enabled),this.textureSize=this.computeTextureSize(e.fullWidth,e.fullHeight),this.ensureDepthTexture();const{near:r,far:s}=this.clampNearFar(i);this.computeCascadeDistances(s,r),this.setupMatrices(e,t);const a=e.viewMatrix,n=e.projectionMatrix;for(let e=0;e<this.numCascades;++e)this.constructCascade(e,n,a,t);this.lastOrigin=null,this.clear()}finish(e){Fn(this.enabled),this.rctx.bindFramebuffer(e)}bind(e){this.enabled?(this._depthTextureUnit=e.bindTexture(this._depthTexture,"uShadowMapTex"),e.setUniform1f("uDepthHalfPixelSz",.5/this.textureSize),e.setUniform1i("uShadowMapNum",this.numCascades),e.setUniform4f("uShadowMapDistance",this.cascadeDistances[0],this.numCascades>1?this.cascadeDistances[1]:1/0,this.numCascades>2?this.cascadeDistances[2]:1/0,this.numCascades>3?this.cascadeDistances[3]:1/0)):e.setUniform1f("uDepthHalfPixelSz",-1)}bindView(e,t){if(!this.enabled)return;const i=this.lastOrigin;if(!(i&&i[0]===t[0]&&i[1]===t[1]&&i[2]===t[2])){this.lastOrigin=this.lastOrigin||fe(),ye(this.lastOrigin,t);for(let e=0;e<this.numCascades;++e){Pr(LP,this.cascades[e].lightMat,t);for(let t=0;t<16;++t)VP[16*e+t]=LP[t]}}e.setUniformMatrix4fv("uShadowMapMatrix",VP)}takeCascadeSnapshotTo(e,t){Fn(this.enabled),this.ensureSnapshot(t),this._bindFbo();const i=this.rctx,r=i.bindTexture(this._snapshots[t],Pn.TEXTURE_UNIT_FOR_UPDATES);i.gl.copyTexSubImage2D(3553,0,e.camera.viewport[0],e.camera.viewport[1],e.camera.viewport[0],e.camera.viewport[1],e.camera.viewport[2],e.camera.viewport[3]),i.bindTexture(r,Pn.TEXTURE_UNIT_FOR_UPDATES)}clear(){const e=this.rctx;this._bindFbo(),e.setClearColor(1,1,1,1),e.clearSafe(16640)}computeTextureSize(e,t){const i=.5*Math.log(e*e+t*t)*Math.LOG2E,r=2**Math.round(i+.35);return Math.min(this.maxTextureSize,2*r)}ensureDepthTexture(){if(null!=this._depthTexture&&this._depthTexture.descriptor.width===this.textureSize)return;this.discardDepthTexture();const e={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0,width:this.textureSize,height:this.textureSize};this._depthTexture=new Pn(this.rctx,e),this.fbo=new Tn(this.rctx,{colorTarget:0,depthStencilTarget:1,width:this.textureSize,height:this.textureSize},this._depthTexture)}ensureSnapshot(e){const t=this._snapshots[e];if(C(t)&&t.descriptor.width===this.textureSize)return;this.discardSnapshot(e);const i={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0,width:this.textureSize,height:this.textureSize};this._snapshots[e]=new Pn(this.rctx,i)}discardDepthTexture(){this.fbo=P(this.fbo),this._depthTexture=P(this._depthTexture)}discardSnapshot(e){this._snapshots[e]=P(this._snapshots[e])}discardAllSnapshots(){for(let e=0;e<this.snapshotCount;++e)this.discardSnapshot(e)}_bindFbo(){const e=this.rctx;C(this._depthTextureUnit)&&(e.bindTexture(null,this._depthTextureUnit),this._depthTextureUnit=null),e.bindFramebuffer(this.fbo)}constructCascade(e,t,i,r){const s=this.cascades[e],a=-this.cascadeDistances[e],n=-this.cascadeDistances[e+1],o=(t[10]*a+t[14])/Math.abs(t[11]*a+t[15]),l=(t[10]*n+t[14])/Math.abs(t[11]*n+t[15]);Fn(o<l);for(let e=0;e<8;++e){Re(TP,e%4==0||e%4==3?-1:1,e%4==0||e%4==1?-1:1,e<4?o:l,1),He(SP[e],TP,CP);for(let t=0;t<3;++t)SP[e][t]/=SP[e][3]}Ue(zP,SP[0]),Pr(wP,IP,zP),s.camera.viewMatrix=wP;for(let e=0;e<8;++e)Le(SP[e],SP[e],s.camera.viewMatrix);ye(PP,SP[0]),ye(RP,SP[0]);for(let e=1;e<8;++e)for(let t=0;t<3;++t)PP[t]=Math.min(PP[t],SP[e][t]),RP[t]=Math.max(RP[t],SP[e][t]);PP[2]-=200,RP[2]+=200,s.camera.near=-RP[2],s.camera.far=-PP[2],this.warp?this.constructTrapezoidalProjection(i,r,s):this.constructOrthogonalProjection(s),Cr(s.lightMat,s.camera.projectionMatrix,s.camera.viewMatrix);const h=this.textureSize/2;s.camera.viewport[0]=e%2==0?0:h,s.camera.viewport[1]=0===Math.floor(e/2)?0:h,s.camera.viewport[2]=h,s.camera.viewport[3]=h}constructOrthogonalProjection(e){Mr(e.camera.projectionMatrix,PP[0],RP[0],PP[1],RP[1],e.camera.near,e.camera.far)}constructTrapezoidalProjection(e,t,i){const r=1/SP[0][3],s=1/SP[4][3];Fn(r<s);let a=r+Math.sqrt(r*s);const n=Math.sin(Ee(e[2]*t[0]+e[6]*t[1]+e[10]*t[2]));a/=n,function(e,t,i,r,s,a,n,o){Ir(kP,0,0);for(let t=0;t<4;++t)Vr(kP,kP,e[t]);kr(kP,kP,.25),Ir(jP,0,0);for(let t=4;t<8;++t)Vr(jP,jP,e[t]);kr(jP,jP,.25),jr(UP[0],e[4],e[5],.5),jr(UP[1],e[5],e[6],.5),jr(UP[2],e[6],e[7],.5),jr(UP[3],e[7],e[4],.5);let l=0,h=Ur(UP[0],kP);for(let e=1;e<4;++e){const t=Ur(UP[e],kP);t<h&&(h=t,l=e)}Lr(qP,UP[l],e[l+4]);const c=qP[0];qP[0]=-qP[1],qP[1]=c,Lr(HP,jP,kP),qr(HP,qP)<0&&Hr(qP,qP);let d,u;jr(qP,qP,HP,i),Br(qP,qP),d=u=qr(Lr(BP,e[0],kP),qP);for(let t=1;t<8;++t){const i=qr(Lr(BP,e[t],kP),qP);i<d?d=i:i>u&&(u=i)}Er(r,kP),kr(BP,qP,d-t),Vr(r,r,BP);let p=-1,m=1,g=0,f=0;for(let t=0;t<8;++t){Lr(NP,e[t],r),Br(NP,NP);const i=qP[0]*NP[1]-qP[1]*NP[0];i>0?i>p&&(p=i,g=t):i<m&&(m=i,f=t)}En(p>0,"leftArea"),En(m<0,"rightArea"),kr(GP,qP,d),Vr(GP,GP,kP),kr(WP,qP,u),Vr(WP,WP,kP),QP[0]=-qP[1],QP[1]=qP[0];const v=Ln(r,e[f],WP,Vr(BP,WP,QP),1,s),_=Ln(r,e[g],WP,BP,1,a),y=Ln(r,e[g],GP,Vr(BP,GP,QP),1,n),x=Ln(r,e[f],GP,BP,1,o);En(v,"rayRay"),En(_,"rayRay"),En(y,"rayRay"),En(x,"rayRay")}(SP,a,n,MP,DP,AP,OP,FP),function(e,t,i,r,s){Lr(KP,i,r),kr(KP,KP,.5),JP[0]=KP[0],JP[1]=KP[1],JP[2]=0,JP[3]=KP[1],JP[4]=-KP[0],JP[5]=0,JP[6]=KP[0]*KP[0]+KP[1]*KP[1],JP[7]=KP[0]*KP[1]-KP[1]*KP[0],JP[8]=1,JP[ZP(0,2)]=-qr(XP(JP,0),e),JP[ZP(1,2)]=-qr(XP(JP,1),e);let a=qr(XP(JP,0),i)+JP[ZP(0,2)],n=qr(XP(JP,1),i)+JP[ZP(1,2)],o=qr(XP(JP,0),r)+JP[ZP(0,2)],l=qr(XP(JP,1),r)+JP[ZP(1,2)];a=-(a+o)/(n+l),JP[ZP(0,0)]+=JP[ZP(1,0)]*a,JP[ZP(0,1)]+=JP[ZP(1,1)]*a,JP[ZP(0,2)]+=JP[ZP(1,2)]*a,a=1/(qr(XP(JP,0),i)+JP[ZP(0,2)]),n=1/(qr(XP(JP,1),i)+JP[ZP(1,2)]),JP[ZP(0,0)]*=a,JP[ZP(0,1)]*=a,JP[ZP(0,2)]*=a,JP[ZP(1,0)]*=n,JP[ZP(1,1)]*=n,JP[ZP(1,2)]*=n,JP[ZP(2,0)]=JP[ZP(1,0)],JP[ZP(2,1)]=JP[ZP(1,1)],JP[ZP(2,2)]=JP[ZP(1,2)],JP[ZP(1,2)]+=1,a=qr(XP(JP,1),t)+JP[ZP(1,2)],n=qr(XP(JP,2),t)+JP[ZP(2,2)],o=qr(XP(JP,1),i)+JP[ZP(1,2)],l=qr(XP(JP,2),i)+JP[ZP(2,2)],a=-.5*(a/n+o/l),JP[ZP(1,0)]+=JP[ZP(2,0)]*a,JP[ZP(1,1)]+=JP[ZP(2,1)]*a,JP[ZP(1,2)]+=JP[ZP(2,2)]*a,a=qr(XP(JP,1),t)+JP[ZP(1,2)],n=qr(XP(JP,2),t)+JP[ZP(2,2)],o=-n/a,JP[ZP(1,0)]*=o,JP[ZP(1,1)]*=o,JP[ZP(1,2)]*=o,s[0]=JP[0],s[1]=JP[1],s[2]=0,s[3]=JP[2],s[4]=JP[3],s[5]=JP[4],s[6]=0,s[7]=JP[5],s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=JP[6],s[13]=JP[7],s[14]=0,s[15]=JP[8]}(MP,DP,OP,FP,i.camera.projectionMatrix),i.camera.projectionMatrix[10]=2/(PP[2]-RP[2]),i.camera.projectionMatrix[14]=-(PP[2]+RP[2])/(PP[2]-RP[2])}setupMatrices(e,t){Cr(bP,e.projectionMatrix,e.viewMatrix),_r(CP,bP);const i=1===this.viewingMode?e.eye:ve(zP,0,0,1);br(IP,[0,0,0],[-t[0],-t[1],-t[2]],i)}clampNearFar(e){let{near:t,far:i}=e;return t<2&&(t=2),i<2&&(i=2),t>=i&&(t=2,i=4),{near:t,far:i}}computeCascadeDistances(e,t){this.numCascades=Math.min(1+Math.floor(In(e/t,4)),this.maxNumCascades);const i=(e-t)/this.numCascades,r=(e/t)**(1/this.numCascades);let s=t,a=t;for(let e=0;e<this.numCascades+1;++e)this.cascadeDistances[e]=Me(s,a,this.splitSchemeLambda),s*=r,a+=i}getGpuMemoryUsage(){var e,t;return this._snapshots.reduce(((e,t)=>e+Ba(t)),null!=(e=null==(t=this.fbo)?void 0:t.gpuMemoryUsage)?e:0)}get test(){const e=this;return{maxNumCascades:this.maxNumCascades,cascades:this.cascades,textureSize:this.textureSize,depthTexture:this._depthTexture,set splitSchemeLambda(t){e.splitSchemeLambda=t},get splitSchemeLambda(){return e.splitSchemeLambda},set warp(t){e.warp=t},get warp(){return e.warp}}}}const wP=Ar(),bP=Ar(),CP=Ar(),TP=nr(),SP=[];for(let e=0;e<8;++e)SP.push(nr());const PP=fe(),RP=fe(),MP=Nr(),DP=Nr(),AP=Nr(),OP=Nr(),FP=Nr(),IP=Ar(),zP=fe(),EP=[],LP=Ar(),VP=new Float32Array(64),kP=Nr(),jP=Nr(),UP=[Nr(),Nr(),Nr(),Nr()],qP=Nr(),HP=Nr(),BP=Nr(),NP=Nr(),GP=Nr(),WP=Nr(),QP=Nr();function ZP(e,t){return 3*t+e}const YP=Nr();function XP(e,t){return Ir(YP,e[t],e[t+3]),YP}const KP=Nr(),JP=vn();class $P{constructor(e,t,i,r,s,a){this._rctx=e,this._stage=i,this._prepareForShadowMapPass=r,this._renderToShadowMap=s,this._requestRender=a,this._progress=0,this._sampleCount=0,this._cachedCamera=new co,this._contentCamera=new co,this._enabled=!1,this._cachedLightDirections=[],this._depthRange=MT,this._previewing=!1,this._handles=new ar,this._cameraForcedForScreenshot=!1,this._shadowMap=new xP(e,i.viewingMode),this._shadowMap.enabled=!0,this._vao=xs(e);const n={rctx:e,viewingMode:i.viewingMode},o=new fP;o.pass=0,this._accumulationTechnique=new gP(n,o);this._fbo=new Tn(e,{colorTarget:0,depthStencilTarget:0,width:0,height:0},{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0}),this._accumulationParams={camera:this._cachedCamera,linearDepthTexture:null,shadowMap:this._shadowMap,inverseView:Ar(),projInfo:nr(),zScale:Nr()},this._accumulationRenderer=new _P(t,e,this,a);const l=this._stage.resourceController.scheduler;this._handles.add(l.registerTask(qo.SHADOW_ACCUMULATOR,this)),this._handles.add(Ti((()=>i.renderView),(e=>{this._handles.remove($P.renderViewHandleKey),M(e)||this._handles.add(e.events.on("force-camera-for-screenshot",(()=>this._cameraForcedForScreenshot=!0)),$P.renderViewHandleKey)})))}get computedSamples(){return this._progress}get shadowCastTexture(){return this._fbo.colorTexture}get running(){return this._isRefining&&this._canAccumulate}get isAccumulating(){return this._isPreviewing||this._isRefining}get _isRefining(){return this._isActive&&!this._isDoneAccumulating&&!this._previewing}get _isPreviewing(){return this._isActive&&this._previewing}get _isActive(){return this._enabled&&this._sampleCount>0}get _canAccumulate(){return null!==this._accumulationParams.linearDepthTexture&&this._depthRange!==MT&&this._opacityFromElevation>.001953125}get _isDoneAccumulating(){return this._progress>=this._sampleCount}get _lightDirections(){return this._cachedLightDirections}set _lightDirections(e){const t=this._cachedLightDirections;if(sh(t,e,be))return;const i=e.length;t.length=i,this._sampleCount=Math.min(255,i);for(let r=0;r<i;++r){const i=e[r],s=t[r]||fe();ye(s,i),t[r]=s}this._invalidate()}get _projInfo(){return this._accumulationParams.projInfo}get _zScale(){return this._accumulationParams.zScale}get _inverseView(){return this._accumulationParams.inverseView}get _opacityFromElevation(){return this._accumulationRenderer.opacityFromElevation}set _opacityFromElevation(e){this._accumulationRenderer.opacityFromElevation=e}runTask(e){for(this._prepareForShadowMapPass(this._cachedCamera,this._contentCamera);!e.done&&!this._isDoneAccumulating;)this._accumulateShadow(),e.madeProgress();this._requestRender()}accumulateFixedSamples(){if(!this.isAccumulating||!this._canAccumulate)return;(this._previewing||0===this._progress||this._cameraForcedForScreenshot)&&this._clear();const e=this._cameraForcedForScreenshot?this._sampleCount:Math.min($P.previewSamples,this._sampleCount-this._progress);for(let t=0;t<e;++t)this._accumulateShadow();this._cameraForcedForScreenshot=!1}render(){this._accumulationRenderer.render()}dispose(){this._stop(),this._handles.destroy(),this._accumulationRenderer=P(this._accumulationRenderer),this._shadowMap=P(this._shadowMap),this._fbo=P(this._fbo),this._vao=P(this._vao),this._accumulationTechnique=P(this._accumulationTechnique),this._cachedLightDirections.length=0,this._sampleCount=0}setOptions(e){void 0!==e.enabled&&this._setEnabled(e.enabled),void 0!==e.previewing&&this.setPreviewing(e.previewing),void 0!==e.lightDirections&&this.setLightDirections(e.lightDirections),this._accumulationRenderer.setOptions(e)}setPreviewing(e){this._previewing!==e&&(this._previewing=e,this._requestRenderIfEnabled())}setLightDirections(e){this._lightDirections=e}setAccumulationDependencies(e,t,i,r){this._accumulationParams.linearDepthTexture=e,this._depthRange=t,this._updateCamera(i),this._contentCamera=r}readAccumulatedShadow(e,t){if(!this._isActive||this._progress<1||e<0||e>this._fbo.width||t<0||t>this._fbo.height)return 0;const i=eR;return this._fbo.readPixels(e,t,1,1,6408,5121,i),i[0]/this._progress}_start(){this._progress=0,this._enabled=!0}_stop(){this._enabled=!1}_invalidate(){this._progress=0,this._requestRenderIfEnabled()}_clear(){this._rctx.bindFramebuffer(this._fbo),this._rctx.setClearColor(0,0,0,0),this._rctx.clearSafe(16384),this._progress=0}_accumulateShadow(){const e=this._lightDirections[this._progress],t=this._cachedCamera;this._renderToShadowMap(this._shadowMap,e,t,this._depthRange),this._rctx.bindFramebuffer(this._fbo),this._rctx.useProgram(this._accumulationTechnique.program),this._accumulationTechnique.bindPipelineState(this._rctx),this._accumulationTechnique.bindPass(this._accumulationParams),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(this._accumulationTechnique.primitiveType,0,Ua(this._vao,"geometry")),this._progress++}_updateCamera(e){if(e.equals(this._cachedCamera))return;const{fullWidth:t,fullHeight:i,projectionMatrix:r,viewMatrix:s,center:a}=e;this._cachedCamera.copyFrom(e),this._fbo.resize(t,i),Vn(r,t,i,this._projInfo,this._zScale),Pr(this._inverseView,s,a),_r(this._inverseView,this._inverseView),this._opacityFromElevation=1-lt(4e4,5e4,e.relativeElevation)}_setEnabled(e){e!==this._enabled&&(e?this._start():this._stop())}_requestRenderIfEnabled(){this._enabled&&this._requestRender()}get test(){return{lightDirections:this._lightDirections,isDone:()=>this._isDoneAccumulating,isActive:()=>this._isActive}}}$P.previewSamples=6,$P.renderViewHandleKey="renderView";const eR=new Uint8Array(4);var tR=Object.freeze({__proto__:null,build:function(e){const t=new ds;return t.include(cn),t.fragment.include(Cs),t.fragment.include(ps),t.include(mc),t.include(Xo),t.fragment.uniforms.add("defaultDepthTex","sampler2D").add("highlightDepthTex","sampler2D").add("depthMap","sampler2D").add("highlightMap","sampler2D").add("color","vec4").add("nearFar","vec2").add("opacity","float").add("occludedOpacity","float").add("terminationFactor","float").add("inverseView","mat4").add("lightingMainDirectionView","vec3").add("texelSize","vec2"),t.fragment.constants.add("unoccludedHighlightFlag","vec4",ra).add("highlightedThreshold","float",e.highlightedThreshold).add("selfShadowThreshold","float",e.selfShadowThreshold),t.fragment.code.add(us`vec3 normalFromDepth(vec3 pixelPos, vec2 fragCoord, vec2 uv, vec2 texelSize, sampler2D depthMap, vec2 nearFar) {
float leftPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(-1.0, 0.0) * texelSize, nearFar);
float rightPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(1.0, 0.0) * texelSize, nearFar);
float bottomPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(0.0, -1.0) * texelSize, nearFar);
float topPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(0.0, 1.0) * texelSize, nearFar);
bool pickLeft = abs(pixelPos.z - leftPixelDepth) < abs(pixelPos.z - rightPixelDepth);
bool pickBottom = abs(pixelPos.z - bottomPixelDepth) < abs(pixelPos.z - topPixelDepth);
vec3 fragCoordHorizontal = pickLeft
? vec3(fragCoord + vec2(-1.0, 0.0), leftPixelDepth)
: vec3(fragCoord + vec2(1.0, 0.0), rightPixelDepth);
vec3 fragCoordVertical = pickBottom
? vec3(fragCoord + vec2(0.0, -1.0), bottomPixelDepth)
: vec3(fragCoord + vec2(0.0, 1.0), topPixelDepth);
vec3 verticalPixelPos = reconstructPosition(fragCoordHorizontal.xy, fragCoordHorizontal.z);
vec3 horizontalPixelPos = reconstructPosition(fragCoordVertical.xy, fragCoordVertical.z);
vec3 normal = normalize(cross(verticalPixelPos - pixelPos, horizontalPixelPos - pixelPos));
return pickLeft == pickBottom ? normal : -normal;
}`),t.fragment.code.add(us`void main(void) {
vec4 highlightInfo = texture2D(highlightMap, uv);
float visiblyHighlighted = (1.0 - clamp(distance(unoccludedHighlightFlag, highlightInfo), 0.0, 1.0)) * highlightInfo.a;
if (visiblyHighlighted > highlightedThreshold) {
discard;
}
float depth = rgba2float(texture2D(depthMap, uv));
if (depth == 0.0) {
discard;
}
float currentPixelDepth = linearDepthFromFloat(depth, nearFar);
if (-currentPixelDepth>nearFar.y || -currentPixelDepth<nearFar.x) {
discard;
}
vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
vec4 worldSpacePos = inverseView * currentPixelPos;
mat4 shadowMatrix;
float linearDepth = -currentPixelDepth;
int i = chooseCascade(linearDepth, shadowMatrix);
if (i >= uShadowMapNum) {
discard;
}
vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);
if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
discard;
}
vec2 uvShadow = cascadeCoordinates(i, lvpos);
float depthHighlight = readShadowMapDepth(uvShadow, highlightDepthTex);
bool shadowHighlight = depthHighlight < lvpos.z;
if (!shadowHighlight) {
discard;
}
float depthDefault = readShadowMapDepth(uvShadow, defaultDepthTex);
bool shadowDefault = depthDefault < lvpos.z;
vec3 normal = normalFromDepth(currentPixelPos.xyz, gl_FragCoord.xy, uv, texelSize, depthMap, nearFar);
bool shaded = dot(normal, lightingMainDirectionView) < selfShadowThreshold;
float differenceOpacity = opacity;
float bothOpacity = occludedOpacity;
float fragOpacity = (shadowDefault || shaded) ? bothOpacity : differenceOpacity;
gl_FragColor = vec4(color.rgb, color.a * fragOpacity * terminationFactor);
}`),t}});class iR extends vs{constructor(){super(...arguments),this.opacityElevation=1,this.dayNightTerminator=1,this.highlightShadowMapSlot=0,this.defaultSnapshotSlot=1}initializeProgram(e){const t=iR.shader.get();this._viewingMode=e.viewingMode;const i=t.build({highlightedThreshold:.99999,selfShadowThreshold:.025});return new _s(e.rctx,i,ys)}initializePipeline(e){return Ea({blending:La(770,1,771,771),colorWrite:Va,depthTest:null,depthWrite:null})}bindPass(e,t){this.opacityElevation=1-lt(4e4,5e4,t.camera.relativeElevation);const i=1===this._viewingMode?we(rR,t.camera.center):ve(rR,0,0,1),r=Ie(i,t.lighting.lightingMainDirection);this.dayNightTerminator=lt(0,1,ue(30*r,0,1)),this.program.bindTexture(t.linearDepthTexture,"depthMap"),this.program.bindTexture(t.highlightColorTexture,"highlightMap"),Le(sR,t.lighting.lightingMainDirection,t.camera.viewInverseTransposeMatrix),we(sR,sR),Vn(t.camera.projectionMatrix,t.camera.fullWidth,t.camera.fullHeight,nR,aR),Pr(oR,t.camera.viewMatrix,t.camera.center),_r(oR,oR),this.program.setUniform4fv("color",e.shadowColor),this.program.setUniform1f("opacity",e.shadowOpacity),this.program.setUniform1f("occludedOpacity",e.occludedShadowOpacity),this.program.setUniform1f("terminationFactor",this.opacityElevation*this.dayNightTerminator),this.program.setUniform2fv("nearFar",t.camera.nearFar),this.program.setUniformMatrix4fv("inverseView",oR),this.program.setUniform4fv("projInfo",nR),this.program.setUniform2fv("zScale",aR),this.program.setUniform3fv("lightingMainDirectionView",sR),this.program.setUniform2f("texelSize",1/t.linearDepthTexture.descriptor.width,1/t.linearDepthTexture.descriptor.height),t.shadowMap.bind(this.program),t.shadowMap.bindView(this.program,t.camera.center);let s=t.shadowMap.getSnapshot(this.highlightShadowMapSlot);C(s)&&this.program.bindTexture(s,"highlightDepthTex"),s=t.shadowMap.getSnapshot(this.defaultSnapshotSlot),C(s)&&this.program.bindTexture(s,"defaultDepthTex")}get primitiveType(){return 5}}iR.shader=new gs(tR,(()=>Promise.resolve().then((function(){return tR}))));const rR=fe(),sR=fe(),aR=Nr(),nR=nr(),oR=Ar();class lR{constructor(e,t){this._rctx=e,this._maxOpacity=1,this._defaultOptions={shadowColor:Dl(1,0,1,1),shadowOpacity:.2,occludedShadowOpacity:.1},this._technique=new iR({rctx:e,viewingMode:t},null),this._vao=xs(this._rctx)}render(e,t){e.shadowMap.enabled&&e.linearDepthTexture&&this.isVisible&&(this._rctx.bindFramebuffer(t),this._rctx.useProgram(this._technique.program),this._technique.bindPipelineState(this._rctx),this._technique.bindPass(this._defaultOptions,e),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(this._technique.primitiveType,0,Ua(this._vao,"geometry")))}getGpuMemoryUsage(){return this._vao?this._vao.size:0}setDefaultOptions(e){this._defaultOptions=e,this._updateMaxOpacity()}get highlightShadowMapSlot(){return this._technique.highlightShadowMapSlot}get defaultSnapshotSlot(){return this._technique.defaultSnapshotSlot}dispose(){this._vao=P(this._vao),this._technique=P(this._technique)}get isVisible(){return this._maxOpacity*this._technique.opacityElevation*this._technique.dayNightTerminator>=.001953125}_updateMaxOpacity(){const e=this._defaultOptions,t=e.shadowColor,i=Math.max(e.shadowOpacity,e.occludedShadowOpacity);this._maxOpacity=i*t[3]}}const hR=Gt();class cR{constructor(){this._worldPlane=hR}get isEnabled(){return this.plane!==hR}get plane(){return this._worldPlane}set plane(e){this._worldPlane=e||hR}}var dR=Object.freeze({__proto__:null,build:function(e){const t=new ds;return 0===e.output&&(t.attributes.add("position","vec2"),t.vertex.uniforms.add("uResolution","vec4"),t.varyings.add("fTexCoord","vec2"),t.varyings.add("fOffset[3]","vec4"),t.vertex.code.add(us`void SMAAEdgeDetectionVS( vec2 texcoord ) {
fOffset[0] = texcoord.xyxy + uResolution.xyxy * vec4( -1.0, 0.0, 0.0,  1.0 );
fOffset[1] = texcoord.xyxy + uResolution.xyxy * vec4(  1.0, 0.0, 0.0, -1.0 );
fOffset[2] = texcoord.xyxy + uResolution.xyxy * vec4( -2.0, 0.0, 0.0,  2.0 );
}
void main() {
fTexCoord = (position + 1.0 ) * 0.5;
gl_Position = vec4(position, 0, 1);
SMAAEdgeDetectionVS( fTexCoord );
}`),t.fragment.uniforms.add("tColor","sampler2D"),t.fragment.code.add(us`
      vec4 SMAAColorEdgeDetectionPS( vec2 texcoord, vec4 offset[3], sampler2D colorTex ) {
        vec2 threshold = vec2( ${us.float(e.threshold)} );

        // Calculate color deltas:
        vec4 delta;
        vec3 C = texture2D( colorTex, texcoord ).rgb;

        vec3 Cleft = texture2D( colorTex, offset[0].xy ).rgb;
        vec3 t = abs( C - Cleft );
        delta.x = max( max( t.r, t.g ), t.b );

        vec3 Ctop = texture2D( colorTex, offset[0].zw ).rgb;
        t = abs( C - Ctop );
        delta.y = max( max( t.r, t.g ), t.b );

        // We do the usual threshold:
        vec2 edges = step( threshold, delta.xy );

        // Then discard if there is no edge:
        if ( dot( edges, vec2( 1.0, 1.0 ) ) == 0.0 )
            discard;

        // Calculate right and bottom deltas:
        vec3 Cright = texture2D( colorTex, offset[1].xy ).rgb;
        t = abs( C - Cright );
        delta.z = max( max( t.r, t.g ), t.b );

        vec3 Cbottom  = texture2D( colorTex, offset[1].zw ).rgb;
        t = abs( C - Cbottom );
        delta.w = max( max( t.r, t.g ), t.b );

        // Calculate the maximum delta in the direct neighborhood:
        float maxDelta = max( max( max( delta.x, delta.y ), delta.z ), delta.w );

        // Calculate left-left and top-top deltas:
        vec3 Cleftleft  = texture2D( colorTex, offset[2].xy ).rgb;
        t = abs( C - Cleftleft );
        delta.z = max( max( t.r, t.g ), t.b );

        vec3 Ctoptop = texture2D( colorTex, offset[2].zw ).rgb;
        t = abs( C - Ctoptop );
        delta.w = max( max( t.r, t.g ), t.b );

        // Calculate the final maximum delta:
        maxDelta = max( max( maxDelta, delta.z ), delta.w );

        // Local contrast adaptation in action:
        edges.xy *= step( maxDelta, float(${us.float(e.localConstrastAdaption)}) * delta.xy );

        return vec4( edges, 0.0, 0.0 );
      }

      void main() {
        gl_FragColor = SMAAColorEdgeDetectionPS( fTexCoord, fOffset, tColor );
      }
    `)),1===e.output&&(t.attributes.add("position","vec2"),t.vertex.uniforms.add("uResolution","vec4"),t.varyings.add("fTexCoord","vec2"),t.varyings.add("fOffset[3]","vec4"),t.varyings.add("fPixCoord","vec2"),t.vertex.code.add(us`
      void SMAABlendingWeightCalculationVS( vec2 texcoord ) {
        fPixCoord = texcoord * uResolution.zw;
        fOffset[0] = texcoord.xyxy + uResolution.xyxy * vec4( -0.25, 0.125, 1.25, 0.125 );
        fOffset[1] = texcoord.xyxy + uResolution.xyxy * vec4( -0.125, 0.25, -0.125, -1.25 );
        fOffset[2] = vec4( fOffset[0].xz, fOffset[1].yw ) + vec4( -2.0, 2.0, -2.0, 2.0 ) * uResolution.xxyy * float( ${us.int(e.maxSearchSteps)} );
      }

      void main() {
        fTexCoord = (position + 1.0 ) * 0.5;
        gl_Position = vec4(position, 0, 1);
        SMAABlendingWeightCalculationVS( fTexCoord );
      }
    `),t.fragment.uniforms.add("tEdges","sampler2D").add("tArea","sampler2D").add("tSearch","sampler2D").add("tColor","sampler2D").add("uResolution","vec4"),t.fragment.code.add(us`
      #define SMAA_AREATEX_PIXEL_SIZE ( 1.0 / vec2( 160.0, 560.0 ) )
      #define SMAA_AREATEX_SUBTEX_SIZE ( 1.0 / 7.0 )

      vec4 SMAASampleLevelZeroOffset(sampler2D tex, vec2 coord, vec2 offset) {
        return texture2D( tex, coord + offset.x * uResolution.xy, 0.0 );
      }

      vec2 round( vec2 x ) {
        return sign( x ) * floor( abs( x ) + 0.5 );
      }

      float SMAASearchLength( sampler2D searchTex, vec2 e, float bias, float scale ) {
        e.r = bias + e.r * scale;
        return 255.0 * texture2D( searchTex, e, 0.0 ).r;
      }

      float SMAASearchXLeft( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 0.0, 1.0 );
        for ( int i = 0; i < ${us.int(e.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord -= vec2( 2.0, 0.0 ) * uResolution.xy;
          if ( ! ( texcoord.x > end && e.g > 0.8281 && e.r == 0.0 ) ) break;
        }
        texcoord.x += 0.25 * uResolution.x;
        texcoord.x += uResolution.x;
        texcoord.x += 2.0 * uResolution.x;
        texcoord.x -= uResolution.x * SMAASearchLength(searchTex, e, 0.0, 0.5);
        return texcoord.x;
      }

      float SMAASearchXRight( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 0.0, 1.0 );
        for ( int i = 0; i < ${us.int(e.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord += vec2( 2.0, 0.0 ) * uResolution.xy;
          if ( ! ( texcoord.x < end && e.g > 0.8281 && e.r == 0.0 ) ) break;
        }
        texcoord.x -= 0.25 * uResolution.x;
        texcoord.x -= uResolution.x;
        texcoord.x -= 2.0 * uResolution.x;
        texcoord.x += uResolution.x * SMAASearchLength( searchTex, e, 0.5, 0.5 );
        return texcoord.x;
      }

      float SMAASearchYUp( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 1.0, 0.0 );
        for ( int i = 0; i < ${us.int(e.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord += vec2( 0.0, 2.0 ) * uResolution.xy;
          if ( ! ( texcoord.y > end && e.r > 0.8281 && e.g == 0.0 ) ) break;
        }
        texcoord.y -= 0.25 * uResolution.y;
        texcoord.y -= uResolution.y;
        texcoord.y -= 2.0 * uResolution.y;
        texcoord.y += uResolution.y * SMAASearchLength( searchTex, e.gr, 0.0, 0.5 );
        return texcoord.y;
      }

      float SMAASearchYDown( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 1.0, 0.0 );
        for ( int i = 0; i < ${us.int(e.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord -= vec2( 0.0, 2.0 ) * uResolution.xy;
          if ( ! ( texcoord.y < end && e.r > 0.8281 && e.g == 0.0 ) ) break;
        }
        texcoord.y += 0.25 * uResolution.y;
        texcoord.y += uResolution.y;
        texcoord.y += 2.0 * uResolution.y;
        texcoord.y -= uResolution.y * SMAASearchLength( searchTex, e.gr, 0.5, 0.5 );
        return texcoord.y;
      }

      vec2 SMAAArea( sampler2D areaTex, vec2 dist, float e1, float e2, float offset ) {
        vec2 texcoord = float( ${us.int(e.maxDistanceAreaTex)} ) * round( 4.0 * vec2( e1, e2 ) ) + dist;
        texcoord = SMAA_AREATEX_PIXEL_SIZE * texcoord + ( 0.5 * SMAA_AREATEX_PIXEL_SIZE );
        texcoord.y += SMAA_AREATEX_SUBTEX_SIZE * offset;
        return texture2D( areaTex, texcoord, 0.0 ).rg;
      }

      vec4 SMAABlendingWeightCalculationPS( vec2 texcoord, vec2 pixcoord, vec4 offset[ 3 ], sampler2D edgesTex, sampler2D areaTex, sampler2D searchTex, ivec4 subsampleIndices ) {
        vec4 weights = vec4( 0.0, 0.0, 0.0, 0.0 );
        vec2 e = texture2D( edgesTex, texcoord ).rg;
        if ( e.g > 0.0 ) {
          vec2 d;
          vec2 coords;
          coords.x = SMAASearchXLeft( edgesTex, searchTex, offset[ 0 ].xy, offset[ 2 ].x );
          coords.y = offset[ 1 ].y;
          d.x = coords.x;
          float e1 = texture2D( edgesTex, coords, 0.0 ).r;
          coords.x = SMAASearchXRight( edgesTex, searchTex, offset[ 0 ].zw, offset[ 2 ].y );
          d.y = coords.x;
          d = d * uResolution.z - pixcoord.x;
          vec2 sqrt_d = sqrt( abs( d ) );
          coords.y -= 1.0 * uResolution.y;
          float e2 = SMAASampleLevelZeroOffset( edgesTex, coords, vec2( 1.0, 0.0 ) ).r;
          weights.rg = SMAAArea( areaTex, sqrt_d, e1, e2, float( subsampleIndices.y ) );
        }

        if ( e.r > 0.0 ) {
          vec2 d;
          vec2 coords;
          coords.y = SMAASearchYUp( edgesTex, searchTex, offset[ 1 ].xy, offset[ 2 ].z );
          coords.x = offset[ 0 ].x;
          d.x = coords.y;
          float e1 = texture2D( edgesTex, coords, 0.0 ).g;
          coords.y = SMAASearchYDown( edgesTex, searchTex, offset[ 1 ].zw, offset[ 2 ].w );
          d.y = coords.y;
          d = d * uResolution.w - pixcoord.y;
          vec2 sqrt_d = sqrt( abs( d ) );
          coords.y -= 1.0 * uResolution.y;
          float e2 = SMAASampleLevelZeroOffset( edgesTex, coords, vec2( 0.0, 1.0 ) ).g;
          weights.ba = SMAAArea( areaTex, sqrt_d, e1, e2, float( subsampleIndices.x ) );

          // for some reason the following lines are necessary to prevent
          // texture lookup precision issues on some Intel integrated graphics chips
          vec4 dbg = (offset[ 0 ]+offset[ 1 ]+offset[ 2 ] + coords.xyyx);
          weights.r += 0.00000001 * dot(vec4(0,1,0,1),dbg);
        }
        return weights;
      }

      void main() {
        gl_FragColor = SMAABlendingWeightCalculationPS( fTexCoord, fPixCoord, fOffset, tEdges, tArea, tSearch, ivec4( 0.0 ) );
      }
    `)),2===e.output&&(t.attributes.add("position","vec2"),t.vertex.uniforms.add("uResolution","vec4"),t.varyings.add("fTexCoord","vec2"),t.varyings.add("fOffset[2]","vec4"),t.vertex.code.add(us`void SMAANeighborhoodBlendingVS( vec2 texcoord ) {
fOffset[0] = texcoord.xyxy + uResolution.xyxy * vec4( -1.0, 0.0, 0.0, 1.0 );
fOffset[1] = texcoord.xyxy + uResolution.xyxy * vec4( 1.0, 0.0, 0.0, -1.0 );
}
void main() {
fTexCoord = (position + 1.0 ) * 0.5;
gl_Position = vec4(position, 0, 1);
SMAANeighborhoodBlendingVS(fTexCoord);
}`),t.fragment.uniforms.add("tBlendWeights","sampler2D"),t.fragment.uniforms.add("tColor","sampler2D"),t.fragment.uniforms.add("uResolution","vec4"),t.fragment.code.add(us`vec4 SMAANeighborhoodBlendingPS( vec2 texcoord, vec4 offset[ 2 ], sampler2D colorTex, sampler2D blendTex ) {
vec4 a;
a.xz = texture2D( blendTex, texcoord ).xz;
a.y = texture2D( blendTex, offset[ 1 ].zw ).g;
a.w = texture2D( blendTex, offset[ 1 ].xy ).a;
if ( dot(a, vec4( 1.0, 1.0, 1.0, 1.0 )) < 1e-5 ) {
return texture2D( colorTex, texcoord, 0.0 );
} else {
vec2 offset;
offset.x = a.a > a.b ? a.a : -a.b;
offset.y = a.g > a.r ? -a.g : a.r;
if ( abs( offset.x ) > abs( offset.y )) {
offset.y = 0.0;
} else {
offset.x = 0.0;
}
vec4 C = texture2D( colorTex, texcoord, 0.0 );
texcoord += sign( offset ) * uResolution.xy;
vec4 Cop = texture2D( colorTex, texcoord, 0.0 );
float s = abs( offset.x ) > abs( offset.y ) ? abs( offset.x ) : abs( offset.y );
vec4 mixed = mix(C, Cop, s);
return mixed;
}
}
void main() {
gl_FragColor = SMAANeighborhoodBlendingPS( fTexCoord, fOffset, tColor, tBlendWeights );
}`)),t}});class uR extends vs{initializeProgram(e){const t=uR.shader.get(),i=this.configuration,r=t.build({output:i.output,threshold:.05,localConstrastAdaption:2,maxSearchSteps:8,maxDistanceAreaTex:16});return new _s(e.rctx,r,ys)}initializePipeline(){return Ea({colorWrite:Va})}}uR.shader=new gs(dR,(()=>Promise.resolve().then((function(){return dR}))));class pR extends fs{constructor(){super(...arguments),this.output=0}}e([ms({count:3})],pR.prototype,"output",void 0);class mR{constructor(e,t){this.rctx=e,this._techniqueRep=t,this.resourceLoadingPromise=null,this.isEnabled=!1}loadResources(e){if(!this.data||!this.textureArea||!this.textureSearch){const t=this.resourceLoadingPromise||this.loadDataModule().then((()=>this.loadTextures()));return e&&t.then(e),this.resourceLoadingPromise||(this.resourceLoadingPromise=t,t.then((()=>this.resourceLoadingPromise=null))),!1}return!0}loadDataModule(){return this.data?Promise.resolve():import("../chunks/SmaaRenderPassData.js").then((e=>{this.data=e}))}loadTextures(){return Promise.all([this.loadTextureFromBase64(this.data.areaTexture,9729,6407),this.loadTextureFromBase64(this.data.searchTexure,9728,6409)]).then((([e,t])=>{this.textureArea=e,this.textureSearch=t}))}get isLoadingResources(){return null!=this.resourceLoadingPromise}enable(){if(this.isEnabled)return!0;if(!this._edgeDetectTechnique||!this._blendWeights||!this._blur){const e=new pR,t=(e,t)=>this._techniqueRep.releaseAndAcquire(uR,e,t);e.output=0,this._edgeDetectTechnique=t(e,this._edgeDetectTechnique),e.output=1,this._blendWeights=t(e,this._blendWeights),e.output=2,this._blur=t(e,this._blur)}return!!this.loadResources()&&(this.vao=sa(this.rctx),this.edges=new Tn(this.rctx,{colorTarget:0,depthStencilTarget:0},{target:3553,pixelFormat:6407,dataType:5121,samplingMode:9729,wrapMode:33071,width:4,height:4}),this.blend=new Tn(this.rctx,{colorTarget:0,depthStencilTarget:0},{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:4,height:4}),this.isEnabled=!0,!0)}disable(){this.isEnabled&&(this.vao.dispose(),this.vao=null,this.textureArea.dispose(),this.textureArea=null,this.textureSearch.dispose(),this.textureSearch=null,this.blend.dispose(),this.blend=null,this.edges.dispose(),this.edges=null,this.isEnabled=!1)}render(e){this.enable();const t=this.rctx,i=t.getBoundFramebufferObject(),r={x:0,y:0,width:e.colorTexture.descriptor.width,height:e.colorTexture.descriptor.height};t.bindVAO(this.vao),t.setPipelineState(this._edgeDetectTechnique.pipeline),t.setViewport(r.x,r.y,r.width,r.height),this.edges.resize(r.width,r.height),t.bindFramebuffer(this.edges),t.setClearColor(0,0,0,1),t.clear(16384),t.useProgram(this._edgeDetectTechnique.program),this._edgeDetectTechnique.program.bindTexture(e.colorTexture,"tColor"),this._edgeDetectTechnique.program.setUniform4f("uResolution",1/r.width,1/r.height,r.width,r.height),t.drawArrays(4,0,3),this.blend.resize(r.width,r.height),t.bindFramebuffer(this.blend),t.setClearColor(0,0,1,1),t.clear(16384),t.useProgram(this._blendWeights.program),this._blendWeights.program.setUniform4f("uResolution",1/r.width,1/r.height,r.width,r.height),this._blendWeights.program.bindTexture(this.textureSearch,"tSearch"),this._blendWeights.program.bindTexture(this.textureArea,"tArea"),this._blendWeights.program.bindTexture(this.edges.colorTexture,"tEdges"),t.drawArrays(4,0,3),t.bindFramebuffer(i),t.setClearColor(0,1,0,1),t.clear(16384),t.useProgram(this._blur.program),this._blur.program.setUniform4f("uResolution",1/r.width,1/r.height,r.width,r.height),this._blur.program.bindTexture(e.colorTexture,"tColor"),this._blur.program.bindTexture(this.blend.colorTexture,"tBlendWeights"),t.drawArrays(4,0,3)}loadTextureFromBase64(e,t,i){const r=new Pn(this.rctx,{pixelFormat:i,dataType:5121,wrapMode:33071,samplingMode:t},null);return Rn(e).then((e=>(r.resize(e.width,e.height),r.setData(e),r)))}}var gR=Object.freeze({__proto__:null,build:function(e){const t=new ds;return t.include(Xo),1===e.output&&(t.fragment.include(ps),t.fragment.uniforms.add("normalMap","sampler2D").add("depthMap","sampler2D").add("tex","sampler2D").add("blurSize","vec2").add("projScale","float").add("nearFar","vec2"),t.fragment.code.add(us`
      void blurFunction(vec2 uv, float r, float center_d, float sharpness, inout float wTotal, inout float bTotal) {
        float c = texture2D(tex, uv).r;
        float d = linearDepthFromTexture(depthMap, uv, nearFar);

        float ddiff = d - center_d;

        float w = exp(-r * r * ${us.float(e.blurFalloff)} - ddiff * ddiff * sharpness);
        wTotal += w;
        bTotal += w * c;
      }
    `),t.fragment.code.add(us`
      void main(void) {
        float b = 0.0;
        float w_total = 0.0;

        float center_d = linearDepthFromTexture(depthMap, uv, nearFar);

        float sharpness = -0.05 * projScale/center_d;
        for (int r = -${us.int(e.filterRadius)}; r <= ${us.int(e.filterRadius)}; ++r) {
          float rf = float(r);
          vec2 uvOffset = uv + rf * blurSize;
          blurFunction(uvOffset, rf, center_d, sharpness, w_total, b);
        }

        gl_FragColor = vec4(b / w_total);
      }
    `)),0===e.output&&(t.fragment.include(ps),t.include(mc),t.fragment.uniforms.add("normalMap","sampler2D").add("depthMap","sampler2D").add("intensity","float").add("projScale","float").add("radius","float").add("nearFar","vec2").add("screenDimensions","vec2").add("rnmScale","vec2").add("rnm","sampler2D"),t.fragment.code.add(us`vec3 sphere[16];
void fillSphere() {
sphere[0] = vec3(0.186937, 0.0, 0.0);
sphere[1] = vec3(0.700542, 0.0, 0.0);
sphere[2] = vec3(-0.864858, -0.481795, -0.111713);
sphere[3] = vec3(-0.624773, 0.102853, -0.730153);
sphere[4] = vec3(-0.387172, 0.260319, 0.007229);
sphere[5] = vec3(-0.222367, -0.642631, -0.707697);
sphere[6] = vec3(-0.01336, -0.014956, 0.169662);
sphere[7] = vec3(0.122575, 0.1544, -0.456944);
sphere[8] = vec3(-0.177141, 0.85997, -0.42346);
sphere[9] = vec3(-0.131631, 0.814545, 0.524355);
sphere[10] = vec3(-0.779469, 0.007991, 0.624833);
sphere[11] = vec3(0.308092, 0.209288,0.35969);
sphere[12] = vec3(0.359331, -0.184533, -0.377458);
sphere[13] = vec3(0.192633, -0.482999, -0.065284);
sphere[14] = vec3(0.233538, 0.293706, -0.055139);
sphere[15] = vec3(0.417709, -0.386701, 0.442449);
}
float fallOffFunction(float vv, float vn, float bias) {
float f = max(radius * radius - vv, 0.0);
return f * f * f * max(vn-bias, 0.0);
}`),t.fragment.code.add(us`float aoValueFromPositionsAndNormal(vec3 C, vec3 n_C, vec3 Q) {
vec3 v = Q - C;
float vv = dot(v, v);
float vn = dot(normalize(v), n_C);
return fallOffFunction(vv, vn, 0.1);
}`),t.fragment.code.add(us`
      void main(void) {
        fillSphere();
        vec3 fres = normalize((texture2D(rnm, uv * rnmScale).xyz * 2.0) - vec3(1.0));
        float currentPixelDepth = linearDepthFromTexture(depthMap, uv, nearFar);

        if (-currentPixelDepth>nearFar.y || -currentPixelDepth<nearFar.x) {
          gl_FragColor = vec4(0.0);
          return;
        }

        vec3 currentPixelPos = reconstructPosition(gl_FragCoord.xy,currentPixelDepth);

        // get the normal of current fragment
        vec4 norm4 = texture2D(normalMap, uv);
        vec3 norm = vec3(-1.0) + 2.0 * norm4.xyz;
        bool isTerrain = norm4.w<0.5;

        float sum = .0;
        vec3 tapPixelPos;

        // note: the factor 2.0 should not be necessary, but makes ssao much nicer.
        // bug or deviation from CE somewhere else?
        float ps = projScale/(2.0 * currentPixelPos.z * zScale.x + zScale.y);

        for(int i = 0; i < ${us.int(e.samples)}; ++i) {
          vec2 unitOffset = reflect(sphere[i], fres).xy;
          vec2 offset = vec2(-unitOffset * radius * ps);

          //don't use current or very nearby samples
          if ( abs(offset.x)<2.0 || abs(offset.y)<2.0) continue;

          vec2 tc = vec2(gl_FragCoord.xy + offset);
          if (tc.x < 0.0 || tc.y < 0.0 || tc.x > screenDimensions.x || tc.y > screenDimensions.y) continue;
          vec2 tcTap = tc/screenDimensions;
          float occluderFragmentDepth = linearDepthFromTexture(depthMap, tcTap, nearFar);

          if (isTerrain) {
            bool isTerrainTap = texture2D(normalMap, tcTap).w<0.5;
            if (isTerrainTap) {
              continue;
            }
          }

          tapPixelPos = reconstructPosition(tc, occluderFragmentDepth);

          sum+= aoValueFromPositionsAndNormal(currentPixelPos, norm, tapPixelPos);
        }

        // output the result
        float A = max(1.0-sum*intensity/float(${us.int(e.samples)}),0.0);

        // Anti-tone map to reduce contrast and drag dark region farther: (x^0.2 + 1.2 * x^4)/2.2
        A = (pow(A, 0.2) + 1.2 * A*A*A*A) / 2.2;
        gl_FragColor = vec4(A);
      }
    `)),t}});class fR extends vs{initializeProgram(e){const t=fR.shader.get(),i=this.configuration,r=(fR.filterRadius+1)/2,s=1/(2*r*r),a=t.build({output:i.output,samples:fR.samples,filterRadius:fR.filterRadius,blurFalloff:s});return new _s(e.rctx,a,ys)}initializePipeline(){return Ea({colorWrite:Va})}}fR.shader=new gs(gR,(()=>Promise.resolve().then((function(){return gR})))),fR.samples=16,fR.filterRadius=4;class vR extends fs{constructor(){super(...arguments),this.output=0}}e([ms({count:2})],vR.prototype,"output",void 0);class _R{constructor(e,t,i){this._techniqueRep=e,this._rctx=t,this._requestRender=i,this._enabled=!1,this._ssaoTechniqueConfig=new vR,this.quadVAO=null,this._blurSizePx=2,this._attenuation=.5}dispose(){this.quadVAO=P(this.quadVAO)}set enabled(e){e?this._enable():this._disable()}get enabled(){return this._enabled}get ready(){return this.enabled&&C(this._noiseTexture)&&C(this._ssaoFBO)&&C(this._blur0FBO)&&C(this._blur1FBO)}computeSSAO(e,t,i){if(!this.enabled||M(this._noiseTexture)||M(this._ssaoFBO)||M(this._blur0FBO)||M(this._blur1FBO))return;const r=this._rctx,s=e.fullViewport,a=s[2],n=s[3],o=a/this._blurSizePx,l=n/this._blurSizePx;this._ssaoFBO.resize(a,n),this._blur0FBO.resize(o,l),this._blur1FBO.resize(o,l);const h=1*a,c=1*n;r.bindFramebuffer(this._ssaoFBO),r.setViewport(0,0,a,n);const d=this._ssaoTechnique.program;r.useProgram(d),r.setPipelineState(this._ssaoTechnique.pipeline),d.setUniform2f("rnmScale",a/this._noiseTexture.descriptor.width,n/this._noiseTexture.descriptor.height),Vn(e.projectionMatrix,e.fullWidth,e.fullHeight,xR,yR),d.setUniform4fv("projInfo",xR),d.setUniform2fv("zScale",yR),d.setUniform2f("nearFar",e.near,e.far);let u=1/e.computeRenderPixelSizeAtDist(1);d.setUniform1f("projScale",1*u),d.setUniform2f("screenDimensions",h,c);const p=De(e.eye,e.center);let m=20*e.computeRenderPixelSizeAtDist(p);m=Math.max(.1,m),d.setUniform1f("radius",m),d.setUniform1f("intensity",4*this._attenuation/m**6),d.bindTexture(this._noiseTexture,"rnm"),d.bindTexture(i,"normalMap"),d.bindTexture(t,"depthMap"),M(this.quadVAO)&&(this.quadVAO=xs(this._rctx)),r.bindVAO(this.quadVAO),r.drawArrays(5,0,Ua(this.quadVAO,"geometry"));const g=this._blurTechnique.program;r.useProgram(g),g.bindTexture(this._ssaoFBO.colorTexture,"tex"),g.bindTexture(i,"normalMap"),g.bindTexture(t,"depthMap"),r.setViewport(0,0,h/this._blurSizePx,c/this._blurSizePx),r.bindFramebuffer(this._blur0FBO),g.setUniform2f("screenDimensions",h,c),g.setUniform2f("blurSize",0,1*this._blurSizePx/c),g.setUniform2f("nearFar",e.near,e.far),p>5e4&&(u=Math.max(0,u-(p-5e4))),g.setUniform1f("projScale",u),r.drawArrays(5,0,Ua(this.quadVAO,"geometry")),g.setUniform2f("blurSize",1*this._blurSizePx/h,0),r.bindFramebuffer(this._blur1FBO),g.bindTexture(this._blur0FBO.colorTexture,"tex"),r.drawArrays(5,0,Ua(this.quadVAO,"geometry")),r.setViewport(s[0],s[1],s[2],s[3])}bind(e,t){this.enabled&&C(this._blur1FBO)&&C(this._ssaoFBO)?(e.bindTexture(this._blur1FBO.colorTexture,"ssaoTex"),e.setUniform4f("viewportPixelSz",t.fullViewport[0],t.fullViewport[1],1/this._ssaoFBO.width,1/this._ssaoFBO.height)):e.setUniform4f("viewportPixelSz",-1,-1,-1,-1)}_selectPrograms(){this._ssaoTechniqueConfig.output=0,this._ssaoTechnique=this._techniqueRep.releaseAndAcquire(fR,this._ssaoTechniqueConfig,this._ssaoTechnique),this._ssaoTechniqueConfig.output=1,this._blurTechnique=this._techniqueRep.releaseAndAcquire(fR,this._ssaoTechniqueConfig,this._blurTechnique)}_enable(){this.enabled||(this._enabled=!0,this._loadResources((()=>{this._enabled&&this._initialize()})))}_loadResources(e){this._data?e():import("../chunks/SSAOHelperData.js").then((t=>{this._data=t,e()}))}_initialize(){const e={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0},t={colorTarget:0,depthStencilTarget:0};Rn(this._data.noiseTexture).then((i=>{this._enabled&&(this._ssaoFBO=new Tn(this._rctx,t,e),this._blur0FBO=new Tn(this._rctx,t,e),this._blur1FBO=new Tn(this._rctx,t,e),this._noiseTexture=new Pn(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,hasMipmap:!0,width:i.width,height:i.height},i),this._requestRender())})),this._selectPrograms()}_disable(){this._enabled=!1,this._noiseTexture=P(this._noiseTexture),this._blur1FBO=P(this._blur1FBO),this._blur0FBO=P(this._blur0FBO),this._ssaoFBO=P(this._ssaoFBO)}get gpuMemoryUsage(){return(C(this._blur0FBO)?this._blur0FBO.gpuMemoryUsage:0)+(C(this._blur1FBO)?this._blur1FBO.gpuMemoryUsage:0)+(C(this._ssaoFBO)?this._ssaoFBO.gpuMemoryUsage:0)}get test(){return{ssao:this._ssaoFBO,blur:this._blur1FBO}}}const yR=Nr(),xR=nr();class wR{constructor(e){this.factory=e,this.originData=new Map}acquire(e){return this.register(this.factory.getOrigin(e))}register(e){const t=this.originData.get(e.id);return t?(t.refCount++,t.origin):(this.originData.set(e.id,{refCount:1,viewMatrix:Ar(),origin:e}),e)}release(e){const t=this.originData.get(e.id);t&&(t.refCount--,0===t.refCount&&this.originData.delete(e.id))}updateViewMatrices(e){this.originData.forEach((t=>{wr(t.viewMatrix,e),function(e,t){const i=t,r=e[0],s=e[1],a=e[2];i[12]+=r*i[0]+s*i[4]+a*i[8],i[13]+=r*i[1]+s*i[5]+a*i[9],i[14]+=r*i[2]+s*i[6]+a*i[10],i[14]+=r*i[3]+s*i[7]+a*i[11]}(t.origin.vec3,t.viewMatrix)}))}getViewMatrix(e){return this.originData.get(e.id).viewMatrix}}function bR(e){const t=us`bool isNaN( float val )
{
return ( val < 0.0 || 0.0 < val || val == 0.0 ) ? false : true;
}`;e.code.add(t)}function CR(e,t){e.vertex.include(bR),e.include(ts,t);const i=e.vertex;i.uniforms.add("uDepthBias","vec2"),i.uniforms.add("uViewportDimInv","vec2"),t.legacy?(i.uniforms.add("uView","mat4"),i.uniforms.add("uProj","mat4")):i.uniforms.add("uTransformNormal_ViewFromGlobal","mat3"),t.legacy?i.code.add(us`vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {
float offsetXY = uDepthBias.x;
float offsetZ  = uDepthBias.y;
vec4 projNormal = uProj * uView * vec4(globalNormal, 0.0);
return offsetXY * projPos.w * 2.0 * uViewportDimInv * normalize(projNormal.xyz).xy;
}`):i.code.add(us`vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {
float offsetXY = uDepthBias.x;
float offsetZ  = uDepthBias.y;
vec4 projNormal = uTransform_ProjFromView * vec4(uTransformNormal_ViewFromGlobal * globalNormal, 0.0);
return offsetXY * projPos.w * 2.0 * uViewportDimInv * normalize(projNormal.xyz).xy;
}`),i.code.add(us`float _calculateProjectedBiasZ(vec4 projPos) {
float offsetZ = uDepthBias.y;
return sqrt(projPos.z) * offsetZ;
}
vec4 adjustProjectedPosition(vec4 projPos, vec3 worldNormal, float lineWidth) {
vec2 offsetXY = calculateProjectedBiasXY(projPos, worldNormal);
if (!isNaN(offsetXY.x) && !isNaN(offsetXY.y)) {
projPos.xy += offsetXY;
}
projPos.z += _calculateProjectedBiasZ(projPos);
return projPos;
}`)}function TR(e,t){const i=e.fragment;i.constants.add("coverageTestThreshold","float",.01),t.antialiasing?i.code.add(us`#define discardByCoverage(radius, coverage) { if (coverage < coverageTestThreshold) discard; }`):i.code.add(us`#define discardByCoverage(radius, coverage) { float coverageLimit = radius <= 0.5 ? coverageTestThreshold : 0.75; if (coverage < coverageLimit) discard; }`)}function SR(e,t){const i=e.vertex;t.silhouette?(i.code.add(us`bool isSilhouetteEdge(vec3 viewDir, vec3 normalA, vec3 normalB) {
float faceAVisible = dot(viewDir, normalA);
float faceBVisible = dot(viewDir, normalB);
return faceAVisible * faceBVisible < 0.0;
}`),t.legacy?i.code.add(us`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
vec3 viewNormalA = _modelToViewNormal(normalA);
vec3 viewNormalB = _modelToViewNormal(normalB);
vec3 viewDir = -viewPos;
if (isSilhouetteEdge(viewDir, viewNormalA, viewNormalB)) {
return false;
}
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return true;
}`):i.code.add(us`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
vec3 worldNormalA = _modelToWorldNormal(normalA);
vec3 worldNormalB = _modelToWorldNormal(normalB);
vec3 viewDir = -worldPos;
if (isSilhouetteEdge(viewDir, worldNormalA, worldNormalB)) {
return false;
}
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return true;
}`)):i.code.add(us`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
return false;
}`)}function PR(e,t){const i=e.vertex;switch(t.mode){case 1:i.code.add(us`#define discardShortEdges(unpackedAttributes, lineLengthPixels) { if (lineLengthPixels <= 3.0) { gl_Position = vec4(10.0, 10.0, 10.0, 1.0); return; }}`);break;case 2:i.code.add(us`#define discardShortEdges(unpackedAttributes, lineLengthPixels) { if (unpackedAttributes.type <= 0.0 && lineLengthPixels <= 3.0) { gl_Position = vec4(10.0, 10.0, 10.0, 1.0); return; }}`);break;case 0:i.code.add(us`#define discardShortEdges(unpackedAttributes, lineLengthPixels) {}`)}}function RR(e,t){const i=e.vertex;i.uniforms.add("uDistanceFalloffFactor","float"),i.code.add(us`float distanceBasedPerspectiveFactor(float distance) {
return clamp(sqrt(uDistanceFalloffFactor / distance), 0.0, 1.0);
}`),i.uniforms.add("uComponentDataTex","sampler2D"),i.uniforms.add("uComponentDataTexInvDim","vec2"),e.attributes.add("componentIndex","float"),i.constants.add("componentColorFieldOffset","float",0),i.constants.add("componentOtherFieldOffset","float",1),i.constants.add("componentFieldCount","float",2),i.constants.add("lineWidthFractionFactor","float",8),i.constants.add("extensionLengthOffset","float",128),i.constants.add("componentTexWidth","float",4096),i.code.add(us`vec2 _componentTextureCoords(float componentIndex, float fieldOffset) {
float fieldIndex = componentFieldCount * componentIndex + fieldOffset;
float rowIndex = floor(fieldIndex / componentTexWidth);
float colIndex = mod(fieldIndex, componentTexWidth);
vec2 linearIndex = vec2(
(colIndex + 0.5) / componentTexWidth,
(rowIndex + 0.5) * uComponentDataTexInvDim.y
);
return linearIndex;
}
struct ComponentData {
vec4 color;
float lineWidth;
float extensionLength;
float type;
};
ComponentData readComponentData() {
vec2 colorIndex = _componentTextureCoords(componentIndex, componentColorFieldOffset);
vec2 otherIndex = _componentTextureCoords(componentIndex, componentOtherFieldOffset);
vec4 colorValue = texture2D(uComponentDataTex, colorIndex);
vec4 otherValue = texture2D(uComponentDataTex, otherIndex);
return ComponentData(
vec4(colorValue.rgb, colorValue.a * otherValue.w),
otherValue.x * (255.0 / lineWidthFractionFactor),
otherValue.y * 255.0 - extensionLengthOffset,
-(otherValue.z * 255.0) + 0.5
);
}`),t.legacy?i.code.add(us`vec3 _modelToWorldNormal(vec3 normal) {
return (uModel * vec4(normal, 0.0)).xyz;
}
vec3 _modelToViewNormal(vec3 normal) {
return (uView * uModel * vec4(normal, 0.0)).xyz;
}`):(i.uniforms.add("uTransformNormal_GlobalFromModel ","mat3"),i.code.add(us`vec3 _modelToWorldNormal(vec3 normal) {
return uTransformNormal_GlobalFromModel * normal;
}`)),t.silhouette?(e.attributes.add("normalA","vec3"),e.attributes.add("normalB","vec3"),i.code.add(us`vec3 worldNormal() {
return _modelToWorldNormal(normalize(normalA + normalB));
}`)):(e.attributes.add("normal","vec3"),i.code.add(us`vec3 worldNormal() {
return _modelToWorldNormal(normal);
}`)),t.legacy?i.code.add(us`vec3 worldFromModelPosition(vec3 position) {
return (uModel * vec4(position, 1.0)).xyz;
}
vec3 viewFromModelPosition(vec3 position) {
return (uView * vec4(worldFromModelPosition(position), 1.0)).xyz;
}
vec4 projFromViewPosition(vec3 position) {
return uProj * vec4(position, 1.0);
}`):(e.vertex.include(hs,t),i.code.add(us`vec3 worldFromModelPosition(vec3 position) {
vec3 rotatedModelPosition = uTransform_WorldFromModel_RS * position;
vec3 transform_CameraRelativeFromModel = dpAdd(
uTransform_WorldFromModel_TL,
uTransform_WorldFromModel_TH,
-uTransform_WorldFromView_TL,
-uTransform_WorldFromView_TH
);
return transform_CameraRelativeFromModel + rotatedModelPosition;
}
vec3 viewFromModelPosition(vec3 position) {
return uTransform_ViewFromCameraRelative_RS * worldFromModelPosition(position);
}
vec4 projFromViewPosition(vec3 position) {
return uTransform_ProjFromView * vec4(position, 1.0);
}`)),i.code.add(us`float calculateExtensionLength(float extensionLength, float lineLength) {
return extensionLength / (log2(max(1.0, 256.0 / lineLength)) * 0.2 + 1.0);
}`)}function MR(e,t){const i=e.vertex;switch(e.include(RR,t),e.attributes.add("sideness","vec2"),2===t.mode?i.code.add(us`struct UnpackedAttributes {
vec2 sideness;
vec2 sidenessNorm;
float lineWidthPixels;
float extensionLengthPixels;
float type;
};`):i.code.add(us`struct UnpackedAttributes {
vec2 sideness;
vec2 sidenessNorm;
float lineWidthPixels;
float extensionLengthPixels;
};`),t.mode){case 2:i.code.add(us`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float fType = component.type;
float extensionLengthPixels = component.extensionLength;
float lineWidth = component.lineWidth;
if (fType <= 0.0) {
extensionLengthPixels *= variantExtension * 2.0 - 1.0;
}
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels, fType);
}`);break;case 1:i.code.add(us`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float extensionLengthPixels = component.extensionLength;
extensionLengthPixels *= variantExtension * 2.0 - 1.0;
float lineWidth = component.lineWidth;
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);
}`);break;case 0:i.code.add(us`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float extensionLengthPixels = component.extensionLength;
float lineWidth = component.lineWidth;
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);
}`)}}function DR(e,t){const i=e.vertex;switch(e.include(MR,t),RR.usesSketchLogic(t)&&i.uniforms.add("uStrokesAmplitude","float"),t.mode){case 0:i.code.add(us`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
return 0.0;
}`);break;case 1:i.code.add(us`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
return uStrokesAmplitude;
}`);break;case 2:i.code.add(us`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
float type = unpackedAttributes.type;
if (type <= 0.0) {
return uStrokesAmplitude;
}
else {
return 0.0;
}
}`)}}function AR(e,t){const i=e.vertex;e.include(MR,t);const r=e.fragment;switch(RR.usesSketchLogic(t)&&(i.uniforms.add("uStrokesTextureScale","vec2"),i.uniforms.add("uStrokesLog2Resolution","float"),i.uniforms.add("uStrokeVariants","float"),e.varyings.add("vStrokeUV","vec2"),r.uniforms.add("uStrokesTexture","sampler2D"),r.uniforms.add("uStrokesNormalizationScale","float"),i.code.add(us`void calculateStyleOutputsSketch(float lineLength, UnpackedAttributes unpackedAttributes) {
vec2 sidenessNorm = unpackedAttributes.sidenessNorm;
float lineIndex = clamp(ceil(log2(lineLength)), 0.0, uStrokesLog2Resolution);
vStrokeUV = vec2(exp2(lineIndex) * sidenessNorm.y, lineIndex * uStrokeVariants + variantStroke + 0.5) * uStrokesTextureScale;
vStrokeUV.x += variantOffset;
}`),e.fragment.include(Cs),r.code.add(us`float calculateLineOffsetSketch() {
float offsetNorm = rgba2float(texture2D(uStrokesTexture, vStrokeUV));
return (offsetNorm - 0.5) * uStrokesNormalizationScale;
}
float calculateLinePressureSketch() {
return rgba2float(texture2D(uStrokesTexture, vStrokeUV + vec2(0.0, 0.5)));
}`)),t.mode){case 0:i.code.add(us`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes) {}`),r.code.add(us`float calculateLineOffset() {
return 0.0;
}
float calculateLinePressure() {
return 1.0;
}`);break;case 1:i.code.add(us`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)
{
calculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);
}`),r.code.add(us`float calculateLineOffset() {
return calculateLineOffsetSketch();
}
float calculateLinePressure() {
return calculateLinePressureSketch();
}`);break;case 2:e.varyings.add("vType","float"),i.code.add(us`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)
{
vType = unpackedAttributes.type;
if (unpackedAttributes.type <= 0.0) {
calculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);
}
}`),r.code.add(us`float calculateLineOffset() {
if (vType <= 0.0) {
return calculateLineOffsetSketch();
}
else {
return 0.0;
}
}
float calculateLinePressure() {
if (vType <= 0.0) {
return calculateLinePressureSketch();
}
else {
return 1.0;
}
}`)}}!function(e){e.usesSketchLogic=function(e){return 1===e.mode||2===e.mode},e.usesSolidLogic=function(e){return 0===e.mode||2===e.mode}}(RR||(RR={}));var OR=Object.freeze({__proto__:null,build:function(e){const t=new ds,i=t.vertex,r=t.fragment;return e.legacy&&i.uniforms.add("uModel","mat4"),e.antialiasing&&(i.code.add(us`#define ANTIALIASING 1`),r.code.add(us`#define ANTIALIASING 1`)),t.include(CR,e),t.include(DR,e),t.include(RR,e),t.include(MR,e),t.include(AR,e),t.include(Is,e),t.include(SR,e),t.include(TR,e),t.include(PR,e),t.varyings.add("vColor","vec4"),t.varyings.add("vRadius","float"),t.varyings.add("vPosition","vec3"),t.varyings.add("vWorldPosition","vec3"),t.varyings.add("vViewPos","vec3"),t.varyings.add("vLineLengthPixels","float"),t.varyings.add("vSizeFalloffFactor","float"),i.uniforms.add("uPixelToNDC","vec2"),i.uniforms.add("uNDCToPixel","vec2"),i.uniforms.add("uPixelRatio","float"),t.attributes.add("position0","vec3"),t.attributes.add("position1","vec3"),t.attributes.add("variantOffset","float"),t.attributes.add("variantStroke","float"),t.attributes.add("variantExtension","float"),i.code.add(us`const float opaqueCutoff = 1.0 / 255.0;
void calculateGeometricOutputs(vec3 viewPosV0, vec3 viewPosV1, vec3 worldPosV0, vec3 worldPosV1, vec3 worldNormal, UnpackedAttributes unpackedAttributes) {
vec2 sideness = unpackedAttributes.sideness;
vec2 sidenessNorm = unpackedAttributes.sidenessNorm;
vWorldPosition = mix(worldPosV0, worldPosV1, sidenessNorm.y).xyz;
vec3 viewPos = mix(viewPosV0, viewPosV1, sidenessNorm.y);
vViewPos = viewPos;
vec4 projPosV0 = projFromViewPosition(viewPosV0);
vec4 projPosV1 = projFromViewPosition(viewPosV1);
vec4 projPos = projFromViewPosition(viewPos);
vec3 screenSpaceLineNDC = (projPosV1.xyz / projPosV1.w - projPosV0.xyz / projPosV0.w);
vec2 screenSpaceLinePixels = screenSpaceLineNDC.xy * uNDCToPixel;
float lineLengthPixels = length(screenSpaceLinePixels);
float dzPerPixel = screenSpaceLineNDC.z / lineLengthPixels;
vec2 screenSpaceDirection = screenSpaceLinePixels / lineLengthPixels;
vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x) * sideness.x;
float falloffFactor = distanceBasedPerspectiveFactor(-viewPos.z) * uPixelRatio;
float lineWidthPixels = unpackedAttributes.lineWidthPixels * falloffFactor;
float extensionLengthPixels = calculateExtensionLength(unpackedAttributes.extensionLengthPixels, lineLengthPixels) * falloffFactor;
float lineAmplitudePixels = calculateLineAmplitude(unpackedAttributes) * uPixelRatio;
vSizeFalloffFactor = falloffFactor;
float lineWidthAndAmplitudePixels = lineWidthPixels + lineAmplitudePixels + lineAmplitudePixels;
float extendedLineLengthPixels = lineLengthPixels + extensionLengthPixels + extensionLengthPixels;
#ifdef ANTIALIASING
const float aaPaddingPixels = 1.0;
float halfAAPaddedLineWidthAndAmplitudePixels = lineWidthAndAmplitudePixels * 0.5 + aaPaddingPixels;
float aaPaddedRoundedCapSizePixels = lineWidthPixels * 0.5 + aaPaddingPixels;
#else
float halfAAPaddedLineWidthAndAmplitudePixels = max(lineWidthAndAmplitudePixels, 1.0) * 0.5;
float aaPaddedRoundedCapSizePixels = max(lineWidthPixels, 1.0) * 0.5;
#endif
vec2 halfAAPaddedLineWidthAndAmplitudeNDC = halfAAPaddedLineWidthAndAmplitudePixels * uPixelToNDC;
vec2 aaPaddedRoundedCapSizeNDC = aaPaddedRoundedCapSizePixels * uPixelToNDC;
vec2 extensionLengthNDC = extensionLengthPixels * uPixelToNDC;
vec2 ndcOffset = (
screenSpaceDirection * sideness.y * (aaPaddedRoundedCapSizeNDC + extensionLengthNDC)
+ perpendicularScreenSpaceDirection * halfAAPaddedLineWidthAndAmplitudeNDC
);
projPos.xy += ndcOffset * projPos.w;
projPos.z += (dzPerPixel * (aaPaddedRoundedCapSizePixels + extensionLengthPixels)) * sideness.y * projPos.w;
projPos = adjustProjectedPosition(projPos, worldNormal, 1.0 + max((lineWidthAndAmplitudePixels - 1.0) * 0.5, 0.0));
float aaPaddedLineWithCapsLengthPixels = extendedLineLengthPixels + aaPaddedRoundedCapSizePixels + aaPaddedRoundedCapSizePixels;
float pixelPositionAlongLine = aaPaddedLineWithCapsLengthPixels * sidenessNorm.y - aaPaddedRoundedCapSizePixels;
vPosition = vec3(
halfAAPaddedLineWidthAndAmplitudePixels * sideness.x,
pixelPositionAlongLine,
pixelPositionAlongLine / extendedLineLengthPixels
);
vRadius = lineWidthPixels * 0.5;
vLineLengthPixels = extendedLineLengthPixels;
discardShortEdges(unpackedAttributes, lineLengthPixels);
gl_Position = projPos;
}
void main() {
ComponentData component = readComponentData();
UnpackedAttributes unpackedAttributes = unpackAttributes(component);
vec3 worldPosV0 = worldFromModelPosition(position0);
vec3 worldPosV1 = worldFromModelPosition(position1);
vec3 viewPosV0 = viewFromModelPosition(position0);
vec3 viewPosV1 = viewFromModelPosition(position1);
vColor = component.color;
if (vColor.a < opaqueCutoff) {
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return;
}
if (discardNonSilhouetteEdges(viewPosV0, worldPosV0)) {
return;
}
calculateGeometricOutputs(viewPosV0, viewPosV1, worldPosV0, worldPosV1, worldNormal(), unpackedAttributes);
calculateStyleOutputs(unpackedAttributes);
}`),e.multipassTerrainEnabled&&(t.fragment.include(ps),t.include(Ws,e)),t.fragment.code.add(us`
    vec2 lineWithCapsDistance(float radius, vec2 position, float lineLength) {
      float lineOffset = calculateLineOffset();
      float positionX = position.x - lineOffset;

      if (radius < 1.0) {
        // Handle this specifically for subpixel sizes:
        // 1. Compute correct coverage (note coverage is computed by
        //    0.5 - dist, so we make sure that that will lead to correct
        //    subpixel coverage
        // 2. Ignore rounded caps
        float coverageX = clamp(min(radius, positionX + 0.5) - max(-radius, positionX - 0.5), 0.0, 1.0);
        float coverageY = clamp(min(lineLength, position.y + 0.5) - max(0.0, position.y - 0.5), 0.0, 1.0);

        float coverage = min(coverageX, coverageY);

        return vec2(0.5 - coverage, 0.0);
      }
      else {
        // Between -radius -> 0 for start cap, 0 for line, 0 -> radius
        float positionOnCap = position.y - clamp(position.y, 0.0, lineLength);

        vec2 lineToPosition = vec2(positionX, positionOnCap);
        return vec2(length(lineToPosition) - radius, positionOnCap / radius);
      }
    }

    void main() {
      ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, vViewPos.z);":""}
      float radius = vRadius * calculateLinePressure();

      vec2 distance = lineWithCapsDistance(radius, vPosition.xy, vLineLengthPixels);
      float coverage = clamp(0.5 - distance.x, 0.0, 1.0);

      discardByCoverage(radius, coverage);
      discardBySlice(vWorldPosition);

      float alpha = vColor.a * coverage;

      gl_FragColor = vec4(vColor.rgb, alpha);

    }
  `),t}});class FR extends vs{bindPass(e){const t=this.program,{edgeRenderParameters:i,bindParameters:r}=e;ts.bindViewProjTransform(t,i.viewProjectionTransform),t.setUniformMatrix3fv("uTransformNormal_ViewFromGlobal",i.transformNormal_ViewFromGlobal),t.setUniformMatrix4fv("uProj",r.camera.projectionMatrix),t.setUniform2f("uDepthBias",.5,-4e-4),t.setUniform2f("uPixelToNDC",2/r.camera.fullViewport[2],2/r.camera.fullViewport[3]),t.setUniform2f("uNDCToPixel",r.camera.fullViewport[2]/2,r.camera.fullViewport[3]/2),t.setUniform1f("uDistanceFalloffFactor",i.distanceFalloffFactor),t.setUniform2f("uViewportDimInv",1/r.camera.fullViewport[2],1/r.camera.fullViewport[3]),t.setUniform1f("uPixelRatio",r.camera.pixelRatio||1)}initializeProgram(e){const t=FR.shader.get(),i=this.configuration,r=t.build({slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,silhouette:i.silhouette,legacy:i.legacy,antialiasing:i.antialiasing,mode:i.mode,doublePrecisionRequiresObfuscation:i.doublePrecisionRequiresObfuscation,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new _s(e.rctx,r,fc)}initializePipeline(e){const t=e.rctx.capabilities.blendMinMax;return Ea(t?{blending:La(1,1,0,1,32774,t.MAX),depthTest:{func:515},colorWrite:Va}:{depthTest:{func:515},depthWrite:Na,colorWrite:Va})}}FR.shader=new gs(OR,(()=>Promise.resolve().then((function(){return OR})))),function(t){class i extends fs{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.silhouette=!1,this.legacy=!1,this.antialiasing=!1,this.mode=0,this.doublePrecisionRequiresObfuscation=!1,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}e([ms()],i.prototype,"slicePlaneEnabled",void 0),e([ms()],i.prototype,"silhouette",void 0),e([ms()],i.prototype,"legacy",void 0),e([ms()],i.prototype,"antialiasing",void 0),e([ms({count:3})],i.prototype,"mode",void 0),e([ms()],i.prototype,"doublePrecisionRequiresObfuscation",void 0),e([ms()],i.prototype,"multipassTerrainEnabled",void 0),e([ms()],i.prototype,"cullAboveGround",void 0),t.Configuration=i}(FR||(FR={}));const IR={type:"uber",slicePlaneEnabled:!1,sliceHighlightDisabled:!1,strokesTexture:null,legacy:!0};class zR{constructor(){this._value=0}get value(){return this._value}increment(){this._value++}decrement(){this._value--}}const ER={solid:0,sketch:1,uber:2};class LR{constructor(e,t,i){this.rctx=e,this.shaderTechniqueRepository=t,this.config=new FR.Configuration,this.technique=null,this.refCount=new zR,this.renderables=new Set,this.sortedRenderables={1:{1:new N,2:new N},2:{1:new N,2:new N}},this.renderablesDirty=!1,this.settings={...IR,...i},this.key=LR.getKey(this.settings.type,this.settings.slicePlaneEnabled,this.settings.legacy);const r=this.settings.strokesTexture.variants;this.writerSettings={variants:r,reducedPrecision:ma.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES},this.config.legacy=this.settings.legacy,this.config.mode=ER[this.settings.type],this.config.silhouette=!1,this.config.antialiasing=!!this.rctx.capabilities.blendMinMax,this.config.slicePlaneEnabled=this.settings.slicePlaneEnabled,this.config.doublePrecisionRequiresObfuscation=ls(e)}dispose(){this.technique=S(this.technique)}addRenderable(e){this.renderables.add(e),this.renderablesDirty=!0}removeRenderable(e){this.renderables.delete(e),this.renderablesDirty=!0}setRenderablesDirty(){this.renderablesDirty=!0}forEachRenderable(e,t){this.renderablesDirty&&this.sortRenderables(),this.sortedRenderables[t][1].forAll(e),this.sortedRenderables[t][2].forAll(e)}setMultipassParameters(e){this.config.multipassTerrainEnabled=!!e.multipassTerrainEnabled&&e.multipassTerrainEnabled,this.config.cullAboveGround=!!e.cullAboveGround&&e.cullAboveGround}bindRegularEdges(e,t){this.setMultipassParameters(e),this.config.silhouette=!1,this.technique=this.shaderTechniqueRepository.releaseAndAcquire(FR,this.config,this.technique),this.technique.bindPass({bindParameters:e,edgeRenderParameters:t}),this.rctx.setPipelineState(this.technique.pipeline),this.rctx.useProgram(this.technique.program)}bindSilhouetteEdges(e,t){this.setMultipassParameters(e),this.config.silhouette=!0,this.technique=this.shaderTechniqueRepository.releaseAndAcquire(FR,this.config,this.technique),this.technique.bindPass({bindParameters:e,edgeRenderParameters:t}),this.rctx.setPipelineState(this.technique.pipeline),this.rctx.useProgram(this.technique.program)}renderRegularEdges(e,t,i){this.render(e,e.regular.vao,t,i)}renderSilhouetteEdges(e,t,i){this.render(e,e.silhouette.vao,t,i)}render(e,t,i,r){this.setUniforms(e,i),this.rctx.bindVAO(t),this.rctx.capabilities.instancing.drawArraysInstanced(6,0,4,r)}setUniforms(e,t){const i=this.technique.program;if(e.components.buffer.textureBuffer.bind(i,VR,kR),t.multipassTerrainEnabled&&(i.setUniform2fv("cameraNearFar",t.camera.nearFar),i.setUniform2fv("inverseViewport",t.inverseViewport),aa(i,t)),"origin"in e.transform)i.setUniformMatrix4fv("uView",t.localViewMatrixForEdges),i.setUniformMatrix4fv("uModel",e.transform.modelMatrix),ks(i,this.settings,t.slicePlane,e.transform.origin.vec3);else{const r=new mS(e.transform.position),s=un(jR,gn(jR,e.transform.rotationScale)),a=new aS;ye(a.worldFromModel_TL,r.low),ye(a.worldFromModel_TH,r.high),fn(a.worldFromModel_RS,e.transform.rotationScale),fn(a.transformNormal_GlobalFromModel,s),ts.bindModelTransform(i,a),i.setUniformMatrix3fv("uTransformNormal_GlobalFromModel",a.transformNormal_GlobalFromModel);const n=t.camera.viewInverseTransposeMatrix,o=ve(UR,n[3],n[7],n[11]);ks(i,this.settings,t.slicePlane,o)}"uber"!==this.settings.type&&"sketch"!==this.settings.type||this.setSketchUniforms(i),i.setUniform1f("uWorldLineRadiusPerDistance",Math.tan(t.camera.fovY/2)/(t.camera.fullViewport[3]/2))}setSketchUniforms(e){const t=this.settings.strokesTexture,i=t.texture;M(i)||(e.bindTexture(i,"uStrokesTexture"),e.setUniform2f("uStrokesTextureScale",1/i.descriptor.width,1/i.descriptor.height),e.setUniform1f("uStrokesLog2Resolution",Xe(t.resolution)),e.setUniform1f("uStrokesNormalizationScale",t.normalizationScale),e.setUniform1f("uStrokesAmplitude",t.amplitude),e.setUniform1f("uStrokeVariants",t.variants))}sortRenderables(){this.renderablesDirty=!1,this.sortedRenderables[1][1].clear(),this.sortedRenderables[1][2].clear(),this.sortedRenderables[2][1].clear(),this.sortedRenderables[2][2].clear(),this.renderables.forEach((e=>{0!==e.objectTransparency&&0!==e.edgeTransparency&&this.sortedRenderables[e.objectTransparency][e.edgeTransparency].push(e)}));const e=(e,t)=>"origin"in e.transform&&"origin"in t.transform?e.transform.origin.id<t.transform.origin.id?-1:e.transform.origin.id>t.transform.origin.id?1:0:0;this.sortedRenderables[1][1].sort(e),this.sortedRenderables[1][2].sort(e),this.sortedRenderables[2][1].sort(e),this.sortedRenderables[2][2].sort(e)}static getKey(e,t,i){return`edges-t:${e}:${t}:${i}`}}const VR="uComponentDataTex",kR="uComponentDataTexInvDim",jR=nc(),UR=fe();class qR extends Tc{constructor(e){super("EdgeProcessingWorker","wrappedWork",e)}async process(e,t,i){if(i)return vc(e);const r=this._packInput(e),s=await this.invoke(r,t);return this._unpackOutput(s)}getTransferList(e){return[e.dataBuffer]}_packInput(e){return{dataBuffer:e.data.buffer,writerSettings:e.writerSettings,skipDeduplicate:e.skipDeduplicate,indicesBuffer:e.indices.buffer,indicesType:j(e.indices)?"Uint32Array":"Uint16Array",indicesLength:e.indicesLength}}_unpackOutput(e){return{regular:{instancesData:_c(e.regular.instancesData),lodInfo:{lengths:new Float32Array(e.regular.lodInfo.lengths)}},silhouette:{instancesData:_c(e.silhouette.instancesData),lodInfo:{lengths:new Float32Array(e.silhouette.lodInfo.lengths)}},averageEdgeLength:e.averageEdgeLength}}}function HR(e,t){if(!e)return null;const i=e.length/2,r=BR*i,s=new Array(i);let a=0;const n=1===t;for(let t=0;t<e.length;t+=2){const i=(e[t]+e[t+1])/2;s[a++]=n?Math.min(r,1-(1-i)*NR):Math.min(r,i*NR)}return s}const BR=.1,NR=.5;class GR{constructor(e,t,i,r,s){this.resolution=e,this.normalizationScale=t,this.amplitude=i,this.variants=r,this.texture=s}dispose(){this.texture=P(this.texture)}}const WR={amplitude:8,resolution:256,strokes:[{distance:[-1.59027,-1.59426,-1.59674,-1.59766,-1.59702,-1.59479,-1.59095,-1.5855,-1.57843,-1.56973,-1.55942,-1.5475,-1.53398,-1.5189,-1.50226,-1.4841,-1.46446,-1.44337,-1.42088,-1.39703,-1.37188,-1.34547,-1.31786,-1.28912,-1.2593,-1.22847,-1.19668,-1.16402,-1.13053,-1.09629,-1.06137,-1.02582,-.98972,-.95313,-.91611,-.87872,-.84102,-.80306,-.76488,-.72654,-.68807,-.64952,-.61092,-.57232,-.53375,-.49527,-.45692,-.41874,-.38078,-.34309,-.3057,-.26867,-.23204,-.19585,-.16015,-.12497,-.09036,-.05634,-.02296,.00977,.04183,.07321,.10389,.13386,.16313,.19169,.21956,.24672,.27321,.299,.32413,.34858,.37237,.3955,.41798,.43981,.461,.48154,.50145,.52073,.53939,.55744,.57488,.5917,.6079,.62347,.63837,.65259,.66609,.67885,.69083,.70201,.71235,.72183,.73042,.73812,.7449,.75076,.7557,.75973,.76284,.76507,.76642,.76692,.76659,.76545,.76352,.76083,.7574,.75324,.74837,.74279,.73652,.72959,.72199,.71377,.70493,.69553,.68558,.67515,.66426,.65298,.64135,.62944,.6173,.60499,.59257,.58008,.56759,.55513,.54275,.5305,.51842,.50654,.4949,.48353,.47246,.4617,.45128,.44121,.43149,.42213,.41313,.40448,.39617,.38818,.3805,.37309,.36594,.35902,.35229,.34572,.33927,.33292,.32663,.32035,.31407,.30774,.30135,.29486,.28824,.28148,.27454,.26739,.26002,.25241,.24454,.23639,.22796,.21922,.21016,.20076,.19098,.18082,.17023,.1592,.14768,.13566,.1231,.10996,.09624,.08188,.06688,.05121,.03485,.01778,0,-.0185,-.03771,-.05763,-.07824,-.09952,-.12144,-.14396,-.16706,-.19069,-.21481,-.23938,-.26436,-.28971,-.31539,-.34136,-.36759,-.39404,-.42067,-.44746,-.47437,-.50136,-.52839,-.55544,-.58248,-.60948,-.63642,-.66329,-.6901,-.71684,-.74352,-.77015,-.79675,-.82332,-.84988,-.87644,-.90301,-.92958,-.95615,-.98272,-1.00926,-1.03575,-1.06217,-1.08847,-1.11463,-1.1406,-1.16633,-1.19178,-1.2169,-1.24164,-1.26595,-1.28979,-1.31312,-1.3359,-1.35809,-1.37963,-1.4005,-1.42064,-1.44,-1.45853,-1.47616,-1.49285,-1.50853,-1.52313,-1.53659,-1.54886,-1.55986,-1.56955,-1.57788,-1.5848],pressure:[-.01365,-.00206,.01025,.02327,.03696,.05129,.06619,.08163,.09755,.11393,.1307,.14784,.16531,.18308,.20111,.21938,.23786,.25651,.2753,.29419,.31315,.33215,.35115,.37015,.38913,.40806,.42694,.44576,.46449,.48313,.50167,.5201,.53839,.55653,.57448,.59222,.60971,.62692,.6438,.66033,.67648,.69221,.70753,.72242,.73688,.75093,.76456,.77779,.79063,.80309,.81517,.82686,.83817,.84911,.85967,.86987,.87972,.88924,.89845,.90734,.91594,.92425,.93229,.94005,.94754,.95475,.96166,.96826,.97451,.9804,.98588,.99092,.99549,.99957,.99685,.99381,.99131,.98936,.98796,.98711,.98681,.98706,.98787,.98923,.99113,.99357,.99654,1,.99607,.99171,.98695,.98181,.97634,.97057,.96452,.95824,.95175,.94506,.93818,.93113,.92389,.91647,.90887,.90109,.89314,.88501,.87672,.86831,.85978,.85119,.84256,.83393,.82533,.8168,.80836,.80002,.79181,.78374,.77582,.7681,.76059,.75331,.74629,.73955,.73311,.72697,.72116,.71568,.71054,.70572,.70121,.697,.69304,.68931,.68576,.68236,.67905,.67582,.67262,.66941,.66619,.66291,.65957,.65613,.65259,.64892,.6451,.6411,.6369,.63248,.62783,.62295,.61783,.61247,.60688,.60104,.59498,.58868,.58216,.57542,.56845,.56125,.5538,.5461,.53813,.52986,.52129,.51239,.50316,.49359,.4837,.47349,.46299,.45223,.44124,.43005,.41869,.40719,.39557,.38386,.37207,.36023,.34836,.33648,.32464,.31287,.30119,.28963,.27822,.26698,.25594,.2451,.23448,.22409,.21391,.20394,.19415,.18452,.17503,.16565,.15636,.14713,.13794,.1288,.11968,.11058,.10151,.09247,.08346,.07447,.06552,.05659,.0477,.03885,.03007,.02137,.01278,.00433,-.00393,-.012,-.01983,-.02738,-.03463,-.04155,-.0481,-.05429,-.0601,-.06553,-.07057,-.07524,-.07954,-.08347,-.08703,-.09022,-.09303,-.09544,-.09744,-.09898,-.10004,-.10059,-.1006,-.10005,-.09892,-.0972,-.09487,-.09192,-.08833,-.08409,-.07918,-.07357,-.06724,-.06019,-.0524,-.04386,-.03455,-.02448]},{distance:[-3.46259,-3.47131,-3.47668,-3.47863,-3.47712,-3.4721,-3.46352,-3.45138,-3.43566,-3.41635,-3.39347,-3.36704,-3.33709,-3.30368,-3.26684,-3.22667,-3.18322,-3.1366,-3.08689,-3.0342,-2.97865,-2.92036,-2.85946,-2.79607,-2.73034,-2.66241,-2.59242,-2.52052,-2.44686,-2.37159,-2.29485,-2.2168,-2.13757,-2.05731,-1.97616,-1.89426,-1.81174,-1.72875,-1.64543,-1.56191,-1.47833,-1.39483,-1.3115,-1.22847,-1.14581,-1.06361,-.98193,-.90083,-.82036,-.74054,-.66141,-.583,-.50532,-.4284,-.35228,-.277,-.20261,-.12916,-.05672,.01463,.08485,.15384,.22153,.28784,.35269,.41602,.47776,.53787,.59629,.653,.70799,.76123,.81274,.86253,.9106,.95698,1.0017,1.04477,1.0862,1.126,1.16415,1.20065,1.23546,1.26857,1.29994,1.32953,1.35731,1.38321,1.40719,1.42921,1.44922,1.46719,1.48309,1.49691,1.50862,1.51825,1.52581,1.53133,1.53486,1.53644,1.53616,1.53409,1.53031,1.52493,1.51803,1.50972,1.50009,1.48924,1.47725,1.46421,1.45019,1.43527,1.4195,1.40295,1.38568,1.36778,1.34929,1.3303,1.31087,1.29108,1.27099,1.25066,1.23018,1.2096,1.18898,1.16838,1.14785,1.12745,1.10721,1.08719,1.06741,1.04791,1.02871,1.00986,.99136,.97324,.95551,.93819,.92127,.90476,.88866,.87296,.85767,.84277,.82823,.81406,.80022,.7867,.77346,.76049,.74774,.73519,.72278,.71049,.69827,.68606,.67381,.66145,.64893,.63618,.62313,.60973,.5959,.5816,.56675,.5513,.53516,.51826,.50053,.4819,.46231,.44169,.42002,.39725,.37336,.34834,.32219,.2949,.2665,.23698,.20638,.17469,.14193,.10809,.07316,.03714,0,-.03827,-.07772,-.11836,-.16022,-.20332,-.24768,-.29332,-.34024,-.38844,-.43788,-.48854,-.54036,-.59329,-.64724,-.70211,-.75782,-.81425,-.87128,-.92881,-.98674,-1.04498,-1.10346,-1.1621,-1.22086,-1.27969,-1.33854,-1.3974,-1.45625,-1.51511,-1.57396,-1.63283,-1.69173,-1.75067,-1.80968,-1.86875,-1.9279,-1.98712,-2.04639,-2.10568,-2.16495,-2.22416,-2.28322,-2.34208,-2.40063,-2.4588,-2.51647,-2.57354,-2.62989,-2.68543,-2.74002,-2.79357,-2.84597,-2.89711,-2.94689,-2.99521,-3.04195,-3.087,-3.13023,-3.17152,-3.21075,-3.24779,-3.28252,-3.3148,-3.34451,-3.37154,-3.39577,-3.41709,-3.43539,-3.45059],pressure:[.87183,.87151,.87129,.87118,.87117,.87128,.87149,.87182,.87225,.8728,.87347,.87424,.87513,.87613,.87723,.87845,.87978,.88122,.88276,.88441,.88616,.88801,.88996,.892,.89414,.89637,.89868,.90108,.90356,.90611,.90874,.91144,.91421,.91704,.91993,.92287,.92587,.92892,.93201,.93514,.93831,.94151,.94474,.94799,.95126,.95456,.95786,.96118,.9645,.96783,.97116,.97448,.9778,.98111,.98441,.9877,.99096,.99421,.99742,.99938,.99622,.9931,.99001,.98697,.98397,.98101,.97811,.97526,.97246,.96972,.96703,.96441,.96185,.95935,.95691,.95455,.95225,.95002,.94786,.94577,.94376,.94182,.93995,.93817,.93646,.93483,.93328,.93181,.93042,.92911,.92788,.92673,.92566,.92467,.92376,.92293,.92217,.92149,.92088,.92034,.91987,.91947,.91913,.91886,.91864,.91849,.91838,.91833,.91834,.91839,.91849,.91863,.91883,.91907,.91935,.91968,.92005,.92046,.92092,.92142,.92195,.92253,.92314,.9238,.92449,.92521,.92598,.92677,.9276,.92847,.92936,.93029,.93125,.93224,.93325,.9343,.93537,.93646,.93758,.93872,.93988,.94106,.94225,.94346,.94469,.94593,.94718,.94844,.94971,.95098,.95226,.95354,.95482,.9561,.95738,.95867,.95995,.96122,.9625,.96377,.96504,.9663,.96757,.96883,.97009,.97135,.97261,.97387,.97513,.9764,.97767,.97895,.98023,.98153,.98284,.98416,.98549,.98684,.98821,.9896,.99101,.99244,.99389,.99537,.99688,.99842,1,.99839,.99675,.99508,.99336,.99161,.98982,.98799,.98613,.98422,.98228,.98029,.97827,.97622,.97414,.97202,.96987,.9677,.96551,.9633,.96107,.95882,.95656,.9543,.95202,.94975,.94747,.94519,.94292,.94065,.93838,.93613,.93388,.93164,.92941,.9272,.92499,.9228,.92062,.91846,.91631,.91418,.91207,.90998,.90792,.90588,.90387,.90189,.89995,.89804,.89617,.89434,.89256,.89083,.88914,.88752,.88595,.88443,.88299,.88161,.8803,.87907,.87791,.87683,.87584,.87494,.87412,.8734,.87278,.87225]},{distance:[.39335,.43437,.47737,.52234,.56923,.61801,.66864,.72109,.7753,.83123,.88882,.94801,1.00875,1.07097,1.13461,1.1996,1.26586,1.33333,1.40193,1.47158,1.54221,1.61373,1.68607,1.75913,1.83284,1.90711,1.98186,2.05699,2.13243,2.20809,2.28387,2.35971,2.4355,2.51117,2.58663,2.66179,2.73658,2.81092,2.88473,2.95792,3.03043,3.10217,3.17308,3.24309,3.31211,3.3801,3.44697,3.51267,3.57712,3.64028,3.70208,3.76247,3.8214,3.87881,3.93467,3.98892,4.04152,4.09244,4.14164,4.18908,4.23474,4.27859,4.32061,4.36077,4.39905,4.43544,4.46992,4.50249,4.53314,4.56185,4.58864,4.61349,4.63642,4.65745,4.67657,4.69381,4.7092,4.72274,4.73447,4.74441,4.75259,4.75903,4.76376,4.76682,4.76822,4.768,4.76618,4.76279,4.75786,4.75142,4.74348,4.73409,4.72326,4.71102,4.69739,4.68241,4.6661,4.64849,4.6296,4.60948,4.58816,4.56567,4.54204,4.51732,4.49154,4.46473,4.43694,4.4082,4.37854,4.348,4.31662,4.28443,4.25145,4.21773,4.1833,4.14819,4.11243,4.07606,4.03912,4.00162,3.96361,3.92512,3.88618,3.84683,3.80708,3.76697,3.72653,3.68579,3.64478,3.60351,3.56202,3.52033,3.47845,3.43642,3.39425,3.35196,3.30957,3.2671,3.22455,3.18196,3.13933,3.09668,3.05402,3.01136,2.96873,2.92613,2.88357,2.84108,2.79865,2.75631,2.71407,2.67195,2.62994,2.58807,2.54634,2.50477,2.46338,2.42216,2.38114,2.34032,2.29971,2.25933,2.21916,2.17923,2.13954,2.10008,2.06087,2.02189,1.98316,1.94468,1.90644,1.86845,1.83069,1.79316,1.75586,1.71877,1.68189,1.6452,1.60868,1.57232,1.53611,1.50004,1.46407,1.4282,1.39241,1.35668,1.321,1.28535,1.24972,1.2141,1.17849,1.14286,1.10723,1.07158,1.03593,1.00028,.96464,.92902,.89344,.85793,.8225,.78719,.75203,.71705,.68231,.64784,.61369,.57991,.54656,.51368,.48134,.44959,.41849,.3881,.35848,.32967,.30174,.27474,.24872,.22373,.19982,.17702,.15539,.13497,.11579,.09791,.08137,.06621,.05248,.04022,.02948,.02029,.01271,.00677,.00252,0,-76e-5,27e-5,.00314,.00788,.01451,.02307,.03357,.04604,.0605,.07697,.09546,.11599,.13858,.16322,.18992,.21869,.24952,.28241,.31735,.35434],pressure:[.95248,.95236,.95228,.95223,.95222,.95224,.95231,.95241,.95256,.95274,.95296,.95322,.95352,.95385,.95423,.95465,.9551,.9556,.95613,.9567,.95731,.95796,.95864,.95936,.96012,.96091,.96173,.96259,.96348,.9644,.96535,.96633,.96734,.96838,.96944,.97053,.97164,.97277,.97393,.9751,.97629,.9775,.97873,.97997,.98122,.98249,.98376,.98505,.98634,.98763,.98893,.99023,.99154,.99284,.99414,.99544,.99673,.99802,.9993,.99942,.99816,.99691,.99568,.99445,.99324,.99205,.99087,.98972,.98858,.98746,.98636,.98528,.98423,.9832,.98219,.98121,.98025,.97931,.9784,.97752,.97666,.97582,.97501,.97423,.97347,.97274,.97203,.97135,.9707,.97007,.96948,.9689,.96836,.96784,.96735,.96689,.96646,.96605,.96567,.96533,.965,.96471,.96445,.96421,.964,.96382,.96367,.96355,.96346,.96339,.96335,.96334,.96336,.9634,.96348,.96358,.9637,.96385,.96403,.96423,.96446,.96471,.96499,.96529,.96561,.96595,.96631,.96669,.96709,.96751,.96795,.9684,.96887,.96935,.96984,.97035,.97087,.9714,.97194,.97249,.97304,.97361,.97418,.97476,.97534,.97592,.97651,.97711,.9777,.9783,.9789,.9795,.9801,.9807,.9813,.9819,.9825,.98309,.98369,.98428,.98486,.98545,.98603,.98661,.98718,.98775,.98832,.98888,.98944,.99,.99056,.99112,.99167,.99223,.99279,.99335,.99392,.99449,.99507,.99565,.99624,.99684,.99745,.99807,.9987,.99934,1,.99933,.99866,.99797,.99727,.99656,.99583,.9951,.99435,.99359,.99283,.99205,.99126,.99046,.98966,.98885,.98803,.9872,.98637,.98554,.9847,.98387,.98303,.98219,.98134,.9805,.97967,.97883,.978,.97717,.97634,.97552,.97471,.97389,.97309,.97229,.9715,.97071,.96993,.96915,.96838,.96762,.96687,.96612,.96539,.96466,.96395,.96324,.96255,.96187,.9612,.96055,.95991,.95929,.95869,.95811,.95754,.957,.95648,.95599,.95552,.95508,.95467,.95428,.95393,.9536,.95331,.95305,.95283,.95264]},{distance:[2.85606,2.86149,2.86432,2.8645,2.862,2.85686,2.84912,2.83886,2.82618,2.81117,2.79393,2.77456,2.75314,2.72975,2.70447,2.67734,2.64844,2.61784,2.58564,2.55196,2.5169,2.48057,2.44305,2.40438,2.36462,2.32383,2.28208,2.23943,2.19591,2.15153,2.10628,2.06016,2.01321,1.96548,1.91702,1.86793,1.8183,1.76829,1.71803,1.66767,1.61737,1.56726,1.51746,1.46803,1.41902,1.37044,1.32228,1.27452,1.22716,1.18023,1.13376,1.08781,1.04244,.99769,.95357,.91003,.86701,.82447,.78238,.74069,.69938,.65836,.61758,.57699,.53656,.49627,.45611,.41611,.37632,.33683,.29776,.25924,.22141,.18441,.14839,.11346,.07972,.04727,.01619,-.01348,-.0417,-.0684,-.09351,-.11698,-.13875,-.1588,-.17713,-.19381,-.20889,-.22242,-.23444,-.24501,-.25421,-.26216,-.26897,-.27473,-.27951,-.28336,-.28631,-.28836,-.28948,-.28963,-.28873,-.28673,-.28355,-.27916,-.27354,-.26673,-.25878,-.2498,-.23992,-.22929,-.21802,-.20623,-.19398,-.18134,-.16836,-.1551,-.14163,-.12809,-.11461,-.1013,-.08826,-.07557,-.06335,-.0517,-.04077,-.03065,-.02143,-.01321,-.00606,0,.00496,.00888,.01181,.01385,.01511,.0157,.01574,.01533,.01458,.01358,.0124,.01112,.00979,.00851,.00738,.0065,.006,.00596,.00646,.00754,.00924,.01161,.01471,.01858,.02323,.02865,.03481,.04169,.0493,.05765,.06677,.07671,.08754,.09934,.11222,.12628,.14159,.15823,.17624,.19561,.21632,.23828,.26142,.28563,.31083,.33696,.36397,.39185,.42057,.4501,.48036,.51125,.54264,.5744,.60646,.63871,.67105,.70337,.73556,.76751,.79918,.83048,.86139,.8919,.92202,.95184,.98144,1.01094,1.04045,1.0701,1.10002,1.13029,1.16103,1.1923,1.22416,1.25664,1.28979,1.32364,1.35824,1.39363,1.42985,1.4669,1.50475,1.54332,1.58252,1.62227,1.6625,1.70312,1.744,1.78501,1.82598,1.8668,1.90734,1.94754,1.98732,2.02666,2.06555,2.10402,2.1421,2.17985,2.2173,2.25448,2.29139,2.328,2.36424,2.4,2.43515,2.46955,2.50309,2.53565,2.56717,2.59761,2.62692,2.65505,2.68191,2.7074,2.73138,2.75375,2.7744,2.79324,2.81017,2.82504,2.83772,2.8481],pressure:[.22758,.23641,.24578,.25568,.26609,.27699,.28835,.30016,.31237,.32495,.33789,.35113,.36466,.37843,.39241,.40658,.4209,.43535,.44989,.4645,.47916,.49385,.50853,.5232,.53784,.55243,.56696,.58141,.59578,.61004,.62419,.63821,.65209,.6658,.67934,.69268,.70582,.71873,.73139,.7438,.75594,.76779,.77935,.79061,.80156,.81221,.82254,.83258,.84231,.85176,.86091,.86978,.87837,.88669,.89473,.9025,.91,.91725,.92425,.931,.93752,.9438,.94985,.95566,.96124,.96658,.97168,.97652,.98109,.98539,.98939,.99309,.99646,.99949,.99783,.99552,.99361,.99209,.99098,.99029,.99003,.99019,.99079,.99181,.99324,.9951,.99735,1,.99698,.99361,.98992,.98592,.98163,.97709,.97231,.96731,.96212,.95676,.95122,.94554,.93973,.93378,.92773,.92157,.91532,.90899,.90258,.89612,.88961,.88308,.87653,.87,.8635,.85705,.85068,.8444,.83823,.83219,.82628,.82052,.81493,.80952,.8043,.79929,.7945,.78994,.78561,.78151,.77765,.77402,.77062,.76742,.76443,.76161,.75896,.75645,.75406,.75175,.74951,.7473,.74511,.74289,.74064,.73833,.73592,.73341,.73078,.728,.72507,.72197,.71869,.71522,.71156,.70769,.70363,.69936,.69489,.69021,.68533,.68023,.67492,.66939,.66363,.65765,.65145,.64501,.63833,.63143,.62428,.61691,.60931,.60148,.59344,.58521,.57679,.5682,.55948,.55063,.54167,.53264,.52354,.51439,.50522,.49603,.48686,.47773,.46865,.45964,.45072,.44192,.43324,.42469,.41629,.40804,.39994,.392,.3842,.37655,.36903,.36164,.35437,.3472,.34012,.33312,.3262,.31933,.31251,.30574,.299,.2923,.28563,.27899,.27239,.26583,.25933,.25288,.24652,.24025,.2341,.22808,.22221,.21653,.21104,.20576,.20072,.19592,.19138,.18712,.18313,.17943,.17602,.17292,.17013,.16766,.16551,.16369,.16222,.1611,.16036,.16001,.16007,.16055,.16148,.16286,.16471,.16705,.16988,.17321,.17706,.18144,.18636,.19182,.19785,.20443,.21158,.2193]},{distance:[-2.31317,-2.3191,-2.32189,-2.32154,-2.31811,-2.31174,-2.30254,-2.29062,-2.27609,-2.25904,-2.23954,-2.21767,-2.19355,-2.16732,-2.13907,-2.10885,-2.07672,-2.04268,-2.00677,-1.96911,-1.92985,-1.88914,-1.84713,-1.80397,-1.75979,-1.71467,-1.66864,-1.62171,-1.57395,-1.52546,-1.47625,-1.42628,-1.3755,-1.32384,-1.27131,-1.218,-1.16408,-1.10972,-1.05508,-1.00031,-.94551,-.89077,-.83615,-.7817,-.72757,-.6739,-.62076,-.56821,-.51625,-.46484,-.41397,-.36366,-.314,-.26506,-.21689,-.16957,-.12316,-.07766,-.03301,.01085,.05399,.09643,.13827,.17967,.22079,.26176,.30265,.34342,.38397,.42414,.46381,.50285,.54115,.57863,.61524,.65093,.6856,.71914,.75153,.78275,.81283,.84182,.86972,.89651,.92208,.94634,.96919,.99052,1.01025,1.02835,1.04484,1.05976,1.07309,1.08479,1.09492,1.1036,1.11096,1.11714,1.12224,1.12627,1.12916,1.13083,1.13125,1.13036,1.12816,1.12466,1.11992,1.11397,1.10677,1.09827,1.08849,1.07746,1.06527,1.05203,1.03786,1.02283,1.00695,.99025,.97279,.9546,.93573,.9163,.8965,.8765,.85647,.83652,.81687,.79775,.77939,.76199,.74568,.73049,.71635,.70316,.69082,.67925,.66834,.65804,.64831,.63911,.63032,.62184,.61363,.60564,.59788,.59036,.58308,.57597,.5689,.56177,.55447,.5469,.53896,.53062,.5219,.51283,.5034,.49355,.48335,.47287,.46223,.45154,.44085,.43012,.41923,.40805,.39648,.38441,.37176,.35849,.34458,.32999,.31461,.29833,.28109,.26288,.2437,.22361,.20265,.18082,.15807,.13434,.1096,.0838,.0569,.02894,0,-.0298,-.0604,-.09173,-.12364,-.15594,-.18843,-.22092,-.25331,-.28559,-.31781,-.35006,-.38244,-.41502,-.44785,-.48098,-.5144,-.54811,-.58218,-.61666,-.65153,-.68677,-.72232,-.75807,-.79397,-.83002,-.86628,-.90281,-.93968,-.97693,-1.01465,-1.05282,-1.09139,-1.13031,-1.16956,-1.20917,-1.24905,-1.28907,-1.32908,-1.36891,-1.40844,-1.44765,-1.48658,-1.52527,-1.56376,-1.60206,-1.64016,-1.67801,-1.71552,-1.75264,-1.78936,-1.8257,-1.86161,-1.89702,-1.93182,-1.96584,-1.99894,-2.03102,-2.06203,-2.0919,-2.12056,-2.14794,-2.17397,-2.19852,-2.22138,-2.24235,-2.26129,-2.27805,-2.29243,-2.30422],pressure:[.9681,.97424,.98046,.98674,.99309,.9995,.99404,.98754,.981,.97444,.96785,.96124,.95462,.94801,.94139,.93479,.92822,.92167,.91515,.90868,.90225,.89589,.88959,.88336,.87722,.87115,.86519,.85932,.85356,.84792,.84239,.83699,.83173,.8266,.82162,.81679,.81211,.80759,.80324,.79906,.79505,.79121,.78756,.78409,.78081,.77771,.77481,.77211,.76959,.76728,.76516,.76324,.76153,.76001,.75869,.75757,.75665,.75593,.7554,.75507,.75493,.75498,.75523,.75565,.75627,.75706,.75803,.75917,.76049,.76197,.76361,.76541,.76737,.76947,.77172,.77409,.7766,.77923,.78198,.78484,.7878,.79086,.79401,.79724,.80055,.80394,.8074,.81092,.8145,.81813,.82182,.82556,.82934,.83317,.83703,.84093,.84487,.84884,.85284,.85687,.86094,.86503,.86915,.87329,.87746,.88166,.88587,.89011,.89436,.89863,.90291,.9072,.91149,.91579,.92009,.92438,.92867,.93295,.9372,.94144,.94566,.94985,.954,.95812,.96219,.96623,.97021,.97415,.97802,.98184,.9856,.9893,.99293,.9965,1,.99657,.9932,.98991,.98668,.98352,.98042,.97738,.9744,.97148,.9686,.96577,.96298,.96023,.95751,.95482,.95214,.94949,.94684,.9442,.94156,.93892,.93627,.93361,.93094,.92825,.92555,.92284,.9201,.91735,.91458,.91179,.90899,.90616,.90332,.90047,.8976,.89472,.89183,.88893,.88603,.88314,.88024,.87735,.87448,.87162,.86878,.86597,.86319,.86044,.85774,.85508,.85247,.84993,.84744,.84503,.84269,.84042,.83825,.83616,.83417,.83227,.83048,.8288,.82724,.82578,.82445,.82324,.82215,.82119,.82037,.81967,.81911,.81868,.81839,.81824,.81823,.81835,.81862,.81903,.81957,.82026,.82109,.82206,.82317,.82443,.82583,.82737,.82906,.83089,.83287,.83499,.83726,.83968,.84223,.84494,.84778,.85077,.8539,.85717,.86058,.86412,.86781,.87163,.87559,.87968,.88391,.88826,.89275,.89737,.90211,.90698,.91198,.91709,.92233,.92768,.93315,.93873,.94441,.95019,.95607,.96205]},{distance:[4.72925,4.81721,4.9037,4.98859,5.07177,5.15311,5.23249,5.3098,5.38491,5.45772,5.52811,5.59598,5.66122,5.72375,5.78346,5.84028,5.8941,5.94486,5.99248,6.03689,6.07803,6.11584,6.15028,6.18128,6.20882,6.23285,6.25336,6.27031,6.28369,6.29348,6.29969,6.3023,6.30133,6.29678,6.28867,6.27703,6.26187,6.24324,6.22116,6.19567,6.16683,6.13468,6.09928,6.06068,6.01896,5.97417,5.92639,5.87569,5.82217,5.76589,5.70696,5.64545,5.58147,5.5151,5.44644,5.37559,5.30265,5.2277,5.15085,5.0722,4.99184,4.90987,4.82639,4.74151,4.65533,4.56794,4.47945,4.38996,4.29959,4.20843,4.11658,4.02416,3.93125,3.83796,3.74437,3.65057,3.55666,3.46272,3.36884,3.27509,3.18155,3.08831,2.99545,2.90303,2.81114,2.71984,2.62922,2.53933,2.45026,2.36207,2.27484,2.18862,2.10349,2.01951,1.93675,1.85528,1.77515,1.69644,1.61919,1.54348,1.46935,1.39685,1.32605,1.25698,1.18967,1.12417,1.06049,.99863,.93862,.88044,.82408,.76953,.71676,.66574,.61644,.56882,.52282,.47841,.43553,.39413,.35414,.31551,.27817,.24206,.20712,.17328,.14048,.10866,.07776,.04772,.01848,-.00999,-.03776,-.06487,-.09134,-.11721,-.14251,-.16725,-.19144,-.21509,-.2382,-.26076,-.28275,-.30416,-.32496,-.34511,-.36459,-.38334,-.40134,-.41852,-.43485,-.45026,-.46471,-.47815,-.49052,-.50179,-.51189,-.52081,-.52849,-.5349,-.54003,-.54383,-.54627,-.54734,-.54702,-.54528,-.54211,-.53752,-.53149,-.52403,-.51515,-.50487,-.4932,-.48015,-.46575,-.45001,-.43297,-.41463,-.39503,-.37419,-.35213,-.32887,-.30443,-.27885,-.25214,-.22432,-.19541,-.16544,-.13442,-.10235,-.06926,-.03514,0,.03616,.07336,.11159,.15088,.19125,.23272,.27531,.31906,.36401,.41019,.45764,.5064,.55651,.60802,.66096,.71538,.77129,.82874,.88776,.94836,1.01056,1.07438,1.13982,1.20687,1.27554,1.34581,1.41766,1.49107,1.56599,1.64239,1.72025,1.79951,1.88013,1.96209,2.04532,2.12979,2.21546,2.30226,2.39017,2.47911,2.56905,2.65991,2.75164,2.84416,2.93742,3.03133,3.12582,3.2208,3.31619,3.41191,3.50785,3.60393,3.70006,3.79612,3.89202,3.98765,4.08291,4.17767,4.27182,4.36525,4.45783,4.54944,4.63995],pressure:[.30942,.30838,.30765,.30724,.30715,.30738,.30795,.30884,.31007,.31164,.31354,.31578,.31837,.32129,.32455,.32815,.33209,.33636,.34097,.34591,.35117,.35675,.36265,.36887,.37539,.38221,.38933,.39674,.40442,.41238,.4206,.42907,.43779,.44675,.45593,.46533,.47493,.48473,.49471,.50486,.51517,.52563,.53623,.54694,.55777,.5687,.57971,.59079,.60194,.61313,.62435,.6356,.64686,.65811,.66935,.68056,.69174,.70286,.71391,.72489,.73579,.74659,.75728,.76785,.7783,.7886,.79876,.80877,.81861,.82827,.83776,.84706,.85617,.86507,.87378,.88227,.89056,.89863,.90649,.91412,.92153,.92872,.93568,.94241,.94892,.95519,.96122,.96702,.97258,.97791,.98299,.98783,.99242,.99677,.99911,.99525,.99164,.98827,.98515,.98228,.97966,.97728,.97514,.97324,.97159,.97017,.96898,.96801,.96727,.96674,.96641,.96629,.96635,.96661,.96703,.96762,.96838,.96928,.97032,.97149,.97279,.9742,.97572,.97734,.97905,.98085,.98273,.98468,.98669,.98877,.99091,.99311,.99535,.99765,1,.9976,.99516,.99267,.99014,.98755,.98491,.98222,.97947,.97666,.97378,.97083,.96781,.96471,.96153,.95826,.9549,.95144,.94787,.9442,.94042,.93651,.93249,.92834,.92407,.91966,.91512,.91045,.90564,.90069,.8956,.89037,.885,.87949,.87384,.86806,.86214,.85608,.84988,.84356,.83711,.83053,.82383,.81702,.81009,.80306,.79594,.78872,.78141,.77403,.76657,.75905,.75148,.74385,.73619,.72849,.72076,.71302,.70526,.69749,.68972,.68195,.67419,.66644,.65871,.65099,.64329,.63561,.62795,.62032,.61271,.60512,.59755,.59001,.58248,.57497,.56749,.56002,.55256,.54512,.5377,.5303,.52291,.51554,.50819,.50087,.49358,.48632,.4791,.47192,.4648,.45773,.45072,.44378,.43692,.43015,.42346,.41687,.41039,.40403,.39779,.39168,.38571,.37989,.37423,.36873,.36342,.35828,.35335,.34862,.34409,.3398,.33573,.3319,.32831,.32498,.32192,.31912,.3166,.31436,.31242,.31077]}]};function QR(e){let t=null;for(const i of e){const e=i.type;if(XR(i))if(M(t))t=e;else if(t!==e)return"uber"}return C(t)?t:"solid"}function ZR(e){let t=0;for(const{material:i}of e)if(XR(i)){if(i.color[3]*i.opacity<1)return 1;t=2}return t}function YR(e){let t=0;for(const{material:i}of e)if(XR(i)){switch(i.objectTransparency){case 1:case 0:return 1;case 2:if(i.opacity<1)return 1}t=2}return t}function XR(e){return e.size*e.color[3]*e.opacity>0}function KR(e,t,i){return e.length-function(e,t){const i=nh(e,t,!0);return-1===i?t<e[0]?0:e.length:i}(e,t*i.minimumEdgeLength)}function JR(e,t,i,r){for(let s=0;s<e.length;s++){const a=e[s].index,n=t[s],o=t[s+1];if(r)for(let e=n;e<o;e++){const t=r[e];i.set(t,a)}else for(let e=n;e<o;e++)i.set(e,a)}}const $R=U.getLogger("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView");let eM=class extends yi{constructor(e){super(e),this.updatingHandles=new Bn,this.perObjectData=new Map,this.perObjectDataEvictionCache=new Set,this.renderers=new Map,this.numberOfRenderedEdges=0,this.gpuMemoryUsage=0,this.workerAbort=h(),this.tmpModelPosition=fe(),this.localOrigins=new wR(new ba(e.renderSR))}initialize(){this.worker=new qR(this.schedule),this.componentColorManager=new yS(this.rctx,2);const e=yc.createBuffer(4);for(let t=0;t<4;t++)e.sideness.set(t,0,0===t||3===t?0:1),e.sideness.set(t,1,0===t||1===t?0:1);this.verticesBufferObject=Ha.createVertex(this.rctx,35044,e.buffer)}destroy(){this.destroyed||(this.perObjectData.forEach((e=>this._discardObjectEntry(e))),this.perObjectData.clear(),this.strokesTexture=P(this.strokesTexture),this.componentColorManager=R(this.componentColorManager),this.workerAbort.abort(),this.worker.destroy(),this.verticesBufferObject=P(this.verticesBufferObject),this.renderers.clear(),this.updatingHandles.destroy())}get updating(){return this.updatingHandles.updating}get usedMemory(){return this.gpuMemoryUsage}get numberOfRenderedPrimitives(){return this.numberOfRenderedEdges}shouldRender(){return this.renderers.size>0}async addComponentObject(e,t,i,r,s,a,n,o){if(this.hasObject(e))return;let l;const h=new tM(new Promise((e=>l=e)),i.center,i.radius);this.perObjectData.set(e,h),await this.updatingHandles.addPromise(this.addComponentGeometry(t,h,r,s,a,n,o)),this.setNeedsRender(),l()}async addOrUpdateObject3D(e,t,i,r){if(this.destroyed)return void $R.warn("Attempt to add an object to a destroyed instance");const s=this.perObjectData.get(e);let a;(null==s?void 0:s.renderables.length)>0&&this.perObjectDataEvictionCache.add(s);const n=e.boundingVolumeWorldSpace.bounds,o=new tM(new Promise((e=>a=e)),tn(n),sn(n));this.perObjectData.set(e,o);const l=new Array;if(i.mergeGeometries&&e.geometries.length>1&&function(e){let t=null,i=null;for(let s=0;s<e.geometries.length;s++){var r;const a=e.geometryRecords[s];if(a.material.supportsEdges){if(t){if(!sh(t,a.transformation))return!1}else t=a.transformation;if(!i&&C(a.origin))i=a;else if(C(null==(r=i)?void 0:r.origin)&&C(a.origin)&&i.origin.id!==a.origin.id)return!1}}return!0}(e))l.push(this.addObjectMergedGeometries(e,o,t,i,r));else for(let s=0;s<e.geometries.length;s++){const a=e.geometries[s],n=e.geometryRecords[s];n.material.supportsEdges&&l.push(this.addGeometry(e,o,a,n,t[0],i,r))}await this.updatingHandles.addPromise(Promise.all(l)),this.perObjectDataEvictionCache.delete(o),this._discardObjectEntry(s),this.setNeedsRender(),a()}_discardObjectEntry(e){e&&(e.renderables.length&&(e.renderables.forEach((e=>this.removeRenderable(e))),this.setNeedsRender()),e.loaded=null)}hasObject(e){return this.perObjectData.has(e)}async updateAllComponentOpacities(e,t){const i=t instanceof Array?e=>t[e]:()=>t;(await this.updatingHandles.addPromise(this.getObjectEntry(e))).renderables.forEach((e=>{const t=e.components.meta.length;for(let r=0;r<t;r++){const t=i(r),s=e.components.meta[r],a=s.index;s.material.opacity=t,e.components.buffer.textureBuffer.setDataElement(a,1,3,255*t)}this.updateTransparency(e)})),this.setNeedsRender()}async updateAllComponentMaterials(e,t,i,r){const s=e instanceof fo,a=!!i.slicePlaneEnabled,n=QR(t),o=LR.getKey(n,a,s);(await this.updatingHandles.addPromise(this.getObjectEntry(e))).renderables.forEach((e=>{if(o!==e.rendererKey){const t=this.renderers.get(e.rendererKey),i=this.acquireRenderer(n,a,s);t.removeRenderable(e),t.refCount.decrement(),e.rendererKey=o,i.addRenderable(e)}for(let i=0;i<t.length;i++)e.components.meta[i].material=t[i];r&&this.updateComponentBuffer(e.components),this.updateTransparency(e)})),this.setNeedsRender()}async updateObjectVisibility(e,t){(await this.updatingHandles.addPromise(this.getObjectEntry(e))).renderables.forEach((e=>e.visible=t)),this.setNeedsRender()}removeObject(e){const t=this.perObjectData.get(e);t&&(this.perObjectData.delete(e),this._discardObjectEntry(t))}async getObjectEntry(e){const t=this.perObjectData.get(e);if(!t)throw"no object";return await t.loaded,t}removeAll(){this.perObjectData.forEach(((e,t)=>this.removeObject(t)))}render(e,t){if(M(this.componentColorManager))return;this.localOrigins.updateViewMatrices(e.camera.viewMatrix);const i=e.camera.viewInverseTransposeMatrix,r=fe(),s=new mS,a=new ts.ViewProjectionTransform,n=vn();ve(r,i[3],i[7],i[11]),s.set(r),ye(a.worldFromView_TH,s.high),ye(a.worldFromView_TL,s.low),dn(a.viewFromCameraRelative_RS,e.camera.viewMatrix),wr(a.projFromView,e.camera.projectionMatrix);const o=vn();un(o,a.viewFromCameraRelative_RS),gn(n,o);let l=0,h=0;if(this.renderers.forEach((e=>{0===e.refCount.value?(this.renderers.delete(e.key),e.dispose()):e.forEachRenderable((e=>{l+=e.statistics.averageEdgeLength,h++}),t)})),this.componentColorManager.garbageCollect(),this.componentColorManager.updateTextures(),0===h)return;const c={distanceFalloffFactor:40*l/h,minimumEdgeLength:e.camera.perScreenPixelRatio,transparency:t,viewProjectionTransform:a,transformNormal_ViewFromGlobal:n};this.updateObjectCameraDistances(e),this.numberOfRenderedEdges=0,this.renderers.forEach((t=>{this.renderRegularEdges(t,e,c),this.renderSilhouetteEdges(t,e,c)}))}updateTransparency(e){const t=ZR(e.components.meta),i=YR(e.components.meta);t===e.edgeTransparency&&i===e.objectTransparency||(e.edgeTransparency=t,e.objectTransparency=i,this.renderers.get(e.rendererKey).setRenderablesDirty())}computeModelTransformWithLocalOrigin(e,t,i){if(e.getCombinedStaticTransformation(t,i),C(t.origin))this.localOrigins.register(t.origin);else{const e=ve(this.tmpModelPosition,i[12],i[13],i[14]);t.origin=this.localOrigins.acquire(e)}return function(e,t){const i=t,r=-e[0],s=-e[1],a=-e[2],n=i[3],o=i[7],l=i[11],h=i[15];i[0]+=n*r,i[1]+=n*s,i[2]+=n*a,i[4]+=o*r,i[5]+=o*s,i[6]+=o*a,i[8]+=l*r,i[9]+=l*s,i[10]+=l*a,i[12]+=h*r,i[13]+=h*s,i[14]+=h*a}(t.origin.vec3,i),t.origin}updateComponentBuffer(e){const{meta:t,buffer:i}=e;for(let e=0;e<t.length;e++){const r=t[e].material,s=t[e].index,a=ue(Math.round(8*r.size),0,255),n=ue(r.extensionLength,-128,127)+128,o="solid"===r.type?0:1,l=255*r.opacity,h=r.color,c=255*h[0],d=255*h[1],u=255*h[2],p=255*h[3];i.textureBuffer.setData(s,0,c,d,u,p),i.textureBuffer.setData(s,1,a,n,o,l)}}createComponentBuffers(e){if(M(this.componentColorManager))return null;const t=new Array,i=this.componentColorManager.getBuffer(e.length);for(let r=0;r<e.length;r++){const s=e[r],a=i.acquireIndex();t.push({index:a,material:s})}const r={meta:t,buffer:i};return this.updateComponentBuffer(r),r}extractEdges(e,t,i,r,s,a=s.length){return this.worker.process({data:t,indices:s,indicesLength:a,writerSettings:e,skipDeduplicate:i},this.workerAbort.signal,r)}createEdgeResources(e){const t={};if(M(this.verticesBufferObject))return t;if(e.regular.lodInfo.lengths.length>0){const i=new qa(this.rctx,fc,{vertices:xc,instances:wc.glLayout},{vertices:this.verticesBufferObject,instances:Ha.createVertex(this.rctx,35044,e.regular.instancesData.buffer)});t.regular={vao:i,lod:e.regular.lodInfo}}if(e.silhouette.lodInfo.lengths.length>0){const i=new qa(this.rctx,fc,{vertices:xc,instances:bc.glLayout},{vertices:this.verticesBufferObject,instances:Ha.createVertex(this.rctx,35044,e.silhouette.instancesData.buffer)});t.silhouette={vao:i,lod:e.silhouette.lodInfo}}return t}async addGeometry(e,t,i,r,s,a,n){const o=i.vertexAttributes.get("position"),l=i.indices.get("position"),h=Ar(),c={position:o,indices:l,modelTransform:h,origin:this.computeModelTransformWithLocalOrigin(e,r,h)};return this.addPositionData(t,c,i.edgeIndicesLength,s,a,n)}async addPositionData(e,t,i,r,s,a=!1){if(null==e.loaded)return;const n=this.createComponentBuffers([r]);if(M(n)||i<=0)return;const o=this.acquireRenderer(r.type,!!s.slicePlaneEnabled),{modelTransform:l,origin:h}=t,c=t.indices,d=t.position,u=d.data.length/d.size,p=Cc.createBuffer(u);for(let e=0;e<u;e++)p.position.set(e,0,d.data[e*d.size+0]),p.position.set(e,1,d.data[e*d.size+1]),p.position.set(e,2,d.data[e*d.size+2]);JR(n.meta,[0,p.componentIndex.count],p.componentIndex);const m=await this.updatingHandles.addPromise(this.extractEdges(o.writerSettings,p,!1,a,c,i));if(null==e.loaded)return;const{regular:g,silhouette:f}=this.createEdgeResources(m),v=(g?g.vao.size:0)+(f?f.vao.size:0),_={regular:g,silhouette:f,transform:{modelMatrix:l,origin:h},statistics:{gpuMemoryUsage:v,averageEdgeLength:m.averageEdgeLength},components:n,visible:!0,edgeTransparency:ZR(n.meta),objectTransparency:YR(n.meta),distanceToCamera:0,rendererKey:o.key};e.renderables.push(_),o.addRenderable(_),this.gpuMemoryUsage+=v}async addComponentGeometry(e,t,i,r,s,a,n){if(null==t.loaded)return;const o=this.createComponentBuffers(a);if(M(o))return;const l=QR(a),h=this.acquireRenderer(l,n.slicePlaneEnabled||!1,!1),c=Cc.createBuffer(i.count);gc(c.position,i),JR(o.meta,s,c.componentIndex,r);const d=h.writerSettings,u=await this.updatingHandles.addPromise(this.extractEdges(d,c,!0,!1,r));if(null==t.loaded)return;const{regular:p,silhouette:m}=this.createEdgeResources(u),g=(p?p.vao.size:0)+(m?m.vao.size:0),f={regular:p,silhouette:m,transform:e,statistics:{gpuMemoryUsage:g,averageEdgeLength:u.averageEdgeLength},components:o,visible:!0,edgeTransparency:ZR(o.meta),objectTransparency:YR(o.meta),distanceToCamera:0,rendererKey:h.key};t.renderables.push(f),h.addRenderable(f),this.gpuMemoryUsage+=g}async addObjectMergedGeometries(e,t,i,r,s){const a=new Map;let n=0,o=null,l=0;for(let t=0;t<e.geometries.length;t++){const i=e.geometries[t],r=e.geometryRecords[t];if(!r.material.supportsEdges)continue;!o&&r.origin&&(o=r);const s=i.vertexAttributes.get("position");l+=s.data.length/s.size,n+=i.edgeIndicesLength}const h=l>=65536?Uint32Array:Uint16Array,c=n?new h(n):null,d=[];let u=0;for(let t=0;t<e.geometries.length;t++){const i=e.geometries[t];if(!e.geometryRecords[t].material.supportsEdges)continue;const r=i.vertexAttributes.get("position"),s=i.indices.get("position");let n=a.get(r.data);if(null==n){n=d.length/3;for(let e=0;e<r.data.length;e+=r.size)d.push(r.data[e+0]),d.push(r.data[e+1]),d.push(r.data[e+2]);a.set(r.data,n)}if(s)for(let e=0;e<i.edgeIndicesLength;e++)c[u++]=n+s[e]}const p=o||e.geometryRecords[0],m=Ar(),g=this.computeModelTransformWithLocalOrigin(e,p,m);for(let t=0;t<e.geometryRecords.length;t++)e.geometryRecords[t].origin=g;const f={position:{data:d,size:3},indices:c,modelTransform:m,origin:g};await this.updatingHandles.addPromise(this.addPositionData(t,f,c.length,i[0],r,s))}acquireRenderer(e,t,i=!0){const r=LR.getKey(e,t,i);let s=this.renderers.get(r);return M(this.strokesTexture)&&(this.strokesTexture=function(e){const t=WR.resolution,i=t/2,r=new Uint8Array(4*t*t),s=4*t*i,a=WR.amplitude,n=2*a,o=4*t,l=Xe(t)+1,h=WR.strokes.length;let c=(l-1)*h*o;for(const{distance:e,pressure:t}of WR.strokes){let i=e,a=t,d=c;for(let e=0;e<l;e++){0!==e&&(i=HR(i,0),a=HR(a,1));for(let e=0;e<WR.resolution;e++){const t=.5+(i?i[e%i.length]/n:0),o=a?a[e%a.length]:1;kn(t,r,d),kn(o,r,d+s),d+=4}d-=o*(h+1)}c+=o}const d=new Pn(e,{pixelFormat:6408,dataType:5121,hasMipmap:!1,samplingMode:9729,width:t,height:t,wrapMode:10497},r);return new GR(t,n,a,h,d)}(this.rctx)),s||(s=new LR(this.rctx,this.techniqueRepository,{type:e,slicePlaneEnabled:t,strokesTexture:this.strokesTexture,legacy:i}),this.renderers.set(r,s)),s.refCount.increment(),s}removeRenderable(e){!function(e){e.regular&&(e.regular.vao.vertexBuffers.instances.dispose(),e.regular.vao.dispose(!1),e.regular.vao=null);e.silhouette&&(e.silhouette.vao.vertexBuffers.instances.dispose(),e.silhouette.vao.dispose(!1),e.silhouette.vao=null)}(e);const t=this.renderers.get(e.rendererKey);if(t){t.removeRenderable(e),t.refCount.decrement(),"origin"in e.transform&&this.localOrigins.release(e.transform.origin),this.gpuMemoryUsage-=e.statistics.gpuMemoryUsage;for(const t of e.components.meta)e.components.buffer.releaseIndex(t.index)}}updateObjectCameraDistances(e){const t=e.camera.eye,i=e.camera.viewForward,r=fe(),s=e=>{const{center:s,radius:a}=e;Je(r,s,t);const n=Ie(r,i),o=n<-a?1/0:n<a?0:n-a;e.renderables.forEach((e=>e.distanceToCamera=o))};this.perObjectData.forEach(s),this.perObjectDataEvictionCache.forEach(s)}renderRegularEdges(e,t,i){e.bindRegularEdges(t,i);const r=i.transparency;e.forEachRenderable((r=>{if(!r.visible||!r.regular)return;const s=KR(r.regular.lod.lengths,r.distanceToCamera,i);"origin"in r.transform&&(t.localViewMatrixForEdges=this.localOrigins.getViewMatrix(r.transform.origin)),e.renderRegularEdges(r,t,s),this.numberOfRenderedEdges+=s}),r)}renderSilhouetteEdges(e,t,i){e.bindSilhouetteEdges(t,i);const r=i.transparency;e.forEachRenderable((r=>{if(!r.visible||!r.silhouette)return;const s=KR(r.silhouette.lod.lengths,r.distanceToCamera,i);"origin"in r.transform&&(t.localViewMatrixForEdges=this.localOrigins.getViewMatrix(r.transform.origin)),e.renderSilhouetteEdges(r,t,s),this.numberOfRenderedEdges+=s}),r)}};e([le({constructOnly:!0})],eM.prototype,"rctx",void 0),e([le({constructOnly:!0})],eM.prototype,"renderSR",void 0),e([le({constructOnly:!0})],eM.prototype,"techniqueRepository",void 0),e([le({constructOnly:!0})],eM.prototype,"setNeedsRender",void 0),e([le({constructOnly:!0})],eM.prototype,"schedule",void 0),e([le({readOnly:!0})],eM.prototype,"updatingHandles",void 0),e([le({readOnly:!0})],eM.prototype,"updating",null),eM=e([ce("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView")],eM);class tM{constructor(e,t,i){this.center=t,this.radius=i,this.renderables=new Array,this.loaded=e,this.loaded.then((()=>{null!=this.loaded&&(this.loaded=!0)}))}}class iM{constructor(e,t,i,r,s,a,n,o,l){this._materialRep=e,this._shaderTechniqueRepository=i,this._rctx=r,this._compositingHelper=s,this._magnifierHelper=a,this.requestRender=n,this._stage=l,this._materialRenderers=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._hasWater=!1,this._hasOverlayWater=!1,this._content=new Map,this._isRendering=!1,this._fallbackDepthStencilTexture=null,this.performanceInfo=new Ca,this._antialiasing=1,this._oitEnabled=!1,this._multipassTerrain=!0,this._opaqueTerrain=!0,this._lighting=new Ta,this._enableNewAtmosphere=!1,this._handles=new ar,this.renderHiddenTransparentEdges=()=>{},this._smaaPass=new mR(this._rctx,i),this._oitEnabled=this._hasOITSupport,this._enableNewAtmosphere=fr(),this.requestRender(),this._offscreenRendering=new hP(this._rctx,this._compositingHelper),this._sliceHelper=new cR,this._shadowMap=new xP(this._rctx,l.viewingMode,2),this._ssaoHelper=new _R(i,this._rctx,(()=>this.requestRender())),this._highlightHelper=new aP(i,this._rctx),this._shadowHighlightHelper=new lR(this._rctx,l.viewingMode),this._shadowAccumulator=new $P(this._rctx,i,l,((e,t)=>{this.renderPassManager.shadowCastingEnabled=!0,this._renderPlugins.prepareRender(e,t),this.renderPassManager.shadowCastingEnabled=this._shadowMap.enabled}),((e,t,i,r)=>{e.start(i,t,r),this.renderShadowCascades(4,e),i.setGLViewport(this._rctx),this.ensureCameraBindParameters(i)}),(()=>this.requestRender())),this._bindParameters={slot:null,camera:null,inverseViewport:Nr(),shadowMap:this._shadowMap,shadowMappingEnabled:this._shadowMap.enabled,ssaoHelper:this._ssaoHelper,ssaoEnabled:this._ssaoHelper.enabled,origin:null,screenToWorldRatio:null,screenToPCSRatio:null,slicePlane:this._sliceHelper.plane,highlightDepthTexture:null,hasOccludees:!1,linearDepthTexture:null,terrainLinearDepthTexture:null,geometryLinearDepthTexture:null,multipassTerrainEnabled:!1,multipassGeometryEnabled:!1,cullAboveGround:!1,lastFrameColorTexture:null,reprojectionMat:null,ssrEnabled:!1,lighting:this._lighting,highlightColorTexture:null},this._renderContext=new Sa(this._rctx,this._offscreenRendering,this._lighting,this._shadowMap,this._ssaoHelper,this._sliceHelper),this._renderContext.multipassTerrainParams={camera:null,multipassTerrainEnabled:!1,cullAboveGround:!1,terrainLinearDepthTexture:null},this._renderContext.multipassGeometryParams={multipassGeometryEnabled:!1,geometryLinearDepthTexture:null},this._renderContext.ssrParams={camera:null,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMat:null,ssrEnabled:!1},this._renderPlugins=new uP({renderContext:this._renderContext,shaderTechniqueRep:i,textureRep:t,materialRep:this._materialRep,requestRender:this.requestRender,schedule:o}),this.renderPassManager=new JS(this._rctx,this._shaderTechniqueRepository),this._renderPlugins.add(this.renderPassManager.slots(),this.renderPassManager),this._handles.add([Y(ma,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",(e=>{this.renderHiddenTransparentEdges=e?()=>this.renderEdges(1):()=>{},this.requestRender()})),Y(this._stage,"camera",(()=>this.requestRender()),!0)])}get hasWater(){return this._hasWater||this._hasOverlayWater}get hasWaterReflection(){return this.hasWater&&this._waterReflectionEnabled}dispose(){this._handles.destroy(),this._smaaPass.disable(),this._materialRenderers.forEach((e=>e.dispose())),this._materialRenderers.clear(),this._edgeView=R(this._edgeView),this._offscreenRendering.dispose(),this._fallbackDepthStencilTexture=P(this._fallbackDepthStencilTexture),this._shadowMap.enabled=!1,this._shadowMap.dispose(),this._ssaoHelper.enabled=!1,this._ssaoHelper.dispose(),this._highlightHelper.dispose(),this._shadowHighlightHelper.dispose(),this._shadowAccumulator.dispose(),na.prune(),this._content.clear()}get updating(){return 1===this._antialiasing&&this._smaaPass.isLoadingResources||C(this._edgeView)&&this._edgeView.updating||this._shadowAccumulator.running||!this.isCameraFinal}ensureEdgeView(){return M(this._edgeView)&&(this._edgeView=new eM({rctx:this._rctx,renderSR:this._stage.renderSR,techniqueRepository:this._shaderTechniqueRepository,setNeedsRender:()=>this.requestRender(),schedule:e=>this._stage.resourceController.schedule(e)}),this._handles.add(this._edgeView.watch("updating",(()=>this.requestRender()),!0)),this.requestRender()),this._edgeView}get edgeView(){return this._edgeView}get isCameraFinal(){return null===this._bindParameters.reprojectionMat||Dr(this._bindParameters.reprojectionMat,hM)}get hasShadowsEnabled(){var e;return!(null==(e=this._shadowMap)||!e.enabled)}setRenderParameters(e){const{renderPassManager:t,_shadowMap:i,_ssaoHelper:r}=this;void 0!==e.screenSpaceReflectionsEnabled&&t.screenSpaceReflectionsEnabled!==e.screenSpaceReflectionsEnabled&&(t.screenSpaceReflectionsEnabled=e.screenSpaceReflectionsEnabled,this.requestRender()),void 0===e.shadowMap||i.enabled===e.shadowMap&&t.shadowCastingEnabled===e.shadowMap||(i.enabled=e.shadowMap,t.shadowCastingEnabled=e.shadowMap,this.requestRender()),void 0!==e.shadowMapMaxCascades&&i.maxCascades!==e.shadowMapMaxCascades&&(i.maxCascades=e.shadowMapMaxCascades,this.requestRender()),void 0!==e.ssao&&r.enabled!==e.ssao&&(r.enabled=e.ssao,this.requestRender()),e.background&&this._offscreenRendering.background!==e.background&&(this._offscreenRendering.background=e.background,this.requestRender());const s=e.antialiasingEnabled?1:0;void 0!==e.antialiasingEnabled&&this._antialiasing!==s&&(this._antialiasing=s,this.requestRender()),void 0!==e.highQualityTransparency&&this._multipassTerrain!==e.highQualityTransparency&&(this._multipassTerrain=e.highQualityTransparency,this._oitEnabled=e.highQualityTransparency&&this._hasOITSupport,this.requestRender()),void 0!==e.defaultHighlightOptions&&(this._highlightHelper.setDefaultOptions(e.defaultHighlightOptions),this._shadowHighlightHelper.setDefaultOptions(e.defaultHighlightOptions),this.requestRender()),void 0!==e.slicePlane&&this._sliceHelper.plane!==e.slicePlane&&(this._sliceHelper.plane=z(e.slicePlane),this.requestRender()),void 0!==e.waterReflectionEnabled&&this._waterReflectionEnabled!==e.waterReflectionEnabled&&(this._waterReflectionEnabled=e.waterReflectionEnabled,this.requestRender()),void 0!==e.opaqueTerrain&&this._opaqueTerrain!==e.opaqueTerrain&&(this._opaqueTerrain=e.opaqueTerrain,this.requestRender()),void 0!==e.hasOverlayWater&&this._hasOverlayWater!==e.hasOverlayWater&&(this._hasOverlayWater=e.hasOverlayWater,this.requestRender()),void 0!==e.shadowCastOptions&&this._shadowAccumulator.setOptions(e.shadowCastOptions)}get hasSlicePlane(){return!!this._sliceHelper.plane}get renderPlugins(){return this._renderPlugins}get _hasOITSupport(){return Xr(this._rctx).floatBufferBlendWorking}modify(e){this._isRendering&&console.warn("Renderer.modify called while rendering");const{adds:t,removes:i,updates:r}=e;if(0===t.length&&0===i.length&&0===r.length)return;i.forAll((({id:e})=>this._content.delete(e))),t.forAll((e=>this._content.set(e.id,e)));const s=Pa(e);let a=!1;s.forEach(((e,t)=>{let i=this._materialRenderers.get(t);if(!i){if(!(e.adds.length>0))return;i=new Ra(this._rctx,this._materialRep,t),this._materialRenderers.set(t,i)}i.modify(e),i.isEmpty&&(a=!0)})),a&&this._materialRenderers.forEach(((e,t)=>{e.isEmpty&&(this._materialRenderers.delete(t),e.dispose())})),this._hasHighlights=Uo(this._materialRenderers,(e=>e.hasHighlights)),this._hasOccludees=Uo(this._materialRenderers,(e=>e.hasOccludees)),this._hasWater=Uo(this._materialRenderers,(e=>e.hasWater)),this.requestRender()}updateLogic(e){let t=!1;return this._materialRenderers.forEach((i=>t=i.updateLogic(e)||t)),t}updateLightSources(e,t,i){this._lighting.groundLightingFactor=t,this._lighting.globalFactor=i,this._lighting.set(e)}render(e,t,i,r){this._isRendering=!0,this.performanceInfo.prerender(this._rctx),this._bindParameters.lighting=this._lighting,this._renderContext.hasOccludees=this._hasOccludees,this._renderContext.transparencyPassType=3,this._bindParameters.transparencyPassType=3;const s=this._offscreenRendering;s.needLastFrameColorTexture=this.hasWaterReflection,s.advanceCurrentRenderTarget();const a=this._sliceHelper.plane;r&&(this._sliceHelper.plane=null),this._rctx.bindFramebuffer(e),t.setGLViewport(this._rctx),this.needsShadowCast&&(this.renderPassManager.shadowCastingEnabled=!0),this._renderPlugins.prepareRender(t,i),this.performanceInfo.advance(0);const n=this.computeDepthRange(t);this.renderShadowMap(e,t,this._lighting.lightingMainDirection,n),this.performanceInfo.advance(1),s.initializeFrame(t),this.ensureBindParameters(t),this.renderLinearDepth(),this.performanceInfo.advance(2),this.accumulateShadows(n,t,i),this.renderNormal(),this.performanceInfo.advance(3),this.ensureBindParametersSSR(),this._ssaoHelper.computeSSAO(t,s.linearDepthTexture,s.normalTexture),this.performanceInfo.advance(4),this.performanceInfo.stats.reset(),this._renderContext.pass=0,this.renderSlot(14),s.bindFramebuffer(),this.renderSlot(0),this.renderOpaqueGeometry(),this.performanceInfo.advance(5);const o=this._multipassTerrain&&!this._opaqueTerrain;this.renderTerrainLinearDepth(o),this.setMultipassFlags(o),this.setTerrainCulling(o),this.renderEdges(2),this.performanceInfo.advance(6),this.renderHiddenTransparentEdges(),this._oitEnabled?this.renderOrderIndependentTransparency((()=>this.renderTransparentGeometry()),!1):this.renderTransparentGeometry(),this.performanceInfo.advance(7),this.renderGeometryLinearDepth(o);const l={hudVisibility:!1,transparentTerrain:!1};l.hudVisibility=this.renderHUDVisibility(),o||this.renderInternalSlot(21),this.performanceInfo.advance(9),this.renderEdges(1,o),this.performanceInfo.advance(8),l.transparentTerrain=this.renderTransparentTerrain(),l.transparentTerrain&&l.hudVisibility&&(o?this.renderLineCallouts(0):s.compositeTransparentTerrainOntoHUDVisibility(),this.renderHUD(0,s.framebuffer),this.performanceInfo.advance(16)),this.performanceInfo.advance(10),this.setTerrainCulling(!1),l.transparentTerrain&&(s.compositeTransparentTerrainOntoMain(),o&&(this.renderEdges(2),this.performanceInfo.advance(6),this._oitEnabled?this.renderOrderIndependentTransparency((()=>this.renderTransparentGeometry()),!1):this.renderTransparentGeometry(),this.performanceInfo.advance(7),this.renderEdges(1),this.performanceInfo.advance(8))),o&&this.renderLineCallouts(1),this.setMultipassFlags(!1),this._shadowAccumulator.render(),s.renderToTargets((()=>{this.renderInternalSlot(8),this.renderSlot(16),this.renderSlot(17)}),s.currentColorTarget,s.mainDepth),this.performanceInfo.advance(11),this._renderPlugins.needsLaserlineWithContrastControl&&s.renderTmpAndCompositeToMain((()=>{this.renderSlot(18)}),2),this.performanceInfo.advance(12),this.renderOccluded(),this.performanceInfo.advance(13);const h=!r&&this._magnifierHelper.enabled,c=h&&M(e)?this._offscreenRendering.getFramebuffer(this._offscreenRendering.tmpColor,this._offscreenRendering.tmpDepth):e;this._rctx.bindFramebuffer(c),this.renderAntiAliasing(this._antialiasing,this._offscreenRendering.colorTexture)||this._compositingHelper.composite(this._offscreenRendering.colorTexture,0),this.performanceInfo.advance(14),this.renderHUD(1,c),this.performanceInfo.advance(17),this.renderHighlights(c,this._bindParameters),this.performanceInfo.advance(15),h&&this._magnifierHelper.render(this._rctx,this._bindParameters),c!==e&&(this._rctx.bindFramebuffer(e),this._compositingHelper.composite(this._offscreenRendering.tmpColorTexture,0)),this._renderContext.lastFrameCamera.copyFrom(this._renderContext.camera),this._sliceHelper.plane=a,this._isRendering=!1,this.onPostRender&&this.onPostRender(),this.performanceInfo.postrender()}readDepthPixels(e,t,i,r,s,a){const n=this._offscreenRendering.bindTarget(this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth);if(!this._needsLinearDepth){this.ensureBindParameters(e),this._renderContext.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0);const t=17664;this._rctx.clearSafe(t),this.renderGeometryAndTransparentTerrainPass(2)}n.readPixels(t,i,r,s,6408,5121,a)}readAccumulatedShadow(e,t){return this._shadowAccumulator.readAccumulatedShadow(e,t)}setMultipassFlags(e){this._renderContext.multipassTerrainParams.multipassTerrainEnabled=this._bindParameters.multipassTerrainEnabled=e,this._renderContext.multipassGeometryParams.multipassGeometryEnabled=this._bindParameters.multipassGeometryEnabled=e}setTerrainCulling(e){this._renderContext.multipassTerrainParams.cullAboveGround=this._bindParameters.cullAboveGround=e}renderSlot(e){return this._renderContext.slot=e,this._renderPlugins.render()}renderEdges(e,t=!1){const i=this._edgeView;C(i)&&i.shouldRender()&&this._offscreenRendering.renderTmpAndCompositeToMain((()=>i.render(this._bindParameters,e)),1,t)}renderShadowMap(e,t,i,r){const s=this._shadowMap;if(s.enabled){if(ma.ENABLE_PROFILE_DEPTH_RANGE&&WS.begin("depthRange"),ma.ENABLE_PROFILE_DEPTH_RANGE&&WS.end("depthRange"),s.start(t,i,r),this.needsShadowHighlight){const e=this._shadowHighlightHelper;this.renderShadowCascades(7,this._shadowMap,(t=>s.takeCascadeSnapshotTo(t,e.highlightShadowMapSlot))),s.clear(),this.renderShadowCascades(6,this._shadowMap,(t=>{s.takeCascadeSnapshotTo(t,e.defaultSnapshotSlot),this.renderGeometryAndTransparentTerrainPass(7)}))}else this.renderShadowCascades(4);s.finish(e),t.setGLViewport(this._rctx)}}renderShadowCascades(e,t=this._shadowMap,i=(e=>{})){for(const r of t.getCascades())r.camera.setGLViewport(this._rctx),this.ensureCameraBindParameters(r.camera),this.renderGeometryAndTransparentTerrainPass(e),i(r)}get _needsLinearDepth(){return this._ssaoHelper.enabled||this._renderPlugins.needsLinearDepth||this._hasWater&&this._waterReflectionEnabled||this.needsShadowHighlight||this.needsShadowCast||this._enableNewAtmosphere}renderLinearDepth(){this._needsLinearDepth?this._offscreenRendering.renderToTargets((()=>this.renderGeometryAndTransparentTerrainPass(2)),this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.linearDepth),this._renderContext.ssrParams.linearDepthTexture=this._bindParameters.linearDepthTexture=this._offscreenRendering.linearDepthTexture}renderTerrainLinearDepth(e){if(e){const e=this._renderContext.pass;this._renderContext.pass=2,this._offscreenRendering.renderToTargets((()=>this.renderTransparentTerrain()),this._offscreenRendering.terrainLinearDepth,this._offscreenRendering.tmpDepth,[-1e10,-1e10,-1e10,1],!0,!0),this._renderContext.pass=e}else this._offscreenRendering.disposeTarget(this._offscreenRendering.terrainLinearDepth);this._renderContext.multipassTerrainParams.terrainLinearDepthTexture=this._bindParameters.terrainLinearDepthTexture=this._offscreenRendering.terrainLinearDepthTexture}renderGeometryLinearDepth(e){if(e){const e=this._renderContext.pass;this._offscreenRendering.renderToTargets((()=>this.renderGeometryPass(2)),this._offscreenRendering.geometryLinearDepth,this._offscreenRendering.tmpDepth,[1,1,1,1],!0,!0),this._renderContext.pass=e}else this._offscreenRendering.disposeTarget(this._offscreenRendering.geometryLinearDepth);this._renderContext.multipassGeometryParams.geometryLinearDepthTexture=this._bindParameters.geometryLinearDepthTexture=this._offscreenRendering.geometryLinearDepthTexture}get needsNormal(){return this._ssaoHelper.enabled}renderNormal(){this.needsNormal?this._offscreenRendering.renderToTargets((()=>{this.renderGeometryAndTransparentTerrainPass(3)}),this._offscreenRendering.normal,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.normal)}get needsDepthRange(){return this._shadowMap.enabled||this.needsShadowCast}computeDepthRange(e){if(!this.needsDepthRange)return MT;const t=IS(e,this._content,this._stage.layers);return PT(t,this.renderPlugins.queryDepthRange(e)),t.near=Math.max(e.near,t.near),t.far=Math.min(e.far,t.far),t}renderGeometryAndTransparentTerrainPass(e){this._renderContext.pass=e,this.renderGeometryPass(e),this.renderTransparentTerrain()}renderGeometryPass(e){this._renderContext.pass=e,this.renderOpaqueGeometry(),this.renderTransparentGeometry()}renderOpaqueGeometry(){this.renderSlot(1),this.renderSlot(2),this.renderInternalSlot(3),this.renderSlot(4),this.renderSlot(15)}renderTransparentGeometry(){this.renderInternalSlot(5),this.renderSlot(6)}renderTransparentTerrain(){return this.renderSlot(7)}renderHUDVisibility(){let e=!1;return this._renderContext.offscreenRenderingHelper&&this._renderContext.offscreenRenderingHelper.renderHUDVisibility((()=>{this._bindParameters.hudVisibilityTexture=this._renderContext.offscreenRenderingHelper?this._renderContext.offscreenRenderingHelper.hudVisibilityTexture:null,e=this.renderInternalSlot(12)}),this._multipassTerrain&&!this._opaqueTerrain),e}renderLineCallouts(e){this._bindParameters.renderTransparentlyOccludedHUD=e,0===e?this._offscreenRendering.renderToTargets((()=>this.renderInternalSlot(21)),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this.renderInternalSlot(21)}renderHUD(e,t){this._oitEnabled?(this.renderOrderIndependentTransparency((()=>this.renderHUDElements(e)),!0),this._rctx.bindFramebuffer(t),this._compositingHelper.composite(this._offscreenRendering.hudColorTexture,2)):0===e?this._offscreenRendering.renderToTargets((()=>this.renderHUDElements(0)),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this.renderHUDElements(e)}renderHUDElements(e){this._bindParameters.renderTransparentlyOccludedHUD=e,this.renderInternalSlot(22),this.renderInternalSlot(19),this.renderInternalSlot(20)}get needsHighlight(){return this._hasHighlights||this._renderPlugins.needsHighlight}get needsShadowHighlight(){return this._shadowMap.enabled&&this._shadowHighlightHelper.isVisible&&this.needsHighlight}renderHighlights(e,t){if(!this.needsHighlight)return void this._offscreenRendering.disposeTarget(this._offscreenRendering.highlight);const i=this._highlightHelper,r=i.profilingCallback&&Ma(this._renderContext.rctx);this._renderContext.highlightDepthTexture=t.highlightDepthTexture;const s=this._offscreenRendering.renderToTargets((()=>{this.renderGeometryAndTransparentTerrainPass(5),this._rctx.clearSafe(256),this.renderHUDElements(2)}),this._offscreenRendering.highlight,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0);this._bindParameters.highlightColorTexture=s.colorTexture,this.needsShadowHighlight&&this._shadowHighlightHelper.render(t,e),i.render(this._renderContext.camera,s,e),C(r)&&i.profilingCallback&&r.stop((e=>{i.profilingCallback&&i.profilingCallback(e)}))}get needsShadowCast(){return this._shadowAccumulator.isAccumulating}accumulateShadows(e,t,i){this.needsShadowCast&&(this._shadowAccumulator.setAccumulationDependencies(this._offscreenRendering.linearDepthTexture,e,t,i),this._shadowAccumulator.accumulateFixedSamples(),this.renderPassManager.shadowCastingEnabled=this._shadowMap.enabled)}renderOrderIndependentTransparency(e,t){const i=i=>{this._renderContext.transparencyPassType=i,this._bindParameters.transparencyPassType=this._renderContext.transparencyPassType,this._offscreenRendering.renderOITPass((()=>e()),i,t)},r=this._renderContext.pass;this._renderContext.pass=1,i(1),this._renderContext.pass=0,i(0),i(2),this._offscreenRendering.compositeTransparentOntoOpaque(t),this._renderContext.transparencyPassType=3,this._bindParameters.transparencyPassType=this._renderContext.transparencyPassType,this._renderContext.pass=r}renderOccluded(){let e=0;this._materialRenderers.forEach(((t,i)=>{i&&i.isVisible()&&8===i.renderOccluded&&(e|=i.renderOccluded,sM.push(i))}));const t=this._offscreenRendering,i=(i,r,s,a,n)=>{0!=(e&r)&&(t.renderToTargets(s,t.tmpColor,t.mainDepth,[0,0,0,0],a,n),t.compositeOccludedOntoMain(i))};0!==sM.length&&(this.renderInternalSlot(10,sM),i(.5,8,(()=>this.renderInternalSlot(11,sM)),!1,!1),sM.length=0),this._materialRenderers.forEach(((t,i)=>{i&&i.isVisible()&&(4===i.renderOccluded||2===i.renderOccluded||16===i.renderOccluded)&&(e|=i.renderOccluded,rM.push(i))}));const r=this._renderPlugins.renderOccludedFlags;if(e|=r,!e)return;const s=e=>{this._renderContext.renderOccludedMask=e,r>1&&this.renderSlot(9),this.renderInternalSlot(3,rM),this.renderInternalSlot(5,rM),this.renderInternalSlot(8,rM),this._renderContext.resetRenderOccludedMask()};this._renderContext.pass=0,i(.5,4,(()=>s(4)),!0,2),i(.5,2,(()=>s(2)),!0,2),i(1,16,(()=>s(16)),!0,2),rM.length=0}renderAntiAliasing(e,t){if(1===e){if(this._smaaPass.loadResources((()=>this.requestRender())),this._smaaPass.enable())return this._smaaPass.render({colorTexture:t}),!0}else this._smaaPass.disable();return!1}ensureCameraBindParameters(e){this._renderContext.camera=e,this._bindParameters.camera=this._renderContext.camera,this._bindParameters.inverseViewport[0]=1/this._renderContext.camera.fullViewport[2],this._bindParameters.inverseViewport[1]=1/this._renderContext.camera.fullViewport[3]}ensureBindParameters(e){var t;this.ensureCameraBindParameters(e);const i=this._renderContext.offscreenRenderingHelper;this._bindParameters.shadowMap=this._renderContext.shadowMap,this._bindParameters.shadowMappingEnabled=this._renderContext.shadowMap.enabled,this._bindParameters.ssaoHelper=this._renderContext.ssaoHelper,this._bindParameters.ssaoEnabled=this._renderContext.ssaoHelper.enabled,this._bindParameters.slicePlane=this._renderContext.sliceHelper.plane,this._bindParameters.hasOccludees=this._renderContext.hasOccludees,this._renderContext.multipassTerrainParams.camera=this._renderContext.camera,this._bindParameters.hudVisibilityTexture=i.hudVisibilityTexture,this._bindParameters.highlightDepthTexture=null!=(t=i.depthTexture)?t:this.getFallbackDepthTexture()}ensureBindParametersSSR(){this.hasWaterReflection?(this._renderContext.lastFrameCamera.equals(this._renderContext.camera)?this._renderContext.ssrParams.reprojectionMat=this._bindParameters.reprojectionMat=hM:(Pr(aM,this._renderContext.lastFrameCamera.viewMatrix,this._bindParameters.origin?this._bindParameters.origin:[0,0,0]),Pr(oM,this._renderContext.camera.viewMatrix,this._bindParameters.origin?this._bindParameters.origin:[0,0,0]),_r(oM,oM),_r(nM,this._renderContext.camera.projectionMatrix),Cr(lM,oM,nM),Cr(lM,aM,lM),Cr(lM,this._renderContext.lastFrameCamera.projectionMatrix,lM),this._renderContext.ssrParams.reprojectionMat=this._bindParameters.reprojectionMat=lM),this._renderContext.ssrParams.camera=this._renderContext.camera,this._renderContext.ssrParams.lastFrameColorTexture=this._bindParameters.lastFrameColorTexture=this._offscreenRendering.lastFrameColorTexture):this._renderContext.ssrParams.lastFrameColorTexture=this._bindParameters.lastFrameColorTexture=null,this._renderContext.ssrParams.ssrEnabled=this._bindParameters.ssrEnabled=this.hasWaterReflection}renderInternalSlot(e,t){const i=0===this._renderContext.pass?this.performanceInfo.stats:null;let r=!1;return this._bindParameters.slot=e,C(t)?t.forEach((t=>{if(!oa(t,this._renderContext))return;const i=this._materialRenderers.get(t);C(i)&&(r=i.render(e,this._renderContext.pass,this._bindParameters)||r)})):this._materialRenderers.forEach(((t,s)=>{oa(s,this._renderContext)&&(r=t.render(e,this._renderContext.pass,this._bindParameters,i)||r)})),r}getFallbackDepthTexture(){return this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=la(this._rctx)),this._fallbackDepthStencilTexture}getGpuMemoryUsage(){return{offscreen:this._offscreenRendering?this._offscreenRendering.getGpuMemoryUsage():0,highlights:(this._highlightHelper?this._highlightHelper.getGpuMemoryUsage():0)+(this._shadowHighlightHelper?this._shadowHighlightHelper.getGpuMemoryUsage():0),shadows:this._shadowMap?this._shadowMap.getGpuMemoryUsage():0,ssao:this._ssaoHelper?this._ssaoHelper.gpuMemoryUsage:0}}get test(){const e=this;return{offscreen:this._offscreenRendering,shadowMap:this._shadowMap,ssao:this._ssaoHelper,highlight:this._highlightHelper,lighting:this._lighting,materialRenderers:this._materialRenderers,shadowAccumulator:this._shadowAccumulator,enableNewAtmosphere:e=>{this._enableNewAtmosphere=e},getFramebufferTexture:t=>{var i;switch(t){case 0:return e._offscreenRendering.colorTexture;case 1:return e._offscreenRendering.linearDepthTexture;case 2:return e._offscreenRendering.normalTexture;case 3:return null==(i=e._shadowMap)?void 0:i.test.depthTexture;case 4:return e._offscreenRendering.hudVisibilityTexture;case 5:return e._offscreenRendering.highlightTexture}}}}}const rM=[],sM=[],aM=Ar(),nM=Ar(),oM=Ar(),lM=Ar(),hM=Ar(),cM=U.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository");class dM{constructor(e,t,i){this._stage=e,this._rctx=i,this._idToRefCountedTexture=new Map,this._loadingCount=0,this._frameUpdates=new Map,this._fallbackTextureData=new Uint8Array(256),this._fallbackTextureTransparentData=new Uint8Array(256),this.events=new tr,this._textureTechnique=t.acquire(Da,new Aa);for(let e=0;e<this._fallbackTextureData.length;++e)this._fallbackTextureData[e]=255,this._fallbackTextureTransparentData[e]=(e+1)%4!=0?255:0;this._fallbackTextureDesc={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:8,height:8,maxAnisotropy:this._rctx.parameters.maxMaxAnisotropy},this._frameTask=e.resourceController.scheduler.registerTask(qo.TEXTURE_UNLOAD)}dispose(){this._frameTask.remove(),C(this._fallbackTexture)&&(this._fallbackTexture.dispose(),this._fallbackTexture=null),C(this._fallbackTextureTransparent)&&(this._fallbackTextureTransparent.dispose(),this._fallbackTextureTransparent=null),this._stage.forEachOfType(4,(e=>e.unload()))}get updating(){return this.loadingCount>0||this._frameTask.updating}acquire(e,t=!1,i){const r=this._getOrCreateRef(e,t,i);return r.ref(),r}update(){let e=!1;this._frameUpdates.forEach((t=>{const i=t.texture.frameUpdate(this._rctx,this._textureTechnique,t.previousToken);i>=0&&i!==t.previousToken&&(t.previousToken=i,e=!0)})),e&&this.events.emit("changed",0)}_getOrCreateRef(e,t,i){const r=this._idToRefCountedTexture.get(e);return r||this._createNewRef(e,t,i)}_createNewRef(e,t,i){const r=this._stage.getObject(e);Fn(void 0!==r);const s=r.events.on("unloaded",(()=>{s.remove(),this._onTextureUnloaded(e)})),a=new uM;this._idToRefCountedTexture.set(e,a);const n=r.load(this._rctx,this._textureTechnique);this._loadingCount++;const o=t=>(this._loadingCount--,this._updateGLTexture(a,t),i&&i(a),r.requiresFrameUpdates&&this._frameUpdates.set(e,{texture:r,previousToken:-1}),a),l=e=>{this._loadingCount--,c(e)||cM.error(e)};return _(n)?(this._updateGLTexture(a,t?this.fallbackTextureTransparent:this.fallbackTexture),n.then(o,l)):o(n),a}_updateGLTexture(e,t){e.glTexture=t,this.events.emit("changed",1)}release(e){const t=this._idToRefCountedTexture.get(e);if(t&&(t.unref(),t.isUnreferenced)){const i=this._stage.getObject(e);this._frameTask.schedule((()=>{t.isUnreferenced&&i.unload()}))}}getTexture(e){return this._stage.getObject(e)}get loadingCount(){return this._loadingCount}_onTextureUnloaded(e){this._idToRefCountedTexture.delete(e),this._frameUpdates.delete(e)}get fallbackTexture(){return M(this._fallbackTexture)&&(this._fallbackTexture=new Pn(this._rctx,this._fallbackTextureDesc,this._fallbackTextureData)),this._fallbackTexture}get fallbackTextureTransparent(){return M(this._fallbackTextureTransparent)&&(this._fallbackTextureTransparent=new Pn(this._rctx,this._fallbackTextureDesc,this._fallbackTextureTransparentData)),this._fallbackTextureTransparent}}class uM{constructor(){this._refCount=0,this.glTexture=null}get isUnreferenced(){return 0===this._refCount}ref(){++this._refCount}unref(){0!==this._refCount?--this._refCount:cM.error("Cannot dereference texture that has no references!")}}const pM=U.getLogger("esri.views.3d.webgl-engine.materials.internal.waterMaterialUtils");let mM=class extends yi{constructor(){super(...arguments),this._data=new Array,this.loadingState=0}dispose(){this.loadingState=0,this._data.forEach((e=>e.dispose())),this._data.length=0}get updating(){return 1===this.loadingState}get ready(){return 2===this.loadingState}loadTextures(e){const t=[Un("esri/images/materials/water/normals.jpg"),Un("esri/images/materials/water/perturbation.jpg")];this.loadingState=1,Promise.all(t.map((e=>Rn(e)))).then((t=>{t.forEach((t=>this._data.push(new Pn(e,{target:3553,pixelFormat:6408,dataType:5121,wrapMode:10497,samplingMode:9987,hasMipmap:!0,maxAnisotropy:8,width:t.width,height:t.height},t)))),this.loadingState=2})).catch((e=>{pM.error("Failed to load textures for water material.",e),this.loadingState=0}))}bind(e){this.ready&&(e.bindTexture(this._data[0],"texWaveNormal"),e.bindTexture(this._data[1],"texWavePerturbation"))}};e([le()],mM.prototype,"loadingState",void 0),e([le({type:Boolean,readOnly:!0})],mM.prototype,"updating",null),mM=e([ce("esri.views.3d.webgl-engine.materials.internal.WaterTextureRepository")],mM);class gM extends Us{constructor(e,t,i,r=null,s,a=!0){super(),this._rctx=e,this._renderScene=t,this._requestRenderScene=i,this._renderOverlay=r,this.forceCameraHook=s,this.supersample=a,this._screenshotQueue=[]}dispose(){this._rctx=null}takeScreenshot(e){this._requestRenderScene();const t=l();return this._screenshotQueue.push({settings:e,resolver:t}),t.promise}update(e){if(0!==this._screenshotQueue.length){for(const t of this._screenshotQueue){if(this.isDisposed){t.resolver.reject();continue}const i={...t.settings,pixelRatio:t.settings.pixelRatio*e.viewCamera.pixelRatio},r=this._ensureScreenshotEncodeCanvas(),s=this._renderScreenshot(e,i),a=Sc(s,i,r,{flipY:!0,premultipliedAlpha:!0});t.resolver(a)}this._screenshotQueue=[]}}_renderScreenshotOverlay(e,t,i){if(M(this._renderOverlay))return t;e.width=t.width,e.height=t.height;const r=e.getContext("2d"),s=i.pixelRatio;return r.save(),r.translate(0,t.height),r.scale(1,-1),i.region&&r.translate(-i.region.x,-i.region.y),r.scale(s,s),t=this._renderOverlay(e,t),r.restore(),t}_readbackScreenshot(e){return e.resample?this._readbackScreenshotResampled(e):this._readbackScreenshotImmediate(e)}_readbackScreenshotResampled(e){const{framebufferWidth:t,framebufferHeight:i,region:r,resample:s}=e,a=this._ensureScreenshotEncodeCanvas();let n=Pc(t,i,a);this._rctx.gl.readPixels(0,0,t,i,6408,5121,new Uint8Array(n.data.buffer)),n=this._renderScreenshotOverlay(a,n,{...e,region:null});const o=Pc(r.width,r.height,a);return Rc(n,o,!0,s.region.x,i-(s.region.y+s.region.height),s.region.width,s.region.height)}_readbackScreenshotImmediate(e){const{framebufferHeight:t,region:i}=e,r=this._ensureScreenshotEncodeCanvas(),s=Pc(i.width,i.height,r);return this._rctx.gl.readPixels(i.x,t-(i.y+i.height),i.width,i.height,6408,5121,new Uint8Array(s.data.buffer)),this._renderScreenshotOverlay(r,s,e)}_renderScreenshot(e,t){let i=null;const r=e.viewCamera,{framebufferWidth:s,framebufferHeight:a}=t;let n=!1;const o=t.disableDecorations&&e.frameHasDecorations,l=s!==r.fullWidth||a!==r.fullHeight,h=t.ignorePadding&&r.pixelRatio!==t.pixelRatio,c=l||o||h;if(c){const e=r.clone();if(t.ignorePadding){const i=cr(e.padding);for(let r=0;r<4;r++)i[r]=Math.round(i[r]/e.pixelRatio*t.pixelRatio);e.padding=i}e.fullWidth=s,e.fullHeight=a,e.pixelRatio=t.pixelRatio;const o=r.fovX-e.fovX,l=r.fovY-e.fovY;o<0&&o<l?e.fovX=r.fovX:l<0&&l<o&&(e.fovY=r.fovY),this.forceCameraHook(e),n=!0,i=new Tn(this._rctx,{width:e.fullWidth,height:e.fullHeight,colorTarget:0,depthStencilTarget:3}),this._renderScene(i,e,t.disableDecorations)}const d=this._readbackScreenshot(t);if(c&&!this._rctx.contextAttributes.alpha)for(let e=3;e<d.data.length;e+=4)d.data[e]=255;return i&&i.dispose(),this._rctx.bindFramebuffer(null),n&&this.forceCameraHook(r),d}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas}}const fM=U.getLogger("esri.views.3d.webgl-engine.parts.View");let vM=class extends(ha(yi)){constructor(e){super({}),this.events=new tr,this.waterTextureRepository=new mM,this._magnifierHelper=new NS,this._componentObjectCollection=null,this._needsUpdate=!0,this._needsRender=!0,this._idleSuspend=!0,this._needsWaterReflectionUpdate=!1,this._logicUpdateLast=0,this._container=e.container,this._initializeContext(e.options),Y(this.waterTextureRepository,"loadingState",(()=>this.setNeedsRender())),this._magnifierHelper.events.on("request-render",(()=>this.setNeedsRender())),this._stippleTextureRepository=new Oa(this._rctx),this._shaderTechniqueRepository=new Fa({rctx:this._rctx,viewingMode:e.viewingMode,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:this.waterTextureRepository}),this._textureRepository=new dM(e,this._shaderTechniqueRepository,this._rctx),this._textureRepository.events.on("changed",(e=>this.setNeedsRender(e))),this._materialRepository=new Ia(this._textureRepository,this._shaderTechniqueRepository,(()=>this.setNeedsRender())),this._compositingHelper=new AS(this._rctx,this._shaderTechniqueRepository),this._renderer=new iM(this._materialRepository,this._textureRepository,this._shaderTechniqueRepository,this._rctx,this._compositingHelper,this._magnifierHelper,((e=1)=>this.setNeedsRender(e)),((t,i)=>e.schedule(t,i)),e),this._screenshotManager=new gM(this._rctx,((e,t,i)=>this._renderer.render(e,t,t,i)),(()=>this.setNeedsRender()),e.options.screenshot.renderOverlay,(e=>this.events.emit("force-camera-for-screenshot",e))),this._registerFrameTask(e)}normalizeCtorArgs(){return{}}dispose(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas),this._frameTask&&(this._frameTask.remove(),this._frameTask=null),this._shaderTechniqueRepository.dispose(),this._shaderTechniqueRepository=null,cs(this._rctx),super.dispose(),this._tmpDepthBuffer=null,this._rctx=null}get performanceInfo(){const e=this._rctx.gl;return{renderer:this._renderer.performanceInfo,textureMemory:void 0!==e.getUsedTextureMemory?e.getUsedTextureMemory():void 0,renderbufferMemory:void 0!==e.getUsedRenderbufferMemory?e.getUsedRenderbufferMemory():void 0,VBOMemory:void 0!==e.getUsedVBOMemory?e.getUsedVBOMemory():void 0}}setNeedsRender(e=1){1===e?this._needsUpdate||(this._needsUpdate=!0,this.notifyChange("updating")):this._needsRender=!0}get needsUpdate(){return this._needsUpdate}get updating(){return this.evaluateUpdating()}evaluateUpdating(){return this.needsUpdate||this._needsWaterReflectionUpdate||this._renderer.updating||this._textureRepository.updating||this.waterTextureRepository.updating||this._magnifierHelper.updating}ensureEdgeView(){return this._renderer.ensureEdgeView()}get edgeView(){return this._renderer.edgeView}get textureRepository(){return this._textureRepository}get compositingHelper(){return this._compositingHelper}set magnifier(e){this._magnifierHelper.magnifier=e}updateLightSources(e,t,i){this._renderer.updateLightSources(e,t,i),this.setNeedsRender()}setRenderParameters(e){void 0!==e.idleSuspend&&this._idleSuspend!==!!e.idleSuspend&&(this._idleSuspend=!!e.idleSuspend,this.setNeedsRender()),this._renderer.setRenderParameters(e)}get renderingContext(){return this._rctx}get capabilities(){return this._rctx.capabilities}modify(e){this._renderer.modify(e),e.clear()}get canvas(){return this._canvas}takeScreenshot(e){return this._screenshotManager.takeScreenshot(e)}get hasShadowsEnabled(){return this._renderer.hasShadowsEnabled}readAccumulatedShadow(e){return this._renderer.readAccumulatedShadow(e[0],e[1])}getMinimalDepthForArea(e,t,i,r,s=r){const a=i.constrainWindowSize(e,t,r*i.pixelRatio,s*i.pixelRatio),n=this._ensureDepthBuffer(a);this._renderer.readDepthPixels(i,a[0],a[1],a[2],a[3],n);let o=Number.MAX_VALUE;for(let e=0;e<a[2]*a[3];e++){const t=FS(4*e,n,i.nearFar);o>t&&t!==i.nearFar[0]&&t!==i.nearFar[1]&&(o=t)}return o===Number.MAX_VALUE?void 0:o}_ensureDepthBuffer(e){const t=4*e[2]*e[3];return(M(this._tmpDepthBuffer)||this._tmpDepthBuffer.byteLength<t)&&(this._tmpDepthBuffer=new Uint8Array(t)),this._tmpDepthBuffer}get renderPlugins(){return this._renderer.renderPlugins}get test(){return{renderer:this._renderer}}getGpuMemoryUsage(){return this._renderer.getGpuMemoryUsage()}async hotReloadShaders(){Hx(),await this._shaderTechniqueRepository.hotReload(),this.setNeedsRender()}_registerFrameTask(e){const t=e.state,i={viewCamera:t.camera,frameHasDecorations:!1};let r=!1;const s={preRender:i=>{r=this.evaluateUpdating(),e.processSyncLayers();const s=q(i.time-this._logicUpdateLast);if(s>Ux||C(this.forcedAnimationTime)){const e={camera:t.camera,dt:s,forcedTime:this.forcedAnimationTime};this._logicUpdateLast=i.time,this._renderer.updateLogic(e)&&this.setNeedsRender(0)}},render:()=>{if((this.needsUpdate||this._needsRender||!this._idleSuspend||!this._renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&t.camera.fullWidth>0&&t.camera.fullHeight>0){const e=this._needsUpdate&&this._idleSuspend&&this._renderer.isCameraFinal;this._needsRender=!1,this._needsUpdate=!1,this._needsWaterReflectionUpdate=!1,this._renderer.render(null,t.camera,t.contentCamera,!1),e&&this._renderer.hasWaterReflection&&(this.setNeedsRender(0),this._needsWaterReflectionUpdate=!0)}},postRender:()=>{r===this.updating&&r===this.evaluateUpdating()||this.notifyChange("updating")},update:()=>{i.viewCamera=t.camera,i.frameHasDecorations=this._renderer.hasSlicePlane||this._magnifierHelper.enabled,this._textureRepository.update(),this._screenshotManager.update(i)}};this._frameTask=G(s)}_initializeContext(e){this._canvas=e.canvas,this._canvas||(this._canvas=document.createElement("canvas")),this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");const t={alpha:e.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:null==e.stencil||e.stencil,powerPreference:"high-performance"};let i;const r=O("esri-force-webgl");if(r?i=Ac(this._canvas,r,t):(i=Oc(this._canvas,2,t),M(i)&&(i=Ac(this._canvas,1,t))),M(i))return void fM.error(r);const s={disabledExtensions:e.deactivatedWebGLExtensions||{},debugWebGLExtensions:e.debugWebGLExtensions||{},maxAnisotropy:8};this._rctx=new Fc(i,s),Xr(this._rctx),this._loadShaderOnlyExtensions(),!e.alpha&&this._rctx.contextAttributes.alpha&&fM.error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&O("safari")>=11&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas)}_loadShaderOnlyExtensions(){this._rctx.capabilities.enable("standardDerivatives"),this._rctx.capabilities.enable("shaderTextureLOD"),this._rctx.capabilities.enable("textureFloat")}get componentObjectCollection(){return M(this._componentObjectCollection)&&(this._componentObjectCollection=new wS(this._renderer.renderPassManager)),this._componentObjectCollection}set componentObjectCollection(e){this._componentObjectCollection=e}};var _M;e([le({type:Boolean,readOnly:!0})],vM.prototype,"updating",null),e([qs()],vM.prototype,"_rctx",void 0),e([qs()],vM.prototype,"_container",void 0),e([qs()],vM.prototype,"_canvas",void 0),e([qs()],vM.prototype,"_stippleTextureRepository",void 0),e([qs(),le()],vM.prototype,"waterTextureRepository",void 0),e([qs(),le()],vM.prototype,"_magnifierHelper",void 0),e([qs(),le()],vM.prototype,"_textureRepository",void 0),e([qs()],vM.prototype,"_compositingHelper",void 0),e([qs()],vM.prototype,"_renderer",void 0),e([qs()],vM.prototype,"_screenshotManager",void 0),e([qs()],vM.prototype,"componentObjectCollection",null),e([qs()],vM.prototype,"_componentObjectCollection",void 0),vM=e([ce("esri.views.3d.webgl-engine.parts.RenderView")],vM);let yM=_M=class extends(ha(yi)){constructor(e){super(e),this._handles=new ar,this._model=new iC,this._layers=new N,this._changeSet=new za,this._layerSyncSet=new Set}initialize(){this._set("renderView",new vM(this)),this._frameTask=this.resourceController.scheduler.registerTask(qo.STAGE,this),this._handles.add(this._frameTask)}destroy(){go.pool.prune(0),this._handles.destroy(),this.dispose()}get viewingMode(){return this.state.viewingMode}get updating(){return this._model.dirtySet.dirty||this.renderView.updating}add(e){this._model.add(e),Yo(e)&&(e.attachStage(this),this._addLayer(e)),this.renderView.setNeedsRender()}remove(e){M(e)||(this.renderView.setNeedsRender(),this._model.remove(e),Yo(e)&&(this._removeLayer(e),e.detachStage()))}addMany(e){C(e)&&(this._model.addMany(e),this.renderView.setNeedsRender())}removeMany(e){C(e)&&(this._model.removeMany(e),this.renderView.setNeedsRender())}forEachOfType(e,t){this._model.forEachOfType(e,t)}handleEvent(e,t){this.destroyed||(this._model.dirtySet[e](t),this.renderView.setNeedsRender())}get running(){return this._model.dirtySet.dirty}runTask(e){this._frameTask.processQueue(e),e.done||this._commit()}_commit(){const e=this._model.dirtySet;_M.DebugSettings.logDirtySet&&console.log("Dirty set: "+e.formatDebugInfo()),e.commit(this._changeSet),_M.DebugSettings.logDirtySet&&(console.log("RGs add: "+this._changeSet.adds.map((e=>e.id))),console.log("RGs remove: "+this._changeSet.removes.map((e=>e.id)))),this._layerSyncSet.clear(),this.renderView.modify(this._changeSet),this.renderView.setNeedsRender()}schedule(e,t){return this._frameTask.schedule(e,t)}syncLayer(e){this._layerSyncSet.add(e),this.renderView.setNeedsRender()}processSyncLayers(){const e=this._model.dirtySet;this._layers.forAll((t=>{(this._layerSyncSet.has(t.id)||1===t.updatePolicy)&&(e.commitLayer(t.id,this._changeSet),this._layerSyncSet.delete(t.id))}));for(const t of this._layerSyncSet)e.commitLayer(t,this._changeSet);this._layerSyncSet.clear(),this.renderView.modify(this._changeSet)}getObject(e){return this._model.getObject(e)}get layers(){return this._layers}_addLayer(e){this._layers.some((t=>t===e))||this._layers.push(e)}_removeLayer(e){this._commit(),null!=this._layers.removeUnordered(e)&&(this._model.dirtySet.getResidentRenderGeometries(e.id,this._changeSet.removes),this.renderView.modify(this._changeSet))}addRenderPlugin(e,t,i){const r=this.renderView.renderPlugins.add(e,t,i),s=()=>{wy(t)&&this.sceneIntersectionHelper.addIntersectionHandler(t)};if(v(r))return r.then(s);s()}removeRenderPlugin(e){wy(e)&&this.sceneIntersectionHelper.removeIntersectionHandler(e),this.renderView.renderPlugins.remove(e)}get performanceInfo(){return{renderView:this.renderView.performanceInfo,model:this._model.getStats()}}get test(){const e=this;return{getCount:t=>e._model.test.content.filter((e=>e.type===t)).length,model:e._model}}};yM.DebugSettings={endFrameContentValidation:!1,logDirtySet:!1},e([le({constructOnly:!0})],yM.prototype,"resourceController",void 0),e([le({constructOnly:!0})],yM.prototype,"options",void 0),e([le({constructOnly:!0})],yM.prototype,"state",void 0),e([le({constructOnly:!0})],yM.prototype,"sceneIntersectionHelper",void 0),e([le({readOnly:!0})],yM.prototype,"viewingMode",null),e([le({constructOnly:!0})],yM.prototype,"container",void 0),e([le({constructOnly:!0})],yM.prototype,"renderSR",void 0),e([le({constructOnly:!0})],yM.prototype,"_handles",void 0),e([le({readOnly:!0})],yM.prototype,"updating",null),e([le({constructOnly:!0})],yM.prototype,"_model",void 0),e([qs(),le()],yM.prototype,"renderView",void 0),yM=_M=e([ce("esri.views.3d.webgl-engine.Stage")],yM);let xM=class extends Uc{constructor(e){super(e),this.components=["attribution","zoom","navigation-toggle","compass"]}};e([le()],xM.prototype,"components",void 0),xM=e([ce("esri.views.ui.3d.DefaultUI3D")],xM);var wM=xM;const bM=U.getLogger("esri.views.SceneView");let CM=class extends(ui(gi(pi(vi)))){constructor(e){super(e),this._userClippingArea=null,this._clippingArea=null,this._initialDefaultSpatialReference=null,this._defaults={},this._externallySet={environment:!1},this._createGraphicsViewController=null,this._resolveWhenReady=[],this.propertiesPool=new no({slicePlane:Yt},this),this._resourceController=function(e,t=(()=>performance.now())){return new Gy.ResourceController({view:e,now:t})}(this),this._defaultToMapOptions={include:new Set},this._defaultHitTestOptions={exclude:new Set},this.deconflictor=new Ev({view:this}),this.labeler=new r_({view:this,deconflictor:this.deconflictor.labels}),this.sharedSymbolResources=null,this.basemapTerrain=null,this.elevationProvider=null,this.camera=null,this.canvas=null,this.center=null,this.constraints=new hd,this.environmentManager=new Vu,this.extent=null,this.floors=new a,this.windowDevicePixelRatio=1,this.fullOpacity=1,this.graphicsView=null,this.groundView=null,this.navigating=!1,this.map=null,this.screenSizePerspectiveEnabled=!0,this.state=new q_,this.scale=null,this.spatialReference=null,this.isHeightModelInfoRequired=!0,this.alphaCompositingEnabled=!1,this.supersampleScreenhotsEnabled=!0,this.type="3d",this.ui=new wM,this._numUpdating=0,this._lastUpdateTime=0,this.updatingProgress=.5,this.viewpoint=null,this.zoom=null,this.highlightOptions=new Ay,te(),e&&e.environment||(this._defaults.environment=new _d,this.environment=this._defaults.environment);const t=e=>{C(e)&&4===e.type||(this.updatingChanged(),this.map&&this.map.allLayers.forEach((async e=>{try{await e.when()}catch{}this.updatingChanged()})))};this.handles.add([Z(this,"map.allLayers","after-changes",t,t,t,!0),this.allLayerViews.on("after-changes",(e=>this._updateUpdatingMonitors(e))),this.watch("map",(e=>{e&&e.load&&e.load().catch((()=>{}))}))]),this.inputManager=new rv({view:this});this.stateManager=new ly({view:this,updateDevicePixelRatio:()=>{const e=window.devicePixelRatio;e!==this.windowDevicePixelRatio&&(this.windowDevicePixelRatio=e,this.notifyChange("pixelRatio"))}})}initialize(){this.groundView=new fi({view:this}),this._updateUpdatingMonitors();const e=()=>this._updateDefaultToMapOptions();this.handles.add(Z(this,"map.allLayers","after-changes",e,e,e)),this.updatingHandles.add(this.qualitySettings,"memoryLimit",(e=>{this.resourceController&&(this.resourceController.memoryController.maxMemory=e)}),2),this.updatingHandles.add(this.qualitySettings,"additionalCacheMemory",(e=>{this.resourceController&&(this.resourceController.memoryController.additionalCacheMemory=e)}),2),this.updatingHandles.add(this.qualitySettings,"frameRate",(e=>Q(e>0?1e3/Math.ceil(e):0)),2),this.updatingHandles.add(ma,"SCENEVIEW_LOCKING_LOG",(e=>this.defaultsFromMap.logDebugInformation=e),2),this.updatingHandles.add(this,"map.ground",e,3),this.updatingHandles.add(this,"map.ground.opacity",(()=>this._updateDefaultHitTestOptions()),3),this.handles.add(this.watch("spatialReference",(()=>this.notifyChange("clippingArea")),!0))}destroy(){this.destroyed||(this.invalidate(),C(this.activeTool)&&(this.activeTool=null),this.layerViewManager.clear(),this._exitSurface(),this._disposeGraphicsView(),this.sharedSymbolResources=R(this.sharedSymbolResources),this.labeler.destroy(),this._set("labeler",null),this.deconflictor.destroy(),this._set("deconflictor",null),this._resourceController=R(this._resourceController),this.stateManager.destroy(),this._set("stateManager",null),this.inputManager.destroy(),this._set("inputManager",null),this.propertiesPool.destroy(),this.handles.remove("updatingMonitors"),this.environmentManager.destroy(),this._set("environmentManager",null),this.groundView=R(this.groundView))}get renderSpatialReference(){return this.renderCoordsHelper&&this.renderCoordsHelper.spatialReference}get basemapSpatialReference(){return this.basemapTerrain&&this.basemapTerrain.spatialReference}installContentCameraReset(e={sticky:!1}){return this.stateManager.installContentCameraReset(e)}get clippingArea(){if("global"===this.viewingMode)return null;let e=this._userClippingArea||this.get("map.clippingArea");return!(!!this._userClippingArea||this.get("map.clippingEnabled"))||M(e)?(this._clippingArea=null,null):e instanceof bl?this.spatialReference&&(e=SM(e,this.spatialReference),M(e))?(bM.error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(e=e.clone(),M(e.intersection(this.groundAndLayersExtent))&&(e.xmin=e.xmax,e.ymin=e.ymax),e.zmin=void 0,e.zmax=void 0,e.equals(this._clippingArea)||(this._clippingArea=e),this._clippingArea):(bM.error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea)}set clippingArea(e){this.ready&&"global"===this.viewingMode&&C(e)?bM.error("#clippingArea=","Clipping area is only supported in local viewingMode"):this._userClippingArea=e}get renderDataExtent(){if(1===this.state.viewingMode)return null;const e=this.renderSpatialReference,t=this.dataExtent;return M(t)||M(e)||t.spatialReference.equals(e)?t:SM(t,e)}get dataExtent(){let e=this.groundAndLayersExtent;const t=this.spatialReference||dr.WGS84,i=SM(this.clippingArea,t);C(i)&&(e=C(e)?e.intersection(i):i);const r=this._get("dataExtent");return C(e)&&e.equals(r)?r:e}get groundAndLayersExtent(){const e=this.spatialReference||dr.WGS84;let t;const i=i=>{const r=SM(i,e);M(r)||(C(t)?t.union(r):t=r.clone())},r=this.basemapTerrain;if(null!=r&&r.spatialReference){const e=r.groundExtent;i(new bl({xmin:e[0],ymin:e[1],zmin:0,xmax:e[2],ymax:e[3],zmax:0,spatialReference:r.spatialReference}))}if(this.map){const e=e=>{!e.fullExtent||"graphics"===e.type&&e.internal||i(e.fullExtent)};this.map.allLayers.forEach((t=>e(t)))}if(M(t))return null;t.hasZ?(t.zmin=Math.min(0,t.zmin),t.zmax=Math.max(0,t.zmax)):(t.zmin=0,t.zmax=0);const s=this._get("groundAndLayersExtent");return t.equals(s)?s:t}set environment(e){e!==this._defaults.environment&&(this._externallySet.environment=!0),this._set("environment",e)}castEnvironment(e){return e?e instanceof _d?e:e instanceof rr?null!=this.environment?this.environment.cloneWithWebsceneEnvironment(e):_d.fromWebsceneEnvironment(e):de(_d,e):new _d}get pixelRatio(){return Math.min(this.windowDevicePixelRatio,this.maximumPixelRatio)}set pixelRatio(e){C(e)?this._override("pixelRatio",e):this._clearOverride("pixelRatio")}get maximumPixelRatio(){let e=1/0;const{maximumPixelRatio:t,maximumRenderResolution:i}=this.qualitySettings;if(null!=t&&(e=Math.min(e,t)),null!=i){const t=i/Math.max(this.width,this.height);e=Math.min(e,t)}return e}set maximumPixelRatio(e){C(e)?this._override("maximumPixelRatio",e):this._clearOverride("maximumPixelRatio")}get initialExtentRequired(){return this.stateManager&&!this.stateManager.hasInitialView}get interacting(){return this.navigating||C(this.activeTool)}get stationary(){return!this.animation&&!this.resizing&&(M(this.state)||this.state.stationary)}set qualityProfile(e){My.isValidProfile(e)&&(My.apply(e,this.qualitySettings),this._set("qualityProfile",e))}get qualityProfile(){return this._get("qualityProfile")||My.getDefaultProfile()}set slicePlane(e){if(this._stage.renderView.setRenderParameters({slicePlane:e}),M(e))return void this._set("slicePlane",null);const t=this.propertiesPool.get("slicePlane");Wt(e,t),this._set("slicePlane",t)}get resolution(){return null!=this.spatialReference?Xt(this.scale,this.spatialReference):0}get heightModelInfo(){const e=this.getDefaultHeightModelInfo();return null!=e?ht.deriveUnitFromSR(e,this.spatialReference):null}get updating(){var e,t,i;let r=0,s=this.layerViewManager.updating,a=s?this.layerViewManager.updatingRemaining:0;this.allLayerViews.forEach((e=>{if(e.isFulfilled()){if(e.updating){if(s=!0,e.suspended||Jl(e))return;++a,r+=e.updatingProgress}}else++a}));for(const e of[this.graphicsView,this.basemapView,this._resourceController,this._stage,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this.featureTreeDebugger,this.toolViewManager])if(C(e)&&e.updating){const e=.1;a+=e,r+=.5*e}for(const e of[this.deconflictor,this.labeler,this.basemapTerrain])C(e)&&e.updating&&(++a,r+=e.updatingProgress);if(s=!!(s||a>0||this.updatingHandles.updating||!this.ready||!this.stationary||this._createGraphicsViewController||null!=(e=this.inputManager)&&e.hasPendingInputs||null!=(t=this.map)&&null!=(i=t.allLayers)&&i.some((e=>!e.isFulfilled()))),s?(this._numUpdating=Math.max(a,this._numUpdating),r+=this._numUpdating-a):this._numUpdating=0,this._numUpdating>0?r/=this._numUpdating:r=s?0:1,this._get("updatingProgress")!==r){const e=this._resourceController.scheduler.now;if(r<1){const t=Math.min((e-this._lastUpdateTime)/2e3,1);r=this.updatingProgress*(1-t)+r*t}this._set("updatingProgress",r),this._lastUpdateTime=s&&r<1?e:0}return s}get viewingMode(){const e=this.get("map.initialViewProperties.viewingMode");if(e)return e;const t=this.spatialReference;return!t||jc(t,"global")?"global":"local"}set viewingMode(e){if(this.ready)bM.error("#viewingMode","viewingMode cannot be set once view is ready");else{["local","global"].indexOf(e)>=0?this._override("viewingMode",e):void 0===e&&this._clearOverride("viewingMode")}}get resourceController(){return this._resourceController}get performanceInfo(){return new El(this)}forceAnimationTime(e){this._stage.renderView.forcedAnimationTime=this.basemapTerrain.overlayManager.forcedAnimationTime=e}on(e,t,i,r){const s=this.viewEvents.on(e,t,i,r);return s||super.on(e,t)}hasEventListener(e){return super.hasEventListener(e)||this.viewEvents.hasHandler(e)}toMap(e,t){if(!this.ready)return bM.error("#toMap()","Scene view cannot be used before it is ready"),null;const i=t?this.externalToInternalIntersectOptions(t):this._defaultToMapOptions,r=C(i.graphics)&&(C(i.graphics.include)||C(i.graphics.exclude)),s=Vc(e)?kc(this,e):e,a=re(s);i.enableDraped=i.include&&!i.include.has(uh)||i.exclude&&i.exclude.has(uh);const n=this.sceneIntersectionHelper,o=new uo(this.state.viewingMode);if(o.options.selectionMode=!0,o.options.store=r?2:0,n.intersectIntersectorScreen(a,o,i),r){for(const e of o.results.all){const t=Ic(e,this);if(M(t))return this._intersectResultToMapPoint(e);if(this._testGraphicUidFilter(i.graphics,t))return this._intersectResultToMapPoint(e)}return null}return this._intersectResultToMapPoint(o.results.min)}toScreen(e){if(!this.ready)return bM.error("#toScreen()","Scene view cannot be used before it is ready"),null;const t=D(null==e.z&&Ml(this.elevationProvider,e),0);return ut(e,PM,this.renderSpatialReference,t),this.state.camera.projectToScreen(PM,RM),ae(RM[0],RM[1])}pixelSizeAt(e){return this.ready?e?(ut(e,PM,this.renderSpatialReference),this.state.camera.computeScreenPixelSizeAt(PM)):0:(bM.error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null)}overlayPixelSizeInMapUnits(e){const t=this.basemapTerrain.overlayManager;return t?t.overlayPixelSizeInMapUnits(e):1}hitTest(e,t){if(!this.ready)return bM.error("#hitTest()","Scene view cannot be used before it is ready"),null;const i=Vc(e)?kc(this,e):e,r=ie(i.x,i.y),s=t?this.externalToInternalIntersectOptions(t):this._defaultHitTestOptions;s.requiresGroundFeedback=!0,s.enableDraped=!0;const a=new uo(this.state.viewingMode);a.options.selectionMode=!0,a.options.store=2,this.sceneIntersectionHelper.intersectIntersectorScreen(r,a,s);const n=this._intersectResultsToHits(a.results.all,s.graphics),o=a.results.ground,l=zc(o,this),h=C(l)&&"type"in l&&"integrated-mesh"===l.type?l:null,c={screenPoint:i,results:n,ground:{mapPoint:this._intersectResultToMapPoint(o),distance:o.hasIntersectionPoint?o.distanceInRenderSpace:0,layer:h}};return ma.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(c.intersector=a),Promise.resolve(c)}popupHitTest(e){return Ec(this,e).then((({results:t,ground:i})=>{let r=null;return!(0===t.length||Math.abs(t[0].distance-i.distance)<1e-5)||i.layer&&"integrated-mesh"===i.layer.type||(r=i.mapPoint),{results:t,screenPoint:e,mapPoint:r}}))}goTo(e,t){return this.updatingHandles.addPromise(this.stateManager.goTo(e,t))}whenLayerView(e){return super.whenLayerView(e)}takeScreenshot(e){return this.whenReady().then((()=>{const t=Mc(e,this);return t.pixelRatio/=this.pixelRatio,this._stage.renderView.takeScreenshot(Dc(t,this.supersampleScreenhotsEnabled,this.padding))}))}addUpdatingPromise(e){return this.updatingHandles.addPromise(e)}importLayerView(e){return Wc(e)}hasLayerViewModule(e){return Gc(e)}forceDOMReadyCycle(){this.forceReadyCycle()}getDefaultSpatialReference(){return this.get("map.initialViewProperties.spatialReference")||this.get("defaultsFromMap.spatialReference")||this.get("defaultsFromMap.isSpatialReferenceDone")&&this._initialDefaultSpatialReference||null}async validate(){let e=mi();if(O("safari")&&O("safari")<9&&(e=new o("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:O("safari")})),C(e))throw bM.warn("#validate()",e.message),e}isSpatialReferenceSupported(e,t,i){const r=e.isGeographic,s=e.isWebMercator,a=jc(e,"global"),n="local"===this.viewingMode,o=!(!this._isOverridden("viewingMode")&&!this.get("map.initialViewProperties.viewingMode"));if(o){if(n&&r&&!jc(e,"local"))return i?i(`Layer ${t.id} is ignored because its spatial reference is not supported in local viewing mode`):bM.warnOnce("Spatial reference defined on view not supported in local viewing mode."),!1;if(!n&&!a)return i?i(`Layer ${t.id} is ignored because its spatial reference is not supported in global viewing mode`):bM.warnOnce("Spatial reference defined on view not supported in global viewing mode."),!1}else if(r&&!a)return i?i(`Layer ${t.id} is ignored because its spatial reference is geographic but unsupported`):bM.warnOnce("Spatial reference is geographic but not supported."),!1;if(t)if(Jt(t)){let r;if(o){r=null!=jl(t,e,qc(this.viewingMode)).tileInfo}else{let i=jl(t,e,1);null==i.tileInfo&&(i=jl(t,e,2),null!=i.tileInfo&&s&&!this.ready&&(this.viewingMode="local")),r=null!=i.tileInfo}if(!r)return i&&i(`Layer ${t.id} is ignored because it is tiled but\n            its tiling scheme is not supported or compatible with the viewing mode`),!1}else if((e.isWGS84||s)&&!n)return null==this._initialDefaultSpatialReference&&(this._initialDefaultSpatialReference=e),o||this.ready||(this.viewingMode="global",i&&i(`Viewing mode locked to global due to reprojectable layer ${t.id}`)),i&&i(`Layer ${t.id} is ignored because it supports server-side reprojection`),!1;return!0}whenReady(){return new Promise((e=>{this.ready?e(this):this._resolveWhenReady.push(e)}))}computeMapPointFromVec3d(e,t){let i=this.spatialReference||dr.WGS84;return pt(e,this.renderSpatialReference,e,i)||(i=dr.WGS84,pt(e,this.renderSpatialReference,e,i)),t?(t.x=e[0],t.y=e[1],t.z=e[2],t.spatialReference=i):t=new Cl(e,i),t}trackGraphicState(e){if(!e.graphic)return bM.error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;const t=this.getViewForGraphic(e.graphic);let i=null,r=!1;const s=t=>{!r&&C(t)&&"graphics3d"in t&&t.graphics3d&&t.graphics3d.graphicsCore&&(i=t.graphics3d.graphicsCore.trackGraphicState(e))};return C(t)?s(t):this.whenViewForGraphic(e.graphic,{waitForLayer:!0}).then((e=>s(e)),(()=>{})).catch((()=>{})),{remove:()=>{r=!0,C(i)&&(i.remove(),i=null)}}}highlight(e){if(Array.isArray(e))return w(e.map((e=>this.highlight(e))));if(a.isCollection(e))return w(e.toArray().map((e=>this.highlight(e))));const t=this.getViewForGraphic(e);return t&&"highlight"in t?t.highlight(e):b()}maskOccludee(e){if(!e)return bM.error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;const t=this.getViewForGraphic(e);let i=null,r=!1;const s=t=>{!r&&C(t)&&"graphics3d"in t&&Lc(t)&&(i=t.maskOccludee(e))};return C(t)?s(t):this.whenViewForGraphic(e,{waitForLayer:!0}).then((e=>s(e)),(()=>{})).catch((()=>{})),{remove:()=>{r=!0,C(i)&&(i.remove(),i=null)}}}getViewForGraphic(e){return e.layer===this.graphics?this.graphicsView:e.layer?this.allLayerViews.find((t=>t.layer===e.layer)):null}graphicChanged(e){C(this.graphicsView)&&this.graphicsView.graphicChanged(e)}async whenViewForGraphic(e,t){if(e.layer===this)return await K(this,"graphicsView"),this.graphicsView;if(!e.layer||!this.map)throw new o("no-view-for-graphic");return t&&t.waitForLayer&&!this.map.allLayers.includes(e.layer)?new Promise(((t,i)=>{const r=this.map.allLayers.on("change",(s=>{-1!==s.added.indexOf(e.layer)&&(r.remove(),this.whenLayerView(e.layer).then(t,i))}))})):this.whenLayerView(e.layer)}externalToInternalIntersectOptions(e){const t=this._externalToInternalRenderItems(e.include,0),i=this._externalToInternalRenderItems(e.exclude,1);return{include:t.layerUids,exclude:i.layerUids,graphics:{include:t.graphicUids,exclude:i.graphicUids}}}_intersectResultToMapPoint(e,t){return e.getIntersectionPoint(PM)?(t=this.computeMapPointFromVec3d(PM,t),"TerrainRenderer"===e.intersector&&this.basemapTerrain&&(t.z=D(Ml(this.basemapTerrain,t),0)),t):null}_intersectResultsToHits(e,t){const i=new Array;let r=null;for(let s=0;s<e.length;s++){const a=e[s],n=zc(a,this);if(C(n)&&(n===this.map.ground||"type"in n&&"integrated-mesh"===n.type))break;const o=Ic(a,this);if(!C(o))continue;if(M(r)&&s!==e.length-1&&(r=new Set),C(r)){const e=this._getGraphicFilterUid(o);if(r.has(e))continue;r.add(e)}if(!this._testGraphicUidFilter(t,o))continue;const l=this._intersectResultToMapPoint(a),h=a.distanceInRenderSpace;i.push({graphic:o,mapPoint:l,distance:h})}return i}_getGraphicFilterUid(e){if(e.layer&&"objectIdField"in e.layer){const t=e.attributes[e.layer.objectIdField];if(t)return`o-${e.layer.id}-${t}`}return`u-${e.uid}`}_testGraphicUidFilter(e,t){const i=this._getGraphicFilterUid(t);return M(e)||(M(e.include)||e.include.has(i))&&(M(e.exclude)||!e.exclude.has(i))}_externalToInternalRenderItems(e,t,s={layerUids:null,graphicUids:null}){return e?(e instanceof i?(!function(e,t){e.graphicUids||(e.graphicUids=new Set);e.graphicUids.add(t)}(s,this._getGraphicFilterUid(e)),0===t&&(C(this.graphicsView)&&e.layer===this?TM(s,this.graphicsView.graphics3d.layer.id):e.layer&&TM(s,e.layer.uid))):"forEach"in e?e.forEach((e=>{Array.isArray(e)?this._externalToInternalRenderItems(e,t,s):a.isCollection(e)?e===this.graphics&&C(this.graphicsView)?TM(s,this.graphicsView.graphics3d.layer.id):this._externalToInternalRenderItems(e,t,s):e instanceof r?e===this.map.ground&&TM(s,uh):this._externalToInternalRenderItems(e,t,s)})):TM(s,e.uid),s):s}_initBasemapTerrain(){this._set("basemapTerrain",new Hb({view:this})),this._set("elevationProvider",new Ty({view:this})),this.elevationProvider.register("ground",this.basemapTerrain)}_exitBasemapTerrain(){this.basemapTerrain&&(this.elevationProvider.unregister(this.basemapTerrain),this.elevationProvider.destroy(),this._set("elevationProvider",null),this.basemapTerrain.destroy(),this._set("basemapTerrain",null))}_initGlobe(){this._initCoordinateSystem(),this.state.createInitialCamera(),this._initBasemapTerrain(),this._set("pointsOfInterest",new Rx({view:this})),this._set("featureTiles",new j_({renderCoordsHelper:this.renderCoordsHelper,cameraOnSurface:this.pointsOfInterest.contentCameraOnSurface,focus:this.pointsOfInterest.focus,tilingSchemeOwner:this.basemapTerrain,viewState:this.state,scheduler:this._resourceController.scheduler,terrain:this.basemapTerrain}));const e=()=>{const e=this.basemapTerrain&&this.basemapTerrain.extent;if(this.clippingArea||e)if(e&&this.basemapTerrain.spatialReference){const e=C(this.basemapTerrain.extent)?xt(qt(this.basemapTerrain.extent,this.basemapTerrain.spatialReference),this.spatialReference):null;C(this.clippingArea)?this.featureTiles.filterExtent=this.clippingArea.intersection(e):this.featureTiles.filterExtent=e}else this.featureTiles.filterExtent=this.clippingArea;else this.featureTiles.filterExtent=null};this.handles.add([this.updatingHandles.add(ma,"FEATURE_TILE_TREE_SHOW_TILES",(e=>{e&&this.featureTiles&&!this.featureTreeDebugger?this.updatingHandles.addPromise(import("../chunks/FeatureTileTree3DDebugger.js")).then((({FeatureTileTree3DDebugger:e})=>{!this.featureTreeDebugger&&ma.FEATURE_TILE_TREE_SHOW_TILES&&(this.featureTreeDebugger=new e({view:this}))})):e||!this.featureTreeDebugger||ma.FEATURE_TILE_TREE_SHOW_TILES||(this.featureTreeDebugger.destroy(),this.featureTreeDebugger=null)}),3),this.updatingHandles.add(this,"clippingArea",e,3),this.updatingHandles.add(this,"basemapTerrain.extent",e,3)],"feature-tiles"),this.stateManager.init()}_exitGlobe(){this.state&&(this.stateManager.deinit(),this.handles.remove("render-coords-helper"),this.handles.remove("feature-tiles"),this.featureTiles.destroy(),this._set("featureTiles",null),this.pointsOfInterest.destroy(),this._set("pointsOfInterest",null),this._exitBasemapTerrain(),this.state.exit(),this._exitCoordinateSystem())}_initCoordinateSystem(){if(this.spatialReference){const e=this.spatialReference;this.mapCoordsHelper&&this.mapCoordsHelper.spatialReference.equals(e)||this._set("mapCoordsHelper",new Oy(this.map,e));const t=this.state.isGlobal,i=t?bt(e):e.isGeographic?dr.PlateCarree:e;i!==this.renderSpatialReference&&(this._set("renderCoordsHelper",jy.create(this.state.viewingMode,i)),t||this.handles.add(this.watch("basemapTerrain.extent",(e=>{const t=this.renderCoordsHelper.spatialReference;0===e[0]&&0===e[1]&&0===e[2]&&0===e[3]||!ft(e,this.basemapTerrain.spatialReference,MM,t)||(this.renderCoordsHelper.extent=MM)}),!0),"render-coords-helper"),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(uo.DEFAULT_TOLERANCE/this.renderCoordsHelper.unitInMeters))}else this._set("mapCoordsHelper",null),this._set("renderCoordsHelper",null)}_exitCoordinateSystem(){this.mapCoordsHelper&&(this.handles.remove("render-coords-helper"),this._set("renderCoordsHelper",null),this._set("mapCoordsHelper",null))}updatingChanged(){this.notifyChange("updating")}_updateUpdatingMonitors(e=null){C(e)&&4===e.type||(this.handles.remove("updatingMonitors"),this.allLayerViews.forEach((e=>{e.destroyed||(this.handles.add([e.watch(["updating","updatingProgress"],(()=>this.updatingChanged()),!0)],"updatingMonitors"),e.when((()=>this.updatingChanged()),(()=>this.updatingChanged())))})),this.updatingChanged())}_renderScreenshotOverlay(e,t){if(!this.overlay||!this.overlay.hasVisibleItems)return t;const i=e.getContext("2d");return i.putImageData(t,0,0),this.overlay.renderCanvas(e),i.getImageData(0,0,t.width,t.height)}_initStage(){const e={deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,alpha:this.alphaCompositingEnabled,canvas:this.renderCanvas,screenshot:{renderOverlay:(e,t)=>this._renderScreenshotOverlay(e,t)}},t=new fy(this.state.viewingMode,{forEachLayer:e=>this._stage.layers.forAll(e)},this);this._set("sceneIntersectionHelper",t);const i=n(this.surface),{resourceController:r,state:s,renderSpatialReference:a}=this;this._stage=new yM({resourceController:r,container:i,options:e,state:s,sceneIntersectionHelper:t,renderSR:a}),this._lostWebGLContextHandle=y(this._stage.renderView.canvas,"webglcontextlost",(()=>this.fatalError=new o("webgl-context-lost"))),this.handles.add([this.updatingHandles.add(this.qualitySettings,"antialiasingEnabled",(()=>{this._stage.renderView.setRenderParameters({antialiasingEnabled:this.qualitySettings.antialiasingEnabled})}),2),this.updatingHandles.add(this.qualitySettings,"highQualityTransparency",(()=>{this._stage.renderView.setRenderParameters({highQualityTransparency:this.qualitySettings.highQualityTransparency})}),2),Y(this,"magnifier",(e=>this._stage.renderView.magnifier=e),!0)],"stage");const l=()=>{this._stage.renderView.setRenderParameters({defaultHighlightOptions:Ay.toEngineOptions(this.highlightOptions)})};for(const e of["highlightOptions","highlightOptions.color","highlightOptions.haloColor","highlightOptions.haloOpacity","highlightOptions.fillOpacity","highlightOptions.shadowOpacity","highlightOptions.shadowColor","highlightOptions.shadowDifference"])this.handles.add(this.updatingHandles.add(this,e,l),"stage");l(),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(uo.DEFAULT_TOLERANCE/this.renderCoordsHelper.unitInMeters),this._set("canvas",this._stage.renderView.canvas)}_exitStage(){this._set("sceneIntersectionHelper",null),this._stage.destroy(),this._stage=null,this._lostWebGLContextHandle.remove(),this._lostWebGLContextHandle=null,this.handles.remove("stage"),this._set("canvas",null)}_initSurface(e){this._exitSurface(),this.state.init(e,this.spatialReference),this._initStage(),this._initGlobe(),this.sharedSymbolResources=new Qy({view:this,viewingMode:e,resourceController:this._resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state,objectResourceCache:new h_})}_exitSurface(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitGlobe(),this._exitStage())}_createGraphicsViewIfNeeded(){if(this.graphicsView||this._createGraphicsViewController)return;if(0===this.graphics.length)return;this.handles.remove("graphics-view"),this._createGraphicsViewController=h();const e=()=>{this._createGraphicsViewController=null,this.updatingChanged()};this._createGraphicsViewAsync(this._createGraphicsViewController.signal).then(e,e),this.updatingChanged()}async _createGraphicsViewAsync(e){const t=(await import("../chunks/GraphicsView3D.js")).default;m(e),await ee(this.basemapTerrain,"ready",e),this._set("graphicsView",new t({view:this}))}_disposeGraphicsView(){this._createGraphicsViewController&&(this._createGraphicsViewController.abort(),this._createGraphicsViewController=null),this.handles.remove("graphics-view"),C(this.graphicsView)&&(this.handles.remove(this.graphicsView.graphics3d.layer.id),this.graphicsView.destroy(),this._set("graphicsView",null))}_startup(){const e=qc(this.viewingMode);if(1===e&&(this._clippingArea=null),this._set("ready",!0),this._initSurface(e),this.handles.add(Z(this,"graphics","after-changes",(()=>this._createGraphicsViewIfNeeded())),"graphics-view"),this._createGraphicsViewIfNeeded(),!this._externallySet.environment){const e=this.get("map.initialViewProperties.environment");e&&(this.environment=e)}this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect();const t=this._resolveWhenReady;this._resolveWhenReady=[],t.forEach((e=>e(this)))}_teardown(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this.labeler.dispose(),this._disposeGraphicsView(),this.handles.remove("graphics-view"),this._exitSurface(),this._set("ready",!1)}_updateDefaultToMapOptions(){if(this._defaultToMapOptions.include.clear(),this.map){this.map.ground&&this._defaultToMapOptions.include.add(uh);for(const e of this.map.allLayers.items)"integrated-mesh"===e.type&&this._defaultToMapOptions.include.add(e.uid)}}_updateDefaultHitTestOptions(){if(this._defaultHitTestOptions.exclude.clear(),this.map){this.map.ground&&this.map.ground.opacity<1&&this._defaultHitTestOptions.exclude.add(uh);for(const e of this.map.allLayers.items)"integrated-mesh"===e.type&&e.opacity<1&&this._defaultToMapOptions.exclude.add(e.uid)}}};function TM(e,t){e.layerUids||(e.layerUids=new Set),e.layerUids.add(t)}function SM(e,t){return C(e)&&yt(e.spatialReference,t)?xt(e,t):null}e([le()],CM.prototype,"_userClippingArea",void 0),e([le()],CM.prototype,"_resourceController",void 0),e([le()],CM.prototype,"_stage",void 0),e([le({readOnly:!0})],CM.prototype,"deconflictor",void 0),e([le({readOnly:!0})],CM.prototype,"labeler",void 0),e([le({type:_i,readOnly:!0,aliasOf:"state.animation"})],CM.prototype,"animation",void 0),e([le({readOnly:!0})],CM.prototype,"basemapTerrain",void 0),e([le({readOnly:!0})],CM.prototype,"elevationProvider",void 0),e([le({type:t,aliasOf:"stateManager.camera"})],CM.prototype,"camera",void 0),e([le({type:t,aliasOf:"stateManager.contentCamera"})],CM.prototype,"contentCamera",void 0),e([le({readOnly:!0})],CM.prototype,"canvas",void 0),e([le({type:Cl,aliasOf:"stateManager.center"})],CM.prototype,"center",void 0),e([le({type:bl})],CM.prototype,"clippingArea",null),e([le({type:hd})],CM.prototype,"constraints",void 0),e([le({type:bl,readOnly:!0})],CM.prototype,"renderDataExtent",null),e([le({type:bl,readOnly:!0})],CM.prototype,"dataExtent",null),e([le({type:bl,readOnly:!0})],CM.prototype,"groundAndLayersExtent",null),e([le({value:null,type:_d})],CM.prototype,"environment",null),e([he("environment")],CM.prototype,"castEnvironment",null),e([le({readOnly:!0})],CM.prototype,"environmentManager",void 0),e([le({type:bl,aliasOf:"stateManager.extent"})],CM.prototype,"extent",void 0),e([le()],CM.prototype,"floors",void 0),e([le({readOnly:!0,aliasOf:"stateManager.screenCenter"})],CM.prototype,"screenCenter",void 0),e([le({type:Number})],CM.prototype,"pixelRatio",null),e([le({type:Number,dependsOn:["qualitySettings.maximumPixelRatio","qualitySettings.maximumRenderResolution","size"]})],CM.prototype,"maximumPixelRatio",null),e([le({aliasOf:"stateManager.frustum"})],CM.prototype,"frustum",void 0),e([le({type:Number,readOnly:!0})],CM.prototype,"fullOpacity",void 0),e([le({readOnly:!0})],CM.prototype,"graphicsView",void 0),e([le()],CM.prototype,"groundView",void 0),e([le({type:Boolean})],CM.prototype,"initialExtentRequired",null),e([le({type:Boolean,readOnly:!0})],CM.prototype,"interacting",null),e([le()],CM.prototype,"stationary",null),e([le({aliasOf:"state.navigating"})],CM.prototype,"navigating",void 0),e([le()],CM.prototype,"map",void 0),e([le({readOnly:!0})],CM.prototype,"mapCoordsHelper",void 0),e([le({aliasOf:"stateManager.padding"})],CM.prototype,"padding",void 0),e([le({type:Rx,readOnly:!0})],CM.prototype,"pointsOfInterest",void 0),e([le({type:j_,readOnly:!0})],CM.prototype,"featureTiles",void 0),e([le()],CM.prototype,"featureTreeDebugger",void 0),e([le({type:Boolean})],CM.prototype,"screenSizePerspectiveEnabled",void 0),e([le({constructOnly:!0})],CM.prototype,"deactivatedWebGLExtensions",void 0),e([le({constructOnly:!0})],CM.prototype,"debugWebGLExtensions",void 0),e([le({constructOnly:!0})],CM.prototype,"renderCanvas",void 0),e([le({constructOnly:!0})],CM.prototype,"state",void 0),e([le({readOnly:!0})],CM.prototype,"inputManager",void 0),e([le({readOnly:!0})],CM.prototype,"stateManager",void 0),e([le({type:["low","medium","high"]})],CM.prototype,"qualityProfile",null),e([le({type:ky,get(){let e=this._get("qualitySettings");return e||(e=new ky,My.apply(this.qualityProfile,e)),e}})],CM.prototype,"qualitySettings",void 0),e([le()],CM.prototype,"slicePlane",null),e([le({dependsOn:["viewingMode"]})],CM.prototype,"preconditionsReady",void 0),e([le({readOnly:!0})],CM.prototype,"renderCoordsHelper",void 0),e([le({readOnly:!0})],CM.prototype,"sceneIntersectionHelper",void 0),e([le({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],CM.prototype,"resolution",null),e([le({type:Number,aliasOf:"stateManager.scale"})],CM.prototype,"scale",void 0),e([le({dependsOn:[]})],CM.prototype,"heightModelInfo",null),e([le({dependsOn:["map.initialViewProperties?.spatialReference","defaultsFromMap.isSpatialReferenceDone"]})],CM.prototype,"spatialReference",void 0),e([le({type:Boolean,constructOnly:!0})],CM.prototype,"alphaCompositingEnabled",void 0),e([le({type:Boolean})],CM.prototype,"supersampleScreenhotsEnabled",void 0),e([le({readOnly:!0})],CM.prototype,"type",void 0),e([le({type:wM})],CM.prototype,"ui",void 0),e([le({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","layerViewManager.updatingRemaining","_resourceController.updating","_stage.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.hasPendingInputs","toolViewManager.updating"]})],CM.prototype,"updating",null),e([le({type:Number,readOnly:!0,dependsOn:["updating"]})],CM.prototype,"updatingProgress",void 0),e([le({type:["global","local"],dependsOn:["map.initialViewProperties?.viewingMode","spatialReference"]})],CM.prototype,"viewingMode",null),e([le({type:s,aliasOf:"stateManager.viewpoint"})],CM.prototype,"viewpoint",void 0),e([le({type:Number,aliasOf:"stateManager.zoom"})],CM.prototype,"zoom",void 0),e([le({type:Ay})],CM.prototype,"highlightOptions",void 0),CM=e([ce("esri.views.SceneView")],CM);const PM=fe(),RM=ie(),MM=Ct();var DM=CM;export{eT as O,xw as R,Ax as T,tT as a,sT as b,md as c,uT as d,DM as default,XT as e,iT as f,hT as g,aT as h,cT as i,oT as j,lT as k,qy as m,rT as s,nT as t,Dx as u};
