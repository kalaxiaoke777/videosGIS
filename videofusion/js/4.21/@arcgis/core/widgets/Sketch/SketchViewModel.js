/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import{symbolTypes as t}from"../../symbols.js";import o from"../../core/Collection.js";import{b as i,i as r,u as s,j as n,p as a,c as p}from"../../core/lang.js";import l from"../../core/Error.js";import{E as c}from"../../chunks/Evented.js";import h from"../../core/Handles.js";import{L as d}from"../../chunks/Logger.js";import{eachAlwaysValues as u,throwIfAborted as m,isAborted as y,createAbortError as g,createAbortController as v,whenOrAbort as f}from"../../core/promiseUtils.js";import{r as j}from"../../chunks/reactiveUtils.js";import{init as w,watch as b,on as _,when as S,whenNotOnce as k,whenOnce as T}from"../../core/watchUtils.js";import{property as E}from"../../core/accessorSupport/decorators/property.js";import"../../chunks/ensureType.js";import{subclass as x}from"../../core/accessorSupport/decorators/subclass.js";import{g as G}from"../../chunks/projectionEllipsoid.js";import{c as C}from"../../geometry/Polygon.js";import O from"../../layers/GraphicsLayer.js";import{i as I}from"../../chunks/DOMContainer.js";import{c as P,h as H}from"../../chunks/elevationInfoUtils.js";import A from"../../geometry/Circle.js";import{V as M}from"../../chunks/InputManager.js";import{S as V}from"../../chunks/keybindings.js";import{HandleOwner as R}from"../../core/HandleOwner.js";import U,{r as L}from"../../core/Accessor.js";import{a as D,j as F,c as q,b as z,g as W,u as Z,q as K,k as B,d as N}from"../../chunks/vec2.js";import Q from"../../geometry/SpatialReference.js";import{s as Y}from"../../chunks/MapUtils.js";import{b as J,S as X}from"../../chunks/mathUtils.js";import{a as $,f as ee}from"../../chunks/vec2f64.js";import{d as te}from"../../chunks/Settings.js";import{o as oe,L as ie,R as re,s as se,a as ne,b as ae,c as pe,P as le,I as ce}from"../../chunks/RightAngleSnappingHint.js";import{p as he,a as de,b as ue,i as me,c as ye,d as ge,e as ve,f as fe}from"../../chunks/geometry2dUtils.js";import je from"../../views/interactive/snapping/SnappingOptions.js";import{b as we}from"../../chunks/screenUtils2.js";import{n as be}from"../../chunks/compilerUtils.js";import _e from"../../symbols/SimpleMarkerSymbol.js";import Se from"../../symbols/SimpleFillSymbol.js";import ke from"../../symbols/SimpleLineSymbol.js";import"../../symbols/CIMSymbol.js";import"../../chunks/string.js";import"../../chunks/object.js";import"../../chunks/enumeration.js";import"../../chunks/jsonMap.js";import"../../chunks/reader.js";import"../../chunks/writer.js";import"../../layers/support/fieldUtils.js";import"../../chunks/arcadeOnDemand.js";import"../../geometry.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../chunks/JSONSupport.js";import"../../chunks/metadata.js";import"../../chunks/handleUtils.js";import"../../chunks/arrayUtils.js";import"../../chunks/deprecate.js";import"../../chunks/ArrayPool.js";import"../../core/scheduling.js";import"../../config.js";import"../../chunks/Message.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/support/webMercatorUtils.js";import"../../chunks/Ellipsoid.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polyline.js";import"../../chunks/extentUtils.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../symbols/Symbol.js";import"../../Color.js";import"../../chunks/colorUtils.js";import"../../chunks/common.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/utils.js";import"../../symbols/edges/Edges3D.js";import"../../chunks/screenUtils.js";import"../../chunks/materialUtils.js";import"../../chunks/opacityUtils.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/FillSymbol.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../symbols/FillSymbol3DLayer.js";import"../../symbols/patterns/StylePattern3D.js";import"../../chunks/symbolLayerUtils3D.js";import"../../chunks/aaBoundingBox.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/Symbol3DOutline.js";import"../../symbols/Font.js";import"../../symbols/IconSymbol3DLayer.js";import"../../core/urlUtils.js";import"../../chunks/persistableUrlUtils.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/Symbol3D.js";import"../../chunks/collectionUtils.js";import"../../portal/Portal.js";import"../../intl.js";import"../../chunks/number.js";import"../../chunks/locale.js";import"../../request.js";import"../../kernel.js";import"../../chunks/assets.js";import"../../chunks/Loadable.js";import"../../chunks/Promise.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../portal/PortalGroup.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../chunks/Thumbnail.js";import"../../chunks/Symbol3DVerticalOffset.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/MeshSymbol3D.js";import"../../symbols/PictureFillSymbol.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../layers/Layer.js";import"../../chunks/Identifiable.js";import"../../chunks/BlendLayer.js";import"../../chunks/parser.js";import"../../chunks/mat4f32.js";import"../../chunks/mat4.js";import"../../chunks/_commonjsHelpers.js";import"../../chunks/ScaleRangeLayer.js";import"../../chunks/GraphicsCollection.js";import"../../Graphic.js";import"../../PopupTemplate.js";import"../../popup/content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/Content.js";import"../../popup/content/CustomContent.js";import"../../popup/content/FieldsContent.js";import"../../popup/FieldInfo.js";import"../../popup/support/FieldInfoFormat.js";import"../../chunks/date.js";import"../../popup/content/MediaContent.js";import"../../popup/content/BarChartMediaInfo.js";import"../../chunks/chartMediaInfoUtils.js";import"../../chunks/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../core/accessorSupport/decorators/aliasOf.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/TextContent.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/RelatedRecordsInfo.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../support/actions/ActionBase.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../chunks/ElevationInfo.js";import"../../chunks/unitConversionUtils.js";import"../../chunks/lengthUtils.js";import"../../chunks/unitUtils.js";import"../../chunks/domUtils.js";import"../../chunks/projector.js";import"../../chunks/widgetUtils.js";import"../Popup.js";import"../../chunks/throttle.js";import"../Feature.js";import"../Widget.js";import"../../chunks/uuid.js";import"../../chunks/jsxWidgetSupport.js";import"../Attachments.js";import"../Attachments/AttachmentsViewModel.js";import"../../rest/query/support/AttachmentInfo.js";import"../../rest/support/AttachmentQuery.js";import"../../chunks/messageBundle.js";import"../../chunks/jsxFactory.js";import"../Feature/FeatureViewModel.js";import"../../rest/support/Query.js";import"../../TimeExtent.js";import"../../chunks/timeUtils.js";import"../../chunks/DataLayerSource.js";import"../../layers/support/Field.js";import"../../chunks/domains.js";import"../../layers/support/CodedValueDomain.js";import"../../layers/support/Domain.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../chunks/fieldType.js";import"../../rest/support/StatisticDefinition.js";import"../../rest/support/RelationshipQuery.js";import"../../tasks/QueryTask.js";import"../../chunks/executeForTopCount.js";import"../../chunks/utils4.js";import"../../chunks/query.js";import"../../geometry/support/normalizeUtils.js";import"../../chunks/normalizeUtilsCommon.js";import"../../chunks/pbfQueryUtils.js";import"../../chunks/pbf.js";import"../../chunks/OptimizedFeature.js";import"../../chunks/OptimizedFeatureSet.js";import"../../chunks/queryZScale.js";import"../../chunks/zscale.js";import"../../chunks/featureConversionUtils.js";import"../../rest/support/FeatureSet.js";import"../../rest/support/TopFeaturesQuery.js";import"../../rest/support/TopFilter.js";import"../../chunks/executeQueryJSON.js";import"../../tasks/Task.js";import"../../layers/FeatureLayer.js";import"../../renderers/ClassBreaksRenderer.js";import"../../renderers/Renderer.js";import"../../renderers/support/AuthoringInfo.js";import"../../renderers/support/AuthoringInfoVisualVariable.js";import"../../chunks/colorRamps.js";import"../../rest/support/AlgorithmicColorRamp.js";import"../../rest/support/ColorRamp.js";import"../../rest/support/MultipartColorRamp.js";import"../../chunks/VisualVariablesMixin.js";import"../../renderers/visualVariables/ColorVariable.js";import"../../renderers/visualVariables/VisualVariable.js";import"../../chunks/LegendOptions.js";import"../../renderers/visualVariables/support/ColorStop.js";import"../../renderers/visualVariables/OpacityVariable.js";import"../../renderers/visualVariables/support/OpacityStop.js";import"../../renderers/visualVariables/RotationVariable.js";import"../../renderers/visualVariables/SizeVariable.js";import"../../renderers/visualVariables/support/SizeStop.js";import"../../chunks/sizeVariableUtils.js";import"../../chunks/visualVariableUtils.js";import"../../renderers/support/ClassBreakInfo.js";import"../../symbols/support/jsonUtils.js";import"../../chunks/symbolConversion.js";import"../../chunks/commonProperties.js";import"../../renderers/DictionaryRenderer.js";import"../../chunks/LRUCache.js";import"../../chunks/MemCache.js";import"../../renderers/DotDensityRenderer.js";import"../../renderers/support/AttributeColorInfo.js";import"../../renderers/HeatmapRenderer.js";import"../../renderers/support/HeatmapColorStop.js";import"../../renderers/SimpleRenderer.js";import"../../renderers/UniqueValueRenderer.js";import"../../chunks/diffUtils.js";import"../../renderers/support/UniqueValueInfo.js";import"../../chunks/styleUtils.js";import"../../chunks/devEnvironmentUtils.js";import"../../renderers/support/jsonUtils.js";import"../../chunks/MultiOriginJSONSupport.js";import"../../chunks/ReadOnlyMultiOriginJSONSupport.js";import"../../core/sql.js";import"../../form/FormTemplate.js";import"../../form/ExpressionInfo.js";import"../../form/elements/GroupElement.js";import"../../form/elements/FieldElement.js";import"../../form/elements/support/inputs.js";import"../../form/elements/inputs/BarcodeScannerInput.js";import"../../form/elements/inputs/TextInput.js";import"../../form/elements/inputs/Input.js";import"../../form/elements/inputs/ComboBoxInput.js";import"../../form/elements/inputs/DateTimePickerInput.js";import"../../form/elements/inputs/RadioButtonsInput.js";import"../../form/elements/inputs/SwitchInput.js";import"../../form/elements/inputs/TextAreaInput.js";import"../../form/elements/inputs/TextBoxInput.js";import"../../form/support/elements.js";import"../../geometry/HeightModelInfo.js";import"../../chunks/FeatureIndex.js";import"../../core/workers/workers.js";import"../../core/workers/Connection.js";import"../../core/workers/RemoteClient.js";import"../../chunks/shared.js";import"../../chunks/APIKeyMixin.js";import"../../chunks/ArcGISService.js";import"../../chunks/arcgisLayerUrl.js";import"../../chunks/CustomParametersMixin.js";import"../../chunks/OperationalLayer.js";import"../../chunks/commonProperties2.js";import"../../support/timeUtils.js";import"../../chunks/OrderedLayer.js";import"../../chunks/PortalLayer.js";import"../../chunks/asyncUtils.js";import"../../portal/PortalItem.js";import"../../portal/PortalItemResource.js";import"../../portal/PortalRating.js";import"../../chunks/RefreshableLayer.js";import"../../chunks/TemporalLayer.js";import"../../TimeInterval.js";import"../../layers/support/TimeInfo.js";import"../../chunks/featureReductionUtils.js";import"../../layers/support/FeatureReductionSelection.js";import"../../layers/support/FeatureReductionCluster.js";import"../../layers/support/LabelClass.js";import"../../chunks/labelUtils.js";import"../../chunks/defaults.js";import"../../chunks/defaultsJSON.js";import"../../layers/support/FeatureTemplate.js";import"../../layers/support/FeatureType.js";import"../../chunks/fieldProperties.js";import"../../layers/support/FieldsIndex.js";import"../../layers/support/GeometryFieldsInfo.js";import"../../chunks/labelingInfo.js";import"../../layers/support/LayerFloorInfo.js";import"../../layers/support/Relationship.js";import"../../chunks/styleUtils2.js";import"../../support/popupUtils.js";import"../../chunks/Heading.js";import"../support/widget.js";import"../../chunks/accessibleHandler.js";import"../../chunks/vmEvent.js";import"../Spinner/SpinnerViewModel.js";import"../../chunks/AnchorElementViewModel.js";import"../Popup/PopupViewModel.js";import"../../symbols/support/symbolUtils.js";import"../../chunks/utils2.js";import"../../chunks/ItemCache.js";import"../../symbols/support/cimSymbolUtils.js";import"../../chunks/utils3.js";import"../../chunks/layerViewUtils.js";import"../../chunks/actions.js";import"../../chunks/GoTo.js";import"../../chunks/Queue.js";import"../../geometry/support/geodesicUtils.js";import"../../chunks/geodesicConstants.js";import"../../views/interactive/snapping/FeatureSnappingLayerSource.js";function Te(e){switch(e){case 0:break;case 1:return"not owned by a graphics layer";case 2:return"no geometry";case 3:return"the geometry type is not supported";case 4:return"the elevation mode is not supported";case 5:return"the symbol type is not supported"}return""}function Ee(e){var t;if("graphics"!==(null==(t=e.layer)?void 0:t.type))return 1;if(i(e.geometry))return 2;switch(e.geometry.type){case"polygon":case"point":case"polyline":case"mesh":break;default:return 3}return"on-the-ground"!==P(e)&&H(e)?4:0}function xe(e){return Ce(e).result}function Ge(e){return Ce(e).geometry}function Ce(e){var t;if("graphics"!==(null==(t=e.layer)?void 0:t.type))return{result:1,geometry:null};if(i(e.geometry))return{result:2,geometry:null};return"on-the-ground"!==P(e)&&H(e)?{result:4,geometry:null}:"point"!==e.geometry.type&&"polyline"!==e.geometry.type&&("polygon"!==e.geometry.type||e.geometry instanceof A)?{result:3,geometry:null}:{result:0,geometry:e.geometry}}function Oe(e,t,o){if(!t||!e||!e.map)return;const{map:i}=e,r=i.layers.find((e=>e===t));r||i.add(t,o),null!=o&&i.layers.reorder(r,o)}class Ie{constructor(e){this.coordinateHelper=e}}class Pe extends Ie{constructor(e,t){super(e),this.point=t}objectEqual(e){return e instanceof Pe&&oe(this.point,e.point)}check(e){return z(e,this.point)<te.pointThreshold}closestTo(){return this.coordinateHelper.clone(this.point)}intersect(e){const t=[];return e instanceof He?t.push(...ue({start:e.start,end:e.end,type:e instanceof Me?1:0},this.point)):e instanceof Re&&t.push(...fe(e.center,e.radius,this.point)),t.map((t=>new Ve(this.coordinateHelper,t,this,e)))}}class He extends Ie{constructor(e,t,o){super(e),this.start=t,this.end=o}objectEqual(e){return e instanceof He&&(oe(this.start,e.start)&&oe(this.end,e.end))}intersect(e){const t=[];return e instanceof Pe?t.push(...ue({start:this.start,end:this.end,type:this instanceof Me?1:0},e.point)):e instanceof He?t.push(...me({start:this.start,end:this.end,type:this instanceof Me?1:0},{start:e.start,end:e.end,type:e instanceof Me?1:0})):e instanceof Re&&t.push(...ye({start:this.start,end:this.end,type:this instanceof Me?1:0},e.center,e.radius)),t.map((t=>new Ve(this.coordinateHelper,t,this,e)))}}class Ae extends He{constructor(e,t,o){super(e,t,o),this.dir=$(),this.p=$()}objectEqual(e){return e instanceof Ae&&super.objectEqual(e)}check(e){return D(this.dir,this.end,this.start),D(this.p,e,this.start),F(this.dir,this.p)>=0&&he(e,this.start,this.end)<te.pointOnLineThreshold}closestTo(e){const t=this.coordinateHelper.clone(e);return de(t,e,this.start,this.end),t}}class Me extends He{constructor(e,t,o){super(e,t,o)}objectEqual(e){return e instanceof Me&&super.objectEqual(e)}check(e){return he(e,this.start,this.end)<te.pointOnLineThreshold}closestTo(e){const t=this.coordinateHelper.clone(e);return ge(t,e,this.start,this.end),t}}class Ve extends Ie{constructor(e,t,o,i){super(e),this.intersection=t,this.first=o,this.second=i}objectEqual(e){return e instanceof Ve&&(this.first.objectEqual(e.first)&&this.second.objectEqual(e.second))}check(){return!1}closestTo(e){const t=this.coordinateHelper.clone(e);return q(t,this.intersection),t}intersect(){return[]}}class Re extends Ie{constructor(e,t,o){super(e),this.center=t,this.radius=o}objectEqual(e){return e instanceof Re&&(this.center[0]===e.center[0]&&this.center[1]===e.center[1]&&this.radius===e.radius)}check(){return!1}closestTo(e){const t=this.coordinateHelper.clone(e);return ve(t,e,this.center,this.radius),t}intersect(e){const t=[];return e instanceof He?t.push(...ye({start:e.start,end:e.end,type:e instanceof Me?1:0},this.center,this.radius)):e instanceof Pe&&t.push(...fe(this.center,this.radius,e.point)),t.map((t=>new Ve(this.coordinateHelper,t,this,e)))}}class Ue{constructor(e,t,o){this.coordinateHelper=e,this.targetPoint=t,this.constraint=o}}class Le extends Ue{constructor({coordinateHelper:e,targetPoint:t,objectId:o,constraint:i}){super(e,t,i),this.objectId=o}}class De extends Le{constructor(e){super({...e,constraint:new Me(e.coordinateHelper,e.edgeStart,e.edgeEnd)})}get hints(){return[new ie(1,this.constraint.start,this.constraint.end)]}}class Fe extends Ue{constructor({coordinateHelper:e,targetPoint:t,constraint:o,previousVertex:i,otherVertex:r,otherVertexType:s,objectId:n}){super(e,t,o),this.previousVertex=i,this.otherVertex=r,this.otherVertexType=s,this.objectId=n}get hints(){const e=this.previousVertex,t=1===this.otherVertexType?this.otherVertex:this.targetPoint,o=1===this.otherVertexType?this.targetPoint:this.otherVertex;return[new ie(0,t,o),new ie(1,e,t),new re(this.previousVertex,t,o)]}}let qe=class extends R{constructor(e){super(e),this.sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null}}}get updating(){return Y(this.snappingSources,(({snappingSource:e})=>e.updating))||this.updatingHandles.updating}get snappingSources(){var e;const t=this._get("snappingSources")||new Map,o=new Map;if(null!=(e=this.options)&&e.featureSources)for(const e of this.options.featureSources.items){const i=e.layer.uid,s=t.get(i);if(s){t.delete(i),o.set(i,s);continue}if(!e.layer.loaded){this.updatingHandles.addPromise(e.layer.load());continue}const n=this.createSourceInfo(e);r(n)&&o.set(i,n)}for(const[,e]of t)e.destroy();return o}initialize(){this.updatingHandles.add(this,"snappingSources",(()=>{this.notifyChange("updating")}),1),r(this.view)&&this.handles.add([this.view.on("layerview-create",(e=>this.updateLayerView(e.layer,e.layerView))),this.view.on("layerview-destroy",(e=>this.updateLayerView(e.layer,null)))])}updateLayerView(e,t){for(const[,o]of this.snappingSources)o.snappingSource.layerSource.layer===e&&(o.layerView=t)}destroy(){this._set("options",null);for(const[,e]of this.snappingSources)e.destroy()}async fetchCandidates(e,t,o){if(!this.options.effectiveFeatureEnabled)return[];const i=[],s=this.computeScreeenSizeDistanceParameters(e,t),n={distance:s,point:e,coordinateHelper:t.coordinateHelper,types:this.types,filter:null};for(const[,{snappingSource:e,layerView:s}]of this.snappingSources)!e.layerSource.enabled||r(s)&&s.suspended||i.push(e.fetchCandidates(n,o).then((o=>o.filter((o=>!this.candidateIsExcluded(e,o,t.excludeFeature))))));const a=(await u(i)).flat();return this.addRightAngleCandidates(a,e,s,t),m(o),se(e,a),a}addRightAngleCandidates(e,t,o,i){var n,a,p,l,c,h,d,u;const m=r(i.vertexHandle)?null==(n=i.vertexHandle.rightEdge)||null==(a=n.rightVertex)?void 0:a.pos:r(i.editGeometryOperations)&&"polygon"===i.editGeometryOperations.data.type?null==(p=s(null==(l=i.editGeometryOperations.data.components[0])?void 0:l.getFirstVertex()))?void 0:p.pos:null,y=r(i.vertexHandle)?null==(c=i.vertexHandle.leftEdge)||null==(h=c.leftVertex)?void 0:h.pos:r(i.editGeometryOperations)?null==(d=s(null==(u=i.editGeometryOperations.data.components[0])?void 0:u.getLastVertex()))?void 0:d.pos:null,g=e.length;for(let r=0;r<g;r++)this.addRightAngleCandidate(e[r],y,t,o,i,e),this.addRightAngleCandidate(e[r],m,t,o,i,e)}addRightAngleCandidate(e,t,o,r,s,n){if(i(t)||!(e instanceof De))return;const a=e.constraint.closestTo(t),p=(a[0]-o[0])/r.x,l=(a[1]-o[1])/r.y;if(p*p+l*l<=1){const o=s.coordinateHelper;n.push(new Fe({coordinateHelper:o,targetPoint:a,otherVertex:t,otherVertexType:0,previousVertex:e.constraint.start,constraint:new Ae(o,t,a),objectId:e.objectId}))}}computeScreeenSizeDistanceParameters(e,t){const o=this.options.distance*("touch"===t.pointer?this.options.touchSensitivityMultiplier:1);return i(this.view)?{x:o,y:o}:"2d"===this.view.type?{x:o*this.view.resolution,y:o*this.view.resolution}:this.computeScreeenSizeDistanceParameters3D(e,o,this.view,t)}computeScreeenSizeDistanceParameters3D(e,t,o,i){const{coordinateHelper:r,elevationInfo:s}=i,n=o.state.camera.computeScreenPixelSizeAt(ne(e,r,s,o,We))*o.renderCoordsHelper.unitInMeters/o.mapCoordsHelper.unitInMeters,a=t*n;return{x:a/this.computeScreenMagnitudeOfMapOffset(e,n,0,o,i),y:a/this.computeScreenMagnitudeOfMapOffset(e,0,n,o,i)}}computeScreenMagnitudeOfMapOffset(e,t,o,i,{coordinateHelper:r,elevationInfo:s}){const n=r.clone(e);n[0]+=t,n[1]+=o;const a=ae(e,r,s,i),p=ae(n,r,s,i),l=p.x-a.x,c=p.y-a.y;return Math.sqrt(l*l+c*c)}get types(){return 3}candidateIsExcluded(e,t,o){if(i(o))return!1;const r=this.getCandidateObjectId(t);if(i(r))return!1;const s=e.layerSource.layer;return"graphics"===s.type?o.uid===r:o.sourceLayer===s&&(!(!o.attributes||!("objectIdField"in s))&&o.attributes[s.objectIdField]===r)}getCandidateObjectId(e){return e instanceof Le?e.objectId:null}createSourceInfo(e){const t=this.createFeatureSnappingSourceType(e);if(i(t))return null;if("loading"in t)return this.updatingHandles.addPromise(t.loading.then((()=>{this.destroyed||this.notifyChange("snappingSources")}))),null;const o=r(this.view)?this.view.allLayerViews.find((t=>t.layer===e.layer)):null;return new ze(t.source,o)}createFeatureSnappingSourceType(e){switch(e.layer.type){case"feature":case"geojson":case"csv":case"subtype-group":case"wfs":return this.createFeatureSnappingSourceFeatureLayer(e);case"graphics":return this.createFeatureSnappingSourceGraphicsLayer(e)}return null}createFeatureSnappingSourceFeatureLayer(e){switch(e.layer.source.type){case"feature-layer":{const t=this.getSourceModule("featureService");return r(t.module)?{source:new t.module.FeatureServiceSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:e})}:{loading:t.loader}}case"memory":case"csv":case"geojson":case"wfs":{if("mesh"===e.layer.geometryType)return null;const t=this.getSourceModule("featureCollection");return r(t.module)?{source:new t.module.FeatureCollectionSnappingSource({layerSource:e})}:{loading:t.loader}}}return null}createFeatureSnappingSourceGraphicsLayer(e){const t=this.getSourceModule("graphics");return r(t.module)?{source:new t.module.GraphicsSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:e})}:{loading:t.loader}}getSourceModule(e){const t=this.sourceModules[e];if(i(t.loader)){const o=this.loadSourceModule(e).then((e=>{t.module=e}));return t.loader=o,{module:t.module,loader:o}}return{module:t.module,loader:t.loader}}loadSourceModule(e){switch(e){case"featureService":return this.updatingHandles.addPromise(import("../../chunks/FeatureServiceSnappingSource.js"));case"featureCollection":return this.updatingHandles.addPromise(import("../../chunks/FeatureCollectionSnappingSource.js"));case"graphics":return this.updatingHandles.addPromise(import("../../chunks/GraphicsSnappingSource.js"))}return null}};e([E({constructOnly:!0})],qe.prototype,"spatialReference",void 0),e([E({constructOnly:!0})],qe.prototype,"view",void 0),e([E()],qe.prototype,"options",void 0),e([E({readOnly:!0})],qe.prototype,"updating",null),e([E({readOnly:!0})],qe.prototype,"snappingSources",null),qe=e([x("esri.views.interactive.snapping.FeatureSnappingEngine")],qe);class ze{constructor(e,t){this.snappingSource=e,this.layerView=t,this.handles=new h;const o=this.snappingSource.layerSource.layer;if("refresh"in o){const t=o;this.handles.add(t.on("refresh",(()=>e.refresh())))}this.handles.add([w(e,"updating",(t=>e.layerSource.updating=t),!0),w(e,"availability",(t=>e.layerSource.availability=t),!0)])}destroy(){this.snappingSource.destroy(),this.handles.destroy()}}const We=J();class Ze{constructor(e,t){this.view=e,this.options=t,this.squaredShortLineThreshold=te.shortLineThreshold*te.shortLineThreshold}snap(e,t){return r(t.vertexHandle)?"vertex"!==t.vertexHandle.type?[]:this.snapExistingVertex(e,t):this.snapNewVertex(e,t)}edgeExceedsShortLineThreshold(e,t){return this.exceedsShortLineThreshold(e.leftVertex.pos,e.rightVertex.pos,t)}exceedsShortLineThreshold(e,t,{elevationInfo:o,editGeometryOperations:i}){const r=i.data.coordinateHelper;return 0===this.squaredShortLineThreshold||pe(ae(t,r,o,this.view),ae(e,r,o,this.view))>this.squaredShortLineThreshold}squaredProximityTreshold(e){return"touch"===e?this.squaredTouchProximityThreshold:this.squaredMouseProximityTreshold}get squaredMouseProximityTreshold(){return this.options.distance*this.options.distance}get squaredTouchProximityThreshold(){const{distance:e,touchSensitivityMultiplier:t}=this.options,o=e*t;return o*o}}class Ke extends Ue{constructor({coordinateHelper:e,lineStart:t,lineEnd:o,targetPoint:i}){super(e,i,new Me(e,t,o)),this.referenceLineHint=new ie(2,t,o)}get hints(){return[this.referenceLineHint,new ie(0,this.lineEndClosestToTarget(),this.targetPoint)]}lineEndClosestToTarget(){const e=this.constraint.start,t=this.constraint.end;return X(F(D(Ne,t,e),D(Be,this.targetPoint,e)))>0?t:e}}const Be=$(),Ne=$();class Qe extends Ze{snapNewVertex(e,t){const o=t.editGeometryOperations.data.components[0],i=o.edges.length,r=[];if(i<1)return r;const s=t.coordinateHelper,n=ae(e,s,t.elevationInfo,this.view),a=o.edges[i-1];let p=a;do{this.edgeExceedsShortLineThreshold(p,t)&&this._processCandidateProposal(p.leftVertex.pos,p.rightVertex.pos,e,n,t,r),p=p.leftVertex.leftEdge}while(p&&p!==a);return r}snapExistingVertex(e,t){const o=[],i=s(t.vertexHandle),r=i.component;if(r.edges.length<2)return o;const n=t.coordinateHelper,a=ae(e,n,t.elevationInfo,this.view),p=i.leftEdge,l=i.rightEdge;p&&l&&this.edgeExceedsShortLineThreshold(p,t)&&this.edgeExceedsShortLineThreshold(l,t)&&this._processCandidateProposal(p.leftVertex.pos,l.rightVertex.pos,e,a,t,o);const c=r.edges[0];let h=c;do{h!==i.leftEdge&&h!==i.rightEdge&&this.edgeExceedsShortLineThreshold(h,t)&&this._processCandidateProposal(h.leftVertex.pos,h.rightVertex.pos,e,a,t,o),h=h.rightVertex.rightEdge}while(h&&h!==c);return o}_processCandidateProposal(e,t,o,i,r,s){const n=ge($(),o,e,t),a=r.coordinateHelper,p=a.fromXYZ(n,a.getZ(o,0));pe(i,ae(p,a,r.elevationInfo,this.view))<this.squaredProximityTreshold(r.pointer)&&s.push(new Ke({coordinateHelper:r.coordinateHelper,lineStart:e,lineEnd:t,targetPoint:p}))}}class Ye extends Ue{constructor({coordinateHelper:e,referenceLine:t,lineStart:o,targetPoint:i}){const r=e.clone(o);D(r,W(r,r,t.rightVertex.pos),t.leftVertex.pos),super(e,i,new Me(e,o,r)),this._referenceLines=[{edge:t,fadeLeft:!0,fadeRight:!0}]}get hints(){return[new ie(0,this.constraint.start,this.targetPoint),new le(this.constraint.start,this.targetPoint),...this._referenceLines.map((e=>new ie(1,e.edge.leftVertex.pos,e.edge.rightVertex.pos,e.fadeLeft,e.fadeRight)))]}addReferenceLine(e){const t={edge:e,fadeLeft:!0,fadeRight:!0};this._referenceLines.forEach((o=>{e.rightVertex.rightEdge===o.edge&&(o.fadeLeft=!1,t.fadeRight=!1),e.leftVertex.leftEdge===o.edge&&(o.fadeRight=!1,t.fadeLeft=!1)})),this._referenceLines.push(t)}}class Je extends Ze{constructor(){super(...arguments),this._tmpProjection=$()}snapNewVertex(e,t){const o=t.editGeometryOperations.data.components[0],i=o.edges.length,r=o.vertices.length,s=[];if(i<2)return s;const n=ae(e,t.coordinateHelper,t.elevationInfo,this.view),a=o.vertices[r-1],p=o.vertices[0],l=o.edges[i-1];let c=l;do{this.edgeExceedsShortLineThreshold(c,t)&&(this._checkEdgeForParalleLines(c,a.pos,e,n,t,s),this._checkEdgeForParalleLines(c,p.pos,e,n,t,s)),c=c.leftVertex.leftEdge}while(c&&c!==l);return s}snapExistingVertex(e,t){const o=[],i=s(t.vertexHandle),r=i.component;if(r.edges.length<3)return o;const n=ae(e,t.coordinateHelper,t.elevationInfo,this.view),a=i.leftEdge,p=i.rightEdge,l=r.vertices[0],c=r.vertices.length,h=r.vertices[c-1],d=r.edges[0];let u=d;do{u!==a&&u!==p&&this.edgeExceedsShortLineThreshold(u,t)&&(a&&this._checkEdgeForParalleLines(u,a.leftVertex.pos,e,n,t,o),p&&this._checkEdgeForParalleLines(u,p.rightVertex.pos,e,n,t,o),i===l?this._checkEdgeForParalleLines(u,h.pos,e,n,t,o):i===h&&this._checkEdgeForParalleLines(u,l.pos,e,n,t,o)),u=u.rightVertex.rightEdge}while(u&&u!==d);return o}_checkEdgeForParalleLines(e,t,o,i,r,s){const n=e.leftVertex.pos,a=e.rightVertex.pos;if(ge(this._tmpProjection,t,n,a),z(this._tmpProjection,t)<te.parallelLineThreshold)return;ge(this._tmpProjection,o,n,a,t);const p=r.coordinateHelper,l=p.fromXYZ(this._tmpProjection,p.getZ(o,0));if(pe(i,ae(l,p,r.elevationInfo,this.view))<this.squaredProximityTreshold(r.pointer)){if(this.parallelToPreviousCandidate(e,s))return;s.push(new Ye({coordinateHelper:p,referenceLine:e,lineStart:t,targetPoint:l}))}}parallelToPreviousCandidate(e,t){const o=e.leftVertex.pos,i=e.rightVertex.pos;for(const r of t)if(ge(this._tmpProjection,i,r.constraint.start,r.constraint.end,o),z(this._tmpProjection,i)<te.parallelLineThreshold)return r.addReferenceLine(e),!0;return!1}}class Xe extends Ze{constructor(){super(...arguments),this._tmp=$()}snapNewVertex(e,t){const o=t.editGeometryOperations.data.components[0],i=o.vertices.length,r=[];if(i<2)return r;const s=ae(e,t.coordinateHelper,t.elevationInfo,this.view),n=o.vertices[i-1];this._checkForSnappingCandidate(r,n.leftEdge,n.pos,e,n.leftEdge.leftVertex.pos,n.pos,t,e,s);const a=o.vertices[0];return this._checkForSnappingCandidate(r,a.rightEdge,a.pos,e,a.rightEdge.rightVertex.pos,a.pos,t,e,s),r}snapExistingVertex(e,t){const o=[],i=s(t.vertexHandle),r=i.component,n=r.vertices.length;if(n<3)return o;const a=ae(e,t.coordinateHelper,t.elevationInfo,this.view),p=i.leftEdge,l=i.rightEdge,c=r.vertices[0],h=r.vertices[n-1];if(!p)return this._checkForSnappingCandidate(o,c.rightEdge.rightVertex.rightEdge,c.rightEdge.rightVertex.pos,e,c.rightEdge.rightVertex.rightEdge.rightVertex.pos,c.rightEdge.rightVertex.pos,t,e,a),o;if(!l)return this._checkForSnappingCandidate(o,h.leftEdge.leftVertex.leftEdge,h.leftEdge.leftVertex.pos,e,h.leftEdge.leftVertex.leftEdge.leftVertex.pos,h.leftEdge.leftVertex.pos,t,e,a),o;if(p&&p.leftVertex.leftEdge){const i=p.leftVertex.leftEdge;this._checkForSnappingCandidate(o,i,p.leftVertex.pos,e,i.leftVertex.pos,p.leftVertex.pos,t,e,a)}if(l&&l.rightVertex.rightEdge){const i=l.rightVertex.rightEdge;this._checkForSnappingCandidate(o,i,l.rightVertex.pos,e,i.rightVertex.pos,l.rightVertex.pos,t,e,a)}return o}_checkForSnappingCandidate(e,t,o,i,r,s,n,a,p){if(!this.edgeExceedsShortLineThreshold(t,n))return;D(this._tmp,t.rightVertex.pos,t.leftVertex.pos);const l=ee(this._tmp[1],-this._tmp[0]),c=F(l,D(this._tmp,i,o))/Z(l),h=n.coordinateHelper,d=h.fromXYZ(K($(),s,l,c),h.getZ(a,0));pe(p,ae(d,h,n.elevationInfo,this.view))<this.squaredProximityTreshold(n.pointer)&&e.push(new Fe({coordinateHelper:h,targetPoint:d,constraint:new Ae(h,s,K(h.createVector(),s,l,X(c))),previousVertex:r,otherVertex:s,otherVertexType:1}))}}class $e extends Ue{constructor({coordinateHelper:e,targetPoint:t,point1:o,point2:i}){super(e,t,new Re(e,B(et,o,i,.5),.5*N(o,i))),this.p1=o,this.p2=i}get hints(){return[new ie(1,this.targetPoint,this.p1),new ie(1,this.targetPoint,this.p2),new re(this.p1,this.targetPoint,this.p2)]}}const et=$();class tt extends Ze{snapNewVertex(e,t){const o=t.editGeometryOperations.data.components[0],i=[],r=o.vertices.length;if("polygon"!==t.editGeometryOperations.data.type||r<2)return i;const s=o.vertices[0],n=o.vertices[r-1];return this._processCandidateProposal(s.pos,n.pos,e,t,i),i}snapExistingVertex(e,t){const o=[],i=s(t.vertexHandle),r=i.component;return r.edges.length<2?o:"polyline"!==t.editGeometryOperations.data.type||0!==i.index&&i.index!==r.vertices.length-1?(this._processCandidateProposal(i.leftEdge.leftVertex.pos,i.rightEdge.rightVertex.pos,e,t,o),o):o}_processCandidateProposal(e,t,o,i,r){if(!this.exceedsShortLineThreshold(e,t,i))return;const s=B($(),e,t,.5),n=.5*N(e,t),a=ve($(),o,s,n),p=i.coordinateHelper,l=p.fromXYZ(a,p.getZ(o,0)),c=ae(o,p,i.elevationInfo,this.view);pe(c,ae(l,p,i.elevationInfo,this.view))<this.squaredProximityTreshold(i.pointer)&&r.push(new $e({coordinateHelper:p,targetPoint:l,point1:e,point2:t}))}}let ot=class extends U{constructor(e){super(e),this.updating=!1,this._snappers=new o}initialize(){this._snappers.push(new Je(this.view,this.options),new Qe(this.view,this.options),new Xe(this.view,this.options),new tt(this.view,this.options))}set options(e){this._set("options",e);for(const t of this._snappers)t.options=e}async fetchCandidates(e,t){if(!this.options.effectiveSelfEnabled)return[];const o=[];for(const i of this._snappers.items)o.push(...i.snap(e,t));return se(e,o),o}};e([E({readOnly:!0})],ot.prototype,"updating",void 0),e([E({constructOnly:!0})],ot.prototype,"view",void 0),e([E()],ot.prototype,"options",null),ot=e([x("esri.views.interactive.snapping.SelfSnappingEngine")],ot);class it extends Ue{constructor(e,t,o,i){super(e,t,new Ve(e,t,o.constraint,i.constraint)),this.first=o,this.second=i}get hints(){return this.first.targetPoint=this.targetPoint,this.second.targetPoint=this.targetPoint,[...this.first.hints,...this.second.hints,new ce(this.targetPoint)]}}let rt=class extends(c.EventedMixin(R)){constructor(e){super(e),this.options=new je,this.engines=[],this._currentMainCandidate=null,this._currentOtherActiveCandidates=[]}initialize(){this.handles.add([L((()=>{const{effectiveFeatureEnabled:e,effectiveSelfEnabled:t,touchSensitivityMultiplier:o,distance:i}=this.options;return{effectiveFeatureEnabled:e,effectiveSelfEnabled:t,touchSensitivityMultiplier:o,distance:i}}),(()=>{this.doneSnapping(),this.emit("changed")})),this.watch("options",(e=>{for(const t of this.engines)t.options=e}),!0),w(this.view,"ready",(e=>this.onViewReady(e)),!0)])}destroy(){this.destroyEngines()}get updating(){return this.engines.some((e=>e.updating))}onViewReady(e){var t,o;(this.destroyEngines(),e)&&(this.engines=[new ot({view:this.view,options:this.options}),new qe({view:this.view,spatialReference:null!=(t=null==(o=this.view)?void 0:o.spatialReference)?t:Q.WGS84,options:this.options})])}destroyEngines(){for(const e of this.engines)e.destroy();this.engines.length=0}get squaredMouseProximityTreshold(){return this.options.distance*this.options.distance}get squaredTouchProximityThreshold(){const{distance:e,touchSensitivityMultiplier:t}=this.options,o=e*t;return o*o}async snap(e,t,o){const i=t.coordinateHelper.pointToVector(e),s=await this.fetchCandidates(i,t,o);return{get valid(){return!y(o)},apply:()=>{const{snappedPoint:e,hints:o}=this.processCandidates(i,s,t);return this.removeVisualization(),r(t.visualizer)&&this.handles.add(t.visualizer.draw(o,{coordinateHelper:t.coordinateHelper,elevationInfo:t.elevationInfo,view:this.view}),st),e}}}update(e,t){this.removeVisualization();let o=e;const i=[];if(r(this._currentMainCandidate)){const r=t.coordinateHelper,s=r.pointToVector(e),n=this._currentMainCandidate.constraint.closestTo(s);if(pe(ae(s,r,t.elevationInfo,this.view),ae(n,r,t.elevationInfo,this.view))<this.squaredPointProximityThreshold(t.pointer)){o=r.vectorToDehydratedPoint(n),this._currentMainCandidate.targetPoint=n,i.push(...this._currentMainCandidate.hints);for(const e of this._currentOtherActiveCandidates)e.targetPoint=n,i.push(...e.hints)}else this._currentMainCandidate=null,this._currentOtherActiveCandidates=[]}return r(t.visualizer)&&this.handles.add(t.visualizer.draw(i,{coordinateHelper:t.coordinateHelper,elevationInfo:t.elevationInfo,view:this.view}),st),o}doneSnapping(){this.removeVisualization(),this._currentMainCandidate=null,this._currentOtherActiveCandidates=[]}removeVisualization(){this.handles.remove(st)}async fetchCandidates(e,t,o){return(await Promise.all(this.engines.map((i=>i.fetchCandidates(e,t,o))))).flat()}processCandidates(e,t,o){if(t.length<1)return this.doneSnapping(),{snappedPoint:o.coordinateHelper.vectorToDehydratedPoint(e),hints:[]};se(e,t);const i=this._currentMainCandidate;if(r(i)){const r=this.findOldConstraintInNewCandidates(i,t);if(r>=0){if(!(t[r]instanceof it))return this.intersectWithOtherCandidates(r,t,e,o);if(z(e,i.targetPoint)<this.squaredPointProximityThreshold(o.pointer))return this.updateSnappingCandidate(i,t,o)}}return this.intersectWithOtherCandidates(0,t,e,o)}findOldConstraintInNewCandidates(e,t){return e instanceof it?this.findOldCandidateIndex(t,e.first)>=0&&this.findOldCandidateIndex(t,e.second)>=0?0:-1:this.findOldCandidateIndex(t,e)}intersectWithOtherCandidates(e,t,o,i){const r=t[e],s=[],n=i.coordinateHelper;for(let a=0;a<t.length;++a){if(a===e)continue;const p=t[a];for(const e of r.constraint.intersect(p.constraint)){const t=n.fromXYZ(e.intersection,r.targetPoint[2]);s.push([new it(n,t,r,p),pe(ae(o,i.coordinateHelper,i.elevationInfo,this.view),ae(t,i.coordinateHelper,i.elevationInfo,this.view))])}}return s.length>0&&(s.sort(((e,t)=>e[1]-t[1])),s[0][1]<this.squaredPointProximityThreshold(i.pointer))?this.updateSnappingCandidate(s[0][0],t,i):this.updateSnappingCandidate(r,t,i)}updateSnappingCandidate(e,t,o){this.doneSnapping(),this._currentMainCandidate=e;const i=this._currentMainCandidate.targetPoint,r=[];r.push(...e.hints);for(const o of t){if(e instanceof it){if(o.constraint.objectEqual(e.first.constraint)||o.constraint.objectEqual(e.second.constraint))continue}else if(o.constraint.objectEqual(e.constraint))continue;o.constraint.check(i)&&(o.targetPoint=i,this._currentOtherActiveCandidates.push(o),r.push(...o.hints))}return{snappedPoint:o.coordinateHelper.vectorToDehydratedPoint(i),hints:r}}squaredPointProximityThreshold(e){return"touch"===e?this.squaredTouchProximityThreshold:this.squaredMouseProximityTreshold}findOldCandidateIndex(e,t){let o=-1;for(let i=0;i<e.length;++i)if(t.constraint.objectEqual(e[i].constraint)){o=i;break}return o}get test(){return{visualizationsActive:this.handles.has(st),engines:this.engines}}};e([E({constructOnly:!0})],rt.prototype,"view",void 0),e([E()],rt.prototype,"options",void 0),e([E({readOnly:!0})],rt.prototype,"updating",null),e([E()],rt.prototype,"engines",void 0),e([E()],rt.prototype,"squaredMouseProximityTreshold",null),e([E()],rt.prototype,"squaredTouchProximityThreshold",null),rt=e([x("esri.views.interactive.snapping.SnappingManager")],rt);const st="visualization-handle";let nt=class extends c.EventedAccessor{constructor(e){super(e),this.cancelled=!1,this.history={undo:[],redo:[]},this.type=null}get tool(){if(!this.activeComponent)return null;switch(this.activeComponent.type){case"graphic-mover":case"move-3d":return"move";case"box":case"transform-3d":return"transform";case"reshape":case"reshape-3d":return"reshape";case"draw-2d":case"draw-3d":return this.activeComponent.geometryType;default:be(this.activeComponent)}return null}addToHistory(e){this.history.redo=[],this.history.undo.push(e)}resetHistory(){this.history.redo=[],this.history.undo=[]}canUndo(){return this.history.undo.length>0}canRedo(){return this.history.redo.length>0}complete(){this.reset(),this.onEnd(),this.emit("complete")}cancel(){this.cancelled=!0,this.complete()}reset(){this.activeComponent.reset()}refreshComponent(){const e=this.activeComponent;e&&("box"!==e.type&&"reshape"!==e.type&&"graphic-mover"!==e.type||e.refresh())}set undo(e){this._set("undo",(()=>{this.canUndo()&&e()}))}set redo(e){this._set("redo",(()=>{this.canRedo()&&e()}))}};e([E()],nt.prototype,"activeComponent",void 0),e([E()],nt.prototype,"cancelled",void 0),e([E()],nt.prototype,"history",void 0),e([E()],nt.prototype,"tool",null),e([E()],nt.prototype,"type",void 0),e([E()],nt.prototype,"canUndo",null),e([E()],nt.prototype,"canRedo",null),e([E()],nt.prototype,"onEnd",void 0),e([E()],nt.prototype,"undo",null),e([E()],nt.prototype,"redo",null),e([E()],nt.prototype,"toggleTool",void 0),e([E()],nt.prototype,"addToSelection",void 0),e([E()],nt.prototype,"removeFromSelection",void 0),nt=e([x("esri.widgets.Sketch.support.OperationHandle")],nt);let at=class extends nt{};e([E()],at.prototype,"activeComponent",void 0),at=e([x("esri.widgets.Sketch.support.CreateOperationHandle")],at);let pt=class extends nt{constructor(e){super(e)}};e([E()],pt.prototype,"activeComponent",void 0),pt=e([x("esri.widgets.Sketch.support.UpdateOperationHandle")],pt);const lt=d.getLogger("esri.widgets.Sketch.SketchViewModel"),ct={defaultZ:0},ht={reshapeOptions:{edgeOperation:"split",shapeOperation:"move",vertexOperation:"move"},enableMoveAllGraphics:!0,enableRotation:!0,enableScaling:!0,multipleSelectionEnabled:!0,preserveAspectRatio:!1,toggleToolOnClick:!0,enableZ:!0,tool:"transform"};let dt=class extends c.EventedAccessor{constructor(e){super(e),this._numUpdating=0,this._handles=new h,this._internalGraphicsLayer=new O({listMode:"hide",internal:!0,title:"SVM Internal"}),this._operationHandle=null,this._viewHandles=new h,this.activeFillSymbol=null,this.activeLineSymbol=null,this.activeVertexSymbol=null,this.allowDeleteKey=!0,this.layer=null,this.pointSymbol=new _e({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),this.polygonSymbol=new Se({color:[150,150,150,.2],outline:{color:[50,50,50],width:2}}),this.polylineSymbol=new ke({color:[130,130,130,1],width:2}),this._snappingManager=null,this.updateGraphics=new o,this.updateOnGraphicClick=!0,this.updatePointSymbol=new _e({size:10,color:[0,200,255,.5],outline:{color:"black",width:1}}),this.updatePolygonSymbol=new Se({color:[12,207,255,.2],outline:{join:"round",color:[12,207,255],width:2}}),this.updatePolylineSymbol=new ke({color:[12,207,255],width:2}),this.vertexSymbol=new _e({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),this._moduleLoaderAbortController=null,this._viewReadyAbortController=null,this._originalAutoOpenEnabled=null,this.defaultCreateOptions=ct,this.defaultUpdateOptions=ht,this.snappingOptions=new je}initialize(){this._handles.add([b(this,"layer",(()=>{this.cancel(),this._internalGraphicsLayer.elevationInfo=r(this.layer)?this.layer.elevationInfo:null})),_(this,"view.map.layers","change",(e=>{e.removed.includes(this.layer)&&this.cancel()})),_(this,"layer.graphics","change",(e=>{if(r(this._operationHandle))for(const t of e.removed)this.updateGraphics.includes(t)&&(this.updateGraphics.length>1?this._operationHandle.removeFromSelection(t):this._operationHandle.cancel())})),w(this,"layer.elevationInfo",(()=>{this.cancel(),this._internalGraphicsLayer.elevationInfo=r(this.layer)?this.layer.elevationInfo:null}),!0),w(this,"view",(e=>{n(this._snappingManager),e&&(this._snappingManager=new rt({view:e,options:this.snappingOptions}),"2d"===e.type?import("../../chunks/editingTools.js"):"3d"===e.type&&(import("../../chunks/editingTools2.js"),import("../../chunks/GraphicsLayerView3D.js")))}),!0)])}destroy(){this.cancel(),this._handles=n(this._handles),this._viewHandles=n(this._viewHandles),this._removeDefaultLayer(),this._snappingManager=n(this._snappingManager),this._set("view",null),this.emit("destroy")}get _defaultUpdateTool(){return"3d"===this.view.type?"move":"transform"}get updating(){return this._numUpdating>0}get activeTool(){return this._operationHandle&&this._operationHandle.tool?this._operationHandle.tool:null}get activeComponent(){return this._operationHandle?this._operationHandle.activeComponent:null}get createGraphic(){return!r(this.activeComponent)||"draw-3d"!==this.activeComponent.type&&"draw-2d"!==this.activeComponent.type?this._get("createGraphic"):s(this.activeComponent.graphic)}set defaultCreateOptions(e){this._set("defaultCreateOptions",{...ct,...e})}set defaultUpdateOptions(e){this._set("defaultUpdateOptions",{...ht,...e,reshapeOptions:{...ht.reshapeOptions,...null==e?void 0:e.reshapeOptions}})}set snappingOptions(e){r(this._snappingManager)&&(this._snappingManager.options=e),this._set("snappingOptions",e)}get state(){var e;const t=!(null==(e=this.view)||!e.ready||!this.layer),o=this._operationHandle;return t&&o?"active":t?"ready":"disabled"}get view(){return this._get("view")}set view(e){const t=this._get("view");if(t){const{container:e,map:o}=t;e&&(t.cursor=null),o&&o.remove(this._internalGraphicsLayer),this._viewHandles.removeAll(),this.cancel()}const o="view-ready";this._handles.remove(o),e&&this._handles.add(S(e,"ready",(t=>{this._viewHandles.removeAll(),t&&this._viewHandles.add(this._generateViewHandles(e))}),!0),o),this._set("view",e)}cancel(){this._moduleLoaderAbortController=a(this._moduleLoaderAbortController),this._viewReadyAbortController=a(this._viewReadyAbortController),this._operationHandle&&this._operationHandle.cancel()}complete(){this._operationHandle&&this._operationHandle.complete()}delete(){const{state:e,updateGraphics:t}=this;if("active"===e&&t.length){const{activeTool:e,layer:o}=this,i=t.toArray();o.removeMany(i),this.cancel(),this._emitDeleteEvent({graphics:i,tool:e})}}async create(e,t){if(await this._waitViewReady(),"disabled"===this.state)throw this.layer||this._logError("sketch:missing-property","Property 'layer' is missing on SketchViewModel."),this.view||this._logError("sketch:missing-property","Property 'view' is missing on SketchViewModel."),g();if(this.cancel(),r(this.view.activeTool)&&(this.view.activeTool=null),!e)return void this._logError("sketch:missing-parameter","Missing parameter 'tool'.");Oe(this.view,this._internalGraphicsLayer);const o=await this._setupCreateOperation(e,t);if(i(o)||this.destroyed)return void this.view.map.remove(this._internalGraphicsLayer);o.on("complete",(()=>{if(o===this._operationHandle){const t=this.createGraphic,i=this._operationHandle.cancelled;this._operationHandle.destroy(),this._operationHandle=null,this._set("createGraphic",null),this.view&&this.view.map&&this.view.map.remove(this._internalGraphicsLayer),o.cancelled||null==t||this.layer.add(t),this.emit("create",{graphic:t,state:i?"cancel":"complete",tool:e,toolEventInfo:null,type:"create"})}})),this._operationHandle=o,this.view.ready&&I(this.view)&&this.view.focus()}async update(e,t){await this._waitViewReady();const{layer:o,view:s,state:n}=this;if("disabled"===n)throw s||this._logError("sketch:missing-property","Property 'view' is missing on SketchViewModel."),o||this._logError("sketch:missing-property","Property 'layer' is missing on SketchViewModel."),g();this.cancel(),r(this.view.activeTool)&&(this.view.activeTool=null);const a=Array.isArray(e)?e:[e];if(null==e||!a||!a.length)return void this._logError("sketch:missing-parameter","Missing parameter 'graphics'.");if(a.some((e=>e.layer!==o?(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics missing from the supplied GraphicsLayer."),!0):i(e.geometry)?(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with an unsupported geometry."),!0):"2d"===s.type&&!s.spatialReference.equals(e.geometry.spatialReference)&&(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with a spatial reference different from the supplied MapView."),!0))))return;const p=await this._setupUpdateOperation(a,t);this.destroyed||i(p)||ft(p)||(Oe(this.view,this._internalGraphicsLayer),this._setUpdateOperationHandle(p,t),this.emit("update",{graphics:a,state:"start",aborted:!1,tool:p.tool,toolEventInfo:null,type:"update"}))}undo(){this.canUndo()&&this._operationHandle.undo()}redo(){this.canRedo()&&this._operationHandle.redo()}canUndo(){return!(!this._operationHandle||!this._operationHandle.canUndo())}canRedo(){return!(!this._operationHandle||!this._operationHandle.canRedo())}toggleUpdateTool(){this._operationHandle&&this._operationHandle.toggleTool&&this._operationHandle.toggleTool()}async _getFirstHit(e){const t=[];switch(this.view.type){case"2d":{const r=await this.view.hitTest(e);if(r.results.length>0){const e=r.results[0];if(e.graphic){var o,i;const r=e.graphic;"vector-tile"!==(null==(o=r.layer)?void 0:o.type)&&"imagery"!==(null==(i=r.layer)?void 0:i.type)&&t.push(e)}}}break;case"3d":{const o=[this.view.map.ground];this.view.map.allLayers.forEach((e=>{"integrated-mesh"===e.type&&o.push(e)}));const i=await this.view.hitTest(e,{exclude:o});if(i.results.length>0){const e=i.results[0];(!i.ground.mapPoint||this.view.map.ground.opacity<1||i.ground.distance-e.distance>-Math.min(3*i.ground.distance,"global"===this.view.viewingMode?G(this.view.renderCoordsHelper.spatialReference).radius/this.view.renderCoordsHelper.unitInMeters:Number.POSITIVE_INFINITY))&&t.push(e)}}}return{screenPoint:e,results:t}}_generateViewHandles(e){return[e.on("immediate-click",(async t=>{const o="active"===this.state&&"create"===this._operationHandle.type;if("disabled"===this.state||o||!this.updateOnGraphicClick)return;this._beginAsyncOperation();const i=(await t.async((()=>this._getFirstHit(we(t))))).results;let s=null;if(i.length){for(const o of i)if(o.graphic){const i=o.graphic;if(this.updateGraphics.includes(i)||i.layer===this.layer){t.stopPropagation(),s=i;break}"2d"!==e.type||this._isComponentGraphic(i)||"active"!==this.state||this.cancel()}}else"active"===this.state&&this.cancel();r(s)&&!this.updateGraphics.includes(s)&&await this.update([s],{...this.defaultUpdateOptions,reshapeOptions:{...this.defaultUpdateOptions.reshapeOptions}}),this._endAsyncOperation()}),M.WIDGET)]}async _setupCreateOperation(e,t){const o={hasZ:"3d"===this.view.type,...this.defaultCreateOptions,...t},r=await this._setupDrawGraphicTool(e,this.view,o);return i(r)?null:(this.view.tools.add(r),this.view.activeTool=r,this._setupCreateOperationHandle(r))}async _setupDrawGraphicTool(e,t,o){if("multipoint"===e&&"3d"===t.type)return this._logError("sketch:create","Multipoint geometries are not supported in SceneView"),null;const i="rectangle"!==e,r="rectangle"!==e;this.snappingOptions.enabledToggled=!1;const s={view:t,mode:"rectangle"===e||"circle"===e?"hybrid":"click",...o,snapToScene:!1,geometryType:e,graphicSymbol:this._getGraphicSymbolFromTool(e),snappingManager:this._snappingManager,forceUniformSize:r,centered:i};return"2d"===this.view.type?this._makeDrawGraphicTool2D(s):this._makeDrawGraphicTool3D(s)}async _makeDrawGraphicTool2D(e){const t=await this._requireModule(import("../../chunks/editingTools.js"));return ft(t)||this.destroyed?null:new t.module.DrawGraphicTool2D({...e,activeVertexSymbol:this.activeVertexSymbol,regularVerticesSymbol:this.vertexSymbol,activeLineSymbol:this.activeLineSymbol,activeFillSymbol:ut(e.geometryType)?this.activeFillSymbol:null})}async _makeDrawGraphicTool3D(e){const t=await this._requireModule(import("../../chunks/editingTools2.js"));return ft(t)||this.destroyed?null:new t.module.DrawGraphicTool3D({...e,elevationInfo:this.layer.elevationInfo,snapToScene:!r(this.layer.elevationInfo)||"absolute-height"===this.layer.elevationInfo.mode})}_setupCreateOperationHandle(e){let t=null;const o=e.forceUniformSize,r=e.centered,n=[this.view.on("key-down",(t=>{if(t.key===V.pan)t.stopPropagation(),t.repeat||(e.enabled=!1);else if(t.key===V.complete)t.stopPropagation(),e.completeCreateOperation();else if(t.key!==V.vertexAdd||t.repeat)t.key===V.undo?(t.stopPropagation(),a.undo()):t.key===V.redo?(t.stopPropagation(),a.redo()):t.key!==V.snappingToggle||"rectangle"===e.geometryType||"circle"===e.geometryType||t.repeat?t.key!==V.constraint||"rectangle"!==e.geometryType&&"circle"!==e.geometryType||t.repeat?t.key===V.center&&(t.repeat||(e.centered=!r,t.stopPropagation())):(e.forceUniformSize=!o,t.stopPropagation()):(this.snappingOptions.enabledToggled=!0,t.stopPropagation());else{const o=e.drawOperation.geometryType;"polyline"!==o&&"polygon"!==o&&"multipoint"!==o||(t.stopPropagation(),e.drawOperation.commitStagedVertex())}}),M.WIDGET),this.view.on("key-up",(t=>{t.key===V.pan?e.enabled=!0:t.key===V.snappingToggle&&"rectangle"!==e.geometryType&&"circle"!==e.geometryType?(this.snappingOptions.enabledToggled=!1,t.stopPropagation()):t.key!==V.constraint||"rectangle"!==e.geometryType&&"circle"!==e.geometryType?t.key===V.center&&(e.centered=r,t.stopPropagation()):(e.forceUniformSize=o,t.stopPropagation())}),M.WIDGET),e.on("vertex-add",(o=>{switch(t=i(t)?"start":"active",o.operation){case"apply":this.emit("create",{graphic:s(e.graphic),state:t,tool:this.activeTool,toolEventInfo:o,type:"create"});break;case"undo":this._emitUndoEvent({graphics:[s(e.graphic)],tool:e.geometryType});break;case"redo":this._emitRedoEvent({graphics:[s(e.graphic)],tool:e.geometryType})}})),e.on("cursor-update",(t=>{e.drawOperation.numCommittedVertices>0&&this.emit("create",{graphic:s(e.graphic),state:"active",tool:this.activeTool,toolEventInfo:{coordinates:t.vertices[0].coordinates,type:"cursor-update"},type:"create"})})),e.on("vertex-remove",(t=>{switch(t.operation){case"apply":this.emit("create",{graphic:s(e.graphic),state:"active",tool:this.activeTool,toolEventInfo:t,type:"create"});break;case"undo":this._emitUndoEvent({graphics:[s(e.graphic)],tool:e.geometryType});break;case"redo":this._emitRedoEvent({graphics:[s(e.graphic)],tool:e.geometryType})}})),e.on("complete",(e=>{this._set("createGraphic",s(e.graphic)),t="complete",e.aborted?a&&a.cancel():a&&a.complete()})),j((()=>this._getGraphicSymbolFromTool(e.geometryType)),(t=>{e.graphicSymbol=t}))],a=new nt({activeComponent:e,tool:e.geometryType,type:"update",onEnd:()=>{var t;n.forEach((e=>e.remove())),n.length=0,null==(t=this.view.tools)||t.remove(e),e.destroy()},undo:()=>{e.canUndo&&e.undo()},redo:()=>{e.canRedo&&e.redo()},canUndo:()=>e.canUndo,canRedo:()=>e.canRedo});return a}_getGraphicSymbolFromTool(e){switch(e){case"point":case"multipoint":return this.pointSymbol;case"polyline":return this.polylineSymbol;case"circle":case"rectangle":case"polygon":return this.polygonSymbol;default:return null}}async _setupUpdateOperation(e,t){const{layer:o,view:i}=this,r={tool:this._defaultUpdateTool,...this.defaultUpdateOptions,...t,reshapeOptions:{...this.defaultUpdateOptions.reshapeOptions,...null==t?void 0:t.reshapeOptions}};let s=r.tool;for(const t of e)o.remove(t),o.add(t);if("3d"===i.type){if(0===e.length)return null;switch(s){case"move":return this._setupMove3DOperation(e,r,i,s);case"reshape":{if(e.length>1)return this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),null;const t=xe(e[0]);return 0===t?this._setupReshape3DOperation(e[0],r,i):(this._logError("sketch:reshape",`Reshape operation not supported for provided graphic(s) (${Te(t)}).`),null)}case"transform":return this._setupGraphicTransform3DOperation(e,r,i)}}switch(s){case"move":return this._setupMoveOperation(e,r,i);case"reshape":{if(e.length>1)return this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),null;const t=xe(e[0]);return 0===t?this._setupTransformOrReshapeOperation(e,s,r,i):(this._logError("sketch:reshape",`Reshape operation not supported for provided graphic(s) (${Te(t)}).`),null)}case"transform":if(1===e.length){const t=p(e[0].geometry,"type");"point"!==t&&"multipoint"!==t||(s="reshape")}return this._setupTransformOrReshapeOperation(e,s,r,i)}}async _setupMove3DOperation(e,t,o,i,r=!1){for(const t of e){const e=Ee(t);if(0!==e)return this._logError("sketch:move",`Move operation not supported for provided graphic(s) (${Te(e)}).`),null}const s=await this._requireModule(import("../../chunks/editingTools2.js"));if(ft(s))return s;const n=new s.module.GraphicMoveTool({view:o,enableZ:t.enableZ,snappingManager:this._snappingManager});this.view.tools.add(n),n.graphics.addMany(e),r||this.updateGraphics.addMany(e);const a=[],p=new pt({activeComponent:n,tool:i,type:"update",onEnd:()=>{var e;a.forEach((e=>e.remove())),a.length=0,null==(e=this.view.tools)||e.remove(n),n.destroyed||n.destroy()},undo:()=>{mt(p,this.updateGraphics.toArray()),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:i})},redo:()=>{yt(p,this.updateGraphics.toArray()),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:i})},addToSelection:e=>{this.updateGraphics.push(e),n.graphics.push(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:e=>{const t=this.updateGraphics.indexOf(e);p.history.undo.forEach((e=>e.updates.splice(t,1))),p.history.redo.forEach((e=>e.updates.splice(t,1))),this.updateGraphics.remove(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),0!==this.updateGraphics.length?n.graphics.remove(e):p.complete()},toggleTool:async()=>{if(1!==this.updateGraphics.length||!1===t.toggleToolOnClick)return;if("transform"!==i)return;const e=this.updateGraphics.getItemAt(0);if(0!==xe(e))return;const r=await this._setupReshape3DOperation(e,t,o,!0);ft(r)||(p.onEnd(),p.destroy(),this._setUpdateOperationHandle(r,t))}});return a.push(...this._getHandlesForComponent(p,t),this.view.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(p,e,t)),M.WIDGET),o.on("key-down",(e=>{this._getCommonUpdateOperationKeyDownHandlers(p,e),e.key===V.snappingToggle&&(this.snappingOptions.enabledToggled=!0,e.stopPropagation())}),M.WIDGET),o.on("key-up",(e=>{e.key===V.snappingToggle&&(this.snappingOptions.enabledToggled=!1,e.stopPropagation())}),M.WIDGET)),p}_setupGraphicTransform3DOperation(e,t,o,s=!1){if(1===e.length&&0===function(e){var t;if("graphics"!==(null==(t=e.layer)?void 0:t.type))return 1;if(i(e.geometry))return 2;switch(e.geometry.type){case"point":break;case"polygon":case"polyline":case"multipoint":case"extent":case"mesh":return 0;default:return 3}const o=r(e.symbol)&&"point-3d"===e.symbol.type&&e.symbol.symbolLayers;return o&&o.length>0&&o.some((e=>"object"===e.type))?"on-the-ground"!==P(e)&&H(e)?4:0:5}(e[0])){const i=e[0],n=i.geometry;if(r(n)&&("point"===n.type||"mesh"===n.type))return this._setupPointTransform3DOperation(i,t,o);if(r(n)&&("polygon"===n.type||"polyline"===n.type))return this._setupPolyTransform3DOperation(i,t,o,s)}return this._setupMove3DOperation(e,t,o,"transform",s)}async _setupPointTransform3DOperation(e,t,o){const i="transform",{enableRotation:r,enableScaling:s,enableZ:n}=t,a=await this._requireModule(import("../../chunks/editingTools2.js"));if(ft(a))return a;const p=new a.module.GraphicTransformTool({graphic:e,view:o,enableRotation:r,enableScaling:s,enableZ:n,snappingManager:this._snappingManager});this.view.tools.add(p),this.updateGraphics.add(e);const l=[],c=new pt({activeComponent:p,tool:i,type:"update",onEnd:()=>{var e;l.forEach((e=>e.remove())),l.length=0,null==(e=this.view.tools)||e.remove(p),p.destroyed||p.destroy()},undo:()=>{mt(c,this.updateGraphics.toArray()),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:i})},redo:()=>{yt(c,this.updateGraphics.toArray()),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:i})},addToSelection:async e=>{this.updateGraphics.add(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"});const i=await this._setupMove3DOperation(this.updateGraphics.toArray(),t,o,"transform",!0);ft(i)||(c.onEnd(),c.destroy(),this._setUpdateOperationHandle(i,t))},removeFromSelection:e=>{this.updateGraphics.remove(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),c.complete()},toggleTool:()=>{}});return l.push(...this._getHandlesForComponent(c,t),this.view.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(c,e,t)),M.WIDGET),o.on("key-down",(e=>{this._getCommonUpdateOperationKeyDownHandlers(c,e),e.key===V.snappingToggle&&(this.snappingOptions.enabledToggled=!0,e.stopPropagation())}),M.WIDGET),o.on("key-up",(e=>{e.key===V.snappingToggle&&(this.snappingOptions.enabledToggled=!1,e.stopPropagation())}),M.WIDGET)),c}async _setupPolyTransform3DOperation(e,t,o,i=!1){const r="transform",{enableRotation:s,enableScaling:n,enableZ:a,preserveAspectRatio:p}=t,l=await this._requireModule(import("../../chunks/editingTools2.js"));if(ft(l))return l;const c=new l.module.ExtentTransformTool({graphic:e,view:o,enableRotation:s,enableScaling:n,enableZ:a,preserveAspectRatio:p});this.view.tools.add(c),i||this.updateGraphics.add(e);const h=[],d=new pt({activeComponent:c,tool:r,type:"update",onEnd:()=>{var e;h.forEach((e=>e.remove())),h.length=0,null==(e=this.view.tools)||e.remove(c),c.destroyed||c.destroy()},canUndo:()=>c.canUndo,undo:()=>{c.undo(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:r})},canRedo:()=>c.canRedo,redo:()=>{c.redo(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:r})},addToSelection:async e=>{this.updateGraphics.add(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"});const i=await this._setupMove3DOperation(this.updateGraphics.toArray(),t,o,"transform",!0);ft(i)||(d.onEnd(),d.destroy(),this._setUpdateOperationHandle(i,t))},removeFromSelection:e=>{this.updateGraphics.remove(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),d.complete()},toggleTool:async()=>{if(1!==this.updateGraphics.length||!1===t.toggleToolOnClick)return;const e=this.updateGraphics.getItemAt(0);if(0!==xe(e))return;const i=await this._setupReshape3DOperation(e,t,o,!0);ft(i)||(d.onEnd(),d.destroy(),this._setUpdateOperationHandle(i,t))}});return h.push(...this._getHandlesForComponent(d,t),this.view.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(d,e,t)),M.WIDGET),this.view.on("key-down",(e=>this._getCommonUpdateOperationKeyDownHandlers(d,e)),M.WIDGET),this.view.on("key-down",(e=>{e.key!==V.constraint||e.repeat||(c.preserveAspectRatio=!c.preserveAspectRatio,e.stopPropagation())}),M.WIDGET),this.view.on("key-up",(e=>{e.key===V.constraint&&(c.preserveAspectRatio=!c.preserveAspectRatio,e.stopPropagation())}),M.WIDGET)),d}async _setupMoveOperation(e,t,o){const i="move";this.updateGraphics.addMany(e);const r=await this._getGraphicMover(e,t,o);if(ft(r))return r;const s=new pt({activeComponent:r,tool:i,type:"update",onEnd:()=>{var e;this._displayDefaultCursor(),p.forEach((e=>e.remove())),a.forEach((e=>e.remove())),p=[],a=[],r.destroy(),null==(e=this._internalGraphicsLayer)||e.removeMany([...this.updateGraphics.toArray()])},undo:()=>{const e=this.updateGraphics.toArray();mt(s,e),s.refreshComponent(),this._emitUndoEvent({graphics:e,tool:i})},redo:()=>{const e=this.updateGraphics.toArray();yt(s,e),s.refreshComponent(),this._emitRedoEvent({graphics:e,tool:i})},addToSelection:e=>{this.updateGraphics.push(e),r.graphics=this.updateGraphics.toArray(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:e=>{const t=this.updateGraphics.indexOf(e);s.history.undo.forEach((e=>e.updates.splice(t,1))),s.history.redo.forEach((e=>e.updates.splice(t,1))),this.updateGraphics.remove(e);const o=this.updateGraphics.toArray();this.emit("update",{graphics:o,state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),0!==this.updateGraphics.length?r.graphics=o:s.complete()}});let n=!1,a=[o.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(s,e,t)),M.WIDGET),o.on("key-down",(e=>{this._getCommonUpdateOperationKeyDownHandlers(s,e),e.key!==V.constraint||e.repeat||(n=!0,r.enableMoveAllGraphics=!r.enableMoveAllGraphics)}),M.WIDGET),o.on("key-up",(e=>{e.key===V.constraint&&n&&(n=!1,r.enableMoveAllGraphics=!r.enableMoveAllGraphics)}),M.WIDGET)],p=this._getHandlesForComponent(s,t);return s}async _setupReshape3DOperation(e,t,o,i=!1){const r="reshape",s=await this._requireModule(import("../../chunks/editingTools2.js"));if(ft(s))return s;this.snappingOptions.enabledToggled=!1;const n=new s.module.GraphicReshapeTool({view:o,graphic:e,enableZVertex:t.enableZ&&"move"===t.reshapeOptions.vertexOperation,enableZShape:t.enableZ&&"move"===t.reshapeOptions.shapeOperation,enableMoveGraphic:"move"===t.reshapeOptions.shapeOperation||"move-xy"===t.reshapeOptions.shapeOperation,enableMidpoints:"split"===t.reshapeOptions.edgeOperation,enableEdgeOffset:"offset"===t.reshapeOptions.edgeOperation,snappingManager:this._snappingManager});o.tools.add(n),i||this.updateGraphics.add(e);const a=[],p=new pt({activeComponent:n,tool:r,type:"update",onEnd:()=>{var e;a.forEach((e=>e.remove())),a.length=0,null==(e=this.view.tools)||e.remove(n),n.destroyed||n.destroy()},canUndo:()=>n.canUndo,undo:()=>{n.undo(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:r})},canRedo:()=>n.canRedo,redo:()=>{n.redo(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:r})},addToSelection:async e=>{this.updateGraphics.add(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"});const i=await this._setupMove3DOperation(this.updateGraphics.toArray(),t,o,"transform",!0);ft(i)||(p.onEnd(),p.destroy(),this._setUpdateOperationHandle(i,t))},removeFromSelection:e=>{this.updateGraphics.remove(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),p.complete()},toggleTool:async()=>{if(!1===t.toggleToolOnClick)return;const e=await this._setupGraphicTransform3DOperation(this.updateGraphics.toArray(),t,o,!0);ft(e)||(p.onEnd(),p.destroy(),this._setUpdateOperationHandle(e,t))}});return a.push(...this._getHandlesForComponent(p,t),o.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(p,e,t)),M.WIDGET),o.on("key-down",(e=>{this._getCommonUpdateOperationKeyDownHandlers(p,e),e.key===V.snappingToggle&&(this.snappingOptions.enabledToggled=!0,e.stopPropagation())}),M.WIDGET),o.on("key-up",(e=>{e.key===V.snappingToggle&&(this.snappingOptions.enabledToggled=!1,e.stopPropagation())}),M.WIDGET)),p}async _setupTransformOrReshapeOperation(e,t,o,i){const{multipleSelectionEnabled:s}=o;this.updateGraphics.addMany(e);const n="transform"===t?await this._getBox(e,o,i):await this._getReshape(e,o,i);if(ft(n))return n;const a=new pt({activeComponent:n,type:"update",onEnd:()=>{l.forEach((e=>e.remove())),p.forEach((e=>e.remove())),l=[],p=[],a.activeComponent&&!a.activeComponent.destroyed&&a.activeComponent.destroy(),this._internalGraphicsLayer.removeMany(this.updateGraphics.toArray())},undo:()=>{mt(a,this.updateGraphics.toArray()),a.refreshComponent(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:a.tool})},redo:()=>{yt(a,this.updateGraphics.toArray()),a.refreshComponent(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:a.tool})},addToSelection:async e=>{let t=a.activeComponent;if("reshape"===t.type){const t=[...this.updateGraphics,e];this.updateGraphics.removeAll();const r=await this._setupMoveOperation(t,o,i);if(ft(r))return;a.onEnd(),a.destroy(),this._setUpdateOperationHandle(r,o)}else this.updateGraphics.add(e),t=t,t.graphics=this.updateGraphics.toArray(),t.refresh(),a.resetHistory();this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:async e=>{const t=this.updateGraphics.indexOf(e);a.history.undo.forEach((e=>e.updates.splice(t,1))),a.history.redo.forEach((e=>e.updates.splice(t,1))),this.updateGraphics.remove(e);const o=this.updateGraphics.toArray();if(0===o.length)a.complete();else{const e=o[0].geometry;1!==o.length||!r(e)||"point"!==e.type&&"multipoint"!==e.type?a.activeComponent.graphics=o:a.toggleTool()}this.emit("update",{graphics:o,state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"})},toggleTool:async()=>{if(this.updateGraphics.length>1)return;const e=this.updateGraphics.getItemAt(0),t=e.geometry;if(r(t)&&("reshape"===a.tool&&("point"===t.type||"multipoint"===t.type)||"transform"===a.tool&&"extent"===t.type))return;let s=null;"transform"===a.tool?s=await this._getReshape([e],o,i):"reshape"===a.tool&&(s=await this._getBox([e],o,i)),ft(s)||(a.activeComponent.destroy(),a.activeComponent=s,a.activeComponent&&(l.forEach((e=>e.remove())),l=this._getHandlesForComponent(a,o)))}});let p=[i.on("immediate-click",(async e=>{var t;const o=await e.async((()=>this._getFirstHit(we(e))));null!=(t=o.results)&&t.length?o.results.some((t=>{if(t.graphic){var o;const i=t.graphic;if(null!=(o=e.native)&&o.shiftKey&&s)return e.stopPropagation(),a.addToSelection(i),!0;if(i.layer===this.layer)return a.complete(),!0}return!1})):a.complete()}),M.WIDGET),i.on("key-down",(e=>{if(this._getCommonUpdateOperationKeyDownHandlers(a,e),e.key!==V.snappingToggle||e.repeat||(this.snappingOptions.enabledToggled=!0,e.stopPropagation()),e.key===V.constraint&&!e.repeat&&a){const e=a.activeComponent;e&&"box"===e.type&&(e.preserveAspectRatio=!e.preserveAspectRatio)}}),M.WIDGET),i.on("key-up",(e=>{var t;if(e.key===V.snappingToggle&&"reshape"===(null==a||null==(t=a.activeComponent)?void 0:t.type)&&(this.snappingOptions.enabledToggled=!1,e.stopPropagation()),e.key===V.constraint&&a){const e=a.activeComponent;e&&"box"===e.type&&(e.preserveAspectRatio=!e.preserveAspectRatio)}}),M.WIDGET)],l=this._getHandlesForComponent(a,o);return a}async _getGraphicMover(e,t,o){const{enableMoveAllGraphics:i}=t,r=await this._requireModule(import("../../chunks/GraphicMover.js"));return ft(r)?r:new r.module.default({enableMoveAllGraphics:i,graphics:e,view:o,callbacks:{onGraphicMoveStart:({dx:e,dy:t,graphic:o})=>{this._displayGrabbingCursor(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:o,type:"move-start"},type:"update"})},onGraphicMove:({dx:e,dy:t,graphic:o})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:o,type:"move"},type:"update"}),onGraphicMoveStop:({dx:e,dy:t,graphic:o})=>{this._displayPointerCursor(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:o,type:"move-stop"},type:"update"})},onGraphicPointerOver:()=>this._displayPointerCursor(),onGraphicPointerOut:()=>this._displayDefaultCursor()}})}async _getBox(e,t,o){const{enableRotation:i,enableScaling:r,preserveAspectRatio:s}=t,n=await this._requireModule(import("../../chunks/Box.js"));return ft(n)?n:new n.module.default({graphics:e,enableRotation:i,enableScaling:r,preserveAspectRatio:s,layer:this._internalGraphicsLayer,view:o,callbacks:{onMoveStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onMove:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onMoveStop:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onScaleStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onScale:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onScaleStop:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onRotateStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onRotate:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onRotateStop:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"})}})}async _getReshape(e,t,o){var i,r;const s="split"===(null==(i=t.reshapeOptions)?void 0:i.edgeOperation),n="move"===(null==(r=t.reshapeOptions)?void 0:r.shapeOperation),a=await this._requireModule(import("../../chunks/Reshape.js"));return ft(a)?a:new a.module.default({enableMidpoints:s,enableMovement:n,graphic:e[0],layer:this._internalGraphicsLayer,snappingManager:this._snappingManager,view:o,callbacks:{onReshapeStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onReshape:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onReshapeStop:({mover:e,type:t})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e,type:t},type:"update"}),onMoveStart:({dx:e,dy:t,mover:o,type:i})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:o,type:i},type:"update"}),onMove:({dx:e,dy:t,mover:o,type:i})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:o,type:i},type:"update"}),onMoveStop:({dx:e,dy:t,mover:o,type:i})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:o,type:i},type:"update"}),onVertexAdd:({added:e,type:t,vertices:o})=>{const i=e.map((e=>C(e.geometry)));this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:i,vertices:o,type:t},type:"update"})},onVertexRemove:({removed:e,type:t,vertices:o})=>{const i=e.map((e=>C(e.geometry)));this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{removed:i,vertices:o,type:t},type:"update"})}}})}_getHandlesForComponent(e,t){const o=e.activeComponent;switch(o.type){case"graphic-mover":return[o.on("graphic-click",(({graphic:t,viewEvent:o})=>{var i;null!=(i=o.native)&&i.shiftKey&&(o.stopPropagation(),e.removeFromSelection(t))})),o.on("graphic-move-start",(t=>e.addToHistory(vt(t.allGraphics))))];case"box":return[o.on("graphic-click",(o=>this._onTransformOrReshape2DGraphicClick(e,t,o))),o.on("move-start",(t=>e.addToHistory(vt(t.graphics)))),o.on("rotate-start",(t=>e.addToHistory(vt(t.graphics)))),o.on("scale-start",(t=>e.addToHistory(vt(t.graphics))))];case"reshape":return[o.on("graphic-click",(o=>this._onTransformOrReshape2DGraphicClick(e,t,o))),o.on("move-start",(t=>e.addToHistory(vt([t.mover])))),o.on("reshape-start",(t=>e.addToHistory(vt([t.graphic])))),o.on("vertex-add",(t=>e.addToHistory(vt([t.oldGraphic])))),o.on("vertex-remove",(t=>e.addToHistory(vt([t.oldGraphic]))))];case"move-3d":return[o.on("graphic-move-start",(t=>{e.addToHistory(vt(t.allGraphics)),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:0,dy:0,mover:t.allGraphics.length>0?t.allGraphics[0]:null,type:"move-start"},type:"update"})})),o.on("graphic-move",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e.dx,dy:e.dy,mover:e.allGraphics.length>0?e.allGraphics[0]:null,type:"move"},type:"update"})})),o.on("graphic-move-stop",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:0,dy:0,mover:e.allGraphics.length>0?e.allGraphics[0]:null,type:"move-stop"},type:"update"})})),o.on("immediate-click",(o=>{o.shiftKey?this._toggleSelection([o.graphic],e,t):e.toggleTool()}))];case"transform-3d":return[o.on("record-undo",(({record:t})=>{e.addToHistory({updates:[t]})})),o.on("graphic-translate-start",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,dx:e.dxScreen,dy:e.dyScreen,type:"move-start"},type:"update"})})),o.on("graphic-translate-stop",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,dx:e.dxScreen,dy:e.dyScreen,type:"move-stop"},type:"update"})})),o.on("graphic-rotate-start",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,angle:e.angle,type:"rotate-start"},type:"update"})})),o.on("graphic-rotate-stop",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,angle:e.angle,type:"rotate-stop"},type:"update"})})),o.on("graphic-scale-start",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,xScale:e.xScale,yScale:e.yScale,type:"scale-start"},type:"update"})})),o.on("graphic-scale-stop",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,xScale:e.xScale,yScale:e.yScale,type:"scale-stop"},type:"update"})})),o.on("graphic-translate",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,dx:e.dxScreen,dy:e.dyScreen,type:"move"},type:"update"})})),o.on("graphic-rotate",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,angle:e.angle,type:"rotate"},type:"update"})})),o.on("graphic-scale",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,xScale:e.xScale,yScale:e.yScale,type:"scale"},type:"update"})})),o.on("immediate-click",(o=>{o.shiftKey?this._toggleSelection([o.graphic],e,t):e.toggleTool()}))];case"reshape-3d":return[o.on("reshape",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:e,type:"update"})})),o.on("move",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:e,type:"update"})})),o.on("vertex-add",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:e,type:"update"})})),o.on("vertex-remove",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:e,type:"update"})})),o.on("immediate-click",(o=>{o.shiftKey?this._toggleSelection([o.graphic],e,t):e.toggleTool()}))];default:return}}_onTransformOrReshape2DGraphicClick(e,t,o){var i;const{graphic:r,viewEvent:s}=o;return null!=(i=s.native)&&i.shiftKey&&r.layer===this.layer?(s.stopPropagation(),e.removeFromSelection(r)):t.toggleToolOnClick?(s.stopPropagation(),e.toggleTool()):void 0}_setUpdateOperationHandle(e,t){this._operationHandle=e;const o=this.view.map;this._disablePopup(t);e.on("complete",(()=>{if(e===this._operationHandle){const i=this.updateGraphics.toArray(),r=this._operationHandle.tool;this._operationHandle.destroy(),this._operationHandle=null,this._internalGraphicsLayer.removeMany(this.updateGraphics.toArray()),this.updateGraphics.removeAll(),o&&o.remove(this._internalGraphicsLayer),this._restorePopup(t),this.emit("update",{graphics:i,state:"complete",aborted:e.cancelled,tool:r,toolEventInfo:null,type:"update"})}}))}async _getCommonUpdateOperationClickHandlers(e,t,o){const i=we(t),r=(await t.async((()=>this._getFirstHit(i)))).results;if(!r.length)return void e.complete();if(t.native.shiftKey&&this._toggleSelection(r.map((e=>e.graphic)),e,o))return void t.stopPropagation();r.some((e=>e.graphic&&this.updateGraphics.includes(e.graphic)))?t.stopPropagation():e.complete()}_toggleSelection(e,t,o){const i=!!o.multipleSelectionEnabled;return e.some((e=>null!=e&&(!(!i||e.layer!==this.layer)&&(this.updateGraphics.includes(e)?t.removeFromSelection(e):t.addToSelection(e),!0))))}_getCommonUpdateOperationKeyDownHandlers(e,t){if(!e)return;const o=t.key;o===V.undo&&e.canUndo()?(t.stopPropagation(),e.undo()):o===V.redo&&e.canRedo()?(t.stopPropagation(),e.redo()):o===V.cancel?(t.stopPropagation(),e.cancel()):this.allowDeleteKey&&V.delete.includes(o)&&this._onDeleteKey(t)}_onDeleteKey(e){if(!this._operationHandle||"update"!==this._operationHandle.type)return;const t=this.activeComponent,o=this.updateGraphics.toArray();i(t)||"reshape-3d"===t.type||("reshape"!==t.type||1===o.length&&"point"===p(o[0].geometry,"type"))&&(e.stopPropagation(),this.delete())}_removeDefaultLayer(){this._internalGraphicsLayer&&(this.view&&this.view.map&&this.view.map.remove(this._internalGraphicsLayer),this._internalGraphicsLayer=n(this._internalGraphicsLayer))}_isComponentGraphic(e){const{activeComponent:t}=this;return!(!e||i(t))&&(!(!e.attributes||!e.attributes.esriSketchTool)||("box"===t.type||"reshape"===t.type)&&t.isUIGraphic(e))}_displayPointerCursor(){this.view&&this.view.container&&"pointer"!==this.view.cursor&&(this.view.cursor="pointer")}_displayGrabbingCursor(){this.view&&this.view.container&&"grabbing"!==this.view.cursor&&(this.view.cursor="grabbing")}_displayDefaultCursor(){this.view&&this.view.container&&null!==this.view.cursor&&(this.view.cursor=null)}_logError(e,t,o){lt.error(new l(e,t,o))}async _requireModule(e){const t=new AbortController;this._moduleLoaderAbortController=t;const o=await e;return this._moduleLoaderAbortController!==t||t.signal.aborted?{requireError:"aborted"}:{module:o}}_emitUndoEvent(e){this.emit("undo",{...e,type:"undo"})}_emitRedoEvent(e){this.emit("redo",{...e,type:"redo"})}_emitDeleteEvent(e){this.emit("delete",{...e,type:"delete"})}test(){return{operationHandle:this._operationHandle,defaultUpdateOptions:ht}}wait(){return k(this,"updating")}_beginAsyncOperation(){this._numUpdating+=1,this.notifyChange("updating")}_endAsyncOperation(){this._numUpdating-=1,this.notifyChange("updating")}_disablePopupEnabled(e){var t;return"3d"!==(null==(t=this.view)?void 0:t.type)||this.updateOnGraphicClick||r(e)&&e.toggleToolOnClick}_disablePopup(e){if(!this._disablePopupEnabled(e))return;const t=this.view.popup;t&&i(this._originalAutoOpenEnabled)&&(this._originalAutoOpenEnabled=t.autoOpenEnabled,t.autoOpenEnabled=!1)}_restorePopup(e){if(!this._disablePopupEnabled(e))return;const t=this.view.popup;t&&r(this._originalAutoOpenEnabled)&&(t.autoOpenEnabled=this._originalAutoOpenEnabled,this._originalAutoOpenEnabled=null)}async _waitViewReady(){this.view&&(a(this._viewReadyAbortController),this._viewReadyAbortController=v(),await f(T(this.view,"ready"),this._viewReadyAbortController.signal))}};function ut(e){return"polygon"===e||"rectangle"===e||"circle"===e}function mt(e,t){gt("undo",e.history.undo,e.history.redo,t)}function yt(e,t){gt("redo",e.history.redo,e.history.undo,t)}function gt(e,t,o,i){const s=t.pop().updates,n=[];i.forEach(((t,o)=>{const i=s[o];null!=i&&("geometry"in i&&r(i.geometry)&&(n.push({geometry:t.geometry}),t.geometry=i.geometry),"symbol"in i&&r(i.symbol)&&(n.push({symbol:t.symbol}),t.symbol=i.symbol),"undo"in i&&(n.push(i),i[e](t)))})),o.push({updates:n})}function vt(e){return{updates:e.map((e=>({geometry:e.geometry})))}}function ft(e){return"requireError"in e&&"aborted"===e.requireError}e([E()],dt.prototype,"updating",null),e([E()],dt.prototype,"_operationHandle",void 0),e([E({readOnly:!0})],dt.prototype,"activeTool",null),e([E()],dt.prototype,"activeFillSymbol",void 0),e([E()],dt.prototype,"activeLineSymbol",void 0),e([E()],dt.prototype,"activeVertexSymbol",void 0),e([E()],dt.prototype,"allowDeleteKey",void 0),e([E({readOnly:!0})],dt.prototype,"createGraphic",null),e([E()],dt.prototype,"defaultCreateOptions",null),e([E()],dt.prototype,"defaultUpdateOptions",null),e([E()],dt.prototype,"layer",void 0),e([E({types:t})],dt.prototype,"pointSymbol",void 0),e([E({types:t})],dt.prototype,"polygonSymbol",void 0),e([E({types:t})],dt.prototype,"polylineSymbol",void 0),e([E({type:je,nonNullable:!0})],dt.prototype,"snappingOptions",null),e([E()],dt.prototype,"_snappingManager",void 0),e([E({readOnly:!0})],dt.prototype,"state",null),e([E({readOnly:!0})],dt.prototype,"updateGraphics",void 0),e([E()],dt.prototype,"updateOnGraphicClick",void 0),e([E({types:t})],dt.prototype,"updatePointSymbol",void 0),e([E({types:t})],dt.prototype,"updatePolygonSymbol",void 0),e([E({types:t})],dt.prototype,"updatePolylineSymbol",void 0),e([E({types:t})],dt.prototype,"vertexSymbol",void 0),e([E({value:null})],dt.prototype,"view",null),e([E()],dt.prototype,"cancel",null),e([E()],dt.prototype,"complete",null),e([E()],dt.prototype,"delete",null),e([E()],dt.prototype,"create",null),e([E()],dt.prototype,"update",null),e([E()],dt.prototype,"undo",null),e([E()],dt.prototype,"redo",null),e([E()],dt.prototype,"canUndo",null),e([E()],dt.prototype,"canRedo",null),e([E()],dt.prototype,"toggleUpdateTool",null),dt=e([x("esri.widgets.Sketch.SketchViewModel")],dt);var jt=dt;export{De as E,Le as F,Pe as P,xe as a,Oe as b,jt as default,Ge as g,Ee as i};
