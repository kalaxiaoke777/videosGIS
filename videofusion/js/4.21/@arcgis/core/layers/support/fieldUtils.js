/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import e from"../../core/Error.js";import{b as n,i}from"../../core/lang.js";import{g as t,s as r}from"../../chunks/object.js";import{l as o}from"../../chunks/arcadeOnDemand.js";import"../../chunks/Logger.js";import"../../config.js";import"../../chunks/string.js";import"../../chunks/Message.js";import"../../geometry.js";import"../../chunks/ensureType.js";import"../../geometry/Extent.js";import"../../chunks/tslib.es6.js";import"../../core/accessorSupport/decorators/property.js";import"../../chunks/metadata.js";import"../../chunks/handleUtils.js";import"../../core/accessorSupport/decorators/subclass.js";import"../../geometry/Geometry.js";import"../../chunks/JSONSupport.js";import"../../core/Accessor.js";import"../../chunks/deprecate.js";import"../../chunks/ArrayPool.js";import"../../chunks/arrayUtils.js";import"../../core/scheduling.js";import"../../core/promiseUtils.js";import"../../chunks/reader.js";import"../../geometry/SpatialReference.js";import"../../chunks/writer.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/support/webMercatorUtils.js";import"../../chunks/Ellipsoid.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/extentUtils.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../chunks/jsonMap.js";import"../../geometry/support/jsonUtils.js";var s;function l(e,n){switch(e.type){case"range":{const i="range"in e?e.range[0]:e.minValue,t="range"in e?e.range[1]:e.maxValue;if(+n<i||+n>t)return s.VALUE_OUT_OF_RANGE;break}case"coded-value":case"codedValue":if(null==e.codedValues||e.codedValues.every((e=>null==e||e.code!==n)))return s.INVALID_CODED_VALUE}return null}function a(e){if(!e||"range"!==e.type)return;return{min:"range"in e?e.range[0]:e.minValue,max:"range"in e?e.range[1]:e.maxValue}}!function(e){e.VALUE_OUT_OF_RANGE="domain-validation-error::value-out-of-range",e.INVALID_CODED_VALUE="domain-validation-error::invalid-coded-value"}(s||(s={}));const u=["field","field2","field3","normalizationField","rotationInfo.field","proportionalSymbolInfo.field","proportionalSymbolInfo.normalizationField","colorInfo.field","colorInfo.normalizationField"],c=["field","normalizationField"];function f(e,n){if(null!=e&&null!=n)for(const i of Array.isArray(e)?e:[e])if(d(u,i,n),"visualVariables"in i&&i.visualVariables)for(const e of i.visualVariables)d(c,e,n)}function d(e,n,i){if(e)for(const o of e){const e=t(o,n),s=e&&"function"!=typeof e&&i.get(e);s&&r(o,s.name,n)}}function m(e,n){if(null!=e&&null!=n&&n.fields.length)if("startField"in e){const i=n.get(e.startField),t=n.get(e.endField);e.startField=i&&i.name||null,e.endField=t&&t.name||null}else{const i=n.get(e.startTimeField),t=n.get(e.endTimeField);e.startTimeField=i&&i.name||null,e.endTimeField=t&&t.name||null}}const p=new Set;function y(e,n){return e&&n?(p.clear(),g(p,e,n),Array.from(p).sort()):[]}function g(e,n,i){var t;if(i)if(null!=n&&null!=(t=n.fields)&&t.length)if(i.includes("*"))for(const{name:i}of n.fields)e.add(i);else for(const t of i)F(e,n,t);else{if(i.includes("*"))return e.clear(),void e.add("*");for(const n of i)e.add(n)}}function F(e,n,i){if("string"==typeof i)if(n){const t=n.get(i);t&&e.add(t.name)}else e.add(i)}function I(e,i){return n(i)||n(e)?[]:i.includes("*")?e.fields.map((e=>e.name)):i}function h(e,n,i=1){if(!n||!e)return[];if(n.includes("*"))return["*"];const t=y(e,n);return t.length/e.fields.length>=i?["*"]:t}async function x(e,n,i){var t;if(!i)return;const{arcadeUtils:r}=await o(),s=r.extractFieldNames(i,null==n||null==(t=n.fields)?void 0:t.map((e=>e.name)));for(const i of s)F(e,n,i)}async function j(n,i,t){if(t&&"1=1"!==t){const r=(await import("../../core/sql/WhereClause.js")).WhereClause.create(t,i);if(!r.isStandardized)throw new e("fieldUtils:collectFilterFields","Where clause is not standardized");g(n,i,r.fieldNames)}}function b({displayField:e,fields:n}){return e||(n&&n.length?T(n,"name-or-title")||T(n,"unique-identifier")||T(n,"type-or-category")||function(e){for(const n of e){if(!n||!n.name)continue;const e=n.name.toLowerCase();if(e.indexOf("name")>-1||e.indexOf("title")>-1)return n.name}return null}(n):null)}function T(e,n){for(const i of e)if(i&&i.valueType&&i.valueType===n)return i.name;return null}async function v(e){if(!e)return[];const n=new Set;return await S(n,e),Array.from(n).sort()}async function S(e,n){if(!n)return;const i=t("elevationInfo.featureExpressionInfo",n);return i?i.collectRequiredFields(e,n.fieldsIndex):void 0}async function A(e,n,i){var t;if(!n||!i||"cluster"!==i.type)return;const r=[];null!=(t=i.popupTemplate)&&t.expressionInfos&&r.push(...i.popupTemplate.expressionInfos.map((i=>x(e,n.fieldsIndex,i.expression)))),i.fields&&r.push(...i.fields.map((i=>async function(e,n,i){i.outStatistic.onStatisticValueExpression?x(e,n,i.outStatistic.onStatisticValueExpression):e.add(i.outStatistic.onStatisticField)}(e,n.fieldsIndex,i)))),await Promise.all(r)}async function E(e,n,t){n&&(n.timeInfo&&i(t)&&t.timeExtent&&g(e,n.fieldsIndex,[n.timeInfo.startField,n.timeInfo.endField]),n.floorInfo&&g(e,n.fieldsIndex,[n.floorInfo.floorField]),i(t)&&i(t.where)&&await j(e,n.fieldsIndex,t.where))}async function V(e,n,i){n&&i&&await Promise.all(i.map((i=>async function(e,n,i){if(!n||!i)return;i.valueExpression?await x(e,n.fieldsIndex,i.valueExpression):i.field&&F(e,n.fieldsIndex,i.field)}(e,n,i))))}async function w(e){if(!e)return[];const n="timeInfo"in e&&e.timeInfo;return n?y(e.fieldsIndex,[e.trackIdField,n.startField,n.endField]):[]}function k(e){if(!e)return[];const n="editFieldsInfo"in e&&e.editFieldsInfo;return n?y(e.fieldsIndex,[n&&n.creatorField,n&&n.creationDateField,n&&n.editorField,n&&n.editDateField]):[]}function N(e){if(!e)return[];const n=e.geometryFieldsInfo;return n?y(e.fieldsIndex,[n.shapeAreaField,n.shapeLengthField]):[]}async function _(e){if(!e)return[];const n=new Set;return await U(n,e),Array.from(n).sort()}async function U(e,n){const{labelingInfo:i,fieldsIndex:t}=n;i&&i.length&&await Promise.all(i.map((n=>async function(e,n,i){if(!i)return;const t=i.getLabelExpression(),r=i.where;if("arcade"===t.type)await x(e,n,t.expression);else{const i=t.expression.match(/{[^}]*}/g);i&&i.forEach((i=>{F(e,n,i.slice(1,-1))}))}await j(e,n,r)}(e,t,n))))}function D(e){const n=e.defaultValue;return void 0!==n&&M(e,n)?n:e.nullable?null:void 0}function O(e){return"number"==typeof e&&!isNaN(e)&&isFinite(e)}function L(e){return null===e||O(e)}const $="isInteger"in Number?Number.isInteger:e=>"number"==typeof e&&isFinite(e)&&Math.floor(e)===e;function P(e){return null===e||$(e)}function R(e){return null!=e&&"string"==typeof e}function z(e){return null===e||R(e)}function G(){return!0}function M(e,n){let i;switch(e.type){case"date":case"integer":case"long":case"small-integer":case"esriFieldTypeDate":case"esriFieldTypeInteger":case"esriFieldTypeLong":case"esriFieldTypeSmallInteger":i=e.nullable?P:$;break;case"double":case"single":case"esriFieldTypeSingle":case"esriFieldTypeDouble":i=e.nullable?L:O;break;case"string":case"esriFieldTypeString":i=e.nullable?z:R;break;default:i=G}return 1===arguments.length?i:i(n)}const C=["integer","small-integer","single","double"],q=new Set([...C,"esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeSingle","esriFieldTypeDouble"]);function J(e){return null!=e&&q.has(e.type)}function W(e){return null!=e&&("string"===e.type||"esriFieldTypeString"===e.type)}function Y(e){return null!=e&&("date"===e.type||"esriFieldTypeDate"===e.type)}function X(e,n){return null===Q(e,n)}var B,H;function K(e){return null==e||"number"==typeof e&&isNaN(e)?null:e}function Q(e,n){return e.nullable&&null===n?null:J(e)&&!Z(e.type,Number(n))?B.OUT_OF_RANGE:M(e,n)?e.domain?l(e.domain,n):null:H.INVALID_TYPE}function Z(e,n){const i="string"==typeof e?ne(e):e;return!!i&&(i.isInteger?$(n)&&n>=i.min&&n<=i.max:n>=i.min&&n<=i.max)}function ee(e){const n=a(e.domain);return n||(J(e)?ne(e.type):void 0)}function ne(e){switch(e){case"esriFieldTypeSmallInteger":case"small-integer":return te;case"esriFieldTypeInteger":case"integer":return re;case"esriFieldTypeSingle":case"single":return oe;case"esriFieldTypeDouble":case"double":return se}}function ie(e){if(!O(e))return null;if($(e)){if(e>=te.min&&e<=te.max)return"esriFieldTypeSmallInteger";if(e>=re.min&&e<=re.max)return"esriFieldTypeInteger"}return e>=oe.min&&e<=oe.max?"esriFieldTypeSingle":"esriFieldTypeDouble"}!function(e){e.OUT_OF_RANGE="numeric-range-validation-error::out-of-range"}(B||(B={})),function(e){e.INVALID_TYPE="type-validation-error::invalid-type"}(H||(H={}));const te={min:-32768,max:32767,isInteger:!0},re={min:-2147483648,max:2147483647,isInteger:!0},oe={min:-34e37,max:12e37,isInteger:!1},se={min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isInteger:!1};function le(e,n,i){switch(e){case s.INVALID_CODED_VALUE:return`Value ${i} is not in the coded domain - field: ${n.name}, domain: ${JSON.stringify(n.domain)}`;case s.VALUE_OUT_OF_RANGE:return`Value ${i} is out of the range of valid values - field: ${n.name}, domain: ${JSON.stringify(n.domain)}`;case H.INVALID_TYPE:return`Value ${i} is not a valid value for the field type - field: ${n.name}, type: ${n.type}, nullable: ${n.nullable}`;case B.OUT_OF_RANGE:{const{min:e,max:t}=ne(n.type);return`Value ${i} is out of range for the number type - field: ${n.name}, type: ${n.type}, value range is ${e} to ${t}`}}}function ae(e,n){return!ue(e,n,null)}function ue(e,n,t){if(!n||!n.attributes||!e){if(i(t))for(const n of e)t.add(n);return!0}const r=n.attributes;let o=!1;for(const n of e)if(!(n in r)){if(o=!0,!i(t))break;t.add(n)}return o}async function ce(e,n){const i=new Set;for(const t of n)await x(i,e.fieldsIndex,t);return Array.from(i).sort()}export{s as D,B as NumericRangeValidationError,H as TypeValidationError,x as collectArcadeFieldNames,S as collectElevationFields,A as collectFeatureReductionFields,F as collectField,g as collectFields,E as collectFilterFields,U as collectLabelingFields,V as collectOrderByInfos,se as doubleRange,ae as featureHasFields,y as fixFields,f as fixRendererFields,m as fixTimeInfoFields,a as g,b as getDisplayFieldName,v as getElevationFields,ce as getExpressionFields,k as getFeatureEditFields,N as getFeatureGeometryFields,D as getFieldDefaultValue,ee as getFieldRange,_ as getLabelingFields,ie as getNumericTypeForValue,w as getTimeFields,re as integerRange,Y as isDateField,Z as isNumberInRange,J as isNumericField,W as isStringField,X as isValidFieldValue,M as isValueMatchingFieldType,C as numericTypes,h as packFields,ue as populateMissingFields,u as rendererFields,K as sanitizeNullFieldValue,oe as singleRange,te as smallIntegerRange,I as unpackFieldNames,l as v,Q as validateFieldValue,le as validationErrorToString,c as visualVariableFields};
