/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import t from"../Color.js";import e from"../request.js";import{g as r}from"./MapUtils.js";import{u as o,f as s,i,b as n}from"../core/lang.js";import{a}from"./mat3.js";import{c as p}from"./quatf64.js";import{j as m}from"./mathUtils.js";import{f as c}from"./vec4f64.js";import l,{M as u}from"../geometry/support/MeshComponent.js";import f from"../geometry/support/MeshMaterialMetallicRoughness.js";import j from"../geometry/support/MeshTexture.js";import{B as g,a as d,g as y,b as x,e as h,l as b,m as v,n as M}from"./BufferView.js";import{t as w,a as C,f as U,s as A,c as S,b as B}from"./vec3.js";import{D as T,l as E,c as $,C as R,t as F,f as O,n as q,g as D,s as P,a as G,h as L,b as N,d as V,e as k}from"./DefaultMaterial_COLOR_GAMMA.js";import{a as z}from"./georeference.js";import{d as I}from"./geometryDataUtils.js";import"./colorUtils.js";import"./ensureType.js";import"./Logger.js";import"../config.js";import"./object.js";import"./string.js";import"./common.js";import"../kernel.js";import"../core/urlUtils.js";import"../core/Error.js";import"./Message.js";import"../core/promiseUtils.js";import"./tslib.es6.js";import"./JSONSupport.js";import"../core/Accessor.js";import"./deprecate.js";import"../core/accessorSupport/decorators/property.js";import"./metadata.js";import"./handleUtils.js";import"./ArrayPool.js";import"../core/accessorSupport/decorators/subclass.js";import"./arrayUtils.js";import"../core/scheduling.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/MeshMaterial.js";import"./reader.js";import"./writer.js";import"./persistableUrlUtils.js";import"./screenshotUtils.js";import"./vec2.js";import"./types.js";import"./asyncUtils.js";import"./mat4f64.js";import"./compilerUtils.js";import"./Version.js";import"./mat4.js";import"./quat.js";import"./unitUtils.js";import"./jsonMap.js";import"./projectionEllipsoid.js";import"../geometry/SpatialReference.js";import"./Ellipsoid.js";import"../geometry/projection.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../geometry/Point.js";import"../geometry/support/webMercatorUtils.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"./pe.js";import"./assets.js";import"../geometry/Polygon.js";import"./extentUtils.js";import"../geometry/Polyline.js";import"./aaBoundingRect.js";import"./geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"./axisAngleDegrees.js";import"./projection.js";import"./triangle.js";import"./vectorStacks.js";import"./vec2f64.js";import"./lineSegment.js";async function _(n,a,p){const l=new T(function(t){if(null==t||!t.resolveFile)return null;return{busy:!1,request:async(r,o,s)=>{const n=t.resolveFile(r),a="image"===o?"image":"binary"===o?"array-buffer":"json";return(await e(n,{responseType:a,signal:i(s)?s.signal:null})).data}}}(p)),b=(await E(l,a,p,!0)).model,v=b.lods.shift(),M=new Map,w=new Map;b.textures.forEach(((t,e)=>{return M.set(e,new j({data:(r=t).data,wrap:W(r.parameters.wrap)}));var r})),b.materials.forEach(((e,r)=>w.set(r,function(e,r){const i=new t((a=e.color,p=e.opacity,c(Y(a[0]),Y(a[1]),Y(a[2]),p))),n=e.emissiveFactor?new t(function(t){return m(Y(t[0]),Y(t[1]),Y(t[2]))}(e.emissiveFactor)):null;var a,p;return new f({color:i,colorTexture:o(s(e.textureColor,(t=>r.get(t)))),normalTexture:o(s(e.textureNormal,(t=>r.get(t)))),emissiveColor:n,emissiveTexture:o(s(e.textureEmissive,(t=>r.get(t)))),occlusionTexture:o(s(e.textureOcclusion,(t=>r.get(t)))),alphaMode:H(e.alphaMode),alphaCutoff:e.alphaCutoff,doubleSided:e.doubleSided,metallic:e.metallicFactor,roughness:e.roughnessFactor,metallicRoughnessTexture:o(s(e.textureMetallicRoughness,(t=>r.get(t))))})}(e,M))));const C=function(t){let e=0;const o={color:!1,tangent:!1,normal:!1,texCoord0:!1},s=new Map,i=new Map,n=[];for(const a of t.parts){const{attributes:{position:t,normal:p,color:m,tangent:c,texCoord0:l}}=a,u=`\n      ${J(t,s)}/\n      ${J(p,s)}/\n      ${J(m,s)}/\n      ${J(c,s)}/\n      ${J(l,s)}/\n      ${K(a.transform)}\n    `;let f=!1;const j=r(i,u,(()=>(f=!0,{start:e,length:t.count})));f&&(e+=t.count),p&&(o.normal=!0),m&&(o.color=!0),c&&(o.tangent=!0),l&&(o.texCoord0=!0),n.push({gltf:a,writeVertices:f,region:j})}return{vertexAttributes:{position:$(g,e),normal:o.normal?$(d,e):null,tangent:o.tangent?$(y,e):null,color:o.color?$(x,e):null,texCoord0:o.texCoord0?$(h,e):null},parts:n,components:[]}}(v);for(const t of C.parts)Q(C,t,w);const{position:U,normal:A,tangent:S,color:B,texCoord0:R}=C.vertexAttributes,F={position:U.typedBuffer,normal:i(A)?A.typedBuffer:null,tangent:i(S)?S.typedBuffer:null,uv:i(R)?R.typedBuffer:null,color:i(B)?B.typedBuffer:null},O=z(F,n,p);return{transform:O.transform,components:C.components,spatialReference:n.spatialReference,vertexAttributes:new u({position:O.vertexAttributes.position,normal:O.vertexAttributes.normal,tangent:O.vertexAttributes.tangent,color:F.color,uv:F.uv})}}function J(t,e){if(n(t))return"-";const o=t.typedBuffer;return`${r(e,o.buffer,(()=>e.size))}/${o.byteOffset}/${o.byteLength}`}function K(t){return i(t)?t.toString():"-"}function Q(t,e,r){e.writeVertices&&function(t,e){const{position:r,normal:o,tangent:s,color:n,texCoord0:m}=t.vertexAttributes,c=e.region.start,{attributes:l,transform:u}=e.gltf,f=l.position.count;if(w(r.slice(c,f),l.position,u),i(l.normal)&&i(o)){const t=a(p(),u);C(o.slice(c,f),l.normal,t)}else i(o)&&U(o,0,0,1,{dstIndex:c,count:f});if(i(l.tangent)&&i(s)){const t=a(p(),u);F(s.slice(c,f),l.tangent,t)}else i(s)&&O(s,0,0,1,1,{dstIndex:c,count:f});i(l.texCoord0)&&i(m)?q(m.slice(c,f),l.texCoord0):i(m)&&D(m,0,0,{dstIndex:c,count:f});if(i(l.color)&&i(n)){const t=l.color,e=n.slice(c,f);if(4===t.elementCount)t instanceof y?P(e,t,255):t instanceof x?G(e,t):t instanceof b&&L(e,t,8);else{O(e,255,255,255,255);const r=v.fromTypedArray(e.typedBuffer,e.typedBufferStride);t instanceof d?A(r,t,255):t instanceof v?S(r,t):t instanceof M&&B(r,t,8)}}else i(n)&&O(n.slice(c,f),255,255,255,255)}(t,e);const o=e.gltf,s=function(t,e){switch(e){case 4:return k(t,I);case 5:return V(t);case 6:return N(t)}}(o.indices||o.attributes.position.count,o.primitiveType),n=e.region.start;if(n)for(let t=0;t<s.length;t++)s[t]+=n;t.components.push(new l({faces:s,material:r.get(o.material),trustSourceNormals:!0}))}function H(t){switch(t){case"OPAQUE":return"opaque";case"MASK":return"mask";case"BLEND":return"blend"}}function W(t){return{horizontal:X(t.s),vertical:X(t.t)}}function X(t){switch(t){case 33071:return"clamp";case 33648:return"mirror";case 10497:return"repeat"}}function Y(t){return t**(1/R)*255}export{_ as loadGLTFMesh};
