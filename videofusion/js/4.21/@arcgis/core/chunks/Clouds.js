/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import e from"../Camera.js";import"../geometry.js";import t from"../Graphic.js";import n from"../Viewpoint.js";import{r}from"./asyncUtils.js";import{i,d as o,b as a,u as s}from"../core/lang.js";import c from"../core/Error.js";import{createResolver as l,eachAlways as u}from"../core/promiseUtils.js";import{f,t as m}from"./mat3.js";import{c as p}from"./quatf64.js";import{c as d}from"./mat4f64.js";import{k as h,p as g,f as y,s as v,g as x,d as w,l as b,b as M,n as R,a as j,r as z,i as T,m as S,t as G,j as C,q as H,o as A,u as P,v as F,w as N,e as k,x as I}from"./mathUtils.js";import{projectPointToVector as E,projectVectorToVector as B,projectVectorToPoint as Z,project as q,projectBuffer as U,computeTranslationToOriginAndRotation as W}from"../geometry/projection.js";import{c as O,e as _,a as L,t as D,i as X,b as Y,d as V,w as $,h as J,g as K}from"./aaBoundingBox.js";import{b as Q,c as ee,i as te}from"./aaBoundingRect.js";import{i as ne}from"./frustum.js";import{geographicToWebMercator as re,project as ie,canProject as oe}from"../geometry/support/webMercatorUtils.js";import{g as ae}from"./projectionEllipsoid.js";import{I as se}from"./Intersector.js";import{L as ce}from"./Logger.js";import le from"../geometry/Point.js";import ue from"../geometry/SpatialReference.js";import{g as fe}from"./scaleUtils.js";import{i as me,r as pe,b as de,c as he}from"./mat4.js";import ge from"../geometry/Extent.js";import{g as ye,a as ve}from"./earthUtils.js";import{C as xe,a as we,c as be}from"./mathUtils2.js";import{g as Me}from"./ElevationProvider.js";import{i as Re}from"./spatialReferenceSupport.js";import je from"../geometry/Geometry.js";import{_ as ze}from"./tslib.es6.js";import Te from"../core/Accessor.js";import{property as Se}from"../core/accessorSupport/decorators/property.js";import"./ensureType.js";import{subclass as Ge}from"../core/accessorSupport/decorators/subclass.js";function Ce(e,t,n,r){return i(e.renderCoordsHelper.fromRenderCoords(t.eye,Ne,r))&&Q(n,Ne)}function He(e,t){return e.elevationProvider?o(e.elevationProvider.getElevation(t[0],t[1],t[2],e.renderCoordsHelper.spatialReference,"ground"),0):0}function Ae(e,t,n,r){const i=e.state.camera.clone();t&&(i.eye=t,i.center=n,i.up=r),function(e,t,n){let r=Fe[e.viewingMode];r||(r=new se(e.state.viewingMode),r.options.backfacesTerrain=!e.state.isGlobal,r.options.invisibleTerrain=!0,Fe[e.viewingMode]=r);const{isGlobal:i}=e.state;if(e.sceneIntersectionHelper.intersectRay(t,r,n)&&!Pe(e,t.origin,n))return!0;if(!e.renderCoordsHelper.intersectManifold(t,0,n)||Pe(e,t.origin,n))return!!i&&function(e,t,n){const r=w(e.origin,e.origin),i=r-n*n,o=i>0?Math.sqrt(i)/3:1;return y(t,e.direction,o/b(e.direction)),x(t,t,e.origin),!0}(t,n,ae(e.spatialReference).radius);return!0}(e,i.ray,ke)||h(ke,i.center);const o=e.state.constraints,a=o.minimumPoiDistance;if(g(i.eye,ke)<a){const t=o.collision.enabled;h(Ie,i.viewForward),y(Ie,Ie,a),t?i.eye=v(Ne,ke,Ie):x(ke,i.eye,Ie);const n=e.renderCoordsHelper,r=n.getAltitude(i.eye),s=o.collision.elevationMargin;t&&r<s&&(v(Ie,ke,i.eye),i.eye=n.setAltitude(Ne,s,i.eye),x(ke,i.eye,Ie))}return i.center=ke,i}function Pe(e,t,n){if(!e.state.isGlobal)return!1;const r=He(e,t),i=e.stateManager.constraintsManager.nearFarHeuristic,{far:o}=i.compute(t,n,e.renderDataExtent,r,Ee),a=o*o;return g(t,n)>a}const Fe={},Ne=M(),ke=M(),Ie=M(),Ee={near:0,far:0},Be=M(),Ze=M();function qe(){return{direction:M(),up:M()}}function Ue(e,t,n,r,i){let o=R(Be,e),a=w(o,r);const s=a>0;a=Math.abs(a),a>.99&&(a=Math.abs(w(t,r)),a<.99?(h(o,t),s&&y(o,o,-1)):o=null);let c=0;if(o){y(Ze,r,w(r,o)),v(o,o,Ze);const e=w(o,i)/(b(o)*b(i));j(Ze,o,i);c=(w(Ze,r)>0?1:-1)*z(T(e))}const l=z(T(-w(r,e)/b(e)));return n?(n.heading=c,n.tilt=l,n):{heading:c,tilt:l}}const We=C(0,1,0),Oe=C(0,0,1),_e=d(),Le=M(),De=M();function Xe(e,t,n,r=qe()){me(_e);const{direction:i,up:o}=r;return pe(_e,_e,-S(t)),de(_e,_e,S(n)),G(i,Oe,_e),y(i,i,-1),G(o,We,_e),r}function Ye(e,t,n,r,i){const o=e.renderSpatialReference,a=e.map&&e.spatialReference||t.spatialReference;return E(t,Le,o),E(t,De,o),Le[0]-=n/2,De[0]+=n/2,Le[1]-=r/2,De[1]+=r/2,B(Le,o,Le,a),B(De,o,De,a),i?(i.xmin=Le[0],i.ymin=Le[1],i.xmax=De[0],i.ymax=De[1],i.spatialReference=a):i=new ge(Le[0],Le[1],De[0],De[1],a),i}var Ve=Object.freeze({__proto__:null,headingTiltToDirectionUp:Xe,directionToHeadingTilt:function(e,t,n,r){return Ue(t,n,r,Oe,We)},eyeForCenterWithHeadingTilt:function(e,t,n,r){const i=Xe(0,n,r),o=M();return y(o,i.direction,-t),x(o,o,e),{up:i.up,eye:o,heading:n,tilt:r}},lookAtTiltToEyeTilt:function(e){return z(e)},eyeTiltToLookAtTilt:function(e){return S(e)},toExtent:Ye});const $e=C(0,0,1),Je=R(M(),C(1,1,1)),Ke=new xe(-180,180),Qe=d(),et=M(),tt=M();function nt(e,t,n,r=qe()){j(et,e,$e),0===w(et,et)&&j(et,e,Je),me(Qe),he(Qe,Qe,-S(t),e),he(Qe,Qe,-S(n),et);const{up:i,direction:o}=r;return j(i,et,e),R(i,i),G(i,i,Qe),R(o,e),H(o,o),G(o,o,Qe),r}function rt(e){const t=e[1];e[1]=-e[2],e[2]=t}function it(e,t){const n=nt(t,e.heading,e.tilt);return e.up=n.up,e}function ot(e,t,n,r,i){let o,a,s,c;const l=t.latitude,u=t.longitude,f=ye(l,n,ae(e.spatialReference).radius)/2;o=u-f,a=u+f;const m=S(l),p=ae(e.spatialReference).radius,d=(1+Math.sin(m))/(1-Math.sin(m)),h=(d+1)*Math.tan(r/p/2),g=h*h;function y(e){const t=Math.PI/2;return(e=we.normalize(e,-t))>t&&(e=Math.PI-e),e}if(s=1.5*Math.PI-2*Math.atan(.5*(h+Math.sqrt(4*d+g))),c=s+r/p,s=y(s),c=y(c),c<s){const e=c;c=s,s=e}if(s=Math.max(z(s),-90),c=Math.min(z(c),90),a=Ke.monotonic(o,a),a-o>180){const e=(a-o-180)/2;o+=e,a-=e}const v=e.spatialReference&&e.spatialReference.isGeographic?e.spatialReference:ue.WGS84;return i?(i.xmin=o,i.ymin=s,i.xmax=a,i.ymax=c,i.spatialReference=v):i=new ge(o,s,a,c,v),e.spatialReference&&e.spatialReference.isWebMercator&&re(i,!1,i),i}var at=Object.freeze({__proto__:null,headingTiltToDirectionUp:nt,directionToHeadingTilt:function(e,t,n,r){const i=et,o=tt;return R(i,e),j(tt,i,$e),0===w(tt,tt)&&j(tt,i,Je),j(o,tt,i),Ue(t,n,r,i,o)},eyeForCenterWithHeadingTilt:function(e,t,n,r){const i={eye:M(),up:null,tilt:r,heading:n},o=et;o[0]=e[0],o[1]=e[2],o[2]=-e[1];const a=t,s=S(n),c=S(r),l=Math.sin(s),u=Math.cos(s),f=Math.sin(c),m=Math.cos(c),p=b(o);let d;if(Math.abs(c)<1e-8)d=a+p;else{const e=p/f,t=A(a/e),n=Math.PI-c-t;d=e*Math.sin(n)}const h=m*a,g=a*a*(f*f),v=u*u*g,x=d-h,w=x*x,R=v*(v+w-o[1]*o[1]);if(R<0)return y(i.eye,o,d/p),i.tilt=0,i;const j=Math.sqrt(R),z=o[1]*x,T=v+w;let G;if(G=u>0?-j+z:j+z,Math.abs(T)<1e-8)return p<1e-8?(i.eye[0]=0,i.eye[1]=0,i.eye[2]=a):y(i.eye,o,d/p),i.tilt=0,rt(i.eye),it(i,e);i.eye[1]=G/T;const C=l*l*g,H=f*a,P=u*H*i.eye[1],F=i.eye[1]*i.eye[1],N=1-F,k=Math.sqrt(N),I=v*F+C-2*P*k*x+N*w;return Math.abs(I)<1e-8?(y(i.eye,o,d/p),i.tilt=0,rt(i.eye),it(i,e)):(i.eye[0]=(N*(d*o[0]-h*o[0])-H*k*(o[0]*i.eye[1]*u+o[2]*l))/I,i.eye[2]=(N*(d*o[2]-h*o[2])-H*k*(o[2]*i.eye[1]*u-o[0]*l))/I,y(i.eye,i.eye,d),rt(i.eye),it(i,e))},lookAtTiltToEyeTilt:function(e,t,n){const r=b(t),i=Math.sqrt(n*n+r*r-2*n*r*Math.cos(Math.PI-e)),o=A(n/(i/Math.sin(e)));return z(e-o)},eyeTiltToLookAtTilt:function(e,t,n){const r=S(e),i=b(t);return A(n/(i/Math.sin(r)))+r},toExtent:ot});const st=ce.getLogger("esri.views.3d.support.cameraUtils"),ct=M(),lt=M(),ut={heading:0,tilt:0},ft=new le,mt=new xe(-20037508.342788905,20037508.342788905),pt=new xe(-180,180);function dt(e){return e.spatialReference||ue.WGS84}function ht(e){return"global"===e.viewingMode?at:Ve}function gt(e,t,n,r,i){return ht(e).headingTiltToDirectionUp(t,n,r,i)}function yt(e,t){if(a(t))return null;const n=e.renderSpatialReference,r=ht(e).headingTiltToDirectionUp,i=M();if(!E(t.position,i,n))return null;const o=r(i,t.heading,t.tilt);y(o.direction,o.direction,e.state.camera.distance),x(o.direction,o.direction,i);const s=Ae(e,i,o.direction,o.up);return s.fov=S(t.fov),s}const vt=M();function xt(t,n,r){const i=t.renderSpatialReference,o=jt(t,n.eye,n.viewForward,n.up,ut);let s=dt(t);return B(n.eye,i,vt,s)||(s=ue.WGS84,B(n.eye,i,vt,s)),a(r)?new e(new le(vt,s),o.heading,o.tilt,z(n.fov)):(r.position.x=vt[0],r.position.y=vt[1],r.position.z=vt[2],r.position.spatialReference=s,r.heading=o.heading,r.tilt=o.tilt,r.fov=z(n.fov),r)}function wt(e,t,n){const r=e.state.camera,i=r.width/2/r.pixelRatio;1===e.renderCoordsHelper.viewingMode&&null!=n&&(t*=Math.cos(S(n)));return i/(3779.5199999999995/(t/=e.renderCoordsHelper.unitInMeters))/Math.tan(r.fovX/2)}function bt(e,t,n){const r=e.state.camera,i=t*Math.tan(r.fovX/2);let o=3779.5199999999995/(r.width/2/r.pixelRatio/i);return 1===e.renderCoordsHelper.viewingMode&&(o/=Math.cos(S(n))),o*=e.renderCoordsHelper.unitInMeters,o}function Mt(e,t,n,r,i,o){return Rt(e,t,wt(e,n,t.latitude),r,i,o)}function Rt(e,t,n,r,i,o){if(It(o)){const s=new kt(o.signal);return zt(e,r.heading,r.tilt,t,n,i,s),void s.resolver.promise.then((t=>{const n=At(e,t,r.fov);if(!a(n))return o.resolver.resolve(n);o.resolver.reject()}),(e=>o.resolver.reject(e)))}const s=zt(e,r.heading,r.tilt,t,n,i);return At(e,s,r.fov,o)}function jt(e,t,n,r,i){return ht(e).directionToHeadingTilt(t,n,r,i)}function zt(e,t,n,r,o,a,s){const c=r&&r instanceof le?r:null;if(It(s))return async function(e,t,n){const r=M();if(t)if(t instanceof le){if(E(t,r,e.renderSpatialReference),null==t.z&&null!=e.basemapTerrain){const o=await e.elevationProvider.queryElevation(t.x,t.y,t.z,t.spatialReference,"ground",n);return i(o)&&e.renderCoordsHelper.setAltitude(r,o),r}}else h(r,t);else h(r,e.state.camera.center);return r}(e,r,s.signal).then((r=>{Tt(e,t,n,c,r,o,a,s)}),(e=>s.resolver.reject(e))),null;const l=function(e,t){const n=M();if(t&&t instanceof le){if(E(t,n,e.renderSpatialReference),null==t.z&&null!=e.basemapTerrain){const r=Me(e.elevationProvider,t);i(r)&&e.renderCoordsHelper.setAltitude(n,r)}}else h(n,t||e.state.camera.center);return n}(e,r);return Tt(e,t,n,c,l,o,a,s)}function Tt(e,t,n,r,i,s,c,l){if(a(r)){const t=e.renderSpatialReference;if(r=Z(i,t,dt(e)),a(r))return null}s=Math.max(s,e.state.constraints.minimumPoiDistance);const u=function(e,t,n,r,i,o){let s=0;1===o&&function(e,t,n){const r=e.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(n/r)/Math.LN2>8)return!0;const i=e.renderSpatialReference,o=dt(e),s=Z(t,i,o),c=Z(e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,i,o);if(a(s)||a(c))return!1;const l=Math.tan(.5*e.state.camera.fov)*r;return c.distance(s)/l>5}(e,r,i)?(t=0,s=function(e,t,n,r){const i=e.state.constraints.tilt(t);i.max=Math.min(i.max,.5*Math.PI);const o=i.min*(1-.7)+.7*i.max,a=Ht(e,r,t,n);return Math.min(a,o)}(e,i,n,r)):s=Ht(e,r,i,n);return s=e.state.constraints.clampTilt(i,s),n=Ct(e,r,i,s),{heading:t,tilt:n}}(e,t,n,i,s,c),f=(0,ht(e).eyeForCenterWithHeadingTilt)(i,s,u.heading,u.tilt);if(1===c&&"global"===e.viewingMode&&n>0){const a=()=>{const o=Ct(e,i,s,function(e,t,n,r){const i=e.state.constraints.tilt(t);let o=Ht(e,r,t,n);return o=Math.min(o,.5*Math.PI),i.min*(1-.7)+.7*o}(e,s,n,i));return Tt(e,t,o,r,i,s,c=n-o<1?0:1,l)},u=e.map.ground.navigationConstraint;if(!u||"stay-above"===u.type){if(function(e,t){return!!(e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(t,ft,e.spatialReference)&&o(Me(e.elevationProvider,ft),0)>ft.z-1)}(e,f.eye))return a();if(It(l))return async function(e,t,n){if(!e.renderCoordsHelper.fromRenderCoords(t,ft,e.spatialReference))return!1;const r=await e.elevationProvider.queryElevation(ft.x,ft.y,ft.z,ft.spatialReference,"ground",n);return o(r,0)>ft.z-1}(e,f.eye,l.signal).then((e=>e?a():(l.resolver.resolve({eye:f.eye,up:f.up,center:P(i),heading:f.heading,tilt:f.tilt}),null))),null}}const m=!l||It(l)?{center:M(),eye:M(),up:M(),tilt:0,heading:0}:l;return m.eye=f.eye,m.up=f.up,m.center=P(i),m.heading=f.heading,m.tilt=f.tilt,It(l)&&l.resolver.resolve(m),m}function St(e,t,n,r,i,s=null){const c=null!=t.zmax&&null!=t.zmin;let l,u,f;if("global"===e.viewingMode){if(!Re(t.spatialReference,"global"))return It(s)&&s.resolver.reject(),null;const e=new le(t.xmin,t.ymin,t.spatialReference),n=new le(t.xmax,t.ymax,t.spatialReference),r=t.spatialReference.isGeographic?pt:mt;l=new le({x:r.center(e.x,n.x),y:(n.y+e.y)/2,z:c?(t.zmax+t.zmin)/2:null,spatialReference:t.spatialReference});const i=ae(t.spatialReference),o=ve(l,e,n);u=o.lon,f=o.lat,r.diff(e.x,n.x)>r.range/2&&(u+=i.halfCircumference),u=Math.min(u,i.halfCircumference),f=Math.min(f,i.halfCircumference)}else{const n=o(e.renderSpatialReference,t.spatialReference);n.equals(t.spatialReference)||(t=q(t,n)),u=t.xmax-t.xmin,f=t.ymax-t.ymin;const r=c?(t.zmax+t.zmin)/2:null;l=new le({x:t.xmin+.5*u,y:t.ymin+.5*f,z:r,spatialReference:n})}const m=c?t.zmax-t.zmin:0,p=e.state.camera,d=1/Math.tan(p.fovX/2),h=1/Math.tan(p.fovY/2),g=1/Math.tan(p.fov/2),y=Math.max(.5*u*d,.5*f*h,.5*m*g)/1;if(It(s)){const t=new kt(s.signal);return zt(e,n,r,l,y,i,t),void t.resolver.promise.then((t=>{const n=At(e,t,e.camera.fov);if(!a(n))return s.resolver.resolve(n);s.resolver.reject()}),(e=>s.resolver.reject(e)))}const v=zt(e,n,r,l,y,i);return At(e,v,e.camera.fov,s)}function Gt(e,t,n){const r=e.renderSpatialReference,i=Z(n,r,dt(e));if(a(i))return null;const o=Math.tan(t.fovX/2),s=Math.tan(t.fovY/2),c=F(t.eye,n),l=2*c*o*1,u=2*c*s*1;return"global"===e.viewingMode?ot(e,i,l,u):Ye(e,i,l,u)}function Ct(e,t,n,r){return ht(e).lookAtTiltToEyeTilt(r,t,n)}function Ht(e,t,n,r){return ht(e).eyeTiltToLookAtTilt(r,t,n)}function At(t,n,r,o){if(a(n))return null;const s=t.renderSpatialReference,c=Z(n.eye,s,dt(t));return a(c)?null:i(o)?(o.position=c,o.heading=n.heading,o.tilt=n.tilt,o.fov=r,o):new e(c,n.heading,n.tilt,r)}function Pt(e,t){var n;const r=null==(n=e.basemapTerrain)?void 0:n.tilingScheme;if(r)return r.levelAtScale(t);st.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")}function Ft(e,t){var n;const r=null==(n=e.basemapTerrain)?void 0:n.tilingScheme;if(r)return r.scaleAtLevel(t);st.error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")}function Nt(t,n,r){const i=t.renderSpatialReference;let o,a;n||(n=t.state.camera);const s=ue.WGS84;return n instanceof e?(o=n.position.latitude,E(n.position,ct,i),E(r,lt,i),a=N(ct,lt)):(B(n.center,i,lt,s),o=lt[1],a=n.distance),bt(t,a,o)}class kt{constructor(e){this.signal=e,this.resolver=l()}}function It(e){return e&&"resolver"in e}function Et(e){return 360-be.normalize(e)}function Bt(e){return be.normalize(360-e)}function Zt(e){return i(e)&&e.resolver&&e.resolver.reject(),null}function qt(e,t,n,r=null){if(!t)return Zt(r);const o=e.spatialReference||ue.WGS84;if(i(t.camera)){const e=ie(t.camera.position,o);if(a(e))return Zt(r);const n=t.camera.clone();return n.position=e,function(e,t){return i(e)&&e.resolver&&e.resolver.resolve(t),t}(r,n)}if(a(t.targetGeometry))return Zt(r);const s=t.get("targetGeometry.spatialReference");if(s&&!oe(s,o))return Zt(r);const c=xt(e,e.state.camera);let l=1;if(null!=t.rotation&&(c.heading=Et(t.rotation),l=0),null!=n&&(c.tilt=n),"point"===t.targetGeometry.type){const n=t.targetGeometry;let i;const o=t.targetGeometry.clone();return i=null!=t.scale?wt(e,t.scale,n.latitude):e.state.camera.distance,Rt(e,o,i,c,l,r)}return St(e,t.targetGeometry.extent,c.heading,c.tilt,l,r)}function Ut(e,t,r=null){return a(r)&&(r=new n),Lt(e,null,t.clone(),r)}async function Wt(t,r,o){const a=function(e,t){if(!t||!e.spatialReference)return null;const n={target:null};if("declaredClass"in t||Array.isArray(t))n.target=t;else{for(const e in t)n[e]=t[e];t.center&&!n.target&&(n.target=t.center)}return n}(t,r);if(!a)throw new c("viewpointutils-create:no-target","Missing target for creating viewpoint");const l=new e({fov:t.camera.fov}),u=new n({camera:l});if(a.target instanceof n){const e=await async function(e,t,n,r,o){if(i(t.camera))return Yt(e,t.camera,o);o.scale=t.scale,o.rotation=t.rotation,o.targetGeometry=i(t.targetGeometry)?t.targetGeometry.clone():null,o.camera=null,null!=n.heading?o.rotation=Bt(n.heading):null!=n.rotation&&(o.rotation=n.rotation);const a=Ot(e,n);null!=a&&(o.scale=a);const s=new kt(r);return qt(e,o,n.tilt,s),o.camera=await s.resolver.promise,o}(t,a.target,a,o,u);return $t(e)}if(a.target instanceof e)return $t(Yt(t,a.target,u));const p=null!=a.scale||null!=a.zoom;if(a.target instanceof ge){const e=a.target.xmin===a.target.xmax||a.target.ymin===a.target.ymax;return $t(p||e?await Vt(t,a,a.target.center,l,o,u):await async function(e,t,n,r,i,o){o.targetGeometry=n.clone();const a=Ae(e);xt(e,a,r);const s=_t(r,t)?0:1,c=new kt(i);return St(e,n,r.heading,r.tilt,s,c),o.camera=await c.resolver.promise,o}(t,a,a.target,l,o,u))}const d={boundingBox:_(),hasZ:!1,screenSpaceObjects:[]},g=p?function(e,t){return function(e,t){return e.spatialReference?fe(t,e.spatialReference):void 0}(e,Ot(e,t))}(t,a):void 0;if(await Xt(t,a.target,g,d),isFinite(d.boundingBox[0])){let e;if(L(d.boundingBox,Jt),sn.x=Jt[0],sn.y=Jt[1],sn.z=Jt[2],sn.spatialReference=t.spatialReference,isFinite(sn.z)&&d.hasZ?e=X(d.boundingBox):(sn.z=void 0,e=te(D(d.boundingBox,tn))),p||e)return $t(await Vt(t,a,sn,l,o,u));const n=function(e,t){const n=.66;if(!t.length)return n;let r=Number.NEGATIVE_INFINITY;for(let e=0;e<t.length;e++){const n=t[e].screenSpaceBoundingRect;r=Math.max(r,Math.abs(n[0]),Math.abs(n[1]),Math.abs(n[2]),Math.abs(n[3]))}const i=Math.min(e.width,e.height);return n-r/i*2}(t,d.screenSpaceObjects);return $t(await async function(e,t,n,r,i,o,a,c){c.targetGeometry=n.clone();const l=Ae(e),u=function(e,t,n,r,i){let o=0;n.hasZ?o=n.z:e.basemapTerrain&&(o=s(Me(e.elevationProvider,n)));k(Jt,n.x,n.y,o),W(e.spatialReference,Jt,Kt,e.renderSpatialReference),f(Qt,Kt),m(Qt,Qt),_(en);const a=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];for(let t=0;t<a.length;t++){const n=a[t];let i=r[n[2]];isFinite(i)||(i=o),k(Jt,r[n[0]],r[n[1]],i),B(Jt,e.spatialReference,Jt,e.renderSpatialReference),Y(en,I(Jt,Jt,Qt))}const c=$(en),l=J(en),u=K(en),p=1/Math.tan(t.fovX/2),d=1/Math.tan(t.fovY/2),h=.5*Math.sqrt(c*c+u*u)*Math.max(d,p)+.5*l,g=.5*l*d+.5*Math.max(c,u);return Math.max(h,g)/i}(e,l,n,r,i);xt(e,l,o);const p=_t(o,t)?0:1;c.scale=bt(e,u,c.targetGeometry.latitude);const d=new kt(a);return Mt(e,c.targetGeometry,c.scale,o,p,d),c.camera=await d.resolver.promise,c}(t,a,sn,d.boundingBox,n,l,o,u))}return a.position?$t(function(e,t,n,r){const i=Ae(e);return h(nn,i.viewForward),jt(e,i.eye,nn,i.up,an),n.position=new le(t.position),n.heading=null!=t.heading?t.heading:an.heading,n.tilt=null!=t.tilt?t.tilt:an.tilt,Lt(e,null,n,r)}(t,a,l,u)):$t(await async function(e,t,n,r,i){const o=Ae(e),a=Z(o.center,e.renderSpatialReference,e.spatialReference);return Vt(e,t,a,n,r,i)}(t,a,l,o,u))}function Ot(e,t){return null==t.scale&&null!=t.zoom?Ft(e,t.zoom):t.scale}function _t(e,t){let n=!1;return null!=t.heading?(e.heading=t.heading,n=!0):null!=t.rotation&&(e.heading=Et(t.rotation),n=!0),null!=t.tilt&&(e.tilt=t.tilt,n=!0),null!=t.fov&&(e.fov=t.fov),n}function Lt(e,t,n,r){const o=e.spatialReference||ue.WGS84;return t=i(t)?t:yt(e,n),a(t)||(r.targetGeometry=Z(t.center,e.renderSpatialReference,o),r.scale=Nt(e,t),r.rotation=Bt(n.heading),r.camera=n),r}function Dt(e,t,n){if(!t)return;if(!oe(t.spatialReference,e.spatialReference))throw new c("viewpointutils:incompatible-spatialreference",`Spatial reference (${t.spatialReference?t.spatialReference.wkid:"unknown"}) is incompatible with the view (${e.spatialReference.wkid})`,{geometry:t});const r=[];if(!t.hasZ&&e.basemapTerrain){let n;switch(t.type){case"point":n=t;break;case"multipoint":case"polyline":n=t.extent.center;break;case"mesh":n=t.origin;break;case"extent":n=t.center;break;case"polygon":n=t.centroid}n&&oe(n,e.basemapTerrain.spatialReference)?Jt[2]=o(Me(e.elevationProvider,n),0):Jt[2]=0}(0,cn[t.type])(t,(e=>{r.push(e[0],e[1],e[2])}),Jt);const i=r.length/3;if(0===i)return;const a=new Array(r.length);if(U(r,t.spatialReference,0,a,e.spatialReference,0,i)){t.hasZ&&(n.hasZ=!0);for(let e=0;e<a.length;e+=3)t.hasZ?(Jt[0]=a[e+0],Jt[1]=a[e+1],Jt[2]=a[e+2]):(Jt[0]=a[e+0],Jt[1]=a[e+1]),Y(n.boundingBox,Jt)}}async function Xt(e,n,i,o){if(Array.isArray(n)&&2===n.length){const t=n[0],r=n[1];if("number"==typeof t&&"number"==typeof r)return sn.x=t,sn.y=r,sn.z=void 0,sn.spatialReference=e.spatialReference.isGeographic?e.spatialReference:ue.WGS84,void Dt(e,sn,o)}n&&"function"==typeof n.map?await u(n.map((t=>Xt(e,t,i,o)))):n instanceof je?Dt(e,n,o):n instanceof t&&await async function(e,t,n,i){const o=await r(e.whenViewForGraphic(t));if(!1===o.ok||a(o.value)||!("whenGraphicBounds"in o.value))return void Dt(e,t.geometry,i);const s=o.value,c=await r(s.whenGraphicBounds(t,{minDemResolution:n}));if(!1===c.ok)return void Dt(e,t.geometry,i);const{screenSpaceObjects:l,boundingBox:u}=c.value;V(i.boundingBox,u),l&&l.forEach((e=>{i.screenSpaceObjects.push(e)})),isFinite(u[2])&&(i.hasZ=!0)}(e,n,i,o)}function Yt(e,t,n){const r=e.spatialReference,i=ie(t.position,r);return a(i)?null:((t=t.clone()).fov=e.camera.fov,t.position=i,Lt(e,null,t,n))}async function Vt(e,t,n,r,i,o){if(a(n))throw new c("createfromcenter","invalid point");o.targetGeometry=n.clone();const s=Ae(e);if(t.position)return function(e,t,n,r,i,o){const a=e.renderSpatialReference;return E(n.position,rn,a),E(t,on,a),o.targetGeometry=new le(t),i.position=new le(n.position),v(nn,on,rn),jt(e,rn,nn,r.up,i),o.scale=bt(e,N(rn,on),o.targetGeometry.latitude),o.rotation=Bt(i.heading),o.camera=i,o}(e,o.targetGeometry,t,s,r,o);if(t.zoomFactor){const r=s.distance/t.zoomFactor,i=y(Jt,s.viewForward,-r);s.eye=x(Jt,s.center,i),o.scale=bt(e,r,n.latitude)}xt(e,s,r);const l=_t(r,t)?0:1;if(!t.zoomFactor){o.scale=Ot(e,t),null==o.scale&&(E(n,Jt,e.renderSpatialReference),ne(s.frustum,Jt)?o.scale=bt(e,N(s.eye,Jt),n.latitude):o.scale=Nt(e,s));const a=new kt(i);Mt(e,o.targetGeometry,o.scale,r,l,a),o.camera=await a.resolver.promise}return o}function $t(e){return e&&i(e.camera)&&(e.rotation=Bt(e.camera.heading)),e}const Jt=M(),Kt=d(),Qt=p(),en=O(),tn=ee(),nn=M(),rn=M(),on=M(),an={heading:0,tilt:0},sn=new le,cn={point(e,t,n){n[0]=e.x,n[1]=e.y,e.hasZ&&(n[2]=e.z),t(n)},polygon(e,t,n){const r=e.hasZ;for(let i=0;i<e.rings.length;i++){const o=e.rings[i];for(let e=0;e<o.length;e++)n[0]=o[e][0],n[1]=o[e][1],r&&(n[2]=o[e][2]),t(n)}},polyline(e,t,n){const r=e.hasZ;for(let i=0;i<e.paths.length;i++){const o=e.paths[i];for(let e=0;e<o.length;e++)n[0]=o[e][0],n[1]=o[e][1],r&&(n[2]=o[e][2]),t(n)}},multipoint(e,t,n){const r=e.points,i=e.hasZ;for(let e=0;e<r.length;e++)n[0]=r[e][0],n[1]=r[e][1],i&&(n[2]=r[e][2]),t(n)},extent(e,t,n){e.hasZ?(t(k(n,e.xmin,e.ymin,e.zmin)),t(k(n,e.xmax,e.ymin,e.zmin)),t(k(n,e.xmin,e.ymax,e.zmin)),t(k(n,e.xmax,e.ymax,e.zmin)),t(k(n,e.xmin,e.ymin,e.zmax)),t(k(n,e.xmax,e.ymin,e.zmax)),t(k(n,e.xmin,e.ymax,e.zmax)),t(k(n,e.xmax,e.ymax,e.zmax))):(t(k(n,e.xmin,e.ymin,n[2])),t(k(n,e.xmax,e.ymin,n[2])),t(k(n,e.xmin,e.ymax,n[2])),t(k(n,e.xmax,e.ymax,n[2])))},mesh(e,t,n){const r=e.vertexAttributes&&e.vertexAttributes.position;if(r)for(let e=0;e<r.length;e+=3)t(k(n,r[e+0],r[e+1],r[e+2]))}};var ln;let un=ln=class extends Te{constructor(e){super(e),this.absorption=0,this.cloudHeight=1,this.cloudSize=.5,this.coverage=.4,this.density=.5,this.detailSize=.5,this.smoothness=.7}clone(){return new ln(this.cloneConstructProperties())}cloneConstructProperties(){return{absorption:this.absorption,cloudHeight:this.cloudHeight,cloudSize:this.cloudSize,coverage:this.coverage,density:this.density,detailSize:this.detailSize,smoothness:this.smoothness}}};ze([Se({type:Number,nonNullable:!0,json:{write:!1}})],un.prototype,"absorption",void 0),ze([Se({type:Number,nonNullable:!0})],un.prototype,"cloudHeight",void 0),ze([Se({type:Number,nonNullable:!0})],un.prototype,"cloudSize",void 0),ze([Se({type:Number,nonNullable:!0})],un.prototype,"coverage",void 0),ze([Se({type:Number,nonNullable:!0})],un.prototype,"density",void 0),ze([Se({type:Number,nonNullable:!0})],un.prototype,"detailSize",void 0),ze([Se({type:Number,nonNullable:!0})],un.prototype,"smoothness",void 0),un=ln=ze([Ge("esri.view.3d.environment.Clouds")],un);var fn=un;export{fn as C,Wt as a,yt as b,qe as c,Gt as d,Ce as e,bt as f,Ut as g,gt as h,xt as i,Pt as j,Ae as k,St as l,zt as m,wt as n,jt as o,He as s,qt as t,Ft as z};
