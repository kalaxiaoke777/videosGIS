/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import"../geometry.js";import e from"../core/Error.js";import{b as t,i as n}from"../core/lang.js";import{a as o}from"./unitUtils.js";import{isLoaded as r,isSupported as i,load as a,project as s,getTransformation as l}from"../geometry/projection.js";import{project as c}from"../geometry/support/webMercatorUtils.js";import x from"../geometry/Extent.js";import f from"../geometry/Point.js";const m=function(e,t){const n=(e.isWGS84||e.isWebMercator)&&(t.isWGS84||t.isWebMercator);return!(e.equals(t)||n)},u={3395:20037508.342789244,3410:17334193.943686873,3832:3339584.723798206,3857:20037508.342788905,3975:17367530.445161372,4087:20037508.342789244,4088:20015108.787169147,6933:17367530.445161372,8858:7396237.374497803,8859:2465412.4581659334,32662:20037508.342789244,53001:20015086.79602057,53002:10007543.39801029,53003:20015086.79602057,53004:20015086.79602057,53016:14152803.599503474,53017:17333573.624304302,53025:7276828.3848298555,53031:10384677.558821043,53034:20015086.79602057,53036:7389443.187332862,53037:2463147.729110953,53079:20015114.352186374,53080:20015114.352186374,54001:20037508.342789244,54002:10018754.171394624,54003:20037508.342789244,54004:20037508.342789244,54016:14168658.027268292,54017:17367530.44516137,54025:7311399.09166516,54031:10396310.810074743,54034:20037508.342789244,54050:808820.9223376509,54053:1920897.3915568967,54079:20037508.342789244,54080:20037508.342789244,54100:20037508.342789244,54101:20037508.342789244,102038:4297258.582585486,102299:5013965.117483125};async function p(){if(r()||!i())return null;await a()}function h(t,n,o){if(!m(t.spatialReference,n))return null;if(!r())throw new e("rasterprojectionhelper-projectResolution","projection engine is not loaded");return o?l(n,t.spatialReference,t):l(t.spatialReference,n,t)}function y(n,o,i,a=null){if(n.spatialReference.equals(o))return n;const l=m(n.spatialReference,o);if(l&&!r())throw new e("rasterprojectionhelper-projectResolution","projection engine is not loaded");const f=i.center,u=new x({xmin:f.x-n.x/2,xmax:f.x+n.x/2,ymin:f.y-n.y/2,ymax:f.y+n.y/2,spatialReference:n.spatialReference}),p=l?s(u,o,a):c(u,o);if(t(p))return null;return{x:p.xmax-p.xmin,y:p.ymax-p.ymin}}function g(e,t=.01){return o(e)?t/o(e):0}function M(n,o,i=null,a=!0){const l=n.spatialReference;if(l.equals(o))return n;let x=c(n,o);if(t(x)){if(!r())throw new e("rasterprojectionhelper-projectResolution","projection engine is not loaded");x=s(n,o,i)}if(a&&o.isGeographic){const[e,t]=b(l,!0),o=g(l);o&&null!=e&&null!=t&&(Math.abs(n.x-e)<o&&Math.abs(180-x.x)<5e-4?x.x-=360:Math.abs(n.x-t)<o&&Math.abs(180+x.x)<5e-4&&(x.x+=360))}return x}function d(e){const t=j(e[0].spatialReference);if(e.length<2||!n(t))return e[0];let{xmin:o,xmax:r,ymin:i,ymax:a}=e[0];for(let n=1;n<e.length;n++){const o=e[n];r=o.xmax+t*n,i=Math.min(i,o.ymin),a=Math.max(a,o.ymax)}return new x({xmin:o,xmax:r,ymin:i,ymax:a,spatialReference:e[0].spatialReference})}function w(e,t,o=null,r=!0){if(e.spatialReference.equals(t))return e;const i=S(e),a=j(e.spatialReference,!0);if(!n(a)||0===i)return R(e,t,o,r);return d(e.clone().normalize().map((e=>R(e,t,o,r))))}function R(n,o,i=null,a=!0){const l=n.spatialReference;if(l.equals(o))return n;if(m(l,o)&&!r())throw new e("rasterprojectionhelper-projectExtent","projection engine is not loaded");let x=c(n,o);t(x)&&(x=s(n,o,i));let[u,p]=b(l,!0);if(x&&a&&l.isWebMercator&&o.isGeographic&&null!=u&&null!=p){const e=.001,t=1e3;if(Math.abs(n.xmin-u)<e&&Math.abs(p-n.xmax)>t&&Math.abs(180-x.xmax)<5e-4){x.xmin=-180;const e=[];e.push(new f(n.xmax,n.ymin,l)),e.push(new f(n.xmax,(n.ymin+n.ymax)/2,l)),e.push(new f(n.xmax,n.ymax,l));const t=e.map((e=>M(e,o,i))).filter((e=>!isNaN(null==e?void 0:e.x))).map((e=>e.x));x.xmax=Math.max.apply(null,t)}if(Math.abs(n.xmax-p)<e&&Math.abs(u-n.xmin)>t&&Math.abs(180+x.xmin)<5e-4){x.xmax=180;const e=[];e.push(new f(n.xmin,n.ymin,l)),e.push(new f(n.xmin,(n.ymin+n.ymax)/2,l)),e.push(new f(n.xmin,n.ymax,l));const t=e.map((e=>M(e,o,i))).filter((e=>!isNaN(null==e?void 0:e.x))).map((e=>e.x));x.xmin=Math.min.apply(null,t)}}[u,p]=b(o,!0);const h=g(o);return h&&null!=u&&null!=p&&(Math.abs(x.xmin-u)<h&&(x.xmin=u),Math.abs(x.xmax-p)<h&&(x.xmax=p)),x}function j(e,t=!1){const n=t?20037508.342787:20037508.342788905;return e.isWebMercator?2*n:e.wkid&&e.isGeographic?360:2*u[e.wkid]||null}function b(e,t=!1){const o=[],r=j(e,t);return n(r)&&(o.push(-r/2),o.push(r/2)),o}function v(e,t,n,o){let r=(e-t)/n;return r-Math.floor(r)!=0?r=Math.floor(r):o&&(r-=1),r}function S(e,t=!1){const o=j(e.spatialReference);if(!n(o))return 0;const r=t?0:-(o/2);return v(e.xmax,r,o,!0)-v(e.xmin,r,o,!1)}function N(e){const t=e.storageInfo.origin.x,o=j(e.spatialReference,!0);if(!n(o))return{originX:t,halfWorldWidth:null,pyramidsInfo:null};const r=o/2,{nativePixelSize:i,storageInfo:a,extent:s}=e,{maximumPyramidLevel:l,blockWidth:c,pyramidScalingFactor:x}=a;let f=i.x;const m=[],u=n(e.transform)&&"gcs-shift"===e.transform.type,p=t+r,h=u?o-t:r-t;for(let e=0;e<=l;e++){const e=(s.xmax-t)/f/c,n=e-Math.floor(e)==0?e:Math.ceil(e),r=(o/2-t)/f/c,i=r-Math.floor(r)==0?r:Math.ceil(r),a=Math.floor(p/f/c),l=Math.round(p/f)%c,u=(c-Math.round(h/f)%c)%c;m.push({resolutionX:f,blockWidth:c,datsetColumnCount:n,worldColumnCountFromOrigin:i,leftMargin:l,rightPadding:u,originColumnOffset:a}),f*=x}return{originX:t,halfWorldWidth:r,pyramidsInfo:m,hasGCSSShiftTransform:u}}function W(t,o,i,a=null,s=null,l=!1,c=[32,32]){if(m(t.spatialReference,o.spatialReference)&&!r())throw new e("rasterprojectionhelper-projectResolution","projection engine is not loaded");if(!(t&&o&&i))return null;const{xmin:x,ymin:u,xmax:p,ymax:h}=t,y=t.spatialReference,g=o.spatialReference,d=j(g);l=l||"gcs-shift"===(null==s?void 0:s.type);const w={x:c[0]*i.x,y:c[1]*i.y},R={cols:Math.ceil((p-x)/w.x-.1/c[0])+1,rows:Math.ceil((h-u)/w.y-.1/c[1])+1},b=w.x,v=w.y,S=[];let N,W=!1;for(let e=0;e<R.cols;e++){const t=[];for(let r=0;r<R.rows;r++){let i=M(new f({x:x+b*e,y:h-v*r,spatialReference:y}),g,a);s&&(i=s.inverseTransform(i)),t.push(i),e>0&&l&&i&&N[r]&&n(d)&&i.x<N[r].x&&(i.x+=d),i?(S.push((i.x-o.xmin)/(o.xmax-o.xmin)),S.push((o.ymax-i.y)/(o.ymax-o.ymin))):(S.push(NaN),S.push(NaN),W=!0)}N=t}const z=function(e,t){const n=(e[0]+e[4]+e[4*t.cols]+e[4*t.cols+4])/4,o=(e[1]+e[5]+e[4*t.rows+1]+e[4*t.rows+5])/4;return[Math.abs(n-e[2*t.rows+2]),Math.abs(o-e[2*t.rows+3])]}(S,R),G=new Float32Array((R.cols-1)*(R.rows-1)*2*6),P=new Float32Array([-0,-1,1,-1,1,-0,1,-0,-0]),C=new Float32Array([-1,1,0,0,-1,1,1,0,0]);for(let e=0;e<R.cols-1;e++){for(let t=0;t<R.rows-1;t++){let n=e*R.rows*2+2*t;const o=S[n],r=S[n+1],i=S[n+2],a=S[n+3];n+=2*R.rows;const s=S[n],l=S[n+1],c=S[n+2],x=S[n+3];let f=0,m=12*(t*(R.cols-1)+e);for(let e=0;e<3;e++)G[m++]=P[f++]*o+P[f++]*i+P[f++]*c;f=0;for(let e=0;e<3;e++)G[m++]=P[f++]*r+P[f++]*a+P[f++]*x;f=0;for(let e=0;e<3;e++)G[m++]=C[f++]*o+C[f++]*s+C[f++]*c;f=0;for(let e=0;e<3;e++)G[m++]=C[f++]*r+C[f++]*l+C[f++]*x}if(W)for(let e=0;e<G.length;e++)isNaN(G[e])&&(G[e]=-1)}return{offsets:S,error:z,coefficients:G,spacing:c,size:[R.cols-1,R.rows-1]}}function z(e){const t=e.clone().normalize();return 1===t.length?t[0]:d(t)}function G(e,t,o){const{storageInfo:r,pixelSize:i}=t;let a,s=!1;const{pyramidResolutions:l}=r;if(n(l)&&l.length){const n=(e.x+e.y)/2,r=l[l.length-1],c=(r.x+r.y)/2,x=(i.x+i.y)/2;if(n<=x)a=0;else if(n>=c)a=l.length,s=n/c>8;else{let e,t=x;for(let r=1;r<=l.length;r++){if(e=(l[r-1].x+l[r-1].y)/2,n<=e){n===e?a=r:"down"===o?(a=r-1,s=n/t>8):a="up"===o||n-t>e-n||n/t>2?r:r-1;break}t=e}}const m=0===a?i:l[a-1];return{pyramidLevel:a,pyramidResolution:new f({x:m.x,y:m.y,spatialReference:t.spatialReference}),excessiveReading:s}}const c=Math.log(e.x/i.x)/Math.LN2,x=Math.log(e.y/i.y)/Math.LN2,m=t.storageInfo.maximumPyramidLevel||0;a="down"===o?Math.floor(Math.min(c,x)):"up"===o?Math.ceil(Math.max(c,x)):Math.round((c+x)/2),a<0?a=0:a>m&&(s=a>m+3,a=m);const u=2**a;return{pyramidLevel:a,pyramidResolution:new f({x:u*t.nativePixelSize.x,y:u*t.nativePixelSize.y,spatialReference:t.spatialReference}),excessiveReading:s}}function P(e,t,n=512,r=!0){const{extent:i,spatialReference:a,pixelSize:s}=e,l=y(new f({x:s.x,y:s.y,spatialReference:a}),t,i);if(null==l)return{projectedPixelSize:null,scales:null,srcResolutions:null,isCustomTilingScheme:!1};const c=(l.x+l.y)/2,x=o(t),m=c*x*96*39.37,u=t.isGeographic?256/n*295828763.7958547:256/n*591657527.591555;let p="vector-magdir"===e.dataType||"vector-uv"===e.dataType;const h=w(i,t);p||r&&(t.isGeographic||t.isWebMercator)&&(p=h.xmin*h.xmax<0);let g,M=m;const d=1.001;if(p){M=u;const e=t.isGeographic?1341104507446289e-21:.29858214164761665,n=e*(96*x*39.37),o=t.isGeographic?4326:3857;g=y(new f({x:e,y:e,spatialReference:{wkid:o}}),a,h),g.x*=M/n,g.y*=M/n}else{g={x:s.x,y:s.y};const t=Math.ceil(Math.log(Math.min(e.width,e.height)/32)/Math.LN2);let n=0;for(;M<.5005*u&&n<t;)n++,M*=2,g.x*=2,g.y*=2;Math.max(M,u)/Math.min(M,u)<=d&&(M=u)}const R=[M],j=[{x:g.x,y:g.y}],b=Math.min(70.5310735,m)/d;for(;M>=b;)M/=2,g.x/=2,g.y/=2,R.push(M),j.push({x:g.x,y:g.y});return{projectedPixelSize:l,scales:R,srcResolutions:j,isCustomTilingScheme:!p}}export{z as a,y as b,w as c,W as d,N as e,P as f,S as g,h,p as l,M as p,G as s};
