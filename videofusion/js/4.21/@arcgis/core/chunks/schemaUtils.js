/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import"../renderers/ClassBreaksRenderer.js";import"../renderers/DictionaryRenderer.js";import"../renderers/DotDensityRenderer.js";import"../renderers/HeatmapRenderer.js";import"../renderers/Renderer.js";import e from"../renderers/SimpleRenderer.js";import"../renderers/UniqueValueRenderer.js";import"../renderers/support/jsonUtils.js";import t from"../core/Error.js";import{u as r,i,h as n,b as s,d as a,clone as l}from"../core/lang.js";import{L as o}from"./Logger.js";import{a as u,t as c}from"./screenUtils.js";import{fromJSON as f}from"../symbols/support/jsonUtils.js";import{b as d,a as p}from"./enums.js";import{l as m}from"./Utils11.js";import{c as y,h}from"./MaterialKey.js";import{g}from"./visualVariablesUtils2.js";import{C as b,R as x}from"./CIMSymbolHelper.js";import{u as v}from"./definitions.js";import{i as w,t as M,r as S,s as V}from"./mat2d.js";import{c as E}from"./mat2df32.js";import{s as I,a as z,f as j,j as T,t as F}from"./vec2.js";import{c as R}from"./vec2f32.js";import{c as N}from"./aaBoundingRect.js";import{d as k}from"./extentUtils.js";import{isPoint as O}from"../geometry/support/jsonUtils.js";import{normalizeMapX as P}from"../geometry/support/normalizeUtils.js";import{a as C}from"./normalizeUtilsCommon.js";import{g as L}from"../geometry/SpatialReference.js";import{b as B,s as K,g as q,a as U}from"./BidiText.js";import{c as A}from"./clusterUtils2.js";import{t as J}from"./util2.js";const D=Math.PI/180,$=E(),G=R(),H=512,W=50;function X(e,t){if(!t.isWrappable)return null;const[r,i]=C(t);return e[2]>i?[N([e[0],e[1],i,e[3]]),N([r,e[1],r+e[2]-i,e[3]])]:e[0]<r?[N([r,e[1],e[2],e[3]]),N([i-(r-e[0]),e[1],i,e[3]])]:null}function Y(e,t,r,i,n,s,a){if(!i||!r.symbol)return e[0]=e[1]=e[2]=e[3]=0,t[0]=t[1]=t[2]=t[3]=0,e;const l=i;if(!O(l)){k(e,l);let i=t[0];0===i&&(i=fe(r),t[0]=i);const s=n*i/2;return e[0]-=s,e[1]-=s,e[2]+=s,e[3]+=s,e}{const i=l.x,o=l.y;"esriTS"===r.symbol.type&&0===t[2]&&0===t[3]&&de(t,r.symbol,r.mosaicItem),function(e,t,r,i,n,s,a,l){let o;switch(i.type){case"esriSMS":case"esriPMS":o=oe(t,r,i,s,a,0);break;case"esriTS":o=ce(t,r,i,n,s,0);break;case"cim":case"CIMSymbolReference":case"expanded-cim":o=ue(t,r,i,s,a,0)}let u,c,f=0;for(let e=0;e<o.rings[0].length-1;e++)c=o.rings[0][e],u=(t-c[0])*(t-c[0])+(r-c[1])*(r-c[1]),f=Math.max(f,u);f=Math.sqrt(f);let d=P(t-f,l),p=P(t+f,l);if(d>p){const e=L(l);if(e){const[t,r]=e.valid;d=t,p=r}}e[0]=d,e[1]=r-f,e[2]=p,e[3]=r+f}(e,i,o,r.symbol,t,n,s,a)}return e}function Q(e){return"text"===e||"esriTS"===e}function Z(e){return"simple-marker"===e||"picture-marker"===e||"esriSMS"===e||"esriPMS"===e}function _(e){switch(r(e.geometry).type){case"point":case"multipoint":return 0;case"polyline":return 1;case"polygon":case"extent":return 2}return 0}const ee=R(),te=R(),re=R(),ie=R(),ne=R(),se=R(),ae=R();function le(e,t,r,i){I(re,t,r);const n=e.paths;let s,a,l,o,u,c,f,d,p,m=1/0;for(let e=0;e<n.length;e++){const y=n[e];if(!(y.length<2))for(let e=1;e<y.length;e++)s=y[e-1][0],l=y[e-1][1],a=y[e][0],o=y[e][1],u=Math.min(s,a)-i,c=Math.min(l,o)-i,f=Math.max(s,a)+i,d=Math.max(l,o)+i,t<u||t>f||r<c||r>d||(I(ee,s,l),I(te,a,o),z(ie,te,ee),z(ne,ee,re),j(se,ie,T(ie,ne)/T(ie,ie)),z(ae,ne,se),p=T(ae,ae),m>p&&(m=p))}return Math.sqrt(m)<=i}function oe(e,t,r,i,n,s){let a,l;const o=u(r.xoffset),c=u(r.yoffset),f=D*r.angle,d=D*s;switch(r.type){case"esriSMS":a=l=u(r.size);break;case"esriPMS":a=u(r.width),l=u(r.height)}n<.04&&(i=.04*i/n);const p=w($);M(p,p,I(G,e,t)),S(p,p,d-f),V(p,p,I(G,i,-i)),M(p,p,I(G,o,-c));const m=[0,0];F(m,I(G,-.5*a,-.5*l),p);const y=[0,0];F(y,I(G,-.5*a,.5*l),p);const h=[0,0];F(h,I(G,.5*a,-.5*l),p);const g=[0,0];return F(g,I(G,.5*a,.5*l),p),{rings:[[m,h,g,y,m]]}}function ue(e,t,r,i,n,s){const a=b.getEnvelope(r.data);if(!a)return null;n<.04&&(i=.04*i/n);const l=u(a.width),o=u(a.height),c=u(a.x),f=u(a.y),d=0*D,p=D*s,m=w($);M(m,m,I(G,e,t)),S(m,m,p-d),V(m,m,I(G,i,i));const y=[0,0];F(y,I(G,c,f+o),m);const h=[0,0];F(h,I(G,c,f),m);const g=[0,0];F(g,I(G,c+l,f+o),m);const x=[0,0];return F(x,I(G,c+l,f),m),{rings:[[y,g,x,h,y]]}}function ce(e,t,r,i,n,s){const a=u(r.xoffset),l=u(r.yoffset),o=D*r.angle,c=D*s,f=w($);M(f,f,I(G,e,t)),S(f,f,c),V(f,f,I(G,n,-n));const d=i[0]+i[2]/2,p=i[1]+i[3]/2;M(f,f,I(G,a,-l)),M(f,f,I(G,d,p)),S(f,f,o),M(f,f,I(G,-d,-p));const m=[0,0];F(m,I(G,i[0],i[1]),f);const y=[0,0];F(y,I(G,i[0],i[1]+i[3]),f);const h=[0,0];F(h,I(G,i[0]+i[2],i[1]),f);const g=[0,0];return F(g,I(G,i[0]+i[2],i[1]+i[3]),f),{rings:[[m,h,g,y,m]]}}function fe(e){switch(e.symbol.type){case"esriSFS":case"esriPFS":{const t=e.symbol.outline;return t?t.width:0}case"esriSLS":return u(e.symbol.width);case"esriSMS":{const t=e.symbol,r=u(t.xoffset),i=u(t.yoffset);return u(t.size)+Math.sqrt(r*r+i*i)}case"esriPMS":{const t=e.symbol,r=u(t.xoffset),i=u(t.yoffset);return u(Math.max(t.width,t.height))+Math.sqrt(r*r+i*i)}case"esriTS":{const t=[0,0,0,0];de(t,e.symbol,e.mosaicItem);const r=Math.max(Math.abs(t[0]),Math.abs(t[1]));return Math.max(t[2],t[3])+r}case"expanded-cim":{const t=b.getEnvelope(e.symbol.data);return t.width!==-1/0&&t.height!==-1/0||(t.width=10,t.height=10,t.x=0,t.y=0),u(Math.sqrt(t.width*t.width+t.height*t.height))}case"composite-symbol":{if(!e.symbol.layers.length)return 0;const t=e.symbol.layers.length-1;return fe({symbol:e.symbol.layers[t],mosaicItem:null})}default:return 0}}function de(e,t,r){if(!r||0===r.glyphMosaicItems.length)return e;const i=B(t.text)[1],n=r.glyphMosaicItems,s=K(n,i,{scale:u(t.font.size)/24,angle:t.angle,xOffset:t.xoffset,yOffset:t.yoffset,hAlign:q(t.horizontalAlignment||"center"),vAlign:U(t.verticalAlignment||"baseline"),maxLineWidth:Math.max(32,Math.min(t.lineWidth||512,512)),lineHeight:30*Math.max(.25,Math.min(t.lineHeight||1,4)),decoration:t.font.decoration||"none",isCIM:!1}).bounds;return e[0]=u(s.x-s.halfWidth),e[1]=u(s.y-s.halfHeight),e[2]=u(s.width),e[3]=u(s.height),e}const pe={"simple-marker":1,"picture-marker":1,text:0,"simple-line":0,"simple-fill":0,"picture-fill":0,cim:1,"web-style":1};function me(e){if(!("visualVariables"in e))return 0;if(!e.hasVisualVariables("size"))return 0;const t=e.getVisualVariablesForType("size");if(!t[0])return 0;const r=t[0];if("outline"===r.target)return 0;if("stops"===r.transformationType)return r.stops.map((e=>e.size)).reduce(Me,0);if("clamped-linear"===r.transformationType){let e=-1/0,t=-1/0;return e="number"==typeof r.maxSize?r.maxSize:r.maxSize.stops.map((e=>e.size)).reduce(Me,0),t="number"==typeof r.minSize?r.minSize:r.minSize.stops.map((e=>e.size)).reduce(Me,0),Math.max(e,t)}return"real-world-size"===r.transformationType?30:void 0}async function ye(e,t,r){if(!e||r&&"cluster"===r.type)return 0;if("heatmap"===e.type)return Math.round(3*e.blurRadius);if("dot-density"===e.type)return 0;if("dictionary"===e.type)return"esriGeometryPoint"===t||"esriGeometryMultipoint"===t?100:200;const i=e.getSymbols(),n=me(e),s=[];for(const e of i)s.push(ve(e,n));const a=await Promise.all(s);return u(a.reduce(Me,0))}const he=[0,0,0,0];function ge(e,t){return null==e?t:e}const be={sdf:!0,code:99,metrics:v.metrics,rect:new x(0,0,24,24),page:0,textureBinding:2};async function xe(e,t){if("simple-marker"===e.type){const r=Math.max(ge(e.size,12),t);return we(e)+.707*r}if("picture-marker"===e.type){const r=Math.max(ge(e.height,12),t),i=ge(e.width,12)*(r/ge(e.height,12))/2,n=r/2;return we(e)+Math.sqrt(i*i+n*n)}if("text"===e.type){const t=function(e){const t=e.text&&e.text.length;if(!t)return{glyphMosaicItems:[be]};const r=[];for(let i=0;i<t;i++)r.push({...be,code:e.text.charCodeAt(i)});return{glyphMosaicItems:r}}(e);de(he,e.toJSON(),t);const r=Math.abs(he[0]),i=Math.abs(he[1]),n=he[2],s=he[3];return Math.max(r,i)+Math.max(n,s)}if("simple-line"===e.type){const r=e,i=Math.max(ge(r.width,.75),t)/2;return r.marker?Math.max(6*r.width,2*t):i}if("simple-fill"===e.type||"picture-fill"===e.type)return Math.max(function(e,t){return null==e.outline?t:ge(e.outline.width,t)}(e,0),t)/2;if("cim"===e.type){const t=b.getEnvelope(e.data);return t?Math.sqrt(t.width*t.width+t.height*t.height):0}return"web-style"===e.type?xe(await e.fetchCIMSymbol(),t):0}async function ve(e,t){return function(e){return e.type in pe}(e)?Math.min(await xe(e,t),75):0}function we(e){const t=ge(e.xoffset,0),r=ge(e.yoffset,0);return Math.sqrt(t*t+r*r)}function Me(e,t){return Math.max(e,t)}const Se=o.getLogger("esri.renderers.visualVariables.support.utils"),Ve=e=>{if(!("visualVariables"in e)||!e.visualVariables||!e.visualVariables.length)return e;const t=e.clone(),r=t.visualVariables.map((e=>Ie(e)?ze(e):e));return t.visualVariables=r,t};function Ee(e){return e.map((e=>Ie(e)?ze(e.clone()):e))}function Ie(e){return("size"===e.type||"color"===e.type||"opacity"===e.type)&&null!=e.stops}function ze(e){return e.stops=function(e,t){if(t.length<=8)return t;if(Se.warn(`Found ${t.length} Visual Variable stops, but MapView only supports 8. Displayed stops will be simplified.`),t.length>16)return function(e,t){const[r,...i]=t,n=i.pop(),s=i[0].value,a=i[i.length-1].value,l=(a-s)/6,o=[];for(let r=s;r<a;r+=l){let n=0;for(;r>=i[n].value;)n++;const s=i[n],a=t[n-1],l=r-a.value,u=s.value===a.value?1:l/(s.value-a.value);if("color"===e){const e=i[n],s=t[n-1],a=e.color.clone();a.r=je(s.color.r,a.r,u),a.g=je(s.color.g,a.g,u),a.b=je(s.color.b,a.b,u),a.a=je(s.color.a,a.a,u),o.push({value:r,color:a,label:e.label})}else if("size"===e){const e=i[n],s=t[n-1],a=c(e.size),l=je(c(s.size),a,u);o.push({value:r,size:l,label:e.label})}else{const e=i[n],s=je(t[n-1].opacity,e.opacity,u);o.push({value:r,opacity:s,label:e.label})}}return[r,...o,n]}(e,t);return function(e){const[t,...r]=e,i=r.pop();for(;r.length>6;){let e=0,t=0;for(let i=1;i<r.length;i++){const n=r[i-1],s=r[i],a=Math.abs(s.value-n.value);a>t&&(t=a,e=i)}r.splice(e,1)}return[t,...r,i]}(t)}(e.type,e.stops),e}function je(e,t,r){return(1-r)*e+r*t}const Te=o.getLogger("esri.views.2d.layers.features.schemaUtils"),Fe={esriGeometryPoint:["above-right","above-center","above-left","center-center","center-left","center-right","below-center","below-left","below-right"],esriGeometryPolygon:["always-horizontal"],esriGeometryPolyline:["center-along"],esriGeometryMultipoint:null};function Re(e){return h(e)}function Ne(e){if("line-marker"===e.type){var t;return{type:"line-marker",color:null==(t=e.color)?void 0:t.toJSON(),placement:e.placement,style:e.style}}return f(e.toJSON()).toJSON()}function ke(e,t,r){if(!e)return null;let n=0,s=!1,a=0;switch(i(t)&&(a=me(t),"visualVariables"in t&&(n=function(e){if(!e)return d.NONE;let t=0;for(const r of e)if("size"===r.type){const e=g(r);t|=e,"outline"===r.target&&(t|=e<<4)}else"color"===r.type?t|=d.COLOR:"opacity"===r.type?t|=d.OPACITY:"rotation"===r.type&&(t|=d.ROTATION);return t}(t.visualVariables||[]),s="dot-density"===t.type)),e.type){case"simple-fill":case"picture-fill":return function(e,t,r,i){const n=y(p.FILL,t,!1,r),s=i?Re(n):n,a=e.clone(),l=a.outline;a.outline=null;const o=[],u={materialKey:s,hash:a.hash(),...Ne(a)};if(o.push(u),l){const e=y(p.LINE,t,!0,!1),r={materialKey:i?Re(e):e,hash:l.hash(),...Ne(l)};o.push(r)}return{type:"composite-symbol",layers:o,hash:o.reduce(((e,t)=>t.hash+e),"")}}(e,n,s,r);case"simple-marker":case"picture-marker":return function(e,t,r,i){const n=y(p.MARKER,t,!1,!1),s=i?Re(n):n,a=Ne(e);return{materialKey:s,hash:e.hash(),...a,angle:e.angle,maxVVSize:r}}(e,n,a,r);case"simple-line":return function(e,t,r){const i=y(p.LINE,t,!1,!1),n=r?Re(i):i,s=e.clone(),a=s.marker;s.marker=null;const l=[];if(l.push({materialKey:n,hash:s.hash(),...Ne(s)}),a){var o;const e=y(p.MARKER,t,!1,!1),i=r?Re(e):e;a.color=null!=(o=a.color)?o:s.color,l.push({materialKey:i,hash:a.hash(),lineWidth:s.width,...Ne(a)})}return{type:"composite-symbol",layers:l,hash:l.reduce(((e,t)=>t.hash+e),"")}}(e,n,r);case"text":return function(e,t,r,i){const n=y(p.TEXT,t,!1,!1),s=i?Re(n):n,a=Ne(e);return{materialKey:s,hash:e.hash(),...a,angle:e.angle,maxVVSize:r}}(e,n,a,r);case"label":return function(e,t,r){const i=e.toJSON(),n=y(p.LABEL,t,!1,!1,i.labelPlacement);return{materialKey:r?Re(n):n,hash:e.hash(),...i,labelPlacement:i.labelPlacement}}(e,n,r);case"cim":return{type:"cim",rendererKey:n,data:e.data,maxVVSize:a};case"web-style":return{...Ne(e),type:"web-style",hash:e.hash(),rendererKey:n,maxVVSize:a};default:throw new Error(`symbol not supported ${e.type}`)}}function Oe(e,r){const i=l(e),n=i.some((e=>function(e,r){const i=e.labelPlacement,n=Fe[r];if(!e.symbol)return Te.warn("No ILabelClass symbol specified."),!0;if(!n)return Te.error(new t("mapview-labeling:unsupported-geometry-type",`Unable to create labels for Feature Layer, ${r} is not supported`)),!0;if(!n.some((e=>e===i))){const t=n[0];i&&Te.warn(`Found invalid label placement type ${i} for ${r}. Defaulting to ${t}`),e.labelPlacement=t}return!1}(e,r)));return n?[]:i}function Pe(e){return n("esri-2d-update-debug")&&console.debug("Created new schema",Ce(e,!0)),Ce(e)}function Ce(r,n=!1){try{var a,l;const o=function(r,n=!1){const a=new Array;return a.push(function(r,n,a=!1){const l={indexCount:0,fields:{}},o="featureReduction"in r&&r.featureReduction,u=o?"aggregate":"feature";if("sublayers"in r){const e={type:"subtype",subtypeField:r.subtypeField,renderers:{}},n={type:"subtype",mapping:{},target:"feature"},s={type:"subtype",classes:{}},o={type:"symbol",target:"feature",aggregateFields:[],attributes:l,storage:n,mesh:{matcher:e,aggregateMatcher:null,labels:s,sortKey:null}},c=new Set;let f=0;for(const{renderer:o,subtypeCode:d,labelingInfo:p,labelsVisible:m}of r.sublayers){const r=De(l,u,o,a),y=Je(l,u,o),h=m&&p;if("visualVariables"in o&&o.visualVariables&&o.visualVariables.length)throw new t("ValidationError","Visual variables are currently not supported for subtype layers");if("dictionary"===r.type)throw new t("ValidationError","Dictionary renderer is not supported in subtype layers");if("subtype"===r.type)throw new t("ValidationError","Nested subtype renderers is not supported");if(i(y)&&"subtype"===y.type)throw new t("ValidationError","Nested subtype storage is not supported");if(i(y)&&"dot-density"===y.type)throw new t("ValidationError","Dot density attributes are not supported in subtype layers");if(c.has(d))throw new t("ValidationError","Subtype codes for sublayers must be unique");c.add(d),e.renderers[d]=r,n.mapping[d]=y,h&&(s.classes[d]=h.map((e=>Ae(o,l,e,"feature",f++,a))))}return o}if("heatmap"===r.renderer.type){const{blurRadius:e,fieldOffset:t,field:i}=r.renderer;return{type:"heatmap",aggregateFields:[],attributes:l,target:u,storage:null,mesh:{blurRadius:e,fieldOffset:t,field:qe(l,{target:u,field:i,resultType:"numeric"}).field}}}{const i=[],n="aggregate"===u?A(i,r.renderer,o,null):r.renderer;!function(e,t){const r={mesh:!0,storage:!0};for(const i of t){const{name:t,outStatistic:n}=i,{statisticType:s,onStatisticField:a}=n;let l=null,o=null,u=null;const c="numeric",f="feature";if("onStatisticValueExpression"in n){o=Ue(e,{type:"expression",target:f,valueExpression:n.onStatisticValueExpression,resultType:c}).fieldIndex}else if("onStatisticNormalizationField"in n){l=Ue(e,{type:"field",target:f,field:a,resultType:c}).field,u=n.onStatisticNormalizationField}else{l=Ue(e,{type:"field",target:f,field:a,resultType:c}).field}Ue(e,{type:"statistic",target:"aggregate",name:t,context:r,inField:l,inNormalizationField:u,inFieldIndex:o,statisticType:s})}}(l,i);const c=De(l,u,n,a);let f=null;const d=Je(l,u,n),p=J(r.geometryType);let m=r.labelsVisible&&r.labelingInfo||[],y=[];if(o){if("selection"===o.type)throw new t("ValidationError","Mapview does not support `selection` reduction type",o);if(o.symbol){const t=new e({symbol:o.symbol,visualVariables:"visualVariables"in n?n.visualVariables:null});f=De(l,u,t,a)}y=o&&o.labelsVisible&&o.labelingInfo||[]}m=Oe(m,p),y=Oe(y,p);let h=0;const g=[...m.map((e=>Ae(n,l,e,"feature",h++,a))),...y.map((e=>Ae(n,l,e,"aggregate",h++,a)))],b=function(e,r){if(s(r)||!r.length)return null;r.length>1&&Te.warn(`Layer rendering currently only supports ordering by 1 orderByInfo, but found ${r.length}. All but the first will be discarded`);const i=r[0],n="ascending"===i.order?"asc":"desc";if(i.field)return{field:i.field,order:n};if(i.valueExpression){return{fieldIndex:Ue(e,{type:"expression",target:"feature",valueExpression:i.valueExpression,resultType:"numeric"}).fieldIndex,order:n}}return Te.error(new t("ValidationError","Expected to find a field or valueExpression for OrderByInfo",i)),null}(l,r.orderBy);return{type:"symbol",target:u,attributes:l,aggregateFields:i,storage:d,mesh:{matcher:c,labels:{type:"simple",classes:g},aggregateMatcher:f,sortKey:b}}}}(r,n)),a}(r,n),c={};o.map((e=>function(e,r,i){switch(i.target){case"feature":return void Ke(e,Be(r),i);case"aggregate":{if(!("featureReduction"in r))return;const n=r.featureReduction;if("selection"===n.type)throw new t("ValidationError","Mapview does not support `selection` reduction type",n);return Ke(e,Be(r),i),void function(e,t,r){e.aggregate||(e.aggregate={name:"aggregate",input:"feature",filters:null,attributes:{},params:{clusterRadius:u(t.clusterRadius/2),clusterPixelBuffer:64*Math.ceil(u(t.clusterMaxSize)/64),fields:r.aggregateFields}});Le(e.aggregate,r.attributes.fields)}(e,n,i)}}}(c,r,e)));return{source:{definitionExpression:r.definitionExpression,fields:r.fields.map((e=>e.toJSON())),gdbVersion:r.gdbVersion,historicMoment:null==(a=r.historicMoment)?void 0:a.getTime(),outFields:r.availableFields,pixelBuffer:r.pixelBuffer,spatialReference:r.spatialReference.toJSON(),timeExtent:null==(l=r.timeExtent)?void 0:l.toJSON(),customParameters:r.customParameters},attributes:{fields:{},indexCount:0},processors:o,targets:c}}catch(e){if("ValidationError"===e.fieldName)return Te.error(e),null;throw e}}function Le(e,t){for(const r in t){const i=t[r];if(i.target!==e.name)continue;const n=e.attributes[r];n?(n.context.mesh=n.context.mesh||i.context.mesh,n.context.storage=n.context.storage||i.context.storage):e.attributes[r]=i}return e}function Be(e){var t,r,i,n,s;return[null!=(t=null==(r=e.filter)?void 0:r.toJSON())?t:null,null!=(i=null==(n=e.effect)||null==(s=n.filter)?void 0:s.toJSON())?i:null]}function Ke(e,t,r){return e.feature||(e.feature={name:"feature",input:"source",filters:t,attributes:{}}),Le(e.feature,r.attributes.fields),e}function qe(e,t){return t.field?Ue(e,{...t,type:"field",field:t.field}):t.valueExpression?Ue(e,{...t,type:"expression",valueExpression:t.valueExpression}):{field:null,fieldIndex:null}}function Ue(e,t){switch(t.type){case"expression":{const r=t.valueExpression;if(!e.fields[r]){const i=e.indexCount++;e.fields[r]={...t,name:r,fieldIndex:i}}return{fieldIndex:e.fields[r].fieldIndex}}case"label-expression":{const r=JSON.stringify(t.label);if(!e.fields[r]){const i=e.indexCount++;e.fields[r]={...t,name:r,fieldIndex:i}}return{fieldIndex:e.fields[r].fieldIndex}}case"field":{const r=t.field;return"aggregate"===t.target&&e.fields[r]||(e.fields[r]={...t,name:r}),{field:r}}case"statistic":return e.fields[t.name]={...t},{field:t.name}}}function Ae(e,t,r,i,n,s=!1){const a=Ue(t,{type:"label-expression",target:i,context:{mesh:!0},resultType:"string",label:{labelExpression:r.labelExpression,labelExpressionInfo:r.labelExpressionInfo?{expression:r.labelExpressionInfo.expression}:null,symbol:!!r.symbol,where:r.where}}),{fieldIndex:l}=a;return{...ke(r,e,s),fieldIndex:l,target:i,index:n}}function Je(e,t,r){switch(r.type){case"dot-density":return function(e,t,r){if(!r||!r.length)return{type:"dot-density",mapping:[],target:t};return{type:"dot-density",mapping:r.map(((r,i)=>{const{field:n,fieldIndex:s}=qe(e,{valueExpression:r.valueExpression,field:r.field,resultType:"numeric",target:t});return{binding:i,field:n,fieldIndex:s}})),target:t}}(e,t,r.attributes);case"simple":case"class-breaks":case"unique-value":case"dictionary":return function(e,t,r){if(!r||!r.length)return{type:"visual-variable",mapping:[],target:t};const i={storage:!0},n="numeric";return{type:"visual-variable",mapping:Ee(r).map((r=>{var s;const a=m(r.type),{field:l,fieldIndex:o}=qe(e,{target:t,valueExpression:r.valueExpression,field:r.field,context:i,resultType:n});switch(r.type){case"size":return"$view.scale"===r.valueExpression?null:{type:"size",binding:a,field:l,fieldIndex:o,normalizationField:qe(e,{target:t,field:r.normalizationField,context:i,resultType:n}).field,valueRepresentation:null!=(s=r.valueRepresentation)?s:null};case"color":return{type:"color",binding:a,field:l,fieldIndex:o,normalizationField:qe(e,{target:t,field:r.normalizationField,context:i,resultType:n}).field};case"opacity":return{type:"opacity",binding:a,field:l,fieldIndex:o,normalizationField:qe(e,{target:t,field:r.normalizationField,context:i,resultType:n}).field};case"rotation":return{type:"rotation",binding:a,field:l,fieldIndex:o}}})).filter((e=>e)),target:t}}(e,t,r.visualVariables);case"heatmap":return null}}function De(e,r,i,n=!1){const s=a(e,{indexCount:0,fields:{}});switch(i.type){case"simple":case"dot-density":return function(e,t,r,i=!1){const n=t.getSymbols();return{type:"simple",symbol:ke(n.length?n[0]:null,t,i),isDotDensity:r}}(0,i,"dot-density"===i.type,n);case"class-breaks":return function(e,t,r,i=!1){const n={mesh:!0,use:"renderer.field"},s=r.backgroundFillSymbol,{field:a,fieldIndex:l}=qe(e,{target:t,field:r.field,valueExpression:r.valueExpression,resultType:"numeric",context:n}),o=r.normalizationType,u="log"===o?"esriNormalizeByLog":"percent-of-total"===o?"esriNormalizeByPercentOfTotal":"field"===o?"esriNormalizeByField":null,c=r.classBreakInfos.map((e=>({symbol:ke(e.symbol,r,i),min:e.minValue,max:e.maxValue}))).sort(((e,t)=>e.min-t.min));return{type:"interval",attributes:e.fields,field:a,fieldIndex:l,backgroundFillSymbol:ke(s,r,i),defaultSymbol:ke(r.defaultSymbol,r,i),intervals:c,normalizationField:r.normalizationField,normalizationTotal:r.normalizationTotal,normalizationType:u,isMaxInclusive:r.isMaxInclusive}}(s,r,i,n);case"unique-value":return function(e,r,i,n=!1){const s=[],a=i.backgroundFillSymbol,l={target:r,context:{mesh:!0},resultType:"string"};if(i.field&&"string"!=typeof i.field)throw new t("ValidationError","Expected renderer.field to be a string",i);const{field:o,fieldIndex:u}=qe(e,{...l,field:i.field,valueExpression:i.valueExpression});for(const e of i.uniqueValueInfos)s.push({value:""+e.value,symbol:ke(e.symbol,i,n)});return{type:"map",attributes:e.fields,field:o,fieldIndex:u,field2:qe(e,{...l,field:i.field2}).field,field3:qe(e,{...l,field:i.field3}).field,fieldDelimiter:i.fieldDelimiter,backgroundFillSymbol:ke(a,i),defaultSymbol:ke(i.defaultSymbol,i),map:s}}(s,r,i,n);case"dictionary":return function(e,t,r=!1){return{type:"dictionary",renderer:t.toJSON()}}(0,i,n)}}export{W as P,H as T,Q as a,ce as b,oe as c,le as d,ue as e,_ as f,Y as g,De as h,Z as i,X as j,ke as k,ye as l,Pe as m,Ve as s};
