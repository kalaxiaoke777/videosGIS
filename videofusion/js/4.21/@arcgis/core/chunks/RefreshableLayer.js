/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import{L as r}from"./Logger.js";import{debounce as t,ignoreAbortErrors as s}from"../core/promiseUtils.js";import{property as o}from"../core/accessorSupport/decorators/property.js";import"../core/lang.js";import"./ensureType.js";import{subclass as n}from"../core/accessorSupport/decorators/subclass.js";import a from"../core/Collection.js";import{a as i}from"../core/Accessor.js";const h=new a,f=new WeakMap;function c(e){return e&&"object"==typeof e&&"refreshInterval"in e&&"refresh"in e}function m(e,r){return Number.isFinite(e)&&Number.isFinite(r)?r<=0?e:m(r,e%r):0}let p=0,l=0;function u(){const e=Date.now();for(const t of h)if(t.refreshInterval){var r;e-(null!=(r=f.get(t))?r:0)+5>=6e4*t.refreshInterval&&(f.set(t,e),t.refresh(e))}}function d(e){return e&&"object"==typeof e&&"refreshTimestamp"in e&&"refresh"in e}i((()=>{const e=Date.now();let r=0;for(const t of h)r=m(Math.round(6e4*t.refreshInterval),r),t.refreshInterval?f.get(t)||f.set(t,e):f.delete(t);if(r!==l){if(l=r,clearInterval(p),0===l)return void(p=0);p=setInterval(u,l)}}));const v=a=>{let i=class extends a{constructor(...e){super(...e),this.refreshInterval=0,this.refreshTimestamp=0,this._debounceHasDataChanged=t((()=>this.hasDataChanged())),this.when().then((()=>{var e;c(e=this)&&h.push(e)}),(()=>{}))}destroy(){var e;c(e=this)&&h.includes(e)&&h.remove(e)}get refreshParameters(){return{_ts:this.refreshTimestamp||null}}refresh(e=Date.now()){s(this._debounceHasDataChanged()).then((r=>{r&&(this._set("refreshTimestamp",e),this.emit("refresh"))}),(e=>{r.getLogger(this.declaredClass).error(e)}))}async hasDataChanged(){return!0}};return e([o({type:Number,cast:e=>e>=.1?e:e<=0?0:.1,json:{write:!0,origins:{"web-document":{write:!0}}}})],i.prototype,"refreshInterval",void 0),e([o({readOnly:!0})],i.prototype,"refreshTimestamp",void 0),e([o()],i.prototype,"refreshParameters",null),i=e([n("esri.layers.mixins.RefreshableLayer")],i),i};export{v as R,d as i};
