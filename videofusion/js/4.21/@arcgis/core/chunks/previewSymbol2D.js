/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import o from"../Color.js";import t from"../core/Error.js";import{a as s,p as e}from"./screenUtils.js";import{h as r,f as l,l as i}from"./utils2.js";import{s as m,v as a,i as p}from"./renderUtils.js";import"./colorUtils.js";import"./mathUtils.js";import"./common.js";import"../core/lang.js";import"./ensureType.js";import"./Logger.js";import"../config.js";import"./object.js";import"./string.js";import"./Message.js";import"../symbols.js";import"../core/accessorSupport/decorators/subclass.js";import"./metadata.js";import"./handleUtils.js";import"../symbols/CIMSymbol.js";import"./tslib.es6.js";import"../core/accessorSupport/decorators/property.js";import"./enumeration.js";import"./jsonMap.js";import"./reader.js";import"./writer.js";import"../layers/support/fieldUtils.js";import"./arcadeOnDemand.js";import"../geometry.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"./JSONSupport.js";import"../core/Accessor.js";import"./deprecate.js";import"./ArrayPool.js";import"./arrayUtils.js";import"../core/scheduling.js";import"../core/promiseUtils.js";import"../geometry/SpatialReference.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"./Ellipsoid.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./extentUtils.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"../symbols/Symbol.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils.js";import"../symbols/edges/Edges3D.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/StylePattern3D.js";import"./symbolLayerUtils3D.js";import"./aaBoundingBox.js";import"./aaBoundingRect.js";import"./Symbol3DOutline.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"../core/urlUtils.js";import"./persistableUrlUtils.js";import"../symbols/LabelSymbol3D.js";import"../core/Collection.js";import"./Evented.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../portal/Portal.js";import"../intl.js";import"./number.js";import"./locale.js";import"../request.js";import"../kernel.js";import"./assets.js";import"./Loadable.js";import"./Promise.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"./Thumbnail.js";import"./Symbol3DVerticalOffset.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"./asyncUtils.js";import"./ItemCache.js";import"./MemCache.js";import"../symbols/support/cimSymbolUtils.js";import"./utils3.js";import"./colorUtils2.js";import"./projector.js";import"./widgetUtils.js";import"./mat2df32.js";import"./mat2d.js";import"./jsxFactory.js";import"./jsxWidgetSupport.js";const n=document.createElement("canvas");function c(c,y){var j,u;const b=null!=(null==y?void 0:y.size)?s(y.size):null,d=null!=(null==y?void 0:y.maxSize)?s(y.maxSize):null,h=null!=(null==y?void 0:y.opacity)?y.opacity:null,f=null!=(null==y?void 0:y.rotation)?y.rotation:"angle"in c?c.angle:null,g=r(c);let S=l(c);if(g&&!S){const t="type"in g?null:new o(g);"#ffffff"===(t?t.toHex():null)&&(S={color:"#bdc3c7",width:.75})}const v={shape:null,fill:null,stroke:S,offset:[0,0]};null!=(j=S)&&j.width&&(S.width=Math.min(S.width,80));const M=(null==(u=S)?void 0:u.width)||0;let L=null!=b&&(null==(null==y?void 0:y.scale)||(null==y?void 0:y.scale)),D=0,U=0,w=!1;switch(c.type){case"simple-marker":{const o=c.style,t=Math.min(null!=b?b:s(c.size),d||120);switch(D=t,U=t,o){case"circle":v.shape={type:"circle",cx:0,cy:0,r:.5*t},L||(D+=M,U+=M);break;case"cross":v.shape={type:"path",path:[{command:"M",values:[0,.5*U]},{command:"L",values:[D,.5*U]},{command:"M",values:[.5*D,0]},{command:"L",values:[.5*D,U]}]};break;case"diamond":v.shape={type:"path",path:[{command:"M",values:[0,.5*U]},{command:"L",values:[.5*D,0]},{command:"L",values:[D,.5*U]},{command:"L",values:[.5*D,U]},{command:"Z",values:[]}]},L||(D+=M,U+=M);break;case"square":v.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[D,0]},{command:"L",values:[D,U]},{command:"L",values:[0,U]},{command:"Z",values:[]}]},L||(D+=M,U+=M),f&&(w=!0);break;case"triangle":v.shape={type:"path",path:[{command:"M",values:[.5*D,0]},{command:"L",values:[D,U]},{command:"L",values:[0,U]},{command:"Z",values:[]}]},L||(D+=M,U+=M),f&&(w=!0);break;case"x":v.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[D,U]},{command:"M",values:[D,0]},{command:"L",values:[0,U]}]},f&&(w=!0);break;case"path":v.shape={type:"path",path:c.path||""},L||(D+=M,U+=M),f&&(w=!0),L=!0}break}case"simple-line":{const o=Math.min(null!=b?b:M,d||80),t=o>22?2*o:40;S.width=o,D=t,U=o,v.shape={type:"path",path:[{command:"M",values:[0,U]},{command:"L",values:[D,U]}]};break}case"picture-fill":case"simple-fill":D=Math.min(null!=b?b:22,d||120)+M,U=D,L=!0,v.shape="object"==typeof(null==y?void 0:y.symbolConfig)&&null!=y&&y.symbolConfig.isSquareFill?m.squareFill[0]:m.fill[0];break;case"picture-marker":{let o=s(c.width),t=s(c.height);const e=null!=b?b:Math.max(o,t),r=o/t;o=r<=1?Math.ceil(e*r):e,t=r<=1?e:Math.ceil(e/r),D=Math.min(o,d||120),U=Math.min(t,d||120),v.shape={type:"image",x:-Math.round(D/2),y:-Math.round(U/2),width:D,height:U,src:c.url||""},f&&(w=!0);break}case"text":{const o=c,t=o.text||"Aa",r=o.font,l=Math.min(null!=b?b:s(r.size),d||120),i=function(o,t){const s=n.getContext("2d"),e=[];return t&&(t.weight&&e.push(t.weight),t.size&&e.push(t.size+"px"),t.family&&e.push(t.family)),s.font=e.join(" "),s.measureText(o).width}(t,{weight:r.weight,size:l,family:r.family}),m=/[\uE600-\uE6FF]/.test(t);D=m?l:i,U=l;let a=.25*function(o){if(0===o.length)return 0;if(o.length>2){const t=e(1),s=parseFloat(o);switch(o.slice(-2)){case"px":return s;case"pt":return s*t;case"in":return 72*s*t;case"pc":return 12*s*t;case"mm":return 2.8346456692913384*s*t;case"cm":return 28.346456692913385*s*t}}return parseFloat(o)}((r?l:0).toString());m&&(a+=5),v.shape={type:"text",text:t,x:0,y:a,align:"middle",decoration:r&&r.decoration,rotated:o.rotated,kerning:o.kerning},v.font=r&&{size:l,style:r.style,decoration:r.decoration,weight:r.weight,family:r.family};break}}if(!v.shape)return Promise.reject(new t("symbolPreview: renderPreviewHTML2D","symbol not supported."));const x=g,k=c.color;let P=null;return x&&"pattern"===x.type&&k&&"picture-fill"!==c.type?P=i(x.src,k.toCss(!0)).then((o=>(x.src=o,v.fill=x,v))):(v.fill=g,P=Promise.resolve(v)),P.then((o=>{const t=[[o]];if("object"==typeof(null==y?void 0:y.symbolConfig)&&null!=y&&y.symbolConfig.applyColorModulation){const s=.6*D;t.unshift([{...o,offset:[-s,0],fill:a(g,-.3)}]),t.push([{...o,offset:[s,0],fill:a(g,.3)}]),D+=2*s}return p(t,[D,U],{node:y&&y.node,scale:L,opacity:h,rotation:f,useRotationSize:w})}))}export{c as previewSymbol2D};
