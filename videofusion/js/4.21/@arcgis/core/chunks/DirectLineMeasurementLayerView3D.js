/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import{j as t,b as i,d as s,i as r}from"../core/lang.js";import{property as o}from"../core/accessorSupport/decorators/property.js";import"./ensureType.js";import"./Logger.js";import{subclass as a}from"../core/accessorSupport/decorators/subclass.js";import{d as n}from"./defaultUnit.js";import{L as l}from"./LayerView3D.js";import p,{e as m,a as d}from"../core/Accessor.js";import c from"../core/Handles.js";import{b as h,w as u,m as g,r as y,i as _,e as v,n as j,s as b,a as w,t as f,af as L,f as S,g as P,ae as C,S as V}from"./mathUtils.js";import{U as E,Q as D,L as M,G as O,E as z,f as A,a as x,b as U,c as T,d as R,e as G,s as I,g as F}from"./Segment.js";import{whenOnce as H}from"../core/watchUtils.js";import{geodesicLength as W}from"../geometry/geometryEngine.js";import k from"../geometry/Polyline.js";import{canProjectWithoutEngine as q,projectPointToVector as B,projectPointToWGS84ComparableLonLat as Q}from"../geometry/projection.js";import{c as N,g as $,S as J,W as Z}from"./projectionEllipsoid.js";import{isSupported as K,geodesicLengths as X,inverseGeodeticSolver as Y}from"../geometry/support/geodesicUtils.js";import{g as ee}from"./ElevationProvider.js";import{fetchMessageBundle as te}from"../intl.js";import{d as ie,f as se}from"./screenUtils.js";import{j as re,c as oe}from"./unitUtils.js";import{j as ae}from"./vec2.js";import{f as ne}from"./vec4f32.js";import{a as le}from"./vec4f64.js";import{O as pe,L as me}from"./LineVisualElement.js";import{c as de}from"./mat4f64.js";import{b as ce}from"./vectorStacks.js";import{G as he}from"./ColorMaterial.js";import{n as ue}from"./InterleavedLayout.js";import{S as ge,g as ye,p as _e,a as ve,b as je,c as be,P as we,D as fe,h as Le,$ as Se,G as Pe,H as Ce,a9 as Ve,aa as Ee,a8 as De}from"./OutputDepth.glsl.js";import{m as Me,c as Oe,d as ze}from"./VertexArrayObject.js";import{R as Ae}from"./RightAngleQuadVisualElement.js";import{a as xe}from"./lineStippleUtils.js";import{o as Ue}from"./locale.js";import Te from"../views/layers/LayerView.js";import"./metadata.js";import"./handleUtils.js";import"../config.js";import"./object.js";import"./string.js";import"./Message.js";import"./heightModelInfoUtils.js";import"../core/Error.js";import"../geometry/HeightModelInfo.js";import"./arrayUtils.js";import"./jsonMap.js";import"./JSONSupport.js";import"./reader.js";import"./writer.js";import"./deprecate.js";import"./ArrayPool.js";import"../core/scheduling.js";import"../core/promiseUtils.js";import"../geometry/SpatialReference.js";import"./Ellipsoid.js";import"./arcgisLayerUrl.js";import"../core/urlUtils.js";import"./persistableUrlUtils.js";import"../core/Collection.js";import"./Evented.js";import"./common.js";import"../widgets/Attachments.js";import"./number.js";import"../core/accessorSupport/decorators/aliasOf.js";import"../core/accessorSupport/decorators/cast.js";import"../widgets/Widget.js";import"./domUtils.js";import"./Promise.js";import"./uuid.js";import"./projector.js";import"./widgetUtils.js";import"./assets.js";import"../request.js";import"../kernel.js";import"./jsxWidgetSupport.js";import"../widgets/Attachments/AttachmentsViewModel.js";import"../Graphic.js";import"../geometry.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../geometry/Point.js";import"../geometry/support/webMercatorUtils.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./extentUtils.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"../PopupTemplate.js";import"../layers/support/fieldUtils.js";import"./arcadeOnDemand.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"./enumeration.js";import"../popup/support/FieldInfoFormat.js";import"./date.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"./chartMediaInfoUtils.js";import"./MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/TextContent.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../support/actions/ActionBase.js";import"./Identifiable.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../symbols.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../Color.js";import"./colorUtils.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils.js";import"../symbols/edges/Edges3D.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/StylePattern3D.js";import"./symbolLayerUtils3D.js";import"./aaBoundingBox.js";import"./aaBoundingRect.js";import"./Symbol3DOutline.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../portal/Portal.js";import"./Loadable.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"./Thumbnail.js";import"./Symbol3DVerticalOffset.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"../core/HandleOwner.js";import"../rest/query/support/AttachmentInfo.js";import"../rest/support/AttachmentQuery.js";import"./messageBundle.js";import"./jsxFactory.js";import"./viewUtils.js";import"./VisualElement.js";import"./mathUtils2.js";import"./geometryEngineBase.js";import"./hydrated.js";import"./mat4.js";import"./pe.js";import"./geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"./Intersector.js";import"./ray.js";import"./boundedPlane.js";import"./lineSegment.js";import"./plane.js";import"./sphere.js";import"./verticalOffsetUtils.js";import"./Util.js";import"./vec2f64.js";import"./mat3.js";import"./quatf64.js";import"./quat.js";import"./vec3f32.js";import"./ScreenSpacePass.js";import"./dehydratedFeatures.js";import"./byteSizeEstimations.js";import"./quantizationUtils.js";import"../layers/support/Field.js";import"./domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"./fieldType.js";import"./frustum.js";import"./lineUtils.js";import"./triangulationUtils.js";import"./earcut.js";import"./deduplicate.js";import"./compilerUtils.js";import"./MapUtils.js";import"./vec2f32.js";import"./FramebufferObject.js";import"./Texture.js";import"./Camera.js";import"./geometryDataUtils.js";import"./triangle.js";import"./PhysicallyBasedRendering.glsl.js";import"./glUtil.js";import"./Scheduler.js";import"./PromiseQueue.js";import"./debugFlags.js";import"./VertexColor.glsl.js";import"./BufferView.js";import"./types.js";import"./mat4f32.js";let Re=class extends p{constructor(e){super(e),this._unitNormalizer=new E,this._handles=new c,this._tempStartPosition=h(),this._tempEndPosition=h(),this._tempCornerPosition=h()}initialize(){this._handles.add(H(this.view,"ready",(()=>this._initialize()),!0))}destroy(){this._handles=t(this._handles)}_initialize(){const e=this.view.spatialReference,t=N(e),i=t===J?Z:t;this._sphericalPCPF=i;const s=q(e,i);this._unitNormalizer.spatialReference=s?i:e,this._handles.add([m((()=>({viewData:this.viewData,startPoint:this.layer.startPoint})),(({viewData:e,startPoint:t})=>{e.elevationAlignedStartPoint=this._applyElevationAlignment(t)})),m((()=>({viewData:this.viewData,endPoint:this.layer.endPoint})),(({viewData:e,endPoint:t})=>{e.elevationAlignedEndPoint=this._applyElevationAlignment(t)})),m((()=>({result:this._computedResult,viewData:this.viewData})),(({result:e,viewData:t})=>{t.result=e}))])}_applyElevationAlignment(e){if(i(e)||e.hasZ)return e;const t=e.clone();return t.z=s(ee(this.view.elevationProvider,t),0),t}get _computedResult(){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:t}=this.viewData;if(i(e)||i(t))return null;const s=this._euclideanDistances(e,t),r=this._exactGeodesicDistanceAndAngle(e,t,s.horizontal.value);return{directDistance:s.direct,horizontalDistance:s.horizontal,verticalDistance:s.vertical,geodesicDistance:r.distance,geodesicAngle:r.angle}}_euclideanDistances(e,t){const i=e.clone();i.z=t.z;const s=this._tempStartPosition,r=this._tempEndPosition,o=this._tempCornerPosition,a=this.view.spatialReference,n=this._sphericalPCPF,l=q(a,n)?n:a;B(e,s,l),B(t,r,l),B(i,o,l);const p=u(s,r),m=u(o,r),d=Math.abs(t.z-e.z),c=e=>this._unitNormalizer.normalizeDistance(e),h=c(p),g=c(m),y=c(d);return{direct:new D(h,"meters"),horizontal:new D(g,"meters"),vertical:new D(y,"meters")}}_exactGeodesicDistanceAndAngle(e,t,i){const s=e.spatialReference,r=new k({spatialReference:s});r.addPath([e,t]);const o=s.isGeographic&&K(s)?X([r],"meters")[0]:s.isWebMercator?W(r,"meters"):void 0,{distance:a,angle:n}=o?{distance:o,angle:this._fallbackGeodesicAngle(o,s)}:this._fallbackGeodesicDistance(e,t,i);return{distance:new D(a,"meters"),angle:new D(n,"degrees")}}_fallbackGeodesicAngle(e,t){return e/$(t).metersPerDegree}_fallbackGeodesicDistance(e,t,i){if(Q(e,Ge)){Q(t,Ie);const e=g(Ge[0]),i=g(Ge[1]),s=g(Ie[0]),r=g(Ie[1]),o=Math.abs(s-e),a=_(Math.sin(i)*Math.sin(r)+Math.cos(i)*Math.cos(r)*Math.cos(o)),n=y(a),l={distance:0};return Y(l,[Ge[0],Ge[1]],[Ie[0],Ie[1]]),{distance:l.distance,angle:n}}const s=e.spatialReference,r=i;return{distance:r,angle:this._fallbackGeodesicAngle(r,s)}}};e([o()],Re.prototype,"view",void 0),e([o()],Re.prototype,"layer",void 0),e([o()],Re.prototype,"viewData",void 0),e([o()],Re.prototype,"_computedResult",null),Re=e([a("esri.views.3d.layers.analysis.DirectLineMeasurement/DirectLineMeasurementController")],Re);const Ge=h(),Ie=h();var Fe=Object.freeze({__proto__:null,build:function(){const e=new ge;e.vertex.uniforms.add("proj","mat4").add("view","mat4").add("width","float"),e.attributes.add("position","vec3"),e.attributes.add("normal","vec3"),e.attributes.add("uv0","vec2"),e.attributes.add("auxpos1","float"),e.varyings.add("vtc","vec2"),e.varyings.add("vlength","float"),e.varyings.add("vradius","float"),e.vertex.code.add(ye`void main(void) {
vec3 bitangent = normal;
vtc = uv0;
vlength = auxpos1;
vradius = 0.5 * width;
vec4 pos = view * vec4(position + vradius * bitangent * uv0.y, 1.0);
gl_Position = proj * pos;
}`),e.fragment.uniforms.add("outlineSize","float").add("outlineColor","vec4").add("stripeLength","float").add("stripeEvenColor","vec4").add("stripeOddColor","vec4");const t=1/Math.sqrt(2);return e.fragment.code.add(ye`
    const float INV_SQRT2 = ${ye.float(t)};

    vec4 arrowColor(vec2 tc, float len) {
      float d = INV_SQRT2 * (tc.x - abs(tc.y));
      d = min(d, INV_SQRT2 * (len - tc.x - abs(tc.y)));
      d = min(d, 1.0 - abs(tc.y));

      if (d < 0.0) {
        return vec4(0.0);
      } else if (d < outlineSize) {
        return outlineColor;
      } else {
        return fract(0.5 / stripeLength * tc.x * vradius) >= 0.5 ? stripeOddColor : stripeEvenColor;
      }
    }

    void main(void) {
      vec2 ntc = vec2(vtc.x / vradius, vtc.y);
      vec4 color = arrowColor(ntc, vlength / vradius);
      if (color.a == 0.0) {
        discard;
      }
      gl_FragColor = color;
    }
  `),e}});class He extends be{constructor(e,t,i){super(e,t,i)}initializeProgram(e){const t=He.shader.get().build();return new we(e.rctx,t,fe)}bindPass(e,t){Le(this.program,t.camera.projectionMatrix),this.program.setUniform1f("width",e.width),this.program.setUniform1f("outlineSize",e.outlineSize),this.program.setUniform4fv("outlineColor",e.outlineColor),this.program.setUniform1f("stripeLength",e.stripeLength),this.program.setUniform4fv("stripeEvenColor",e.stripeEvenColor),this.program.setUniform4fv("stripeOddColor",e.stripeOddColor)}bindDraw(e){Se(this.program,e),this.program.rebindTextures()}setPipelineState(e){const t=3===e,i=this.configuration;return Me({blending:i.transparent?t?Pe:Ce(e):null,polygonOffset:this.configuration.polygonOffsetEnabled&&{factor:0,units:-4},depthTest:{func:513},depthWrite:Oe,colorWrite:ze})}initializePipeline(){return this.setPipelineState(this.configuration.transparencyPassType)}get primitiveType(){return 5}}He.shader=new ve(Fe,(()=>Promise.resolve().then((function(){return Fe}))));class We extends je{constructor(){super(...arguments),this.polygonOffsetEnabled=!1,this.transparent=!1,this.transparencyPassType=3}}e([_e()],We.prototype,"polygonOffsetEnabled",void 0),e([_e()],We.prototype,"transparent",void 0),e([_e({count:4})],We.prototype,"transparencyPassType",void 0);class ke extends Ve{constructor(e){super(e,Be),this.techniqueConfig=new We}getTechniqueConfig(e){return this.techniqueConfig.polygonOffsetEnabled=this.params.polygonOffset,this.techniqueConfig.transparent=this.params.stripeEvenColor[3]<1||this.params.stripeOddColor[3]<1||this.params.outlineColor[3]<1,this.techniqueConfig.transparencyPassType=e?e.transparencyPassType:3,this.techniqueConfig}dispose(){}getPassParameters(){return this.params}intersect(){}createBufferWriter(){return new Xe}getGLMaterial(e){return 0===e.output?new qe(e):void 0}}class qe extends Ee{constructor(e){super(e),this.updateParameters()}updateParameters(e){this._technique=this._techniqueRep.releaseAndAcquire(He,this._material.getTechniqueConfig(e),this._technique)}beginSlot(e){return 3===e}bind(e){this._technique.bindPass(this._material.getPassParameters(),e)}}const Be={width:32,outlineSize:.2,outlineColor:[1,.5,0,1],stripeLength:1,stripeEvenColor:[1,1,1,1],stripeOddColor:[1,.5,0,1],polygonOffset:!1,...De},Qe=ue().vec3f("position").vec3f("normal").vec2f("uv0").f32("auxpos1"),Ne=h(),$e=h(),Je=h(),Ze=h(),Ke=h();class Xe{constructor(){this.vertexBufferLayout=Qe}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return 2*(e.indices.get("position").length/2+1)}write(e,t,i,s){const r=t.vertexAttributes.get("position").data,o=t.vertexAttributes.get("normal").data,a=r.length/3,n=t&&t.indices&&t.indices.get("position");n&&n.length!==2*(a-1)&&console.warn("MeasurementArrowMaterial does not support indices");const l=Ne,p=$e,m=Je,d=Ze,c=Ke,h=e.transformation,g=e.invTranspTransformation,y=i.position,_=i.normal,L=i.uv0;let S=0;for(let e=0;e<a;++e){const t=3*e;if(v(l,r[t],r[t+1],r[t+2]),e<a-1){const t=3*(e+1);v(p,r[t],r[t+1],r[t+2]),v(c,o[t],o[t+1],o[t+2]),j(c,c),b(m,p,l),j(m,m),w(d,c,m),j(d,d)}const i=u(l,p);h&&g&&(f(l,l,h),f(p,p,h),f(d,d,g));const n=s+2*e,P=n+1;y.setVec(n,l),y.setVec(P,l),_.setVec(n,d),_.setVec(P,d),L.set(n,0,S),L.set(n,1,-1),L.set(P,0,S),L.set(P,1,1),e<a-1&&(S+=i)}const P=i.auxpos1;for(let e=0;e<2*a;++e)P.set(s+e,S)}}class Ye extends pe{constructor(e){super(e),this._parameters=et,this._handles=null,this._origin=h(),this._originTransform=de(),this._arrowCenter=h(),this._renderOccluded=4,this._geometry=null,this._stripeLength=1,this._stripesEnabled=!0,this._opacity=1,this.applyProps(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._arrowMaterial&&this._arrowMaterial.setParameterValues({renderOccluded:e}))}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.geometryChanged()}get stripeLength(){return this._stripeLength}set stripeLength(e){this._stripeLength=e,this.attached&&this._arrowMaterial.setParameterValues({stripeLength:this._stripeLength})}get stripesEnabled(){return this._stripesEnabled}set stripesEnabled(e){if(this._stripesEnabled=e,this.attached){const e=this.opacity,{arrowStripeEvenColor:t,arrowStripeOddColor:i}=this._parameters,s=L(tt,this._stripesEnabled?t:i,e);this._arrowMaterial.setParameterValues({stripeEvenColor:s})}}get opacity(){return this._opacity}set opacity(e){e!==this._opacity&&(this._opacity=e,this._updateArrowOpacity())}createExternalResources(){const{arrowStripeEvenColor:e,arrowStripeOddColor:t,arrowOutlineColor:i}=this._parameters,s=this._stripesEnabled?e:t;this._arrowMaterial=new ke({outlineColor:i,stripeEvenColor:s,stripeOddColor:t,renderOccluded:this.renderOccluded,polygonOffset:!0}),this._handles=new c,this._handles.add(this.view.state.watch("camera",(()=>{this.viewChanged()})))}destroyExternalResources(){this._arrowMaterial=null,this._handles.destroy(),this._handles=null}forEachExternalMaterial(e){e(this._arrowMaterial)}createGeometries(e){if(i(this._geometry)||i(this._geometry.startRenderSpace)||i(this._geometry.endRenderSpace))return;const t=this._createArrowGeometry(this._geometry.startRenderSpace,this._geometry.endRenderSpace,this._origin,this._geometry);e.addGeometry(t,this._arrowMaterial,this._originTransform),this.viewChanged()}_createArrowGeometry(e,t,i,s){const r=this.view.renderCoordsHelper,o=[],a=[],n=(e,t)=>{const s=ce.get();b(s,e,i),o.push(s),a.push(t)};if("euclidean"===s.type){s.eval(.5,this._arrowCenter);const i=ce.get();r.worldUpAtPosition(this._arrowCenter,i),n(e,i),n(t,i)}else{s.eval(.5,this._arrowCenter);const e=this._parameters.arrowSubdivisions+1&-2;for(let t=0;t<e;++t){const i=t/(e-1),o=ce.get(),a=ce.get();s.eval(i,o),r.worldUpAtPosition(o,a),n(o,a)}}return he.createPolylineGeometry(o,a)}geometryChanged(){this.recreateGeometry()}viewChanged(){if(this.view.ready&&this.attached&&r(this._geometry)){const e=this.view.state.camera.computeScreenPixelSizeAt(this._arrowCenter);this._arrowMaterial.setParameterValues({width:this._parameters.arrowWidth*e})}}_updateArrowOpacity(){const e=this.opacity,{arrowStripeEvenColor:t,arrowStripeOddColor:i,arrowOutlineColor:s}=this._parameters,r=L(tt,this._stripesEnabled?t:i,e),o=L(it,s,e),a=L(st,i,e);this._arrowMaterial.setParameterValues({stripeEvenColor:r,outlineColor:o,stripeOddColor:a})}}const et={arrowWidth:16,arrowOutlineColor:[1,.5,0,1],arrowOutlineWidth:.2,arrowStripeEvenColor:[1,1,1,1],arrowStripeOddColor:[1,.5,0,1],arrowStripeLength:16,arrowSubdivisions:128},tt=le(),it=le(),st=le();let rt=class extends p{constructor(e){super(e),this._params={...at},this._handles=new c,this._segmentVisualElement=null,this._triangleVisualElement=null,this._rightAngleQuad=null,this._projectedGeodesicLine=null,this._geodesicStartHint=null,this._geodesicEndHint=null,this._segmentLabel=null,this._verticalLabel=null,this._horizontalLabel=null,this._startPosition=h(),this._endPosition=h(),this._cornerPosition=h(),this._startPositionAtSeaLevel=h(),this._endPositionAtSeaLevel=h(),this._state=0,this._segmentLabelDisplayedMeasurement=1,this._triangleOrientationOverride=null,this.messages=null,this.loadingMessages=!0,this.viewMode=0,this.visualizedMeasurement=0,this.actualVisualizedMeasurement=1,this.visualElementOrientation=0,this.triangleCollapseRatioThreshold=.03}get _geodesicDistanceExceeded(){var e;const t=this.layerView.result;return r(t)&&(null==(e=t.horizontalDistance)?void 0:e.value)>this.layer.geodesicDistanceThreshold}get ready(){return 1===this._state}get visible(){return this.layerView.visible&&!this.layerView.suspended}get allowVisualElementsOrientationChange(){return i(this._triangleOrientationOverride)}set allowVisualElementsOrientationChange(e){i(this._triangleOrientationOverride)!==e&&(i(this._triangleOrientationOverride)?this._triangleOrientationOverride=this._getActualVisualElementsOrientation():this._triangleOrientationOverride=null)}get labels(){const e=2===this.actualVisualizedMeasurement;return{direct:this._segmentLabel,horizontal:e?this._segmentLabel:this._horizontalLabel,vertical:this._verticalLabel}}get testData(){var e;return{labels:this.labels,stripeLength:null==(e=this._segmentVisualElement)?void 0:e.stripeLength}}initialize(){this._handles.add(H(this.view,"ready",(()=>this._initialize()),!0))}_initialize(){switch(this._state){case 1:throw new Error("invalid state");case 2:return}const e=this._params,t={attached:!0,view:this.view};this._segmentVisualElement=new Ye({...t,geometry:null,renderOccluded:4}),this._triangleVisualElement=new me({...t,width:e.triangleLineWidth,color:e.triangleColor,renderOccluded:4}),this._rightAngleQuad=new Ae({...t,color:ot,renderOccluded:4});const i={...t,polygonOffset:!0,stippleIntegerRepeats:!1,renderOccluded:4};this._projectedGeodesicLine=new me({...i,width:e.geodesicProjectionLineWidth,color:e.geodesicProjectionLineColor,stipplePattern:xe(e.guideStippleLengthPixels)}),this._geodesicStartHint=new me({...i,width:e.guideLineWidth,color:e.geodesicProjectionLineColor,stipplePattern:xe(e.guideStippleLengthPixels)}),this._geodesicEndHint=new me({...i,width:e.guideLineWidth,color:e.geodesicProjectionLineColor,stipplePattern:xe(e.guideStippleLengthPixels)}),this._segmentLabel=new M({...t,fontSize:e.direcLabelFontSize}),this._verticalLabel=new M({...t,fontSize:e.verticalLabelFontSize}),this._horizontalLabel=new M({...t,fontSize:e.horizontalLabelFontSize}),this._handles.add([d((()=>this._updateGeometryAndViewMode())),d((()=>this._updateVisualElementVisibility())),m((()=>this.layerView.fullOpacity),(()=>this._updateVisualElementsOpacity())),d((()=>this._updateLabelText())),d((()=>this._updateLabelVisibility())),d((()=>this._updateSegmentStripeLength())),Ue((async()=>this._updateMessageBundle()))]),this._state=1,this._updateMessageBundle()}destroy(){2!==this._state&&(this._handles=t(this._handles),this._segmentVisualElement=t(this._segmentVisualElement),this._triangleVisualElement=t(this._triangleVisualElement),this._rightAngleQuad=t(this._rightAngleQuad),this._projectedGeodesicLine=t(this._projectedGeodesicLine),this._geodesicStartHint=t(this._geodesicStartHint),this._geodesicEndHint=t(this._geodesicEndHint),this._segmentLabel=t(this._segmentLabel),this._verticalLabel=t(this._verticalLabel),this._horizontalLabel=t(this._horizontalLabel),this.set("view",null),this._state=2)}async whenReady(){await H(this,"ready")}_updateVisualElementVisibility(){if(this._segmentVisualElement.visible=!1,this._triangleVisualElement.visible=!1,this._rightAngleQuad.visible=!1,this._projectedGeodesicLine.visible=!1,this._geodesicStartHint.visible=!1,this._geodesicEndHint.visible=!1,this.visible)switch(this.viewMode){case 0:break;case 1:this._segmentVisualElement.visible=!0;break;case 2:this._segmentVisualElement.visible=!0,this._triangleVisualElement.visible=!0,this._rightAngleQuad.visible=!0;break;case 3:this._segmentVisualElement.visible=!0,this._projectedGeodesicLine.visible=!0,this._geodesicStartHint.visible=!0,this._geodesicEndHint.visible=!0}}_updateGeometryAndViewMode(){const e=this.view.renderCoordsHelper,{elevationAlignedStartPoint:t,elevationAlignedEndPoint:s}=this.layerView;if(i(t)||i(s)||t.equals(s)){this.viewMode=0;const e=this.visualizedMeasurement,t=0===e;return void(this.actualVisualizedMeasurement=t?1:e)}e.toRenderCoords(t,this._startPosition),e.toRenderCoords(s,this._endPosition);const r=this._getActualVisualElementsOrientation(),o=this._updateActualVisualizedMeasurement();this.viewMode=this._computeViewMode(o);let a=this._startPosition,n=this._endPosition;const l=1===r?1:-1,p=l*(e.getAltitude(n)-e.getAltitude(a));p<0&&(a=this._endPosition,n=this._startPosition);const m=2===o?new O(this._startPosition,this._endPosition,e.spatialReference):new z(this._startPosition,this._endPosition);switch(this._segmentVisualElement.geometry=m,this._updateSegmentStripeLength(),this._segmentLabelDisplayedMeasurement=o,this.viewMode){case 1:this._updateSegment(m,r);break;case 2:this._updateSegmentAndTriangle(m,r,a,n,l,p);break;case 3:this._updateSegmentAndProjection(r)}}_updateSegment(e,t){this._segmentLabel.anchor=1===t?"top":"bottom",this._segmentLabel.geometry={type:"segment",segment:e,sampleLocation:"center"}}_updateSegmentAndTriangle(e,t,i,s,r,o){const a=this.view,n=a.renderCoordsHelper,l=a.state.camera,p=this._cornerPosition;n.worldUpAtPosition(i,p),S(p,p,r*Math.abs(o)),P(p,p,i),this._triangleVisualElement.geometry=[[[i[0],i[1],i[2]],[p[0],p[1],p[2]],[s[0],s[1],s[2]]]],this._rightAngleQuad.geometry={previous:i,center:p,next:s};const m=new z(i,p),d=new z(p,s),c=function(e,t,i,s,r){const o=pt,a=mt;r.projectToRenderScreen(i,o),r.projectToRenderScreen(t,a);const n={segment:"bottom",horizontal:"top",vertical:o[0]<a[0]?"left":"right"};{const s=dt,o=ct;if(I(e,i,s,r),I(e,t,o,r),ae(s,o)>=nt){const e=V(s[1])===V(o[1]);n.segment=e?F(n.vertical):n.vertical}else{const e=ht;I(i,t,e,r),ae(e,o)>=nt&&(n.segment=V(e[0])===V(o[0])?F(n.horizontal):n.horizontal)}}if(2===s){const e=e=>"top"===e?"bottom":"top";n.segment=e(n.segment),n.horizontal=e(n.horizontal),n.vertical=e(n.vertical)}return n}(i,s,p,t,l);this._segmentLabel.anchor=c.segment,this._segmentLabel.geometry={type:"segment",segment:e,sampleLocation:"center"},this._verticalLabel.geometry={type:"segment",segment:m,sampleLocation:"center"},this._verticalLabel.anchor=c.vertical,this._horizontalLabel.geometry={type:"segment",segment:d,sampleLocation:"center"},this._horizontalLabel.anchor=c.horizontal}_updateSegmentAndProjection(e){const t=this.view.renderCoordsHelper;t.setAltitude(this._startPositionAtSeaLevel,0,this._startPosition),t.setAltitude(this._endPositionAtSeaLevel,0,this._endPosition);const i=new O(this._startPositionAtSeaLevel,this._endPositionAtSeaLevel,t.spatialReference);this._projectedGeodesicLine.setGeometryFromSegment(i),this._geodesicStartHint.setGeometryFromSegment(new z(this._startPositionAtSeaLevel,this._startPosition)),this._geodesicEndHint.setGeometryFromSegment(new z(this._endPositionAtSeaLevel,this._endPosition)),this._segmentLabel.geometry={type:"segment",segment:i,sampleLocation:"center"},this._segmentLabel.anchor=1===e?"top":"bottom"}_updateLabelText(){if(1!==this._state)return;const e=this._segmentLabel,t=this._horizontalLabel,s=this._verticalLabel,r=this.messages,o=this.layerView.result;if(i(o)||i(r))return e.text=null,t.text=null,void(s.text=null);const a=this._getLabelsText(r,o),n=1===this._segmentLabelDisplayedMeasurement;e.text=n?a.euclideanDistance:a.geodesicDistance,t.text=a.horizontalDistance,s.text=a.verticalDistance,this.notifyChange("labels")}_updateLabelVisibility(){if(1!==this._state)return;const e=this._segmentLabel,t=this._horizontalLabel,i=this._verticalLabel;if(e.visible=!1,t.visible=!1,i.visible=!1,this.visible)switch(this.viewMode){case 1:e.visible=!0;break;case 2:e.visible=!0,t.visible=!0,i.visible=!0;break;case 3:e.visible=!0}}_getLabelsText(e,{directDistance:t,horizontalDistance:i,verticalDistance:s,geodesicDistance:r,geodesicAngle:o}){const a=this.layerView.unit,n=e=>({euclideanDistance:"",geodesicDistance:"",horizontalDistance:"",verticalDistance:"",...e});switch(a){case"metric":return n({euclideanDistance:t&&R(e,t),geodesicDistance:r&&R(e,r),horizontalDistance:i&&R(e,i),verticalDistance:s&&G(e,s)});case"imperial":return n({euclideanDistance:t&&U(e,t),geodesicDistance:r&&U(e,r),horizontalDistance:i&&U(e,i),verticalDistance:s&&T(e,s)});case"degrees":{const t=o&&A(e,o,"degrees");return n({euclideanDistance:t,geodesicDistance:t,horizontalDistance:t})}case"degrees-minutes-seconds":return n({horizontalDistance:o&&x(o)});default:return n({euclideanDistance:t&&A(e,t,a),geodesicDistance:r&&A(e,r,a),horizontalDistance:i&&A(e,i,a),verticalDistance:s&&A(e,s,a)})}}_updateSegmentStripeLength(){const e=this._measurementArrowStripeLength,t=this._segmentVisualElement;r(e)?(t.stripeLength=e,t.stripesEnabled=!0):t.stripesEnabled=!1}_computeViewMode(e){if(2===e){if(!this._geodesicDistanceExceeded)return 1;if(this._requiresGeodesicGuideAt(this._startPosition)||this._requiresGeodesicGuideAt(this._endPosition))return 3}const t=this.layerView.result;if(i(t))return 1;const{verticalDistance:s,horizontalDistance:r}=t,o=s.value,a=r.value;return Math.min(o/a,a/o)<this.triangleCollapseRatioThreshold?1:2}_getActualVisualElementsOrientation(){if(r(this._triangleOrientationOverride))return this._triangleOrientationOverride;const e=this.visualElementOrientation;return 0===e?this.view.state.camera.aboveGround?1:2:e}_updateActualVisualizedMeasurement(){if(0===this.visualizedMeasurement){this.actualVisualizedMeasurement=1;const e=this.layerView.unit;"degrees"!==e&&"degrees-minutes-seconds"!==e||(this.actualVisualizedMeasurement=2),this._geodesicDistanceExceeded&&(this.actualVisualizedMeasurement=2)}else this.actualVisualizedMeasurement=this.visualizedMeasurement;return this.actualVisualizedMeasurement}_requiresGeodesicGuideAt(e){const t=this.view;if(!t.state)return!1;const i=t.state.camera,s=t.renderCoordsHelper,r=i.computeScreenPixelSizeAt(e);return s.getAltitude(e)/r>=10}get _measurementArrowStripeLength(){const e=this.view,{result:t,unit:i}=this.layerView;let s=null;if(r(t)){const e=t.directDistance;switch(i){case"metric":s=e&&e.toUnit("meters");break;case"imperial":s=e&&e.toUnit(re(e.value,e.unit));break;case"degrees":case"degrees-minutes-seconds":{const e=t.geodesicAngle;s=e&&e.toUnit("degrees");break}default:s=e&&e.toUnit(i)}}if(s){let t=1;return t=C(s.value/30),t*="degrees"===s.unit?$(e.spatialReference).metersPerDegree:oe(1,s.unit,"meters"),t}return null}_updateMessageBundle(){this.loadingMessages=!0,te("esri/core/t9n/Units").then((e=>{this.messages=e,this.view&&this._updateLabelText()})).finally((()=>{this.loadingMessages=!1}))}_updateVisualElementsOpacity(){const e=this.layerView.fullOpacity,t=this._params,{triangleColor:i,geodesicProjectionLineColor:s}=t;this._triangleVisualElement.color=L(lt,i,e),this._rightAngleQuad.color=L(lt,ot,e),L(lt,s,e),this._projectedGeodesicLine.color=lt,this._geodesicStartHint.color=lt,this._geodesicEndHint.color=lt,this._segmentVisualElement.opacity=e}};e([o()],rt.prototype,"_state",void 0),e([o()],rt.prototype,"_segmentLabelDisplayedMeasurement",void 0),e([o()],rt.prototype,"_triangleOrientationOverride",void 0),e([o()],rt.prototype,"_geodesicDistanceExceeded",null),e([o()],rt.prototype,"messages",void 0),e([o()],rt.prototype,"view",void 0),e([o()],rt.prototype,"layer",void 0),e([o()],rt.prototype,"layerView",void 0),e([o({readOnly:!0})],rt.prototype,"ready",null),e([o()],rt.prototype,"loadingMessages",void 0),e([o({readOnly:!0})],rt.prototype,"visible",null),e([o()],rt.prototype,"viewMode",void 0),e([o()],rt.prototype,"visualizedMeasurement",void 0),e([o()],rt.prototype,"actualVisualizedMeasurement",void 0),e([o()],rt.prototype,"visualElementOrientation",void 0),e([o()],rt.prototype,"triangleCollapseRatioThreshold",void 0),e([o()],rt.prototype,"allowVisualElementsOrientationChange",null),e([o()],rt.prototype,"labels",null),e([o()],rt.prototype,"testData",null),e([o()],rt.prototype,"_measurementArrowStripeLength",null),rt=e([a("esri.views.3d.layers.DirectLineMeasurement.DirectLineMeasurementView")],rt);const ot=ne(1,.5,0,.75),at={laserLineGlowColor:[1,.5,0],laserLineGlowWidth:8,laserLineGlowFalloff:8,laserLineInnerColor:[1,1,1],laserLineInnerWidth:.75,laserLineGlobalAlpha:.75,laserLineEnabled:!0,handleColor:[1,.5,0],handleOpacity:.5,handleRadius:5,triangleColor:ot,triangleLineWidth:3,triangleCornerSize:32,triangleSubdivisions:128,arrowWidth:16,arrowOutlineColor:[1,.5,0,1],arrowOutlineWidth:.2,arrowStripeEvenColor:[1,1,1,1],arrowStripeOddColor:[1,.5,0,1],arrowStripeLength:16,arrowSubdivisions:128,geodesicProjectionLineWidth:2,geodesicProjectionLineColor:ot,guideLineWidth:2,guideLineColor:ot,guideStippleLengthPixels:6,labelDistance:25,direcLabelFontSize:16,horizontalLabelFontSize:12,verticalLabelFontSize:12},nt=Math.cos(g(12)),lt=le(),pt=ie(),mt=ie(),dt=se(),ct=se(),ht=se();let ut=class extends(l(Te)){constructor(e){super(e),this._userUnit=null,this.type="direct-line-measurement-3d",this.result=null,this.elevationAlignedStartPoint=null,this.elevationAlignedEndPoint=null}set unit(e){this._userUnit=e}get unit(){return s(this._userUnit,this._defaultUnit)}get viewMode(){return this._analysisView.viewMode}get visualizedMeasurement(){return this._analysisView.visualizedMeasurement}set visualizedMeasurement(e){this._analysisView.visualizedMeasurement=e}get actualVisualizedMeasurement(){return this._analysisView.actualVisualizedMeasurement}get visualElementOrientation(){return this._analysisView.visualElementOrientation}set visualElementOrientation(e){this._analysisView.visualElementOrientation=e}get allowVisualElementsOrientationChange(){return this._analysisView.allowVisualElementsOrientationChange}set allowVisualElementsOrientationChange(e){this._analysisView.allowVisualElementsOrientationChange=e}get triangleCollapseRatioThreshold(){return this._analysisView.triangleCollapseRatioThreshold}set triangleCollapseRatioThreshold(e){this._analysisView.triangleCollapseRatioThreshold=e}get directLabelText(){return this._analysisView.labels.direct.text}get horizontalLabelText(){return this._analysisView.labels.horizontal.text}get verticalLabelText(){return this._analysisView.labels.vertical.text}get testData(){var e;return this.destroyed?{labels:null,stripeLength:null,view:null,controller:null}:{...null==(e=this._analysisView)?void 0:e.testData,view:this._analysisView,controller:this._analysisController}}initialize(){const e=this.view,t=this.layer;this._analysisView=new rt({view:e,layer:t,layerView:this}),this._analysisController=new Re({view:e,layer:t,viewData:this})}destroy(){t(this._analysisController),t(this._analysisView)}whenReady(){return this._analysisView.whenReady()}isUpdating(){var e;return!(null==(e=this._analysisView)||!e.loadingMessages)}};e([o(n)],ut.prototype,"_defaultUnit",void 0),e([o()],ut.prototype,"_userUnit",void 0),e([o()],ut.prototype,"_analysisView",void 0),e([o()],ut.prototype,"_analysisController",void 0),e([o()],ut.prototype,"type",void 0),e([o()],ut.prototype,"unit",null),e([o()],ut.prototype,"layer",void 0),e([o()],ut.prototype,"result",void 0),e([o()],ut.prototype,"elevationAlignedStartPoint",void 0),e([o()],ut.prototype,"elevationAlignedEndPoint",void 0),e([o({readOnly:!0})],ut.prototype,"viewMode",null),e([o()],ut.prototype,"visualizedMeasurement",null),e([o({readOnly:!0})],ut.prototype,"actualVisualizedMeasurement",null),e([o()],ut.prototype,"visualElementOrientation",null),e([o()],ut.prototype,"allowVisualElementsOrientationChange",null),e([o()],ut.prototype,"triangleCollapseRatioThreshold",null),e([o({readOnly:!0})],ut.prototype,"directLabelText",null),e([o({readOnly:!0})],ut.prototype,"horizontalLabelText",null),e([o({readOnly:!0})],ut.prototype,"verticalLabelText",null),e([o()],ut.prototype,"testData",null),ut=e([a("esri.views.3d.layers.DirectLineMeasurementLayerView3D")],ut);var gt=ut;export{gt as default};
