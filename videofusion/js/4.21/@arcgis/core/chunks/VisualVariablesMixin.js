/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import{_ as a}from"./tslib.es6.js";import{property as r}from"../core/accessorSupport/decorators/property.js";import"../core/lang.js";import"./ensureType.js";import{L as e}from"./Logger.js";import{r as s}from"./reader.js";import{subclass as i,W as t}from"../core/accessorSupport/decorators/subclass.js";import{w as o}from"./writer.js";import{collectField as l,collectArcadeFieldNames as n}from"../layers/support/fieldUtils.js";import u from"../renderers/visualVariables/ColorVariable.js";import V from"../renderers/visualVariables/OpacityVariable.js";import p from"../renderers/visualVariables/RotationVariable.js";import b from"../renderers/visualVariables/SizeVariable.js";import c from"../renderers/visualVariables/VisualVariable.js";import h from"../core/Accessor.js";import{J as y}from"./jsonMap.js";const f=e.getLogger("esri.renderers.visualVariables.VisualVariableFactory"),v={color:u,size:b,opacity:V,rotation:p},m=new y({colorInfo:"color",transparencyInfo:"opacity",rotationInfo:"rotation",sizeInfo:"size"}),d=/^\[([^\]]+)\]$/i;let g=class extends h{constructor(){super(...arguments),this.colorVariables=null,this.opacityVariables=null,this.rotationVariables=null,this.sizeVariables=null}set visualVariables(a){if(this._resetVariables(),(a=a&&a.filter((a=>!!a)))&&a.length){for(const r of a)switch(r.type){case"color":this.colorVariables.push(r);break;case"opacity":this.opacityVariables.push(r);break;case"rotation":this.rotationVariables.push(r);break;case"size":this.sizeVariables.push(r)}if(this.sizeVariables.length){this.sizeVariables.some((a=>!!a.target))&&a.sort(((a,r)=>{let e=null;return e=a.target===r.target?0:a.target?1:-1,e}))}for(let r=0;r<a.length;r++){a[r].index=r}this._set("visualVariables",a)}else this._set("visualVariables",a)}readVariables(a,r,e){const{rotationExpression:s,rotationType:i}=r,o=s&&s.match(d),l=o&&o[1];if(l&&(a||(a=[]),a.push({type:"rotationInfo",rotationType:i,field:l})),a)return a.map((a=>{const r=m.read(a.type),s=v[r];s||(f.warn(`Unknown variable type: ${r}`),e&&e.messages&&e.messages.push(new t("visual-variable:unsupported",`visualVariable of type '${r}' is not supported`,{definition:a,context:e})));const i=new s;return i.read(a,e),i}))}writeVariables(a,r){const e=[];for(const s of a){const a=s.toJSON(r);a&&e.push(a)}return e}_resetVariables(){this.colorVariables=[],this.opacityVariables=[],this.rotationVariables=[],this.sizeVariables=[]}};a([r()],g.prototype,"visualVariables",null),g=a([i("esri.renderers.visualVariables.VisualVariableFactory")],g);var j=g;const F={base:c,key:"type",typeMap:{opacity:V,color:u,rotation:p,size:b}},w=e=>{let t=class extends e{constructor(){super(...arguments),this._vvFactory=new j}set visualVariables(a){this._vvFactory.visualVariables=a,this._set("visualVariables",this._vvFactory.visualVariables)}readVisualVariables(a,r,e){return this._vvFactory.readVariables(a,r,e)}writeVisualVariables(a,r,e,s){r[e]=this._vvFactory.writeVariables(a,s)}get arcadeRequiredForVisualVariables(){if(!this.visualVariables)return!1;for(const a of this.visualVariables)if(a.arcadeRequired)return!0;return!1}hasVisualVariables(a,r){return a?this.getVisualVariablesForType(a,r).length>0:this.getVisualVariablesForType("size",r).length>0||this.getVisualVariablesForType("color",r).length>0||this.getVisualVariablesForType("opacity",r).length>0||this.getVisualVariablesForType("rotation",r).length>0}getVisualVariablesForType(a,r){const e=this.visualVariables;return e?e.filter((e=>e.type===a&&("string"==typeof r?e.target===r:!1!==r||!e.target))):[]}async collectVVRequiredFields(a,r){let e=[];this.visualVariables&&(e=e.concat(this.visualVariables));for(const s of e)s&&(s.field&&l(a,r,s.field),s.normalizationField&&l(a,r,s.normalizationField),s.valueExpression&&await n(a,r,s.valueExpression))}};return a([r({types:[F],value:null,json:{write:!0}})],t.prototype,"visualVariables",null),a([s("visualVariables",["visualVariables","rotationType","rotationExpression"])],t.prototype,"readVisualVariables",null),a([o("visualVariables")],t.prototype,"writeVisualVariables",null),t=a([i("esri.renderers.mixins.VisualVariablesMixin")],t),t};export{w as V};
