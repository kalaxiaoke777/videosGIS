/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import t from"../core/Error.js";import{L as r}from"./Logger.js";import{i,b as s}from"../core/lang.js";import{eachAlways as o}from"../core/promiseUtils.js";import{init as a,on as l}from"../core/watchUtils.js";import{property as n}from"../core/accessorSupport/decorators/property.js";import"./ensureType.js";import{subclass as u}from"../core/accessorSupport/decorators/subclass.js";import{f as p}from"./commonProperties2.js";import{fixFields as d,unpackFieldNames as m,collectLabelingFields as f,collectElevationFields as c,collectFilterFields as y,collectFeatureReductionFields as h,collectOrderByInfos as F,collectFields as w,collectField as g,featureHasFields as x}from"../layers/support/fieldUtils.js";import v from"../rest/support/Query.js";import{l as b}from"./arcadeOnDemand.js";import E from"../views/layers/support/FeatureEffect.js";import q from"../views/layers/support/FeatureFilter.js";import{g as j,a as I}from"./popupUtils.js";import{a as R}from"./floorFilterUtils.js";const _=r.getLogger("esri.views.layers.FeatureLayerView"),P=r=>{let P=class extends r{constructor(...e){super(...e),this._updatingRequiredFieldsPromise=null,this.effect=null,this.filter=null,this.timeExtent=null,this.layer=null,this.requiredFields=[],this.view=null}initialize(){a(this,["layer.renderer","layer.labelingInfo","layer.elevationInfo.featureExpressionInfo","layer.displayField","filter","effect","layer.timeInfo","layer.floorInfo","timeExtent"],(()=>this._handleRequiredFieldsChange()),!0),l(this,"view.floors","change",(()=>this._handleRequiredFieldsChange())),l(this,"layer.sublayer","change",(()=>this._handleRequiredFieldsChange()))}get availableFields(){const{layer:e,layer:{fieldsIndex:t},requiredFields:r}=this;return"outFields"in e&&e.outFields?d(t,[...m(t,e.outFields),...r]):d(t,r)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){_.error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}highlight(e){throw new Error("missing implementation")}createQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},t=i(this.filter)?this.filter.createQuery(e):new v(e);if("feature"===this.layer.type){const e=R(this);i(e)&&(t.where=t.where?`(${t.where}) AND (${e})`:e)}return i(this.timeExtent)&&(t.timeExtent=i(t.timeExtent)?t.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),t}queryFeatures(e,t){throw new Error("missing implementation")}queryObjectIds(e,t){throw new Error("missing implementation")}queryFeatureCount(e,t){throw new Error("missing implementation")}queryExtent(e,t){throw new Error("missing implementation")}_loadArcadeModules(e){if(e.get("expressionInfos.length"))return b()}_handleRequiredFieldsChange(){const e=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",e),e.then((()=>{this._updatingRequiredFieldsPromise===e&&this._set("_updatingRequiredFieldsPromise",null)}))}async _updateRequiredFields(){if(!this.layer||!this.view)return;const e="3d"===this.view.type,{layer:t,layer:{fieldsIndex:r,objectIdField:s}}=this,a="renderer"in t&&t.renderer,l="orderBy"in t&&t.orderBy,n=t.featureReduction,u=new Set,p=await o([a?a.collectRequiredFields(u,r):null,f(u,t),e?c(u,t):null,i(this.filter)?y(u,t,this.filter):null,this.effect?y(u,t,this.effect.filter):null,n?h(u,t,n):null,l?F(u,t,l):null]);if(t.timeInfo&&this.timeExtent&&w(u,t.fieldsIndex,[t.timeInfo.startField,t.timeInfo.endField]),"feature"===t.type&&t.floorInfo&&w(u,t.fieldsIndex,[t.floorInfo.floorField]),"subtype-group"===t.type){g(u,r,t.subtypeField);const e=t.sublayers.map((e=>{var t;return Promise.all([null==(t=e.renderer)?void 0:t.collectRequiredFields(u,r),f(u,e)])}));await o(e)}for(const e of p)e.error&&_.error(e.error);g(u,r,s),e&&"displayField"in t&&t.displayField&&g(u,r,t.displayField);const d=Array.from(u).sort();this._set("requiredFields",d)}validateFetchPopupFeatures(e){if(s(e))return null;for(const r of e.clientGraphics){const i=r.layer;if("popupEnabled"in i&&!i.popupEnabled)return new t("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:i});if("popupTemplate"in i){if(!j(i,e))return new t("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:i})}}}async fetchClientPopupFeatures(e){const t=i(e)?e.clientGraphics:null;if(!t||0===t.length)return Promise.resolve([]);const r=[],s=[],o=await this.createPopupQuery(e);for(const a of t){const{layer:t}=a;if(!("popupEnabled"in t))continue;const l=m(this.layer.fieldsIndex,o.outFields),n=j(t,e);if(!i(n))continue;const u=await this._loadArcadeModules(n);u&&u.arcadeUtils.hasGeometryOperations(n)||!x(l,a)?s.push(a):r.push(a)}return"stream"===this.layer.type||0===s.length?Promise.resolve(r):(o.objectIds=s.map((e=>e.attributes[this.layer.objectIdField])),this.layer.queryFeatures(o).then((e=>r.concat(e.features))).catch((()=>s)))}async createPopupQuery(e){const t=this.layer.createQuery(),r=new Set;let s=!1;const o=i(e)&&e.clientGraphics?e.clientGraphics.map((e=>e.layer)):[this.layer];for(const t of o){if(!("popupEnabled"in t))continue;const o=j(t,e);if(!i(o))continue;const a=await this._loadArcadeModules(o),l=a&&a.arcadeUtils.hasGeometryOperations(o);s=!("point"!==this.layer.geometryType&&!l);const n=await I(this.layer,o);for(const e of n)r.add(e)}if(t.returnGeometry=s,t.returnZ=s,t.returnM=s,t.outFields=Array.from(r),t.outSpatialReference=this.view.spatialReference,"feature"===this.layer.type){const e=R(this);i(e)&&(t.where=t.where?`(${t.where}) AND (${e})`:e)}return t}canResume(){return!!super.canResume()&&(!i(this.timeExtent)||!this.timeExtent.isEmpty)}};return e([n()],P.prototype,"_updatingRequiredFieldsPromise",void 0),e([n({readOnly:!0})],P.prototype,"availableFields",null),e([n({type:E})],P.prototype,"effect",void 0),e([n({type:q})],P.prototype,"filter",void 0),e([n(p)],P.prototype,"timeExtent",void 0),e([n()],P.prototype,"layer",void 0),e([n({type:Number})],P.prototype,"maximumNumberOfFeatures",null),e([n({readOnly:!0,type:Boolean})],P.prototype,"maximumNumberOfFeaturesExceeded",null),e([n({readOnly:!0})],P.prototype,"requiredFields",void 0),e([n()],P.prototype,"suspended",void 0),e([n()],P.prototype,"view",void 0),P=e([u("esri.views.layers.FeatureLayerView")],P),P};export{P as F};
