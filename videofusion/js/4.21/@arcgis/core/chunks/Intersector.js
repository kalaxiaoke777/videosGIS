/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import{i as t,d as e,b as s}from"../core/lang.js";import{c as r,b as i,I as a}from"./mat4f64.js";import{t as o,h as n,w as h,u as d,k as m,j as c,e as l,b as u,f as g,l as f,g as _,y,n as p}from"./mathUtils.js";import{c as b,a as v,b as O}from"./ray.js";import{e as A,m as T}from"./mat4.js";import{a as L}from"./vec4f64.js";import{e as j}from"./boundedPlane.js";import{c as S,a as V}from"./sphere.js";import{b as R}from"./mathUtils2.js";import{C as E,a as x,r as P,I as M,g as N,i as U}from"./verticalOffsetUtils.js";import{O as w}from"./ArrayPool.js";import{g as B}from"../core/Accessor.js";import{a as G}from"./Util.js";class I{constructor(){this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.store=2}}class W{constructor(){this._disposed=!1}get disposed(){return this._disposed}get shaderTransformation(){return this._shaderTransformation}acquire(t,e,s,r,i,a){this.id=B(),this.geometry=t,this.material=e,this.transformation=s,this.instanceParameters=r,this.origin=i,this._shaderTransformation=a,this._disposed=!1}release(){this._disposed=!1}dispose(){this._disposed=!0}getStaticTransformation(){return this.transformation}getShaderTransformation(){return t(this._shaderTransformation)?this._shaderTransformation(this.transformation):this.transformation}computeAttachmentOrigin(t){return!!(this.material.computeAttachmentOrigin?this.material.computeAttachmentOrigin(this.geometry,t):this.geometry.computeAttachmentOrigin(t))&&(o(t,t,this.getStaticTransformation()),!0)}}W.pool=new w(W);class X{constructor(t){this.channel=t,this.id=B()}}class C extends E{constructor(t={}){super(),this.type=1,this._geometryRecords=new Array,this._geometries=new Array,this._objectTransformation=r(),this._bvObjectSpace=new q,this._bvWorldSpace=new q,this._bvDirty=!0,this._hasVolatileTransformation=!1,this._visible=!0,this.castShadow=null==t.castShadow||t.castShadow,this.metadata=t.metadata,this.metadata&&this.metadata.isElevationSource&&(this.metadata.lastValidElevationBB=new D),this.transformation=r();const{geometries:e,materials:s,transformations:a,origins:o}=t;if(Array.isArray(e)){G(s.length===e.length,"Object3D: materials don't match geometries"),G(a.length===e.length,"Object3D: transformations don't match geometries"),this._geometryRecords.length=e.length,this._geometries.length=e.length;for(let t=0;t<e.length;t++)this._geometries[t]=e[t],this._geometryRecords[t]=W.pool.acquire(e[t],s[t],i(a[t]),{highlights:null,occludees:null,visible:!0},o&&o[t])}}get geometryRecords(){return this._geometryRecords}get geometries(){return this._geometries}get transformation(){return this._objectTransformation}set transformation(t){A(this._objectTransformation,t),this._invalidateBoundingVolume(),this._emit("objectTransformation",this)}dispose(){this._geometryRecords.length=0,this._geometries.length=0}get parentLayer(){return this._parentLayer}set parentLayer(t){G(null==this._parentLayer||null==t,"Object3D can only be added to a single Layer"),this._parentLayer=t}getNumGeometryRecords(){return this._geometryRecords.length}getGeometryRecord(t){return G(t>=0&&t<this._geometryRecords.length,"Object3d.getGeometryDataByIndex: index out of range"),this._geometryRecords[t]}addGeometry(e,s,r,i,o,n){r=r||a,this._geometries.push(e);const h=W.pool.acquire(e,s,r,i||{highlights:null,occludees:null,visible:!0},o,n);return this._geometryRecords.push(h),this._hasVolatileTransformation=this._hasVolatileTransformation||t(h.shaderTransformation),this._emit("objectGeometryAdded",{object:this,record:h}),this._invalidateBoundingVolume(),h}removeGeometry(e){const s=this._geometryRecords.splice(e,1)[0];return this._hasVolatileTransformation=t(s.shaderTransformation)?this._geometryRecords.some((e=>t(e.shaderTransformation))):this._hasVolatileTransformation,s.dispose(),this._geometries.splice(e,1),this._emit("objectGeometryRemoved",{object:this,record:s}),this._invalidateBoundingVolume(),s}removeAllGeometries(){for(;this.getNumGeometryRecords()>0;)this.removeGeometry(0)}geometryVertexAttrsUpdated(t){this._emit("vertexAttrsUpdated",{object:this,record:this._geometryRecords[t]}),this._invalidateBoundingVolume()}get isVisible(){return this._visible}setVisible(t){this._visible=t;for(const t of this._geometryRecords)t.instanceParameters.visible=this._visible;this._emit("visibilityChanged",this)}maskOccludee(){const t=new X(1);for(const e of this._geometryRecords)e.instanceParameters.occludees=x(e.instanceParameters.occludees,t);return this._emit("occlusionChanged",this),t}removeOcclude(t){for(const e of this._geometryRecords)e.instanceParameters.occludees=P(e.instanceParameters.occludees,t);this._emit("occlusionChanged",this)}highlight(){const t=new X(0);for(const e of this._geometryRecords)e.instanceParameters.highlights=x(e.instanceParameters.highlights,t);return this._emit("highlightChanged",this),t}removeHighlight(t){for(const e of this._geometryRecords)e.instanceParameters.highlights=P(e.instanceParameters.highlights,t);this._emit("highlightChanged",this)}getCombinedStaticTransformation(t,s){return T(e(s,r()),this.transformation,t.getStaticTransformation())}getCombinedShaderTransformation(t,e){return e=e||r(),T(e,this.transformation,t.getShaderTransformation()),e}hasVolativeTransformation(){return this._hasVolatileTransformation}get boundingVolumeWorldSpace(){return this._validateBoundingVolume(),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._validateBoundingVolume(),this._bvObjectSpace}_validateBoundingVolume(){if(!this._bvDirty&&!this._hasVolatileTransformation)return;this._bvObjectSpace.init(),this._bvWorldSpace.init();for(let e=0;e<this._geometryRecords.length;++e){const s=this._geometries[e],r=this._geometryRecords[e],i=s.boundingInfo;t(i)&&(this._calculateTransformedBoundingVolume(i,this._bvObjectSpace,r.getShaderTransformation()),this._calculateTransformedBoundingVolume(i,this._bvWorldSpace,this.getCombinedShaderTransformation(r)))}n(this._bvObjectSpace.bounds,this._bvObjectSpace.min,this._bvObjectSpace.max,.5),n(this._bvWorldSpace.bounds,this._bvWorldSpace.min,this._bvWorldSpace.max,.5);const e=u(),r=u(),i=R(this.transformation);for(let t=0;t<this._geometryRecords.length;++t){const a=this._geometries[t].boundingInfo;if(s(a))continue;const n=this._geometryRecords[t].getShaderTransformation(),d=R(n);o(e,a.getCenter(),n);const m=h(e,this._bvObjectSpace.bounds),c=a.getBSRadius()*d;this._bvObjectSpace.bounds[3]=Math.max(this._bvObjectSpace.bounds[3],m+c),o(r,e,this.transformation);const l=h(r,this._bvWorldSpace.bounds),u=c*i;this._bvWorldSpace.bounds[3]=Math.max(this._bvWorldSpace.bounds[3],l+u)}this._bvDirty=!1}_calculateTransformedBoundingVolume(t,e,s){const r=t.getBBMin(),i=t.getBBMax(),a=d(r),n=d(i);o(a,a,s),o(n,n,s);for(let t=0;t<3;++t)e.min[t]=Math.min(e.min[t],a[t],n[t]),e.max[t]=Math.max(e.max[t],a[t],n[t]);for(let t=0;t<3;++t){m(a,r),m(n,i),a[t]=i[t],n[t]=r[t],o(a,a,s),o(n,n,s);for(let t=0;t<3;++t)e.min[t]=Math.min(e.min[t],a[t],n[t]),e.max[t]=Math.max(e.max[t],a[t],n[t])}}_invalidateBoundingVolume(){this._bvDirty=!0,t(this._parentLayer)&&this._parentLayer.notifyObjectBBChanged(this,this._bvWorldSpace.bounds)}_emit(e,s){t(this._parentLayer)&&this._parentLayer.events.emit(e,s)}get test(){const t=this;return{hasGeometry:e=>t._geometries.indexOf(e)>-1,getGeometryIndex:e=>t._geometries.indexOf(e)}}}class D{constructor(){this.min=c(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.max=c(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}isEmpty(){return this.max[0]<this.min[0]&&this.max[1]<this.min[1]&&this.max[2]<this.min[2]}}class q extends D{constructor(){super(...arguments),this.bounds=S()}init(){l(this.min,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),l(this.max,-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),V(this.bounds)}}function k(t){return(e,s,r)=>(n(z,e,s,r),!j(t,z))}class F{constructor(){this.min=new Q,this.max=new Q,this.hud=new Q,this.ground=new Q}init(t){this.min.init(t),this.max.init(t),this.hud.init(t),this.ground.init(t),this.all=[]}}class Q{constructor(t){this.normal=u(),this.transformation=r(),this._ray=b(),this.init(t)}get ray(){return this._ray}get hasIntersectionPoint(){return null!=this.dist}get distanceInRenderSpace(){if(null!=this.dist)return g(H,this.ray.direction,this.dist),f(H)}getIntersectionPoint(t){return!!this.hasIntersectionPoint&&(g(H,this.ray.direction,this.dist),_(t,this.ray.origin,H),!0)}getTransformedNormal(t){return m($,this.normal),$[3]=0,y($,$,this.transformation),m(t,$),p(t,t),t}init(t){this.dist=void 0,this.target=void 0,this.name=void 0,this.drapedLayerOrder=void 0,this.drapedLayerGraphicOrder=void 0,this.center=null,this.geometryId=null,this.triangleNr=null,this.intersector="Stage",t?v(t,this._ray):this._ray=b()}set(t,e,s,r,i,a,o,n,h,c){t instanceof C&&(t={type:"stage",obj:t}),this.dist=s,m(this.normal,r),A(this.transformation,i),this.target=t,this.name=e,this.drapedLayerOrder=a,this.center=o?d(o):null,this.geometryId=n,this.triangleNr=h,this.drapedLayerGraphicOrder=c}copyFrom(t){v(t.ray,this._ray),this.dist=t.dist,this.target=t.target,this.name=t.name,this.drapedLayerOrder=t.drapedLayerOrder,this.center=t.center?d(t.center):null,this.geometryId=t.geometryId,this.triangleNr=t.triangleNr,this.intersector=t.intersector,this.drapedLayerGraphicOrder=t.drapedLayerGraphicOrder,m(this.normal,t.normal),A(this.transformation,t.transformation)}}const z=u(),H=u(),$=L();class J{constructor(t){this.options=new I,this.results=new F,this.transform=new M,this.performanceInfo={queryDuration:0,numObjectsTested:0},this.tolerance=1e-5,this.verticalOffset=null,this._ray={origin:u(),direction:u()},this._rayEndPoint=u(),this._rayStartPointTransformed=u(),this._rayEndPointTransformed=u(),this.viewingMode=null==t?1:t}get ray(){return this._ray}get rayBeginPoint(){return this._ray.origin}get rayEndPoint(){return this._rayEndPoint}reset(t,e){this.resetWithRay(O(t,e,this._ray))}resetWithRay(t){t!==this._ray&&v(t,this._ray),0!==this.options.verticalOffset?2===this.viewingMode?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,_(this._rayEndPoint,this._ray.origin,this._ray.direction),this._numObjectsTested=0,this.results.init(this._ray)}intersect(e=null,s,r,i,a,o){this.point=s,this.camera=r,this.filterPredicate=a,this.tolerance=null==i?1e-5:i;const n=N(this.verticalOffset);if(t(e)&&e.length>0){const s=o?t=>{o(t)&&this.intersectObject(t)}:t=>{this.intersectObject(t)};for(const r of e){const e=r.getSpatialQueryAccelerator&&r.getSpatialQueryAccelerator();t(e)?(t(n)?e.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,s,n):e.forEachAlongRay(this._ray.origin,this._ray.direction,s),this.options.selectionMode&&this.options.hud&&e.forEachDegenerateObject(s)):r.objects.forAll((t=>s(t)))}}this.sortResults()}intersectObject(e){this._numObjectsTested++;const s=e.geometryRecords;if(!s)return;const r=e.id,i=e.transformation;let n;const h=N(this.verticalOffset);for(const d of s){const{geometry:s,material:m,instanceParameters:c}=d;if(U(c))continue;n=s.id,this.transform.setAndInvalidateLazyTransforms(i,d.getShaderTransformation()),o(this._rayStartPointTransformed,this._ray.origin,this.transform.inverse),o(this._rayEndPointTransformed,this._rayEndPoint,this.transform.inverse);const l=this.transform.transform;t(h)&&(h.objectTransform=this.transform),m.intersect(s,c,this.transform.transform,this,this._rayStartPointTransformed,this._rayEndPointTransformed,((s,i,o,h,d,m)=>{if(s>=0){if(t(this.filterPredicate)&&!this.filterPredicate(this._ray.origin,this._rayEndPoint,s))return;const c=`Object3D ${r}`;if(d)return void((null==this.results.hud.dist||s<this.results.hud.dist)&&this.results.hud.set(e,c,s,i,a,h,m,n,o));const u=t=>t.set(e,c,s,i,l,h,null,n,o);if((null==this.results.min.drapedLayerOrder||h>=this.results.min.drapedLayerOrder)&&(null==this.results.min.dist||s<this.results.min.dist)&&u(this.results.min),0!==this.options.store&&(null==this.results.max.drapedLayerOrder||h<this.results.max.drapedLayerOrder)&&(null==this.results.max.dist||s>this.results.max.dist)&&u(this.results.max),2===this.options.store){const t=new Q(this._ray);u(t),this.results.all.push(t)}}}),d.shaderTransformation)}}sortResults(){this.results.all.sort(((t,e)=>t.dist!==e.dist?t.dist-e.dist:t.drapedLayerOrder!==e.drapedLayerOrder?(void 0!==t.drapedLayerOrder?t.drapedLayerOrder:Number.MAX_VALUE)-(void 0!==e.drapedLayerOrder?e.drapedLayerOrder:Number.MAX_VALUE):(void 0!==e.drapedLayerGraphicOrder?e.drapedLayerGraphicOrder:Number.MIN_VALUE)-(void 0!==t.drapedLayerGraphicOrder?t.drapedLayerGraphicOrder:Number.MIN_VALUE)))}}J.DEFAULT_TOLERANCE=1e-5;export{W as G,J as I,C as O,Q as a,X as b,k as s};
