/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import t from"../core/Accessor.js";import{b as r,i as s}from"../core/lang.js";import{s as i}from"./screenUtils.js";import{property as o}from"../core/accessorSupport/decorators/property.js";import"./ensureType.js";import"./Logger.js";import{subclass as n}from"../core/accessorSupport/decorators/subclass.js";import{k as a,d as c,f as p,n as d,g as l,b as m}from"./mathUtils.js";import{c as u,a as h,b as f}from"./ray.js";import{c as y}from"./vectorStacks.js";import{g}from"./dehydratedFeatures.js";import{a as v}from"./ray2.js";import{e as j}from"./tileUtils.js";import{I}from"./Intersector.js";import{t as w}from"./intersectorUtilsConversions.js";let R=class extends t{constructor(e){super(e)}initialize(){this.intersector=new I(this.view.state.viewingMode),this.intersector.options.hud=!1,this.intersector.options.store=0}getScreenPointIntersection(e){const t=i(e,y.get()),r=v(this.view.state.camera,t,S);return this._getRayIntersection(r)}_getRayIntersection(e){if(r(e))return null;this.view.sceneIntersectionHelper.intersectToolIntersectorRay(e,this.intersector);const t=this.intersector.results.min,i=b;if(!t||!t.getIntersectionPoint(i))return null;const o=this.view.renderCoordsHelper.fromRenderCoords(i,this.view.spatialReference),n=m();a(n,t.normal);const d=c(n,e.direction)>0?-1:1;p(n,n,d);const l=w(t,this.view);if(s(l)){const r=l.layer,s=l.sourceLayer;let i;if(s)switch(s.type){case"scene":i=g(l,s.objectIdField);break;case"integrated-mesh":{const e=t.target;i=`${e.metadata.nodeIndex}/${e.metadata.componentIndex}`;break}default:i=l.uid}else i=l.uid;return{type:"Graphic",id:`${r.uid}/${i}`,ray:h(e),normal:n,point:o}}if("TerrainRenderer"===t.intersector){return{type:"Terrain",id:t.target.metadata.tile.lij.slice(),ray:h(e),normal:n,point:o}}return null}_canUpdateFromIntersectionResult(e,t){if(r(e)||!t||e.type!==t.type)return!1;switch(e.type){case"Terrain":{const r=e.id,s=t.id;return r[0]===s[0]&&r[1]===s[1]&&r[2]===s[2]||j(r,s)}case"Graphic":case"I3S":return e.id===t.id}}updateFromIntersectionResult(e){let t;if("Terrain"===e.type&&s(e.point)){const r=b,s=T,i=C;this.view.renderCoordsHelper.toRenderCoords(e.point,s),this.view.renderCoordsHelper.worldUpAtPosition(s,i);const o=this.view.basemapTerrain.elevationBounds,n=this.view.renderCoordsHelper.getAltitude(s),a=o?Math.abs(o.max-o.min)/Math.abs(n):100,c=n>0?1:-1;d(i,i),p(i,i,c*a),l(r,s,i),f(r,s,S),t=this._getRayIntersection(S)}else t=this._getRayIntersection(e.ray);return this._canUpdateFromIntersectionResult(t,e)?t.point:null}};e([o()],R.prototype,"view",void 0),e([o()],R.prototype,"intersector",void 0),R=e([n("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightRayIntersector")],R);const b=m(),T=m(),C=m(),S=u();export{R as L};
