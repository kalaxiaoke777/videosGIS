/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import"../geometry.js";import{n as e}from"./compilerUtils.js";import{L as t}from"./Logger.js";import{m as r,B as s,k as i,l as a,e as o,g as n,f as c,s as d,b as l,n as u,d as g,a as m,C as p,u as h,j as f,r as b}from"./mathUtils.js";import{h as w,i as v,b as y,d as _}from"../core/lang.js";import{e as M}from"./screenUtils.js";import{i as j,r as P,s as k,m as C,b as x,t as O,x as S}from"./mat4.js";import{c as U}from"./mat4f64.js";import{r as W}from"./quat.js";import{r as T,f as L,i as R,c as A,n as E,u as G}from"./boundedPlane.js";import{q as I,e as F}from"./plane.js";import{c as z}from"./ray.js";import{k as D}from"./sphere.js";import{b as V,s as q,d as B}from"./vectorStacks.js";import{M as H,d as N}from"./manipulatorUtils.js";import{O as $,L as Z}from"./LineVisualElement.js";import{f as J}from"./vec4f32.js";import{D as K,P as Q,G as X,C as Y}from"./ColorMaterial.js";import{_ as ee}from"./tslib.es6.js";import{S as te,g as re,a as se,c as ie,P as ae,D as oe,h as ne,$ as ce,w as de,aa as le,a9 as ue,ai as ge,a8 as me,ab as pe}from"./OutputDepth.glsl.js";import{m as he,s as fe,d as be}from"./VertexArrayObject.js";import{g as we}from"./ElevationProvider.js";import{c as ve}from"./ray2.js";import{I as ye}from"./ImageMaterial.js";import{N as _e}from"./NativeLineMaterial.js";import{v as Me}from"./lineUtils.js";import je from"../widgets/Slice/SlicePlane.js";import Pe from"../geometry/Point.js";const ke=w("mac")?"Meta":"Control",Ce="Shift",xe=2500,Oe=.02,Se=Math.cos(r(45)),Ue=Math.cos(r(5)),We=.95,Te=.3,Le=[1,.5,0],Re=2,Ae=1,Ee=[...Le,.7],Ge=[0,0,0,.04],Ie=[...Le,.5],Fe=[...Le,1],ze=[1,1,1,1],De=[1,.8,.6,1],Ve=[1,.93,.86,1],qe=[...Le,1],Be=[...Le,1];var He=Object.freeze({__proto__:null,build:function(){const e=new te;return e.extensions.add("GL_OES_standard_derivatives"),e.vertex.uniforms.add("proj","mat4").add("view","mat4"),e.attributes.add("position","vec3"),e.attributes.add("uv0","vec2"),e.varyings.add("vUV","vec2"),e.vertex.code.add(re`void main(void) {
vUV = uv0;
gl_Position = proj * view * vec4(position, 1.0);
}`),e.fragment.uniforms.add("backgroundColor","vec4").add("gridColor","vec4").add("ratio","float").add("gridWidth","float"),e.fragment.code.add(re`void main() {
const float LINE_WIDTH = 1.0;
vec2 uvScaled = vUV * gridWidth;
vec2 gridUV = (fract(uvScaled + 0.5) - 0.5) / (LINE_WIDTH * fwidth(uvScaled));
vec2 grid = (1.0 - step(0.5, gridUV)) * step(-0.5, gridUV);
grid.x *= step(0.5, uvScaled.x) * step(uvScaled.x, gridWidth - 0.5);
grid.y *= step(0.5, uvScaled.y) * step(uvScaled.y, gridWidth - 0.5);
float gridFade = max(grid.x, grid.y);
float gridAlpha = gridColor.a * gridFade;
gl_FragColor =
vec4(backgroundColor.rgb * backgroundColor.a, backgroundColor.a) * (1.0 - gridAlpha) +
vec4(gridColor.rgb, 1.0) * gridAlpha;
}`),e}});class Ne extends ie{initializeProgram(e){const t=Ne.shader.get().build();return new ae(e.rctx,t,oe)}bindPass(e,t){ne(this.program,t.camera.projectionMatrix),this.program.setUniform4fv("backgroundColor",e.backgroundColor),this.program.setUniform4fv("gridColor",e.gridColor),this.program.setUniform1f("gridWidth",e.gridWidth)}bindDraw(e){ce(this.program,e),this.program.rebindTextures()}initializePipeline(){return he({blending:fe(1,1,771,771),depthTest:{func:513},colorWrite:be})}}Ne.shader=new se(He,(()=>Promise.resolve().then((function(){return He}))));class $e extends ue{constructor(e){super(e,Je)}intersect(e,t,r,s,i,a,o){return ge(e,t,s,i,a,void 0,o)}createBufferWriter(){return new K(Q)}getGLMaterial(e){return 0===e.output?new Ze(e):void 0}}class Ze extends le{constructor(e){super(e),this._technique=new Ne(this._techniqueRep.constructionContext,null),this.updateParameters()}updateParameters(){}beginSlot(e){return 8===e}bind(e){this._technique.bindPass(this._material.params,e)}}ee([de()],Ze.prototype,"_technique",void 0);const Je={backgroundColor:[1,0,0,.5],gridColor:[0,1,0,.5],gridWidth:4,...me};class Ke extends ${constructor(e){super(e),this._material=null,this._renderOccluded=4,this._gridWidth=1,this._gridColor=J(1,0,0,1),this._backgroundColor=J(1,0,0,1),this.applyProps(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get gridWidth(){return this._gridWidth}set gridWidth(e){this._gridWidth!==e&&(this._gridWidth=e,this._updateMaterial())}get gridColor(){return this._gridColor}set gridColor(e){s(this._gridColor,e),this._updateMaterial()}get backgroundColor(){return this._backgroundColor}set backgroundColor(e){s(this._backgroundColor,e),this._updateMaterial()}createExternalResources(){this._material=new $e(this.materialParameters)}destroyExternalResources(){this._material=null}forEachExternalMaterial(e){v(this._material)&&e(this._material)}createGeometries(e){if(v(this._material)){const t=X.createSquareGeometry();e.addGeometry(t,this._material)}}get materialParameters(){return{backgroundColor:this._backgroundColor,gridWidth:this._gridWidth,gridColor:this._gridColor,renderOccluded:this._renderOccluded}}_updateMaterial(){v(this._material)&&this._material.setParameterValues(this.materialParameters)}}const Qe=t.getLogger("esri.views.3d.interactive.analysisTools.slice.sliceToolUtils");function Xe(e,t,r,s,a,o,n,d){return function(e,t,r,s,a,o){const n=g(e,t),d=V.get(),l=V.get();switch(0===s?Math.abs(n)>Se?1:2:s){case 2:{const s=Math.abs(n)<=Ue?e:r.viewUp;m(d,s,t),i(l,t);break}case 1:m(d,r.viewUp,t),m(l,t,d);break;case 3:{const s=Math.abs(n)<=Ue?t:r.viewUp;m(d,s,e),m(l,e,d);break}}const p=m(V.get(),d,l);g(p,r.viewForward)>0&&c(l,l,-1);u(a,d),u(o,l)}(t,n.worldUpAtPosition(e,V.get()),a,o,d.basis1,d.basis2),c(d.basis1,d.basis1,r),c(d.basis2,d.basis2,s),i(d.origin,e),F(d.basis2,d.basis1,d.origin,d.plane),d}function Ye(e,t,r){const s=t.worldUpAtPosition(e.origin,V.get()),i=e.basis1,a=yt(e,s),o=Math.round(a/Ct)*Ct;return T(e,o-a,i,r)}function et(e,t,r,s,o,l){const u=i(V.get(),o.origin);n(u,u,c(V.get(),o.basis1,e.direction[0]<0?1:-1)),n(u,u,c(V.get(),o.basis2,e.direction[1]<0?1:-1));const m=a(o.basis1),p=a(o.basis2),h=d(V.get(),r,u),f=d(V.get(),t,u);let b=0,w=0;if(mt(e)){const t=gt(o),r=gt(l);b=m-.5*e.direction[0]*g(o.basis1,f)/m,w=p-.5*e.direction[1]*g(o.basis2,f)/p;const s=r/t;b*=s,w*=s}const v=b+.5*e.direction[0]*g(o.basis1,h)/m,y=w+.5*e.direction[1]*g(o.basis2,h)/p,_=c(V.get(),o.basis1,v/m),M=c(V.get(),o.basis2,y/p);(v<=0||lt(l.origin,_,s)<=1600)&&i(_,l.basis1),(y<=0||lt(l.origin,M,s)<=1600)&&i(M,l.basis2);const j=i(V.get(),u);return n(j,j,c(V.get(),_,e.direction[0]<0?-1:1)),n(j,j,c(V.get(),M,e.direction[1]<0?-1:1)),L(j,_,M,l)}function tt(e,t){return.4*Math.min(t.width,t.height)*t.computeRenderPixelSizeAt(e)}function rt(e,t,r,s){const i=m(V.get(),t,r);return m(i,i,t),I(e,i,s)}function st(e,t){return N(e.basis1,e.basis2,e.origin,t)}function it(e,t,r,s){const a=t.worldUpAtPosition(e.origin,V.get()),o=V.get();switch(r){case 1:i(o,a);break;case 2:i(o,e.basis1)}return I(e.origin,o,s)}function at(e,t,r,s){const i=dt(r,2),a=q.get();P(a,t,i.edge*Math.PI/2);const o=u(V.get(),i.basis);let d=c(V.get(),o,i.direction*s.computeScreenPixelSizeAt(i.position)*40);n(d,d,i.position);const l=s.projectToRenderScreen(d,M(V.get())),g=function(e,t){const[r,s,i,a]=e.viewport,o=Math.min(i,a)/16;let n=!0;t[0]<r+o?(t[0]=r+o,n=!1):t[0]>r+i-o&&(t[0]=r+i-o,n=!1);t[1]<s+o?(t[1]=s+o,n=!1):t[1]>s+a-o&&(t[1]=s+a-o,n=!1);return n}(s,l);ve(s,l,kt),u(kt.direction,kt.direction);const m=V.get();!g&&R(r,kt,m)&&(d=m),a[12]=0,a[13]=0,a[14]=0,e.modelTransform=a,e.renderLocation=h(d),g?e.state|=Pt:e.state&=~Pt}function ot(e,t,r,s){const i=a(s.basis1),d=a(s.basis2),l=ut(s),u=gt(s),g=o(V.get(),0,0,0);n(g,c(V.get(),s.basis1,t.direction[0]),c(V.get(),s.basis2,t.direction[1])),n(g,s.origin,g);let m=0,p=1;if(mt(t))1===t.direction[0]&&-1===t.direction[1]?m=Ct:1===t.direction[0]&&1===t.direction[1]?m=Math.PI:-1===t.direction[0]&&1===t.direction[1]&&(m=3*Math.PI/2),p=u;else{const e=0!==t.direction[0]?1:2;m=1===e?Ct:0,p=(1===e?d:i)-l}const h=j(q.get());P(h,h,m),k(h,h,o(V.get(),p,p,p)),C(h,r,h),h[12]=0,h[13]=0,h[14]=0,e.modelTransform=h,e.renderLocation=g}function nt(e,t,r,s){const i=s.worldUpAtPosition(r.origin,V.get()),a=dt(r,0),o=j(q.get());P(o,o,a.edge*Math.PI/2),x(o,o,-yt(r,i)),C(o,t,o),o[12]=0,o[13]=0,o[14]=0,e.modelTransform=o,e.renderLocation=a.position}function ct(e,t,r){const s=dt(r,1),i=j(q.get());P(i,i,s.edge*Math.PI/2),x(i,i,Ct),C(i,t,i),i[12]=0,i[13]=0,i[14]=0,e.modelTransform=i,e.renderLocation=s.position}function dt(e,t){switch(t){case 0:return{basis:e.basis1,direction:1,position:n(V.get(),e.origin,e.basis1),edge:t};case 1:return{basis:e.basis2,direction:1,position:n(V.get(),e.origin,e.basis2),edge:t};case 2:return{basis:e.basis1,direction:-1,position:d(V.get(),e.origin,e.basis1),edge:t};case 3:return{basis:e.basis2,direction:-1,position:d(V.get(),e.origin,e.basis2),edge:t}}}function lt(e,t,r){const s=r.projectToRenderScreen(n(V.get(),e,t),M(V.get())),i=r.projectToRenderScreen(d(V.get(),e,t),M(V.get()));return p(d(s,s,i))}function ut(e){const t=a(e.basis1),r=a(e.basis2);return.3*Math.min(t,r)}function gt(e){return ut(e)}function mt(e){return 0!==e.direction[0]&&0!==e.direction[1]}function pt(e,t=1){const r=0===t?40:0,s=[f(r,0,-24),f(r,0,24)],i=function(e,t){const r=d(l(),e[e.length-1],e[e.length-2]);if(u(r,r),c(r,r,12),n(r,r,e[e.length-1]),t){const t=d(l(),e[0],e[1]);return u(t,t),c(t,t,12),n(t,t,e[0]),[t,...e,r]}return[...e,r]}(s,!0),a=(e,t)=>function(e,t,r){const s=s=>{const i=(s?t:e).slice(0),a=d(V.get(),i[0],i[1]);u(a,a);const g=d(V.get(),i[i.length-1],i[i.length-2]);if(u(g,g),r.padding>0){const e=c(l(),g,-r.padding);if(i[i.length-1]=n(e,e,i[i.length-1]),r.bothEnds){const e=c(l(),a,-r.padding);i[0]=n(e,e,i[0])}}const m=s?r.tipFocusMultiplier:1,p=r.tipLength*(r.focusTipLength?m:1),h=r.tipRadius*m,b=j(q.get());if(r.padding>0){const e=p/4,t=o(V.get(),0,e,0),s=1+r.padding/e;O(b,b,t),k(b,b,o(V.get(),s,s,s)),O(b,b,c(t,t,-1/s))}const w=j(U()),y=f(0,1,0),_=S(U(),W(B.get(),y,g));_[12]=i[i.length-1][0],_[13]=i[i.length-1][1],_[14]=i[i.length-1][2],C(_,_,b);const M=function(e,t,r){const s=[];if(v(t))s.push([e,t.thickness/2],[-e,t.thickness/2],[-e,-t.thickness/2],[e,-t.thickness/2]);else{const t=12;for(let r=0;r<t;r++){const i=r/t*2*Math.PI;s.push([Math.cos(i)*e,Math.sin(i)*e])}}return X.createPathExtrusionGeometry(s,r,[],[],!1)}(r.tubeRadius*(s?r.tubeFocusMultiplier:1)+r.padding,r.flat,i),P=[{part:"tube",geometry:M,transform:w}];let x,T;if(v(r.flat)?x=X.createExtrudedTriangle(p,h,h,r.flat.thickness):(x=X.createConeGeometry(p,h,24,!1,!1,!0),T=X.createConeGeometry(p,h,24,!1,!0,!1)),P.push({part:"tip",geometry:x,transform:_}),T&&P.push({part:"cap",geometry:T,transform:_}),r.bothEnds){const e=S(U(),W(B.get(),y,a));e[12]=i[0][0],e[13]=i[0][1],e[14]=i[0][2],C(e,e,b),P.push({part:"tip",geometry:x,transform:e}),T&&P.push({part:"cap",geometry:T,transform:e})}return P};return{normal:s(!1),focused:s(!0)}}(s,s,{tubeRadius:3,tipRadius:11,tipLength:22.5,tubeFocusMultiplier:1.15,tipFocusMultiplier:1.15,padding:e,bothEnds:!0,flat:null,focusTipLength:!0,addCap:t}),g=a(0,!1),m=a(2.25,!0),p=new Y({color:ze,cullFace:2,renderOccluded:16}),h=new Y({color:De,cullFace:2,renderOccluded:16}),b=new Y({color:Ve,cullFace:2,renderOccluded:16}),w=new Y({color:Be,transparent:!0,writeDepth:!1,cullFace:1,renderOccluded:2}),y=X.createPolylineGeometry([[r,0,0],[r-40,0,0]]),_=X.createPolylineGeometry([[r,0,0],[r-40,0,0]]),M=new _e({color:qe,renderOccluded:4});return new H({view:e,renderObjects:[...g.normal.map((({part:e,geometry:t,transform:r})=>({geometry:t,material:"tip"===e?p:"cap"===e?h:b,transform:r,stateMask:1|jt}))),...m.normal.map((({geometry:e,transform:t})=>({geometry:e,material:w,transform:t,stateMask:1|jt}))),{geometry:y,material:M,stateMask:1|jt|Pt},...g.focused.map((({part:e,geometry:t,transform:r})=>({geometry:t,material:"tip"===e?p:"cap"===e?h:b,transform:r,stateMask:2|jt}))),...m.focused.map((({geometry:e,transform:t})=>({geometry:e,material:w,transform:t,stateMask:2|jt}))),{geometry:_,material:M,stateMask:2|jt|Pt}],autoScaleRenderObjects:!1,collisionType:{type:"line",paths:[i]},collisionPriority:1,radius:11,state:jt})}function ht(e,t){const r=new ye({transparent:!0,writeDepth:!1,textureId:t.id,renderOccluded:16}),s=40,i=27*1.1,a=e=>{const t=new Uint32Array([0,1,2,2,3,0]);return new pe([["position",{size:3,data:[s-e,-e,0,s+e,-e,0,s+e,e,0,s-e,e,0],exclusive:!0}],["uv0",{size:2,data:[0,0,1,0,1,1,0,1]}]],[["position",t],["uv0",t]])},o=X.createPolylineGeometry([[0,0,0],[13,0,0]]),n=X.createPolylineGeometry([[0,0,0],[10.299999999999997,0,0]]),c=new _e({color:Fe,renderOccluded:4}),d=[{geometry:a(27),material:r,stateMask:1|jt},{geometry:o,material:c,stateMask:1|jt},{geometry:a(i),material:r,stateMask:2|jt},{geometry:n,material:c,stateMask:2|jt}];return new H({view:e,renderObjects:d,autoScaleRenderObjects:!1,collisionType:{type:"disc",direction:[0,0,1],offset:[s,0,0]},collisionPriority:1,radius:13.5,state:jt})}function ft(e){return new Z({view:e,attached:!0,color:Ee,width:1,writeDepthEnabled:!1,renderOccluded:4,geometry:[[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0],[-1,-1,0]]]})}function bt(e){return new Ke({view:e,attached:!0,backgroundColor:[...Ge],gridColor:Ie,gridWidth:4,renderOccluded:4})}function wt(e,t){const r=mt(t),s=r?[f(1,0,0),f(0,0,0),f(0,1,0)]:[f(1,0,0),f(-1,0,0)],i=X.createPolylineGeometry(s),a=[...Le,1],o=r?4:1,n=2*o,c=e=>e>1?(e=>new Me({color:a,width:e,renderOccluded:4}))(e):new _e({color:a,renderOccluded:4}),d=[{geometry:i,material:c(o),stateMask:1|xt},{geometry:i,material:c(n),stateMask:2|xt},{geometry:i,material:c(1),stateMask:Ot}],l=new H({view:e,renderObjects:d,collisionType:{type:"line",paths:[s]},autoScaleRenderObjects:!1,worldSized:!0,radius:r?6:4,idHint:r?1:2});return l.state=xt,l}function vt(e,t,r,s=new je){if(y(e))return null;const i=v(s.position)?s.position:new Pe;t.fromRenderCoords(e.origin,i,r),s.position=i;const o=t.worldUpAtPosition(e.origin,V.get()),n=t.worldBasisAtPosition(e.origin,1,V.get());return s.width=2*a(e.basis1),s.height=2*a(e.basis2),s.tilt=b(yt(e,o)),s.heading=b(function(e,t,r){return D(e.basis1,r,t)-Ct}(e,o,n)),s}function yt(e,t){return D(t,e.basis2,e.basis1)+Ct}function _t(e,t,s=A()){if(y(e)||y(e.position))return null;let i=e.position;return e.position.hasZ||(i=e.position.clone(),i.z=_(we(t.elevationProvider,e.position),0)),function(e,t,s,i,a,o,n=A()){return o.toRenderCoords(e,n.origin)?(o.worldBasisAtPosition(n.origin,0,n.basis1),o.worldBasisAtPosition(n.origin,1,n.basis2),F(n.basis2,n.basis1,n.origin,n.plane),T(n,-r(t),E(n),n),T(n,r(s),n.basis1,n),c(n.basis1,n.basis1,i/2),c(n.basis2,n.basis2,a/2),G(n),n):(Qe.error(`Failed to project slice plane position, projection from ${e.spatialReference.wkid} is not supported`),null)}(i,e.heading,e.tilt,e.width,e.height,t.renderCoordsHelper,s)}function Mt(t){switch(t.type){case"building-scene":case"csv":case"direct-line-measurement":case"area-measurement":case"feature":case"geo-rss":case"geojson":case"graphics":case"group":case"integrated-mesh":case"kml":case"line-of-sight":case"map-notes":case"ogc-feature":case"point-cloud":case"route":case"slice":case"scene":case"stream":case"voxel":case"subtype-group":case"unknown":case"unsupported":case"wfs":case null:return!1;case"base-dynamic":case"base-elevation":case"base-tile":case"bing-maps":case"elevation":case"imagery":case"imagery-tile":case"map-image":case"open-street-map":case"tile":case"vector-tile":case"wcs":case"web-tile":case"wms":case"wmts":return!0;default:return e(t.type),!1}}const jt=16,Pt=32,kt=z(),Ct=Math.PI/2,xt=16,Ot=32;export{We as A,mt as B,Pt as C,jt as D,xt as E,Ot as F,Ie as G,gt as H,Oe as I,Ae as P,ft as a,st as b,bt as c,Ee as d,Re as e,Ye as f,Ge as g,pt as h,Mt as i,ht as j,wt as k,Ce as l,ke as m,it as n,Te as o,vt as p,tt as q,et as r,_t as s,Xe as t,xe as u,at as v,nt as w,ct as x,ot as y,rt as z};
