/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import e from"../request.js";import{f as t,s as r,h as a}from"./arrayUtils.js";import n from"../core/Error.js";import{h as o,i as s,b as i,G as l,H as c}from"../core/lang.js";import{eachAlways as f}from"../core/promiseUtils.js";import{d as u}from"./mat3.js";import{c as h}from"./quatf64.js";import{d as p}from"./mat4.js";import{c as m}from"./mat4f64.js";import{a as d,m as y,c as b}from"./quat.js";import{b as g}from"./quatf32.js";import{b as w,e as M,k as v,$ as S,E as x,f as j,g as q,t as R}from"./mathUtils.js";import{a as T}from"./vec4f64.js";import{computeTranslationToOriginAndRotation as k,projectBoundingSphere as z,canProjectWithoutEngine as F,projectBuffer as I,projectVectorToVector as W}from"../geometry/projection.js";import{g as A,c as G}from"./projectionEllipsoid.js";import L,{k as C}from"../geometry/SpatialReference.js";import{c as E}from"./aaBoundingBox.js";import{c as K,e as B,l as O,g as P}from"./aaBoundingRect.js";import U from"../rest/support/Query.js";import{r as $}from"./I3SBinaryReader.js";import{i as Q,p as H,h as V}from"./ElevationQuery.js";import{a as Z,b as D,d as J}from"../views/SceneView.js";function N(e,t,r,a){const n=X(e,t,r),o=m();return k(r,n,o,a),o}function X(e,t,r){const a=w(),n=e[3],o=2**(4*Math.ceil(Math.log(n)*Math.LOG2E/4)+1);if(r.isGeographic){const t=o/A(r).radius*180/Math.PI,n=Math.round(e[1]/t),s=Math.max(-90,Math.min(90,n*t)),i=t/Math.cos((Math.abs(s)-t/2)/180*Math.PI),l=Math.round(e[0]/i)*i;a[0]=l,a[1]=s}else{const t=Math.round(e[0]/o),r=Math.round(e[1]/o);a[0]=t*o,a[1]=r*o}const s=e[2]+t,i=Math.round(s/o);return a[2]=i*o,a}function Y(e){return e&&parseInt(e.substring(e.lastIndexOf("/")+1,e.length),10)}function _(e){if(o("disable-feature:i3s-draco")||!e)return!1;for(const r of e)for(const e of r.geometryBuffers){var t;if("draco"===(null==(t=e.compressedAttributes)?void 0:t.encoding))return!0}return!1}function ee(e,t,r,a,n,o){n.traverse(r,(r=>{let n=r.mbs;t!==a&&(n=oe,z(r.mbs,a,n,t));const s=function(e,t){const r=t[0],a=t[1],n=t[3],o=e[0]-r,s=r-e[2],i=e[1]-a,l=a-e[3],c=Math.max(o,s,0),f=Math.max(i,l,0),u=c*c+f*f;if(u>n*n)return 0;if(u>0)return 1;if(-Math.max(o,s,i,l)>n)return 3;return 2}(e,n);return 0!==s&&(o(r,s),!0)}))}function te(e,t,r){let a=0,n=0;for(let o=0;o<t.length&&a<e.length;o++)e[a]===t[o]&&(r(o)&&(e[n]=e[a],n++),a++);e.length=n}function re(e,t,r){let n=0,o=0;for(;n<r.length;){a(e,r[n])>=0===t&&(r[o]=r[n],o++),n++}r.length=o}const ae=E();function ne(e,t){if(0===t.rotationScale[1]&&0===t.rotationScale[2]&&0===t.rotationScale[3]&&0===t.rotationScale[5]&&0===t.rotationScale[6]&&0===t.rotationScale[7])return ae[0]=(e[0]-t.position[0])/t.rotationScale[0],ae[1]=(e[1]-t.position[1])/t.rotationScale[4],ae[2]=(e[2]-t.position[2])/t.rotationScale[8],ae[3]=(e[3]-t.position[0])/t.rotationScale[0],ae[4]=(e[4]-t.position[1])/t.rotationScale[4],ae[5]=(e[5]-t.position[2])/t.rotationScale[8],ae}const oe=T();function se(e,t){const r=t[0],a=t[1],n=t[2],o=t[3],s=e[0]-r,i=r-e[3],l=e[1]-a,c=a-e[4],f=e[2]-n,u=n-e[5],h=Math.max(s,i,0),p=Math.max(l,c,0),m=Math.max(f,u,0),d=h*h+p*p+m*m;if(d>o*o)return 0;if(d>0)return 1;return-Math.max(s,i,l,c,f,u)>o?3:2}function ie(e,t,r){const a=[],n=r&&r.missingFields,o=r&&r.originalFields;for(const r of e){const e=r.toLowerCase();let s=!1;for(const n of t)if(e===n.name.toLowerCase()){a.push(n.name),s=!0,o&&o.push(r);break}!s&&n&&n.push(r)}return a}async function le(r,a,o,l,c){if(0===a.length)return[];const u=r.attributeStorageInfo;if(s(r.associatedLayer))try{return await async function(e,t,r,a){t.sort(((e,t)=>e.attributes[r]-t.attributes[r]));const n=t.map((e=>e.attributes[r])),o=[],s=ie(a,e.fields,{originalFields:o}),i=await ce(e,n,s);for(let e=0;e<t.length;e++){const r=t[e],a=i[e],n={};if(r.attributes)for(const e in r.attributes)n[e]=r.attributes[e];for(let e=0;e<o.length;e++)n[o[e]]=a[s[e]];r.attributes=n}return t}(r.associatedLayer,a,o,l)}catch(e){if(r.associatedLayer.loaded)throw e}if(u){const s=function(e,t,r){const a=new Map,n=[],o=r();for(const r of e){const e=r.attributes[t];for(let t=0;t<o.length;t++){const s=o[t],i=s.featureIds.indexOf(e);if(i>=0){let e=a.get(s.node);e||(e={node:s.node,indices:[],graphics:[]},n.push(e),a.set(s.node,e)),e.indices.push(i),e.graphics.push(r);for(let e=t;e>0;e--)o[e]=o[e-1];o[0]=s;break}}}return n}(a,o,c);if(i(s))throw new n("scenelayer:features-not-loaded","Tried to query attributes for unloaded features");const h=r.parsedUrl.path,p=await Promise.all(s.map((t=>function(t,r,a,n,o){const s=[];for(const e of r)if(e&&-1!==o.indexOf(e.name)){const r=`${t}/nodes/${a.resources.attributes}/attributes/${e.key}/0`;s.push({url:r,storageInfo:e})}return f(s.map((t=>e(t.url,{responseType:"array-buffer"}).then((e=>$(t.storageInfo,e.data)))))).then((e=>{const t=[];for(const r of n){const a={};for(let t=0;t<e.length;t++)null!=e[t].value&&(a[s[t].storageInfo.name]=fe(e[t].value,r));t.push(a)}return t}))}(h,u,t.node,t.indices,l).then((e=>{for(let r=0;r<t.graphics.length;r++){const a=t.graphics[r],n=e[r];if(a.attributes)for(const e in a.attributes)e in n||(n[e]=a.attributes[e]);a.attributes=n}return t.graphics})))));return t(p)}throw new n("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available")}function ce(e,a,o){const s=e.capabilities.query.maxRecordCount;if(null!=s&&a.length>s){const n=r(a,s);return Promise.all(n.map((t=>ce(e,t,o)))).then(t)}const i=new U({objectIds:a,outFields:o,orderByFields:[e.objectIdField]});return e.queryFeatures(i).then((e=>{if(e&&e.features&&e.features.length===a.length)return e.features.map((e=>e.attributes));throw new n("scenelayer:feature-not-in-associated-layer","Feature not found in associated feature layer")}))}function fe(e,t){if(!e)return null;const r=e[t];if(l(e))return-32768===r?null:r;if(c(e))return-2147483648===r?null:r;return r!=r?null:r}function ue(e){const t=e.store.indexCRS||e.store.geographicCRS,r=void 0===t?e.store.indexWKT:void 0;if(r){if(!e.spatialReference)throw new n("layerview:no-store-spatial-reference-wkt-index-and-no-layer-spatial-reference","Found indeWKT in the scene layer store but no layer spatial reference",{});if(r!==e.spatialReference.wkt)throw new n("layerview:store-spatial-reference-wkt-index-incompatible","The indeWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const a=t?new L(Y(t)):e.spatialReference;return a.equals(e.spatialReference)?e.spatialReference:a}function he(e){const t=e.store.vertexCRS||e.store.projectedCRS,r=void 0===t?e.store.vertexWKT:void 0;if(r){if(!e.spatialReference)throw new n("layerview:no-store-spatial-reference-wkt-vertex-and-no-layer-spatial-reference","Found vertexWKT in the scene layer store but no layer spatial reference",{});if(r!==e.spatialReference.wkt)throw new n("layerview:store-spatial-reference-wkt-vertex-incompatible","The vertexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const a=t?new L(Y(t)):e.spatialReference;return a.equals(e.spatialReference)?e.spatialReference:a}function pe(e,t){return i(t)?"@null":t===G(t)?"@ECEF":e.equals(t)?"":null!=t.wkid?"@"+t.wkid:null}function me(e,t,r){if(!F(e,t))throw new n("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});if("local"===r&&!function(e,t){return e.equals(t)||e.isWGS84&&t.isWebMercator}(e,t))throw new n("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{})}function de(e,t,r){const a=ue(e),n=he(e);me(a,t,r),me(n,t,r)}function ye(e){if(null==e.store||null==e.store.defaultGeometrySchema||(null!=(t=e.store.defaultGeometrySchema).geometryType&&"triangles"!==t.geometryType||null!=t.topology&&"PerAttributeArray"!==t.topology||null==t.vertexAttributes||null==t.vertexAttributes.position))throw new n("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{url:e.parsedUrl.path});var t}function be(e,t){de(e,t.spatialReference,t.viewingMode)}function ge(e){if(null==e.store||null==e.store.defaultGeometrySchema||(null==(t=e.store.defaultGeometrySchema).geometryType||"points"!==t.geometryType||null!=t.topology&&"PerAttributeArray"!==t.topology||null!=t.encoding&&""!==t.encoding&&"lepcc-xyz"!==t.encoding||null==t.vertexAttributes||null==t.vertexAttributes.position))throw new n("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{});var t}function we(e,t){me(e.spatialReference,t.spatialReference,t.viewingMode)}function Me(e){return"mesh-3d"===e.type}function ve(e){if(null==e||!function(e){return"simple"===e.type||"class-breaks"===e.type||"unique-value"===e.type}(e))return!0;if(("unique-value"===e.type||"class-breaks"===e.type)&&null==e.defaultSymbol)return!0;const t=e.getSymbols();if(0===t.length)return!0;for(const e of t){if(!Me(e)||0===e.symbolLayers.length)return!0;for(const t of e.symbolLayers.items)if("fill"!==t.type||i(t.material)||i(t.material.color)||"replace"!==t.material.colorMixMode)return!0}return!1}const Se=Q({color:[0,0,0,0],opacity:0});class xe{constructor(){this.edgeMaterial=null,this.material=null,this.castShadows=!0}}function je(e){const t=new xe;let r=!1,a=!1;for(const n of e.symbolLayers.items)if("fill"===n.type&&n.enabled){const e=n.material,o=n.edges;if(s(e)&&!r){const a=e.color,o=H(e.colorMixMode);s(a)?t.material={color:[a.r/255,a.g/255,a.b/255],alpha:a.a,colorMixMode:o}:t.material={color:[1,1,1],alpha:1,colorMixMode:1},t.castShadows=n.castShadows,r=!0}s(o)&&!a&&(t.edgeMaterial=V(o,{}),a=!0)}return t.material||(t.material={color:[1,1,1],alpha:1,colorMixMode:1}),t}function qe(e,t){return(0|e)+(0|t)|0}function Re(e,t,r,a,n=0){a===G(a)?t.isGeographic?function(e,t,r,a){const n=A(r),o=1+Math.max(0,a)/(n.radius+e.center[2]);M(t.center,e.center[0],e.center[1],e.center[2]+a),I(t.center,r,0,t.center,G(r),0,1),d(t.quaternion,e.quaternion),b(Ge,e.quaternion),M(Be,0,0,1),x(Be,Be,Ge),M(Be,e.halfSize[0]*Math.abs(Be[0]),e.halfSize[1]*Math.abs(Be[1]),e.halfSize[2]*Math.abs(Be[2])),j(Be,Be,n.inverseFlattening),q(t.halfSize,e.halfSize,Be),j(t.halfSize,t.halfSize,o)}(e,r,t,n):function(e,t,r,a){J(e,Le),M(t.center,e.center[0],e.center[1],e.center[2]+a),k(r,t.center,Ae,G(r)),M(t.center,Ae[12],Ae[13],Ae[14]);const n=2*Math.sqrt(1+Ae[0]+Ae[5]+Ae[10]);Ge[0]=(Ae[6]-Ae[9])/n,Ge[1]=(Ae[8]-Ae[2])/n,Ge[2]=(Ae[1]-Ae[4])/n,Ge[3]=.25*n,y(t.quaternion,Ge,e.quaternion),b(Ge,t.quaternion);let o=0,s=0,i=0;for(const e of Le)e[2]+=a,I(e,r,0,e,G(r),0,1),S(Be,e,t.center),x(Be,Be,Ge),o=Math.max(o,Math.abs(Be[0])),s=Math.max(s,Math.abs(Be[1])),i=Math.max(i,Math.abs(Be[2]));M(t.halfSize,o,s,i)}(e,r,t,n):t.isWGS84&&(a.isWebMercator||C(a))?function(e,t,r,a,n){const o=u(Ie,t.quaternion);v(Fe,t.center),Fe[2]+=n;const s=G(r);I(Fe,e,0,Fe,s,0,1);for(let e=0;e<8;++e){for(let r=0;r<3;++r)ze[r]=t.halfSize[r]*(0!=(e&1<<r)?-1:1);for(let t=0;t<3;++t){let r=Fe[t];for(let e=0;e<3;++e)r+=ze[e]*o[3*e+t];Te[3*e+t]=r}}I(Te,s,0,Te,r,0,8),D(ke,a)}(t,e,a,r,n):e===r?(r.center[2]+=n,I(r.center,t,0,r.center,a,0,1)):(M(r.center,e.center[0],e.center[1],e.center[2]+n),I(r.center,t,0,r.center,a,0,1),d(r.quaternion,e.quaternion),v(r.halfSize,e.halfSize))}const Te=new Float64Array(24),ke={data:Te,size:3},ze=w(),Fe=w(),Ie=h();function We(e,t,r,a,n,o){if(!o||0===o.length||i(t))return null;const l=N(e.mbs,n,r,t);let c;p(Pe,l);let f=1/0,u=-1/0;const h=o=>{if("replace"!==o.type)return;const i=o.geometry;if(!i.hasZ)return;B(Ce);const l=i.spatialReference||a,h=i.rings.reduce(((e,r)=>r.reduce(((e,r)=>(W(r,l,Be,t),R(Be,Be,Pe),O(Ce,Be),Math.min(Be[2],e))),e)),1/0);(()=>{if(!c)if(c=Le,B(Ee),s(e.serviceObb)){Re(e.serviceObb,r,Ke,t,n),J(Ke,c);for(const e of c)R(e,e,Pe),O(Ee,e)}else{const a=e.mbs,o=a[3];W(a,r,Be,t),R(Be,Be,Pe),Be[2]+=n;for(let e=0;e<8;++e){const t=1&e?o:-o,r=2&e?o:-o,a=4&e?o:-o,n=c[e];v(n,[Be[0]+t,Be[1]+r,Be[2]+a]),O(Ee,n)}}})(),P(Ee,Ce)&&(f=Math.min(f,h),u=Math.max(u,h))};if(o.forEach((e=>h(e))),f===1/0)return null;for(let e=0;e<8;++e)m=Oe.data,d=3*e,y=c[e],R(Be,y,l),m[d+0]=Be[0],m[d+1]=Be[1],m[d+2]=Be[2],d+=24,y[2]=f,R(Be,y,l),m[d+0]=Be[0],m[d+1]=Be[1],m[d+2]=Be[2],d+=24,y[2]=u,R(Be,y,l),m[d+0]=Be[0],m[d+1]=Be[1],m[d+2]=Be[2];var m,d,y;return D(Oe)}const Ae=m(),Ge=g(),Le=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],Ce=K(),Ee=K(),Ke=Z(),Be=[0,0,0],Oe={data:new Array(72),size:3},Pe=m();export{ye as a,be as b,me as c,pe as d,N as e,ie as f,ue as g,We as h,X as i,te as j,se as k,qe as l,je as m,fe as n,ne as o,re as p,Re as q,ve as r,he as s,Se as t,ee as u,ge as v,le as w,we as x,de as y,_ as z};
