/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import{g as s}from"./assets.js";import{b as t,t as o}from"./colorUtils2.js";import{b as e,i as r}from"../core/lang.js";import l from"../core/Error.js";import{L as i}from"./Logger.js";import{eachAlways as a}from"../core/promiseUtils.js";import{a as m}from"./screenUtils.js";import{k as p,l as n,i as c,m as u,e as y}from"./utils2.js";import{d as h}from"../symbols/IconSymbol3DLayer.js";import{d as j}from"../symbols/ObjectSymbol3DLayer.js";import{h as b,i as f,t as d,s as g,j as S,k as v,l as k,m as M,n as L,o as x,p as w,q as D,u as U}from"./renderUtils.js";import{r as P}from"./styleUtils.js";import"../config.js";import"./object.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"./Message.js";import"./string.js";import"../Color.js";import"./colorUtils.js";import"./mathUtils.js";import"./common.js";import"./ensureType.js";import"../symbols.js";import"../core/accessorSupport/decorators/subclass.js";import"./metadata.js";import"./handleUtils.js";import"../symbols/CIMSymbol.js";import"./tslib.es6.js";import"../core/accessorSupport/decorators/property.js";import"./enumeration.js";import"./jsonMap.js";import"./reader.js";import"./writer.js";import"../layers/support/fieldUtils.js";import"./arcadeOnDemand.js";import"../geometry.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"./JSONSupport.js";import"../core/Accessor.js";import"./deprecate.js";import"./ArrayPool.js";import"./arrayUtils.js";import"../core/scheduling.js";import"../geometry/SpatialReference.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"./Ellipsoid.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./extentUtils.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"../symbols/Symbol.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils.js";import"../symbols/edges/Edges3D.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/StylePattern3D.js";import"./symbolLayerUtils3D.js";import"./aaBoundingBox.js";import"./aaBoundingRect.js";import"./Symbol3DOutline.js";import"../symbols/Font.js";import"../symbols/LabelSymbol3D.js";import"../core/Collection.js";import"./Evented.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../portal/Portal.js";import"../intl.js";import"./number.js";import"./locale.js";import"./Loadable.js";import"./Promise.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"./persistableUrlUtils.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"./Thumbnail.js";import"./Symbol3DVerticalOffset.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"./asyncUtils.js";import"./ItemCache.js";import"./MemCache.js";import"../symbols/support/cimSymbolUtils.js";import"./utils3.js";import"./projector.js";import"./widgetUtils.js";import"./mat2df32.js";import"./mat2d.js";import"./jsxFactory.js";import"./jsxWidgetSupport.js";import"./devEnvironmentUtils.js";import"../symbols/support/jsonUtils.js";import"./symbolConversion.js";const z=i.getLogger("esri.symbols.support.previewSymbol3D");function C(s){const t=s.outline,o=r(s.material)?s.material.color:null,l=r(o)?o.toHex():null;if(e(t)||"none"===t.pattern)return"fill"===s.type&&"#ffffff"===l?{color:"#bdc3c7",width:.75}:null;const i=m(t.size)||0;return{color:"rgba("+(r(t.color)?t.color.toRgba():"255,255,255,1")+")",width:Math.min(i,80),style:"pattern"in s?u(t.pattern):null,join:"butt",cap:t.patternCap}}function E(s,e=1){const r=s.a,l=t(s),i=l.h,a=l.s/e,m=100-(100-l.v)/e,{r:p,g:n,b:c}=o({h:i,s:a,v:m});return[p,n,c,r]}function O(s){return"water"===s.type?e(s.color)?null:s.color:e(s.material)||e(s.material.color)?null:s.material.color}function F(s,t=0){const o=O(s);if(!o){if("fill"===s.type)return null;const o=p.r,e=b(o,t);return[e,e,e,100]}const e=o.toRgba();for(let s=0;s<3;s++)e[s]=b(e[s],t);return e}async function I(t,o){const e=t.style;if("none"===e)return null;return{type:"pattern",x:0,y:0,src:await n(s(`esri/symbols/patterns/${e}.png`),o.toCss(!0)),width:5,height:5}}function R(s){return s.outline?C(s):{color:"rgba(0, 0, 0, 1)",width:1.5}}function T(s,t){const o=O(s);if(!o)return null;let e="rgba(";return e+=b(o.r,t)+",",e+=b(o.g,t)+",",e+=b(o.b,t)+",",e+o.a+");"}function q(s,t){const o=T(s,t);if(!o)return{};if("pattern"in s&&"none"===s.pattern)return null;return{color:o,width:Math.min(s.size?m(s.size):.75,80),style:"pattern"in s?u(s.pattern):null,cap:"cap"in s?s.cap:null,join:"join"in s?"miter"===s.join?m(2):s.join:null}}function A(s,t,o){const e=.75*o;return{type:"linear",x1:e?.25*e:0,y1:e?.5*e:0,x2:e||4,y2:e?.5*e:4,colors:[{color:s,offset:0},{color:t,offset:1}]}}function B(t,o){const e=o&&o.size?m(o.size):null,r=o&&o.maxSize?m(o.maxSize):null,l=o&&o.disableUpsampling,i=t.symbolLayers,p=[];let n=0,c=0;const u=i.getItemAt(i.length-1);let b;return u&&"icon"===u.type&&(b=u.size&&m(u.size)),i.forEach((i=>{if("icon"!==i.type&&"object"!==i.type)return;const a="icon"===i.type?i.size&&m(i.size):0,u=e||a?Math.ceil(Math.min(e||a,r||120)):22;if(i&&i.resource&&i.resource.href){const o=function(t,o){const e=o&&o.resource,r=e&&e.href;if(t.thumbnail&&t.thumbnail.url)return Promise.resolve(t.thumbnail.url);if(r&&"object"!==o.type)return Promise.resolve(y(t,o));const l=s("esri/images/Legend/legend3dsymboldefault.png");return t.styleOrigin&&(t.styleOrigin.styleName||t.styleOrigin.styleUrl)?P(t.styleOrigin,{portal:t.styleOrigin.portal},"webRef").catch((s=>s)).then((s=>{var t;return(null==s||null==(t=s.thumbnail)?void 0:t.url)||l})):Promise.resolve(l)}(t,i).then((function(s){const t=i.get("material.color"),o=function(s){return"icon"===s.type?"multiply":"tint"}(i);return d(s,u,t,o,l)})).then((function(s){const t=s.width,o=s.height;return n=Math.max(n,t),c=Math.max(c,o),[{shape:{type:"image",x:0,y:0,width:t,height:o,src:s.url},fill:null,stroke:null}]}));p.push(o)}else{var f;let s=u;"icon"===i.type&&b&&e&&(s=u*(a/b));const t="tall"===(null==o?void 0:o.symbolConfig)||(null==o||null==(f=o.symbolConfig)?void 0:f.isTall)||"object"===i.type&&function(s){const t=s.depth,o=s.height,e=s.width;return e&&t&&o&&e===t&&e<o}(i);n=Math.max(n,t?20:s),c=Math.max(c,s),p.push(Promise.resolve(function(s,t,o){const e=[];if(!s)return e;switch(s.type){case"icon":{const o=0,r=0,l=t,i=t;switch(s.resource&&s.resource.primitive||h){case"circle":e.push({shape:{type:"circle",cx:0,cy:0,r:.5*t},fill:F(s,0),stroke:C(s)});break;case"square":e.push({shape:{type:"path",path:[{command:"M",values:[o,i]},{command:"L",values:[o,r]},{command:"L",values:[l,r]},{command:"L",values:[l,i]},{command:"Z",values:[]}]},fill:F(s,0),stroke:C(s)});break;case"triangle":e.push({shape:{type:"path",path:[{command:"M",values:[o,i]},{command:"L",values:[.5*l,r]},{command:"L",values:[l,i]},{command:"Z",values:[]}]},fill:F(s,0),stroke:C(s)});break;case"cross":e.push({shape:{type:"path",path:[{command:"M",values:[.5*l,r]},{command:"L",values:[.5*l,i]},{command:"M",values:[o,.5*i]},{command:"L",values:[l,.5*i]}]},stroke:R(s)});break;case"x":e.push({shape:{type:"path",path:[{command:"M",values:[o,r]},{command:"L",values:[l,i]},{command:"M",values:[l,r]},{command:"L",values:[o,i]}]},stroke:R(s)});break;case"kite":e.push({shape:{type:"path",path:[{command:"M",values:[o,.5*i]},{command:"L",values:[.5*l,r]},{command:"L",values:[l,.5*i]},{command:"L",values:[.5*l,i]},{command:"Z",values:[]}]},fill:F(s,0),stroke:C(s)})}break}case"object":switch(s.resource&&s.resource.primitive||j){case"cone":{const r=A(F(s,0),F(s,-.6),o?20:t),l=x(t,o);e.push({shape:l[0],fill:r}),e.push({shape:l[1],fill:r});break}case"inverted-cone":{const o=F(s,0),r=A(o,F(s,-.6),t),l=L(t);e.push({shape:l[0],fill:r}),e.push({shape:l[1],fill:o});break}case"cube":{const r=M(t,o);e.push({shape:r[0],fill:F(s,0)}),e.push({shape:r[1],fill:F(s,-.3)}),e.push({shape:r[2],fill:F(s,-.5)});break}case"cylinder":{const r=A(F(s,0),F(s,-.6),o?20:t),l=k(t,o);e.push({shape:l[0],fill:r}),e.push({shape:l[1],fill:r}),e.push({shape:l[2],fill:F(s,0)});break}case"diamond":{const o=v(t);e.push({shape:o[0],fill:F(s,-.3)}),e.push({shape:o[1],fill:F(s,0)}),e.push({shape:o[2],fill:F(s,-.3)}),e.push({shape:o[3],fill:F(s,-.7)});break}case"sphere":{const o=A(F(s,0),F(s,-.6));o.x1=0,o.y1=0,o.x2=.25*t,o.y2=.25*t,e.push({shape:{type:"circle",cx:0,cy:0,r:.5*t},fill:o});break}case"tetrahedron":{const o=S(t);e.push({shape:o[0],fill:F(s,-.3)}),e.push({shape:o[1],fill:F(s,0)}),e.push({shape:o[2],fill:F(s,-.6)});break}}}return e}(i,s,t)))}})),a(p).then((function(s){const t=[];return s.forEach((function(s){s.value?t.push(s.value):s.error&&z.warn("error while building swatchInfo!",s.error)})),f(t,[n,c],{node:o&&o.node,scale:!1,opacity:o&&o.opacity})}))}function N(s,t){if(0===s.symbolLayers.length)return Promise.reject(new l("symbolPreview: renderPreviewHTML3D","No symbolLayers in the symbol."));switch(s.type){case"point-3d":return B(s,t);case"line-3d":return function(s,t){const o=s.symbolLayers,r=[],l=c(s),i=t&&t.size?m(t.size):null,a=(t&&t.maxSize?m(t.maxSize):null)||80;let p,n=0,u=0;return o.forEach(((s,t)=>{if(!s)return;if("line"!==s.type&&"path"!==s.type)return;const o=[];switch(s.type){case"line":{const r=q(s,0);if(e(r))break;const l=r&&r.width||0;0===t&&(p=l);const m=Math.min(i||l,a),c=0===t?m:i?m*(l/p):m,y=c>20?2*c:40;u=Math.max(u,c),n=Math.max(n,y),r.width=c,o.push({shape:{type:"path",path:[{command:"M",values:[0,.5*u]},{command:"L",values:[n,.5*u]}]},stroke:r});break}case"path":{const t=Math.min(i||22,a),e=F(s,0),r=F(s,-.2),l=T(s,-.4),m=l?{color:l,width:1}:{};if("quad"===s.profile){const t=s.width,l=s.height,i=w(t&&l?t/l:1,0===l,0===t),a={...m,join:"bevel"};o.push({shape:i[0],fill:r,stroke:a}),o.push({shape:i[1],fill:r,stroke:a}),o.push({shape:i[2],fill:e,stroke:a})}else o.push({shape:g.pathSymbol3DLayer[0],fill:r,stroke:m}),o.push({shape:g.pathSymbol3DLayer[1],fill:e,stroke:m});u=Math.max(u,t),n=u}}r.push(o)})),Promise.resolve(f(r,[n,u],{node:t&&t.node,scale:l,opacity:t&&t.opacity}))}(s,t);case"polygon-3d":case"mesh-3d":return async function(s,t){const o="mesh-3d"===s.type,l=s.symbolLayers,i=t&&t.size?m(t.size):null,a=t&&t.maxSize?m(t.maxSize):null,p=i||22,n=[];let c=0,u=0,y=!1;for(let s=0;s<l.length;s++){const t=l.getItemAt(s),i=[];if(o&&"fill"!==t.type)continue;const m=g.fill[0];switch(t.type){case"fill":{const s=C(t),e=Math.min(p,a||120);c=Math.max(c,e),u=Math.max(u,e),y=!0;let l=F(t,0);const n="pattern"in t&&t.pattern,h=O(t);!o&&r(n)&&"style"===n.type&&"solid"!==n.style&&h&&(l=await I(n,h)),i.push({shape:m,fill:l,stroke:s});break}case"line":{const s=q(t,0);if(e(s))break;const o={stroke:s,shape:m};c=Math.max(c,22),u=Math.max(u,22),i.push(o);break}case"extrude":{const s={join:"round",width:1,...q(t,-.4)},o=F(t,0),e=F(t,-.2),r=Math.min(p,a||120),l=U(r);s.width=1,i.push({shape:l[0],fill:e,stroke:s}),i.push({shape:l[1],fill:e,stroke:s}),i.push({shape:l[2],fill:o,stroke:s});const m=22,n=22*.7+.5*r;c=Math.max(c,m),u=Math.max(u,n);break}case"water":{const s=O(t),o=E(s),e=E(s,2),r=E(s,3),l=D();y=!0,i.push({shape:l[0],fill:o}),i.push({shape:l[1],fill:e}),i.push({shape:l[2],fill:r});const m=Math.min(p,a||120);c=Math.max(c,m),u=Math.max(u,m);break}}n.push(i)}return Promise.resolve(f(n,[c,u],{node:t&&t.node,scale:y,opacity:t&&t.opacity}))}(s,t)}return Promise.reject(new l("symbolPreview: swatchInfo3D","symbol not supported."))}export{I as getPatternDescriptor,F as getSymbolLayerFill,N as previewSymbol3D};
