/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import{r as e,i as t,clone as s,b as n,d as r}from"../core/lang.js";import{_ as i}from"./tslib.es6.js";import o from"../request.js";import a from"../core/Accessor.js";import{r as l}from"./arrayUtils.js";import u from"../core/Error.js";import{createResolver as c,onAbort as h,createAbortError as f,throwIfAborted as d,isAbortError as p,createAbortController as m}from"../core/promiseUtils.js";import{property as g}from"../core/accessorSupport/decorators/property.js";import"./ensureType.js";import"./Logger.js";import{subclass as k}from"../core/accessorSupport/decorators/subclass.js";import{a as y}from"./Util.js";import{T as b}from"./Scheduler.js";import{b as w,k as T,s as _,d as v,g as x,f as L}from"./mathUtils.js";import{canProjectToWGS84ComparableLonLat as S}from"../geometry/projection.js";import{b as I,s as j,n as E,c as Q}from"./aaBoundingRect.js";import{T as W,c as q}from"./TerrainConst.js";import{f as M,h as R}from"../geometry/SpatialReference.js";class C{constructor(e){this.typeWorkerQuota=e,this.tasks=new Array,this.numWorkers=0,this.statistics=new z}}class z{constructor(){this.requests=0,this.size=0,this.duration=0,this.speed=0}}class F{constructor(e,t,s,n){this._workerFunc=e,this._callbackFunc=t,this._maxTotalNumWorkers=s,this._totalNumWorkers=0,this._clients=n.map((e=>new C(e)))}hasQuota(e){const t=this._clients[e];return!!t&&(this._totalNumWorkers<this._maxTotalNumWorkers||t.numWorkers+t.tasks.length<t.typeWorkerQuota)}push(e){const t=this._clients[e.client];t&&(this._totalNumWorkers<this._maxTotalNumWorkers?(t.numWorkers++,this._totalNumWorkers++,this._workerFunc(e,((e,t)=>this._taskCallback(e,t)))):t.tasks.push(e))}cancel(e){this._taskFinished(e),e._cancelled=!0}destroy(){this._clients.length=0}_taskFinished(e){const t=this._clients[e.client];this._totalNumWorkers--,t.numWorkers--,t.statistics.requests++,t.statistics.size+=e.size||0,t.statistics.duration+=e.duration||0,t.statistics.speed=t.statistics.duration>0?t.statistics.size/t.statistics.duration:0,y(t.numWorkers>=0),this._next()}_next(){for(const e of this._clients)if(e&&e.numWorkers<e.typeWorkerQuota&&this._processQueue(e))return;for(const e of this._clients)if(e&&this._processQueue(e))return}_processQueue(e){for(;e.tasks.length>0;)if(this._workerFunc(e.tasks.shift(),((e,t)=>this._taskCallback(e,t))))return e.numWorkers++,this._totalNumWorkers++,!0;return!1}_taskCallback(e,t){e._cancelled||(this._callbackFunc(e,t),this._taskFinished(e))}getStatsForType(e){const t=this._clients[e];return t?{quota:t.typeWorkerQuota,workers:t.numWorkers,queueSize:t.tasks.length,requestStats:t.statistics}:null}get test(){const e=this;return{set workerFunc(t){e._workerFunc=t}}}}class A extends class{constructor(e){this.client=e,this._cancelled=!1,this.size=0,this.duration=0}}{constructor(e,t,s,n,r){super(n),this.url=e,this.options=t,this.docType=s,this.key=r,this.result=null,this.status=1,this.request=null,this.abortController=null,this.resolvers=new Array,this.startTime=0}}let O=class extends a{constructor(){super(...arguments),this.tasks=new Map,this.onLoadQueue=new Array,this.doneQueue=new Array,this.updating=!1}setup(e,t,s){this.loadQueue=new F(((e,t)=>this.startLoading(e,t)),((e,t)=>this.doneLoadingCallback(e,t)),e,t),s&&(this.taskHandle=s.registerTask(b.STREAM_DATA_LOADER,this))}destroy(){this.taskHandle=e(this.taskHandle),this.tasks.forEach((e=>{e.abortController&&e.abortController.abort()})),this.loadQueue.destroy(),this.loadQueue=null,this.onLoadQueue=null,this.doneQueue=null,this.tasks=null}hasDownloadSlots(e){return this.loadQueue.hasQuota(e)}request(e,s,n,r={}){const i=c();i.__signal=t(r)?r.signal:null;const o=this.createOrUpdateTask(e,s,n,r,i);return h(r,(()=>this.cancelRequest(o,i))),i.promise}createTask(e,t,s,n,r,i){const o=new A(e,t,s,n,r);return this.updateTask(o,i),this.tasks.set(r,o),1===this.tasks.size&&this._set("updating",!0),this.loadQueue.push(o),o}cancelRequest(e,t){l(e.resolvers,t),t.reject(f()),0===e.resolvers.length&&(2===e.status&&(e.status=4,this.loadQueue.cancel(e),e.abortController.abort(),e.request=null,e.abortController=null),e.status=4,this.tasks.delete(e.key),0===this.tasks.size&&this._set("updating",!1))}taskKey(e,t,s){return`${e}:${t}:${s}`}updateTask(e,t){e.resolvers.push(t)}createOrUpdateTask(e,s,n,r,i){const o=t(r)&&r.uid||e,a=this.taskKey(o,s,n),l=this.tasks.get(a);return l?(this.updateTask(l,i),l):this.createTask(e,r,s,n,a,i)}doneLoadingCallback(e,t){this.loadQueue&&(y(2===e.status),e.status=3,this.taskHandle?this.doneQueue.push({task:e,err:t}):this.doneLoading(e,t))}get running(){return this.doneQueue.length>0||this.onLoadQueue.length>0}runTask(e){for(;!e.done&&this.onLoadQueue.length>0;){const t=this.onLoadQueue.shift();d(t.task.abortController),t.task.abortController=null,t.callback(t.task),e.madeProgress()}for(;!e.done&&this.doneQueue.length>0;){const t=this.doneQueue.shift();3!==t.task.status&&(t.err=t.err||f()),this.doneLoading(t.task,t.err),e.madeProgress()}}doneLoading(e,t){let n=e.result instanceof HTMLImageElement?0:e.resolvers.length;for(const r of e.resolvers)if(t)p(t)?r.reject(t):r.reject(new u("stream-data-loader:request-error",`Failed to request resource at '${e.url}'. ${t}`,{url:e.url,error:t}));else{--n;const t=n<=0?e.result:s(e.result);r.resolve(t)}this.tasks.delete(e.key),0===this.tasks.size&&this._set("updating",!1)}startLoading(e,t){if(4===e.status)return!1;let s,n;switch(e.startTime=performance.now(),e.status=2,e.docType){case"binary":n="array-buffer",s=0;break;case"image":n="image";break;case"image+type":n="array-buffer";break;default:n="json"}e.abortController=m();const r=e.abortController.signal;e.request=o(e.url,{...e.options,responseType:n,timeout:s,signal:r});let i=()=>{};const a=s=>{e.duration=performance.now()-e.startTime,e.size=s instanceof ArrayBuffer?s.byteLength:e.size||0,e.result=s,this.taskHandle?this.onLoadQueue.push({callback:t,task:e}):(e.abortController=null,t(e))},l=s=>{2===e.status&&t(e,s),i()};return"image+type"!==e.docType?(e.request.then((e=>a(e.data)),l),!0):(e.request.then((t=>{const u=t.data,c=function(e){if(e.byteLength<2)return"unknown";const t=new Uint8Array(e,0,e.byteLength);if(137===t[0]&&80===t[1])return"image/png";if(71===t[0]&&73===t[1])return"image/gif";if(66===t[0]&&77===t[1])return"image/bmp";if(255===t[0]&&216===t[1])return"image/jpeg";return"unknown"}(u);if(n="image",e.size=u.byteLength,"unknown"===c)return e.request=o(e.url,{responseType:n,timeout:s,signal:r}),void e.request.then((e=>a(e.data)),l);const h=new Blob([u],{type:c}),f=window.URL.createObjectURL(h);i=()=>window.URL.revokeObjectURL(f),e.request=o(f,{responseType:n,timeout:s,signal:r}),e.request.then((e=>a(new U(e.data,c,i))),l)}),l),!0)}get test(){return{loadQueue:this.loadQueue}}};i([g({readOnly:!0})],O.prototype,"updating",void 0),O=i([k("esri.views.3d.support.StreamDataLoader")],O);class U{constructor(e,t,s){this.image=e,this.type=t,this.release=s}get isOpaque(){return"image/jpeg"===this.type}}var N=O;const H=w(),B=w(),G=w(),D=w();function P(e,t,s,n){T(H,s),H[n]=t[n];const r=_(H,H,t),i=_(B,e,t),o=v(i,r),a=v(r,r);let l;l=o<=0?t:a<=o?s:x(H,t,L(r,r,o/a));const u=_(H,e,l);return Math.PI/2-Math.atan(u[2]/Math.sqrt(u[0]*u[0]+u[1]*u[1]))}var V=Object.freeze({__proto__:null,isInsideExtent:function(e,t,s=0){const r=e.extent;if(n(r))return!1;if(0===s)return I(r,t);const i=Math.min(r[2]-r[0],r[3]-r[1]);return j(r,t,s*i)},tiltToExtentEdge:function(e,t,s){const r=e.extent;if(n(r))return 0;G[0]=r[0],G[1]=r[1],G[2]=s,D[0]=r[2],D[1]=r[3],D[2]=s;let i=1/0,o=1/0;return t[0]<G[0]?i=P(t,G,D,0):t[0]>D[0]&&(i=P(t,D,G,0)),t[1]<G[1]?o=P(t,G,D,1):t[1]>D[1]&&(o=P(t,D,G,1)),Math.min(i,o)},checkIfTileInfoSupportedForViewSR:function(e,t,s){if(e.spatialReference.isGeographic&&!S(e.spatialReference))return new u("tilingscheme:local-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in local scenes");const n=W.checkUnsupported(e);if(n)return n;const r=function(e,t){const s=e.lods,n=s[0].resolution*2**s[0].level,r=[n*e.size[0],n*e.size[1]],i=[e.origin.x,e.origin.y],o=E(t),a=Q();W.computeRowColExtent(o,r,i,a);const l=(a[2]-a[0])*(a[3]-a[1]);if(l>q){const t=s[0].scale*2**s[0].level;let r=Math.max((o[3]-o[1])/e.size[1],(o[2]-o[0])/e.size[0])*t/n;const i=Math.floor(Math.log(r)/Math.log(10));return r=Math.ceil(r/10**i)*10**i,new u("tilingscheme:too-many-root-tiles","Scale of level 0 of the tiling scheme (1:"+Math.floor(t).toLocaleString()+") is too large for the layer's extent. Suggested scale: 1:"+r.toLocaleString()+".",{level0Scale:t,suggestedLevel0Scale:r,requiredNumRootTiles:l,allowedNumRootTiles:q})}return null}(e,s);return r||(t&&!e.spatialReference.equals(t)?new u("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the local scene"):null)}});const $={1:Object.freeze({__proto__:null,isInsideExtent:function(){return!0},tiltToExtentEdge:function(){return 0},checkIfTileInfoSupportedForViewSR:function(e,t){const s=e.lods.length-1,n=e.spatialReference,r=S(n)||M(n)||R(n);if(n.isWebMercator){if(!W.makeWebMercatorAuxiliarySphere(s).compatibleWith(e))return new u("tilingscheme:incompatible-global-web-mercator","The tiling scheme is not compatible with the ArcGIS Online Web Mercator tiling scheme")}else{if(!r)return new u("tilingscheme:global-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in global scenes");if(!W.makeGCSWithTileSize(e.spatialReference,e.size[0],s).compatibleWith(e))return e.spatialReference.isWGS84?new u("tilingscheme:incompatible-global-wgs84","The tiling scheme is not compatible with the ArcGIS Online WGS84 tiling scheme"):new u("tilingscheme:incompatible-global","The tiling scheme is not compatible with the ArcGIS Online tiling scheme")}if(t&&!e.spatialReference.equals(t))return new u("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the global scene")}}),2:V};function K(e,t){e||console.warn("Terrain: "+t)}const J=80/180*Math.PI,X=110/180*Math.PI;function Y(e,s,n){const i=$[e.viewingMode];let o;if(i.isInsideExtent(e,s))o=r(e.getElevation(s[0],s[1],s[1],e.spatialReference),0);else{if(!i.isInsideExtent(e,s,1.2))return 0;const n=e.getTileWithElevation(s[0],s[1],s[1],e.spatialReference);o=.5*((t(n)?n.elevationBounds[0]:e.elevationBounds.min)+(t(n)?n.elevationBounds[1]:e.elevationBounds.max));const r=i.tiltToExtentEdge(e,s,o);if(r>J&&r<X)return 0}const a=s[2]-o;return Math.abs(a)<n?0:a<0?-1:1}function Z(e){return se(e)?{fullExtent:e.fullExtent,minScale:e.layer.minScale,maxScale:e.layer.maxScale,tilemapCache:null}:e.layer}function ee(e){return"vector-tile"===(null==e?void 0:e.type)}function te(e){return"imagery-tile"===(null==e?void 0:e.type)||"wcs"===(null==e?void 0:e.type)}function se(e){return"imagery-tile-3d"===(null==e?void 0:e.type)}function ne(e){return"tile-3d"===(null==e?void 0:e.type)}function re(e){return"vector-tile-3d"===(null==e?void 0:e.type)}function ie(e){return"elevation-3d"===(null==e?void 0:e.type)}function oe(e){return e&&(ne(e)||se(e)||ie(e)||re(e)||function(e){return"wmts-3d"===(null==e?void 0:e.type)}(e))}function ae(e){var s;const n=null==e||null==(s=e.sourceLayerInfo)?void 0:s.data;return t(n)&&"type"in n&&"raster-tile"===n.type}function le(e){var s;const n=null==e||null==(s=e.sourceLayerInfo)?void 0:s.data;return t(n)&&"type"in n&&"vector-tile"===n.type}function ue(e){var s;const n=null==e||null==(s=e.sourceLayerInfo)?void 0:s.data;return t(n)&&"type"in n&&"tile-texture"===n.type}function ce(e){var t;const s=null==e||null==(t=e.sourceLayerInfo)?void 0:t.data;return s instanceof HTMLImageElement||s instanceof U||s instanceof HTMLCanvasElement||s instanceof ImageData}function he(e){return t(e)&&"release"in e&&e.release(),null}function fe(e){return e.fetchTile&&!1!==e.hasOverriddenFetchTile}function de(e,t,s,n){return $[n].checkIfTileInfoSupportedForViewSR(e,s,t)}function pe(e,t,s){let n,r;if("wmts"===e.type){const i=e.activeLayer;if(i){const e=i.tileMatrixSet;if(e)n=e.tileInfo,r=e.fullExtent;else{const e=i.tileMatrixSets;if(e){const n=e.find((e=>null==de(e.tileInfo,e.fullExtent,t,s)));if(n)return{tileInfo:n.tileInfo,fullExtent:n.fullExtent}}}}}else r=te(e)?e.getCompatibleFullExtent(t):e.fullExtent,n=ee(e)&&!me.force512VTL?e.compatibleTileInfo256:te(e)?e.getCompatibleTileInfo(t,r,2===s):e.tileInfo;return n&&r&&null==de(n,r,t,s)?{tileInfo:n,fullExtent:r}:{tileInfo:null,fullExtent:null}}const me={force512VTL:!1};export{U as I,N as S,Z as a,re as b,de as c,le as d,ae as e,ce as f,pe as g,ue as h,te as i,ee as j,Y as k,oe as l,ie as m,se as n,ne as o,he as r,fe as u,K as w};
