/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import{i as t,b as e}from"../core/lang.js";import n from"../layers/support/PixelBlock.js";function i(e){return t(e)&&"esri.layers.support.PixelBlock"===e.declaredClass&&e.pixels&&e.pixels.length>0}function l(t,e){if(null==e||!e.length||!i(t))return t;const l=t.pixels.length;return e&&e.some((t=>t>=l))||1===l&&1===e.length&&0===e[0]?t:l!==e.length||e.some(((t,e)=>t!==e))?new n({pixelType:t.pixelType,width:t.width,height:t.height,mask:t.mask,validPixelCount:t.validPixelCount,maskIsAlpha:t.maskIsAlpha,pixels:e.map((e=>t.pixels[e])),statistics:t.statistics&&e.map((e=>t.statistics[e]))}):t}function r(t){if(!t)return;const e=t.colormap;if(!e||0===e.length)return;const n=e.sort(((t,e)=>t[0]-e[0]));let i=0;n[0][0]<0&&(i=n[0][0]);const l=Math.max(256,n[n.length-1][0]-i+1),r=new Uint8Array(4*l),o=[];let s,a=0,f=0;const h=5===n[0].length;if(l>65536)return n.forEach((t=>{o[t[0]-i]=h?t.slice(1):t.slice(1).concat([255])})),{indexed2DColormap:o,offset:i,alphaSpecified:h};if(t.fillUnspecified)for(s=n[f],a=s[0]-i;a<l;a++)r[4*a]=s[1],r[4*a+1]=s[2],r[4*a+2]=s[3],r[4*a+3]=h?s[4]:255,a===s[0]-i&&(s=f===n.length-1?s:n[++f]);else for(a=0;a<n.length;a++)s=n[a],f=4*(s[0]-i),r[f]=s[1],r[f+1]=s[2],r[f+2]=s[3],r[f+3]=h?s[4]:255;return{indexedColormap:r,offset:i,alphaSpecified:h}}function o(t,e){if(!i(t))return t;if(!e&&(e.indexedColormap||e.indexed2DColormap))return t;const n=t.clone(),l=n.pixels;let r=n.mask;const o=n.width*n.height;if(1!==l.length)return t;const{indexedColormap:s,indexed2DColormap:a,offset:f,alphaSpecified:h}=e,u=s.length-1;let c=0;const x=l[0],p=new Uint8Array(x.length),m=new Uint8Array(x.length),d=new Uint8Array(x.length);let g,y=0;if(s)if(r)for(c=0;c<o;c++)r[c]&&(y=4*(x[c]-f),y<f||y>u?r[c]=0:(p[c]=s[y],m[c]=s[y+1],d[c]=s[y+2],r[c]=s[y+3]));else{for(r=new Uint8Array(o),c=0;c<o;c++)y=4*(x[c]-f),y<f||y>u?r[c]=0:(p[c]=s[y],m[c]=s[y+1],d[c]=s[y+2],r[c]=s[y+3]);n.mask=r}else if(r)for(c=0;c<o;c++)r[c]&&(g=a[x[c]],p[c]=g[0],m[c]=g[1],d[c]=g[2],r[c]=g[3]);else{for(r=new Uint8Array(o),c=0;c<o;c++)g=a[x[c]],p[c]=g[0],m[c]=g[1],d[c]=g[2],r[c]=g[3];n.mask=r}return n.pixels=[p,m,d],n.statistics=null,n.pixelType="u8",n.maskIsAlpha=h,n}function s(t){if(!i(t))return null;t.statistics||t.updateStatistics();const{pixels:e,mask:n,pixelType:l,statistics:r}=t,o=t.width*t.height,s=e.length;let a,f,h,u,c;const x=[],p=[];let m,d,g,y,w,M,k,A,U,C;const T=256;for(u=0;u<s;u++){if(m=new Uint32Array(T),g=e[u],"u8"===l)if(a=-.5,f=255.5,n)for(c=0;c<o;c++)n[c]&&m[g[c]]++;else for(c=0;c<o;c++)m[g[c]]++;else{if(a=r[u].minValue,f=r[u].maxValue,h=(f-a)/T,d=new Uint32Array(257),n)for(c=0;c<o;c++)n[c]&&d[Math.floor((g[c]-a)/h)]++;else for(c=0;c<o;c++)d[Math.floor((g[c]-a)/h)]++;for(c=0;c<255;c++)m[c]=d[c];m[255]=d[255]+d[256]}for(x.push({min:a,max:f,size:T,counts:m}),y=0,w=0,A=0,c=0;c<T;c++)y+=m[c],w+=c*m[c];for(U=w/y,c=0;c<T;c++)A+=m[c]*(c-U)**2;C=Math.sqrt(A/(y-1)),h=(f-a)/T,M=(U+.5)*h+a,k=C*h,p.push({min:a,max:f,avg:M,stddev:k})}return{statistics:p,histograms:x}}function a(t){const e=[];for(let n=0;n<t.length;n++){const{min:i,max:l,size:r,counts:o}=t[n];let s=0,a=0;for(let t=0;t<r;t++)s+=o[t],a+=t*o[t];const f=a/s;let h=0;for(let t=0;t<r;t++)h+=o[t]*(t-f)**2;const u=(l-i)/r,c=(f+.5)*u+i,x=Math.sqrt(h/(s-1))*u;e.push({min:i,max:l,avg:c,stddev:x})}return e}function f(t){const{minCutOff:e,maxCutOff:n,gamma:i,pixelType:l}=t,r=t.outMin||0,o=t.outMax||255;if(-1===["u8","u16","s8","s16"].indexOf(l))return null;const s=e.length;let a,f,h=0;"s8"===l?h=-127:"s16"===l&&(h=-32767);let u=256;["u16","s16"].indexOf(l)>-1&&(u=65536);const c=[],x=[],p=o-r;for(a=0;a<s;a++)x[a]=n[a]-e[a],c[a]=p/(n[a]-e[a]);const m=i&&i.length>=s,d=[];if(m)for(a=0;a<s;a++)i[a]>1?i[a]>2?d[a]=6.5+(i[a]-2)**2.5:d[a]=6.5+100*(2-i[a])**4:d[a]=1;let g;const y=[];let w,M,k;if(m)for(a=0;a<s;a++){for(k=[],f=0;f<u;f++)w=f+h,g=(w-e[a])/x[a],M=1,i[a]>1&&(M-=(1/p)**(g*d[a])),w<n[a]&&w>e[a]?k[f]=Math.floor(M*p*g**(1/i[a]))+r:w>=n[a]?k[f]=o:k[f]=r;y[a]=k}else for(a=0;a<s;a++){for(k=[],f=0;f<u;f++)w=f+h,w<=e[a]?k[f]=r:w>=n[a]?k[f]=o:k[f]=Math.floor((w-e[a])/x[a]*p)+r;y[a]=k}if(null!=t.contrastOffset){const e=function(t,e){const n=Math.min(Math.max(t,-100),100),i=Math.min(Math.max(e,-100),100),l=255,r=128;let o,s;const a=new Uint8Array(256);for(o=0;o<256;o++)n>0&&n<100?s=(200*o-100*l+2*l*i)/(2*(100-n))+r:n<=0&&n>-100?s=(200*o-100*l+2*l*i)*(100+n)/2e4+r:100===n?(s=200*o-100*l+(l+1)*(100-n)+2*l*i,s=s>0?l:0):-100===n&&(s=r),a[o]=s>l?l:s<0?0:s;return a}(t.contrastOffset,t.brightnessOffset);for(a=0;a<s;a++)for(k=y[a],f=0;f<u;f++)k[f]=e[k[f]]}return{lut:y,offset:h}}function h(t,e=256){e=Math.min(e,256);const{size:n,counts:i}=t,l=new Uint8Array(n),r=i.reduce(((t,n)=>t+n/e),0);let o=0,s=0,a=0,f=r;for(let t=0;t<n;t++)if(a+=i[t],!(t<n-1&&a+i[t+1]<f)){for(;o<e-1&&f<a;)o++,f+=r;for(let e=s;e<=t;e++)l[e]=o;s=t+1}for(let t=s;t<n;t++)l[t]=e-1;return l}function u(t,e){if(!i(t))return null;const n=t.clone(),{pixels:l,mask:r}=n,{minCutOff:o,maxCutOff:s,gamma:a}=e,f=e.outMin||0,h=e.outMax||255,u=n.width*n.height,c=l.length;let x,p,m,d,g;const y=h-f,w=[],M=[];for(x=0;x<c;x++)M[x]=s[x]-o[x],w[x]=y/(s[x]-o[x]);const k=a&&a.length>=c,A=[];if(k)for(x=0;x<c;x++)a[x]>1?a[x]>2?A[x]=6.5+(a[x]-2)**2.5:A[x]=6.5+100*(2-a[x])**4:A[x]=1;if(k)if(null!=r){for(p=0;p<u;p++)if(r[p])for(x=0;x<c;x++)m=l[x][p],g=(m-o[x])/M[x],d=1,a[x]>1&&(d-=(1/y)**(g*A[x])),m<s[x]&&m>o[x]?l[x][p]=Math.floor(d*y*g**(1/a[x]))+f:m>=s[x]?l[x][p]=h:l[x][p]=f}else for(p=0;p<u;p++)for(x=0;x<c;x++)m=l[x][p],g=(m-o[x])/M[x],d=1,a[x]>1&&(d-=(1/y)**(g*A[x])),m<s[x]&&m>o[x]?l[x][p]=Math.floor(d*y*g**(1/a[x]))+f:m>=s[x]?l[x][p]=h:l[x][p]=f;else if(null!=r){for(p=0;p<u;p++)if(r[p])for(x=0;x<c;x++)m=l[x][p],m<s[x]&&m>o[x]?l[x][p]=Math.floor((m-o[x])/M[x]*y)+f:m>=s[x]?l[x][p]=h:l[x][p]=f}else for(p=0;p<u;p++)for(x=0;x<c;x++)m=l[x][p],m<s[x]&&m>o[x]?l[x][p]=Math.floor((m-o[x])/M[x]*y)+f:m>=s[x]?l[x][p]=h:l[x][p]=f;return n.pixelType="u8",n.updateStatistics(),n}function c(t,e){if(!i(t))return null;const{pixels:l,mask:r}=t,o=t.width*t.height,s=l.length;let a=e.lut;const{offset:f}=e;let h,u;a&&1===a[0].length&&(a=l.map((()=>a)));const c=[];let x,p,m;if(f)if(null==r)for(h=0;h<s;h++){for(x=l[h],p=a[h],m=new Uint8Array(o),u=0;u<o;u++)m[u]=p[x[u]-f];c.push(m)}else for(h=0;h<s;h++){for(x=l[h],p=a[h],m=new Uint8Array(o),u=0;u<o;u++)r[u]&&(m[u]=p[x[u]-f]);c.push(m)}else if(null==r)for(h=0;h<s;h++){for(x=l[h],p=a[h],m=new Uint8Array(o),u=0;u<o;u++)m[u]=p[x[u]];c.push(m)}else for(h=0;h<s;h++){for(x=l[h],p=a[h],m=new Uint8Array(o),u=0;u<o;u++)r[u]&&(m[u]=p[x[u]]);c.push(m)}const d=new n({width:t.width,height:t.height,pixels:c,mask:r,pixelType:"u8"});return d.updateStatistics(),d}function x(t,e){if(!i(t))return null;const n=t.clone(),{pixels:l}=n,r=n.width*n.height,o=e.length,s=Math.floor(o/2),a=e[Math.floor(s)],f=l[0];let h,u,c,x,p,m,d=!1;const g=new Uint8Array(r),y=new Uint8Array(r),w=new Uint8Array(r);let M=n.mask;const k=4===e[0].mappedColor.length;for(M||(M=new Uint8Array(r),M.fill(k?255:1),n.mask=M),p=0;p<r;p++)if(M[p]){for(h=f[p],d=!1,m=s,u=a,c=0,x=o-1;x-c>1;){if(h===u.value){d=!0;break}h>u.value?c=m:x=m,m=Math.floor((c+x)/2),u=e[Math.floor(m)]}d||(h===e[c].value?(u=e[c],d=!0):h===e[x].value?(u=e[x],d=!0):h<e[c].value?(d=!1,u=null):h>e[c].value&&(h<e[x].value?(u=e[c],d=!0):x===o-1?(d=!1,u=null):(u=e[x],d=!0))),d?(g[p]=u.mappedColor[0],y[p]=u.mappedColor[1],w[p]=u.mappedColor[2],M[p]=u.mappedColor[3]):g[p]=y[p]=w[p]=M[p]=0}return n.pixels=[g,y,w],n.mask=M,n.pixelType="u8",n.maskIsAlpha=k,n}function p(t,n){if(!t||0===t.length)return null;const i=t.filter((t=>t.pixelBlock))[0];if(!i||e(i.pixelBlock))return null;const l=(i.extent.xmax-i.extent.xmin)/i.pixelBlock.width,r=(i.extent.ymax-i.extent.ymin)/i.pixelBlock.height,o=.01*Math.min(l,r),s=t.sort(((t,e)=>Math.abs(t.extent.ymax-e.extent.ymax)>o?e.extent.ymax-t.extent.ymax:Math.abs(t.extent.xmin-e.extent.xmin)>o?t.extent.xmin-e.extent.xmin:0)),a=Math.min.apply(null,s.map((t=>t.extent.xmin))),f=Math.min.apply(null,s.map((t=>t.extent.ymin))),h=Math.max.apply(null,s.map((t=>t.extent.xmax))),u=Math.max.apply(null,s.map((t=>t.extent.ymax))),c={x:Math.round((n.xmin-a)/l),y:Math.round((u-n.ymax)/r)},x={width:Math.round((h-a)/l),height:Math.round((u-f)/r)},p={width:Math.round((n.xmax-n.xmin)/l),height:Math.round((n.ymax-n.ymin)/r)};if(Math.round(x.width/i.pixelBlock.width)*Math.round(x.height/i.pixelBlock.height)!==s.length||c.x<0||c.y<0||x.width<p.width||x.height<p.height)return null;return{extent:n,pixelBlock:d(s.map((t=>t.pixelBlock)),x,c,p)}}function m(t,e,n,i,l,r){const{width:o,height:s}=n.block,{x:a,y:f}=n.offset,{width:h,height:u}=n.mosaic,c=function(t,e,n,i,l,r,o,s){return{xmin:l<=n*t?0:l<n*t+t?l-n*t:t,ymin:r<=i*e?0:r<i*e+e?r-i*e:e,xmax:l+o<=n*t?0:l+o<n*t+t?l+o-n*t:t,ymax:r+s<=i*e?0:r+s<i*e+e?r+s-i*e:e}}(o,s,i,l,a,f,h,u);let x=0,p=0;if(r){const t=r.hasGCSSShiftTransform?360:r.halfWorldWidth,e=o*r.resolutionX,n=r.startX+i*e,l=n+e;n<t&&l>t?p=r.rightPadding:n>=t&&(x=r.leftMargin-r.rightPadding,p=0)}if(c.xmax-=p,"number"!=typeof e)for(let n=c.ymin;n<c.ymax;n++){const r=(l*s+n-f)*h+(i*o-a)+x,u=n*o;for(let n=c.xmin;n<c.xmax;n++)t[r+n]=e[u+n]}else for(let n=c.ymin;n<c.ymax;n++){const r=(l*s+n-f)*h+(i*o-a)+x;for(let n=c.xmin;n<c.xmax;n++)t[r+n]=e}}function d(l,r,o,s,a){const f=l.filter((t=>i(t)))[0];if(e(f))return null;const h=s?s.width:r.width,u=s?s.height:r.height,c=f.width,x=f.height,p=r.width/c,d=r.height/x,g={offset:o||{x:0,y:0},mosaic:s||r,block:{width:c,height:x}},y=f.pixelType,w=n.getPixelArrayConstructor(y),M=f.pixels.length,k=[];let A,U;for(let t=0;t<M;t++){U=new w(h*u);for(let e=0;e<d;e++)for(let n=0;n<p;n++){const r=l[e*p+n];i(r)&&(A=r.pixels[t],m(U,A,g,n,e,a))}k.push(U)}let C;if(l.some((t=>e(t)||t.mask&&t.mask.length>0))){C=new Uint8Array(h*u);for(let e=0;e<d;e++)for(let n=0;n<p;n++){const i=l[e*p+n],r=t(i)?i.mask:null;m(C,r||(i?1:0),g,n,e,a)}}const T=new n({width:h,height:u,pixels:k,pixelType:y,mask:C});return T.updateStatistics(),T}function g(t,e,n){if(!i(t))return null;const{width:l,height:r}=t,o=e.x,s=e.y,a=n.width+o,f=n.height+s;if(o<0||s<0||a>l||f>r)return t;if(0===o&&0===s&&a===l&&f===r)return t;t.mask||(t.mask=new Uint8Array(l*r));const h=t.mask;for(let t=0;t<r;t++){const e=t*l;for(let n=0;n<l;n++)h[e+n]=t<s||t>=f||n<o||n>=a?0:1}return t.updateStatistics(),t}function y(t){if(0===t.size)return 0;let e=0,n=-1,i=0;const l=t.keys();let r=l.next();for(;!r.done;)i=t.get(r.value),i>e&&(n=r.value,e=i),r=l.next();return n}function w(t,e,n){if(0===n)return;const i=t.get(e);1===i?t.delete(e):t.set(e,i-1)}function M(t,e,n){0!==n&&t.set(e,t.has(e)?t.get(e)+1:1)}function k(t,e,l){let{x:r,y:o}=e;const{width:s,height:a}=l;if(0===r&&0===o&&a===t.height&&s===t.width)return t;const{width:f,height:h}=t,u=Math.max(0,o),c=Math.max(0,r),x=Math.min(r+s,f),p=Math.min(o+a,h);if(x<0||p<0||!i(t))return null;r=Math.max(0,-r),o=Math.max(0,-o);const{pixels:m,mask:d}=t,g=s*a,y=m.length,w=[];for(let e=0;e<y;e++){const i=m[e],l=n.createEmptyBand(t.pixelType,g);for(let t=u;t<p;t++){const e=t*f;let n=(t+o-u)*s+r;for(let t=c;t<x;t++)l[n++]=i[e+t]}w.push(l)}const M=new Uint8Array(g);for(let t=u;t<p;t++){const e=t*f;let n=(t+o-u)*s+r;for(let t=c;t<x;t++)M[n++]=d?d[e+t]:1}const k=new n({width:l.width,height:l.height,pixelType:t.pixelType,pixels:w,mask:M});return k.updateStatistics(),k}function A(t,e=!0){if(!i(t))return null;const{pixels:l,width:r,height:o,mask:s,pixelType:a}=t,f=[],h=Math.round(r/2),u=Math.round(o/2),c=o-1,x=r-1;for(let t=0;t<l.length;t++){const i=l[t],s=n.createEmptyBand(a,h*u);let p=0;for(let t=0;t<o;t+=2)for(let n=0;n<r;n+=2){const l=i[t*r+n];if(e){const e=n===x?l:i[t*r+n+1],o=t===c?l:i[t*r+n+r],a=n===x?o:t===c?e:i[t*r+n+r+1];s[p++]=(l+e+o+a)/4}else s[p++]=l}f.push(s)}let p=null;if(s){p=new Uint8Array(h*u);let t=0;for(let n=0;n<o;n+=2)for(let i=0;i<r;i+=2){const l=s[n*r+i];if(e){const e=i===x?l:s[n*r+i+1],o=n===c?l:s[n*r+i+r],a=i===x?o:n===c?e:s[n*r+i+r+1];p[t++]=l*e*o*a?1:0}else p[t++]=l}}return new n({width:h,height:u,pixelType:a,pixels:f,mask:p})}function U(t,e,n){if(!i(t))return null;const{width:l,height:r}=e;let{width:o,height:s}=t;const a=new Map,f={x:0,y:0},h=null==n?1:1+n;let u=t;for(let t=0;t<h;t++){const n=Math.ceil(o/l),i=Math.ceil(s/r);for(let o=0;o<i;o++){f.y=o*r;for(let i=0;i<n;i++){f.x=i*l;const n=k(u,f,e);a.set(`${t}/${o}/${i}`,n)}}t<h-1&&(u=A(u)),o=Math.round(o/2),s=Math.round(s/2)}return a}function C(t,e,l,r,o="nearest"){if(!i(t))return null;"majority"===o&&(t=function(t){if(!i(t))return null;const e=t.clone(),{width:n,height:l,pixels:r,mask:o}=t,s=r[0],a=e.pixels[0];for(let t=2;t<l-1;t++){const e=new Map;for(let i=t-2;i<t+2;i++)for(let t=0;t<4;t++){const l=i*n+t;M(e,s[l],o?o[l]:1)}a[t*n]=y(e),a[t*n+1]=a[t*n+2]=a[t*n];let i=3;for(;i<n-1;i++){let l=(t-2)*n+i+1;M(e,s[l],o?o[l]:1),l=(t-1)*n+i+1,M(e,s[l],o?o[l]:1),l=t*n+i+1,M(e,s[l],o?o[l]:1),l=(t+1)*n+i+1,M(e,s[l],o?o[l]:1),l=(t-2)*n+i-3,w(e,s[l],o?o[l]:1),l=(t-1)*n+i-3,w(e,s[l],o?o[l]:1),l=t*n+i-3,w(e,s[l],o?o[l]:1),l=(t+1)*n+i-3,w(e,s[l],o?o[l]:1),a[t*n+i]=y(e)}a[t*n+i+1]=a[t*n+i]}for(let t=0;t<n;t++)a[t]=a[n+t]=a[2*n+t],a[(l-1)*n+t]=a[(l-2)*n+t];return e.updateStatistics(),e}(t));const{pixels:s,mask:a,pixelType:f}=t,h=t.width,u=t.height,c=n.getPixelArrayConstructor(f),x=s.length,{width:p,height:m}=e,d=r.cols,g=r.rows,k=Math.ceil(p/d-.1/d),A=Math.ceil(m/g-.1/g);let U,C,T,v,S,B,b,O=!1;for(let t=0;t<l.length;t+=3)-1===l[t]&&-1===l[t+1]&&-1===l[t+2]&&(O=!0);const P=k*d,j=P*A*g,z=new Float32Array(j),I=new Float32Array(j);let D,E,$=0;const q="majority"===o?0:.5;for(let t=0;t<A;t++)for(let e=0;e<k;e++){U=12*(t*k+e),C=l[U],T=l[U+1],v=l[U+2],S=l[U+3],B=l[U+4],b=l[U+5];for(let n=0;n<g;n++){$=(t*g+n)*P+e*d,E=(n+.5)/g;for(let t=0;t<n;t++)D=(t+.5)/d,z[$+t]=Math.round((C*D+T*E+v)*h-q),I[$+t]=Math.round((S*D+B*E+b)*u-q)}U+=6,C=l[U],T=l[U+1],v=l[U+2],S=l[U+3],B=l[U+4],b=l[U+5];for(let n=0;n<g;n++){$=(t*g+n)*P+e*d,E=(n+.5)/g;for(let t=n;t<d;t++)D=(t+.5)/d,z[$+t]=Math.round((C*D+T*E+v)*h-q),I[$+t]=Math.round((S*D+B*E+b)*u-q)}}const F=(t,e)=>{for(let n=0;n<m;n++){U=n*P;for(let i=0;i<p;i++)z[U]<0||I[U]<0?t[n*p+i]=0:t[n*p+i]=e[z[U]+I[U]*h],U++}},V=[];let W;for(let t=0;t<x;t++)W=new c(p*m),F(W,s[t]),V.push(W);const X=new n({width:p,height:m,pixelType:f,pixels:V});if(a)X.mask=new Uint8Array(p*m),F(X.mask,a);else if(O){X.mask=new Uint8Array(p*m);for(let t=0;t<p*m;t++)X.mask[t]=z[t]<0||I[t]<0?0:1}return X.updateStatistics(),X}export{f as a,r as b,o as c,h as d,l as e,s as f,U as g,a as h,i,g as j,C as k,c as l,d as m,k as n,p as o,x as r,u as s};
