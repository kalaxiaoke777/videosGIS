<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Video Fusion Minimal Demo</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.118/Build/Cesium/Cesium.js"></script>
    <link
      href="https://cesium.com/downloads/cesiumjs/releases/1.118/Build/Cesium/Widgets/widgets.css"
      rel="stylesheet"
    />
    <style>
      html,
      body {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
        font-family: Arial, sans-serif;
      }
      #cesiumContainer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }
      #videoContainer {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 320px;
        background: rgba(0, 0, 0, 0.8);
        border-radius: 8px;
        padding: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }
      #videoSource {
        width: 100%;
        border-radius: 4px;
        background: black;
      }
      #info {
        margin-top: 8px;
        color: white;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div id="cesiumContainer"></div>

    <!-- 右上角视频，直接显示 video 元素 -->
    <div id="videoContainer">
      <video
        id="videoSource"
        muted
        loop
        playsinline
        style="width: 100%; border-radius: 4px"
      >
        <source src="data/data_clipped_30s.mp4" type="video/mp4" />
      </video>
      <div id="info">
        <div>分辨率: <span id="videoRes">-</span></div>
        <div>贴图区域: 整个视频画面</div>
      </div>
    </div>

    <script>
      // 1. 初始化 Cesium
      Cesium.Ion.defaultAccessToken =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJkOGFjOTU5Zi0xOTU1LTRlOTctOTg4Ny05MGJmYmNhMDdhNTgiLCJpZCI6MTUxNTAxLCJpYXQiOjE3MDUzOTQ0OTl9.8SXHmK_7zqWsYcIY5GLJbeez-4JTQo9ePfpKV8Q5Stg";

      const viewer = new Cesium.Viewer("cesiumContainer", {
        baseLayerPicker: false,
        terrain: Cesium.Terrain.NONE,
        timeline: false,
        animation: false,
        shouldAnimate: true,
      });

      // 2. 右上角视频
      const video = document.getElementById("videoSource");
      const videoResSpan = document.getElementById("videoRes");

      // 视频元数据加载
      video.addEventListener("loadedmetadata", () => {
        console.log("loadedmetadata fired");
        console.log("video size", video.videoWidth, video.videoHeight);
        videoResSpan.textContent = `${video.videoWidth} x ${video.videoHeight}`;

        // 创建地图上的矩形覆盖
        createVideoRectangle();

        // 尝试自动播放
        video
          .play()
          .then(() => {
            console.log("视频自动播放成功");
          })
          .catch((e) => {
            console.warn("自动播放失败, 需要用户点击页面触发播放:", e);
          });
      });

      video.addEventListener("error", (e) => {
        console.error("视频加载错误:", e);
      });

      // 3. 在地球上放一个矩形, 用 video 作为材质
      function createVideoRectangle() {
        fetch("data/camera_config.json")
          .then((r) => r.json())
          .then((cfg) => {
            console.log("camera_config", cfg);
            const lon = cfg.extrinsic.lon;
            const lat = cfg.extrinsic.lat;

            // 简单假设: 在相机点附近画一个 150m x 150m 的正方形
            const sizeMeters = 150;
            const metersPerDegreeLat = 111320;
            const metersPerDegreeLon =
              metersPerDegreeLat * Math.cos(Cesium.Math.toRadians(lat));

            const dLon = sizeMeters / metersPerDegreeLon / 2;
            const dLat = sizeMeters / metersPerDegreeLat / 2;

            const rect = Cesium.Rectangle.fromDegrees(
              lon - dLon,
              lat - dLat,
              lon + dLon,
              lat + dLat
            );

            const material = new Cesium.ImageMaterialProperty({
              image: video, // 直接用 <video> 元素
              transparent: true,
            });

            const entity = viewer.entities.add({
              name: "VideoOnGlobe",
              rectangle: {
                coordinates: rect,
                material: material,
              },
            });

            console.log("Video entity added", entity);

            // 摄像机飞过去
            viewer.flyTo(entity);
          })
          .catch((e) => {
            console.error("加载 camera_config.json 失败", e);
          });
      }

      // 4. 开始加载视频
      console.log("开始加载视频 data/data_clipped_30s.mp4");
      video.load();

      // 5. 兜底: 任意点击页面时尝试播放视频(解决浏览器自动播放限制)
      document.body.addEventListener("click", () => {
        if (video.paused) {
          video
            .play()
            .then(() => console.log("用户点击后视频开始播放"))
            .catch((err) => console.error("点击后播放仍然失败", err));
        }
      });
    </script>
  </body>
</html>
